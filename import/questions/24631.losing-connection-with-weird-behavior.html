<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Losing connection with weird behavior. - Wireshark Q&amp;A</title>
        <meta name="description" content="My game client loses connection from my game server intermittently. (about 0.2% per minute) When connection is dropped, my client received a error code 10053(connaborted) usually. The number of user is about 100k, so about 200 users are dropped per minute. I should find the cause, but can&#39;t find the..." />
        <meta name="keywords" content="connection,drop,disconnect" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/24631/losing-connection-with-weird-behavior" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/24631/losing-connection-with-weird-behavior?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='tpR2GEL5SyMY41yHFQWZqCDviLfNBv6F' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/24631/losing-connection-with-weird-behavior">Losing connection with weird behavior.</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-24631-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/24631/up/" rel="nofollow"> </a>
<div id="post-24631-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-24631-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/24631/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/24631/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>My game client loses connection from my game server intermittently. (about 0.2% per minute)
When connection is dropped, my client received a error code 10053(connaborted) usually.</p>
<p>The number of user is about 100k, so about 200 users are dropped per minute.</p>
<p>I should find the cause, but can't find the root cause.</p>
<p>Now I have written code to work aroud this problem.
When my client detects losing connection, my client tries to connect again.</p>
<p>Although this work around, I want to know the root cause of this problem.</p>
<p>Here is my game C/S's environment.</p>
<ul>
<li>
<p>Client</p>
<ul>
<li>works on Windows (XP, Visita, 7)</li>
<li>uses in-house network library (it's very simple)</li>
</ul>
</li>
<li>
<p>Server</p>
<ul>
<li>works on Linux (Ubuntu 12.04.1 - kernel 3.2.0-29 / Ubuntu 12.04.2 - kernel 3.5.0-23)</li>
<li>using iptables or ufw</li>
</ul>
</li>
</ul>
<p>Here is my approach to solve this problem.</p>
<p>First of all, I doubted my in-house code. 
I reviewed my codes very carefully but couldn't find any problems.</p>
<p>Second, I tried to capture packets on my server.
Before loosing connection, my server can't receve any packets from a client.
My server can't receive a ack packet, so my server try retransmission again and again.</p>
<p>Maybe a client also can't receive any packets from a server.
(I can't reproduce this problem in my computer, so can't capture packets in client's side.)</p>
<p>The reason I think a client can't receive any packets is that 
a client is disconnected with a 10053 error code before the server's retransmission timeout.
The client doesn't call closesocket explicitly.</p>
<p>I wonder why client and server can't receive any packets? What's wrong?
If the reason is congestion, trying reconnect should be fail, isn't it?
But almost trying reconnect is success!</p>
<p>I don't know who drops my packets and why?</p>
<p>I suspect the firewall, so I make the firewall disable on the server (just one machine).
But, the problem still produces.</p>
<p>Finally, I suspect linux kernel/tcp stack or NIC device driver.
But commonsensically the linux kernel/tcp stack is very stable, isn't it?</p>
<p>Do you have any idea? I'll be very appreciate any feedback.</p>
<p>** attach my wireshark's result</p>
<ul>
<li>port: 4134 is a client</li>
<li>port: 7781 is a server</li>
<li>a client should send a ping msg (which size is 20 bytes) to a server per 3 seconds.</li>
<li>but, there is no client's ping msg from 768 to 786</li>
<li>a server sends a ping msg per 20 seconds. At 786 a server try to send a ping msg. (which size is 30 bytes)</li>
<li>but a server can't receive ack packet from a client.</li>
<li>At 815, a client tries to reconnect to server!! (It's my work around.)
   But, a server can't receive any FIN or RST.</li>
<li>Maybe a client had sent a RST to a server, but a server can't receive it.</li>
</ul>
<p><img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/capture_5.png"></p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/connection/" class="post-tag tag-link-connection"
                                        title="see questions tagged 'connection'" rel="tag">connection</a>
                                
                                    <a href="/tags/drop/" class="post-tag tag-link-drop"
                                        title="see questions tagged 'drop'" rel="tag">drop</a>
                                
                                    <a href="/tags/disconnect/" class="post-tag tag-link-disconnect"
                                        title="see questions tagged 'disconnect'" rel="tag">disconnect</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>13 Sep '13, 02:34</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/1b0e831a230435b60baa865724a25032?s=32&amp;d=identicon&amp;r=g" alt="plotonix's gravatar image" />
    <p><a href="/users/5649/plotonix">plotonix</a><br/>
    <span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">&#9679;</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">&#9679;</span><span class="badgecount">3</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="plotonix has no accepted answers">0&#37;</span>
    </p>
</div>


                            </div>
                            




<div class="comments-container" id="comments-container-24631">
    
</div>
<div id="comment-tools-24631" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-24631-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    2 Answers:
                    </div>
                    
<div class="tabsA"><a href="/questions/24631/losing-connection-with-weird-behavior?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/24631/losing-connection-with-weird-behavior?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/24631/losing-connection-with-weird-behavior?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/24631/losing-connection-with-weird-behavior?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="24657"></a>
                    <div id="answer-container-24657" class="answer ">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-24657-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/24657/up/" rel="nofollow"> </a>
<div id="post-24657-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-24657-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/24657/down/" rel="nofollow"> </a>

                                        


    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <ul>
<li>Assuming that this trace is filtered on the remote client's ip address the client port number 'wraps' from within 4134 to 1737. Very unlikely for a windows client which uses incremental ephemeral ports.</li>
<li>The SYN packet arrives with a reduced MSS of 1414 </li>
<li>The client's 'ping' packet was due at 761.64x but was never seen at the server</li>
<li>The server's ping packets don't go through either</li>
<li>815.708  into the trace - 54 seconds after the first missing packet - the client reconnects - immediately after the abort as you say your client is coded.</li>
</ul>
<p>So, the client entered retransmission and finally aborted the connection when retries were exhausted. The new SYN packet  went through immediately, so we can exclude a general IP connectivity problem. I'd say, the problem is with security device in the path that is dropping packets of your TCP session for whatever reason. </p>
<p>Good luck in finding out more using traces at the endpoints ! ;-)</p>
<p>Regards Matthias</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/24657/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>13 Sep '13, 13:29</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/5500bd1decb766660522dfb347eedc49?s=32&amp;d=identicon&amp;r=g" alt="mrEEde's gravatar image" />
    <p><a href="/users/4668/mreede">mrEEde</a><br/>
    <span class="score" title="3892 reputation points"><span class="">3.9k</span></span><span title="15 badges"><span class="badge1">&#9679;</span><span class="badgecount">15</span></span><span title="22 badges"><span class="silver">&#9679;</span><span class="badgecount">22</span></span><span title="70 badges"><span class="bronze">&#9679;</span><span class="badgecount">70</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="mrEEde has 48 accepted answers">20&#37;</span>
    </p>
</div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-24657">
    
        <a name="24665"></a>
        <div class="comment" id="comment-24665">
            <div id="post-24665-score" class="comment-score"></div>
            <div class="comment-text"><p><a href="/users/4668/mreede"></a><a href="/users/4668/mreede">@mrEEde</a> Thanks for your comment. </p>

<p>Of course, this trace is filtered on the client's ip addr and the port.</p>

<p>I totally agree with your answer. It's not a general IP connectivity problem.</p>

<p>When I tried to turn off the firewall in my server, the problem is still occurred.
So, the firewall in my server is not dropping my packets.</p>

<p>I want to know who drops my packets (intermittently) and why?
How can I trace this problem and how to find 'who and why?'</p></div>
            <div class="comment-info" id="comment-24665-info">
                
                
                
                

                

                <span class="comment-age">(13 Sep '13, 18:12)</span>
                <a class="comment-user userinfo" href="/users/5649/plotonix">plotonix</a>
                
            </div>
        </div>
    
        <a name="24716"></a>
        <div class="comment" id="comment-24716">
            <div id="post-24716-score" class="comment-score"></div>
            <div class="comment-text"><p>With your server serving 100.000 users I gather that the clients are spread all over the world. So, to find "THE" device that is dropping those packets by looking at a single connection is close to impossible as there are probably many devices out there that are causing your 'problem'. Furthermore,  those devices are most likely not in your scope of influence and the owners will not be too keen to spend their time figuring out what is going on unless you have a valid business reason. 
To summ it up, I think 200 drops out of 100.000 user sessions is not too bad ;-)</p></div>
            <div class="comment-info" id="comment-24716-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '13, 07:40)</span>
                <a class="comment-user userinfo" href="/users/4668/mreede">mrEEde</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-24657" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-24657-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                    <a name="24676"></a>
                    <div id="answer-container-24676" class="answer ">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-24676-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/24676/up/" rel="nofollow"> </a>
<div id="post-24676-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-24676-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/24676/down/" rel="nofollow"> </a>

                                        


    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <blockquote>
<p>I want to know who drops my packets (intermittently) and why? How can I trace this problem and how to find 'who and why?'</p>
</blockquote>
<p>Well, that's hard to do, as you won't be able to easily figure that out. A drop of a security device is usually 'silent' meaning, you don't know where is happens.</p>
<p>One option I see is this: </p>
<p>On the server (better on the client as well): If you detect multiple re-transmissions/DUP ACK, etc., you could start a new thread and start sending the last packet (the one you don't get an answer for) with increasing TTL. If you're lucky, you will at least be able to nail down the approx. device that could be dropping the packet, which is the one after which you don't get ICMP time exceeded anymore. This will obviouly only work, if the routers on the way do send the ICMP messages and they are not filtered on the way to your server.</p>
<pre>Server -&gt; Router1 --&gt; Router2 --&gt; Firewall/IDS/Whatever --&gt; Router3 --&gt; Router4
TTL:1     # &lt;- ICMP
TTL:2                # &lt;- ICMP
TTL:3                             :: drop
TTL:4                             :: drop
TTL:5                             :: drop
</pre>

<p>The firewall drops the TCP packet and thus the last station you get an ICMP message from would be Router2.</p>
<p>Regards<br>
Kurt</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/24676/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>14 Sep '13, 04:49</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" alt="Kurt%20Knochner's gravatar image" />
    <p><a href="/users/2593/kurt-knochner">Kurt Knochner ♦</a><br/>
    <span class="score" title="24767 reputation points"><span class="">24.8k</span></span><span title="10 badges"><span class="badge1">&#9679;</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">&#9679;</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">&#9679;</span><span class="badgecount">237</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Kurt Knochner has 344 accepted answers">15&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/24676/">
                edited
                <strong>14 Sep '13, 14:54</strong>
            </a>
        </p>
        
    </div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-24676">
    
        <a name="24680"></a>
        <div class="comment" id="comment-24680">
            <div id="post-24680-score" class="comment-score"></div>
            <div class="comment-text"><p><a href="/users/2593/kurt-knochner"></a><a href="/users/2593/kurt-knochner">@Kurt Knochner</a> </p>

<p>Thanks for your comment.
I have some questions about your comment.</p>

<ol>
<li>How do the server application know TCP retransmission. There is no callback and notification. 
As I known, It's just duty of TCP, and the server application couldn't know that timing.
So, I couldn't start a new thread and blah blah.. at that timing.
How could I do it?</li>
</ol>

<p>2.
I'm not a fluent English speaker. :( 
I couldn't understand your sentence.
"device that could be dropping the packet, which is the one after which you don't get ICMP time exceeded anymore"
If you explain this sentence with another words, I will be appreciate it.</p>

<p>3.
Why do you suggest to increase TTL. </p>

<ol>
<li>As you said, if the routers on the way do send the ICMP msg to my server, 
I will know who drops my packet!
I already tried to capture ICMP message on my server, but there is nothing special.
I'll try to do it again.</li>
</ol></div>
            <div class="comment-info" id="comment-24680-info">
                
                
                
                

                

                <span class="comment-age">(14 Sep '13, 07:25)</span>
                <a class="comment-user userinfo" href="/users/5649/plotonix">plotonix</a>
                
            </div>
        </div>
    
        <a name="24692"></a>
        <div class="comment" id="comment-24692">
            <div id="post-24692-score" class="comment-score"></div>
            <div class="comment-text"><blockquote>
<p>How do the server application know TCP retransmission. </p>
</blockquote>

<p>Well, actually I don't think it will be possible with the standard TCP/IP API calls, so you need to either use libpcap in a kind of monitoring thread of your server and look for retransmissions yourself (rather hard) or use some scripting together with Wireshark/tshark. As soon as you detect a retransmission, you fire up script and try to implement what I mentioned above. You can use packet injection tools to do that. Although, that sounds like a weird hack, it might be your best option to identify the part where everything fails.</p>

<blockquote>
<p>Second, I tried to capture packets on my server.</p>
</blockquote>

<p>Did you try to capture the traffic off-box, meaning on a mirror port of the switch? Maybe the problem is caused by the NIC (or the driver) of your server. Maybe you should do that first!</p>

<blockquote>
<p>I'm not a fluent English speaker. </p>
</blockquote>

<p>Neither am I ;-)</p>

<blockquote>
<p>I couldn't understand your sentence.</p>
</blockquote>

<p>Look at the picture in my answer. The last device that sends an ICMP response, is the last hop before the device that possibly drops the TCP packets.</p>

<blockquote>
<p>I already tried to capture ICMP message on my server, but there is nothing special.</p>
</blockquote>

<p>You will only see ICMP messages, if you implement the 'TTL hack' I tried to describe.</p></div>
            <div class="comment-info" id="comment-24692-info">
                
                
                
                

                

                <span class="comment-age">(14 Sep '13, 14:54)</span>
                <a class="comment-user userinfo" href="/users/2593/kurt-knochner">Kurt Knochner ♦</a>
                
            </div>
        </div>
    
        <a name="24729"></a>
        <div class="comment" id="comment-24729">
            <div id="post-24729-score" class="comment-score"></div>
            <div class="comment-text"><p><a href="/users/2593/kurt-knochner">@Kurt Knochner</a></p>

<p>Thanks for your reply. I've got what you mean.
I'll try it and share the result.</p></div>
            <div class="comment-info" id="comment-24729-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '13, 18:21)</span>
                <a class="comment-user userinfo" href="/users/5649/plotonix">plotonix</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-24676" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-24676-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/24631/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='tpR2GEL5SyMY41yHFQWZqCDviLfNBv6F' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/24631/losing-connection-with-weird-behavior?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/24631/losing-connection-with-weird-behavior?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/connection/"
            class="tag-link-connection"
            title="see questions tagged'connection'using tags"
            rel="tag">connection</a> <span class="tag-number">&#215;41</span><br/>
        
        <a href="/tags/disconnect/"
            class="tag-link-disconnect"
            title="see questions tagged'disconnect'using tags"
            rel="tag">disconnect</a> <span class="tag-number">&#215;15</span><br/>
        
        <a href="/tags/drop/"
            class="tag-link-drop"
            title="see questions tagged'drop'using tags"
            rel="tag">drop</a> <span class="tag-number">&#215;10</span><br/>
        
    </p>
    <p>
        question asked: <strong title="Sept. 13, 2013, 2:34 a.m.">13 Sep '13, 02:34</strong>
    </p>
    <p> 
     	question was seen: <strong>6,220 times</strong>
    </p>
    <p> 
        last updated: <strong title="Sept. 15, 2013, 6:21 p.m.">15 Sep '13, 18:21</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/2711/is-there-any-way-to-gauge-how-many-times-connection-times-out-over-a-length-of-time">Is there any way to gauge how many times connection times out over a length of time?</a>
        </p>
        
        <p>
            <a href="/questions/230/displaying-all-tcp-connections-with-syn-packets">Displaying all TCP connections with SYN packets</a>
        </p>
        
        <p>
            <a href="/questions/22206/how-can-you-be-aware-the-source-of-the-slow-connection-problem">How can you be aware the source of the slow connection problem?</a>
        </p>
        
        <p>
            <a href="/questions/54778/what-should-i-see-in-capture-when-there-is-tcp-error-could-not-connect-to-the-server">What should I see in capture when there is TCP error: Could not connect to the server?</a>
        </p>
        
        <p>
            <a href="/questions/48075/losing-connection-with-weird-behavior-disconnecting-everyone">Losing connection with weird behavior (disconnecting everyone)</a>
        </p>
        
        <p>
            <a href="/questions/652/connection-to-microsoft-exchange-has-been-lost-outlook-will-restore-the-connection-when-possible">Connection to Microsoft Exchange has been lost. Outlook will restore the connection when possible</a>
        </p>
        
        <p>
            <a href="/questions/25727/how-to-apply-filter-to-view-tcp-connection-timeout">How to apply filter to view tcp connection timeout</a>
        </p>
        
        <p>
            <a href="/questions/55348/ftp-connection-closed-aborted-transfer-of-file">FTP: Connection closed; aborted transfer of file</a>
        </p>
        
        <p>
            <a href="/questions/55495/remote-user-disconnect-log-review">Remote User Disconnect - Log Review</a>
        </p>
        
        <p>
            <a href="/questions/1324/vpn-connection">VPN connection</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
