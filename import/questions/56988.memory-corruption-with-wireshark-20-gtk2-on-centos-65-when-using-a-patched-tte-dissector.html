<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Memory corruption with Wireshark 2.0 GTK2 on CentOS 6.5 when using a patched TTE dissector - Wireshark Q&amp;A</title>
        <meta name="description" content="I encountered a very weird issue, and need expertise on Wireshark internals. First, a few context informations :  we use a home compiled version of Wireshark 2.0 where we disable a lot of features such as Qt and GTK3 interface or Lua. Main point is being able to run a recent version of Wireshark (be..." />
        <meta name="keywords" content="gtk,dissector,crash,sub-dissector,patch" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='fM0nSGHQvli49YTQ6N3kyNg7vlG9IYYZ' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector">Memory corruption with Wireshark 2.0 GTK2 on CentOS 6.5 when using a patched TTE dissector</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-56988-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/56988/up/" rel="nofollow"> </a>
<div id="post-56988-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-56988-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/56988/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/56988/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>I encountered a very weird issue, and need expertise on Wireshark internals. First, a few context informations :</p>
<ul>
<li>we use a home compiled version of Wireshark 2.0 where we disable a lot of features such as Qt and GTK3 interface or Lua. Main point is being able to run a recent version of Wireshark (because we developed a plugin infrastructure on top of Wireshark 2 API) on an old distribution based on CentOS 6.5, as well as a more recent one, based on CentOS 7. This "home" version is properly compiled on systems with the right distribution (ie the version we run on CentOS 6.5 is compiled on CentOS 6.5, same with CentOS 7)</li>
<li>this "home version" features a patch of the TTE protocol dissector, since we need to use dissectors on top of it, and bundled version doesn't support this feature. So we added a dissector table allowing to add dissectors based on "tte.ctid" field</li>
</ul>
<p>The problem we observe is a crash when we use a dissector based on this tte.ctid field, but only in CentOS 6.5 context. On CentOS 7, no problem. To exactly pinpoint the problem we used Valgrind, and we don't observe the valgrind error on the CentOS 7 version.</p>
<p>So I guess we did something wrong with the patch, since going through subdissectors overwrites freed memory originally belonging to GDK. My guess is that the problem might be that <code>call_dissector_with_data</code> is called (original TTE dissector code), and then we call <code>dissector_try_uint</code> to call the subdissectors. Is that the way to do it?</p>
<p>Now for the data that will help detect the problem. First, our patch of the TTE dissector :</p>
<pre><code>--- wireshark-2.0.3/epan/dissectors/packet-tte.c    2016-07-19 18:53:17.721839071 +0200
+++ wireshark-2.0.3-patch/epan/dissectors/packet-tte.c  2016-07-20 10:43:25.441521228 +0200
@@ -57,6 +57,8 @@
 static gint ett_tte = -1;
 static gint ett_tte_macdest = -1;

+/* ASL Patch for sub-dissectors */
+static dissector_table_t tte_dissector_table;

 /* Code to actually dissect the packets */
 static int
@@ -68,6 +70,9 @@
     /* Set up structures needed to add the protocol subtree and manage it */
     proto_item *tte_root_item, *tte_macdest_item;
     proto_tree *tte_tree, *tte_macdest_tree;
+    /* ASL Patch for sub-dissectors */
+    guint16 ctid = -1;
+    int ret;

     /* Check that there's enough data */
     if (tvb_reported_length(tvb) &lt; TTE_HEADER_LENGTH)
@@ -96,6 +100,8 @@
         col_set_str(pinfo-&gt;cinfo, COL_INFO, "Bogus TTEthernet Frame");
     }

+    
+
     if (tree) {

         /* create display subtree for the protocol */
@@ -120,9 +126,9 @@
         proto_tree_add_item(tte_macdest_tree,
             hf_tte_dst_cf, tvb, 0, TTE_MACDEST_CF_LENGTH, ENC_BIG_ENDIAN);

-        proto_tree_add_item(tte_macdest_tree,
+        proto_tree_add_item_ret_uint(tte_macdest_tree,
             hf_tte_ctid, tvb, TTE_MACDEST_CF_LENGTH,
-            TTE_MACDEST_CTID_LENGTH, ENC_BIG_ENDIAN);
+            TTE_MACDEST_CTID_LENGTH, ENC_BIG_ENDIAN, (guint32*)&amp;ctid);
     }

     /* prevent clearing the Columns...appending cannot be prevented */
@@ -137,7 +143,19 @@
     ethertype_data.fcs_len = 0;

     call_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &amp;ethertype_data);
-    return tvb_reported_length(tvb);
+
+    /* ASL Patch for sub-dissectors */
+    /*    return tvb_reported_length(tvb);*/
+    ret = TTE_HEADER_LENGTH;
+    if (ctid &gt; 0) {
+        int bytes = dissector_try_uint(tte_dissector_table, ctid, tvb, pinfo, tree);
+
+        if (bytes &gt; ret) {
+            ret = bytes;
+        }
+    }
+
+    return ret;
 }

@@ -172,6 +185,9 @@
     proto_register_field_array(proto_tte, hf, array_length(hf));
     proto_register_subtree_array(ett, array_length(ett));

+    /* ASL Patch for sub-dissectors */
+    tte_dissector_table = register_dissector_table("tte.ctid", "CT ID", FT_UINT16, BASE_DEC);
+
     /* Register preferences module */
     tte_module = prefs_register_protocol(proto_tte, NULL);
</code></pre>
<p>The valgrind crash trace (only occurring on CentOS 6.5) :</p>
<pre><code>==11024== Invalid write of size 8
==11024==    at 0x65FCA88: dissector_try_heuristic (packet.c:2194)
==11024==    by 0x68BE54A: dissect_eth_common (packet-eth.c:337)
==11024==    by 0x68BF0B8: dissect_eth (packet-eth.c:841)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FE0A5: dissector_try_uint_new (packet.c:1163)
==11024==    by 0x68F03B4: dissect_frame (packet-frame.c:499)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FD400: call_dissector_with_data (packet.c:2563)
==11024==    by 0x65FF495: dissect_record (packet.c:498)
==11024==    by 0x65F20C9: epan_dissect_run (epan.c:332)
==11024==  Address 0x18240000 is 64 bytes inside a block of size 192 free'd
==11024==    at 0x4A063F0: free (vg_replace_malloc.c:446)
==11024==    by 0x3598A10D22: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A1580A: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A1589A: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A0FB0F: cairo_restore (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3597E26F3F: ??? (in /usr/lib64/libgdk-x11-2.0.so.0.2000.1)
==11024==    by 0x3597E2C88F: ??? (in /usr/lib64/libgdk-x11-2.0.so.0.2000.1)
==11024==    by 0x3597E2CF63: ??? (in /usr/lib64/libgdk-x11-2.0.so.0.2000.1)
==11024==    by 0x3597A2887C: pango_renderer_draw_glyphs (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3597A29064: pango_renderer_draw_layout_line (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3597A29364: pango_renderer_draw_layout (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3597E2BB66: gdk_draw_layout_with_colors (in /usr/lib64/libgdk-x11-2.0.so.0.2000.1)
==11024==
==11024== Invalid write of size 8
==11024==    at 0x65FCA90: dissector_try_heuristic (packet.c:2195)
==11024==    by 0x68BE54A: dissect_eth_common (packet-eth.c:337)
==11024==    by 0x68BF0B8: dissect_eth (packet-eth.c:841)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FE0A5: dissector_try_uint_new (packet.c:1163)
==11024==    by 0x68F03B4: dissect_frame (packet-frame.c:499)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FD400: call_dissector_with_data (packet.c:2563)
==11024==    by 0x65FF495: dissect_record (packet.c:498)
==11024==    by 0x65F20C9: epan_dissect_run (epan.c:332)
==11024==  Address 0x18240158 is not stack'd, malloc'd or (recently) free'd
==11024==
==11024== Invalid write of size 2
==11024==    at 0x65FCA9C: dissector_try_heuristic (packet.c:2196)
==11024==    by 0x68BE54A: dissect_eth_common (packet-eth.c:337)
==11024==    by 0x68BF0B8: dissect_eth (packet-eth.c:841)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FE0A5: dissector_try_uint_new (packet.c:1163)
==11024==    by 0x68F03B4: dissect_frame (packet-frame.c:499)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FD400: call_dissector_with_data (packet.c:2563)
==11024==    by 0x65FF495: dissect_record (packet.c:498)
==11024==    by 0x65F20C9: epan_dissect_run (epan.c:332)
==11024==  Address 0x182400c0 is 0 bytes inside a block of size 16 free'd
==11024==    at 0x4A063F0: free (vg_replace_malloc.c:446)
==11024==    by 0x3598A4393A: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A2AA5D: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A13982: ??? (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598A0E146: cairo_show_glyphs (in /usr/lib64/libcairo.so.2.10800.8)
==11024==    by 0x3598E086D5: ??? (in /usr/lib64/libpangocairo-1.0.so.0.2800.1)
==11024==    by 0x3598E0899A: ??? (in /usr/lib64/libpangocairo-1.0.so.0.2800.1)
==11024==    by 0x3597A2887C: pango_renderer_draw_glyphs (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3598E074DB: ??? (in /usr/lib64/libpangocairo-1.0.so.0.2800.1)
==11024==    by 0x3597A2887C: pango_renderer_draw_glyphs (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3597A29064: pango_renderer_draw_layout_line (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==    by 0x3597A29364: pango_renderer_draw_layout (in /usr/lib64/libpango-1.0.so.0.2800.1)
==11024==
==11024==
==11024== Process terminating with default action of signal 11 (SIGSEGV): dumping core
==11024==  Access not within mapped region at address 0x7FEFF0000
==11024==    at 0x65FCA88: dissector_try_heuristic (packet.c:2194)
==11024==    by 0x68BE54A: dissect_eth_common (packet-eth.c:337)
==11024==    by 0x68BF0B8: dissect_eth (packet-eth.c:841)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FE0A5: dissector_try_uint_new (packet.c:1163)
==11024==    by 0x68F03B4: dissect_frame (packet-frame.c:499)
==11024==    by 0x65FCB6E: call_dissector_through_handle (packet.c:618)
==11024==    by 0x65FD073: call_dissector_work (packet.c:706)
==11024==    by 0x65FD400: call_dissector_with_data (packet.c:2563)
==11024==    by 0x65FF495: dissect_record (packet.c:498)
==11024==    by 0x65F20C9: epan_dissect_run (epan.c:332)
==11024==  If you believe this happened as a result of a stack
==11024==  overflow in your program's main thread (unlikely but
==11024==  possible), you can try to increase the size of the
==11024==  main thread stack using the --main-stacksize= flag.
==11024==  The main thread stack size used in this run was 8388608.
</code></pre>
<p>About box information of our CentOS 6.5 Wireshark version :</p>
<pre><code>Version 2.0.7 (Git Rev Unknown from unknown)

Copyright 1998-2016 Gerald Combs &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ccaba9beada0a88cbba5bea9bfa4adbea7e2a3beab">[email&#160;protected]</a>&gt; and contributors.
License GPLv2+: GNU GPL version 2 or later &lt;<a href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html>">http://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt;</a>
This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Compiled (64-bit) with GTK+ 2.20.1, with Cairo 1.8.8, with Pango 1.28.1, with
libpcap, without POSIX capabilities, without libnl, with libz 1.2.3, with GLib
2.26.1, without SMI, without c-ares, without ADNS, without Lua, without GnuTLS,
with Gcrypt 1.4.5, with MIT Kerberos, without GeoIP, without PortAudio, without
AirPcap.

Running on Linux 3.10.47-rt50-RedHawk-6.5.2-trace, with locale en_US.UTF-8, with
libpcap version 1.7.4, with libz 1.2.3, with Gcrypt 1.4.5.
       Intel(R) Xeon(R) CPU E5-2407 0 @ 2.20GHz (with SSE4.2)

Built using gcc 4.4.7 20120313 (Red Hat 4.4.7-4).
</code></pre>
<p>About box of our CentOS 7 version, where the problem does not occur :</p>
<pre><code>Version 2.0.7 (Git Rev Unknown from unknown)

Copyright 1998-2016 Gerald Combs &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="791e1c0b18151d390e100b1c0a11180b1257160b1e">[email&#160;protected]</a>&gt; and contributors.
License GPLv2+: GNU GPL version 2 or later &lt;<a href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html>">http://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt;</a>
This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Compiled (64-bit) with GTK+ 2.24.22, with Cairo 1.12.14, with Pango 1.34.1, with
libpcap, without POSIX capabilities, without libnl, with libz 1.2.7, with GLib
2.36.3, without SMI, without c-ares, without ADNS, without Lua, without GnuTLS,
without Gcrypt, with MIT Kerberos, without GeoIP, without PortAudio, without
AirPcap.

Running on Linux 3.16.7-RedHawk-7.0.2-trace, with locale en_US.UTF-8, with
libpcap version 1.7.4, with libz 1.2.7.
Intel(R) Xeon(R) CPU E5-2637 v3 @ 3.50GHz (with SSE4.2)

Built using gcc 4.8.2 20140120 (Red Hat 4.8.2-16).
</code></pre>
<p>Thanks in advance for any help you can provide, because I'm a bit lost here :)</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/gtk/" class="post-tag tag-link-gtk"
                                        title="see questions tagged 'gtk'" rel="tag">gtk</a>
                                
                                    <a href="/tags/dissector/" class="post-tag tag-link-dissector"
                                        title="see questions tagged 'dissector'" rel="tag">dissector</a>
                                
                                    <a href="/tags/crash/" class="post-tag tag-link-crash"
                                        title="see questions tagged 'crash'" rel="tag">crash</a>
                                
                                    <a href="/tags/sub-dissector/" class="post-tag tag-link-sub-dissector"
                                        title="see questions tagged 'sub-dissector'" rel="tag">sub-dissector</a>
                                
                                    <a href="/tags/patch/" class="post-tag tag-link-patch"
                                        title="see questions tagged 'patch'" rel="tag">patch</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>04 Nov '16, 10:04</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/1b1240dfe83b6bd6af805b6c96b3b1b8?s=32&amp;d=identicon&amp;r=g" alt="Florian%20Haradji's gravatar image" />
    <p><a href="/users/26207/florian-haradji">Florian Haradji</a><br/>
    <span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">&#9679;</span><span class="badgecount">1</span></span><span title="5 badges"><span class="bronze">&#9679;</span><span class="badgecount">5</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Florian Haradji has no accepted answers">0&#37;</span>
    </p>
</div>


                            </div>
                            




<div class="comments-container" id="comments-container-56988">
    
</div>
<div id="comment-tools-56988" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-56988-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    One Answer:
                    </div>
                    
<div class="tabsA"><a href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="56989"></a>
                    <div id="answer-container-56989" class="answer accepted-answer">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-56989-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/56989/up/" rel="nofollow"> </a>
<div id="post-56989-score" class="post-score"
    title="current number of votes">
    2
</div>
<a id="post-56989-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/56989/down/" rel="nofollow"> </a>

                                        


    
      <a class="accept-answer on"
        title="Florian Haradji has selected this answer as the correct answer"
        href="/accept_answer/56989/" rel="nofollow">
      </a>
    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>First of all ctid should be a guint32, not a guint16 (you cannot make assumption on the alignment rules done by the compiler/processor and cast a pointer on guint 16 variable as guint32).</p>
<p>Calling dissector_try_uint after call_dissector_with_data is not an issue by its own, it just means that you give the same payload to 2 different dissectors (so the same data might be dissected twice with different protocols, which is weird).</p>
<p>There are changces your issue is in the dissectors registered to the newly created tte.ctid table. But as you did not share the code, it's up to you to find what's wrong ;)</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/56989/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>04 Nov '16, 10:29</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/713f24fd877861260b71ecd455018625?s=32&amp;d=identicon&amp;r=g" alt="Pascal%20Quantin's gravatar image" />
    <p><a href="/users/1538/pascal-quantin">Pascal Quantin</a><br/>
    <span class="score" title="5544 reputation points"><span class="">5.5k</span></span><span title="10 badges"><span class="silver">&#9679;</span><span class="badgecount">10</span></span><span title="60 badges"><span class="bronze">&#9679;</span><span class="badgecount">60</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Pascal Quantin has 92 accepted answers">30&#37;</span>
    </p>
</div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-56989">
    
        <a name="56990"></a>
        <div class="comment" id="comment-56990">
            <div id="post-56990-score" class="comment-score"></div>
            <div class="comment-text"><p>Well ctid fits on two bytes in the message, but yes, I'll try to use a guint32 instead, and see how it goes.</p>

<p>Yes I need the same data twice, which is weird...I have reasons for that but it will be too long and uninteresting to explain them here :)</p>

<p>I don't think the problem is in the dissectors on top of it, since their exact same code is used on top of the more classic "udp.port" dissector table, and no problem then. </p>

<p>Also, the fact that the problem appears only in CentOS 6.5 where GTK2 and associated libs are in a different version than in CentOS 7, and the valgrind trace explicitly showing gdk/cairo code is quite weird, don't you think?</p></div>
            <div class="comment-info" id="comment-56990-info">
                
                
                
                

                

                <span class="comment-age">(04 Nov '16, 10:37)</span>
                <a class="comment-user userinfo" href="/users/26207/florian-haradji">Florian Haradji</a>
                
            </div>
        </div>
    
        <a name="57009"></a>
        <div class="comment" id="comment-57009">
            <div id="post-57009-score" class="comment-score">1</div>
            <div class="comment-text"><blockquote>
<p>Well ctid fits on two bytes in the message,</p>
</blockquote>

<p>That's completely irrelevant.  <code>proto_tree_add_item_ret_uint()</code> is passed a pointer to a <code>guint32</code>, and assumes that the pointer does, in fact, point to a <code>guint32</code>, and thus stores into <em>four</em> bytes starting at the location in the pointer.  If you cast a pointer to a <code>guint16</code> to <code>guint32 *</code>, and pass that to <code>proto_tree_add_item_ret_uint()</code>, <code>proto_tree_add_item_ret_uint()</code> will store into that variable <strong><em>and the two bytes after that variable</em></strong>.</p>

<p>(We didn't complicate the API by having multiple <code>proto_tree_add_item_ret_</code> routines for different data types, taking return-value arguments of different sizes, so the return value will be bigger than the field for types narrower than <code>FT_UINT32</code>.)</p>

<p>So <strong><em>don't do that</em></strong>.  It will cause two random bytes to be overwritten, and where those two bytes happen to be could depend on...</p>

<blockquote>
<p>Also, the fact that the problem appears only in CentOS 6.5 where GTK2 and associated libs are in a different version than in CentOS 7</p>
</blockquote>

<p>...the version of the compiler used to compile the program, so the behavior could differ between a Wireshark compiled with gcc 4.4.7 20120313 (Red Hat 4.4.7-4) and one compiled with gcc 4.8.2 20140120 (Red Hat 4.8.2-16).  That difference could even include one version crashing and another version not crashing.</p>

<p>Valgrind will also complain about the store into the two bytes after the variable; that's what the "Invalid write of size 2" error probably is (unfortunately, Valgrind apparently doesn't handle the way the stack is handled by the call to the dissector, so it's probably not including the dissector itself in the stack trace).</p>

<blockquote>
<p>and the valgrind trace explicitly showing gdk/cairo code</p>
</blockquote>

<p>It's explicitly showing that <em>one</em> of the invalid writes is to memory that was <em>freed</em> (and presumably allocated) by gdk/cairo code.  That's an 8-byte write, so it's probably a completely separate problem from the 2-byte invalid write.  It's not immediately obvious what's causing <em>that</em> problem.</p></div>
            <div class="comment-info" id="comment-57009-info">
                
                
                
                

                

                <span class="comment-age">(04 Nov '16, 18:00)</span>
                <a class="comment-user userinfo" href="/users/79/guy-harris">Guy Harris ♦♦</a>
                
            </div>
        </div>
    
        <a name="57048"></a>
        <div class="comment" id="comment-57048">
            <div id="post-57048-score" class="comment-score"></div>
            <div class="comment-text"><p>And...that was it! It was a pretty obvious mistake, but I guess the valgrind stack trace was a little misleading. Plus the fact it didn't crash in another compiler/OS environment...I did not look in the right place.</p>

<p>So thank you all :)</p></div>
            <div class="comment-info" id="comment-57048-info">
                
                
                
                

                

                <span class="comment-age">(07 Nov '16, 03:47)</span>
                <a class="comment-user userinfo" href="/users/26207/florian-haradji">Florian Haradji</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-56989" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-56989-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/56988/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='fM0nSGHQvli49YTQ6N3kyNg7vlG9IYYZ' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/56988/memory-corruption-with-wireshark-20-gtk2-on-centos-65-when-using-a-patched-tte-dissector?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/dissector/"
            class="tag-link-dissector"
            title="see questions tagged'dissector'using tags"
            rel="tag">dissector</a> <span class="tag-number">&#215;637</span><br/>
        
        <a href="/tags/crash/"
            class="tag-link-crash"
            title="see questions tagged'crash'using tags"
            rel="tag">crash</a> <span class="tag-number">&#215;84</span><br/>
        
        <a href="/tags/gtk/"
            class="tag-link-gtk"
            title="see questions tagged'gtk'using tags"
            rel="tag">gtk</a> <span class="tag-number">&#215;25</span><br/>
        
        <a href="/tags/sub-dissector/"
            class="tag-link-sub-dissector"
            title="see questions tagged'sub-dissector'using tags"
            rel="tag">sub-dissector</a> <span class="tag-number">&#215;20</span><br/>
        
        <a href="/tags/patch/"
            class="tag-link-patch"
            title="see questions tagged'patch'using tags"
            rel="tag">patch</a> <span class="tag-number">&#215;11</span><br/>
        
    </p>
    <p>
        question asked: <strong title="Nov. 4, 2016, 10:04 a.m.">04 Nov '16, 10:04</strong>
    </p>
    <p> 
     	question was seen: <strong>962 times</strong>
    </p>
    <p> 
        last updated: <strong title="Nov. 7, 2016, 3:47 a.m.">07 Nov '16, 03:47</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/41554/gre-protocol-type">GRE Protocol Type</a>
        </p>
        
        <p>
            <a href="/questions/51758/qt-vs-gtk-info-column-differences-in-201-and-newer">QT vs GTK Info Column Differences in 2.0.1 and Newer</a>
        </p>
        
        <p>
            <a href="/questions/7060/using-dissectors-and-subdissectors">Using Dissectors and Subdissectors</a>
        </p>
        
        <p>
            <a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector">How can I decrypt SSL session with Lua dissector ?</a>
        </p>
        
        <p>
            <a href="/questions/16524/q-dissector-sub-items">[Q] Dissector Sub Items</a>
        </p>
        
        <p>
            <a href="/questions/2953/how-to-obtain-informations-from-a-dissector-inside-a-sub-dissector">How to obtain informations from a dissector inside a sub-dissector ?</a>
        </p>
        
        <p>
            <a href="/questions/37029/get-dissector-table-from-another-plugin">Get dissector table from another plugin</a>
        </p>
        
        <p>
            <a href="/questions/23390/extend-gre-dissector">Extend GRE dissector</a>
        </p>
        
        <p>
            <a href="/questions/3014/use-sub-dissector-in-dissector">Use sub-dissector in dissector</a>
        </p>
        
        <p>
            <a href="/questions/12559/prevent-patch-file-from-getting-outdated">Prevent Patch file from getting outdated</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
