<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>slow SMB file transfer - Wireshark Q&amp;A</title>
        <meta name="description" content="I am troubleshooting a slow file transfer over SMB from a Windows share to a VM running FreeBSD 10.3 FreeBSD 192.168.20.225, Windows 192.168.20.100 Is there anything in this 3 way handshake between the hosts that indicates a problem? (Window Size Value?) https://www.cloudshark.org/captures/2ade37ce2..." />
        <meta name="keywords" content="window,smb,freebsd,tcp" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/54047/slow-smb-file-transfer" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/54047/slow-smb-file-transfer?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='BvKzM2fqbi3kRJPJXPaONxBbFMVemJNv' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/54047/slow-smb-file-transfer">slow SMB file transfer</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-54047-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/54047/up/" rel="nofollow"> </a>
<div id="post-54047-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-54047-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/54047/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/54047/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>I am troubleshooting a slow file transfer over SMB from a Windows share to a VM running FreeBSD 10.3
FreeBSD 192.168.20.225, Windows 192.168.20.100</p>
<p>Is there anything in this 3 way handshake between the hosts that indicates a problem? (Window Size Value?)</p>
<p><a href="https://www.cloudshark.org/captures/2ade37ce25dd">https://www.cloudshark.org/captures/2ade37ce25dd</a></p>
<p>here is a graph of a 2GB file transfer from a Windows computer hosting the file</p>
<p><img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/2gbtranss.jpg"></p>
<p>here is a graph of what whireshark sees </p>
<p><img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/grafs.jpg"></p>
<p>Thank you</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/window/" class="post-tag tag-link-window"
                                        title="see questions tagged 'window'" rel="tag">window</a>
                                
                                    <a href="/tags/smb/" class="post-tag tag-link-smb"
                                        title="see questions tagged 'smb'" rel="tag">smb</a>
                                
                                    <a href="/tags/freebsd/" class="post-tag tag-link-freebsd"
                                        title="see questions tagged 'freebsd'" rel="tag">freebsd</a>
                                
                                    <a href="/tags/tcp/" class="post-tag tag-link-tcp"
                                        title="see questions tagged 'tcp'" rel="tag">tcp</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>13 Jul '16, 13:39</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/bcfdf26904f3a8a9fb69c7ca0dc5e7b1?s=32&amp;d=identicon&amp;r=g" alt="net_tech's gravatar image" />
    <p><a href="/users/249/net_tech">net_tech</a><br/>
    <span class="score" title="116 reputation points">116</span><span title="30 badges"><span class="badge1">&#9679;</span><span class="badgecount">30</span></span><span title="33 badges"><span class="silver">&#9679;</span><span class="badgecount">33</span></span><span title="37 badges"><span class="bronze">&#9679;</span><span class="badgecount">37</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="net_tech has 2 accepted answers">13&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/54047/">
                edited
                <strong>13 Jul '16, 13:53</strong>
            </a>
        </p>
        
    </div>


                            </div>
                            




<div class="comments-container" id="comments-container-54047">
    
        <a name="54069"></a>
        <div class="comment" id="comment-54069">
            <div id="post-54069-score" class="comment-score"></div>
            <div class="comment-text"><p>Just seeing the 3-way handshake's not going to help.  The Wireshark graph shows the throughput bouncing all over the place and even dropping to 0 for some seconds.  We'd need to see the whole capture to analyze it.</p>

<p>Alternatively I'd suggest looking at (and using some of the analysis techniques) described at Ronnie's excellent "analyze CIFS Traffic" presentation available on the <a href="https://wiki.wireshark.org/Presentations">Presentations page</a> of the wiki.</p></div>
            <div class="comment-info" id="comment-54069-info">
                
                
                
                

                

                <span class="comment-age">(14 Jul '16, 11:32)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="54070"></a>
        <div class="comment" id="comment-54070">
            <div id="post-54070-score" class="comment-score"></div>
            <div class="comment-text"><p>Here is a capture of the transfer via FTP between the same hosts, which looks even worse than SMB  (500MB file)</p>

<p><a href="https://www.dropbox.com/s/9a3exw8u6htijii/ftp.pcapng?dl=0">https://www.dropbox.com/s/9a3exw8u6htijii/ftp.pcapng?dl=0</a></p></div>
            <div class="comment-info" id="comment-54070-info">
                
                
                
                

                

                <span class="comment-age">(14 Jul '16, 12:20)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="54072"></a>
        <div class="comment" id="comment-54072">
            <div id="post-54072-score" class="comment-score"></div>
            <div class="comment-text"><p>tiny portion of the SMB trace Windows -&gt; FreeBSD
<a href="https://www.cloudshark.org/captures/bf42fc4b294b">https://www.cloudshark.org/captures/bf42fc4b294b</a></p>

<p>Is Frame #7 an acknowledgment for Frame #6? There is a 7 seconds delay between the packets, which illustrates the drop in the graph above.</p></div>
            <div class="comment-info" id="comment-54072-info">
                
                
                
                

                

                <span class="comment-age">(14 Jul '16, 18:47)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="54080"></a>
        <div class="comment" id="comment-54080">
            <div id="post-54080-score" class="comment-score"></div>
            <div class="comment-text"><p>The trace is made onside host with "segmentation offload = yes". If you want to see what really is going on you have to trace outside as close as possible to the machine. Best recomendation: Use a tap.</p></div>
            <div class="comment-info" id="comment-54080-info">
                
                
                
                

                

                <span class="comment-age">(15 Jul '16, 12:24)</span>
                <a class="comment-user userinfo" href="/users/16160/christian_r">Christian_R</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-54047" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-54047-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    2 Answers:
                    </div>
                    
<div class="tabsA"><a href="/questions/54047/slow-smb-file-transfer?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/54047/slow-smb-file-transfer?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/54047/slow-smb-file-transfer?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/54047/slow-smb-file-transfer?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="54137"></a>
                    <div id="answer-container-54137" class="answer ">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-54137-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/54137/up/" rel="nofollow"> </a>
<div id="post-54137-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-54137-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/54137/down/" rel="nofollow"> </a>

                                        


    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>The SMB trace suggests that the client (FreeBSD VM) is slow.  Yes, it would be nice to see it with segmentation offload disabled but I'm not sure it matters in this case.  The big packets are coming from the Windows machine and the traffic was captured on the Windows machine.  The 7 second delay isn't from the big packets it's from the next read request from the client.</p>
<p>The FTP trace is similar.  There's a large burst of traffic at the beginning (peaking at 50,000,000 bytes/sec) but then quickly slows down to (and stabilizes) around 4,000,000 bytes/sec.</p>
<p>I don't see much in the way of transport problems (e.g., packet loss).  I don't know if the segmentation offload is hiding this--I've never worked much with TSO enabled.</p>
<p>These two traces <em>suggest</em> to me that the (FreeBSD VM) client is slow and I would further theorize that it may be the filesystem that is slow.</p>
<p>You might want to time some (large) file creations on the VM to test the theory.  For example:</p>
<pre><code>time dd if=/dev/zero of=/some/file bs=1m count=500
</code></pre>
<p>Will create a 500 Mbyte file and tell you how long it took.  Do some math and find out what the filesystem write speed is.  If you get something on the order of 4 Mbytes/sec (like the FTP transfer) then that's your problem.  If it's <strong>much</strong> faster then my theory's no good.</p>
<p>Note: the above would work on Linux; I think it will work on FreeBSD too.</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/54137/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>18 Jul '16, 11:25</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/e0564001bb7deb960d5d9d9c1e0ba074?s=32&amp;d=identicon&amp;r=g" alt="JeffMorriss's gravatar image" />
    <p><a href="/users/655/jeffmorriss">JeffMorriss ♦</a><br/>
    <span class="score" title="6219 reputation points"><span class="">6.2k</span></span><span title="5 badges"><span class="silver">&#9679;</span><span class="badgecount">5</span></span><span title="72 badges"><span class="bronze">&#9679;</span><span class="badgecount">72</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="JeffMorriss has 103 accepted answers">27&#37;</span>
    </p>
</div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-54137">
    
        <a name="54189"></a>
        <div class="comment" id="comment-54189">
            <div id="post-54189-score" class="comment-score"></div>
            <div class="comment-text"><p>Output:</p>

<pre><code>500+0 records in
500+0 records out
524288000 bytes transferred in 0.782651 secs (669887389 bytes/sec)
0.000u 0.582s 0:00.78 74.3% 25+171k 0+1io 0pf+0w
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0b7964647f4b6d796e6e69786f">[email&#160;protected]</a>:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500

500+0 records in
500+0 records out
524288000 bytes transferred in 0.602017 secs (870885468 bytes/sec)
0.000u 0.240s 0:00.60 40.0% 22+153k 0+0io 0pf+0w
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0f7d60607b4f697d6a6a6d7c6b">[email&#160;protected]</a>:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500

500+0 records in
500+0 records out
524288000 bytes transferred in 0.656157 secs (799028261 bytes/sec)
0.000u 0.235s 0:00.65 35.3% 25+171k 0+0io 0pf+0w
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="95e7fafae1d5f3e7f0f0f7e6f1">[email&#160;protected]</a>:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500
</code></pre></div>
            <div class="comment-info" id="comment-54189-info">
                
                
                
                

                

                <span class="comment-age">(20 Jul '16, 08:15)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="54209"></a>
        <div class="comment" id="comment-54209">
            <div id="post-54209-score" class="comment-score"></div>
            <div class="comment-text"><p>So the disk is certainly fast enough...</p>

<p>Looking again at the FTP capture I can see two things of interest:</p>

<ol>
<li>If I graph the client's available window size it never drops below like 50k (so: the server is not filling the client's window--in other words the server isn't sending as fast as it could)</li>
<li>(and) if I filter for <code>ftp-data</code> and then change the time display to "seconds since previously displayed packet" I can see that, once the throughput has gotten slow, the server is only sending another (50kbyte) packet every 8-12 milliseconds.  That's pretty slow.  This is also visible without a filter: the time between the last ACK from the client and the next FTP-DATA appears to always be 4+ milliseconds.</li>
</ol>

<p>Is this (Windows) server able to send files (of this size) to other clients at higher speeds?</p></div>
            <div class="comment-info" id="comment-54209-info">
                
                
                
                

                

                <span class="comment-age">(20 Jul '16, 14:17)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55521"></a>
        <div class="comment" id="comment-55521">
            <div id="post-55521-score" class="comment-score"></div>
            <div class="comment-text"><p>Yes, Windows 7 (acting as a server) is capable of sending at 115MB/s</p>

<p>Here is a diagram of the current setup. VMWare server is hosting 2VMs. 
Windows Server 2012 and FreeBSD. Windows 7 Workstation on the right is a physical computer with a network share. Transferring a test 2GB file from a Win 7 PC to a 2012 Server VM is almost wire speed, transferring the same 2GB file from a Win 7 to a FreeBSD VM is extremely slow. Both VMs (FreeBSD and Win 2012) have identical hardware assigned to them, there is no special memory/cpu/hard drive reservations. </p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/diag.jpg"></p></div>
            <div class="comment-info" id="comment-55521-info">
                
                
                
                

                

                <span class="comment-age">(13 Sep '16, 07:01)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55542"></a>
        <div class="comment" id="comment-55542">
            <div id="post-55542-score" class="comment-score"></div>
            <div class="comment-text"><p>I spun up another Win 7 VM and enabled promiscuous mode on the vSwitch  so my new Win 7 VM running Wireshark could see all traffic between the FreeBSD and Windows 7 PC. </p>

<p>Windows 7 PC hosting the SMB share is now at 192.168.20.103,
FreeBSD is at 192.168.20.225</p>

<p>New capture could be downloaded <a href="https://www.dropbox.com/s/vcivexl2e4usdaa/2gb.pcapng?dl=0">here</a>  (1.2GB)</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/2gb.jpg"></p></div>
            <div class="comment-info" id="comment-55542-info">
                
                
                
                

                

                <span class="comment-age">(13 Sep '16, 18:58)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55556"></a>
        <div class="comment" id="comment-55556">
            <div id="post-55556-score" class="comment-score"></div>
            <div class="comment-text"><p>there is a 7 seconds delay around frame 368749, if it does turn out to be the file system (ZFS) problem, is there anything in the trace to support this theory?</p>

<p>Thanks</p></div>
            <div class="comment-info" id="comment-55556-info">
                
                
                
                

                

                <span class="comment-age">(14 Sep '16, 07:42)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55560"></a>
        <div class="comment not_top_scorer" id="comment-55560">
            <div id="post-55560-score" class="comment-score"></div>
            <div class="comment-text"><p>Well frame 368749 is a SMB Read Request (from FreeBSD) which is <strong>14 seconds</strong> after the last message in that (TCP) conversation.  That 14 second delay certainly appears to be due to something on the (FreeBSD) client but whether that's the filesystem or something else is another question...</p></div>
            <div class="comment-info" id="comment-55560-info">
                
                
                
                

                

                <span class="comment-age">(14 Sep '16, 13:44)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55562"></a>
        <div class="comment not_top_scorer" id="comment-55562">
            <div id="post-55562-score" class="comment-score"></div>
            <div class="comment-text"><p>Looking at the throughput in the latest file your original supposition may have been correct: it appears that the Windows server is filling the client's TCP window.  The client is not setting window scaling which is limiting Windows to 62k before it has to stop and wait.  (This is visible if you graph <code>tcp.analysis.bytes_in_flight</code> from the server or if you filter for frames where that value is large--like more than 60000.)</p>

<p>Can you enable window scaling on FreeBSD?</p></div>
            <div class="comment-info" id="comment-55562-info">
                
                
                
                

                

                <span class="comment-age">(14 Sep '16, 14:41)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55571"></a>
        <div class="comment not_top_scorer" id="comment-55571">
            <div id="post-55571-score" class="comment-score"></div>
            <div class="comment-text"><p>According to <a href="https://wiki.freebsd.org/SystemTuning">https://wiki.freebsd.org/SystemTuning</a> 
RFC1323 support is enabled by default, but I went ahead and applied the suggested settings from this post <a href="https://slaptijack.com/system-administration/freebsd-tcp-performance-tuning.">https://slaptijack.com/system-administration/freebsd-tcp-performance-tuning.</a> Unfortunately there was no improvement. </p>

<p>I also experimented with another FreeBSD VM using USF. Here is the graph.</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/ufs.jpg"></p></div>
            <div class="comment-info" id="comment-55571-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '16, 13:54)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55572"></a>
        <div class="comment not_top_scorer" id="comment-55572">
            <div id="post-55572-score" class="comment-score"></div>
            <div class="comment-text"><p>finally I bumped the ram of the FreeBSD VM from 4GB to 8GB. This is the 1st time I was able to transfer a 2GB file at half the gigabit speeds and minimal drops.</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/8gb.jpg"></p></div>
            <div class="comment-info" id="comment-55572-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '16, 13:56)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55573"></a>
        <div class="comment not_top_scorer" id="comment-55573">
            <div id="post-55573-score" class="comment-score"></div>
            <div class="comment-text"><p>Interesting...  Is FreeBSD now advertising large TCP windows (via window scaling)?  At what point did it start doing that (which change did it)?</p>

<p>The "throw memory at it" fix makes me wonder about some of the notes on the FreeBSD pages about needing to increase network memory buffers when enabling TCP window scaling...  If that's the case there may be some other config options to try.</p></div>
            <div class="comment-info" id="comment-55573-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '16, 14:07)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55579"></a>
        <div class="comment not_top_scorer" id="comment-55579">
            <div id="post-55579-score" class="comment-score"></div>
            <div class="comment-text"><p>no, the largest Window size value is still 1040. I want to do another test on a physical FreeBSD system. I am not using NFS, but suspect virtualization could be adding some complexity to this puzzle
<a href="https://calvin.me/slow-vmware-nfs-zfs-add-zil/">https://calvin.me/slow-vmware-nfs-zfs-add-zil/</a></p></div>
            <div class="comment-info" id="comment-55579-info">
                
                
                
                

                

                <span class="comment-age">(15 Sep '16, 19:15)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55600"></a>
        <div class="comment not_top_scorer" id="comment-55600">
            <div id="post-55600-score" class="comment-score"></div>
            <div class="comment-text"><p>1040?  In the "2gb" file I was looking at FreeBSD was advertising 64k (in both the SYN and in all the TCP ACKs).</p></div>
            <div class="comment-info" id="comment-55600-info">
                
                
                
                

                

                <span class="comment-age">(16 Sep '16, 10:49)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55601"></a>
        <div class="comment not_top_scorer" id="comment-55601">
            <div id="post-55601-score" class="comment-score"></div>
            <div class="comment-text"><p>sorry, it's still 64k </p>

<p>but this could be the answer why the performance is better with 8GB</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/zfsn.jpg"></p></div>
            <div class="comment-info" id="comment-55601-info">
                
                
                
                

                

                <span class="comment-age">(16 Sep '16, 11:45)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55605"></a>
        <div class="comment not_top_scorer" id="comment-55605">
            <div id="post-55605-score" class="comment-score"></div>
            <div class="comment-text"><p>Hmm, isn't prefetching for optimizing (sequential) <strong>reads</strong>?  Here the BSD client is reading from a remote server and writing locally.</p></div>
            <div class="comment-info" id="comment-55605-info">
                
                
                
                

                

                <span class="comment-age">(16 Sep '16, 12:50)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="55669"></a>
        <div class="comment not_top_scorer" id="comment-55669">
            <div id="post-55669-score" class="comment-score"></div>
            <div class="comment-text"><p>you are correct, prefetching would help if I was reading from the BSD client. I thought the better result was from the memory increase, apparently it's from UFS. </p>

<p>To rule out virtualization, I built another BSD client on physical machine with an SSD drive and ZFS.</p>

<p>Results are much better with no drops in the file transfer, which leaves VMware being a part of the problem.</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/phys_zfs.jpg"></p></div>
            <div class="comment-info" id="comment-55669-info">
                
                
                
                

                

                <span class="comment-age">(19 Sep '16, 18:05)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
        <a name="55670"></a>
        <div class="comment not_top_scorer" id="comment-55670">
            <div id="post-55670-score" class="comment-score"></div>
            <div class="comment-text"><p>Do you think increasing the TCP window on a BSD system will improve the throughput?</p>

<p>Executing <strong>sysctl net.inet.tcp</strong> on a BSD system shows that rfc1323 is enabled by default. </p>

<blockquote>
<p>net.inet.tcp.rfc1323: 1</p>
</blockquote>

<p>FreeBSD 10.3 VM TCP Window</p>

<p><img alt="link text" src="http://www.remontnetworks.com/freebsd/fbsdws.jpg"></p>

<p>Win 2012 VM TCP Window</p>

<p><img alt="alt text" src="http://www.remontnetworks.com/freebsd/winws.jpg"></p>

<p>Thank you</p></div>
            <div class="comment-info" id="comment-55670-info">
                
                
                
                

                

                <span class="comment-age">(19 Sep '16, 18:09)</span>
                <a class="comment-user userinfo" href="/users/249/net_tech">net_tech</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-54137" class="comment-tools">
    
        <span class="comments-showing">
            showing 5 of 16
        </span>
        <a href="#" class="show-all-comments-link">show 11 more comments</a>
    
    
</div>




<div class="clear"></div>
<div id="comment-54137-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                    <a name="59579"></a>
                    <div id="answer-container-59579" class="answer ">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-59579-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/59579/up/" rel="nofollow"> </a>
<div id="post-59579-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-59579-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/59579/down/" rel="nofollow"> </a>

                                        


    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>I had a look at the capture named "2gb".</p>
<p>It is missing a lot of packets because the sniffer dropped them, not because the network dropped them. These occur at very regular intervals - not randomly.  At the time period I delved into, for every 35-37ms of data captured there was then 70-74ms of data missing. This would lead me to believe that the capturing mechanism has an inherent flaw, perhaps based on the virtualisation.</p>
<p>Nevertheless, we can find some useful information.</p>
<p>Although we don't see the 3-way handshake for the main SMB connection, other SYN/SYN-ACK setups between the same client and server don't support Window Scaling. Therefore, we can only ever have 64KB in flight (i.e., per round trip).  Put another way, we can only do one SMB request/response at a time (because each SMB requests a 64 KB data block).</p>
<p>This may not matter in this case because the "slowness" is entirely due to the client.</p>
<p>We are achieving a throughput of ~500 Mb/s because we are achieving only approximately 64 KB/ms.
This is because the client is only making one request per 1 or 2 ms.  Each request is serviced very quickly and the 64 KB is delivered from the server across the network very quickly. The client usually ACKs the server data quickly, except for the last few packets which are ACKed by the client's next SMB READ&amp;X request packet.</p>
<p>The time gaps between the client's request packet and the last server packet are consistently just under 0.4ms. The time from the last server packet and the client's next request packet is consistently just under 0.6ms. The time between client request packets is consistently 1ms +/- 0.2ms.</p>
<p>The network RTT seems to be around 0.2ms, so the time gaps between client requests are not related to the network.  They are time spent by the client dealing with the received data before bothering to request the next block. The large 14 second time gap is, likewise, due to the client. </p>
<p>So your hunt is to determine why the client waits so long between requests.</p>
<ul>
<li>Could it be that it takes it that long to write the received 64 KB away?</li>
<li>Could the virtualisation be playing a part? 
        Eg, the virtual servers or network components only get a "turn" once per millisecond?</li>
</ul>
<p>I'd also be interested in why Windows Scaling doesn't appear to be enabled. The client doesn't request it in its SYN packets.  It would be interesting to know if enabling it would make a difference.</p>
<p>Happy hunting! </p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/59579/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>21 Feb '17, 02:04</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/35a0c1d0cf15b9d54d73bf54ae28abcd?s=32&amp;d=identicon&amp;r=g" alt="Philst's gravatar image" />
    <p><a href="/users/26122/philst">Philst</a><br/>
    <span class="score" title="431 reputation points">431</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="6 badges"><span class="silver">&#9679;</span><span class="badgecount">6</span></span><span title="16 badges"><span class="bronze">&#9679;</span><span class="badgecount">16</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Philst has 6 accepted answers">27&#37;</span>
    </p>
</div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-59579">
    
</div>
<div id="comment-tools-59579" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-59579-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/54047/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='BvKzM2fqbi3kRJPJXPaONxBbFMVemJNv' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/54047/slow-smb-file-transfer?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/54047/slow-smb-file-transfer?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/tcp/"
            class="tag-link-tcp"
            title="see questions tagged'tcp'using tags"
            rel="tag">tcp</a> <span class="tag-number">&#215;752</span><br/>
        
        <a href="/tags/window/"
            class="tag-link-window"
            title="see questions tagged'window'using tags"
            rel="tag">window</a> <span class="tag-number">&#215;55</span><br/>
        
        <a href="/tags/smb/"
            class="tag-link-smb"
            title="see questions tagged'smb'using tags"
            rel="tag">smb</a> <span class="tag-number">&#215;52</span><br/>
        
        <a href="/tags/freebsd/"
            class="tag-link-freebsd"
            title="see questions tagged'freebsd'using tags"
            rel="tag">freebsd</a> <span class="tag-number">&#215;3</span><br/>
        
    </p>
    <p>
        question asked: <strong title="July 13, 2016, 1:39 p.m.">13 Jul '16, 13:39</strong>
    </p>
    <p> 
     	question was seen: <strong>5,766 times</strong>
    </p>
    <p> 
        last updated: <strong title="Feb. 21, 2017, 2:04 a.m.">21 Feb '17, 02:04</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/4610/tcp-window-full">TCP window full</a>
        </p>
        
        <p>
            <a href="/questions/20156/windows-size-256">Windows size 256</a>
        </p>
        
        <p>
            <a href="/questions/28056/tcp-window-full-message-after-receiving-ack">TCP window full message after receiving ACK?</a>
        </p>
        
        <p>
            <a href="/questions/15885/wireshark-filter-for-window-size">Wireshark filter for window size</a>
        </p>
        
        <p>
            <a href="/questions/31048/tcp-window-keeps-decreasing-on-pshacks">TCP window keeps decreasing on PSH,ACKs</a>
        </p>
        
        <p>
            <a href="/questions/38512/file-transfer-cature-question-runs-slow">File transfer cature question runs slow</a>
        </p>
        
        <p>
            <a href="/questions/11413/why-do-i-have-video-stutter-through-netgear-mcab1001-moca-adapters-possibly-related-to-tcp-window">Why Do I Have Video Stutter Through Netgear MCAB1001 MoCA Adapters--Possibly Related to TCP Window</a>
        </p>
        
        <p>
            <a href="/questions/24316/tcp-window-size">TCP window Size</a>
        </p>
        
        <p>
            <a href="/questions/42695/why-acknowledgments-sent-early-than-window-size-reached-during-tcp-session">Why acknowledgments sent early than window size reached during TCP session?</a>
        </p>
        
        <p>
            <a href="/questions/45146/tcp-transmission-deviates-from-receive-window-any-legitimate-reason">TCP transmission deviates from receive window - any legitimate reason</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
