<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>How can I decrypt SSL session with Lua dissector ? - Wireshark Q&amp;A</title>
        <meta name="description" content="Hello everyone I used to decrypt HTTPS session by providing &quot;Client Random&quot; and &quot;Master Secret&quot; into wireshark. Recently, I need to decrypt SSL session which is created in USB communication. USB header is parsed by wireshark.  But some byte and SSL header are not parsed by wireshark. it just show me..." />
        <meta name="keywords" content="ssl_decrypt,ssl,dissector,sub-dissector,lua" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='qhxLi1o0lRkUAj2RMbn9B5b7dzjeLV8K' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector">How can I decrypt SSL session with Lua dissector ?</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-56115-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/56115/up/" rel="nofollow"> </a>
<div id="post-56115-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-56115-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/56115/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/56115/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>Hello everyone</p>
<p>I used to decrypt HTTPS session by <a href="https://jimshaver.net/2015/02/11/decrypting-tls-browser-traffic-with-wireshark-the-easy-way/">providing "Client Random" and "Master Secret" into wireshark.</a></p>
<p>Recently, I need to decrypt SSL session which is created in USB communication. USB header is parsed by wireshark. </p>
<p>But some byte and SSL header are not parsed by wireshark. it just show me payload as "Leftover Capture Data"</p>
<p><img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/1_49orC6T.jpg"></p>
<p>So I decide to use Lua script for parsing "Leftover Capture Data" as 28-byte unknown protocol and SSL.</p>
<p>My Lua script is </p>
<pre><code>    local ios_usb = Proto("iOS_USB", "iOS USB Protocol")
    local ios_temp = Proto("iOS", "iOS USB TEMP Protocol")

    local msgtype  = ProtoField.new( "Unknown #1","ios.msgtype", ftypes.UINT32)
    local memaddr  = ProtoField.new( "Unknown #2","ios.memaddr", ftypes.UINT32)
    local memlen   = ProtoField.new( "Unknown #3", "ios.memlen",ftypes.UINT32)
    local regdata  = ProtoField.new( "Unknown #4","ios.regdata", ftypes.UINT32)
    local stopdata1 = ProtoField.new( "Unknown #5","ios.stopdata1", ftypes.UINT32)
    local stopdata2 = ProtoField.new( "Unknown #6","ios.stopdata2", ftypes.UINT32)
    local stopdata3 = ProtoField.new( "Unknown #7", "ios.stopdata3",ftypes.UINT32)

    ios_usb.fields = {msgtype, memaddr, memlen, regdata, stopdata1, stopdata2, stopdata3}

    local f_urb_type = Field.new("usb.urb_type")
    local f_transfer_type = Field.new("usb.transfer_type")
    local f_endpoint = Field.new("usb.endpoint_number.endpoint")

    function ios_usb.dissector(tvbuf, pktinfo, root)
     pktinfo.cols.protocol:set("iOS_USB")
     local pktlen = tvbuf:reported_length_remaining()

     if pktlen &lt; 28 then
        return pktlen
    end

    if pktlen == 28 then

        root:add(ios_temp,tvbuf:range(0,0))
        return 28
    end

     local tree = root:add(ios_usb, tvbuf:range(0,pktlen))
     local transfer_type = tonumber(tostring(f_transfer_type))
     local ssl_dis =Dissector.get("ssl")

                pktinfo.cols.protocol = ios_usb.name

                tree:add(msgtype, tvbuf:range(0,4))
                tree:add(memaddr, tvbuf:range(4,4))
                tree:add(memlen, tvbuf:range(8,4))
                tree:add(regdata, tvbuf:range(12,4))
                tree:add(stopdata1, tvbuf:range(16,4))
                tree:add(stopdata2, tvbuf:range(20,4))
                tree:add(stopdata3, tvbuf:range(24,4))

    local newbuf = tvbuf:range(28,pktlen-28):tvb()
    local first = tvbuf:range(28,1):uint()

    if first == 0x16 or first == 0x17 then

            ssl_dis:call(newbuf,pktinfo,root)
    end

        return pktlen
    end

function ios_usb.init()

    local usb_bulk_dissectors = DissectorTable.get("usb.bulk")
    usb_bulk_dissectors:add(0xFF, ios_usb)

end
</code></pre>
<p>This script can parse SSL header successfully</p>
<p>I also extract Client Random and Master secret. And I put it in the Preferences -&gt; Protocols -&gt; SSL -&gt; (Pre)master-Secret Log file</p>
<p>Even though I give key file for decrypting, I cannot get decrypted payload of SSL.</p>
<p><img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/2_F0BITN4.jpg"></p>
<p>Is there any tips for decrypting ssl session using Lua ssl dissector?</p>
<p>Thank you!</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/ssl_decrypt/" class="post-tag tag-link-ssl_decrypt"
                                        title="see questions tagged 'ssl_decrypt'" rel="tag">ssl_decrypt</a>
                                
                                    <a href="/tags/ssl/" class="post-tag tag-link-ssl"
                                        title="see questions tagged 'ssl'" rel="tag">ssl</a>
                                
                                    <a href="/tags/dissector/" class="post-tag tag-link-dissector"
                                        title="see questions tagged 'dissector'" rel="tag">dissector</a>
                                
                                    <a href="/tags/sub-dissector/" class="post-tag tag-link-sub-dissector"
                                        title="see questions tagged 'sub-dissector'" rel="tag">sub-dissector</a>
                                
                                    <a href="/tags/lua/" class="post-tag tag-link-lua"
                                        title="see questions tagged 'lua'" rel="tag">lua</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>03 Oct '16, 23:05</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/417042f4a5ae00104a6b7683d86f1687?s=32&amp;d=identicon&amp;r=g" alt="yobob's gravatar image" />
    <p><a href="/users/25620/yobob">yobob</a><br/>
    <span class="score" title="26 reputation points">26</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">&#9679;</span><span class="badgecount">1</span></span><span title="6 badges"><span class="bronze">&#9679;</span><span class="badgecount">6</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="yobob has no accepted answers">0&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/56115/">
                edited
                <strong>04 Oct '16, 02:13</strong>
            </a>
        </p>
        
    </div>


                            </div>
                            




<div class="comments-container" id="comments-container-56115">
    
        <a name="56120"></a>
        <div class="comment" id="comment-56120">
            <div id="post-56120-score" class="comment-score">1</div>
            <div class="comment-text"><p>Wow for the idea. However, I'm afraid that to get a real solution, you'll need to file a bug (category enhancement), because currently, part of ssl decryption configuration is to tell the ssl dissector what other dissector to use to handle the decrypted data, and the fields used as index to the table are IP address and tcp port.</p>

<p>As a temporary workaround I could imagine to use tshark to extract the payload from the URBs (<code>-T fields -e usb.addr -e usb.capdata</code>) and feed its output to a script which would provide fake TCP headers to the data - which, however, would also not be an easy task as you would have to properly imitate at least the seq and ack numbers so that the tcp dissector would be happy. The script could output a simple hexdump format which you would then feed to text2pcap or import it to Wireshark using <code>File -&gt; Import from Hex Dump</code>.</p></div>
            <div class="comment-info" id="comment-56120-info">
                
                
                
                

                

                <span class="comment-age">(04 Oct '16, 02:26)</span>
                <a class="comment-user userinfo" href="/users/19586/sindy">sindy</a>
                
            </div>
        </div>
    
        <a name="56123"></a>
        <div class="comment" id="comment-56123">
            <div id="post-56123-score" class="comment-score"></div>
            <div class="comment-text"><p>An idea which didn't come to my mind instantly would be to use Lua to create these fake TCP and IP headers during dissection (you'd have to create a new tvb containing the fake headers followed by the data extracted from the URB), and you would have to save the values for the headers as each frame may be dissected multiple times - they are dissected in sequence only once during loading or capture of the file.</p></div>
            <div class="comment-info" id="comment-56123-info">
                
                
                
                

                

                <span class="comment-age">(04 Oct '16, 03:05)</span>
                <a class="comment-user userinfo" href="/users/19586/sindy">sindy</a>
                
            </div>
        </div>
    
        <a name="56124"></a>
        <div class="comment" id="comment-56124">
            <div id="post-56124-score" class="comment-score"></div>
            <div class="comment-text"><p>Would it be easier to create UDP headers, and then you'd have <a href="https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security">DTLS</a>?</p></div>
            <div class="comment-info" id="comment-56124-info">
                
                
                
                

                

                <span class="comment-age">(04 Oct '16, 03:13)</span>
                <a class="comment-user userinfo" href="/users/1225/grahamb">grahamb ♦</a>
                
            </div>
        </div>
    
        <a name="56126"></a>
        <div class="comment" id="comment-56126">
            <div id="post-56126-score" class="comment-score"></div>
            <div class="comment-text"><p>I'm not sure. DTLS uses its own sequence numbering to ensure that the TLS PDUs are properly ordered, plus it uses an indicator of cipher state changes, so instead of generating TCP's <code>seq</code> and <code>ack</code> values <strong>outside</strong> the original encrypted data, you'd have to take care about DTLS's <code>sequence_number</code> and <code>epoch</code> <strong>in the middle of</strong> the encrypted data.</p></div>
            <div class="comment-info" id="comment-56126-info">
                
                
                
                

                

                <span class="comment-age">(04 Oct '16, 03:26)</span>
                <a class="comment-user userinfo" href="/users/19586/sindy">sindy</a>
                
            </div>
        </div>
    
        <a name="56128"></a>
        <div class="comment not_top_scorer" id="comment-56128">
            <div id="post-56128-score" class="comment-score"></div>
            <div class="comment-text"><p>Ah, I've only looked at DTLS ever so briefly and obviously didn't understand the intricacies.</p></div>
            <div class="comment-info" id="comment-56128-info">
                
                
                
                

                

                <span class="comment-age">(04 Oct '16, 03:43)</span>
                <a class="comment-user userinfo" href="/users/1225/grahamb">grahamb ♦</a>
                
            </div>
        </div>
    
        <a name="56174"></a>
        <div class="comment not_top_scorer" id="comment-56174">
            <div id="post-56174-score" class="comment-score"></div>
            <div class="comment-text"><p>Thank you for your comments. I will try to replace USB header to TCP dummy header.
By the way, the Lua ssl dissector is different with the default ssl dissector of wireshark?</p></div>
            <div class="comment-info" id="comment-56174-info">
                
                
                
                

                

                <span class="comment-age">(05 Oct '16, 20:01)</span>
                <a class="comment-user userinfo" href="/users/25620/yobob">yobob</a>
                
            </div>
        </div>
    
        <a name="56177"></a>
        <div class="comment" id="comment-56177">
            <div id="post-56177-score" class="comment-score">1</div>
            <div class="comment-text"><p>There is no such thing like "Lua SSL dissector" (unless you have written your own one but in such case the question would make no sense, right?). Lua dissectors can invoke C dissectors and vice versa.</p>

<p><strong>Replacing</strong> USB header with a TCP dummy header is not exactly what I had in mind. A dissector normally acts on the actual bytes of a captured frame and from its point of view, these bytes are read-only. But any dissector can create additional bytes of data and ask a higher layer dissector to handle them as if they were part of the captured frame.</p>

<p>So what I've recommended was to create the IP and TCP header as a byte array, concatenate to it the payload extracted from the URB, and use the  <a href="https://wiki.wireshark.org/LuaAPI/ByteArray#ByteArray.tvb.28bytearray.2C_name.29">bytearray:tvb</a> function to create a new tvb from it and call the existing IP dissector, giving it your new tvb as a target.</p>

<p>The IP header must be there too because the SSL dissector uses both IP address and port as keys to the table choosing the right dissector for the decrypted payload, and because you have to specify even <code>data</code> (i.e. no dissection, just display of the contents in hexadecimal) explicitly.</p>

<p>Myself I would use IP address <code>10.0.0.1</code> to represent the USB host and <code>10.0.bus.device</code> to represent the USB endpoint, so an URB from <code>host</code> to <code>2.1.4</code> would have <code>10.0.0.1</code> as IP source and <code>10.0.2.1</code> as IP destination, and vice versa. The server side TCP port should be set to a value to which no other dissector of TCP payload is linked by default, something like <code>33333</code>, and you may link the <code>ssl</code> dissector to that TCP port already in your initialization code:</p>

<pre><code>DissectorTable.get("tcp.port"):add(33333,Dissector.get("ssl"))
</code></pre>

<p>The client side port should be in the range from <code>40000</code> up.</p>

<p>As already written, the TCP header cannot be totally dummy because otherwise the TCP dissector would not invoke the higher layer dissector (in our case, the SSL one). I believe, though, that it is not necessary to simulate the SYN, SYN+ACK, ACK session establishment sequence.</p></div>
            <div class="comment-info" id="comment-56177-info">
                
                
                
                

                

                <span class="comment-age">(05 Oct '16, 22:29)</span>
                <a class="comment-user userinfo" href="/users/19586/sindy">sindy</a>
                
            </div>
        </div>
    
        <a name="56213"></a>
        <div class="comment not_top_scorer" id="comment-56213">
            <div id="post-56213-score" class="comment-score"></div>
            <div class="comment-text"><p>One more point, as USB by nature uses distinct data endpoints for in and out directions even if they form up a bi-directional logical channel, the <code>ssl</code> dissector would not even know that the messages to one endpoint and the messages from the other one belong to the same conversation. To let the <code>ssl</code> dissector handle the conversation properly, the fake IP and TCP headers must use the same pair of IP:port tuples, properly oriented as source and destination depending on the URB direction. What my workaround suggestion ignores is that the USB device may theoretically use several pairs of data endpoints and that in such case, the only way to determine which IN endpoint works in tandem with which OUT endpoint would be to analyse the descriptors.</p>

<p>For the record, of course the clean way would be to file an enhancement "bug" asking for the <code>ssl</code> dissector to understand USB conversations directly, without the need to create fake IP and TCP headers, as stated in my first reaction. But that would require some investigation into the issue above, i.e. to verify and describe a method of determination which endpoints form up a bi-directional logical channel.</p></div>
            <div class="comment-info" id="comment-56213-info">
                
                
                
                

                

                <span class="comment-age">(07 Oct '16, 01:08)</span>
                <a class="comment-user userinfo" href="/users/19586/sindy">sindy</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-56115" class="comment-tools">
    
        <span class="comments-showing">
            showing 5 of 8
        </span>
        <a href="#" class="show-all-comments-link">show 3 more comments</a>
    
    
</div>




<div class="clear"></div>
<div id="comment-56115-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    One Answer:
                    </div>
                    
<div class="tabsA"><a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="56230"></a>
                    <div id="answer-container-56230" class="answer accepted-answer">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-56230-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/56230/up/" rel="nofollow"> </a>
<div id="post-56230-score" class="post-score"
    title="current number of votes">
    2
</div>
<a id="post-56230-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/56230/down/" rel="nofollow"> </a>

                                        


    
      <a class="accept-answer on"
        title="yobob has selected this answer as the correct answer"
        href="/accept_answer/56230/" rel="nofollow">
      </a>
    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>For SSL/TLS decryption, a client and server side must be known identified since both sides contribute to the session secret via the nonces in their Hello messages (Client Random and Server Random). This client/server is determined automatically when using UDP/TCP, but for other protocols you (as the parent layer) must provide this information.</p>
<p>On the USB level, data packets go from the host to the device (for an OUT endpoint) or from the device to the host (for an IN endpoint). These endpoint numbers are not necessarily the same and in that case Wireshark sees two separate conversations:</p>
<pre><code>2.1.5 &lt;-&gt; host
2.1.4 &lt;-&gt; host
</code></pre>
<p>Thus the SSL dissector is unable to understand that these two data streams are paired. According to the <a href="https://www.wireshark.org/docs/wsdg_html_chunked/lua_module_Pinfo.html#lua_class_Pinfo">WSLUA</a> documentation, fields like <code>pinfo.src</code> and <code>pinfo.dst</code> are actually writable, so you could put your fake "source" and "destination" addresses inside.</p>
<p>Note that these properties form a "conversation" (see <code>find_or_create_conversation</code> in <code>epan/conversation.c</code>):</p>
<ul>
<li><code>pinfo.src</code> / <code>pinfo.dst</code></li>
<li><code>pinfo.port_type</code> (<code>PT_USB</code> (12) in the case of USB)</li>
<li><code>pinfo.src_port</code> / <code>pinfo.dst_port</code></li>
</ul>
<p>To ensure that the old, USB-specific conversations are not accidentally matched, chose source/destination addresses that are definitely different or pick any other port type.</p>
<p>The SSL dissector currently does not check the port type, so if you for example have HTTP, you could set a conversation like this (swap roles accordingly):</p>
<ul>
<li><code>pinfo.src</code>: CLIENT</li>
<li><code>pinfo.dst</code>: SERVER</li>
<li><code>pinfo.port_type</code>: <code>PT_TCP</code> (numeric value is 2, could probably pick any other value)</li>
<li><code>pinfo.src_port</code>: 0 (choice does not matter)</li>
<li><code>pinfo.dst_port</code>: 443</li>
</ul>
<p>(If you pick <code>port_type</code> 0, be sure to use Wireshark 2.2.1 which <a href="https://code.wireshark.org/review/gitweb?p=wireshark.git;a=commit;h=aeaf42724def75fdf5d591d27c4ab6ca2f64d342">fixed</a> an issue that resulted in misdetection of the client/server side.)</p>
<p>If this still does not give the expected result, enable the SSL debug log. For example, if the log shows two different "ssl_session" pointer addresses, then you know that the conversation is messed up.</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/56230/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>07 Oct '16, 15:57</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/285b1f0f4caadc088a38c40aea22feba?s=32&amp;d=identicon&amp;r=g" alt="Lekensteyn's gravatar image" />
    <p><a href="/users/5644/lekensteyn">Lekensteyn</a><br/>
    <span class="score" title="2213 reputation points"><span class="">2.2k</span></span><span title="3 badges"><span class="badge1">&#9679;</span><span class="badgecount">3</span></span><span title="7 badges"><span class="silver">&#9679;</span><span class="badgecount">7</span></span><span title="24 badges"><span class="bronze">&#9679;</span><span class="badgecount">24</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Lekensteyn has 32 accepted answers">30&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/56230/">
                edited
                <strong>08 Oct '16, 08:21</strong>
            </a>
        </p>
        
    </div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-56230">
    
        <a name="56305"></a>
        <div class="comment" id="comment-56305">
            <div id="post-56305-score" class="comment-score"></div>
            <div class="comment-text"><p>Thank you for your comment.</p>

<p>As you told, I should have set pinfo.src_port and pinfo.dst_port to decrypt packets.
I could get decrypted packets after that.</p>

<p>thank you again, Lekensteyn</p></div>
            <div class="comment-info" id="comment-56305-info">
                
                
                
                

                

                <span class="comment-age">(11 Oct '16, 21:55)</span>
                <a class="comment-user userinfo" href="/users/25620/yobob">yobob</a>
                
            </div>
        </div>
    
        <a name="56426"></a>
        <div class="comment" id="comment-56426">
            <div id="post-56426-score" class="comment-score"></div>
            <div class="comment-text"><p><a href="/users/25620/yobob">@yobob</a> If your question is answered, consider pressing accepting this answer by pressing the tick on the left. Thanks!</p></div>
            <div class="comment-info" id="comment-56426-info">
                
                
                
                

                

                <span class="comment-age">(16 Oct '16, 13:33)</span>
                <a class="comment-user userinfo" href="/users/5644/lekensteyn">Lekensteyn</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-56230" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-56230-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/56115/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='qhxLi1o0lRkUAj2RMbn9B5b7dzjeLV8K' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/56115/how-can-i-decrypt-ssl-session-with-lua-dissector?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/dissector/"
            class="tag-link-dissector"
            title="see questions tagged'dissector'using tags"
            rel="tag">dissector</a> <span class="tag-number">&#215;637</span><br/>
        
        <a href="/tags/lua/"
            class="tag-link-lua"
            title="see questions tagged'lua'using tags"
            rel="tag">lua</a> <span class="tag-number">&#215;431</span><br/>
        
        <a href="/tags/ssl/"
            class="tag-link-ssl"
            title="see questions tagged'ssl'using tags"
            rel="tag">ssl</a> <span class="tag-number">&#215;319</span><br/>
        
        <a href="/tags/ssl_decrypt/"
            class="tag-link-ssl_decrypt"
            title="see questions tagged'ssl_decrypt'using tags"
            rel="tag">ssl_decrypt</a> <span class="tag-number">&#215;56</span><br/>
        
        <a href="/tags/sub-dissector/"
            class="tag-link-sub-dissector"
            title="see questions tagged'sub-dissector'using tags"
            rel="tag">sub-dissector</a> <span class="tag-number">&#215;20</span><br/>
        
    </p>
    <p>
        question asked: <strong title="Oct. 3, 2016, 11:05 p.m.">03 Oct '16, 23:05</strong>
    </p>
    <p> 
     	question was seen: <strong>2,594 times</strong>
    </p>
    <p> 
        last updated: <strong title="Oct. 16, 2016, 1:33 p.m.">16 Oct '16, 13:33</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/38663/rsa-key-association-for-ssl-over-udp">RSA Key association for SSL over UDP</a>
        </p>
        
        <p>
            <a href="/questions/58247/ssl-lua-dissector-how">SSL Lua dissector - how?</a>
        </p>
        
        <p>
            <a href="/questions/29825/bad-argument-1-to-get_index-index-out-of-range-in-wireshark-lua-dissector">bad argument #1 to &#39;get_index&#39; (index out of range) in Wireshark Lua dissector</a>
        </p>
        
        <p>
            <a href="/questions/50212/ssl-dissector-not-displaying-client-hello">SSL Dissector not displaying &quot;Client Hello&quot;</a>
        </p>
        
        <p>
            <a href="/questions/57906/radius-eap-message-decoding">radius eap message decoding</a>
        </p>
        
        <p>
            <a href="/questions/61629/decrypt-ssl-traffic-from-android-device-emulator">Decrypt SSL traffic from Android Device (Emulator)</a>
        </p>
        
        <p>
            <a href="/questions/570/crashing-issue-when-running-lua-dissector-after-upgrading-from-wireshark-100">Crashing issue when running Lua dissector after upgrading from wireshark 1.0.0</a>
        </p>
        
        <p>
            <a href="/questions/3398/input-for-a-dissector">Input for a dissector</a>
        </p>
        
        <p>
            <a href="/questions/21389/how-to-calculate-the-difference-between-two-nstime-values-in-lua">How to calculate the difference between two NSTime values in LUA</a>
        </p>
        
        <p>
            <a href="/questions/30529/does-reassembly-address-multiple-pdus-in-a-single-tcp-segment">Does reassembly address multiple PDUs in a single TCP segment?</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
