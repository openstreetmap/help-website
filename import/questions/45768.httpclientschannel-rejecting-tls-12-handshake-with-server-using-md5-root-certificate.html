<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>[closed] HttpClient/Schannel rejecting TLS 1.2 handshake with server using MD5 root certificate - Wireshark Q&amp;A</title>
        <meta name="description" content="We enabled SchUseStrongCrypto in the registry on a Windows Server 2008 R2 server. After the change, we noted that HTTP requests to another, third-party server made using .NET HttpClient no longer worked. The registry change altered the protocol used from TLS 1.0 to TLS 1.2. Schannel logged the follo..." />
        <meta name="keywords" content="schannel,ssl,.net,windows2008,md5" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/45768/httpclientschannel-rejecting-tls-12-handshake-with-server-using-md5-root-certificate" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/45768/httpclientschannel-rejecting-tls-12-handshake-with-server-using-md5-root-certificate?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='X3F8sxxGptAlS7m1YaScEiUYjF4smB9i' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/45768/httpclientschannel-rejecting-tls-12-handshake-with-server-using-md5-root-certificate">[closed] HttpClient/Schannel rejecting TLS 1.2 handshake with server using MD5 root certificate</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-45768-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/45768/up/" rel="nofollow"> </a>
<div id="post-45768-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-45768-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/45768/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/45768/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>We <a href="http://stackoverflow.com/a/28502562/1062614">enabled SchUseStrongCrypto</a> in the registry on a Windows Server 2008 R2 server. After the change, we noted that HTTP requests to another, third-party server made using .NET HttpClient no longer worked. The registry change altered the protocol used from TLS 1.0 to TLS 1.2. Schannel logged the following error to the system event log: "The following fatal alert was generated: 40. The internal error state is 252."</p>
<p>Some research with Wireshark revealed a situation very similar to the one outlined in <a href="http://blogs.msdn.com/b/friis/archive/2012/08/29/tls-1-2-handshake-failure.aspx">this blog post</a>: our server was sending a TCP RST after receiving the remote server certificate, presumably because the root certificate sent by the remote server uses MD5 as its hash algorithm and no signature algorithms using MD5 were listed in our ClientHello. By <a href="https://technet.microsoft.com/en-us/library/Dn786418.aspx#BKMK_SchannelTR_TLS12">disabling TLS 1.2</a> in the registry (the <a href="https://tools.ietf.org/html/rfc5246#section-7.4.1.4.1">signature_algorithms extension</a> is specific to TLS 1.2), we were able to force the connection to be made over TLS 1.1 and eveything worked happily.</p>
<p>However, there are several aspects of the situation I don't understand. When running the same application on a Windows Server 2016 Technical Preview 2 server with SchUseStrongCrypto also enabled, the connection was made using TLS 1.2 just fine, despite the same signature algorithms being sent in the ClientHello, albeit in a different order. Both servers have .NET 4.6 installed and the application targets 4.6.</p>
<p>Why did the connection work on one server and not the other, despite both saying they wouldn't accept MD5 certs? Additionally, Wireshark revealed that on the 2008 R2 server Internet Explorer 11 (which is not governed by the .NET SchUseStrongCrypto flag but which uses Schannel) is also failing to make the initial TLS 1.2 connection, but rather than sending a RST it sends a FIN and then tries and successfully makes a TLS 1.0 connection (on the 2016 server IE11 uses TLS 1.2 successfully)--what governs whether/how HttpClient performs the same fallback? Finally, how are signature algorithms specified and ordered (i.e. like you can select and order cipher suites in gpedit.msc), and what should the client's behavior be when it receives a certificate that doesn't match any of the signature algorithms it said it was willing to use?</p>
<p>An SSL Labs report on the remote server revealed that everything except IE 6 (as expected) successfully negotiated with it, with Windows 8.1+ and OS X platforms using TLS 1.2. Another thing I noticed from the report is that the remote server's certificate chain actually includes two self-signed certs, the more proximal of which uses SHA1 rather than MD5, so there are two "paths". The first path is reported as "trusted" because the first self-signed cert is "in trust store"; the second is "not trusted" because the problematic MD5 cert, which is the ultimate root of the chain, is "not in trust store". This implies to me that other HTTP clients, like the browsers that SSL Labs tests, use the first path and ignore the MD5 cert.</p>
<p>Ultimately, this seems to be due to some fundamental difference between the two versions of Windows (maybe in Schannel), but is that difference documented or configurable anywhere?</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/schannel/" class="post-tag tag-link-schannel"
                                        title="see questions tagged 'schannel'" rel="tag">schannel</a>
                                
                                    <a href="/tags/ssl/" class="post-tag tag-link-ssl"
                                        title="see questions tagged 'ssl'" rel="tag">ssl</a>
                                
                                    <a href="/tags/.net/" class="post-tag tag-link-.net"
                                        title="see questions tagged '.net'" rel="tag">.net</a>
                                
                                    <a href="/tags/windows2008/" class="post-tag tag-link-windows2008"
                                        title="see questions tagged 'windows2008'" rel="tag">windows2008</a>
                                
                                    <a href="/tags/md5/" class="post-tag tag-link-md5"
                                        title="see questions tagged 'md5'" rel="tag">md5</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>10 Sep '15, 13:22</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/f42d1416ea421ade94ed7ef2a23e9a09?s=32&amp;d=identicon&amp;r=g" alt="ejohnson's gravatar image" />
    <p><a href="/users/19550/ejohnson">ejohnson</a><br/>
    <span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">&#9679;</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">&#9679;</span><span class="badgecount">2</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="ejohnson has no accepted answers">0&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/45768/">
                closed
                <strong>11 Sep '15, 02:42</strong>
            </a>
        </p>
        
            <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" alt="grahamb's gravatar image" />
            <p><a href="/users/1225/grahamb">grahamb ♦</a><br/>
            <span class="score" title="19834 reputation points"><span class="">19.8k</span></span><span title="3 badges"><span class="badge1">&#9679;</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">&#9679;</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">&#9679;</span><span class="badgecount">206</span></span></p>
        
    </div>


                            </div>
                            




<div class="comments-container" id="comments-container-45768">
    
        <a name="45783"></a>
        <div class="comment" id="comment-45783">
            <div id="post-45783-score" class="comment-score"></div>
            <div class="comment-text"><p>Wouldn't this question be better handled on a windows forum?</p></div>
            <div class="comment-info" id="comment-45783-info">
                
                
                
                

                

                <span class="comment-age">(11 Sep '15, 02:42)</span>
                <a class="comment-user userinfo" href="/users/1225/grahamb">grahamb ♦</a>
                
            </div>
        </div>
    
        <a name="45789"></a>
        <div class="comment" id="comment-45789">
            <div id="post-45789-score" class="comment-score"></div>
            <div class="comment-text"><p>Okay. Just looking for help from knowledgeable people.</p></div>
            <div class="comment-info" id="comment-45789-info">
                
                
                
                

                

                <span class="comment-age">(11 Sep '15, 07:42)</span>
                <a class="comment-user userinfo" href="/users/19550/ejohnson">ejohnson</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-45768" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-45768-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            <div class="question-status" style="margin-bottom:15px">
            <h3>
                The question has been closed for the following reason "Question is off-topic or not relevant" by
                <a href="/users/1225/grahamb">grahamb</a>
                 11 Sep '15, 02:42
            </h3>
            </div>
            
            
        <form id="fmanswer" action="/questions/45768/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='X3F8sxxGptAlS7m1YaScEiUYjF4smB9i' />
            <div style="clear:both">
            </div>

            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/45768/httpclientschannel-rejecting-tls-12-handshake-with-server-using-md5-root-certificate?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/45768/httpclientschannel-rejecting-tls-12-handshake-with-server-using-md5-root-certificate?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/ssl/"
            class="tag-link-ssl"
            title="see questions tagged'ssl'using tags"
            rel="tag">ssl</a> <span class="tag-number">&#215;319</span><br/>
        
        <a href="/tags/windows2008/"
            class="tag-link-windows2008"
            title="see questions tagged'windows2008'using tags"
            rel="tag">windows2008</a> <span class="tag-number">&#215;7</span><br/>
        
        <a href="/tags/.net/"
            class="tag-link-.net"
            title="see questions tagged'.net'using tags"
            rel="tag">.net</a> <span class="tag-number">&#215;6</span><br/>
        
        <a href="/tags/md5/"
            class="tag-link-md5"
            title="see questions tagged'md5'using tags"
            rel="tag">md5</a> <span class="tag-number">&#215;3</span><br/>
        
        <a href="/tags/schannel/"
            class="tag-link-schannel"
            title="see questions tagged'schannel'using tags"
            rel="tag">schannel</a> <span class="tag-number">&#215;3</span><br/>
        
    </p>
    <p>
        question asked: <strong title="Sept. 10, 2015, 1:22 p.m.">10 Sep '15, 13:22</strong>
    </p>
    <p> 
     	question was seen: <strong>2,303 times</strong>
    </p>
    <p> 
        last updated: <strong title="Sept. 11, 2015, 7:42 a.m.">11 Sep '15, 07:42</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/32327/schannel-errors">schannel errors</a>
        </p>
        
        <p>
            <a href="/questions/337/where-did-the-google-ssl-video-go">Where did the Google SSL video go?</a>
        </p>
        
        <p>
            <a href="/questions/4303/decrypt-ssl-traffic-destined-for-squid-proxy-server">Decrypt SSL Traffic destined for Squid Proxy Server</a>
        </p>
        
        <p>
            <a href="/questions/6368/ssl-capture">SSL capture</a>
        </p>
        
        <p>
            <a href="/questions/8004/ssl-decryption-only-works-in-promiscuous-mode">SSL decryption only works in promiscuous mode?</a>
        </p>
        
        <p>
            <a href="/questions/10184/ssl-descrypt-_without_-specifying-a-protocol">SSL Descrypt _without_ specifying a protocol?</a>
        </p>
        
        <p>
            <a href="/questions/13090/how-do-you-decrypt-the-encrypted-handshakes-and-application-data">How do you decrypt The Encrypted Handshakes and Application Data.</a>
        </p>
        
        <p>
            <a href="/questions/15995/ssl-dissector-tlsv1-versus-ssl">SSL Dissector - TLSv1 versus SSL</a>
        </p>
        
        <p>
            <a href="/questions/20667/ssl-key-exchange-0-different-from-kex_rsa-but-using-rsa">SSL &quot;key exchange 0 different from KEX_RSA&quot; but using RSA</a>
        </p>
        
        <p>
            <a href="/questions/23449/wireshark-ssl-and-tlsv1-protocol">Wireshark SSL and TLSv1 protocol</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
