<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>A Question regarding weird Duplicate ICMP response - Wireshark Q&amp;A</title>
        <meta name="description" content="Hi Guys, I tried to use winpcap to write a software running on PC (with 2 ethernet cards) to emulate a NAT. In that way, I could use a pesudo external IP address to access an internal IP. The architecture is as attached graph. However when I tried to ping the pesudo external IP address, I always get..." />
        <meta name="keywords" content="redirect,icmp" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/27647/a-question-regarding-weird-duplicate-icmp-response" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='sUjjWcULQEHQFoTkKhP8kxIqOAOlSkd9' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response">A Question regarding weird Duplicate ICMP response</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-27647-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/27647/up/" rel="nofollow"> </a>
<div id="post-27647-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-27647-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/27647/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/27647/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>Hi Guys,</p>
<p>I tried to use winpcap to write a software running on PC (with 2 ethernet cards) to emulate a NAT. In that way, I could use a pesudo external IP address to access an internal IP. The architecture is as attached graph. However when I tried to ping the pesudo external IP address, I always get a lot of DUPLICATE ICMP response, does anyone knows why is that?</p>
<p>I do a ping from 146.208.243.51 -&gt; 146.208.233.8, on the NAT server, the IP address and MAC address is converted to internal LAN's IP address/MAC address; and when the PC2 reply the ping, the NAT server will convert those IP/MAC address back to external IP/MAC address. However, when the ping response packet send back to the external network, I got following output. I've also tried if the PC3 stay in the same subnet as the NAT server, it seems everything work ok. But if the IP packet goes to Router/Gateway, this strange behavior is observed.<img alt="alt text" src="https://osqa-ask.wireshark.org/upfiles/1_1.JPG"></p>
<pre>64 bytes from 146.208.233.8: icmp_seq=1 ttl=62 time=4.09 ms
64 bytes from 146.208.233.8: icmp_seq=1 ttl=61 time=4.39 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=60 time=4.60 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=59 time=4.69 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=58 time=4.73 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=57 time=4.82 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=56 time=4.85 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=55 time=4.94 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=54 time=5.08 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=53 time=5.27 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=52 time=5.45 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=51 time=5.65 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=50 time=5.82 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=49 time=5.95 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=48 time=6.03 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=47 time=6.12 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=46 time=6.20 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=45 time=6.28 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=44 time=6.38 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=43 time=6.45 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=42 time=6.52 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=41 time=6.56 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=40 time=6.65 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=39 time=6.69 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=38 time=6.78 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=37 time=6.81 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=36 time=6.90 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=35 time=6.94 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=34 time=7.02 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=33 time=7.06 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=32 time=7.15 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=31 time=7.19 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=30 time=7.27 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=29 time=7.31 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=28 time=7.40 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=27 time=7.44 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=26 time=7.52 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=25 time=7.56 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=24 time=7.65 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=23 time=7.68 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=22 time=7.77 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=21 time=7.80 ms (DUP!)
64 bytes from 146.208.233.8: icmp_seq=1 ttl=20 time=7.89 ms (DUP!)
</pre>

<p>Does anybody knows why?</p>
<p>Thanks in advance</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/redirect/" class="post-tag tag-link-redirect"
                                        title="see questions tagged 'redirect'" rel="tag">redirect</a>
                                
                                    <a href="/tags/icmp/" class="post-tag tag-link-icmp"
                                        title="see questions tagged 'icmp'" rel="tag">icmp</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>02 Dec '13, 00:53</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/bbf88acd96e1a1f909172c86bd1cce6c?s=32&amp;d=identicon&amp;r=g" alt="Jianhui's gravatar image" />
    <p><a href="/users/6203/jianhui">Jianhui</a><br/>
    <span class="score" title="6 reputation points">6</span><span title="2 badges"><span class="badge1">&#9679;</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">&#9679;</span><span class="badgecount">2</span></span><span title="4 badges"><span class="bronze">&#9679;</span><span class="badgecount">4</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Jianhui has no accepted answers">0&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/27647/">
                edited
                <strong>02 Dec '13, 01:28</strong>
            </a>
        </p>
        
            <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" alt="Kurt%20Knochner's gravatar image" />
            <p><a href="/users/2593/kurt-knochner">Kurt Knochner ♦</a><br/>
            <span class="score" title="24767 reputation points"><span class="">24.8k</span></span><span title="10 badges"><span class="badge1">&#9679;</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">&#9679;</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">&#9679;</span><span class="badgecount">237</span></span></p>
        
    </div>


                            </div>
                            




<div class="comments-container" id="comments-container-27647">
    
</div>
<div id="comment-tools-27647" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-27647-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    One Answer:
                    </div>
                    
<div class="tabsA"><a href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="27651"></a>
                    <div id="answer-container-27651" class="answer accepted-answer">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-27651-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/27651/up/" rel="nofollow"> </a>
<div id="post-27651-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-27651-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/27651/down/" rel="nofollow"> </a>

                                        


    
      <a class="accept-answer on"
        title="Jianhui has selected this answer as the correct answer"
        href="/accept_answer/27651/" rel="nofollow">
      </a>
    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>as you can see, the TTL is 'counting' down. That's usually a sign for a routing loop. However, as you wrote the NAT code yourself, it could also be a bug in your code.</p>
<p>It's hard to diagnose without a capture file, taken at the right place(s). Can you post one at Google drive, dropbox, cloudshark.org, or mega.co.nz? </p>
<p>You should take a capture between PC2 -&gt; PC(NAT) and between PC(NAT) -&gt; GW1 at the same time. </p>
<p>Regards<br>
Kurt</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/27651/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>02 Dec '13, 01:39</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" alt="Kurt%20Knochner's gravatar image" />
    <p><a href="/users/2593/kurt-knochner">Kurt Knochner ♦</a><br/>
    <span class="score" title="24767 reputation points"><span class="">24.8k</span></span><span title="10 badges"><span class="badge1">&#9679;</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">&#9679;</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">&#9679;</span><span class="badgecount">237</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Kurt Knochner has 344 accepted answers">15&#37;</span>
    </p>
</div>

    <div class='post-update-info post-update-info-edited'>
        <p style="line-height:12px;">
            <a href="/revisions/27651/">
                edited
                <strong>02 Dec '13, 03:30</strong>
            </a>
        </p>
        
    </div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-27651">
    
        <a name="27684"></a>
        <div class="comment" id="comment-27684">
            <div id="post-27684-score" class="comment-score"></div>
            <div class="comment-text"><p>Hi Kurt,</p>

<p>Thanks for your quick response. I capture a log from the NAT server to capture wireshark log on both ethernet interface.The log is put on <a href="https://dl.dropboxusercontent.com/u/80123665/icmp.pcapng">https://dl.dropboxusercontent.com/u/80123665/icmp.pcapng</a> . You could use icmp filter to see ping request/response.</p>

<p>For example, You could see:</p>

<p>msg No. 257, ping request sent from 146.208.243.51 -&gt; 146.208.233.8</p>

<p>msg No. 299, the ping request has been converted into internal LAN, IP/MAC address has been converted to 10.168.0.100 -&gt; 10.168.0.2</p>

<p>msg No. 302, the ping response sent back from 10.168.0.2 -&gt; 10.168.0.100</p>

<p>msg No. 262, the ping response has been converted back into external LAN, IP/MAC address has been converted to 146.208.233.8 -&gt; 146.208.243.51</p>

<p>After that, I got 2 redirect message (msg 275,277) from 146.208.234.171 and 146.208.235.84, does that mean the router are suggesting other gateway? And I got a ICMP time-tolive exceeded packet in message No.313.</p>

<p>In this case, for internal LAN, I use the internal ethernet LAN MAC ID for both 10.168.0.1 and 10.168.0.100; for external LAN, I use the external LAN MAC ID for both 146.208.235.150 and 146.208.233.8 IP address. Is this an issue for the router?</p>

<p>Thanks a lot,
Jianhui</p></div>
            <div class="comment-info" id="comment-27684-info">
                
                
                
                

                

                <span class="comment-age">(02 Dec '13, 20:15)</span>
                <a class="comment-user userinfo" href="/users/6203/jianhui">Jianhui</a>
                
            </div>
        </div>
    
        <a name="27685"></a>
        <div class="comment" id="comment-27685">
            <div id="post-27685-score" class="comment-score"></div>
            <div class="comment-text"><p>A clarification of the system diagram is the PC3 is actually a Linux server instead of a PC running Microsoft Windows 7.</p></div>
            <div class="comment-info" id="comment-27685-info">
                
                
                
                

                

                <span class="comment-age">(02 Dec '13, 20:22)</span>
                <a class="comment-user userinfo" href="/users/6203/jianhui">Jianhui</a>
                
            </div>
        </div>
    
        <a name="27692"></a>
        <div class="comment" id="comment-27692">
            <div id="post-27692-score" class="comment-score">1</div>
            <div class="comment-text"><p>In Frame #257 the ICMP request is coming from a Cisco MAC address (I guess GW1). Then in Frame #262, the ICMP response is going to the MAC of a Dell system (Dell_d9:a5:d0 (00:1c:23:d9:a5:d0)). Then you get two ICMP redirects (Frame #275,277) from systems that are not included in your picture (IP: 146.208.234.171 and 146.208.235.84) and both have a <strong>different MAC</strong> address than the Dell address !??!</p>

<p><strong>Spoiler</strong>: I guess, there is something terribly wrong with your network setup and most certainly there is a routing problem, as I suspect a routing loop somewhere ;-)</p>

<p>Please post the output of the following commands on <strong>both</strong> systems: PC(NAT) and GW1</p>

<blockquote>
<p>netstat -nr <br>
ipconfig -a <br>
tracert -d 146.208.243.51<br>
</p>
</blockquote>

<p>and the equivalent output on your Cisco device (GW1?).</p>

<p>Please identify the systems that sent the ICMP redirects ( 146.208.234.171 and 146.208.235.84) and check how they are involved.</p>

<p>Next thing: The ICMP request/reply is first shown completely on the external side of PC(NAT): Frames: #257,#262 and <strong>only after that</strong> on the internal side: #299,#302. That's not how NAT works.</p>

<p>On a a NAT device, I would have expected the following packet sequence:</p>

<ul>
<li>External: ICMP request</li>
<li>Internal: ICMP request (address translated to internal)</li>
<li>Internal: ICMP reply</li>
<li>External: ICMP reply   (address translated to external)</li>
</ul>

<p>Did you configure the NAT IP address (146.208.233.8) on PC(NAT) as a secondary address? </p>

<p>To me it looks like you did that and the IP stack of the 'NAT' system answers the external ICMP requests (see ICMP packet sequence in the capture file). Then your WinPcap 'NAT code' takes the request and sends it to the internal side, which is then answered by the internal PC.</p>

<p>If that is true: That's not a good idea.</p>

<p>My suggestion:</p>

<ol>
<li>Fix your network setup: Check routing, etc. </li>
<li>Think about how NAT should work</li>
<li>Fix your IP configuration on PC(NAT)</li>
<li>Maybe also required: Fix your WinPcap NAT code</li>
<li>Repeat tests</li>
</ol></div>
            <div class="comment-info" id="comment-27692-info">
                
                
                
                

                

                <span class="comment-age">(03 Dec '13, 02:42)</span>
                <a class="comment-user userinfo" href="/users/2593/kurt-knochner">Kurt Knochner ♦</a>
                
            </div>
        </div>
    
        <a name="27738"></a>
        <div class="comment" id="comment-27738">
            <div id="post-27738-score" class="comment-score"></div>
            <div class="comment-text"><p>Hi Kurt,</p>

<p>Thanks for your detailed response. I think I understand the issue right now.</p>

<p>I overlook the MAC address of the incoming ping request from external LAN, that MAC address (GW1's MAC address) is the MAC address that I should used for the ping response. However when I write NAT code, I convert that ping response Packet's Dest MAC address to the final destination's MAC address (PC3's MAC address instead of GW1's MAC address). It means I sent back a packet with a MAC address that cannot reached in the sub-net. That cause problem to the router while result in the Duplicate ping response.(But I'm not sure how the loopback route is created by the router, maybe you could shed some light on that ;-) )</p>

<p>As for the NAT problem you point out, I think that is caused by wireshark' logging algorithm. It puzzled me too when I see the log the first time. Then I found if you reorder the logging packets by time (instead of by sequence number) you would see the expected packet sequence:</p>

<p>External: ICMP request</p>

<p>Internal: ICMP request (address translated to internal)</p>

<p>Internal: ICMP reply</p>

<p>External: ICMP reply (address translated to external)</p>

<p>Thanks again for your great help on this, It is really very helpful!
Jianhui</p></div>
            <div class="comment-info" id="comment-27738-info">
                
                
                
                

                

                <span class="comment-age">(03 Dec '13, 17:47)</span>
                <a class="comment-user userinfo" href="/users/6203/jianhui">Jianhui</a>
                
            </div>
        </div>
    
        <a name="27750"></a>
        <div class="comment" id="comment-27750">
            <div id="post-27750-score" class="comment-score"></div>
            <div class="comment-text"><blockquote>
<p>It means I sent back a packet with a MAC address that cannot reached in the sub-net. </p>
</blockquote>

<p>Yes, and therefore no other system should 'feel' itself responsible for that packet. Why you get the ICMP redirects is unclear to me and I cannot give you any good explanation, as I don't know the rest of your infrastructure. I leave it up to you to figure out what's going on ;-) </p>

<blockquote>
<p>Then I found if you reorder the logging packets by time (instead of by sequence number) you would see the expected packet sequence:</p>
</blockquote>

<p>you are right. I did not check that. That's probably related to the way WinPcap (or dumpcap) buffers frames internally before they get flushed out to a capture file, especially if you capture on two interfaces at the same time</p>

<p><strong>Note to myself:</strong> Don't assume <strong>anything</strong> ;-))</p>

<blockquote>
<p>Thanks again for your great help on this, It is really very helpful! Jianhui</p>
</blockquote>

<p>You're welcome, especially as these kinds of problem are rather interesting to diagnose :-)</p>

<p>Hint: If a supplied answer resolves your question can you please "accept" it by clicking the checkmark icon next to it. This highlights good answers for the benefit of subsequent users with the same or similar questions. For extra points you can up vote the answer (thumb up).</p></div>
            <div class="comment-info" id="comment-27750-info">
                
                
                
                

                

                <span class="comment-age">(04 Dec '13, 02:39)</span>
                <a class="comment-user userinfo" href="/users/2593/kurt-knochner">Kurt Knochner ♦</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-27651" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-27651-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/27647/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='sUjjWcULQEHQFoTkKhP8kxIqOAOlSkd9' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/27647/a-question-regarding-weird-duplicate-icmp-response?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/icmp/"
            class="tag-link-icmp"
            title="see questions tagged'icmp'using tags"
            rel="tag">icmp</a> <span class="tag-number">&#215;74</span><br/>
        
        <a href="/tags/redirect/"
            class="tag-link-redirect"
            title="see questions tagged'redirect'using tags"
            rel="tag">redirect</a> <span class="tag-number">&#215;7</span><br/>
        
    </p>
    <p>
        question asked: <strong title="Dec. 2, 2013, 12:53 a.m.">02 Dec '13, 00:53</strong>
    </p>
    <p> 
     	question was seen: <strong>17,520 times</strong>
    </p>
    <p> 
        last updated: <strong title="Dec. 4, 2013, 2:39 a.m.">04 Dec '13, 02:39</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/3961/weird-icmp-traffic-redirect-for-network">Weird icmp traffic - redirect for network</a>
        </p>
        
        <p>
            <a href="/questions/19629/pc-randomly-responds-to-other-devices-packets-with-an-icmp-redirect">PC randomly responds to other devices packets with an &quot;ICMP redirect&quot;</a>
        </p>
        
        <p>
            <a href="/questions/19988/malformed-packet-for-icmpv6-redirect-message">Malformed Packet for ICMPv6 Redirect Message</a>
        </p>
        
        <p>
            <a href="/questions/35826/what-does-icmp-redirect-redirect-for-host-mean">What does ICMP | Redirect | (redirect for host) mean?</a>
        </p>
        
        <p>
            <a href="/questions/2094/wireshark-does-not-capture-depending-on-mtu-size">Wireshark does not capture depending on MTU size</a>
        </p>
        
        <p>
            <a href="/questions/16496/strange-icmp-packets">Strange ICMP (?) Packets</a>
        </p>
        
        <p>
            <a href="/questions/36767/im-seeing-icmp-traffic-that-i-did-not-commence">I&#39;m seeing ICMP traffic that I did not commence</a>
        </p>
        
        <p>
            <a href="/questions/45882/when-i-do-a-filter-for-my-qos-packets-using-ipdsfielddscp46-i-also-get-dscp-22-packets">When I do a filter for my QoS packets using ip.dsfield.dscp==46 I also get DSCP 22 packets</a>
        </p>
        
        <p>
            <a href="/questions/57550/a-quick-question-about-lack-of-icmp-reply-in-trace">A quick question about lack of ICMP reply in trace</a>
        </p>
        
        <p>
            <a href="/questions/2827/extra-fields-displayed-in-icmp-capture">Extra fields displayed in ICMP capture</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
