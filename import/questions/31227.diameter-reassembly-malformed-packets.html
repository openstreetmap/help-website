<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base_content.html -->

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Diameter reassembly (malformed packets) - Wireshark Q&amp;A</title>
        <meta name="description" content="When having one Diameter message spanned in two different TCP packets (TCP is used as Diameter transport protocol), wireshark sometimes is not able to reassemble properly the Diameter messages. We have seen the following situations: 1) The payload in the TCP message is not starting as a Diamter mess..." />
        <meta name="keywords" content="diameter,malformed,tcp,reassembly" />
        
        <link rel="canonical" href="https://osqa-ask.wireshark.org/questions/31227/diameter-reassembly-malformed-packets" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/questions/31227/diameter-reassembly-malformed-packets?type=rss">


        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <meta name="google-site-verification" content="dqzpAlfsUDYClyC-7mNVrF11yfwuCZ0-uF7C4HApzkU" />
        
        <link rel="shortcut icon" href="/upfiles/favicon-ask_1.ico" />
        <link href="/m/default/media/style/style.css" rel="stylesheet" type="text/css" />
        
        <link href="/cstyle.css" rel="stylesheet" type="text/css" />
        
        <link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" />
        <!--[if IE 6]>
        <style type="text/css">
        img, div, a { behavior: url(/m/default/media/iepngfix/iepngfix.htc) }
        </style>
        <![endif]-->
        

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        /*<![CDATA[*/
            
            

            var i18nLang = 'en';
            var appUrl = 'https://osqa-ask.wireshark.org'
            var scriptUrl = '/'
            var osqaSkin = 'default';

            var messages = {
                username: '',
                confirm: "Are you sure?",
                yes: "Yes",
                no: "No",
                message: "Message:",
                cancel: "Cancel",
                close: "Close",
                ok: "Ok",
                matching_tags_url: "/matching_tags/",
                word: "word",
                words: "words",
                character: "character",
                characters: "characters"
            }
        /*]]>*/
        </script>
        <script type="text/javascript" src="/m/default/media/js/osqa.main.js"></script>
        
        <style type="text/css">
            body { margin-top:2.4em; }
        </style>
        <script type="text/javascript">
            $(document).ready(function() {
                var element = $('#validate_email_alert');
                element.click(function(){notify.close(true);})
                notify.show();
            });
        </script>
        
        
            <META name="y_key" content="af3ab95b28a8b14e">
<meta name="msvalidate.01" content="9EAF899765C0DD43A19EEF6EAFFA6A77" />
        
        
        
        <script type='text/javascript' src='/m/default/media/js/osqa.question.js'></script>
        <script type='text/javascript' src='/m/default/media/js/jquery.caret.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/showdown.js'></script>
        <script type='text/javascript' src='/m/default/media/js/wmd/wmd.js'></script>
        <script type='text/javascript' src='/m/default/media/js/html_sanitizer.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/wmd/wmd.css" />

        
        <script type='text/javascript' src='/m/default/media/js/viewbox_min.js'></script>
        <script type='text/javascript' src='/m/default/media/js/youtube.js'></script>
        <link rel="stylesheet" type="text/css" href="/m/default/media/js/viewbox.css" />
        
        

        <script type="text/javascript">
        $().ready(function(){
            $("#nav_questions").attr('className',"on");
            var answer_sort_tab = "";

            if (answer_sort_tab) {
                $("#" + answer_sort_tab).attr('className',"on");
            }

            $('#editor').TextAreaResizer();

            //toggle preview of editor
            var display = true;
            var txt = "[hide preview]";
            $('#pre-collapse').text(txt);
            $('#pre-collapse').bind('click', function(){
                txt = display ? "[show preview]" : "[hide preview]";
                display = !display;
                $('#previewer').toggle();
                $('#pre-collapse').text(txt);
            });
        });

        function submitClicked(e, f) {
            if(!(browserTester('chrome') || browserTester('safari'))) {
                $("input.submit")[0].disabled=true;
            }
            window.removeEventListener('beforeunload', beforeUnload, true);
            if (f) {
                f.submit();
            }
        }

        function beforeUnload(e) {

            if($("textarea#editor")[0].value != "") {
                return yourWorkWillBeLost(e);
            }

            var commentBoxes = $("textarea.commentBox");
            for(var index = 0; index < commentBoxes.length; index++) {
                if(commentBoxes[index].value != "") {
                    return yourWorkWillBeLost(e);
                }
            }
        }
        window.addEventListener('beforeunload', beforeUnload, true);
        </script>
        <noscript>
            <style>
                .comment.not_top_scorer {
                    display: block;
                }
                .comment-form-container {
                    display: block;
                }
                .div.comment-tools {
                    display: none;
                }
            </style>
        </noscript>

        <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Wireshark Q&amp;A Search" />
        
    </head>
    <body>
        <div class="wrapper">
        
        <!-- template header.html -->


	<div id="roof">
	  
		<div id="logo">
			<a href="/">
				<img src="/upfiles/wsbadge@186x57.png" title="back to home page" alt="Wireshark Q&amp;A logo"/>
			</a>
		</div>
	  
		<div id="top">
		     <a href="/account/signin/" >login</a>  <a href="/about/" >about</a>  <a href="/faq/" >faq</a> 
		</div>

    <div id="nav">
        <a id="nav_questions" class="on" href="/questions/" >questions</a><a id="nav_tags" href="/tags/" >tags</a><a id="nav_users" href="/users/" >users</a><a id="nav_badges" href="/badges/" >badges</a><a id="nav_unanswered" href="/questions/unanswered/" >unanswered</a>
        
    </div>
  </div>

  <div class="clear"></div>
  
	<div id="searchBar">
    <form action="/search/" method="get">
        <input type='hidden' name='csrfmiddlewaretoken' value='P7VznECzmHBkWktjMBTyJWFM8MzGxJR3' />
        <div>
            <input type="text" class="searchInput" value="" name="q" id="keywords" />
            <input type="submit" name="Submit" value="search" class="searchBtn" />
        </div>
        <div class="options">
            <input id="type-question" type="radio" value="question" name="t" 
                checked="checked" /><label for="type-question">questions</label>
            <input id="type-tag" type="radio" value="tag" name="t" /><label for="type-tag">tags</label>
            <input id="type-user" type="radio" value="user" name="t" /><label for="type-user">users</label>
        </div>
    </form>	
	</div>

	
  <div id="announcement">
      <div style="padding: 1em; margin-top: 5px; border-radius: 5px; border: 1px solid rgb(107, 43, 40); background: rgb(243, 227, 225);">
This is our old Q&amp;A Site. Please post any new questions and answers at <a href="https://ask.wireshark.org/">ask.wireshark.org</a>.
</div>
  </div>
  

<!-- end template header.html -->

        



<div id="wrapper">
    
    
    <div id="room">
        <div id="CALeft">
            
<div class="headNormal">
    <h1><a href="/questions/31227/diameter-reassembly-malformed-packets">Diameter reassembly (malformed packets)</a></h1>
</div>
<div id="main-body" class="">
    <div id="askform">
            <table style="width:100%;" id="question-table" >
                <tr>
                    <td style="width:30px;vertical-align:top">
                        <div class="vote-buttons">
                            

<a id="post-31227-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/31227/up/" rel="nofollow"> </a>
<div id="post-31227-score" class="post-score"
    title="current number of votes">
    0
</div>
<a id="post-31227-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/31227/down/" rel="nofollow"> </a>

                            

<a id="favorite-mark" title="mark/unmark this question as favorite (click again to cancel)"
    class="ajax-command favorite-mark "
    href="/mark_favorite/31227/" rel="nofollow"> </a>
<div id="favorite-count" class="favorite-count">
   
</div>

                        </div>
                    </td>
                    <td>
                        <div id="item-right">
                            <div class="question-body">
                                <p>When having one Diameter message spanned in two different TCP packets (TCP is used as Diameter transport protocol), wireshark sometimes is not able to reassemble properly the Diameter messages.</p>
<p>We have seen the following situations:
1) The payload in the TCP message is not starting as a Diamter message (probably wireshark does not understand the Diameter version and the Diameter message length are coming). In this situation, wireshark shows the Diameter message as a CONTINUATION of the previous ones.
2) The payload in the TCP message seems to be starting as a Diameter message (probably wireshark understands a Diameter version and a valid message length is coming), but the truth is it is the continuation of a Diameter message which was sent in the previous TCP packet. In this situation, wireshark shows the Diameter message is containing a unknwon command code containing a malformed Diameter message.</p>
<p>This is usually seen when a packet is lost or at the beginning of the trace. Once the TCP payload is starting with a valid Diameter message (with its Diameter version, length, and valid command code) wireshark is decoding the messages properly, until a new packet is lost.</p>
<p>In the end, it seems a system is sending invalid Diameter messages when it is not.</p>
<p>Have you already seen this problem? Do you know if that might be related to how wireshark reassembles Diameter messages?</p>
<p>By the way, both TCP (Allow subdisectors to reassemble TCP streams) and Diameter (Reassemble Diameter messages spanning multiple TCP segments) options to reassemble Diameter/TCP messages are set.</p>
                            </div>
                            <div id="question-tags" class="tags-container tags">
                                
                                    <a href="/tags/diameter/" class="post-tag tag-link-diameter"
                                        title="see questions tagged 'diameter'" rel="tag">diameter</a>
                                
                                    <a href="/tags/malformed/" class="post-tag tag-link-malformed"
                                        title="see questions tagged 'malformed'" rel="tag">malformed</a>
                                
                                    <a href="/tags/tcp/" class="post-tag tag-link-tcp"
                                        title="see questions tagged 'tcp'" rel="tag">tcp</a>
                                
                                    <a href="/tags/reassembly/" class="post-tag tag-link-reassembly"
                                        title="see questions tagged 'reassembly'" rel="tag">reassembly</a>
                                
                            </div>
                            <div id="question-controls" class="post-controls">
                                

                                

                            </div>
                            <div class="post-update-info-container">
                                    
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        asked
        <strong>27 Mar '14, 11:29</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/d6196cc7e0715e430d10c758795f7ca3?s=32&amp;d=identicon&amp;r=g" alt="Juan_ma's gravatar image" />
    <p><a href="/users/7008/juan_ma">Juan_ma</a><br/>
    <span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">&#9679;</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">&#9679;</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">&#9679;</span><span class="badgecount">2</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="Juan_ma has no accepted answers">0&#37;</span>
    </p>
</div>


                            </div>
                            




<div class="comments-container" id="comments-container-31227">
    
</div>
<div id="comment-tools-31227" class="comment-tools">
    
    
</div>




<div class="clear"></div>
<div id="comment-31227-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                        </div>

                    </td>
                </tr>
            </table>
            
            
                <hr/>
                <div class="tabBar">
                    <a name="sort-top"></a>
                    <div class="headQuestions">
                    One Answer:
                    </div>
                    
<div class="tabsA"><a href="/questions/31227/diameter-reassembly-malformed-packets?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/31227/diameter-reassembly-malformed-packets?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/31227/diameter-reassembly-malformed-packets?sort=newest" title="newest answers will be shown first">newest answers</a><a href="/questions/31227/diameter-reassembly-malformed-packets?sort=votes" class="on" title="most voted answers will be shown first">popular answers</a></div>

                </div>
                

                
                    <a name="31245"></a>
                    <div id="answer-container-31245" class="answer ">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:30px;vertical-align:top">
                                    <div class="vote-buttons">
                                        

<a id="post-31245-upvote" title="I like this post (click again to cancel)"
    class="ajax-command post-vote up "
     href="/vote/31245/up/" rel="nofollow"> </a>
<div id="post-31245-score" class="post-score"
    title="current number of votes">
    1
</div>
<a id="post-31245-downvote" title="I dont like this post (click again to cancel)"
    class="ajax-command post-vote down"
     href="/vote/31245/down/" rel="nofollow"> </a>

                                        


    



                                    </div>
                                </td>
                                <td>
                                    <div class="item-right">
                                        <div class="answer-body">
                                            <p>From what I understand of your question (hint: a publicly posted capture somewhere helps tremendously) you are expecting the Diameter dissector to be able to correctly reassemble and dissect messages where some fragment of the message is missing?</p>
<p>I'm not at all familiar with Diameter but in general this isn't going to happen for any protocol as each message fragment will contain vital information for the reassembly and if any is missing then reassembly will be at best broken, and at worst the dissector will complain about a malformed (incomplete) message.</p>
<p>This situation will especially apply for protocols running over stream based (i.e. no message boundaries) transport protocols such as tcp as the application protocol doesn't have any idea of what transport fragmentation may be taking place so can't ensure a viable application pdu is in each transport layer fragment.</p>
                                        </div>
                                        <div class="answer-controls post-controls">
                                            
<span class="action-link"><a rel="nofollow" title="answer permanent link" class="ajax-command withprompt  copy" href="/answer_link/31245/">permanent link</a></span>
                                            

                                        </div>
                                        <div class="post-update-info-container">
                                            
<div class='post-update-info post-update-info-user'>
    <p style="line-height:12px;">
        answered
        <strong>28 Mar '14, 03:25</strong>
    </p>
    <img class="gravatar" width="32" height="32" src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" alt="grahamb's gravatar image" />
    <p><a href="/users/1225/grahamb">grahamb ♦</a><br/>
    <span class="score" title="19834 reputation points"><span class="">19.8k</span></span><span title="3 badges"><span class="badge1">&#9679;</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">&#9679;</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">&#9679;</span><span class="badgecount">206</span></span><br />
    
    <span title="Rate of the user's accepted answers" class="accept_rate">accept rate:</span>
    <span title="grahamb has 274 accepted answers">22&#37;</span>
    </p>
</div>


                                        </div>
                                        




<div class="comments-container" id="comments-container-31245">
    
        <a name="31298"></a>
        <div class="comment" id="comment-31298">
            <div id="post-31298-score" class="comment-score">1</div>
            <div class="comment-text"><p>If you have a sample capture showing the 2nd case (Wireshark thinks it's Diameter but it's not really) it's possible someone could improve the Diameter dissector's heuristics to remove these false positives (i.e., make it claim that it's just continuation data).</p></div>
            <div class="comment-info" id="comment-31298-info">
                
                
                
                

                

                <span class="comment-age">(30 Mar '14, 14:48)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31305"></a>
        <div class="comment" id="comment-31305">
            <div id="post-31305-score" class="comment-score">1</div>
            <div class="comment-text"><p>It sounds like Wireshark is reporting this correctly Juan. From it's perspective, at the beginning or end of your  trace  file if only one of the two segments that make up the Diameter message exist in the trace file, it's not going to call it a correctly-formed Diameter message.</p>

<p>Diameter over TCP, so I'm assuming this is a credit control interface? If you <em>can</em> share it you can upload it here and post a link: <a href="https://appliance.cloudshark.org/upload/">https://appliance.cloudshark.org/upload/</a></p></div>
            <div class="comment-info" id="comment-31305-info">
                
                
                
                

                

                <span class="comment-age">(30 Mar '14, 19:24)</span>
                <a class="comment-user userinfo" href="/users/4985/quadratic">Quadratic</a>
                
            </div>
        </div>
    
        <a name="31479"></a>
        <div class="comment not_top_scorer" id="comment-31479">
            <div id="post-31479-score" class="comment-score"></div>
            <div class="comment-text"><p>Finally I managed to get a file without sensitive information. I also manipulated all ip addresses, mac addresses and Diameter addresses, so take into account checksums will not be valid.</p>

<p>Here there is a link to the pcap file:
<a href="https://www.cloudshark.org/captures/6cf577bd1721">https://www.cloudshark.org/captures/6cf577bd1721</a></p>

<p>From frame 1 to 14, packets are decoded as DIAMETER CONTINUATION messages since it is the beginning of the trace and the payload is not beginning with the starting of a Diameter message.</p>

<p>From frame 15 to 683, packets are correctly decoded, main reason is starting of payload in packet 15 coincides with the beginning of a Diameter message. </p>

<p>687 frame was received out of order (684 is really the continuation of 687). At this moment wireshark stops reassembling Diameter messages (don't know if somehow it could realize 684 is the continuation of 687)</p>

<p>From frame 691 to 693, packets are decoded as DIAMETER CONTINUATION messages since the payload is not beginning with the starting of a Diameter message.</p>

<p>Payload in 694 is starting with 01, which is how Diameter messages are starting (Diameter version) and next three bytes are considered the length of the Diameter message, those three bytes are including value 07 40 00 in hex which basically is understood by wireshark as a length of 475136 bytes!!! The truth is payload of frame 694 is the continuation of frame 693, but its starting is similar to a Diameter message (I wonder if Diameter dissector's is just chaecking Diameter version is coming...).</p>

<p>All frames from 694 to 1398 are reassembled as a Diameter message of 475136 bytes, this huge Diameter message is not understood by wireshark and considers it a malformed Diameter message.</p>

<p>Frame 1400 is not starting as a Diameter message (no 01 at the beginning) and hence wireshark considers it a Diameter continuation</p>

<p>However frame 1401 is starting with 01 and the next three bytes read are 2c 01 00, which is understood by Diameter dissector as a Diameter message of 2883840 bytes!!! That would mean messages from 1401 to 5602 are understood as one Diameter message.</p>

<p>Same behaviour is repeated until frame number 11375 where the starting of the TCP payload coincides again with the beginning of a real Diameter message (Diameter version/ Diameter length/Diameter Flags/Diameter Command Code...)</p>

<p>I guess it is a problem on the Diameter dissector's heuristics as Jeff pointed out.</p></div>
            <div class="comment-info" id="comment-31479-info">
                
                
                
                

                

                <span class="comment-age">(03 Apr '14, 05:50)</span>
                <a class="comment-user userinfo" href="/users/7008/juan_ma">Juan_ma</a>
                
            </div>
        </div>
    
        <a name="31497"></a>
        <div class="comment" id="comment-31497">
            <div id="post-31497-score" class="comment-score">1</div>
            <div class="comment-text"><p>You were exactly right that the Diameter dissector was only looking at the version and not the length.  I submitted a <a href="https://code.wireshark.org/review/949">change</a> which strengthens those heuristics so the length is checked (only works for messages under 8192 bytes--if you know messages might be bigger than that in the real world, let me know and I'll increase the number) and that none of the reserved Flags bits are set.</p>

<p>(Really should have moved this over to a bug report but oh well...)</p></div>
            <div class="comment-info" id="comment-31497-info">
                
                
                
                

                

                <span class="comment-age">(03 Apr '14, 11:01)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31504"></a>
        <div class="comment not_top_scorer" id="comment-31504">
            <div id="post-31504-score" class="comment-score"></div>
            <div class="comment-text"><p>Sorry, I'm quite new on this fora and didn't know I could create a bug report. I guess you'll take the point of requesting to solve this issue, right?</p>

<p>In relation to the Diameter message size, I know cases where 64 Kbytes are sent in the real world, and the truth is Diameter RFC is theoretically allowing 16777215 bytes.</p>

<p>I think it would be better to check command flags fields coming after the length (see text copied from RFC 6733):</p>

<p>Command Flags
      The Command Flags field is eight bits.  The following bits are
      assigned:</p>

<pre><code>   0 1 2 3 4 5 6 7
  +-+-+-+-+-+-+-+-+
  |R P E T r r r r|
  +-+-+-+-+-+-+-+-+
</code></pre>

<p>and taking into account "r" bits must be zero</p>

<pre><code>  r(eserved)

     These flag bits are reserved for future use; they MUST be set to zero and ignored by the receiver.
</code></pre></div>
            <div class="comment-info" id="comment-31504-info">
                
                
                
                

                

                <span class="comment-age">(04 Apr '14, 01:01)</span>
                <a class="comment-user userinfo" href="/users/7008/juan_ma">Juan_ma</a>
                
            </div>
        </div>
    
        <a name="31509"></a>
        <div class="comment" id="comment-31509">
            <div id="post-31509-score" class="comment-score">1</div>
            <div class="comment-text"><p>64 kbytes, really?  Wow, I saw someone screaming over 1800 bytes. But that's in the Telco world.  I can push a change to increase the limit to 64kbytes.  I know that <em>theoretically</em> the messages can be up to 2^24-1 bytes, the question is just what will ever actually happen in the real world.</p>

<p>The change I pushed yesterday already checks that the r-bits must be 0.  But that's still a pretty weak heuristic--I think we really need a length check.</p>

<p>Do you think 64kbytes is enough or maybe we need some more room like 80kbytes?</p></div>
            <div class="comment-info" id="comment-31509-info">
                
                
                
                

                

                <span class="comment-age">(04 Apr '14, 07:03)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31540"></a>
        <div class="comment not_top_scorer" id="comment-31540">
            <div id="post-31540-score" class="comment-score"></div>
            <div class="comment-text"><p>In the Telco world some Diameter applications like 3GPP Sh interface can contain XML documents or binary data of whatever size. I think sending more than 80 kbytes would imply a very inefective use of Diameter protocol, but you cannot prevent from that.</p>

<p>I still think it would be good to check command code flags after the length to guarantee it is a valid Diameter message. Byte after length must always contain X0 where X (most significant 4 bits) can take the following hex values: 0, 2, 4, 6, 8, 9, C and D; and least 4 significant bits must always be 0. That is, commmand code flags byte can only contain 00, 20, 40, 60, 80, 90, C0 and D0 values following Diameter RFC, and any other command code flags is invalid.</p></div>
            <div class="comment-info" id="comment-31540-info">
                
                
                
                

                

                <span class="comment-age">(05 Apr '14, 04:11)</span>
                <a class="comment-user userinfo" href="/users/7008/juan_ma">Juan_ma</a>
                
            </div>
        </div>
    
        <a name="31558"></a>
        <div class="comment not_top_scorer" id="comment-31558">
            <div id="post-31558-score" class="comment-score"></div>
            <div class="comment-text"><p>Jeff - Just to give you some insight on what's happening right now in the mobile industry as it relates to this:</p>

<p>The IMS network architecture is the defined method of deploying Voice over LTE (VoLTE), which is something that operators have been delaying for years with workarounds (CSFB, etc., kind of like how ISPs have used NAT workaround for the move to IPv6), but IMS and VoLTE is going to be in full swing this year. Since that architecture calls for all "services" including voice to be served by SIP application servers, where those servers store all provisioning data for all applications on a single database (the HSS or "Home Subscriber Server"), and since the communication between those systems calls for entire XML documents to be passed as content within an AVP in a Diameter message, I think the need to deal with very large individual Diameter messages is likely to increase significantly.</p>

<p>So in short, I would agree with Juan that the need to support possibly very large Diameter message is going to increase as we go. I'd further add that while Diameter is already central to LTE/EPC networks, since VoLTE will see it replace virutally all SS7/Sigtran signaling for applications like gsm_map, inap and camel, Diameter in general is going to become one of the most important protocols for mobile protocol analysis. That and SIP, DNS, GTPv2, and the radio/s1ap pieces.</p></div>
            <div class="comment-info" id="comment-31558-info">
                
                
                
                

                

                <span class="comment-age">(05 Apr '14, 15:41)</span>
                <a class="comment-user userinfo" href="/users/4985/quadratic">Quadratic</a>
                
            </div>
        </div>
    
        <a name="31569"></a>
        <div class="comment" id="comment-31569">
            <div id="post-31569-score" class="comment-score">1</div>
            <div class="comment-text"><p>Trust me--I know.  My employer makes a product which sits in the middle of all this Diameter traffic.</p>

<p>But think about it for a minute: a 64kbyte subscriber profile (let's round it out and say it's a 64kbyte Update Location Answer) means that you'd need a 1 Gbit link (coming out of your HSS all the way to your MME) for every ~2000 ULAs you want to send per second: (1,000,000,000 bits/sec) / (8 bits/byte) / (64,000 bytes/ULA) == 1953.  Sure you can have faster networks and more than 1 HSS but you've also probably got lots of MMEs.  And let's not even start talking about roaming (I pity the roaming hub who connects to a network which dishes out 64kbyte profiles!).</p>

<p>To put some more perspective on that: I've seen traffic forecasts of 0.5 to 1.0 ULR/subscriber/hour.  Taking the lower number (for argument's sake) that works out to needing that 1 Gbit/sec link (doing <em>only</em> ULR/ULA) for every ~14M subscribers.  Taking the higher number means you can only support 7M subscribers.</p>

<p>As I said earlier, I heard screaming (well, more like "great displeasure") from an operator who discovered one of their partners was sending them ~1800 byte ULAs.</p>

<p>So I really have a hard time imagining anyone getting away with 64kbyte subscriber profiles.  I imagine other interfaces will be similar.  But if you guys are really sure, I can always take Michael Mann's suggestion (in the change quoted above) and put in a preference for the max Diameter message size, maybe with a default closer to 64k than the 8k it is now.</p>

<p><a href="/users/7008/juan_ma">@Juan_ma</a>: as mentioned my change already checks for the lower 4 flags bits being 0.  But you do raise a good point that it could also ensure the E &amp; R bits aren't both set.</p></div>
            <div class="comment-info" id="comment-31569-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 11:07)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31570"></a>
        <div class="comment not_top_scorer" id="comment-31570">
            <div id="post-31570-score" class="comment-score">1</div>
            <div class="comment-text"><p>They do scream about DIAMETER message size - but at the same time they want more data pushed over it. :)</p>

<p>For example, some people are asking my employer to stuff entire SIP messages inside DIAMETER, for logging/troubleshooting purposes... yes I know, DIAMETER isn't a good logging transport protocol, but tell that to some folks who see it as the do-everything protocol between the call control systems and the management/back-office systems.</p>

<p>So... since SIP messages sometime grow quite large (for example NOTIFY messages with buddy lists in them), I'd expect DIAMETER to grow quite large too someday.</p></div>
            <div class="comment-info" id="comment-31570-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 11:38)</span>
                <a class="comment-user userinfo" href="/users/4318/hadriel">Hadriel</a>
                
            </div>
        </div>
    
        <a name="31571"></a>
        <div class="comment not_top_scorer" id="comment-31571">
            <div id="post-31571-score" class="comment-score"></div>
            <div class="comment-text"><p>So how large would you consider "large?"</p>

<p>(I'm not saying that my choice of 8kbytes is the right one but I also find it highly unlikely we'll ever see a message of size 2^24-1.)</p></div>
            <div class="comment-info" id="comment-31571-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 12:42)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31576"></a>
        <div class="comment not_top_scorer" id="comment-31576">
            <div id="post-31576-score" class="comment-score">1</div>
            <div class="comment-text"><p>Probably 64KB for the default.</p>

<p>I know that makes the odds of a false-positive higher, but maybe not too bad? You could make it a max of 65534 instead of 65535, just to avoid having a 0x00FFFF successfully match it incorrectly (because that's probably a common sequence of bytes inside DIAMETER payload).</p>

<p>A lot of normal users don't know about preference settings, and it would be hard to figure out the reason why it's not decoding something it should. :(</p></div>
            <div class="comment-info" id="comment-31576-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 14:52)</span>
                <a class="comment-user userinfo" href="/users/4318/hadriel">Hadriel</a>
                
            </div>
        </div>
    
        <a name="31578"></a>
        <div class="comment not_top_scorer" id="comment-31578">
            <div id="post-31578-score" class="comment-score">1</div>
            <div class="comment-text"><p><a href="/users/655/jeffmorriss"></a><a href="/users/655/jeffmorriss">@JeffMorriss</a>, we seem to be talking about two different things here - The large messages aren't going to come from S6a/d, they're going to come from Sh. ULAs will have limited subscriber data, and EPS-specific subscriber data. Sh interface will have entire XML documents of profile data that can be about virtually anything an application would want to provision.</p>

<p>The operators you're talking about sound like they're just doing traditional LTE roaming, but the concern is the home network's Sh interface between the HSS and the AS's (eg: MMTel, RCS, etc.). I can only imagine what third party developers will do to those XML documents for their own custom applications.</p></div>
            <div class="comment-info" id="comment-31578-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 15:14)</span>
                <a class="comment-user userinfo" href="/users/4985/quadratic">Quadratic</a>
                
            </div>
        </div>
    
        <a name="31579"></a>
        <div class="comment not_top_scorer" id="comment-31579">
            <div id="post-31579-score" class="comment-score">1</div>
            <div class="comment-text"><p>OK, I pushed another <a href="https://code.wireshark.org/review/990">change</a> which checks for the E- and R-bits being set and raised the size limit to 65534 (<a href="/users/4318/hadriel">@Hadriel</a>, not a bad idea about the commonality of 65535).</p>

<p><a href="/users/4985/quadratic">@Quadratic</a>, sure, my example's from S6a but the principle's the same, right?  How much bandwidth are the operators going to be willing to allocate for <em>signaling</em>?</p></div>
            <div class="comment-info" id="comment-31579-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 17:04)</span>
                <a class="comment-user userinfo" href="/users/655/jeffmorriss">JeffMorriss ♦</a>
                
            </div>
        </div>
    
        <a name="31582"></a>
        <div class="comment not_top_scorer" id="comment-31582">
            <div id="post-31582-score" class="comment-score">1</div>
            <div class="comment-text"><p>I think time will tell, but I'd be surprised if operators push back much on the size of those XML documents. Reasons being:</p>

<ul>
<li>
<p>Sh XML pushes aren't really in-line with user signaling in the traditional sense and aren't as delay-sensitive as something like S6a.</p>
</li>
<li>
<p>Everyone wants to follow the standards (which call for all that provisioning info being passed over Diameter/XML).</p>
</li>
<li>
<p>If there's ever a choice between giving more granular features for an application to end users and reducing the size of the XML documents for the sake of bandwidth for the provisioning file transfer, I believe the needs of the end user will always win.</p>
</li>
</ul>

<p>Like I said, time will tell just how crazy we get with provisioning records over Sh but I won't be surprised to see very large packets on that interface over the next couple years.</p></div>
            <div class="comment-info" id="comment-31582-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 20:34)</span>
                <a class="comment-user userinfo" href="/users/4985/quadratic">Quadratic</a>
                
            </div>
        </div>
    
        <a name="31583"></a>
        <div class="comment not_top_scorer" id="comment-31583">
            <div id="post-31583-score" class="comment-score"></div>
            <div class="comment-text"><pre><code>Everyone wants to follow the standards (which call for all that provisioning info being passed over Diameter/XML).
</code></pre>

<p>Yeah, that's the real reason. Otherwise they'd use HTTP for that provisioning-related stuff like normal people. But the 3gpp standards process is dominated by vendors/manufacturers who would feel threatened if HTTP were used; they'd rather keep it as specialized as possible for a vertical market. And their customer telco's have a deep-seated religion about following 3gpp standards no matter what - for very good reasons in some cases, but not all.</p></div>
            <div class="comment-info" id="comment-31583-info">
                
                
                
                

                

                <span class="comment-age">(06 Apr '14, 20:58)</span>
                <a class="comment-user userinfo" href="/users/4318/hadriel">Hadriel</a>
                
            </div>
        </div>
    
</div>
<div id="comment-tools-31245" class="comment-tools">
    
        <span class="comments-showing">
            showing 5 of 16
        </span>
        <a href="#" class="show-all-comments-link">show 11 more comments</a>
    
    
</div>




<div class="clear"></div>
<div id="comment-31245-form-container" class="comment-form-container">
    
</div>
<div class="clear"></div>



                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                
                <div class="paginator-container-left">
                    
                </div>
            
        <form id="fmanswer" action="/questions/31227/answer/" method="post">
            <input type='hidden' name='csrfmiddlewaretoken' value='P7VznECzmHBkWktjMBTyJWFM8MzGxJR3' />
            <div style="clear:both">
            </div>

            
                <div style="padding:10px 0 0 0;">
                    <div class="headNormal">
                        
                            Your answer
                        
                    </div>
                </div>
                

                <div id="description" class="" >
                    <div id="wmd-button-bar" class="wmd-panel"></div>
                    <textarea cols="40" id="editor" name="text" rows="10"></textarea>
                    <div class="preview-toggle">
                        <table width="100%">
                            <tr>
                                <td>
                                    <span id="pre-collapse" 
                                        title="Toggle the real time Markdown editor preview">
                                            toggle preview
                                    </span>
                                </td>
                                <td style="text-align: right;" id="editor-metrics"></td>
                                
                                <td style="text-align:right;">
                                    <input id="id_wiki" name="wiki" type="checkbox" /> 
                                    <span style="font-weight:normal;cursor:help" 
                                        title="if you choose community wiki option, the question and answer do not generate points and name of author will not be shown">
                                            <label for="id_wiki">community wiki:</label> 
                                    </span>
                                </td>
                                
                            </tr>

                        </table>
                    </div>
                    
                    <div id="previewer" class="wmd-preview"></div>
                </div>

                

                <p><span class="form-error"></span></p>
                <input type="button"
                    
                        value="Login/Signup to Post Your Answer" 
                    
                    class="submit" style="float:left" onclick="submitClicked(event, this.form)"/>
            
        </form>
    </div>
</div>


        </div>
        <div id="CARight">
            
<div class="boxC" id="subscription_box">
    <h3 class="subtitle">Follow this question</h3><strong>By Email:</strong><p>Once you sign in you will be able to subscribe for any updates here</p><strong>By RSS:</strong><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/31227/diameter-reassembly-malformed-packets?type=rss" title="subscribe to answers"></a>
    Answers
</p><p><a class="feed-icon" style="background-image:url('/m/default/media/images/feed-icon-small.png');"
        href="/questions/31227/diameter-reassembly-malformed-packets?type=rss&comments=yes" title="subscribe to comments and answers"></a>
    Answers and Comments
</p>

</div>


<div class="boxC" id="editor_side_bar">
    <p class="subtitle darkred">Markdown Basics</p>
    <ul class="list-item">
        <li>
            *italic* or _italic_
        </li>
        <li>
			**bold** or __bold__
        </li>
        <li>
            <b>link</b>:[text](http://url.com/ "title")

        </li>

        <li>
            <b>image</b>?![alt text](/path/img.jpg "title")

        </li>
        <li>
			numbered list:
            1.  Foo
            2.  Bar
        </li>
        <li>
			to add a line break simply add two spaces to where you would like the new line to be.
        </li>
        <li>
			basic HTML tags are also supported
        </li>
    </ul>
    <p class='info-box-follow-up-links'>
        <a href="/markdown_help/" target="_blank">learn more about Markdown </a>
    </p>
</div>



<div id="sidebar-upper" class="boxC">
    <div class="body">
        <h2>You have a trillion packets.</h2>
<h3>You need to see four of them.</h3>
<p><a href="http://www.riverbed.com/products-solutions/products/network-performance-management/">Riverbed Technology</a> lets you seamlessly move between packets and flows for comprehensive monitoring, analysis and troubleshooting.</p>
<p><a href="http://www.riverbed.com/us/products/cascade/wireshark_enhancements/"><img style="margin-left: 39px;" src="https://www.wireshark.org/image/logo_riverbed_150.png"></a></p>
<p>Riverbed is Wireshark's primary sponsor and provides our funding.</p>
     </div>
</div>




<div class="boxC">
    <p>
        Question tags:
    </p>
    <p class="tags" >
        
        <a href="/tags/tcp/"
            class="tag-link-tcp"
            title="see questions tagged'tcp'using tags"
            rel="tag">tcp</a> <span class="tag-number">&#215;752</span><br/>
        
        <a href="/tags/reassembly/"
            class="tag-link-reassembly"
            title="see questions tagged'reassembly'using tags"
            rel="tag">reassembly</a> <span class="tag-number">&#215;78</span><br/>
        
        <a href="/tags/diameter/"
            class="tag-link-diameter"
            title="see questions tagged'diameter'using tags"
            rel="tag">diameter</a> <span class="tag-number">&#215;58</span><br/>
        
        <a href="/tags/malformed/"
            class="tag-link-malformed"
            title="see questions tagged'malformed'using tags"
            rel="tag">malformed</a> <span class="tag-number">&#215;47</span><br/>
        
    </p>
    <p>
        question asked: <strong title="March 27, 2014, 11:29 a.m.">27 Mar '14, 11:29</strong>
    </p>
    <p> 
     	question was seen: <strong>7,246 times</strong>
    </p>
    <p> 
        last updated: <strong title="April 6, 2014, 8:58 p.m.">06 Apr '14, 20:58</strong>
    </p>
</div>


<div id="sidebar-lower" class="boxC">
    <div class="body">
        <h2>Don't have Wireshark?</h2>
<p>What are you waiting for? It's free! Wireshark documentation and downloads can be found at the <a href="https://www.wireshark.org/"><strong>Wireshark web site</strong></a>.</p>
     </div>
</div>


<div class="boxC">
    <h3 class="subtitle">Related questions</h3>
    <div class="questions-related">

        
        <p>
            <a href="/questions/17805/why-doesnt-wireshark-reassemble-http-post-messages-in-my-converted-raw-ip-capture">Why doesn&#39;t Wireshark reassemble HTTP POST messages in my converted raw IP capture</a>
        </p>
        
        <p>
            <a href="/questions/43383/during-reassembly-of-a-protocol-running-on-top-of-tcp-setting-desegment_offset0-and-desegment_lendesegment_one_more_segment-seems-to-break-down-the-behavior-stated-in-readmedissector-is-this-expected">During reassembly of a protocol running on top of TCP, setting desegment_offset=0 and desegment_len=DESEGMENT_ONE_MORE_SEGMENT seems to break down the behavior stated in README.dissector. Is this expected?</a>
        </p>
        
        <p>
            <a href="/questions/44057/complex-lua-tcp-reassembly-problem">Complex Lua TCP Reassembly Problem</a>
        </p>
        
        <p>
            <a href="/questions/59314/tcp-reassembly-issues">TCP Reassembly issues</a>
        </p>
        
        <p>
            <a href="/questions/14280/how-does-wireshark-reassemble-tcp-segments">How does Wireshark reassemble TCP Segments</a>
        </p>
        
        <p>
            <a href="/questions/62798/tcphttp-reassemble">TCP\HTTP reassemble</a>
        </p>
        
        <p>
            <a href="/questions/344/conditional-tcp-reassembly-based-on-dscp-bits">Conditional TCP reassembly based on DSCP bits</a>
        </p>
        
        <p>
            <a href="/questions/5382/custom-dissector-and-info-column">Custom dissector and info column</a>
        </p>
        
        <p>
            <a href="/questions/48918/tcp-retransmissions-reassembled-pdu-tcp-out-of-order-issue-with-slow-connectivity">TCP Retransmissions, reassembled PDU, TCP Out-of-order, issue with slow connectivity</a>
        </p>
        
        <p>
            <a href="/questions/2289/enabling-reassembly-of-tcp-packets">Enabling reassembly of TCP packets</a>
        </p>
        

    </div>
</div>



        </div>
        <div id="tail" style="clear:both;">
            
            
        </div>
    </div>
    <div class="spacer3"></div>
</div>

        
            <div id="ground">
                


<div>
    <div class="footerLinks" >
         <a href="/about/" >about</a> <span class="link-separator"> |</span> <a href="/faq/" >faq</a> <span class="link-separator"> |</span> <a href="/privacy/" >privacy</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" target="_blank">support</a> <span class="link-separator"> |</span> <a href="https://bugs.wireshark.org/" >contact</a> 
    </div>
  <p>
        p&#8203;o&#8203;w&#8203;e&#8203;r&#8203;e&#8203;d by &#79;&#8203;&#83;&#8203;&#81;&#8203;&#65;
  </p>
</div>
 <div id="licenseLogo">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
            <img src="/m/default/media/images/by-sa-88x31.png" title="Creative Commons: Attribution - Share Alike" alt="cc-by-sa" width="88" height="31" />
  </a>
 </div>


            </div>
        
        

        
            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-605389-6']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
        
        </div>

        <!-- Put all elements with fixed position here, IE6 fixed position fix: http://ryanfait.com/position-fixed-ie6/ -->
        <div class="notify" style="display:none">
            
                
                    
                          <p class="darkred">First time here? Check out the <a href="/faq/">FAQ</a>!</p>
                    
                
            
            <a id="close-notify" onclick="notify.close(true)">&#215;</a>
        </div>
    </body>
</html>
<!-- end template base_content.html -->
