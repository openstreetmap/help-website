+++
type = "question"
title = "Tons of Retransmission and Dup ACK - WiFi to Android, using Java NIO"
description = '''New user here, and my knowledge of TCP/IP is not good.  Here&#x27;s the WireShark capture: https://www.cloudshark.org/captures/7133e5f96577 The connection is between my PC and an Android device on WiFi. I&#x27;m developing my own TCP/IP modules for both ends. I think the PC module is OK - PC-to-PC communicati...'''
date = "2015-10-09T06:23:00Z"
lastmod = "2015-10-09T08:34:00Z"
weight = 46431
keywords = [ "android", "retransmissions" ]
aliases = [ "/questions/46431" ]
osqa_answers = 0
osqa_accepted = true
+++

<div class="headNormal">

# [Tons of Retransmission and Dup ACK - WiFi to Android, using Java NIO](/questions/46431/tons-of-retransmission-and-dup-ack-wifi-to-android-using-java-nio)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-46431-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count">1</div></div></td><td><div id="item-right"><div class="question-body"><p>New user here, and my knowledge of TCP/IP is not good.</p><p>Here's the WireShark capture: <a href="https://www.cloudshark.org/captures/7133e5f96577">https://www.cloudshark.org/captures/7133e5f96577</a></p><p>The connection is between my PC and an Android device on WiFi. I'm developing my own TCP/IP modules for both ends. I think the PC module is OK - PC-to-PC communications works fine.</p><p>Android-to-PC also works OK, but PC-to-Android is very slow, down around 10% of the speed in the other direction.</p><p>I've run an Android app called SpeedTest, and it indicates that the WiFi connection is OK, with speed in both directions about the same.</p><p>So in desperation I've tried using WireShark to see what is going on. There are tons of Retransmission and Dup ACK packets. I assume this is what is causing the performance to be so poor, right? (10.2.2.20 is my PC, 172.16.31.178 is the Android device.)</p><p>I'm also assuming my Android programming must be faulty. I'm using Java NIO, if that's relevant. Does anyone have any suggestions as to what is wrong, to cause these symptoms?</p><p>Thanks in advance.</p></div><div id="question-tags" class="tags-container tags">android retransmissions</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>09 Oct '15, 06:23</strong></p><img src="https://secure.gravatar.com/avatar/cefa500b666d789893f89cae377b7e76?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="RenniePet&#39;s gravatar image" /><p>RenniePet<br />
<span class="score" title="11 reputation points">11</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="7 badges"><span class="bronze">●</span><span class="badgecount">7</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="RenniePet has no accepted answers">0%</span></p></div></div><div id="comments-container-46431" class="comments-container"></div><div id="comment-tools-46431" class="comment-tools"></div><div class="clear"></div><div id="comment-46431-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="46437"></span>

<div id="answer-container-46437" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-46437-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>You are correct, the timer based (= delayed) retransmissions after packet loss are what is hurting performance. So you either need to avoid the packet loss or tune your windows to react faster on it.</p><p>There is a hotfix out there that allows to reduce the minRTO value in Windows:</p><p><a href="http://support.microsoft.com/kb/2472264">http://support.microsoft.com/kb/2472264</a></p><p>" ... For example, you can use the following command to set the values for the Custom template.</p><pre><code>netsh interface tcp set supplemental template=custom minRto=20 icw=16 delayedacktimeout=10</code></pre><p>Note You have to tell the stack to use these Custom template values. The default template that the stack uses is the Internet template. Set the Custom template to be the global default template by using the following command:</p><pre><code>netsh interface tcp set supplemental template=custom</code></pre><p>Note This command makes the custom values valid for all connections. "</p><hr /><p>"Why does my PC choose to send small packets to the WiFi router and large packets to the other PC? I'm perhaps misunderstanding something, but the end result is that sending data to the Android device via the WiFi router is very slow, compared with everything else."</p><p>Your PC starts out using Large-Send (TCP Segmentation Offload) however none of those 'large' packets make it to the android device.<br />
The (duplicate) ACKs indicate that only the second half of the large segment was received by the android's TCP layer. So with the receipt of duplicate ACKs indicating packet loss your windows reverts back to normal sending of segments for a while until it retries segmentation offload with the same results, being the first segment never arrives resulting in 3 dup_ACKs and fast retransmission.</p><pre><code>(tcp.analysis.duplicate_ack_num == 3 or tcp.len gt 1448) and tcp.stream eq 0</code></pre><p>I would suggest to turn off Segmentation Offload / TCP Chimney Offload as per <a href="https://support.microsoft.com/en-us/kb/951037">How to enable and disable TCP Chimney Offload in Windows Server 2008</a> to see if it helps avoid the packet loss over WiFi towards the android TCP layer.</p><p>Regards Matthias</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>09 Oct '15, 08:34</strong></p><img src="https://secure.gravatar.com/avatar/5500bd1decb766660522dfb347eedc49?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde&#39;s gravatar image" /><p>mrEEde<br />
<span class="score" title="3892 reputation points"><span>3.9k</span></span><span title="15 badges"><span class="badge1">●</span><span class="badgecount">15</span></span><span title="22 badges"><span class="silver">●</span><span class="badgecount">22</span></span><span title="70 badges"><span class="bronze">●</span><span class="badgecount">70</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde has 48 accepted answers">20%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 13 Oct '15, 22:43</p></div></div><div id="comments-container-46437" class="comments-container"><span id="46442"></span><div id="comment-46442" class="comment"><div id="post-46442-score" class="comment-score"></div><div class="comment-text"><p>Great hotfix link.</p></div><div id="comment-46442-info" class="comment-info"><span class="comment-age">(10 Oct '15, 01:50)</span> Christian_R</div></div><span id="46487"></span><div id="comment-46487" class="comment"><div id="post-46487-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your answer.</p><p>As I mention, I don't know enough about TCP, but have been reading up on it the last couple of days.</p><p>Unfortunately, I don't think your answer is relevant to my problem. In fact, I don't think the Retransmission and Dup ACK packets are relevant either - so I was (probably) wrong on that point, and should not have made that part of my question.</p><p>What I'm seeing in this Wireshark log is that sending to the WiFi router (a SonicWall firewall / WiFi router) results in one packet of typically 1.5 KB every 2 ms. or so, while sending to another PC on the network results in one packet of 15 KB every 1 ms. or so.</p><p>Why does my PC choose to send small packets to the WiFi router and large packets to the other PC? I'm perhaps misunderstanding something, but the end result is that sending data to the Android device via the WiFi router is very slow, compared with everything else.</p></div><div id="comment-46487-info" class="comment-info"><span class="comment-age">(12 Oct '15, 22:22)</span> RenniePet</div></div><span id="46583"></span><div id="comment-46583" class="comment"><div id="post-46583-score" class="comment-score"></div><div class="comment-text"><p>Matthias, thank you very much. Your last suggestion about turning off the TCP Chimney Offload does indeed fix the problem.</p><p>Strangely, for my system (Windows 7 64-bit) turning this option off via the command prompt simply doesn't work. (And yes, I did run command prompt as administrator. I even rebooted the PC to see if that made it work, but no.) When I display the parameters it says "disabled", but I still have the problem. It was first when I disabled the corresponding option for the network card that my problem was fixed.</p><p>So now I have a new question, if you'll bear with me. Is this a very rare situation I find myself in? Because I don't feel I can expect the customers of my program to be willing to do something like this, and it's apparently not something I can do via programming. Or is it? Can I specify a max packet size of 1448 bytes somewhere and fix it that way, so the fix is only for my program and not system-wide?</p></div><div id="comment-46583-info" class="comment-info"><span class="comment-age">(15 Oct '15, 15:02)</span> RenniePet</div></div><span id="46585"></span><div id="comment-46585" class="comment not_top_scorer"><div id="post-46585-score" class="comment-score"></div><div class="comment-text"><p>From my point of view it was a little bit strange what we have seen in the trace. So have you ever tried to use an actual nic driver?</p></div><div id="comment-46585-info" class="comment-info"><span class="comment-age">(15 Oct '15, 15:19)</span> Christian_R</div></div><span id="46586"></span><div id="comment-46586" class="comment not_top_scorer"><div id="post-46586-score" class="comment-score"></div><div class="comment-text"><blockquote><p>So have you ever tried to use an actual nic driver?</p></blockquote><p>Sorry, I don't understand what you mean. My PC program is written in C#, and uses .Net's SocketAsyncEventArgs, which uses the corresponding Windows API, which uses whatever network card driver and network card that happens to be installed in the machine. For my development machine it's a "Realtek PCIe GBE Family Controller". But when my program gets installed at a customer site it could be any network card and driver that the customer machine has.</p></div><div id="comment-46586-info" class="comment-info"><span class="comment-age">(15 Oct '15, 15:37)</span> RenniePet</div></div><span id="46587"></span><div id="comment-46587" class="comment not_top_scorer"><div id="post-46587-score" class="comment-score"></div><div class="comment-text"><p>So normally TCP Offloading should be no problem. But in the past a lot of problems with TCP Offloading has been caused by network drivers. And I thought you only had problems in this special case?! Am I wrong? If I am not wrong, than try to update the Realtek driver and try again with activated TCP Offloading.</p></div><div id="comment-46587-info" class="comment-info"><span class="comment-age">(15 Oct '15, 15:43)</span> Christian_R</div></div><span id="46614"></span><div id="comment-46614" class="comment"><div id="post-46614-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>If I am not wrong, than try to update the Realtek driver and try again with activated TCP Offloading.</p></blockquote><p>@Christian_R: OK, I updated the driver and re-enabled the TCP offloading and now everything works. So I've wasted about three days due to a defective driver. Sigh. At least I've learned a lot about TCP and Wireshark. Thanks for your help.</p></div><div id="comment-46614-info" class="comment-info"><span class="comment-age">(16 Oct '15, 05:50)</span> RenniePet</div></div><span id="46618"></span><div id="comment-46618" class="comment"><div id="post-46618-score" class="comment-score">1</div><div class="comment-text"><p>You are welcome. And I have learned, too. E.g. : A great link -&gt; thanks @mrEEde</p></div><div id="comment-46618-info" class="comment-info"><span class="comment-age">(16 Oct '15, 06:09)</span> Christian_R</div></div></div><div id="comment-tools-46437" class="comment-tools"><span class="comments-showing"> showing 5 of 8 </span> <a href="#" class="show-all-comments-link">show 3 more comments</a></div><div class="clear"></div><div id="comment-46437-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

