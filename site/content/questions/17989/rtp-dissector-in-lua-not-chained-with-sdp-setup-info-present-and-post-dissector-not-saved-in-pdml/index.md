+++
type = "question"
title = "RTP dissector in Lua not chained with SDP setup info present and post-dissector not saved in pdml"
description = '''Hi, I&#x27;m pretty much a Wireshark noob, but.. I&#x27;m trying to analyze some RTP streams, some of which are set up by SIP (with some additional features). I&#x27;m writing packet dissectors in Lua, but there are a couple of problems. As far as I can tell, if I use a chained dissector and add it to the udp diss...'''
date = "2013-01-27T12:56:00Z"
lastmod = "2013-02-26T16:45:00Z"
weight = 17989
keywords = [ "lua", "pdml", "rtp", "dissectors" ]
aliases = [ "/questions/17989" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [RTP dissector in Lua not chained with SDP setup info present and post-dissector not saved in pdml](/questions/17989/rtp-dissector-in-lua-not-chained-with-sdp-setup-info-present-and-post-dissector-not-saved-in-pdml)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-17989-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-17989-score" class="post-score" title="current number of votes">0</div><span id="post-17989-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, I'm pretty much a Wireshark noob, but..</p><p>I'm trying to analyze some RTP streams, some of which are set up by SIP (with some additional features).</p><p>I'm writing packet dissectors in Lua, but there are a couple of problems. As far as I can tell, if I use a chained dissector and add it to the udp dissector table where udp.port == [port of interest] then the dissector works fine EXCEPT where the builtin Wireshark RTP dissector has added a 'Stream setup by SDP' subtree. I'm not sure how Wireshark determines which packets are RTP other than as part of a SIP conversation, but I haven't had any luck attaching a dissector to these packets.</p><p>The most reliable way is to disable RTP protocol and dissect the RTP headers myself, but then I lose the stream setup by info that Wireshark provides. I can probably do this myself with Lua but it seems like a lot of extra work, given my level of expertise.. I would prefer to take advantage of all of Wiresharks built in RTP dissectors and just add my stuff.</p><p>Which leads me to my second problem. A post dissector actually works fine, is easy to write and accomplishes EVERYTHING I need, EXCEPT for the fact that the post dissector tree IS NOT WRITTEN to an exported .PDML file. This is a blocking issue for me as I'm doing further analysis with this file.</p><p>I'd be very grateful for any pointers on what is causing the SDP setup info dissector to disable my dissector and how to make it work. Failing that, is exporting of post dissector info to .pdml problematic, or is this just an omission that could be fixed in the source? (I'm not keen to build Wireshark myself as I'm using windoze, but maybe if this is an easy fix, somebody could submit a patch?).</p><p><strong>UPDATE</strong> I thought the first problem might be with Wireshark decoding dynamic payload type 99 as RFC 2198. I disabled the dissector RFC 2198 in RTP preferences. see: <a href="http://ask.wireshark.org/questions/13891/how-to-decode-dynamic-pt-in-rtp-eg-rfc-2429-in-rtp-carring-h263-video">http://ask.wireshark.org/questions/13891/how-to-decode-dynamic-pt-in-rtp-eg-rfc-2429-in-rtp-carring-h263-video</a> ..However my dissector still won't run on those packets. The only difference seems to be the SDP stream setup info but if I disable this in preferences, the problem persists.</p><p>My dissector is installed using <code>DissectorTable.get("udp.port"):add(9050, proto)</code></p><p>I also use <code>Dissector.get("rtp"):call(buf(0):tvb(),pkt,root)</code> at the start of the dissector function, but adding or removing this has no effect other than what's expected.</p><p>Cheers, Jono Poff.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-lua" rel="tag" title="see questions tagged &#39;lua&#39;">lua</span> <span class="post-tag tag-link-pdml" rel="tag" title="see questions tagged &#39;pdml&#39;">pdml</span> <span class="post-tag tag-link-rtp" rel="tag" title="see questions tagged &#39;rtp&#39;">rtp</span> <span class="post-tag tag-link-dissectors" rel="tag" title="see questions tagged &#39;dissectors&#39;">dissectors</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>27 Jan '13, 12:56</strong></p><img src="https://secure.gravatar.com/avatar/754877fa55fad6f262af00189b7447ed?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="J0N0&#39;s gravatar image" /><p><span>J0N0</span><br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="J0N0 has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>27 Jan '13, 19:05</strong> </span></p></div></div><div id="comments-container-17989" class="comments-container"><span id="18051"></span><div id="comment-18051" class="comment"><div id="post-18051-score" class="comment-score"></div><div class="comment-text"><p>If I decode packets as RTP using 'decode as' they also are bypassed by the Lua plugin dissector..</p></div><div id="comment-18051-info" class="comment-info"><span class="comment-age">(29 Jan '13, 11:42)</span> <span class="comment-user userinfo">J0N0</span></div></div></div><div id="comment-tools-17989" class="comment-tools"></div><div class="clear"></div><div id="comment-17989-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="18876"></span>

<div id="answer-container-18876" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-18876-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-18876-score" class="post-score" title="current number of votes">1</div><span id="post-18876-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>So it turns out PDML writing should work with a Lua post-dissector, but wasn't in your case due to bug 6020. Ironically that bug was fixed by me, and the code change was just delivered into 1.9.1 this afternoon. So it should work with the latest automated build of 1.9.1, SVN-47877 or higher. (see <a href="http://www.wireshark.org/download/automated/">http://www.wireshark.org/download/automated/</a>)</p><p>I don't know if/when it will be back-ported to stable release patches.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>25 Feb '13, 22:15</strong></p><img src="https://secure.gravatar.com/avatar/d02f20c18a7742ec73a666f1974bf6dc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Hadriel&#39;s gravatar image" /><p><span>Hadriel</span><br />
<span class="score" title="2652 reputation points"><span>2.7k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="9 badges"><span class="silver">●</span><span class="badgecount">9</span></span><span title="39 badges"><span class="bronze">●</span><span class="badgecount">39</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Hadriel has 30 accepted answers">18%</span></p></div></div><div id="comments-container-18876" class="comments-container"><span id="18898"></span><div id="comment-18898" class="comment"><div id="post-18898-score" class="comment-score"></div><div class="comment-text"><p>Hi Hadriel,</p><p>yes I can confirm that Version 1.9.1-SVN-47899 writes post-dissector info and fixes a lot of these issues. RTP setup info is still missing from PDML output, even tho it appears in the GUI. Maybe there's an explanation for this.. Anyway, it's irrelevant to me now as I've written my own RTP and SDP dissectors to analyse setup and add RTP dissectors to new streams.</p><p>Thanks again for all your help. Btw, I've written an XSLT to transform PDML as swim lanes into HTML. I'll ask my boss if I can contribute it if anyone's interested.</p><p>Cheers, Jono</p></div><div id="comment-18898-info" class="comment-info"><span class="comment-age">(26 Feb '13, 14:55)</span> <span class="comment-user userinfo">J0N0</span></div></div><span id="18899"></span><div id="comment-18899" class="comment"><div id="post-18899-score" class="comment-score"></div><div class="comment-text"><p>Your answer has been converted to a comment as that's how this site works. Please read the FAQ for more information.</p><p>If an answer has solved your issue, please accept the answer for the benefit of other users by clicking the checkmark icon next to the answer. Please read the FAQ for more information.</p></div><div id="comment-18899-info" class="comment-info"><span class="comment-age">(26 Feb '13, 15:01)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="18900"></span><div id="comment-18900" class="comment"><div id="post-18900-score" class="comment-score"></div><div class="comment-text"><p>The setup info appears for me: ' &lt;proto name="rtp" showname="Real-Time Transport Protocol" size="252" pos="42"&gt; &lt;field name="rtp.setup" showname="Stream setup by SDP (frame 11)" size="0" pos="42" show=""&gt; &lt;field name="rtp.setup-frame" showname="Setup frame: 11" size="0" pos="42" show="11"/&gt; &lt;field name="rtp.setup-method" showname="Setup Method: SDP" size="0" pos="42" show="SDP"/&gt; &lt;/field&gt; '</p><p>Did you re-enabled Preferences -&gt; Protocols -&gt; SDP -&gt; Establish Media Conversation?</p></div><div id="comment-18900-info" class="comment-info"><span class="comment-age">(26 Feb '13, 15:15)</span> <span class="comment-user userinfo">Hadriel</span></div></div><span id="18902"></span><div id="comment-18902" class="comment"><div id="post-18902-score" class="comment-score"></div><div class="comment-text"><p>It works!</p><p>Wireshark wrote the built-in SDP/RTP setup info to PDML just fine, but I wanted to use this info downstream in a post-dissector (eg, see below) and write it to PDML. Up til now, that has worked in the GUI but not with PDML.</p><p>Now it works for both, which is awesome. Thx.</p><p>:-)</p><hr /><pre><code>udp_src_f = Field.new(&quot;udp.srcport&quot;)
rtp_setup_f = Field.new(&quot;rtp.setup-frame&quot;)
trivial_proto = Proto(&quot;trivial&quot;,&quot;Trivial Postdissector&quot;)
f_port = ProtoField.uint16(&quot;trivial.port&quot;,&quot;Port&quot;)
f_setup = ProtoField.uint8(&quot;tait.rtp_setup_frame&quot;,&quot;SetupFrame&quot;)
f_comment = ProtoField.string(&quot;trivial.comment&quot;,&quot;Comment&quot;)
trivial_proto.fields = {f_comment}
function trivial_proto.dissector(buffer,pinfo,tree)
    local subtree = tree:add(trivial_proto,&quot;Trivial&quot;)
    if udp_src_f() then
       subtree:add(f_comment, &quot;udp.srcport found&quot;)
       subtree:add(f_port, udp_src_f().value)
   else
       subtree:add(f_comment, &quot;udp.srcport not found&quot;)
   end
if rtp_setup_f() then
   subtree:add(f_comment, &quot;rtp.setup-frame&quot;)
   subtree:add(f_setup, rtp_setup_f().value)</code></pre><p>else subtree:add(f_comment, "rtp.setup-frame not found") end end</p></code><p><code>register_postdissector(trivial_proto)</code></p></pre></div><div id="comment-18902-info" class="comment-info"><span class="comment-age">(26 Feb '13, 16:43)</span> <span class="comment-user userinfo">J0N0</span></div></div><span id="18903"></span><div id="comment-18903" class="comment"><div id="post-18903-score" class="comment-score"></div><div class="comment-text"><p>Sorry about my comment that it didn't work in 1.9.1, SVN-47877. Not sure what happened there...</p></div><div id="comment-18903-info" class="comment-info"><span class="comment-age">(26 Feb '13, 16:45)</span> <span class="comment-user userinfo">J0N0</span></div></div></div><div id="comment-tools-18876" class="comment-tools"></div><div class="clear"></div><div id="comment-18876-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="17999"></span>

<div id="answer-container-17999" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-17999-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-17999-score" class="post-score" title="current number of votes">0</div><span id="post-17999-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>SDP makes an interpretation of the media lines and uses a helper function in the RTP dissector to define a conversation, with RTP as dissector. This is how the setup information comes in RTP, and assigns RTP as dissector for this stream. Either showing or not showing the setup information doesn't prevent the SDP from creating these conversations. So, these two come in pair: setup information and RTP dissector gets the payload. I think all you can do is inhibit SDP from setting up the conversation. That allows your dissector access to the payload, but you loose the setup info.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>28 Jan '13, 03:01</strong></p><img src="https://secure.gravatar.com/avatar/2337f0406681e5c72ea0e6f1f0d6c0b0?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jaap&#39;s gravatar image" /><p><span>Jaap ♦</span><br />
<span class="score" title="11680 reputation points"><span>11.7k</span></span><span title="16 badges"><span class="silver">●</span><span class="badgecount">16</span></span><span title="101 badges"><span class="bronze">●</span><span class="badgecount">101</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jaap has 155 accepted answers">14%</span></p></div></div><div id="comments-container-17999" class="comments-container"><span id="18016"></span><div id="comment-18016" class="comment"><div id="post-18016-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jaap, I thought that might be the case.<br />
</p><p>If I disable the RTP dissector entirely and get setup info directly from the SDP message header, eg:</p><p>o=16386 1355173130331 1355173130331 IN IP4 172.26.26.8 m=audio 9050 RTP/AVP 100</p><p>how practical would it be to follow the conversations myself (with a listener maybe?) then add setup info to my own RTP packet dissector. I guess it would require some ongoing analysis of the SIP conversation..</p><p>What would be really great would be a hook to override the RTP dissector being called by SDP with a user supplied one.</p></div><div id="comment-18016-info" class="comment-info"><span class="comment-age">(28 Jan '13, 13:17)</span> <span class="comment-user userinfo">J0N0</span></div></div><span id="18020"></span><div id="comment-18020" class="comment"><div id="post-18020-score" class="comment-score"></div><div class="comment-text"><p>That would mean you have to parse SDP as well. From that you would create a conversation defining UDP packet flow to that endpoint to go to your dissector. I'm not well versed enough in Lua to know if that's possible.</p></div><div id="comment-18020-info" class="comment-info"><span class="comment-age">(28 Jan '13, 23:00)</span> <span class="comment-user userinfo">Jaap ♦</span></div></div><span id="18856"></span><div id="comment-18856" class="comment"><div id="post-18856-score" class="comment-score"></div><div class="comment-text"><p>I think what Jaap means is to go into Preferences -&gt; Protocol -&gt; SDP, and de-select the "Establish Media Conversation" checkbox. That should make the SDP dissector not invoke RTP dissection for the UDP ip:port flows that is indicated by SDP, so that RTP's dissector won't get called before/instead-of your own dissector for those UDP ip:port flows.</p><p>Of course that also means there won't be any setup info and dynamic RTP dissection.</p><p>Another alternative is to submit an enhancement request for the tree info generated by a post-dissector to be exported in PDML, so that you can instead use a post-dissector - since that's arguably the right thing to use to begin with.</p></div><div id="comment-18856-info" class="comment-info"><span class="comment-age">(25 Feb '13, 11:30)</span> <span class="comment-user userinfo">Hadriel</span></div></div><span id="18863"></span><div id="comment-18863" class="comment"><div id="post-18863-score" class="comment-score"></div><div class="comment-text"><p>Thanks Hadriel,</p><p>I've written the SDP setup stuff in Lua and am now loading RTP dissectors as needed according to that info.<br />
</p><p>It does feel like reinventing the wheel tho, and really all I need is for the post-dissector to be written to pdml, so that wld definitely be a good enhancement from my perspective. Therefore I'll put in a request!</p><p>Cheers, Jono</p></div><div id="comment-18863-info" class="comment-info"><span class="comment-age">(25 Feb '13, 14:06)</span> <span class="comment-user userinfo">J0N0</span></div></div></div><div id="comment-tools-17999" class="comment-tools"></div><div class="clear"></div><div id="comment-17999-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

