+++
type = "question"
title = "Anything I&#x27;m missing in my analysis of retransmits?"
description = '''We have a source server 10.235.3.53(local) transferring to 10.240.44.9(remote), and throughput is quite slow. All local links/devices have been vetted as clean so we moved to a capture. I see a lot of DUP ACKs followed by retransmits, which would be why we&#x27;re seeing reduced performance. https://www....'''
date = "2014-10-14T14:16:00Z"
lastmod = "2014-10-14T22:34:00Z"
weight = 37044
keywords = [ "duplicate" ]
aliases = [ "/questions/37044" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [Anything I'm missing in my analysis of retransmits?](/questions/37044/anything-im-missing-in-my-analysis-of-retransmits)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-37044-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>We have a source server 10.235.3.53(local) transferring to 10.240.44.9(remote), and throughput is quite slow. All local links/devices have been vetted as clean so we moved to a capture.</p><p>I see a lot of DUP ACKs followed by retransmits, which would be why we're seeing reduced performance.</p><p><a href="https://www.cloudshark.org/captures/00208d87b26d">https://www.cloudshark.org/captures/00208d87b26d</a> This particular capture is the inside interface of the local firewall. The dup ack I see are sourced from remote 10.240.44.9 to the local 10.235.3.53, so it would appear the packet is getting lost somewhere between our local firewall and local server. Then we see 10.235.2.53 do a fast retransmit since it never saw an ACK for the packet. Correct?</p><p>Is there anything I'm missing from the capture which can give more details?</p><p>Thanks all!</p></div><div id="question-tags" class="tags-container tags">duplicate</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>14 Oct '14, 14:16</strong></p><img src="https://secure.gravatar.com/avatar/e304c2551c490a018a9ccaef7a4d129f?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="parsonsproject&#39;s gravatar image" /><p>parsonsproject<br />
<span class="score" title="16 reputation points">16</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="parsonsproject has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 14 Oct '14, 14:23</p></div></div><div id="comments-container-37044" class="comments-container"><span id="37075"></span><div id="comment-37075" class="comment"><div id="post-37075-score" class="comment-score"></div><div class="comment-text"><p>Here is a capture of the 3 way handshake <a href="https://www.cloudshark.org/captures/55bd973d2a44">https://www.cloudshark.org/captures/55bd973d2a44</a></p><p>If i read this correct, initial window size from src is 5840, and slowly scales up to 10880. The dst has a window size which scales to 69632. So they are not settling on a nice window between the two? I see line 365 a tcp window update from the far end to the local src, but it doesn't seem to do anything with the sender's window.</p></div><div id="comment-37075-info" class="comment-info"><span class="comment-age">(15 Oct '14, 09:03)</span> parsonsproject</div></div></div><div id="comment-tools-37044" class="comment-tools"></div><div class="clear"></div><div id="comment-37044-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="37045"></span>

<div id="answer-container-37045" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-37045-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>Packets are being lost between your capture point and the receiver, 10.240.44.9, not between your capture point and the sender. To verify this, select any of the six packets that Wireshark has identified as retransmissions. Open the TCP portion of the packet, right-click on the sequence number, and select "Apply as filter &gt; Selected." You will see both the original packet and the retransmission, meaning that the original packet made it from the sender to your capture point; it was dropped somewhere downstream from your capture point.</p><p>No, the Fast Retransmissions are not because the sender never got an ACK for the data packet. Fast Retransmissions are triggered when the sender gets three Duplicate ACKs from the receiver.</p><p>When a packet is transmitted, the sender starts the Receive Time Out (RTO) timer. If the RTO timer counts down to zero and no ACK has been received for that packet, the sender will retransmit it. However, the sender will also retransmit the packet if it received three Duplicate ACKs from the receiver, and this happens more quickly than the RTO timer counts down, hence the name "<em>Fast</em> Retransmission."</p><p>This communication was already underway when the capture started, so the TCP three-way handshake is missing. Whenever possible, try to start capturing before the TCP connection is established so that the three-way handshake will be in the capture file. There are certain things that are only seen in the three-way handshake. For example, it is very likely that window scaling is usesd on this connection, but without the handshake, we don't know what the window scaling factors are so we don't know what the true TCP window sizes are.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>14 Oct '14, 16:05</strong></p><img src="https://secure.gravatar.com/avatar/071fe61f64868d98bdf4eb060b63b6ca?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jim%20Aragon&#39;s gravatar image" /><p>Jim Aragon<br />
<span class="score" title="7187 reputation points"><span>7.2k</span></span><span title="7 badges"><span class="badge1">●</span><span class="badgecount">7</span></span><span title="33 badges"><span class="silver">●</span><span class="badgecount">33</span></span><span title="118 badges"><span class="bronze">●</span><span class="badgecount">118</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jim Aragon has 70 accepted answers">24%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 15 Oct '14, 05:03</p></div></div><div id="comments-container-37045" class="comments-container"><span id="37064"></span><div id="comment-37064" class="comment"><div id="post-37064-score" class="comment-score"></div><div class="comment-text"><p>Thank you Jim that is helpful.</p><p>I'll have to get another capture for the 3-way handshake, but I do have the traffic capture on the local firewall outside interface and the far firewall outside interface captured as well</p><p>local firewall outside interface <a href="https://www.cloudshark.org/captures/c99c0a9518e2">https://www.cloudshark.org/captures/c99c0a9518e2</a></p><p>remote firewall outside interface <a href="https://www.cloudshark.org/captures/fae08e88b12f">https://www.cloudshark.org/captures/fae08e88b12f</a></p><p>remote firewall inside interface <a href="https://www.cloudshark.org/captures/ccfa5d77927f">https://www.cloudshark.org/captures/ccfa5d77927f</a></p><p>Setting up the filter as you mentioned, I see the original encrypted packet go out the local fw outside interface, as well as the tcp fast retransmission packet, however on the far side we don't see the original packet get to the outside interface, just the follow-up re-transmit. So the drop is occurring somewhere between the firewalls then?</p><p>Is there an easy way to follow tcp streams through interfaces? I'm having troubles aligning which packets on the inside capture correspond to which packets on the outside capture.</p><p>Thanks again</p></div><div id="comment-37064-info" class="comment-info"><span class="comment-age">(15 Oct '14, 07:13)</span> parsonsproject</div></div><span id="37103"></span><div id="comment-37103" class="comment"><div id="post-37103-score" class="comment-score"></div><div class="comment-text"><p>Yes, the packets are being dropped between the two firewalls.</p><p>To correlate the two streams on different sides of the firewall, you need to look for some common value in each stream. You could try IP ID and/or TCP sequence numbers.</p></div><div id="comment-37103-info" class="comment-info"><span class="comment-age">(16 Oct '14, 05:02)</span> Jim Aragon</div></div></div><div id="comment-tools-37045" class="comment-tools"></div><div class="clear"></div><div id="comment-37045-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="37048"></span>

<div id="answer-container-37048" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-37048-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><pre><code>I think the slow performance is caused by the fact that the SSH server seems to be running in a virtual machine and doesn&#39;t get dispatched fast enough (at 28ms intervals).  
The TSVAL at the server increments at 1ms intervals and jumps in the TSVAL go together with a high RTT, so the latency is imposed by the server itself.  
For that high latency the number of bytes in flight is certainly not enough to achieve a satisfying throughput. This is probably due to the congestion window shrinking at the client because of the retransmissions. 
My bet is that the missing packets are dropped in the VM itself and not in the network.</code></pre><hr /><p>After looking at the traces in the Juniper I must correct my statement.<br />
The packets are dropped in the Juniper()==VPN==()Juniper tunnel, obviously when there are more than 10-12 packets sent in a single batch (due to increasing windowsizes)<br />
The delay of 28 ms is caused by the WAN latency between the 2 Junipers.<br />
Notes to the example below:<br />
ip.id==0x2752 didn't make it to the server in this timeframe.<br />
ip.id==0x2747 and ip.id==0x2753 are delayed by 28 ms</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Screenshot.png" alt="alt text" /> I reduced the files based on ip_ids and uploaded an example here:</p><p><a href="https://www.cloudshark.org/captures/a43693daae83">https://www.cloudshark.org/captures/a43693daae83</a></p><p><a href="https://www.cloudshark.org/captures/cce154b812a1">https://www.cloudshark.org/captures/cce154b812a1</a></p><p>Regards Matthias</p><p><img src="https://www.cloudshark.org/captures/cce154b812a1" alt="alt text" /></p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>14 Oct '14, 22:34</strong></p><img src="https://secure.gravatar.com/avatar/5500bd1decb766660522dfb347eedc49?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde&#39;s gravatar image" /><p>mrEEde<br />
<span class="score" title="3892 reputation points"><span>3.9k</span></span><span title="15 badges"><span class="badge1">●</span><span class="badgecount">15</span></span><span title="22 badges"><span class="silver">●</span><span class="badgecount">22</span></span><span title="70 badges"><span class="bronze">●</span><span class="badgecount">70</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde has 48 accepted answers">20%</span> </br></br></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 16 Oct '14, 04:17</p></div></div><div id="comments-container-37048" class="comments-container"><span id="37066"></span><div id="comment-37066" class="comment"><div id="post-37066-score" class="comment-score"></div><div class="comment-text"><p>Thanks for the feedback Matthias, I have to dig into that a bit more. So the diagram above is the dst, so we are looking at timestamp values on return packets from the dst to the source? Just to note the 10.235 source is in a different state than the 10.240.</p><p>I also see tsval increases from the local src ranging from 1ms up to ~30ms and higher...</p><p>25 2014-10-14 11:50:44.926938 10.235.3.53 203509526 10.240.44.9 SSH 1438 Client: Encrypted packet (len=1368)</p><p>27 2014-10-14 11:50:44.955379 10.235.3.53 203509555 10.240.44.9 SSH 1438 Client: Encrypted packet (len=1368)</p><p>Are we saying that the src sending machine simply isn't sending the data quick enough?</p><p>Thanks, this is great discussion for me!</p></div><div id="comment-37066-info" class="comment-info"><span class="comment-age">(15 Oct '14, 07:45)</span> parsonsproject</div></div><span id="37067"></span><div id="comment-37067" class="comment"><div id="post-37067-score" class="comment-score"></div><div class="comment-text"><p>I'm trying to say that from the capture point's view the receiving node at 10.204.44.9 is not sending ACKs quickly enough,</p></div><div id="comment-37067-info" class="comment-info"><span class="comment-age">(15 Oct '14, 07:51)</span> mrEEde</div></div><span id="37077"></span><div id="comment-37077" class="comment"><div id="post-37077-score" class="comment-score"></div><div class="comment-text"><p>What are you using for the tcp delta and RTT, in your custom column?</p></div><div id="comment-37077-info" class="comment-info"><span class="comment-age">(15 Oct '14, 09:37)</span> parsonsproject</div></div><span id="37083"></span><div id="comment-37083" class="comment"><div id="post-37083-score" class="comment-score"></div><div class="comment-text"><p>tcp.time_delta and tcp.analysis.ack_rtt are the two custom fields.</p></div><div id="comment-37083-info" class="comment-info"><span class="comment-age">(15 Oct '14, 12:14)</span> mrEEde</div></div><span id="37152"></span><div id="comment-37152" class="comment"><div id="post-37152-score" class="comment-score"></div><div class="comment-text"><p>I am refering to w-o.pcap(<a href="https://www.cloudshark.org/captures/c99c0a9518e2),Source">https://www.cloudshark.org/captures/c99c0a9518e2),Source</a> 10.235.3.53 sends 6 packets between 9-16 packet and received ack for each of them,slow start rule says we can increase our CWND by one MSS for each ack we received,if we follow this rule in next bunch source 10.235.3.53 should had sent the 12 packets but unfortunately it didn't.In next bunch source send only 7 packet 20-29.This pattern repeats itself.is it tcp or openssh application,who is restricting this ? I was looking at Hansang 2013 sharkfest presentation on slow ssh file transfer and there it was a problem with openssh application setting channel_session_windows_default.</p></div><div id="comment-37152-info" class="comment-info"><span class="comment-age">(18 Oct '14, 07:08)</span> kishan pandey</div></div></div><div id="comment-tools-37048" class="comment-tools"></div><div class="clear"></div><div id="comment-37048-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

