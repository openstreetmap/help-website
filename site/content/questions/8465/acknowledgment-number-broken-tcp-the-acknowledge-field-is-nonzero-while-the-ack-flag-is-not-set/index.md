+++
type = "question"
title = "Acknowledgment number: Broken TCP. The acknowledge field is nonzero while the ACK flag is not set"
description = '''Hi, We are currently having a recurring (and intermittent) problem with an in-house application connecting to a server sitting on our local network. The process works fine for a certain amount of time (sometimes hours, sometimes days - never more than 48 Hours) then suddenly starts failing - the app...'''
date = "2012-01-19T05:05:00Z"
lastmod = "2012-01-19T07:27:00Z"
weight = 8465
keywords = [ "nonzero", "brokentcp", "rst" ]
aliases = [ "/questions/8465" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Acknowledgment number: Broken TCP. The acknowledge field is nonzero while the ACK flag is not set](/questions/8465/acknowledgment-number-broken-tcp-the-acknowledge-field-is-nonzero-while-the-ack-flag-is-not-set)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-8465-score" class="post-score" title="current number of votes">1</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi,</p><p>We are currently having a recurring (and intermittent) problem with an in-house application connecting to a server sitting on our local network. The process works fine for a certain amount of time (sometimes hours, sometimes days - never more than 48 Hours) then suddenly starts failing - the application hosted on the workstation throwing error messages.</p><p>The "process" works as followed: - The client creates a TCP connection to a server on a specific port then passes some data through. - At the server level, there is an application listening to the specific port and uses the data to "do stuff". The application then shuts the TCP connection.</p><p>During normal operations, we see the following at network level:</p><ul><li>Client initiates a connection [SYN] to Server, seq=0</li><li>Server responds to Client [SYN, ACK], seq=0 Ack=1</li><li>Client responds to Server [ACK], seq=1, Ack=1</li><li>Client responds to Server [PSH, ACK] , seq=1 Ack=1</li><li>Server responds to Client [FIN, ACK], seq=1 Ack=32</li></ul><p>What we are seeing when the process fails is that the TCP connection is established between the client and the server but the server resets the connection [RST] prior to the [PSH, ACK] message coming through:</p><ul><li>Client initiates a connection [SYN] to Server, seq=0</li><li>Server responds to Client [SYN, ACK], seq=0 Ack=1</li><li>Client responds to Server [ACK], seq=1, Ack=1</li><li>Server responds to Client [RST], seq=1</li><li>Client responds to Server [PSH, ACK] , seq=1 Ack=1</li><li>Server responds to Client [RST], seq=1</li></ul><p>The [RST] message contains the following error description "Acknowledgment number: Broken TCP. The acknowledge field is nonzero while the ACK flag is not set"</p><p>Once this happens, the server effectively refuses any new connection on that specific port, regardless of the source. To work-around the problem, I have to change the application on the client level to use another port and set the "listener" on the server to listen to the new port.</p><p>We've already established that the [RST] is not triggered by the application as we don't see any connection being created at application level when the process is failing.</p><p>We've also established that all previous TCPconnections are being closed correctly by the server.</p><p>We've recently rebuilt the server with latest firmware and Windows Security Updates to see if it would fix the issue - no joy there.</p><p>The other interesting point is that we ran this process from another server for 2 weeks and did not have any issue - both servers were on the same Hardware / OS / Windows SU / Application version ... The difference is that they are sitting into 2 different offices (2 different VLAN's) - connecting via a WAN Link (Metro Ethernet).</p><p>I've gone through a series of websites about this problem but couldn't find anything relevant.</p><p>Could you please help identifying what is causing the server / network to "block" the port ? I really don't have any idea where to start.</p><p>Thanks.</p><p>CalaoSHP</p></div><div id="question-tags" class="tags-container tags">nonzero brokentcp rst</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>19 Jan '12, 05:05</strong></p><img src="https://secure.gravatar.com/avatar/d7a7c0810d5b291188b071de571c066c?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="CalaoSHP&#39;s gravatar image" /><p>CalaoSHP<br />
<span class="score" title="31 reputation points">31</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="CalaoSHP has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 19 Jan '12, 06:56</p></div></div><div id="comments-container-8465" class="comments-container"><span id="8467"></span><div id="comment-8467" class="comment"><div id="post-8467-score" class="comment-score"></div><div class="comment-text"><p>Good write up! Where are you taking the captures from? When you look at the captures of the failed transactions can you verify that the ACK flag is not set? Do other communications from the server still work? Does this application rely on the Windoze TCP stack, or does it have it's own implementation? Does the server's switchport show any interesting / unusual errors? Does simply killing/restarting the daemon process fix the problem? Is there any kind of firewall in place - either hardware or software on the server?</p></div><div id="comment-8467-info" class="comment-info"><span class="comment-age">(19 Jan '12, 06:03)</span> GeonJay</div></div><span id="8470"></span><div id="comment-8470" class="comment"><div id="post-8470-score" class="comment-score"></div><div class="comment-text"><p>RESPONSE PART 1</p><p>Hi GeonJay,</p><p>Thanks for replying so quickly - I'll do my best to answer your questions.</p><ol><li>The captures were taken from the server.</li><li>The ACK is set - this is no different from when it works.</li><li>Other communications to the server work fine - all except on the port used</li><li>I believe that the application relies on the Windows TCP stack (Windows 2003 R2 SP2)</li><li>I don't believe that the switchport is showing anything interesting / unusual ... I'll get the Network Engineers to monitor it though</li></ol></div><div id="comment-8470-info" class="comment-info"><span class="comment-age">(19 Jan '12, 07:50)</span> CalaoSHP</div></div><span id="8471"></span><div id="comment-8471" class="comment"><div id="post-8471-score" class="comment-score"></div><div class="comment-text"><p>REPONSE PART 2</p><ol><li>I actually don't kill the process as such, I just get it to listen to another port. When doing Netstat on the server you can still see the application listening to the previous port.</li><li>There is a Fortigate Firewall managing the WAN circuits but this problem is impacting all clients, including ones that are on the same LAN as the server.</li></ol><p>Looking forward to hearing from you.</p></div><div id="comment-8471-info" class="comment-info"><span class="comment-age">(19 Jan '12, 07:51)</span> CalaoSHP</div></div></div><div id="comment-tools-8465" class="comment-tools"></div><div class="clear"></div><div id="comment-8465-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="8468"></span>

<div id="answer-container-8468" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-8468-score" class="post-score" title="current number of votes">4</div></div></td><td><div class="item-right"><div class="answer-body"><p>First of all, I'm not sure that the message <strong>"Acknowledgment number: Broken TCP. The acknowledge field is nonzero while the ACK flag is not set"</strong> within the RST Paket is the actual cause of the connection failing, because the RST already is a result of that having happened, so I'd guess it's just a side effect.</p><p>More interesting is the reason why the server would suddenly refuse a session after it has already been established on the TCP level. I've seen this kind of thing to happen when an application decides that it doesn't like the client, for example because it's IP address isn't in the pool of allowed nodes and shuts it down right after the Three Way Handshake. In your case this should not be the reason, since I'm sure you'd already know if the application has a feature like that.</p><p>Since you said it happens after a while I'd start monitoring the concurrent session count, and try to find out if there is some kind of resource exhaustion taking place. You could either capture all connection until the problem shows up (which might be tons of data, and a lot of work to process), or maybe a simple <strong>netstat -an</strong> can help. It will tell you how many sessions there are, and since you tear down your "good" communication with FINs you might have a problem with too many TimeWait states still being kept. You might want to look into setting the <strong>tcptimedwaitdelay</strong> in the Windows Registry to the lowest possible value (30 seconds) - take a look at the "TCP/IP implementation details" from Microsoft technet for details.</p><p>The curious thing is that the three way handshake works, which it wouldn't in the first place if the port is not open and listened to by an application. The application learns about the new connection after the handshake is completed, and it looks to me like the application is saying "New Connection? Naw...", which results in the unfriendly "RST" paket going out when the application closes the socket.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>19 Jan '12, 07:27</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 19 Jan '12, 07:28</p></div></div><div id="comments-container-8468" class="comments-container"><span id="8472"></span><div id="comment-8472" class="comment"><div id="post-8472-score" class="comment-score"></div><div class="comment-text"><p>The "we use a different port" piece piques my interest. And you're right, the immediate RST looks like a firewall denying access. The servers are identical, but I wonder if their usage is identical.</p></div><div id="comment-8472-info" class="comment-info"><span class="comment-age">(19 Jan '12, 07:54)</span> GeonJay</div></div><span id="8473"></span><div id="comment-8473" class="comment not_top_scorer"><div id="post-8473-score" class="comment-score"></div><div class="comment-text"><p>Hi Jasper,</p><p>Thanks for your response - I know it's a bizarre behaviour - I've been on the case for a few months now and still nowhere on finding what is happening. Especially that the same application works on a different server with the same hardware / OS / application; but in a different office and on different VLAN.</p><p>We've monitored the concurrent sessions on that specific port but it hardly ever exceeds 30 - so we discounted that theory.</p><p>I hear what you're saying about the "New Connection? Nah..." but we don't even see the connection reaching the application.</p><p>Frustrating !</p></div><div id="comment-8473-info" class="comment-info"><span class="comment-age">(19 Jan '12, 08:04)</span> CalaoSHP</div></div><span id="8475"></span><div id="comment-8475" class="comment not_top_scorer"><div id="post-8475-score" class="comment-score"></div><div class="comment-text"><p>Hi GeonJay,</p><p>If it was Firewall related, wouldn't it only impact people going through the Firewall? Which is not the case here as people on the same LAN as the server (therefore not going through the Firewall) are also affected.</p><p>The server in the other office is a full backup of the first one - so once it is in use, it does everything that the primary server does.</p></div><div id="comment-8475-info" class="comment-info"><span class="comment-age">(19 Jan '12, 08:49)</span> CalaoSHP</div></div><span id="8477"></span><div id="comment-8477" class="comment"><div id="post-8477-score" class="comment-score">2</div><div class="comment-text"><p>The message "Acknowledgment number: Broken TCP, The acknowledge field is nonzero while the ACK flag is not set" can be regarded as cosmetic. Per the RFCs, any time the ACK flag is not set, the acknowledgment number field SHOULD BE set to zero, however, recent Windows versions don't bother to zero the acknowledgment number if the RST bit is set. As @Jasper says, this is a side effect, not a cause. This is not RFC-compliant behavior, but I've never seen it cause a problem.</p></div><div id="comment-8477-info" class="comment-info"><span class="comment-age">(19 Jan '12, 09:12)</span> Jim Aragon</div></div><span id="8480"></span><div id="comment-8480" class="comment not_top_scorer"><div id="post-8480-score" class="comment-score"></div><div class="comment-text"><p>@CalaoSHP: if the application doesn't get the connection but the TCP stack allows to create it in the first place I can only think of the Windows OS having some sort of trouble talking to the application. The OS has to know that the application has the port open, otherwise it wouldn't SYN/ACK at all. Looks like OS and Application have communication issues, especially if you say it keeps the old port open when you change it... By the way, what's the timing between SYN-SYN/ACK-ACK and the RST? Is there a delay, or is it instant?</p></div><div id="comment-8480-info" class="comment-info"><span class="comment-age">(19 Jan '12, 09:32)</span> Jasper ♦♦</div></div><span id="8481"></span><div id="comment-8481" class="comment"><div id="post-8481-score" class="comment-score">1</div><div class="comment-text"><p>One other thing that just came to mind - can you monitor the application ressource usage, maybe with Process Explorer? It is possible that the application has some sort of memory leak, increasing over time, and at some point when the failing connection comes in the application fails to allocate ressources for it so it gets dropped. A telltale sign could that the consumed memory goes up or stays the same, but never goes down. On a final note: I doubt you have a network issue here, it really looks like "OS vs. Application".</p></div><div id="comment-8481-info" class="comment-info"><span class="comment-age">(19 Jan '12, 09:35)</span> Jasper ♦♦</div></div><span id="8493"></span><div id="comment-8493" class="comment not_top_scorer"><div id="post-8493-score" class="comment-score"></div><div class="comment-text"><p>@Jasper - we're talking miliseconds between [SYN] - [SYN,ACK] - [ACK].</p></div><div id="comment-8493-info" class="comment-info"><span class="comment-age">(20 Jan '12, 01:18)</span> CalaoSHP</div></div><span id="8499"></span><div id="comment-8499" class="comment not_top_scorer"><div id="post-8499-score" class="comment-score"></div><div class="comment-text"><p>What about the RST? The Handshake isn't that interesting, but does the RST take a while, or is it just as fast?</p></div><div id="comment-8499-info" class="comment-info"><span class="comment-age">(20 Jan '12, 03:35)</span> Jasper ♦♦</div></div><span id="8505"></span><div id="comment-8505" class="comment not_top_scorer"><div id="post-8505-score" class="comment-score"></div><div class="comment-text"><p>@Jasper - the whole handshake takes miliseconds</p></div><div id="comment-8505-info" class="comment-info"><span class="comment-age">(20 Jan '12, 04:18)</span> CalaoSHP</div></div><span id="8506"></span><div id="comment-8506" class="comment not_top_scorer"><div id="post-8506-score" class="comment-score"></div><div class="comment-text"><p>Sorry - got my knickers in a twist ... the RST is also instant.</p></div><div id="comment-8506-info" class="comment-info"><span class="comment-age">(20 Jan '12, 04:32)</span> CalaoSHP</div></div><span id="8507"></span><div id="comment-8507" class="comment"><div id="post-8507-score" class="comment-score">1</div><div class="comment-text"><p>Okay... so I think you'll have to focus on troubleshooting the OS/Application parts on the bad server, or you could go for a differential analysis to see what the differences are between the bad and the good server. I doubt it's the VLAN or the physical location, but maybe stuff like concurrent sessions, requests per minute etc. which are different and give you a hint.</p></div><div id="comment-8507-info" class="comment-info"><span class="comment-age">(20 Jan '12, 04:38)</span> Jasper ♦♦</div></div><span id="8647"></span><div id="comment-8647" class="comment"><div id="post-8647-score" class="comment-score">2</div><div class="comment-text"><p>Hi,</p><p>I'm glad to say we found out what the problem was and fixed it :-) A little by accident I admit but it's now been working for 2 days without a glitch.</p><p>At the same time as troubleshooting this problem (port blocking / connection reset), we were also troubleshooting another one on the same server whereby processes were failing to initialise. The error message we were getting in the system event log was something like "Application Error : The application failed to initialize properly (0xc0000142)".</p><p>I then found this article <a href="http://support.microsoft.com/kb/824422" title="Link">http://support.microsoft.com/kb/824422</a> which suggested that the server was running out Desktop Heap Memory.</p><p>I applied the recommended changes (changing the registry value from 512 to 1024) and we've not had the problem since.</p><p>Conclusion: The O/S was not able to manage the non-interactive processes on the server, therefore rejecting new requests (RST - Acknowledgment number: Broken TCP. The acknowledge field is nonzero while the ACK flag is not set) which subsequently caused the port to be "corrupted".</p><p>If you want to monitor the Desktop Heap activity on your server, you can download the Desktop Heap Monitor tool from <a href="http://www.microsoft.com/download/en/confirmation.aspx?displayLang=en&amp;id=17782">http://www.microsoft.com/download/en/confirmation.aspx?displayLang=en&amp;id=17782</a> It's a little fiddly to install &amp; run but once installed you can get detailed information.</p><p>I hope this helps anybody with similar issues.</p><p>CalaoSHP</p></div><div id="comment-8647-info" class="comment-info"><span class="comment-age">(27 Jan '12, 02:41)</span> CalaoSHP</div></div></div><div id="comment-tools-8468" class="comment-tools"><span class="comments-showing"> showing 5 of 12 </span> <a href="#" class="show-all-comments-link">show 7 more comments</a></div><div class="clear"></div><div id="comment-8468-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

