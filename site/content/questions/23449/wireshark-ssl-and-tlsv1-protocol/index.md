+++
type = "question"
title = "Wireshark SSL and TLSv1 protocol"
description = '''Hello guys, I&#x27;m working on the issue with my Nagios server. Nagios monitoring was working fine, but for few days already I see these errors: &quot;CHECK_NRPE: Error - Could not complete SSL handshake. &quot; But theses error not consistent. So, first it gives this error, but after 5 minutes check became OK. S...'''
date = "2013-07-30T08:51:00Z"
lastmod = "2013-07-31T08:16:00Z"
weight = 23449
keywords = [ "ssl", "wireshark", "tlsv1" ]
aliases = [ "/questions/23449" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Wireshark SSL and TLSv1 protocol](/questions/23449/wireshark-ssl-and-tlsv1-protocol)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-23449-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-23449-score" class="post-score" title="current number of votes">0</div><span id="post-23449-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hello guys,</p><p>I'm working on the issue with my Nagios server. Nagios monitoring was working fine, but for few days already I see these errors:</p><p>"CHECK_NRPE: Error - Could not complete SSL handshake. " But theses error not consistent. So, first it gives this error, but after 5 minutes check became OK.</p><p>So, I check my configuration, but as no changes was made in last time, find no issues as well.</p><p>So I try to analyse Nagios traffic with Wireshark. Mostly it look ok for me, but I find strange thing - when Nagios try to establish SSL handshake it sends packet with protocol shows in Wireshark as "SSL". It receive no answer. Then after a minute it sends the same packet for SSL handshake, but with TLSv1 ptotocol. And then it works fine. <a href="http://piccy.info/view3/4921610/583ca764bdb98d778b0f605c3e0b3a22/orig/">http://piccy.info/view3/4921610/583ca764bdb98d778b0f605c3e0b3a22/orig/</a></p><p>So, question is - what is the difference between this SSL and TLSv1 protocols? As they look the same for me.</p><p><a href="http://www.cloudshark.org/captures/e957011a18ef">http://www.cloudshark.org/captures/e957011a18ef</a></p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-ssl" rel="tag" title="see questions tagged &#39;ssl&#39;">ssl</span> <span class="post-tag tag-link-wireshark" rel="tag" title="see questions tagged &#39;wireshark&#39;">wireshark</span> <span class="post-tag tag-link-tlsv1" rel="tag" title="see questions tagged &#39;tlsv1&#39;">tlsv1</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>30 Jul '13, 08:51</strong></p><img src="https://secure.gravatar.com/avatar/66025c5c90824d797445af9049474b81?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Macumazan&#39;s gravatar image" /><p><span>Macumazan</span><br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Macumazan has no accepted answers">0%</span></p></div></div><div id="comments-container-23449" class="comments-container"></div><div id="comment-tools-23449" class="comment-tools"></div><div class="clear"></div><div id="comment-23449-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="23458"></span>

<div id="answer-container-23458" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-23458-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-23458-score" class="post-score" title="current number of votes">0</div><span id="post-23458-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>The Client Hello is a TLS 1.0 handshake in both - tcp.stream eq 10 or tcp.stream eq 11 - connections.</p><p>The difference in the Protocol interpretation (SSL vs. TLSv1) is due to the fact that in stream 11 the negotiation does not complete and wireshark sets SSL in this case.</p><p>I extracted only the first 5 packets of tcp stream 10 and the Protocol field then changed to SSL also, when it was TLSv1 before with the full handshake.</p><p>So the real question is, why does the "server" send a FIN in the middle of the SSL handshake. Looking at the RTT and TTL it is probably NOT the real server but maybe the riverbed appliance, but this is just a guess.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>31 Jul '13, 00:05</strong></p><img src="https://secure.gravatar.com/avatar/d6607c3aca20db751d019d8bbd2da893?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde2&#39;s gravatar image" /><p><span>mrEEde2</span><br />
<span class="score" title="336 reputation points">336</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="14 badges"><span class="bronze">●</span><span class="badgecount">14</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde2 has 5 accepted answers">20%</span></p></div></div><div id="comments-container-23458" class="comments-container"><span id="23470"></span><div id="comment-23470" class="comment"><div id="post-23470-score" class="comment-score"></div><div class="comment-text"><p>Thank you for a great explanation.</p></div><div id="comment-23470-info" class="comment-info"><span class="comment-age">(31 Jul '13, 01:54)</span> <span class="comment-user userinfo">Macumazan</span></div></div></div><div id="comment-tools-23458" class="comment-tools"></div><div class="clear"></div><div id="comment-23458-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="23464"></span>

<div id="answer-container-23464" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-23464-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-23464-score" class="post-score" title="current number of votes">0</div><span id="post-23464-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>As <span>@mrEEde2</span> points out, the SSL version of the client hello is actually the same, it is the interpretation of Wireshark based on the rest of the session that makes it show SSL or TLSv1. So that is not the issue.</p><p>What I do see in your trace is that all traffic is sent to a TyanComp system with the mac address 00:e0:81:45:5c:a8 and that the return traffic either comes from a Cisco device with mac address 64:00:f1:c1:da:01 or from a Riverbed device with mac address 00:0e:b6:99:9e:e4. There is only one session that fails in the trace file. It is after a couple of sessions over the Cisco and before a couple of sessions over the Riverbed. As the Riverbed device is most likely a WAN optimizer, could it be that the tunnel to the remote location is flapping and that when Nagios polls while the tunnel is being rebuilt, the SSL session to the server 10.49.32.186 fails?</p><p>What is the LAN setup at the nagios side of the connection?</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>31 Jul '13, 01:38</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p><span>SYN-bit ♦♦</span><br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div></div><div id="comments-container-23464" class="comments-container"><span id="23471"></span><div id="comment-23471" class="comment"><div id="post-23471-score" class="comment-score"></div><div class="comment-text"><p>Thank you for the reply. Traffic from Nagios goes to the router. Router sends packets to the WAN provider router through the Riverbed hardware. The same setup on the other side of the WAN.</p><p>I don't think that tunnel to other location is flapping, but is there a way to check this? I have access to routers before the Riverbed, but WAN provider routers is not accessible for me.</p></div><div id="comment-23471-info" class="comment-info"><span class="comment-age">(31 Jul '13, 02:01)</span> <span class="comment-user userinfo">Macumazan</span></div></div><span id="23472"></span><div id="comment-23472" class="comment"><div id="post-23472-score" class="comment-score"></div><div class="comment-text"><p>As the return packets from the Riverbed in stream 11 have a ip.ttl of 64, it looks like the Riverbed is directly connected to (in the same vlan/ip-subnet as) the Nagios server. Are you sure it is <em>behind</em> the router with the TyanComp mac-address (as seen from the Nagios server)?</p><p>Can you identify all mac-addresses in the trace (TyanComp and Cisco) and tell me which device uses which mac-address? What does a traceroute from Nagios to the server show and what does a traceroute from the server to Nagios show? Are the routers redundant? What kind of first hop redundancy protocol do you use (HSRP, VRRP, etc)?</p></div><div id="comment-23472-info" class="comment-info"><span class="comment-age">(31 Jul '13, 02:18)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="23473"></span><div id="comment-23473" class="comment"><div id="post-23473-score" class="comment-score"></div><div class="comment-text"><p>So, network is look like this:</p><p>Nagios -&gt; Host with Linux as router(<em>) -&gt; HP switch -&gt; Riverbed hardware -&gt; Verizon router(</em>) -&gt; ... WAN ... -&gt; Verizon router -&gt; Riverbed hardware -&gt; HP switch -&gt; Linux host as router -&gt; Nagios client</p><p>Cisco is the Verizon router(<em>)<br />
TyanComp is Host with Linux as router(</em>)<br />
</p><p>Traceroute from Nagios:<br />
traceroute to 10.49.32.186 (10.49.32.186), 30 hops max, 40 byte packets<br />
1 10.32.240.92 0.197 ms 0.194 ms 0.191 ms -&gt; Linux router<br />
2 10.32.255.99 0.606 ms 0.605 ms 1.072 ms -&gt; Verizon router<br />
3 * 3.579 ms 3.587 ms 3.586 ms<br />
4 * 19.380 ms 19.384 ms 19.873 ms<br />
5 * 37.538 ms 37.776 ms 38.008 ms<br />
6 10.49.32.186 37.529 ms 37.382 ms 37.359 ms<br />
</p><p>Tracerouter from Nagios client:<br />
traceroute to 10.32.241.141 (10.32.241.141), 30 hops max, 40 byte packets<br />
1 10.49.32.202 0.081 ms 0.062 ms 0.063 ms<br />
2 10.49.47.99 1.229 ms 1.451 ms 1.467 ms<br />
3 * 15.417 ms 15.539 ms 15.446 ms<br />
4 * 38.673 ms 38.908 ms 38.912 ms<br />
5 * 34.135 ms 34.131 ms 34.355 ms<br />
6 10.32.241.141 37.851 ms 38.078 ms 38.076 ms<br />
</p><p>I think we don't use any redundancy protocols.</p></div><div id="comment-23473-info" class="comment-info"><span class="comment-age">(31 Jul '13, 03:54)</span> <span class="comment-user userinfo">Macumazan</span></div></div><span id="23474"></span><div id="comment-23474" class="comment"><div id="post-23474-score" class="comment-score"></div><div class="comment-text"><p>Is the Nagios host connected on the same HP switch? And is it on the same vlan as the Linux Router and the Riverbed?</p><p>What is the subnetmask used on the Nagios host, the linux router and the Verizon router? I suspect a subnet mask of 255.255.240.0, putting all devices in the same IP subnet and therefor creating asymetric routing. I bet step 5 in the reverse nagios trace was actually a response from the Verizon router (public interface).</p><p>Does the Verizon router point back to the Linux router (if it's subnet mask is smaller than 255.255.240.0)?</p><p>Regarding the flapping of the Riverbed tunnel, do you have access to the Riverbed device? Or can you contact someone with access to it to check whether there is anything in the logging at the times Nagios reports the server as down?</p></div><div id="comment-23474-info" class="comment-info"><span class="comment-age">(31 Jul '13, 04:11)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="23475"></span><div id="comment-23475" class="comment"><div id="post-23475-score" class="comment-score"></div><div class="comment-text"><p>Yes, vlan the same for them. Nagios connected to the same switch. Subnet mask is 255.255.240.0, yes. 5 step is Verizon router. It point to the Linux router.</p><p>Yes, I find that when Nagios show this error, Riverbed gives the error as well:</p><p>[io/inner/prod.ERR] 128089795 {10.32.241.141:60513 10.49.32.192:5666} Err while reading: Connection reset by peer</p><p>It's other host with the same error from today.</p></div><div id="comment-23475-info" class="comment-info"><span class="comment-age">(31 Jul '13, 04:30)</span> <span class="comment-user userinfo">Macumazan</span></div></div><span id="23476"></span><div id="comment-23476" class="comment not_top_scorer"><div id="post-23476-score" class="comment-score"></div><div class="comment-text"><p>OK, that indeed explains the asymmetric routing seen in the tracefile, as the verizon host is in the same subnet as the Nagios host it will send the return traffic straight to the Nagios host instead of the Linux router.</p><p>Although the reason for this design is not clear to me, I don't think it is the reason for the failing connections. It would be interesting to see a packet capture made on the Riverbed when this problem occurs. On both the inside interface (connected to the switch) and the outside interface (connected to the Verizon router).</p><p>I still suspect the Riverbed tunnel as the response time for the FIN after the Client Hello is ~11 ms, while the RTT in the 3-way-handshake was ~45 ms. This means the Riverbed must have decided to send the FIN without waiting on the response to the ClientHello from the other side.</p><p>Did you also make a packet capture on the remote side? It would be interesting to see what is seen on the network there (preferably also before and after the riverbed device).</p></div><div id="comment-23476-info" class="comment-info"><span class="comment-age">(31 Jul '13, 05:09)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="23478"></span><div id="comment-23478" class="comment not_top_scorer"><div id="post-23478-score" class="comment-score"></div><div class="comment-text"><p>I think I found what was the cause -&gt; Riverbed hardware. So after I check logs from Riverbed I find that it gives these type of errors sometime:</p><p>[admission_control.NOTICE] - {- -} Connection limit achieved. Total Connections 611,Branched Warmed Connections 0<br />
Jul 31 15:37:38 sport[7943]: [admission_control.WARN] - {- -} Pausing intercept: Connection limit achieved;<br />
Jul 31 15:37:38 sport[7943]: [admission_control.NOTICE] - {- -} Memory Usage: 1341 Current Connections: 611 TCP Memory Usage: 114;<br />
</p><p>So looks like we have a limits of optimize connections - 611. I put Nagios server to passthrough the optimize tunnel - don't see any ssl issues for now.</p><p>I will check this until tomorrow to see if issue is fixed.</p><p>It was very nice of you to help me figure this out! It was like a lesson and vector to point me where I need to develop my network debugging skills :)</p></div><div id="comment-23478-info" class="comment-info"><span class="comment-age">(31 Jul '13, 08:16)</span> <span class="comment-user userinfo">Macumazan</span></div></div></div><div id="comment-tools-23464" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-23464-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

