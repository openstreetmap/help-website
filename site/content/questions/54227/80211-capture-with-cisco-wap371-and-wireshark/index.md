+++
type = "question"
title = "802.11 Capture with Cisco WAP371 and Wireshark"
description = '''Hi this is my first post to the forum. I recently bought a Cisco WAP371 to use as an 802.11ac packet capture device. I have it set up to operate on the 5GHz radio only with channel 48 as the primary channel and have selected 80 MHz channel width. There are no wireless clients associated with the WAP...'''
date = "2016-07-21T09:58:00Z"
lastmod = "2016-08-17T15:23:00Z"
weight = 54227
keywords = [ "wap371", "802.11ac" ]
aliases = [ "/questions/54227" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [802.11 Capture with Cisco WAP371 and Wireshark](/questions/54227/80211-capture-with-cisco-wap371-and-wireshark)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54227-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54227-score" class="post-score" title="current number of votes">0</div><span id="post-54227-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi</p><p>this is my first post to the forum. I recently bought a Cisco WAP371 to use as an 802.11ac packet capture device. I have it set up to operate on the 5GHz radio only with channel 48 as the primary channel and have selected 80 MHz channel width. There are no wireless clients associated with the WAP and I use my laptop connected to it via Ethernet to turn packet capture on and off.</p><p>I have been experimenting with capturing packets between my desktop computer which has a Netgear A6210 802.11ac client adapter and my home wireless router which is a Netgear R7000 running Asuswrt-Merlin firmware (also set up for channel 48 @80MHz channel width).</p><p>I download the captured trace files to my computer to examine with Wireshark (I have the latest version installed).</p><p>For the most part it works well and as expected but I do have a few observations/questions that I would like to ask.</p><ol><li><p>Even though I am on a 5GHz radio channel the information in the Radiotap header always shows, under channel flags, that it is operating in the 2GHz spectrum. The channel flag for 5GHz is always off. Any idea why?</p></li><li><p>Similarly, when looking at the captured 802.11 radio information the PHY type always shows 802.11g (6) - why not 802.11ac?</p></li><li><p>Most of the captured Management frames (e.g., Beacons, Probe Requests etc) appear as Malformed packets. It appears that the FCS field at the end of these packets is not treated as FCS but rather an extension of the management frame data - hence the malformation. Is this a known issue with the WAP371 packet capture? (In the radiotap flags section FCS at end is always false).</p></li><li><p>If I run a speedtest from my computer and capture the packets I never see a data packet with a Tx rate greater than 106Mb/s. The vast majority being 84Mb/s. However the results of the speedtest says I am getting &gt;150Mb/s download. The WAP371 is situated close to my client adapter. Captured RSSI for the client is -37dBm and for the AP -46dBm. Noise level is -92dBm. There are no other AP's or clients on the channel. I would have expected to see faster Tx rates. Are there any known issues with the Tx rate capture?</p></li></ol><p>Thanks in advance for any guidance or insights anyone can give me.</p><p>Regards</p><p>Mike</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-wap371" rel="tag" title="see questions tagged &#39;wap371&#39;">wap371</span> <span class="post-tag tag-link-802.11ac" rel="tag" title="see questions tagged &#39;802.11ac&#39;">802.11ac</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>21 Jul '16, 09:58</strong></p><img src="https://secure.gravatar.com/avatar/60a024354df9603f8ef6831db16c4c60?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="GromitD90&#39;s gravatar image" /><p><span>GromitD90</span><br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="GromitD90 has no accepted answers">0%</span></p></div></div><div id="comments-container-54227" class="comments-container"><span id="54246"></span><div id="comment-54246" class="comment"><div id="post-54246-score" class="comment-score"></div><div class="comment-text"><p>1) If you read the capture into Wireshark, and open up the capture file properties window (Statistics -&gt; Capture File Properties in the Qt version, Statistics -&gt; Summary in the GTK+ version), there will be a list of interfaces, which should have one entry - what does it say in the "Link type" column?</p><p>2) What version of Wireshark are you running?</p></div><div id="comment-54246-info" class="comment-info"><span class="comment-age">(22 Jul '16, 19:28)</span> <span class="comment-user userinfo">Guy Harris ♦♦</span></div></div><span id="54250"></span><div id="comment-54250" class="comment"><div id="post-54250-score" class="comment-score"></div><div class="comment-text"><p>Guy - thanks for responding.</p><ol><li>The link type is showing up as Ethernet so I assume that's not what I want -:). Do I need to change that - if so how is it done?</li><li>I am running the Qt version 2.0.4</li></ol><p>Mike</p></div><div id="comment-54250-info" class="comment-info"><span class="comment-age">(23 Jul '16, 08:43)</span> <span class="comment-user userinfo">GromitD90</span></div></div><span id="54252"></span><div id="comment-54252" class="comment"><div id="post-54252-score" class="comment-score"></div><div class="comment-text"><p>Guy - sorry I was looking at a different pcap file. The ones captured from the WAP371 show a link type of IEEE 802.11 plus radiotap header. Which makes more sense.</p></div><div id="comment-54252-info" class="comment-info"><span class="comment-age">(23 Jul '16, 08:51)</span> <span class="comment-user userinfo">GromitD90</span></div></div></div><div id="comment-tools-54227" class="comment-tools"></div><div class="clear"></div><div id="comment-54227-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="54925"></span>

<div id="answer-container-54925" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54925-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54925-score" class="post-score" title="current number of votes">1</div><span id="post-54925-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Ah Hi Mike, looks like we're trying to do the same thing :)</p><p>Please see <a href="https://www.wireshark.org/lists/wireshark-users/201505/msg00002.html">https://www.wireshark.org/lists/wireshark-users/201505/msg00002.html</a> and <a href="https://supportforums.cisco.com/discussion/12490711/wap371-firmware-v1123-packet-capture-missing-packets-and-2-other-bugs">https://supportforums.cisco.com/discussion/12490711/wap371-firmware-v1123-packet-capture-missing-packets-and-2-other-bugs</a> and <a href="https://supportforums.cisco.com/discussion/13080401/wap371-packet-capture-questions">https://supportforums.cisco.com/discussion/13080401/wap371-packet-capture-questions</a></p><p>Unfortunately after pursuing with Cisco they ultimately declared that it's only supposed to be used for sampling and not a full capture and that it was down to hardware limitations.</p><p>I have a WAP571 now and am receiving the same error as you, so either a subsequent firmware update has totally bricked the Wireshark interoperability.. or a new Wireshark has.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>17 Aug '16, 12:15</strong></p><img src="https://secure.gravatar.com/avatar/d97559d5a31cc1f74bd63a10430f210b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="matthew1471&#39;s gravatar image" /><p><span>matthew1471</span><br />
<span class="score" title="16 reputation points">16</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="matthew1471 has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>17 Aug '16, 12:46</strong> </span></p></div></div><div id="comments-container-54925" class="comments-container"><span id="54930"></span><div id="comment-54930" class="comment"><div id="post-54930-score" class="comment-score"></div><div class="comment-text"><p>Matthew</p><p>thanks so much for responding here. I've been pulling my hair out trying to figure this out. My issue has not been packet loss. I bought the WAP371 specifically to do 802.11ac packet capture so I'm a little disappointed that Cisco are now saying that it's not up to the task.</p><p>I have been using the procedure where packets are captured locally on the WAP and then transferred the pcap file for later analysis by Wireshark. I have also used a different analysis program and that also showed up the same issues - so in my case this is not a Wireshark issue at all. Seems to be a failure of the packet capture feature of the WAP to correctly interpret the radiotap information.</p><p>Is this what is happening with the 571 too?</p><p>Mike</p></div><div id="comment-54930-info" class="comment-info"><span class="comment-age">(17 Aug '16, 15:23)</span> <span class="comment-user userinfo">GromitD90</span></div></div></div><div id="comment-tools-54925" class="comment-tools"></div><div class="clear"></div><div id="comment-54925-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="54254"></span>

<div id="answer-container-54254" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54254-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54254-score" class="post-score" title="current number of votes">0</div><span id="post-54254-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I am not familiar with this particular Cisco device, but other devices they have include similar functionality.<br />
</p><p>Looking at the <a href="http://www.cisco.com/c/dam/en/us/td/docs/wireless/access_point/csbap/wap371/administration/guide/1_0_0_10/1CSWAP371-SWUM100_1_0_0_10.pdf">user guide</a>, you have to select the correct interface to capture on - and since this is both a 2.4/5GHz device, it has two radios. Which one did you choose, and did you try the other one?</p><ul><li>Configure these parameters:</li><li>Capture Interface—Enter a capture interface type for packet capture:</li><li>radio1—802.11 traffic on the radio interface Radio 1.</li><li>radio2—802.11 traffic on Radio 2</li></ul><p>From the document,<br />
</p><blockquote><blockquote><p>The default value of Mode is 802.11a/n/ac for Radio 1 and 802.11b/g/n for Radio 2</p></blockquote></blockquote><p>I think you want to capture on Radio 1. Radio 2 is 2.4GHz. If you have selected and accepted capture on Radio 1, try Radio 2. If the issue continues, provide a short capture with some captured beacons from each radio setting. The HT and VHT info IEs in the beacons indicate which channels are in use (base and extension channels, if any). It will be interesting to see how that matches up with what might be indicated in the radiotap header, as it relates to your configuration of the AP device.</p><p>Your points 1 &amp; 2 are consistent with not capturing on 5GHz, as just described. Try changing the config and see what happens. I am not sure about point 3 with wrong FCS - I have no idea what the Cisco will do with FCS. Attach a short capture if you want us to take a look - also check the 802.11 preferences for an assume/validate FCS options. Toggling these may change the behavior and may make the 'view' more palatable.<br />
</p><p>For point 4, if you are capturing on 2.4GHz but transferring test data on 5GHz, there is absolutely no relationship between the packet capture and the physical environment. The rates you are seeing are representative of something, but it's unknown and not your test. Are you sure your test traffic is 5GHz? Verification is possible by matching MAC addresses and BSSIDs in the trace, and those frames are the ones that you want to evaluate for rates and other performance parameters.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>23 Jul '16, 10:29</strong></p><img src="https://secure.gravatar.com/avatar/0a47ef51dd9c9996d194a4983295f5a4?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Bob%20Jones&#39;s gravatar image" /><p><span>Bob Jones</span><br />
<span class="score" title="1014 reputation points"><span>1.0k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="15 badges"><span class="bronze">●</span><span class="badgecount">15</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Bob Jones has 19 accepted answers">21%</span> </br></br></p></div></div><div id="comments-container-54254" class="comments-container"></div><div id="comment-tools-54254" class="comment-tools"></div><div class="clear"></div><div id="comment-54254-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="54260"></span>

<div id="answer-container-54260" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54260-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54260-score" class="post-score" title="current number of votes">0</div><span id="post-54260-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>OK, good, radiotap <em>is</em> capable of 1) reporting the 5 GHz channel, 2) reporting 11ac information, 3) indicating whether the FCS is present.</p><p>Therefore:</p><blockquote><p>Even though I am on a 5GHz radio channel the information in the Radiotap header always shows, under channel flags, that it is operating in the 2GHz spectrum. The channel flag for 5GHz is always off. Any idea why?</p></blockquote><p>Either you're not capturing on a 2.4 GHz channel or Cisco's not properly filling in the radiotap header. Check out Bob Jones' answer first and, if you're <em>certain</em> you're capturing on the 5 GHz channel, report this to Cisco as a bug.</p><blockquote><p>Similarly, when looking at the captured 802.11 radio information the PHY type always shows 802.11g (6) - why not 802.11ac?</p></blockquote><p>Either it's not an 11ac frame or Cisco's not providing a VHT field in the radiotap header. If you're <em>certain</em> that the frames in question are 11ac frames, report this to Cisco as a bug. (Beacons, obviously, won't be 11ac frames - they're typically 11b frames, so all machines can see them.)</p><blockquote><p>Most of the captured Management frames (e.g., Beacons, Probe Requests etc) appear as Malformed packets. It appears that the FCS field at the end of these packets is not treated as FCS but rather an extension of the management frame data - hence the malformation. Is this a known issue with the WAP371 packet capture? (In the radiotap flags section FCS at end is always false).</p></blockquote><p>If the frames include an FCS at the end, and the WAP371 doesn't set the "FCS at end" flag, report that to Cisco as a bug.</p><blockquote><p>If I run a speedtest from my computer and capture the packets I never see a data packet with a Tx rate greater than 106Mb/s</p></blockquote><p>Presumably by "Tx rate" you mean the data rate.</p><p>A radiotap header can include a data rate. It might not, in which case, if the frame is an HT frame (11n), Wireshark will calculate it based on the MCS, channel width, and guard interval length - for other frames, including VHT frames (11ac), Wireshark currently won't calculate the data rate. Do the frames with the lower data rates have a data rate field in the radiotap header? If so, and if it's lower than it should be, report that to Cisco as a bug. Otherwise, has Wireshark calculated the data rate (if it has, the entry in the radiotap header will be in square brackets, e.g. "[Data rate: 106 Mb/s]").</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>23 Jul '16, 17:44</strong></p><img src="https://secure.gravatar.com/avatar/f93de7000747ab5efb5acd3034b2ebd7?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Guy%20Harris&#39;s gravatar image" /><p><span>Guy Harris ♦♦</span><br />
<span class="score" title="17443 reputation points"><span>17.4k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="35 badges"><span class="silver">●</span><span class="badgecount">35</span></span><span title="196 badges"><span class="bronze">●</span><span class="badgecount">196</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Guy Harris has 216 accepted answers">19%</span> </br></p></div></div><div id="comments-container-54260" class="comments-container"><span id="54262"></span><div id="comment-54262" class="comment"><div id="post-54262-score" class="comment-score"></div><div class="comment-text"><p><span>@Guy</span>,</p><p>My version of Wireshark calculates and 802.11ac datarate properly (2.0.4-GTK / Linux):</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Header_ozJaTF6.png" alt="alt text" /> <img src="https://osqa-ask.wireshark.org/upfiles/mcsindex_qQ7HJub.png" alt="alt text" /></p></div><div id="comment-54262-info" class="comment-info"><span class="comment-age">(24 Jul '16, 01:00)</span> <span class="comment-user userinfo">Bob Jones</span></div></div><span id="54264"></span><div id="comment-54264" class="comment"><div id="post-54264-score" class="comment-score"></div><div class="comment-text"><p>Thanks again for the feedback. I can definitely confirm that my AP and client are both operating in the 5GHz part of the spectrum, the wireshark trace even lists the Channel Frequency as 5210 [A 42] on the captured packets. However the Radiotap header does not have the VHT info on any captured packets. I'll have to go back to the drawing board and play around with some other settings on the WAP371</p></div><div id="comment-54264-info" class="comment-info"><span class="comment-age">(24 Jul '16, 05:31)</span> <span class="comment-user userinfo">GromitD90</span></div></div><span id="54274"></span><div id="comment-54274" class="comment"><div id="post-54274-score" class="comment-score"></div><div class="comment-text"><p>I spent some more time on this and am convinced it is a Cisco issue. If I do A live Wireshark Capture on the Primary 802.11ac channel using an airpcap adapter I see all the VHT info and it says it is operating on 5G so my AP is sending out the right info. Of course I cannot see the data packets.</p><p>So I tried setting up to do a remote capture from the WAP371 to Wireshark to see if that worked. I can configure Wireshark to see the remote interfaces so there is communication between the devices but whenever select an interface and hit start I get an error message saying Error reading from pipe. This operation returned because the timeout period expired (error 1460).</p><p>What timeout is that? Can I increase it?</p></div><div id="comment-54274-info" class="comment-info"><span class="comment-age">(24 Jul '16, 13:59)</span> <span class="comment-user userinfo">GromitD90</span></div></div><span id="54275"></span><div id="comment-54275" class="comment"><div id="post-54275-score" class="comment-score"></div><div class="comment-text"><blockquote><blockquote><p>If I do A live Wireshark Capture on the Primary 802.11ac channel using an airpcap adapter I see all the VHT info</p></blockquote></blockquote><p>This is not consistent with what I thought your issue is. Where do you see the VHT info now? You can't see VHT info in a radiotap header with an AirPcap (assuming the NX, since it supports 2.4 &amp; 5, while the AirPcap only support 2.4GHz). You should see some VHT info in the beacons as IEs, but not in the radiotap header. To actually prove you have 802.11ac frames, you need to see something like I have shown in the radiotap header. Only data frames will be at ac rates; CTS/RTS, probes, beacons, Block ACKs, etc., will be at much lower 802.11a rates.</p><p>So in the Cisco case, you seem to be looking in the radiotap header and don't see what you need. Sometimes you see 2.4GHz, sometimes 5GHz, maybe. Example</p><blockquote><blockquote><p>the wireshark trace even lists the Channel Frequency as 5210 [A 42] on the captured packets</p></blockquote></blockquote><p>compared to</p><blockquote><blockquote><p>Even though I am on a 5GHz radio channel the information in the Radiotap header always shows, under channel flags, that it is operating in the 2GHz spectrum. The channel flag for 5GHz is always off. Any idea why?</p></blockquote></blockquote><p>Frankly, I have no idea what you are or are not seeing. There might be Cisco bugs here, but I am not convinced.</p></div><div id="comment-54275-info" class="comment-info"><span class="comment-age">(24 Jul '16, 14:21)</span> <span class="comment-user userinfo">Bob Jones</span></div></div><span id="54277"></span><div id="comment-54277" class="comment"><div id="post-54277-score" class="comment-score"></div><div class="comment-text"><blockquote><p>There might be Cisco bugs here, but I am not convinced.</p></blockquote><p>I'm pretty much convinced there is at least one Cisco bug:</p><blockquote><p>Most of the captured Management frames (e.g., Beacons, Probe Requests etc) appear as Malformed packets. It appears that the FCS field at the end of these packets is not treated as FCS but rather an extension of the management frame data - hence the malformation. Is this a known issue with the WAP371 packet capture? (In the radiotap flags section FCS at end is always false).</p></blockquote><p>There might, or might not, be more.</p></div><div id="comment-54277-info" class="comment-info"><span class="comment-age">(24 Jul '16, 14:38)</span> <span class="comment-user userinfo">Guy Harris ♦♦</span></div></div></div><div id="comment-tools-54260" class="comment-tools"></div><div class="clear"></div><div id="comment-54260-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

