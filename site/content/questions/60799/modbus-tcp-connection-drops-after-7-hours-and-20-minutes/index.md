+++
type = "question"
title = "Modbus TCP connection drops after 7 hours and 20 minutes"
description = '''VMware ESXi 5.5 Windows Server 2012 connected via VLAN with 3 hops (Cisco switches) to Modbus TCP Devices: Advantech ADAM-5000/TCP (x5) Advantech ADAM-6260 TCP. (x1) The devices can be polled using the Advantech ADAM/Apax.net utility version 2.05.10. I&#x27;m running Wonderware System Platform 2014 R2 SP...'''
date = "2017-04-13T03:47:00Z"
lastmod = "2017-04-14T05:32:00Z"
weight = 60799
keywords = [ "modbus", "ack", "fin", "tcp", "rst" ]
aliases = [ "/questions/60799" ]
osqa_answers = 1
osqa_accepted = true
+++

<div class="headNormal">

# [Modbus TCP connection drops after 7 hours and 20 minutes](/questions/60799/modbus-tcp-connection-drops-after-7-hours-and-20-minutes)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-60799-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-60799-score" class="post-score" title="current number of votes">1</div><span id="post-60799-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>VMware ESXi 5.5 Windows Server 2012 connected via VLAN with 3 hops (Cisco switches) to Modbus TCP Devices:</p><p>Advantech ADAM-5000/TCP (x5) Advantech ADAM-6260 TCP. (x1)</p><p>The devices can be polled using the Advantech ADAM/Apax.net utility version 2.05.10.</p><p>I'm running Wonderware System Platform 2014 R2 SP1 as the SCADA with DASMBTCP Version 3.0.1 Data Acquisition Server.</p><p>The ADAM-6260 device is rock solid and never loses connection.</p><p>The ADAM-5000/TCP devices all drop connection via port502 after 7 hours 20 minutes of stable operation.</p><p>Pinging the devices is always possible, even after the Modbus TCP port closes.</p><p>A physical reset of the ADAM5000 brings the device back to life.</p><p>If I connect a Win7 laptop to the Server switch and route through the VLAN to the ADAM 5000, connection is rock solid.</p><p>If I connect a Win7 laptop to the ADAM 5000 via cross-over cable the connection is rock solid.</p><p>As soon as the device is connected and polled from the VMWare Windows Server 2012, the Modbus TCP fails after 7 hours and 20 minutes.</p><p>I've tried using a Telnet client but Port 502 is definitely closed.</p><p>The Advantech Utility error message is "Connect Module Failed! Reached maximum number of connections"</p><p>The issue seems to be independent of the Wonderware DA Server or the Advantech ADAM/Apax.net Utility because when both are disabled / not polling the devices still drop out after the 7hrs20mins.</p><p>The ADAM6260 is solid and Advantech support put this down to a function / feature called "Host Idle Timeout". This is not available on the ADAM5000, although I have requested it.</p><p>The table below should help guide through the Wireshark log</p><ul><li>IP Source - 123.111.4.101</li><li>IP Dest - 123.111.4.10</li><li>Device ADAM 5000L TCP</li><li>Source Port before drop out 53609</li><li>Source Port after drop out 61587</li><li><p>Time in wireshark log 16:04:51</p><p>55688 2017-04-12 16:04:01.496375 123.111.4.10 123.111.4.101 Modbus/TCP 79 Response: Trans: 1319; Unit: 1, Func: 3: Read Holding Registers<br />
55726 2017-04-12 16:04:01.557603 123.111.4.101 123.111.4.10 TCP 54 53609 → 502 [ACK] Seq=469 Ack=976 Win=64867 Len=0<br />
57140 2017-04-12 16:04:11.495071 123.111.4.101 123.111.4.10 Modbus/TCP 66 Query: Trans: 1320; Unit: 1, Func: 3: Read Holding Registers<br />
57162 2017-04-12 16:04:11.616774 123.111.4.10 123.111.4.101 TCP 60 502 → 53609 [ACK] Seq=976 Ack=481 Win=2368 Len=0<br />
62801 2017-04-12 16:04:51.493880 123.111.4.101 123.111.4.10 TCP 54 53609 → 502 [FIN, ACK] Seq=481 Ack=976 Win=64867 Len=0<br />
62802 2017-04-12 16:04:51.494132 123.111.4.101 123.111.4.10 TCP 66 61582 → 502 [SYN, ECN, CWR] Seq=0 Win=8192 Len=0 MSS=1460 WS=256 SACK_PERM=1<br />
62803 2017-04-12 16:04:51.495346 123.111.4.10 123.111.4.101 TCP 60 502 → 53609 [ACK] Seq=976 Ack=482 Win=2367 Len=0<br />
62804 2017-04-12 16:04:51.496270 123.111.4.10 123.111.4.101 TCP 60 502 → 61582 [SYN, ACK] Seq=0 Ack=1 Win=2368 Len=0 MSS=528<br />
62805 2017-04-12 16:04:51.496303 123.111.4.101 123.111.4.10 TCP 54 61582 → 502 [ACK] Seq=1 Ack=1 Win=65392 Len=0<br />
62806 2017-04-12 16:04:51.496403 123.111.4.101 123.111.4.10 Modbus/TCP 66 Query: Trans: 1321; Unit: 1, Func: 3: Read Holding Registers<br />
62807 2017-04-12 16:04:51.497312 123.111.4.10 123.111.4.101 TCP 60 502 → 61582 [RST, ACK] Seq=1 Ack=1 Win=2368 Len=0<br />
62808 2017-04-12 16:04:51.498110 123.111.4.10 123.111.4.101 TCP 60 502 → 61582 [RST, ACK] Seq=1 Ack=13 Win=2368 Len=0<br />
64258 2017-04-12 16:05:01.493965 123.111.4.101 123.111.4.10 TCP 66 61587 → 502 [SYN, ECN, CWR] Seq=0 Win=8192 Len=0 MSS=1460 WS=256 SACK_PERM=1<br />
64259 2017-04-12 16:05:01.494879 123.111.4.10 123.111.4.101 TCP 60 502 → 61587 [SYN, ACK] Seq=0 Ack=1 Win=2368 Len=0 MSS=528<br />
</p></li></ul><p>I wanted to attach several screenshot of Packet Captures and upload a capture to Cloudshark but I'm unable to due to company policy and I'm unable to add files directly to this post.</p><p>Any Guidance or insights would be very much appreciated, I've been working on this issue for 6 weeks now. Many thanks in advance.</p><p>Chris Dell.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-modbus" rel="tag" title="see questions tagged &#39;modbus&#39;">modbus</span> <span class="post-tag tag-link-ack" rel="tag" title="see questions tagged &#39;ack&#39;">ack</span> <span class="post-tag tag-link-fin" rel="tag" title="see questions tagged &#39;fin&#39;">fin</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span> <span class="post-tag tag-link-rst" rel="tag" title="see questions tagged &#39;rst&#39;">rst</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>13 Apr '17, 03:47</strong></p><img src="https://secure.gravatar.com/avatar/e68368a38dcd75843db14f9d9e7f6e6b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="chrisdell&#39;s gravatar image" /><p><span>chrisdell</span><br />
<span class="score" title="26 reputation points">26</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="chrisdell has no accepted answers">0%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>13 Apr '17, 14:51</strong> </span></p></div></div><div id="comments-container-60799" class="comments-container"></div><div id="comment-tools-60799" class="comment-tools"></div><div class="clear"></div><div id="comment-60799-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="60800"></span>

<div id="answer-container-60800" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-60800-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-60800-score" class="post-score" title="current number of votes">2</div><span id="post-60800-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="chrisdell has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Working with the brief text excerpt of the capture I can see the following:</p><ul><li>In frame 57140 the master makes a slave query (from port 53609)</li><li>In frame 57162 the slave sends a TCP ack for the query segment</li><li>In frame 62801, 40 seconds after the query, the master closes the connection with a FIN, probably due to timeout for no slave reply.</li><li>In frame 62802 the master opens another connection (from port 61582).</li><li>In frame 62803 the slave acknowledges the FIN from 62801 but doesn't supply its own FIN keeping the connection alive.</li><li>In frame 62804 the slave responds to the SYN in frame 62802 with its own SYN.</li><li>In frame 62805 the master completes the 3-way handshake for the connection from port 61582.</li><li>In frame 62806 the master sends a query, presumably using the connection just established.</li><li>In frames 62807 &amp; 8 the slave sends TCP RST's for port 61582,thus closing the connection.</li><li>In frame 64258 the master attempts to open another connection (port 61587).</li><li>In frame 64259 the slave responds to the SYN in frame 64258 with its own SYN.</li></ul><p>In summary, the master sends a requests, the slave fails to respond, the master closes the connection, the slave fails to complete the connection close, the master successfully opens another connection and sends a query to which the slave hard-closes the connection.</p><p>Looks to me like an application issue on the slave.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>13 Apr '17, 05:22</strong></p><img src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="grahamb&#39;s gravatar image" /><p><span>grahamb ♦</span><br />
<span class="score" title="19834 reputation points"><span>19.8k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">●</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">●</span><span class="badgecount">206</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="grahamb has 274 accepted answers">22%</span> </br></br></p></div></div><div id="comments-container-60800" class="comments-container"><span id="60803"></span><div id="comment-60803" class="comment"><div id="post-60803-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your quick response Graham. I've tried to get the vendor to make a firmware change but so far I've hit resistance. If you don't mind I'm going to send your explanation to Advantech and see if they can make any firmware change.</p></div><div id="comment-60803-info" class="comment-info"><span class="comment-age">(13 Apr '17, 08:05)</span> <span class="comment-user userinfo">chrisdell</span></div></div><span id="60806"></span><div id="comment-60806" class="comment"><div id="post-60806-score" class="comment-score"></div><div class="comment-text"><p>Having access to the full capture would also enable analysis of other things such as multiple master connection attempts etc.</p><p>Personally I don't think there's any sensitive data in a Modbus capture, it's only register values. The exception is where multiple registers are used to return such things as strings, then there might be sensitive data. The IP addresses can be anonymized, but you've already shown those (although they might have been fuzzed).</p></div><div id="comment-60806-info" class="comment-info"><span class="comment-age">(13 Apr '17, 08:57)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="60820"></span><div id="comment-60820" class="comment"><div id="post-60820-score" class="comment-score"></div><div class="comment-text"><p>This afternoon I tried a Tofino Modbus Firewall between the network and the ADAM5000 and early tests are looking good. The units aren't pingable anymore but the Modbus traffic is steady. I'll know for sure over the weekend.</p></div><div id="comment-60820-info" class="comment-info"><span class="comment-age">(13 Apr '17, 13:34)</span> <span class="comment-user userinfo">chrisdell</span></div></div><span id="60822"></span><div id="comment-60822" class="comment"><div id="post-60822-score" class="comment-score"></div><div class="comment-text"><p>I missed the part in your question about it only being a problem when running in VMWare.</p><p>This implies that the VMWare solution is doing something different, in which case where are you capturing? If capturing on the VMWare guest or host you may not be seeing the "real" network traffic. Ideally capture with a tap or mirror or span port between the slave and it's switch.</p><p>As it works other than when under VMWare, it would seem that the different behaviour can only be seen by analysing the full captures. As your're unable to provide them, then you're on your own there.</p><p>The Modbus firewall must be subtly modifying the traffic in some way such that it doesn't trigger the abnormal slave behaviour. Again you'll need to analyse the captures (again at the slave side of the switch) to try and spot any differences.</p></div><div id="comment-60822-info" class="comment-info"><span class="comment-age">(13 Apr '17, 15:40)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="60829"></span><div id="comment-60829" class="comment"><div id="post-60829-score" class="comment-score"></div><div class="comment-text"><p>The unit in between the firewall device has been stable for over 16 hours now. I'm going to implement this as the solution. Further investigation will have to wait as the project has been on hold since I hit this issue over a month ago. Thanks for your input.</p></div><div id="comment-60829-info" class="comment-info"><span class="comment-age">(14 Apr '17, 02:49)</span> <span class="comment-user userinfo">chrisdell</span></div></div><span id="60832"></span><div id="comment-60832" class="comment not_top_scorer"><div id="post-60832-score" class="comment-score"></div><div class="comment-text"><p>I know that sometimes business needs preclude completing an investigation, but I'd still be concerned that the issue has been postponed and not actually fixed.</p></div><div id="comment-60832-info" class="comment-info"><span class="comment-age">(14 Apr '17, 05:32)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div></div><div id="comment-tools-60800" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-60800-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

