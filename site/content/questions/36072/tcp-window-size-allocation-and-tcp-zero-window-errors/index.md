+++
type = "question"
title = "TCP Window Size Allocation and TCP Zero Window Errors"
description = '''Greetings Everyone! My mind is about to explode as everyone is always blaming the network guys for disconnections and slowness in the networks, but Solarwinds Reports that all utilization in the network devices and links are Okay. So I tried sniffing then I got &quot;Zero Window&quot; errors. So If I may ask:...'''
date = "2014-09-08T07:26:00Z"
lastmod = "2014-09-08T07:48:00Z"
weight = 36072
keywords = [ "zero-window", "latency", "monitoring", "slowness", "wireshark" ]
aliases = [ "/questions/36072" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [TCP Window Size Allocation and TCP Zero Window Errors](/questions/36072/tcp-window-size-allocation-and-tcp-zero-window-errors)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-36072-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Greetings Everyone!</p><p>My mind is about to explode as everyone is always blaming the network guys for disconnections and slowness in the networks, but Solarwinds Reports that all utilization in the network devices and links are Okay. So I tried sniffing then I got "Zero Window" errors. So If I may ask:</p><p>1.) <strong>How is TCP Window Size Allocated?</strong> (Is it per TCP conversation like if you have 1 Application(Mozilla Firefox) and 5 tabs open, then the OS allocates Window Size per tab?)</p><p>2.) <strong>What causes and How do you fix a "TCP Zero - Window" issue?</strong> (The Stock Trading Server is the one who is having a hard time processing burst traffic and sending the TCP Zero window messages to the traders but based on the Network Utilization(CPU, Memory and Link Utilization of Network Devices) in Solarwinds and Performance Monitoring(CPU, Disk Space, Memory, NIC Utilization) in both the Stock Trading Server and Database Server, it shows that is <strong>Perfectly Normal</strong> <strong>and even under-utilized!</strong>.)</p><p>3.) <strong>Is it perhaps in the Trading Server's Settings? (32 GB Memory but only uses the default tcp window allocation size of 64 MB)</strong></p><p>4.) <strong>Or is there something wrong with how slow the Trading Application process the data?</strong> (I am planning to increase the TCP Buffer Size from 64KB to probably 256KB but it might not help if the the Trading Application Server itself process the data slowly.)</p><p>5.) <strong>Also, all the traders are experiencing "Unable to Connect to Trading Server" and "Intermittent Connections" errors.</strong> (but there's no report of network problem like "down links" or "fully utilized links". I've even tried to change the polling data to every 1 minute to capture short disconnections but I still see no problem) So I think that there might be a latency problem</p><p>6.) <strong>How do you measure Latency of Network Communication efficiently? What Free and Paid Software Solutions do you recommend?</strong> (Traceroute reports 4ms and even if i increase the ping packet to 1mb, it also shows 1-3ms delay so I don't think that's helpful)</p><p>7.) <strong>How do you sort out each TCP thread/conversations if the source port and destination port are the same and the data is encrypted?</strong> (Like if the Stock Trading Server and the SQL Server talks on the same port numbers but has multiple transactions going on.)</p><p>Sorry, I'm just new to the networking world so there are a lot of stuff I don't know and can't find in books and other resources. I think this kind of things are learned through experience so please share your wisdom.</p><p>Thank you and Have a Good Day! :)</p></div><div id="question-tags" class="tags-container tags">zero-window latency monitoring slowness wireshark</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>08 Sep '14, 07:26</strong></p><img src="https://secure.gravatar.com/avatar/baaa6678eb41fc5aa58992954bab2fc8?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Sharknado&#39;s gravatar image" /><p>Sharknado<br />
<span class="score" title="1 reputation points">1</span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Sharknado has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 08 Sep '14, 07:30</p></div></div><div id="comments-container-36072" class="comments-container"><span id="36074"></span><div id="comment-36074" class="comment"><div id="post-36074-score" class="comment-score"></div><div class="comment-text"><p>If I may say so:</p><p>It appears there are issues in a Production Trading system with with real $$$ impacts.</p><p>I would suggest strongly that one or more experts should be found (hired or whatever) who can do a complete analysis and recommend solutions.</p><p>IOW: "Do it yourself" is <em>not</em> a good approach. :)</p></div><div id="comment-36074-info" class="comment-info"><span class="comment-age">(08 Sep '14, 07:54)</span> Bill Meier ♦♦</div></div></div><div id="comment-tools-36072" class="comment-tools"></div><div class="clear"></div><div id="comment-36072-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="36073"></span>

<div id="answer-container-36073" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-36073-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p><strong>1.) How is TCP Window Size Allocated? (Is it per TCP conversation like if you have 1 application(Mozilla Firefox) and 5 tabs open, then the OS allocates Window Size per tab?)</strong></p><p>It is per TCP conversation. 10 conversations with a 64k window require 640k of RAM to store incoming segments. It is not allocated per Firefox tab, because if you open a web page in a tab that e.g. opens 5 connections (1 for the web page, 4 for some pictures) you may end up with 5 TCP connections. It depends on how the communication is performed - some web servers allow pulling all 5 elements (still as an example) in one session, others require the browser to open up a single one for each element.</p><p><strong>2.) What causes and How do you fix a "TCP Zero - Window" issue? (The Stock Trading Server is the one who is having a hard time processing burst traffic and sending the TCP Zero window messages to the traders but based on the Network Utilization(CPU, Memory and Link Utilization of Network Devices) in Solarwinds and Performance Monitoring(CPU, Disk Space, Memory, NIC Utilization) in both the Stock Trading Server and Database Server, it shows that is Perfectly Normal and even under-utilized!.)</strong></p><p>Zero Window means that the receiver of the packets waves a "white flag" towards the sender, telling it to stop sending because there is no more buffer space for incoming packets. This is in almost all cases a sign of the receiver being too slow to process the incoming packets in time. If performance monitoring on the receiver doesn't show any problems it is a bit hard to say why the Zero Window problem occurs, but you should try to update the NIC drivers, or change network cards. Things get really messy if the server is a VM - if so, please specify what kind of virtualization you're using.</p><p><strong>3.) Is it perhaps in the Trading Server's Settings? (32 GB Memory but only uses the default tcp window allocation size of 64 MB)</strong></p><p>It depends on the latency and bandwidth of the conversation. Generally, the higher the latency and the higher the bandwith on the link, the more window size you need. But if you're running into zero window problems more window will only delay the problem in most cases, but once zero window is happening it will often repeat to do so.</p><p><strong>4.) Or is there something wrong with how slow the Trading Application process the data? (I am planning to increase the TCP Buffer Size from 64KB to probably 256KB but it might not help if the Trading Server itself is slow.)</strong></p><p>Possible. Maybe the Trading Application is not reacting to the TCP stack offering more packets quickly enough. More memory could help, but also have the developers check if they can do anything to process new data coming from the stack faster. Maybe there aren't enough threats in use by the program.</p><p><strong>5.) Also, all the traders are experiencing "Unable to Connect to Trading Server" and "Intermittent Connections" errors. (but there's no report of network problem like "down links" or "fully utilized links". I've even tried to change the polling data to every 1 minute to capture short disconnections but I still see no problem) So I think that there might be a latency problem</strong></p><p>Latency as in timeouts? Often, if an application is swamped, it will not react to more TCP stack messages about nodes trying to connect. You should check if you see SYN - SYN/ACK messages, or if the stack doesn't react at all when a connection fails. It will tell you if the stack or the application is the problem - if you see a SYN/ACK as a reaction to the SYN from the client, the stack works.</p><p><strong>6.) How do you measure Latency of Network Communication efficiently? What Free and Paid Software Solutions do you recommend? (Traceroute reports 4ms and even if i increase the ping packet to 1mb, it also shows 1-3ms delay so I don't think that's helpful)</strong></p><p>Use Wireshark. Find the three way handshake and determine initial RTT from there. See <a href="http://blog.packet-foo.com/2014/07/determining-tcp-initial-round-trip-time/">http://blog.packet-foo.com/2014/07/determining-tcp-initial-round-trip-time/</a></p><p><strong>7.) How do you sort out each TCP thread/conversations if the source port and destination port are the same and the data is encrypted? (Like if the Stock Trading Server and the SQL Server talks on the same port numbers but has multiple transactions going on.)</strong></p><p>Source and destination port <strong>cannot</strong> be the same. The client selects a new source port for each TCP connection. If the Stock Trading Server connects to the SQL server with multiple TCP connections it will use a new source port each time. If a database connection only uses one TCP connection to issue multiple requests you need to treat them as separate requests/answer pairs by finding the request and determining the size of the answer. If there is encryption you're in trouble, because you'll have to decrypt the communication to see where the request/answer pairs begin and end. It usually better to turn of encryption for the duration of the analysis.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>08 Sep '14, 07:48</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-36073" class="comments-container"><span id="36075"></span><div id="comment-36075" class="comment"><div id="post-36075-score" class="comment-score"></div><div class="comment-text"><p>Hi Jasper!</p><p>Thank you and I appreciate that you replied to my inquiries.</p><p>1.) Thanks, now I understand that.</p><p>2.) Yes, it is under a Vsphere. I'm not on the Server Team but as far as I know, the Trading Application is under 1 VM and is using a Virtual NIC. The VSphere is connected to 4 different cisco switches but I only saw it using two of the switches. Also there might be resource sharing configured in case one VM needs more memory.</p><p>3.) True, increasing the window size might only delay the problem that's why I still haven't tried that.</p><p>4.) Well, the vendor for the Trading Application always claims that they have multiple clients and we are the only one who is having this issue. They also claim that it's because we don't have QoS implemented in our LAN and we don't have a separate physical network infrastructure for that certain application. So we really have to prove first that the problem is caused by the Application.</p><p>5.) Yes, the latency might be too high to the point that timeout happens. I never get to see the SYN Ack unless I see a "RST Flag" and I only see that once or twice a day and it doesn't happen everyday.</p><p>6.) Ok, I'll go ahead and check that.</p><p>7.) The port the sql server uses is always 1433(well because it's fixed) and the port used by the trading server is at 8693(made-up number) but they always use those 2 port numbers through the entire day, everyday. I think it's configured to be encrypted because it's all financial data so I don't think there's a way to decrypt that.</p><p>Thanks for all your help Jasper!</p></div><div id="comment-36075-info" class="comment-info"><span class="comment-age">(08 Sep '14, 08:12)</span> Sharknado</div></div><span id="36079"></span><div id="comment-36079" class="comment"><div id="post-36079-score" class="comment-score"></div><div class="comment-text"><p>First of all, a couple of things about how this Q&amp;A site works ;-)</p><ol><li>please use comments, not answers, if you reply</li><li>if you like something, vote it up (thumbs up button left to the answer)</li><li>if an answer helped, accept it (checkmark button)</li></ol><p>Now, to your points:</p><ol><li><p>have the VMware admins check if the VM uses VMXNET3 adapters. Most run VMs with emulated AMD or Intel cards - VMXNET adapters are way faster and may solve your problem. They do not work on all OSes, though, so have them check if it is an option</p></li><li><p>QoS will not help <strong>at all</strong> in Zero Windows situation. It is a host performance problem, not a latency/delay problem. Tell the vendor to understand Zero Window symptoms first before going through their excuse calendar ;-)</p></li><li><p>If you see a RST and not a SYN/ACK then the TCP stack on the server refuses further connections. Maybe the connection table is exhausted - you might want to do a capture at the server to find out how many concurrent connections can be establihsed before it refuses any more.</p></li><li><p>Sure, SQL uses 1433 for MS-SQL, and it should always be the same. If the trading server uses only one port as well it should only be one connection - otherwise Wireshark will diagnose "TCP Port Reused". If you don't see that message (check with filter "tcp.analysis.reused_ports") you don't have a problem like that.</p></li></ol></div><div id="comment-36079-info" class="comment-info"><span class="comment-age">(08 Sep '14, 08:23)</span> Jasper ♦♦</div></div><span id="36081"></span><div id="comment-36081" class="comment"><div id="post-36081-score" class="comment-score"></div><div class="comment-text"><p>1.) I'll ask them about that tomorrow. So can I get back to you on this? :)</p><p>2.) You're right. I'll construct a documented report regarding all my findings and slap it right to their faces the next time we meet.</p><p>3.) How can I see the number of concurrent connections if the trade server only uses 1 port number to converse with the database server throughout the day?</p><p>4.) I checked and I didn't see anything with the filter you posted so I don't think that's a problem.</p><p>Thanks again Jasper! :)</p></div><div id="comment-36081-info" class="comment-info"><span class="comment-age">(08 Sep '14, 08:39)</span> Sharknado</div></div><span id="36083"></span><div id="comment-36083" class="comment"><div id="post-36083-score" class="comment-score"></div><div class="comment-text"><ol><li>sure</li><li>open up the Conversation Statistics and select the TCP tab. Sort by IP addresses to find you application server. Check how many rows there are where it talks to the SQL IP. According to your assumption, there should be only one.</li></ol></div><div id="comment-36083-info" class="comment-info"><span class="comment-age">(08 Sep '14, 11:58)</span> Jasper ♦♦</div></div></div><div id="comment-tools-36073" class="comment-tools"></div><div class="clear"></div><div id="comment-36073-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

