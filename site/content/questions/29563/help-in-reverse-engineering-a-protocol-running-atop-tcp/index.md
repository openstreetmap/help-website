+++
type = "question"
title = "Help in reverse-engineering a protocol running atop TCP"
description = '''Hi all, I&#x27;m having an issue understanding how a program communicates with a device for sending table entries from a database. It can send thousands of entries but it will send them in blocks containing 16 table entries per block which, right now my data equals about 520 blocks before its done sendin...'''
date = "2014-02-08T22:53:00Z"
lastmod = "2014-02-13T00:56:00Z"
weight = 29563
keywords = [ "checksum", "packet", "crc" ]
aliases = [ "/questions/29563" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [Help in reverse-engineering a protocol running atop TCP](/questions/29563/help-in-reverse-engineering-a-protocol-running-atop-tcp)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-29563-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi all,</p><p>I'm having an issue understanding how a program communicates with a device for sending table entries from a database. It can send thousands of entries but it will send them in blocks containing 16 table entries per block which, right now my data equals about 520 blocks before its done sending data.<br />
</p><p>The problem I'm having is understanding how it verifies that the data in each block is correct (a checksum or crc?). After the TCP header of each block there's a sequence of bits that are the same in every block and I assume this sequence is telling the device it wants to send another block. Each block also ends the same, 2 octets that are always the same and then 2 octets that are different. The octets that are different is what has me stumped. If these final 16 bits are wrong then the device kills communication. I haven't been able to find anything on the internet regarding a checksum or crc that is placed at the end of the data section in a packet, all I've found info on is the checksum in the tcp header. I've ran brute force tools against many captured blocks of data without any luck of finding a crc polynomial.</p><p>Would anyone be able to help me out with this problem? Perhaps I'm missing something or just don't understand how data is sent. I'm pretty sure this data is being sent using a synchronous socket since it waits for a reply from the device before sending the next block. But outside of that I'm not sure if there's something in the code of the application and the device that uses a proprietary way of checking the data in the block or if this is something standard with device communication.</p><p>I am providing a link to download wireshark file. Each packet (from source IP 192.168.1.115) ends in 10 03 then the 2 octets I'm trying to "crack". Again, not sure if its some sort of checksum or crc.</p><p><a href="http://www.mediafire.com/download/mt3ph1dazlv44gr/help.pcapng">http://www.mediafire.com/download/mt3ph1dazlv44gr/help.pcapng</a></p><p>Thank you for any help, its greatly appreciated!</p></div><div id="question-tags" class="tags-container tags">checksum packet crc</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>08 Feb '14, 22:53</strong></p><img src="https://secure.gravatar.com/avatar/b31f8a25e65b77f3925b1fa825dbe336?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="dirtyrobinson&#39;s gravatar image" /><p>dirtyrobinson<br />
<span class="score" title="11 reputation points">11</span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="dirtyrobinson has no accepted answers">0%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 12 Feb '14, 20:22</p><img src="https://secure.gravatar.com/avatar/f93de7000747ab5efb5acd3034b2ebd7?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Guy%20Harris&#39;s gravatar image" /><p>Guy Harris ♦♦<br />
<span class="score" title="17443 reputation points"><span>17.4k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="35 badges"><span class="silver">●</span><span class="badgecount">35</span></span><span title="196 badges"><span class="bronze">●</span><span class="badgecount">196</span></span></p></div></div><div id="comments-container-29563" class="comments-container"><span id="29655"></span><div id="comment-29655" class="comment"><div id="post-29655-score" class="comment-score"></div><div class="comment-text"><p>I'll see if the company that made the software would share how to communicate with their device, thanks guys for looking at it. I appreciate it!</p><p>Jason</p></div><div id="comment-29655-info" class="comment-info"><span class="comment-age">(10 Feb '14, 14:44)</span> dirtyrobinson</div></div></div><div id="comment-tools-29563" class="comment-tools"></div><div class="clear"></div><div id="comment-29563-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="29573"></span>

<div id="answer-container-29573" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-29573-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>TCP has a checksum in the header that is used to verify integrity of the TCP header AND the TCP data section, so TCP itself takes care of the data block being correct (as much as you can do that with a 16 bit CRC, of course). Usually, data transported by TCP does not have an additional checksum in the data itself, because the segmentation process of TCP could cut it from the current packet and transmit it as first part of the next packet. If an application wants to put a specific checksum in a TCP packet data segment it must control the creation of the whole segment, which is a lot more complex than just sending the data and trusting on the CRC of TCP.</p><p>Now, if a communication using TCP as a transport protocol implements an additional checksum mechanism (like you assume to be the last 2 bytes of the payload) you need to have the specification of how the checksum is calculated. If you don't have that you can only guess or try to reverse engineer how it is calculated, but that may be a frustrating task. The only good thing is that you think that it is only 2 bytes long, which means that the calculation is probably a pretty simple algorithm. Keep in mind that you'll have to calculate the CRC on the data segment only, not the full packet, so you need to extract the data bytes after the TCP header and run your brute force tools on that.</p><p>So you should try to find the protocol specifications for the stuff that is transported after the TCP header. Since you already know some details about it (when you say there are 16 table entries per packet) you seem to have access to that.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>09 Feb '14, 03:23</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-29573" class="comments-container"><span id="29593"></span><div id="comment-29593" class="comment"><div id="post-29593-score" class="comment-score"></div><div class="comment-text"><p>What I don't have access to is the source code that explains how it splits everything, I just know that it takes a file in hex then splits it after every 1264 bits, it adds 16 bits of data before each block of the file is transmitted then it adds 4 bits at the end, since I don't have the source I don't know how its determining the final 2 bits. I can only decompile the app and watch the assembly code.<br />
</p><p>Are there any other options as to what those 2 bytes may be? I only know of 2 options, its either a checksum or a crc.</p></div><div id="comment-29593-info" class="comment-info"><span class="comment-age">(09 Feb '14, 23:00)</span> dirtyrobinson</div></div></div><div id="comment-tools-29573" class="comment-tools"></div><div class="clear"></div><div id="comment-29573-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="29618"></span>

<div id="answer-container-29618" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-29618-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>Are there any other options as to what those 2 bytes may be?</p></blockquote><p>could be anything.</p><blockquote><p>I only know of 2 options, its either a checksum or a crc.</p></blockquote><p>a crc is just an algorithm to implementat a checksum.</p><p>If you look thoroughly at the packets, you'll find a 'clear' structure</p><p>There is</p><ul><li>a record 'magic' number: 10 53 10 50 10 53 (wich is '.S.P.S' in ASCII)</li><li>there is (probably) a record start delimiter: 10 02</li><li>there is (probably) a record end delimiter: 10 03</li><li>there are some bytes that are unclear at the beginning, after the start delimiter</li><li>there are those two bytes at the end, probably some form of a checksum</li></ul><p>To sum it up: It's probably better to ask the vendor of the software about the structure of the data, unless you have much more data and a <strong>lot of time</strong> to analyze the data structure. If that later applies, you could try to 'brute force' the last two bytes, by trying several known checksum algorithms that produce a 16 bit output. <strong>However</strong> keep in mind, that the developer of the software might have created its own checksum algorithm. If that is the case, you will have no chance at all to figure out that algorithm, just by looking at the packet bytes.</p><p>So, again: It's probably better to ask the vendor of the software or to reverse engineer the software with a debugger/disassembler.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>10 Feb '14, 04:23</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p>edited 10 Feb '14, 15:09</p></div></div><div id="comments-container-29618" class="comments-container"><span id="29791"></span><div id="comment-29791" class="comment"><div id="post-29791-score" class="comment-score"></div><div class="comment-text"><p>The company that made the software is of no help, I was kind of expecting the response I got though. They would only share the function if there was a sales opportunity for them.</p></div><div id="comment-29791-info" class="comment-info"><span class="comment-age">(12 Feb '14, 13:36)</span> dirtyrobinson</div></div><span id="29792"></span><div id="comment-29792" class="comment"><div id="post-29792-score" class="comment-score"></div><div class="comment-text"><p>O.K. then tell them you will decide a 10 million deal, but only after you get the information you need :-))</p><p>BTW: why do you need that information? What are you trying to do?</p></div><div id="comment-29792-info" class="comment-info"><span class="comment-age">(12 Feb '14, 14:12)</span> Kurt Knochner ♦</div></div><span id="29793"></span><div id="comment-29793" class="comment"><div id="post-29793-score" class="comment-score"></div><div class="comment-text"><p>Its for my cash registers, the programs that can communicate with it lack "customability" when it comes to reports and inventory. The PC program creates files of the data from the register and the program I created can edit and pull data from the files created by the PC program. I'm getting tired of having to use the vendor's software to send information back to the register.<br />
</p><p>I matched my data with the streams created by the cash register and everything is an exact match except for whatever those final 2 bytes are.</p></div><div id="comment-29793-info" class="comment-info"><span class="comment-age">(12 Feb '14, 15:09)</span> dirtyrobinson</div></div><span id="29794"></span><div id="comment-29794" class="comment"><div id="post-29794-score" class="comment-score"></div><div class="comment-text"><p>Well, then I would take the debugger/disassembler approach.</p><p>What happens if you send data with the wrong 'checksum'?</p></div><div id="comment-29794-info" class="comment-info"><span class="comment-age">(12 Feb '14, 15:16)</span> Kurt Knochner ♦</div></div><span id="29796"></span><div id="comment-29796" class="comment"><div id="post-29796-score" class="comment-score"></div><div class="comment-text"><p>Is the software Java or .net based?</p></div><div id="comment-29796-info" class="comment-info"><span class="comment-age">(12 Feb '14, 15:25)</span> Kurt Knochner ♦</div></div><span id="29798"></span><div id="comment-29798" class="comment not_top_scorer"><div id="post-29798-score" class="comment-score"></div><div class="comment-text"><p>Can you post the software on dropbox?</p></div><div id="comment-29798-info" class="comment-info"><span class="comment-age">(12 Feb '14, 15:30)</span> Kurt Knochner ♦</div></div><span id="29800"></span><div id="comment-29800" class="comment not_top_scorer"><div id="post-29800-score" class="comment-score"></div><div class="comment-text"><p>No PM here, but if you click my name, you'll find my e-mail address.</p></div><div id="comment-29800-info" class="comment-info"><span class="comment-age">(12 Feb '14, 15:54)</span> Kurt Knochner ♦</div></div><span id="29807"></span><div id="comment-29807" class="comment not_top_scorer"><div id="post-29807-score" class="comment-score"></div><div class="comment-text"><p>crc16tbl is odd. That could be a sign for a mapping table for a 'custom' CRC16 code. If that is the case you need to analyze the code to reverse engineer their CRC16 algorithm and the table.</p></div><div id="comment-29807-info" class="comment-info"><span class="comment-age">(12 Feb '14, 17:01)</span> Kurt Knochner ♦</div></div><span id="29822"></span><div id="comment-29822" class="comment not_top_scorer"><div id="post-29822-score" class="comment-score"></div><div class="comment-text"><p>UPDATE: the OP has deleted some of his comments. As a result, my comments cannot be fully understood in the now void context :-(</p></div><div id="comment-29822-info" class="comment-info"><span class="comment-age">(13 Feb '14, 00:17)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-29618" class="comment-tools"><span class="comments-showing"> showing 5 of 9 </span> <a href="#" class="show-all-comments-link">show 4 more comments</a></div><div class="clear"></div><div id="comment-29618-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="29824"></span>

<div id="answer-container-29824" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-29824-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>If it's encrypted you do have a chance (in fact, you have a 100% chance if you handle it right): the key must reside somewhere on your computer. Just pop open your favorite debugger, watch for a bit (err, a hundred bytes or so I'd hope) of data to come in from a socket, set a watchpoint on that data, and look at the stack traces of things that access it. If you're really lucky, you might even see it get decrypted in place. If not, you'll probably pick up on the fact that they're using a standard encryption algorithm (they'd be fools not to from a theoretical security standpoint) either by looking at stack traces (if you're lucky) or by using one of the pf6x9j1 / S-box profilers out there (avoid the academic ones, most of them don't work without a lot of trouble). Many encryption algorithms use blocks of "standard data" that can be detected (these are the IVs / S-boxes), these are what you look for in the absence of other information. Whatever you find, google it, and try to override their encryption library to dump the data that's being encrypted/decrypted. From these dumps, <strong><a href="http://www.please.dont.spam.this.site">(PRODUCT SPAM REMOVED)</a></strong> should be relatively easy to see what's going on.</p><p>REing an encrypted session can be a lot of fun, but it requires skill with your debugger and lots of reading. It can be frustrating but you won't be sorry if you spend the time to learn how to do it :)</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>13 Feb '14, 00:56</strong></p><img src="https://secure.gravatar.com/avatar/c03f8825d72ddaaecb18f8a6762c4207?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="cusabio1&#39;s gravatar image" /><p>cusabio1<br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="bronze">●</span><span class="badgecount">1</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="cusabio1 has no accepted answers">0%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 13 Feb '14, 01:29</p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span></p></div></div><div id="comments-container-29824" class="comments-container"></div><div id="comment-tools-29824" class="comment-tools"></div><div class="clear"></div><div id="comment-29824-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

