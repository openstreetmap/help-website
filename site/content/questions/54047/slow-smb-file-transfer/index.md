+++
type = "question"
title = "slow SMB file transfer"
description = '''I am troubleshooting a slow file transfer over SMB from a Windows share to a VM running FreeBSD 10.3 FreeBSD 192.168.20.225, Windows 192.168.20.100 Is there anything in this 3 way handshake between the hosts that indicates a problem? (Window Size Value?) https://www.cloudshark.org/captures/2ade37ce2...'''
date = "2016-07-13T13:39:00Z"
lastmod = "2017-02-21T02:04:00Z"
weight = 54047
keywords = [ "window", "smb", "freebsd", "tcp" ]
aliases = [ "/questions/54047" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [slow SMB file transfer](/questions/54047/slow-smb-file-transfer)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54047-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I am troubleshooting a slow file transfer over SMB from a Windows share to a VM running FreeBSD 10.3 FreeBSD 192.168.20.225, Windows 192.168.20.100</p><p>Is there anything in this 3 way handshake between the hosts that indicates a problem? (Window Size Value?)</p><p><a href="https://www.cloudshark.org/captures/2ade37ce25dd">https://www.cloudshark.org/captures/2ade37ce25dd</a></p><p>here is a graph of a 2GB file transfer from a Windows computer hosting the file</p><p><img src="https://osqa-ask.wireshark.org/upfiles/2gbtranss.jpg" alt="alt text" /></p><p>here is a graph of what whireshark sees</p><p><img src="https://osqa-ask.wireshark.org/upfiles/grafs.jpg" alt="alt text" /></p><p>Thank you</p></div><div id="question-tags" class="tags-container tags">window smb freebsd tcp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>13 Jul '16, 13:39</strong></p><img src="https://secure.gravatar.com/avatar/bcfdf26904f3a8a9fb69c7ca0dc5e7b1?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="net_tech&#39;s gravatar image" /><p>net_tech<br />
<span class="score" title="116 reputation points">116</span><span title="30 badges"><span class="badge1">●</span><span class="badgecount">30</span></span><span title="33 badges"><span class="silver">●</span><span class="badgecount">33</span></span><span title="37 badges"><span class="bronze">●</span><span class="badgecount">37</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="net_tech has 2 accepted answers">13%</span></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 13 Jul '16, 13:53</p></div></div><div id="comments-container-54047" class="comments-container"><span id="54069"></span><div id="comment-54069" class="comment"><div id="post-54069-score" class="comment-score"></div><div class="comment-text"><p>Just seeing the 3-way handshake's not going to help. The Wireshark graph shows the throughput bouncing all over the place and even dropping to 0 for some seconds. We'd need to see the whole capture to analyze it.</p><p>Alternatively I'd suggest looking at (and using some of the analysis techniques) described at Ronnie's excellent "analyze CIFS Traffic" presentation available on the <a href="https://wiki.wireshark.org/Presentations">Presentations page</a> of the wiki.</p></div><div id="comment-54069-info" class="comment-info"><span class="comment-age">(14 Jul '16, 11:32)</span> JeffMorriss ♦</div></div><span id="54070"></span><div id="comment-54070" class="comment"><div id="post-54070-score" class="comment-score"></div><div class="comment-text"><p>Here is a capture of the transfer via FTP between the same hosts, which looks even worse than SMB (500MB file)</p><p><a href="https://www.dropbox.com/s/9a3exw8u6htijii/ftp.pcapng?dl=0">https://www.dropbox.com/s/9a3exw8u6htijii/ftp.pcapng?dl=0</a></p></div><div id="comment-54070-info" class="comment-info"><span class="comment-age">(14 Jul '16, 12:20)</span> net_tech</div></div><span id="54072"></span><div id="comment-54072" class="comment"><div id="post-54072-score" class="comment-score"></div><div class="comment-text"><p>tiny portion of the SMB trace Windows -&gt; FreeBSD <a href="https://www.cloudshark.org/captures/bf42fc4b294b">https://www.cloudshark.org/captures/bf42fc4b294b</a></p><p>Is Frame #7 an acknowledgment for Frame #6? There is a 7 seconds delay between the packets, which illustrates the drop in the graph above.</p></div><div id="comment-54072-info" class="comment-info"><span class="comment-age">(14 Jul '16, 18:47)</span> net_tech</div></div><span id="54080"></span><div id="comment-54080" class="comment"><div id="post-54080-score" class="comment-score"></div><div class="comment-text"><p>The trace is made onside host with "segmentation offload = yes". If you want to see what really is going on you have to trace outside as close as possible to the machine. Best recomendation: Use a tap.</p></div><div id="comment-54080-info" class="comment-info"><span class="comment-age">(15 Jul '16, 12:24)</span> Christian_R</div></div></div><div id="comment-tools-54047" class="comment-tools"></div><div class="clear"></div><div id="comment-54047-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="54137"></span>

<div id="answer-container-54137" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54137-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>The SMB trace suggests that the client (FreeBSD VM) is slow. Yes, it would be nice to see it with segmentation offload disabled but I'm not sure it matters in this case. The big packets are coming from the Windows machine and the traffic was captured on the Windows machine. The 7 second delay isn't from the big packets it's from the next read request from the client.</p><p>The FTP trace is similar. There's a large burst of traffic at the beginning (peaking at 50,000,000 bytes/sec) but then quickly slows down to (and stabilizes) around 4,000,000 bytes/sec.</p><p>I don't see much in the way of transport problems (e.g., packet loss). I don't know if the segmentation offload is hiding this--I've never worked much with TSO enabled.</p><p>These two traces <em>suggest</em> to me that the (FreeBSD VM) client is slow and I would further theorize that it may be the filesystem that is slow.</p><p>You might want to time some (large) file creations on the VM to test the theory. For example:</p><pre><code>time dd if=/dev/zero of=/some/file bs=1m count=500</code></pre><p>Will create a 500 Mbyte file and tell you how long it took. Do some math and find out what the filesystem write speed is. If you get something on the order of 4 Mbytes/sec (like the FTP transfer) then that's your problem. If it's <strong>much</strong> faster then my theory's no good.</p><p>Note: the above would work on Linux; I think it will work on FreeBSD too.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>18 Jul '16, 11:25</strong></p><img src="https://secure.gravatar.com/avatar/e0564001bb7deb960d5d9d9c1e0ba074?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JeffMorriss&#39;s gravatar image" /><p>JeffMorriss ♦<br />
<span class="score" title="6219 reputation points"><span>6.2k</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="72 badges"><span class="bronze">●</span><span class="badgecount">72</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="JeffMorriss has 103 accepted answers">27%</span></p></img></div></div><div id="comments-container-54137" class="comments-container"><span id="54189"></span><div id="comment-54189" class="comment"><div id="post-54189-score" class="comment-score"></div><div class="comment-text"><p>Output:</p><pre><code>500+0 records in
500+0 records out
524288000 bytes transferred in 0.782651 secs (669887389 bytes/sec)
0.000u 0.582s 0:00.78 74.3% 25+171k 0+1io 0pf+0w
[email protected]:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500

500+0 records in
500+0 records out
524288000 bytes transferred in 0.602017 secs (870885468 bytes/sec)
0.000u 0.240s 0:00.60 40.0% 22+153k 0+0io 0pf+0w
[email protected]:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500

500+0 records in
500+0 records out
524288000 bytes transferred in 0.656157 secs (799028261 bytes/sec)
0.000u 0.235s 0:00.65 35.3% 25+171k 0+0io 0pf+0w
[email protected]:/tmp # time dd if=/dev/zero of=/LearnKey-Linux.rar bs=1m count=500</code></pre></div><div id="comment-54189-info" class="comment-info"><span class="comment-age">(20 Jul '16, 08:15)</span> net_tech</div></div><span id="54209"></span><div id="comment-54209" class="comment"><div id="post-54209-score" class="comment-score"></div><div class="comment-text"><p>So the disk is certainly fast enough...</p><p>Looking again at the FTP capture I can see two things of interest:</p><ol><li>If I graph the client's available window size it never drops below like 50k (so: the server is not filling the client's window--in other words the server isn't sending as fast as it could)</li><li>(and) if I filter for <code>ftp-data</code> and then change the time display to "seconds since previously displayed packet" I can see that, once the throughput has gotten slow, the server is only sending another (50kbyte) packet every 8-12 milliseconds. That's pretty slow. This is also visible without a filter: the time between the last ACK from the client and the next FTP-DATA appears to always be 4+ milliseconds.</li></ol><p>Is this (Windows) server able to send files (of this size) to other clients at higher speeds?</p></div><div id="comment-54209-info" class="comment-info"><span class="comment-age">(20 Jul '16, 14:17)</span> JeffMorriss ♦</div></div><span id="55521"></span><div id="comment-55521" class="comment"><div id="post-55521-score" class="comment-score"></div><div class="comment-text"><p>Yes, Windows 7 (acting as a server) is capable of sending at 115MB/s</p><p>Here is a diagram of the current setup. VMWare server is hosting 2VMs. Windows Server 2012 and FreeBSD. Windows 7 Workstation on the right is a physical computer with a network share. Transferring a test 2GB file from a Win 7 PC to a 2012 Server VM is almost wire speed, transferring the same 2GB file from a Win 7 to a FreeBSD VM is extremely slow. Both VMs (FreeBSD and Win 2012) have identical hardware assigned to them, there is no special memory/cpu/hard drive reservations.</p><p><img src="http://www.remontnetworks.com/freebsd/diag.jpg" alt="alt text" /></p></div><div id="comment-55521-info" class="comment-info"><span class="comment-age">(13 Sep '16, 07:01)</span> net_tech</div></div><span id="55542"></span><div id="comment-55542" class="comment"><div id="post-55542-score" class="comment-score"></div><div class="comment-text"><p>I spun up another Win 7 VM and enabled promiscuous mode on the vSwitch so my new Win 7 VM running Wireshark could see all traffic between the FreeBSD and Windows 7 PC.</p><p>Windows 7 PC hosting the SMB share is now at 192.168.20.103, FreeBSD is at 192.168.20.225</p><p>New capture could be downloaded <a href="https://www.dropbox.com/s/vcivexl2e4usdaa/2gb.pcapng?dl=0">here</a> (1.2GB)</p><p><img src="http://www.remontnetworks.com/freebsd/2gb.jpg" alt="alt text" /></p></div><div id="comment-55542-info" class="comment-info"><span class="comment-age">(13 Sep '16, 18:58)</span> net_tech</div></div><span id="55556"></span><div id="comment-55556" class="comment"><div id="post-55556-score" class="comment-score"></div><div class="comment-text"><p>there is a 7 seconds delay around frame 368749, if it does turn out to be the file system (ZFS) problem, is there anything in the trace to support this theory?</p><p>Thanks</p></div><div id="comment-55556-info" class="comment-info"><span class="comment-age">(14 Sep '16, 07:42)</span> net_tech</div></div><span id="55560"></span><div id="comment-55560" class="comment not_top_scorer"><div id="post-55560-score" class="comment-score"></div><div class="comment-text"><p>Well frame 368749 is a SMB Read Request (from FreeBSD) which is <strong>14 seconds</strong> after the last message in that (TCP) conversation. That 14 second delay certainly appears to be due to something on the (FreeBSD) client but whether that's the filesystem or something else is another question...</p></div><div id="comment-55560-info" class="comment-info"><span class="comment-age">(14 Sep '16, 13:44)</span> JeffMorriss ♦</div></div><span id="55562"></span><div id="comment-55562" class="comment not_top_scorer"><div id="post-55562-score" class="comment-score"></div><div class="comment-text"><p>Looking at the throughput in the latest file your original supposition may have been correct: it appears that the Windows server is filling the client's TCP window. The client is not setting window scaling which is limiting Windows to 62k before it has to stop and wait. (This is visible if you graph <code>tcp.analysis.bytes_in_flight</code> from the server or if you filter for frames where that value is large--like more than 60000.)</p><p>Can you enable window scaling on FreeBSD?</p></div><div id="comment-55562-info" class="comment-info"><span class="comment-age">(14 Sep '16, 14:41)</span> JeffMorriss ♦</div></div><span id="55571"></span><div id="comment-55571" class="comment not_top_scorer"><div id="post-55571-score" class="comment-score"></div><div class="comment-text"><p>According to <a href="https://wiki.freebsd.org/SystemTuning">https://wiki.freebsd.org/SystemTuning</a> RFC1323 support is enabled by default, but I went ahead and applied the suggested settings from this post <a href="https://slaptijack.com/system-administration/freebsd-tcp-performance-tuning.">https://slaptijack.com/system-administration/freebsd-tcp-performance-tuning.</a> Unfortunately there was no improvement.</p><p>I also experimented with another FreeBSD VM using USF. Here is the graph.</p><p><img src="http://www.remontnetworks.com/freebsd/ufs.jpg" alt="alt text" /></p></div><div id="comment-55571-info" class="comment-info"><span class="comment-age">(15 Sep '16, 13:54)</span> net_tech</div></div><span id="55572"></span><div id="comment-55572" class="comment not_top_scorer"><div id="post-55572-score" class="comment-score"></div><div class="comment-text"><p>finally I bumped the ram of the FreeBSD VM from 4GB to 8GB. This is the 1st time I was able to transfer a 2GB file at half the gigabit speeds and minimal drops.</p><p><img src="http://www.remontnetworks.com/freebsd/8gb.jpg" alt="alt text" /></p></div><div id="comment-55572-info" class="comment-info"><span class="comment-age">(15 Sep '16, 13:56)</span> net_tech</div></div><span id="55573"></span><div id="comment-55573" class="comment not_top_scorer"><div id="post-55573-score" class="comment-score"></div><div class="comment-text"><p>Interesting... Is FreeBSD now advertising large TCP windows (via window scaling)? At what point did it start doing that (which change did it)?</p><p>The "throw memory at it" fix makes me wonder about some of the notes on the FreeBSD pages about needing to increase network memory buffers when enabling TCP window scaling... If that's the case there may be some other config options to try.</p></div><div id="comment-55573-info" class="comment-info"><span class="comment-age">(15 Sep '16, 14:07)</span> JeffMorriss ♦</div></div><span id="55579"></span><div id="comment-55579" class="comment not_top_scorer"><div id="post-55579-score" class="comment-score"></div><div class="comment-text"><p>no, the largest Window size value is still 1040. I want to do another test on a physical FreeBSD system. I am not using NFS, but suspect virtualization could be adding some complexity to this puzzle <a href="https://calvin.me/slow-vmware-nfs-zfs-add-zil/">https://calvin.me/slow-vmware-nfs-zfs-add-zil/</a></p></div><div id="comment-55579-info" class="comment-info"><span class="comment-age">(15 Sep '16, 19:15)</span> net_tech</div></div><span id="55600"></span><div id="comment-55600" class="comment not_top_scorer"><div id="post-55600-score" class="comment-score"></div><div class="comment-text"><p>1040? In the "2gb" file I was looking at FreeBSD was advertising 64k (in both the SYN and in all the TCP ACKs).</p></div><div id="comment-55600-info" class="comment-info"><span class="comment-age">(16 Sep '16, 10:49)</span> JeffMorriss ♦</div></div><span id="55601"></span><div id="comment-55601" class="comment not_top_scorer"><div id="post-55601-score" class="comment-score"></div><div class="comment-text"><p>sorry, it's still 64k</p><p>but this could be the answer why the performance is better with 8GB</p><p><img src="http://www.remontnetworks.com/freebsd/zfsn.jpg" alt="alt text" /></p></div><div id="comment-55601-info" class="comment-info"><span class="comment-age">(16 Sep '16, 11:45)</span> net_tech</div></div><span id="55605"></span><div id="comment-55605" class="comment not_top_scorer"><div id="post-55605-score" class="comment-score"></div><div class="comment-text"><p>Hmm, isn't prefetching for optimizing (sequential) <strong>reads</strong>? Here the BSD client is reading from a remote server and writing locally.</p></div><div id="comment-55605-info" class="comment-info"><span class="comment-age">(16 Sep '16, 12:50)</span> JeffMorriss ♦</div></div><span id="55669"></span><div id="comment-55669" class="comment not_top_scorer"><div id="post-55669-score" class="comment-score"></div><div class="comment-text"><p>you are correct, prefetching would help if I was reading from the BSD client. I thought the better result was from the memory increase, apparently it's from UFS.</p><p>To rule out virtualization, I built another BSD client on physical machine with an SSD drive and ZFS.</p><p>Results are much better with no drops in the file transfer, which leaves VMware being a part of the problem.</p><p><img src="http://www.remontnetworks.com/freebsd/phys_zfs.jpg" alt="alt text" /></p></div><div id="comment-55669-info" class="comment-info"><span class="comment-age">(19 Sep '16, 18:05)</span> net_tech</div></div><span id="55670"></span><div id="comment-55670" class="comment not_top_scorer"><div id="post-55670-score" class="comment-score"></div><div class="comment-text"><p>Do you think increasing the TCP window on a BSD system will improve the throughput?</p><p>Executing <strong>sysctl net.inet.tcp</strong> on a BSD system shows that rfc1323 is enabled by default.</p><blockquote><p>net.inet.tcp.rfc1323: 1</p></blockquote><p>FreeBSD 10.3 VM TCP Window</p><p><img src="http://www.remontnetworks.com/freebsd/fbsdws.jpg" alt="link text" /></p><p>Win 2012 VM TCP Window</p><p><img src="http://www.remontnetworks.com/freebsd/winws.jpg" alt="alt text" /></p><p>Thank you</p></div><div id="comment-55670-info" class="comment-info"><span class="comment-age">(19 Sep '16, 18:09)</span> net_tech</div></div></div><div id="comment-tools-54137" class="comment-tools"><span class="comments-showing"> showing 5 of 16 </span> <a href="#" class="show-all-comments-link">show 11 more comments</a></div><div class="clear"></div><div id="comment-54137-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="59579"></span>

<div id="answer-container-59579" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-59579-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>I had a look at the capture named "2gb".</p><p>It is missing a lot of packets because the sniffer dropped them, not because the network dropped them. These occur at very regular intervals - not randomly. At the time period I delved into, for every 35-37ms of data captured there was then 70-74ms of data missing. This would lead me to believe that the capturing mechanism has an inherent flaw, perhaps based on the virtualisation.</p><p>Nevertheless, we can find some useful information.</p><p>Although we don't see the 3-way handshake for the main SMB connection, other SYN/SYN-ACK setups between the same client and server don't support Window Scaling. Therefore, we can only ever have 64KB in flight (i.e., per round trip). Put another way, we can only do one SMB request/response at a time (because each SMB requests a 64 KB data block).</p><p>This may not matter in this case because the "slowness" is entirely due to the client.</p><p>We are achieving a throughput of ~500 Mb/s because we are achieving only approximately 64 KB/ms. This is because the client is only making one request per 1 or 2 ms. Each request is serviced very quickly and the 64 KB is delivered from the server across the network very quickly. The client usually ACKs the server data quickly, except for the last few packets which are ACKed by the client's next SMB READ&amp;X request packet.</p><p>The time gaps between the client's request packet and the last server packet are consistently just under 0.4ms. The time from the last server packet and the client's next request packet is consistently just under 0.6ms. The time between client request packets is consistently 1ms +/- 0.2ms.</p><p>The network RTT seems to be around 0.2ms, so the time gaps between client requests are not related to the network. They are time spent by the client dealing with the received data before bothering to request the next block. The large 14 second time gap is, likewise, due to the client.</p><p>So your hunt is to determine why the client waits so long between requests.</p><ul><li>Could it be that it takes it that long to write the received 64 KB away?</li><li>Could the virtualisation be playing a part? Eg, the virtual servers or network components only get a "turn" once per millisecond?</li></ul><p>I'd also be interested in why Windows Scaling doesn't appear to be enabled. The client doesn't request it in its SYN packets. It would be interesting to know if enabling it would make a difference.</p><p>Happy hunting!</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>21 Feb '17, 02:04</strong></p><img src="https://secure.gravatar.com/avatar/35a0c1d0cf15b9d54d73bf54ae28abcd?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Philst&#39;s gravatar image" /><p>Philst<br />
<span class="score" title="431 reputation points">431</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="16 badges"><span class="bronze">●</span><span class="badgecount">16</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Philst has 6 accepted answers">27%</span></p></img></div></div><div id="comments-container-59579" class="comments-container"></div><div id="comment-tools-59579" class="comment-tools"></div><div class="clear"></div><div id="comment-59579-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

