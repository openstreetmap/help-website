+++
type = "question"
title = "Why causes ARP request  a &quot;TCP previous segment lost&quot;?"
description = '''We have two windows XP pc&#x27;s 10.10.10.1 and 10.10.10.2 with a direct connection to each other (So not via a router). These both have a user application running, which continuously exchange information via TCP/IP. When the communication between the 2 pc&#x27;s is logged with wireshark, it shows every 10 mi...'''
date = "2012-07-12T05:18:00Z"
lastmod = "2012-07-31T07:03:00Z"
weight = 12655
keywords = [ "arp" ]
aliases = [ "/questions/12655" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [Why causes ARP request a "TCP previous segment lost"?](/questions/12655/why-causes-arp-request-a-tcp-previous-segment-lost)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-12655-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-12655-score" class="post-score" title="current number of votes">1</div><span id="post-12655-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>We have two windows XP pc's 10.10.10.1 and 10.10.10.2 with a direct connection to each other (So not via a router). These both have a user application running, which continuously exchange information via TCP/IP. When the communication between the 2 pc's is logged with wireshark, it shows every 10 minutes a ARP request is broadcast to refresh the arp cache. However once in a while, the ARP message exchange seems to set off the whole network communication. In wireshark it is followed by a TCP previous segment lost message. Here an example:</p><pre><code>26893 1578.844599 10.10.10.2            10.10.10.1            TCP      146    kyoceranetdev &gt; scol [PSH, ACK] Seq=3613653 Ack=402623 Win=65280 Len=92 2012-06-06 15:22:02.178605 146

26894 1579.029143 IntelCor_8d:0c:6d     Broadcast             ARP      42     Who has 10.10.10.1?  Tell 10.10.10.2                            2012-06-06 15:22:02.363149 42

26895 1579.030506 IntelCor_8d:0c:4f     IntelCor_8d:0c:6d     ARP      60     10.10.10.1 is at 00:15:17:8d:0c:4f                              2012-06-06 15:22:02.364512 60

26896 1579.030511 10.10.10.2            10.10.10.1            TCP      191    [TCP Previous segment lost] kyoceranetdev &gt; scol [PSH, ACK] Seq=3615205 Ack=402623 Win=65280 Len=137 2012-06-06 15:22:02.364517 191

26897 1579.030666 10.10.10.1            10.10.10.2            TCP      66     scol &gt; kyoceranetdev [ACK] Seq=402623 Ack=3613745 Win=64538 Len=0 SLE=3615205 SRE=3615342 2012-06-06 15:22:02.364672 66

26898 1579.291510 10.10.10.2            10.10.10.1            TCP      1514   kyoceranetdev &gt; scol [PSH, ACK] Seq=3615342 Ack=402623 Win=65280 Len=1460 2012-06-06 15:22:02.625516 1514

26899 1579.291522 10.10.10.2            10.10.10.1            TCP      62     kyoceranetdev &gt; scol [PSH, ACK] Seq=3616802 Ack=402623 Win=65280 Len=8 2012-06-06 15:22:02.625528 62

26900 1579.298290 10.10.10.1            10.10.10.2            TCP      66     [TCP Dup ACK 26897#1] scol &gt; kyoceranetdev [ACK] Seq=402623 Ack=3613745 Win=64538 Len=0 SLE=3615205 SRE=3616802 2012-06-06 15:22:02.632296 66

26901 1579.298296 10.10.10.1            10.10.10.2            TCP      66     [TCP Dup ACK 26897#2] scol &gt; kyoceranetdev [ACK] Seq=402623 Ack=3613745 Win=64538 Len=0 SLE=3615205 SRE=3616810 2012-06-06 15:22:02.632302 66

26902 1579.298306 10.10.10.2            10.10.10.1            TCP      210    [TCP Fast Retransmission] kyoceranetdev &gt; scol [PSH, ACK] Seq=3613745 Ack=402623 Win=65280 Len=156 2012-06-06 15:22:02.632312 210

26903 1579.298306 10.10.10.2            10.10.10.1            TCP      218    kyoceranetdev &gt; scol [PSH, ACK] Seq=3616810 Ack=402623 Win=65280 Len=164 2012-06-06 15:22:02.632312 218</code></pre><p>Anyone any idea why this is happening?</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-arp" rel="tag" title="see questions tagged &#39;arp&#39;">arp</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>12 Jul '12, 05:18</strong></p><img src="https://secure.gravatar.com/avatar/26cc90089fc8501812ad5225b214f8d3?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="rv_deventer&#39;s gravatar image" /><p><span>rv_deventer</span><br />
<span class="score" title="21 reputation points">21</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="rv_deventer has no accepted answers">0%</span></p></div></div><div id="comments-container-12655" class="comments-container"><span id="13005"></span><div id="comment-13005" class="comment"><div id="post-13005-score" class="comment-score"></div><div class="comment-text"><p>Can you post a capture file somewhere (perhaps <a href="http://www.cloudshark.org">www.cloudshark.org</a>) that shows the problem? It's hard to tell much from a text printout with only a single ARP request/response pair and only 11 packets total. It's likely that the ARP and the lost segment are unrelated and it's just coincidence that the lost segment sometimes comes right after an ARP.</p></div><div id="comment-13005-info" class="comment-info"><span class="comment-age">(25 Jul '12, 17:30)</span> <span class="comment-user userinfo">Jim Aragon</span></div></div></div><div id="comment-tools-12655" class="comment-tools"></div><div class="clear"></div><div id="comment-12655-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="13065"></span>

<div id="answer-container-13065" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-13065-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-13065-score" class="post-score" title="current number of votes">3</div><span id="post-13065-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="rv_deventer has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Let's sum it up in an answer.<br />
</p><p>Based on the information gathered during analyzing the problem, I conclude:</p><p><strong>Windows:</strong> ARP Behavior</p><blockquote><p><code>http://technet.microsoft.com/en-us/library/cc940021.aspx</code><br />
</p></blockquote><p>Look at the end.</p><blockquote><p>Cite: <strong>ARP queues only one outbound IP datagram</strong> for a given destination address <strong>while that IP address is being resolved to a MAC address</strong>. .... An application <strong>can compensate for this</strong> by <strong>calling the Iphlpapi.dll routine SendArp()</strong> to establish an arp cache entry, before sending the stream of packets.</p></blockquote><p>Also this:</p><blockquote><p><code>http://support.microsoft.com/kb/194881/en-us</code><br />
</p><p>Cite: While Windows NT awaits an ARP Response, <strong>ARP will "queue" the IP packet that needs to be sent</strong>. When Windows NT <strong>receives the ARP Response</strong>, it will <strong>only transmit the "latest" or last packet</strong> that it received in its "ARP Packet Queue" for any given destination host.</p></blockquote><p><strong>Conclusion</strong>: It looks like Windows dropped one (ore more) of your TCP packets, ALTHOUGH the information above seems to be only related to UDP. Maybe the information in the first link is wrong or the behavior is the same for TCP and other protocols.<br />
</p><p>HOWEVER, This behavior does not fully comply with the explanation above. At least one packet should have been queued and sent, after ARP finished. But maybe that's just the packet Wireshark marks with "TCP Previous segment was not captured" and another packet with payload data was dropped. Without insight into the application, we will never know.<br />
</p><p><strong>Question:</strong> Why does it happen only once in a while?<br />
<strong>Answer:</strong> It's simply a timing issue. There may be short time frames where the application does not transmit any data. If the ARP refresh takes place in that time frame, you won't see any problems, as no packets need to be queued.</p><p><strong>Solution</strong> for your problem, in the order I would recommend:</p><ul><li>do nothing, as TCP recovers from that situation by itself</li><li>call <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366358%28v=vs.85%29.aspx">SendArp()</a> from time to time in your application to update the arp cache before the entry expires</li><li>set a static ARP entry, verified by yourself. However, that's not a good idea</li></ul><p>It's apparently the same for other operation systems, however the "ARP queue length" is different.</p><p><strong>Linux:</strong> You can configured the ARP queue len with the parameter <strong><code>unres_qlen</code></strong> via systcl (Default: 3).</p><blockquote><p><code>http://www.kernel.org/doc/man-pages/online/pages/man7/arp.7.html</code><br />
<code>http://www.6test.edu.cn/~lujx/linux_networking/0131777203_ch15lev1sec3.html</code><br />
</p></blockquote><p><strong>AIX:</strong> Same for AIX with <strong><code>arpqsize</code></strong> (Default: 12).</p><blockquote><p><code>http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?topic=/com.ibm.aix.prftungd/doc/prftungd/arp_cache_tuning.htm</code><br />
</p></blockquote><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>27 Jul '12, 02:15</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div></div><div id="comments-container-13065" class="comments-container"><span id="13181"></span><div id="comment-13181" class="comment"><div id="post-13181-score" class="comment-score"></div><div class="comment-text"><p>Thanks Kurt for this extensive 'research', I understand it is some kind of default behaviour. Still strange that it looks like windows drops packets, except the last one.</p><p>Anyway, we think we have 'fixed' it as follows: Every time at start-up of our application the application uses SendARP etc. to once discover the mac address of the other pc. Then it adds a static entry to the arp cache.</p><p>Thanks, Rudy PS. I tried to award points to you, but in some way I cannot set the award points slider to a value different from 1. (?)</p></div><div id="comment-13181-info" class="comment-info"><span class="comment-age">(31 Jul '12, 05:56)</span> <span class="comment-user userinfo">rv_deventer</span></div></div><span id="13184"></span><div id="comment-13184" class="comment"><div id="post-13184-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Thanks Kurt for this extensive 'research',</p></blockquote><p>You're welcome and I learned something too ;-))</p><blockquote><p>Still strange that it looks like windows drops packets, except the last one.</p></blockquote><p>That's the way the Windows stack seems to work. It will only buffer one packet during the ARP request. So, if there are severeal packets sent during that time, all are dropped, except the last one.</p><blockquote><p>Every time at start-up of our application the application uses SendARP etc. to once discover the mac address of the other pc. Then it adds a static entry to the arp cache.</p></blockquote><p>SendArp() is O.K, but <strong>the static ARP entry is problematic</strong>!!</p><p>This entry will be there until the machine reboots. Imagine, the NIC of the computer for which you have a static entry needs to be replaced (or the whole machine needs to be replaced). After it boots up, you will still try to contact the old MAC address due to the static ARP cache entry. It will take you (your admins, customers) quite some time to figure out what's going wrong. It's certainly better to use SendArp() throughout your application, triggered by a timer.</p><blockquote><p>I tried to award points to you, but in some way I cannot set the award points slider to a value different from 1. (?)</p></blockquote><p>That's because you only have 1 karma point yourself. Just accept the answer (check mark) and if you like vote it up.</p></div><div id="comment-13184-info" class="comment-info"><span class="comment-age">(31 Jul '12, 06:14)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="13185"></span><div id="comment-13185" class="comment"><div id="post-13185-score" class="comment-score"></div><div class="comment-text"><p>I agree with your suggestion that SendARp throughout the application is better solution. With our solution, we are aware that we have an issue when the computer for which we have the static entry needs to be replaced. As a first approach we are going to instruct our service department (who does replacements) to reboot both computers. That will then prevent it. We then can still decide in the future to implement the timer triggered refresh...</p></div><div id="comment-13185-info" class="comment-info"><span class="comment-age">(31 Jul '12, 06:25)</span> <span class="comment-user userinfo">rv_deventer</span></div></div><span id="13187"></span><div id="comment-13187" class="comment"><div id="post-13187-score" class="comment-score"></div><div class="comment-text"><p>BTW: Why do you need to do anything at all? TCP recovers from the situation by its retransmission mechanism.</p></div><div id="comment-13187-info" class="comment-info"><span class="comment-age">(31 Jul '12, 07:03)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div></div><div id="comment-tools-13065" class="comment-tools"></div><div class="clear"></div><div id="comment-13065-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="13001"></span>

<div id="answer-container-13001" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-13001-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-13001-score" class="post-score" title="current number of votes">0</div><span id="post-13001-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>Anyone any idea why this is happening?</p></blockquote><p>Not a real idea, just some guessing for now.</p><blockquote><p>However once in a while, the ARP message exchange seems to set off the whole network communication</p></blockquote><p>Is that "once in a while" in the regular 10 minute schedule (Windows XP ARP cache renewal time for used entries)?</p><p><strong>If NO</strong>: You say, the computers are connected directly to each other. I assume a CAT5/6 cable. Maybe the RJ45 connector is not plugged in fully (at either end) and due to small movements (vibrations) the connector loses contact with some pins, which could cause packet loss. Maybe even the link state is lost. However: the time difference between the last TCP packet and the ARP request is probalby to short to reestablish the link. Anyway, can you please check the physical connection (unplug/plug) at both ends?</p><p><strong>If YES</strong>: I have no idea (yet) what causes the loss of at least one packet (10.10.10.2 -&gt; 10.10.10.1).</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>25 Jul '12, 13:40</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>25 Jul '12, 13:43</strong> </span></p></div></div><div id="comments-container-13001" class="comments-container"><span id="13056"></span><div id="comment-13056" class="comment"><div id="post-13056-score" class="comment-score"></div><div class="comment-text"><p>Hi Kurt,</p><p>Thanks for your answer.</p><p>ARP broadcast and ARP cache renewal is every 10 minutes. Most renewals do not set off communication, it's just once in a while. We did replace the UTP cable between the pc's. Did not help. Further we do see the same issue at different customers (we have several systems in the field).</p><p>We also did the following test: we added a static entry to the arp cache. That fixed the communication problem. It proved that the ARP renewal causes the communication is been set off.</p><p>I uploaded 4 dump files, which shows the issue:</p><pre><code>PC 10.10.10.1 Dump6.pcap    http://www.cloudshark.org/captures/380ef7488e8e
PC 10.10.10.2 Dump6.pcap    http://www.cloudshark.org/captures/6539364bc235
Dump6
 PC 10.10.10.1       PC 10.10.10.2
   Packet no           Packet no
     2046               2326   ARP
    14544              14824   ARP   -&gt; Sets off communication

PC 10.10.10.1 Dump8.pcap   http://www.cloudshark.org/captures/d550e87c5451
PC 10.10.10.2 Dump8.pcap   http://www.cloudshark.org/captures/51a6c13672d1
Dump8
 PC 10.10.10.1       PC 10.10.10.2
   Packet no           Packet no
      687                267   ARP
    11311              10891   ARP
    20314              19894   ARP   -&gt; Sets off communication
    32437              32017   ARP</code></pre><p>Regards Rudy</p></div><div id="comment-13056-info" class="comment-info"><span class="comment-age">(27 Jul '12, 00:10)</span> <span class="comment-user userinfo">rv_deventer</span></div></div><span id="13063"></span><div id="comment-13063" class="comment"><div id="post-13063-score" class="comment-score">1</div><div class="comment-text"><p>looking at capture Dump6.cap I can see the following:</p><p>Wireshark shows "TCP previous segment not captured" for BOTH capture files (Frame #2329 PC_10.10.10.2_Dump6.cap and Frame #2049 PC_10.10.10.1_Dump6.cap).</p><p>I conclude: The Windows TCP/IP stack must have dropped the packet internally, before it was sent to the network, maybe due to the ARP request.</p><p>A quick search on google revealed a similar problem (with UDP).</p><blockquote><p><code>http://www.groupsrv.com/computers/about668311.html</code><br />
</p></blockquote><p>Unfortunately the link to <a href="http://experts-exchange.com">experts-exchange.com</a> is void.</p><p>I guess it's either a bug in Windows or "works as designed" ;-))</p><p><strong>UPDATE</strong>: A rather old link from microsoft itself, pointing at a similar problem. Maybe it's not just a problem in routing mode and still not fixed in Windows XP.</p><blockquote><p><code>http://support.microsoft.com/kb/194881/en-us</code><br />
</p><p>Cite: While Windows NT awaits an ARP Response, <strong>ARP will "queue" the IP packet that needs to be sent</strong>. When Windows NT <strong>receives the ARP Response</strong>, it will <strong>only transmit the "latest" or last packet</strong> that it received in its "ARP Packet Queue" for any given destination host.</p></blockquote><p>Doing a bit more "research" ... There needs (should) to be a queue in the TCP/IP stack that holds packets until the ARP request finished.</p><p>Linux: Take a look at this description of ARP handling in the kernel.</p><blockquote><p><code>http://www.6test.edu.cn/~lujx/linux_networking/0131777203_ch15lev1sec3.html</code><br />
</p></blockquote><p>You can configured the ARP queue len with the parameter <strong><code>unres_qlen</code></strong> via systcl (Default: 3).</p><blockquote><p><code>http://www.kernel.org/doc/man-pages/online/pages/man7/arp.7.html</code></p></blockquote><p>AIX: Same for AIX with <strong><code>arpqsize</code></strong> (Default: 12).</p><blockquote><p><code>http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?topic=/com.ibm.aix.prftungd/doc/prftungd/arp_cache_tuning.htm</code><br />
</p></blockquote><p>Maybe there is also a parameter for Windows, however I was not able to find one (yet).</p><p>I guess this pretty much explains it:</p><blockquote><p><code>http://technet.microsoft.com/en-us/library/cc940021.aspx</code><br />
</p></blockquote><p>Cite: <strong>ARP queues only one outbound IP datagram</strong> for a given destination address while that IP address is being resolved to a MAC address. .... An application can <strong>compensate for this by calling the Iphlpapi.dll routine <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366358%28v=vs.85%29.aspx">SendArp()</a></strong> to establish an arp cache entry, before sending the stream of packets.</p><p><strong>Solution for your problem:</strong></p><ul><li>set a static ARP entry (not a good idea)</li><li>calling SendArp() from time to time to update the arp cache before the entry expires</li></ul></div><div id="comment-13063-info" class="comment-info"><span class="comment-age">(27 Jul '12, 01:25)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div></div><div id="comment-tools-13001" class="comment-tools"></div><div class="clear"></div><div id="comment-13001-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

