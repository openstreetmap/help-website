+++
type = "question"
title = "TCP: How many re-transmissions are acceptable (embedded device)"
description = '''First let me state I an extremely new to networking. My situation is I am using an embedded ARM device with some custom hardware and Ethernet driver chip and a third party TCP-IP stack as well as a third party SMTP client application for that stack. My ultimate goal is just to be able to send emails...'''
date = "2014-04-30T14:45:00Z"
lastmod = "2014-05-03T17:19:00Z"
weight = 32323
keywords = [ "device", "ip", "smtp", "embedded", "tcp" ]
aliases = [ "/questions/32323" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [TCP: How many re-transmissions are acceptable (embedded device)](/questions/32323/tcp-how-many-re-transmissions-are-acceptable-embedded-device)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32323-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32323-score" class="post-score" title="current number of votes">0</div><span id="post-32323-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>First let me state I an extremely new to networking. My situation is I am using an embedded ARM device with some custom hardware and Ethernet driver chip and a third party TCP-IP stack as well as a third party SMTP client application for that stack. My ultimate goal is just to be able to send emails.</p><p>I was experiencing previously odd behavior where connecting to a 'hostmonter.com' email server and sending emails to myself would work sometime and not others.</p><p>I started my search by forgetting SMTP and just issuing a TCP connect sequence with the mail server. I saw similar behavior where it would work fine once but after resetting my embedded device I started getting lots of TCP retransmissions and out of orders warnings and other oddities.</p><p>I setup hMailServer on my laptop to take 'hostmonster.com' out of the equation but proceeded to get the same TCP re-transmissions and out of orders warnings and even some duplicate ACKs.</p><p>The device always connects to the server but it just seems to me that for a hardwired connection all on my desk I should be experiencing 0 re-transmissions or other oddities. But is it possible that having a slow (&lt;50MHz) ARM processor could be the cause of those re-transmissions etc when connected to a much faster server and much faster internet in general?</p><p>Here is the condensed log from wireshark: <a href="http://lookoutportablesecurity.com/tcp.txt">http://lookoutportablesecurity.com/tcp.txt</a></p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-device" rel="tag" title="see questions tagged &#39;device&#39;">device</span> <span class="post-tag tag-link-ip" rel="tag" title="see questions tagged &#39;ip&#39;">ip</span> <span class="post-tag tag-link-smtp" rel="tag" title="see questions tagged &#39;smtp&#39;">smtp</span> <span class="post-tag tag-link-embedded" rel="tag" title="see questions tagged &#39;embedded&#39;">embedded</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>30 Apr '14, 14:45</strong></p><img src="https://secure.gravatar.com/avatar/d10b4a16cda08123bdeafd8686342d41?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="wes000000&#39;s gravatar image" /><p><span>wes000000</span><br />
<span class="score" title="21 reputation points">21</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="wes000000 has no accepted answers">0%</span></p></div></div><div id="comments-container-32323" class="comments-container"></div><div id="comment-tools-32323" class="comment-tools"></div><div class="clear"></div><div id="comment-32323-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="32335"></span>

<div id="answer-container-32335" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32335-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32335-score" class="post-score" title="current number of votes">2</div><span id="post-32335-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I don't think that these are real re-transmissions but just traced twice. Looking at the delta times of the suspected packets - they 'retransmissions' occur in the same ms.</p><ul><li>166,167 is the SYN_ACK occuring 15.777 seconds into the trace (note the slightly different size)</li><li>170,171 is the SMTP Welcome message occuring 15.933</li><li>615,616 is an ACK to the client's FIN occuring 55.239 into the trace</li></ul><p>I suggest yo look at the ip.id of those packets to verify whether it's the same packet traced twice or a real re-transmission</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>01 May '14, 00:50</strong></p><img src="https://secure.gravatar.com/avatar/5500bd1decb766660522dfb347eedc49?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde&#39;s gravatar image" /><p><span>mrEEde</span><br />
<span class="score" title="3892 reputation points"><span>3.9k</span></span><span title="15 badges"><span class="badge1">●</span><span class="badgecount">15</span></span><span title="22 badges"><span class="silver">●</span><span class="badgecount">22</span></span><span title="70 badges"><span class="bronze">●</span><span class="badgecount">70</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde has 48 accepted answers">20%</span></p></div></div><div id="comments-container-32335" class="comments-container"><span id="32341"></span><div id="comment-32341" class="comment"><div id="post-32341-score" class="comment-score"></div><div class="comment-text"><p>200ms delay between two packets is way too slow for duplicates, they usually have a delta of only a couple of microseconds. But without a capture and a description of the capture setup it can't be completely ignored as an option.</p></div><div id="comment-32341-info" class="comment-info"><span class="comment-age">(01 May '14, 06:35)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div></div><div id="comment-tools-32335" class="comment-tools"></div><div class="clear"></div><div id="comment-32335-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="32329"></span>

<div id="answer-container-32329" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32329-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32329-score" class="post-score" title="current number of votes">1</div><span id="post-32329-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I guess your ARM processor might be too slow when talking to your mailserver. If you look at packet 170 you see that the mail server sends "S: 220 WESLEY-LAPTOP ESMTP" to the client", but there is no acknowledge or answer coming back. I guess this triggers a retransmission after 200ms in packet 171, because the server assumes the packet 170 got lost since it didn't get acknowledged. The only reason I can think of in a network as small and simple as the one you're describing is that the client is having trouble answering in time.</p><p>The same happens again in packets 1086 and 1087, again with over 200ms delta.</p><p>So again, my money is on the ARM processor being too slow (or the code not fast enough, however you want to look at it :-))</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>30 Apr '14, 16:54</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p><span>Jasper ♦♦</span><br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-32329" class="comments-container"></div><div id="comment-tools-32329" class="comment-tools"></div><div class="clear"></div><div id="comment-32329-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="32370"></span>

<div id="answer-container-32370" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32370-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32370-score" class="post-score" title="current number of votes">1</div><span id="post-32370-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>As <span><span><span><span>@mrEEde</span></span></span></span> indicated, there are duplicate frames in the capture file coming from 10.0.0.65 (the SMTP server). I don't think they are re-transmissions. I believe they are just duplicates due to the way the capture file was taken (probably on the SMTP server itself or on a mirror port of the switch duplicating the server traffic).</p><p>I believe the capture file was taken on the server, because of the duplicate frames 125,126. Frame 125 was captured before padding (on the server), frame 126 was captured after padding.</p><p><code>  125 12.636354000  Pegatron_ad:34:d3  1e:30:6c:a2:45:5c  ARP  42  10.0.0.65 is at 4c:72:b9:ad:34:d3  126 12.636598000  Pegatron_ad:34:d3  1e:30:6c:a2:45:5c  ARP  60  10.0.0.65 is at 4c:72:b9:ad:34:d3</code></p><p>So, those duplicate frames are not going to cause a problem on the embedded device, because <strong>there are no duplicates (re-transmission) on the wire</strong>.</p><p>After you remove the duplicate frames, you'll get this:</p><p><code>   162 15.690765000   10.0.0.187  10.0.0.65   TCP  60  1024 &gt; smtp [SYN] Seq=0 Win=4380 Len=0 MSS=1460   166 15.777702000   10.0.0.65   10.0.0.187  TCP  58  smtp &gt; 1024 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1460   169 15.931764000   10.0.0.187  10.0.0.65   TCP  60  1024 &gt; smtp [ACK] Seq=1 Ack=1 Win=4380 Len=0   170 15.933402000   10.0.0.65   10.0.0.187  SMTP 79  S: 220 WESLEY-LAPTOP ESMTP   173 16.076656000   10.0.0.187  10.0.0.65   TCP  60  1024 &gt; smtp [ACK] Seq=1 Ack=26 Win=4380 Len=0   614 55.239381000   10.0.0.187  10.0.0.65   TCP  60  1024 &gt; smtp [FIN, ACK] Seq=1 Ack=26 Win=4380 Len=0</code></p><p>Everything is well until frame 173, where the client ACKs frame 170. But then, the server does not answer, which makes the client close the connection in frame 614.</p><p>The same thing happens in the second attempt.</p><p><del>So, currently everything points into the direction of the SMTP server. Maybe there is something in frame 173, that the server does not like, but we cannot see in the text output - like checksum errors, or the client ACKs the wrong number of bytes, etc., which in effect would make the embedded device the guilty party. Otherwise, it's the SMTP server (software, OS, security software on the systems, etc.).</del></p><p>According to the hint of <span><span><span><span>@mrEEde</span></span></span></span>, the client should send the HELO/EHLO after it received frame 170. However, it does not. It simply ACKs the data in frame 173 and then closes the connection in frame 614. So, the problem is (probably) within the SMTP library of the embedded devices or the software that uses the SMTP library.</p><p><del>We would need the real capture file to analyze that. If possible, please post the pcap file instead of a text file.</del></p><p>There isn't much we can analyze in the capture file. The best thing is to enable debugging on the embedded device or check the software logic if possible.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>01 May '14, 16:56</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>02 May '14, 00:47</strong> </span></p></div></div><div id="comments-container-32370" class="comments-container"><span id="32374"></span><div id="comment-32374" class="comment"><div id="post-32374-score" class="comment-score"></div><div class="comment-text"><p>the capture file was generated using the same computer the server is running on. Is that bad practice generally? And I will post the pcap file next week (sorry for the delay) but the computer with the server on it as well as my ARM device is unavailable until then.</p></div><div id="comment-32374-info" class="comment-info"><span class="comment-age">(01 May '14, 20:14)</span> <span class="comment-user userinfo">wes000000</span></div></div><span id="32378"></span><div id="comment-32378" class="comment"><div id="post-32378-score" class="comment-score">1</div><div class="comment-text"><p>"Everything is well until frame 173, where the client ACKs frame 170. But then, the server does not answer, which makes the client close the connection in frame 614." Wouldn't the next expected packet be the client's HELO packet?</p></div><div id="comment-32378-info" class="comment-info"><span class="comment-age">(01 May '14, 23:04)</span> <span class="comment-user userinfo">mrEEde</span></div></div><span id="32381"></span><div id="comment-32381" class="comment"><div id="post-32381-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>Wouldn't the next expected packet be the client's HELO packet?</p></blockquote><p>Ah, sure. It was very late when I answered the question. Thanks for the hint.</p><p>So, yes the client should send the HELO. As a result, it's a problem with the embedded smtp client, instead of the server as I said in my answer. Sorry for the confusion.</p></div><div id="comment-32381-info" class="comment-info"><span class="comment-age">(02 May '14, 00:36)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="32382"></span><div id="comment-32382" class="comment"><div id="post-32382-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>Is that bad practice generally?</p></blockquote><p>Not in general. Sometimes there is no other option than to capture on one of the involved systems. But sometimes you'll get false results, as in your case. We have had similar problems in other questions. Duplicate frames when captured on the server, but there was no common reason observable (yet). Could be a driver issue or some software on the capturing system (VPN, Firewall, IDS/IPS, Endpoint Security, etc.).</p><p>Anyway, please see the very good comment of <span></span><span>@mrEEde</span> and my comment above. The problem is most likely <strong>not the server</strong>, but the client, because it does not send the HELO/EHLO.</p></div><div id="comment-32382-info" class="comment-info"><span class="comment-age">(02 May '14, 00:41)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="32463"></span><div id="comment-32463" class="comment"><div id="post-32463-score" class="comment-score"></div><div class="comment-text"><p>Thank you guys for all the help! We are currently in the process of debugging and working with the client software and are in communication with the support team responsible for the third party smtp client and stack. Thanks again!</p></div><div id="comment-32463-info" class="comment-info"><span class="comment-age">(03 May '14, 17:19)</span> <span class="comment-user userinfo">wes000000</span></div></div></div><div id="comment-tools-32370" class="comment-tools"></div><div class="clear"></div><div id="comment-32370-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

