+++
type = "question"
title = "Matching GoP to another GoP to another GoP"
description = '''Hi, I have a scenario related to multiple GoPs I have a common attribute between GOP1 and GOP2, And another attribute is common to GOP2 and GOP3  How can I match the GOPs between three GOPS and group into a GoG Thanks'''
date = "2016-03-18T04:16:00Z"
lastmod = "2016-03-18T04:16:00Z"
weight = 51023
keywords = [ "mate" ]
aliases = [ "/questions/51023" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Matching GoP to another GoP to another GoP](/questions/51023/matching-gop-to-another-gop-to-another-gop)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-51023-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi,</p><p>I have a scenario related to multiple GoPs</p><p>I have a common attribute between GOP1 and GOP2, And another attribute is common to GOP2 and GOP3 How can I match the GOPs between three GOPS and group into a GoG</p><p>Thanks</p></div><div id="question-tags" class="tags-container tags">mate</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>18 Mar '16, 04:16</strong></p><img src="https://secure.gravatar.com/avatar/4a2a1ab8f8fa05aa1d21e5b43f767aae?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sshark&#39;s gravatar image" /><p>sshark<br />
<span class="score" title="6 reputation points">6</span><span title="6 badges"><span class="badge1">●</span><span class="badgecount">6</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="sshark has no accepted answers">0%</span></p></div></div><div id="comments-container-51023" class="comments-container"><span id="51024"></span><div id="comment-51024" class="comment"><div id="post-51024-score" class="comment-score"></div><div class="comment-text"><p>In my understanding,</p><pre><code>Gog mix {
    Member gop1 (attribute12);
    Member gop2 (attribute12, attribute23);
    Member gop3 (attribute23);
};</code></pre><p>should do the trick if your only issue is that attribute 12 does not exist in gop3 and attribute 23 does not exist in gop1, but both attribute12 and attribute23 are sufficiently unique, i.e. exactly one value of attribute12 matches exactly one value of attribute23.</p><p>Another trouble point is that if gop1 and gop3 would come first, and gop2 after them, you'd end up with two GoGs.</p></div><div id="comment-51024-info" class="comment-info"><span class="comment-age">(18 Mar '16, 04:46)</span> sindy</div></div><span id="51025"></span><div id="comment-51025" class="comment"><div id="post-51025-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your hints, unfortunately attribute12 in gop1 will have multi values and attribute23 in gop2 will have multi values. Will this cause any issues ?</p><p>Actual scenario gop1 = &gt; SIP gop2 =&gt; Diameter gop3 =&gt; RTP</p><p>SIP gives me the user for VoIP call, based on that I filter diameter. Diameter provides the RTP end point IP address</p></div><div id="comment-51025-info" class="comment-info"><span class="comment-age">(18 Mar '16, 05:44)</span> sshark</div></div><span id="51026"></span><div id="comment-51026" class="comment"><div id="post-51026-score" class="comment-score"></div><div class="comment-text"><p>It is clear that in general the attribute12 will have multiple values and attribute 23 will have multiple values, but the question is whether for two calls, you can have the same attribute 12 but different values of attribute23 (or vice versa). If yes, the above suggestion will not work, as already said but maybe not clearly enough.</p><p>But let's leave out the generalisation and talk about the real case, I would expect that SIP would use the RTP endpoint IP address returned by Diameter in the SDP it would send out, so I'd extract the RTP IP (or, even better, the whole socket) from there into the "sip_session" Gop. What am I missing?</p></div><div id="comment-51026-info" class="comment-info"><span class="comment-age">(18 Mar '16, 06:12)</span> sindy</div></div><span id="51028"></span><div id="comment-51028" class="comment"><div id="post-51028-score" class="comment-score"></div><div class="comment-text"><p>Let me describe in detail. Below is the architecture</p><pre><code>        OCS (Charging)
              |
              |
Handset ---- SBC ----- Core side
              |
              |
         Media Server</code></pre><p>Handset to SBC SIP packets are IPSec encrypted, SBC to OCS is diameter offline charging. SBC to Media Server is H248</p><p>I wanted to capture SIP, H248 and media flow from handset to Media Server, Media Server to Core side</p></div><div id="comment-51028-info" class="comment-info"><span class="comment-age">(18 Mar '16, 06:21)</span> sshark</div></div><span id="51029"></span><div id="comment-51029" class="comment"><div id="post-51029-score" class="comment-score"></div><div class="comment-text"><p>I'm not sure I understand what you wanted to say.</p><ul><li><p>if you cannot decrypt the UE to SBC SIP contents, how would you link it to the diameter packets,</p></li><li><p>you say you want to capture SIP between the UE and the SBC.</p></li></ul><p>Based on these two premises, I suppose you <em>can</em> capture decrypted UE &lt;-&gt; SBC SIP messages on a virtual interface of the IPsec tunnel.</p><p>Now:</p><ul><li><p>is the "media server" really a media <em>server</em>, i.e. the media contents for the UE originates there, or a media <em>proxy</em> (possibly with transcoding), i.e. the media pass through it between UE and the core?</p></li><li><p>is the SBC acting as a B2BUA or as a plain proxy, i.e. are the SIP call-IDs the same between the UE and the SBC and between the SBC and the core? I mean, can we have a single GoP for both SIP branches of the call or not?</p></li></ul><p>What also confuses me is that before you were talking about RTP and now you are talking about H.248. Nevertheless, the RTP socket (to be) used at the media server seems to be the only common piece of information between all the four protocols (so the only candidate for a GoG key), as I suppose nothing else is inherited from SIP to H.248. So I would extract the media sockets from the SDPs sent (but not received) by the SBC (as these point to the media servers) in the sip Pdus.</p></div><div id="comment-51029-info" class="comment-info"><span class="comment-age">(18 Mar '16, 06:54)</span> sindy</div></div><span id="51030"></span><div id="comment-51030" class="comment not_top_scorer"><div id="post-51030-score" class="comment-score"></div><div class="comment-text"><p>Apologies for not making it clear, let me try again</p><p>Handset to SBC - I cannot decode SIP message, however the charging diameter interface will give the handset IP (I can also fetch source IP from ESP packets). Using this IP, I can see RTP packets from handset to media server, which is not encrypted. Towards the core network SIP and RTP is not encrypted</p><p>Media server actually does process media - transcoding/mixing etc SBC is a B2BUA</p></div><div id="comment-51030-info" class="comment-info"><span class="comment-age">(18 Mar '16, 07:10)</span> sshark</div></div><span id="51031"></span><div id="comment-51031" class="comment not_top_scorer"><div id="post-51031-score" class="comment-score"></div><div class="comment-text"><p>Cool. So we do not have a media <em>socket</em> but only media IP, and even this only because we suppose that the UE uses a common IP for signalling and media (I was wondering what does Diameter have to do with media IP but I believed you were using it is a kind of database interface so I thought it would be the local media address, not the remote one).</p><p>So:</p><ul><li><p>we actually do not have the UE&lt;-&gt;SBC SIP at all, so B2BUA or proxy doesn't matter.</p></li><li><p>we have the user ID from the SIP captured at core side, which we can use to pair the SIP Gop with the Diameter Gop, and on the timeline, we get the SIP Gop first (for both outgoing calls from the UE and incoming calls to the UE). The user ID is our attribute12.</p></li><li><p>from the Diameter Gop, we get the UE IP (attribute23) which we should see in the H.248 and RTP as the remote address.</p></li></ul><p>So even if there was no other issue, already due to the fact that we do not have the complete media <em>socket</em> but only the <em>IP address</em> we must believe that the UEs are not behind a NAT so that we wouldn't see more than one UE behind a single IP, and also that an UE is not allowed to make more than a single call at a time (i.e. no call hold).<br />
</p><p>If the requirements above are fulfilled (each remote IP matches exactly one user ID and the sessions of this unique tuple do not overlap in time), the initial idea should work.</p><p>If they are not, there is no way to properly associate the SIP session with the H.248 control exchange and RTP flow by principle, as you have no piece of information allowing you to distinguish different calls from each other (in case of sessions overlapping in time) and no piece of information allowing you to tell two UEs behind the same NAT from each other.</p></div><div id="comment-51031-info" class="comment-info"><span class="comment-age">(18 Mar '16, 07:42)</span> sindy</div></div><span id="51060"></span><div id="comment-51060" class="comment not_top_scorer"><div id="post-51060-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your inputs, I have few questions</p><ol><li><p>I do not have any condition for RTP GoP start/stop hence end up with multiple values. Because I want to capture RTP from UE to Media server and vice versa, How can I do that ? Can you suggest sample RTP GoP</p></li><li><p>UEs are not behind NAT in our solution, so all UEs will have unique IP and user</p></li></ol></div><div id="comment-51060-info" class="comment-info"><span class="comment-age">(21 Mar '16, 05:30)</span> sshark</div></div><span id="51062"></span><div id="comment-51062" class="comment not_top_scorer"><div id="post-51062-score" class="comment-score"></div><div class="comment-text"><p>The least important one, from the wiki: If no Gop Stop is defined, the Gop is Stopped by the same PDU by which it is started.</p><p>The first RTP packet should contain a marker, but it is only true for audio codecs and not reliable either, some implementations do not send it and if silence suppression is used, there may be multiple markers in a single RTP flow. The last packet is not identified at all.</p><p>So your only possibility is to use the UE side IP address and both ports as RTP GoP key and use the GoP timers to limit the time after the last PDU during which another one with the same key will still be added to the old Gop. While the port at UE side may be the same for two subsequent calls, it is highly unlikely that the media proxy side port would be re-used as well. Into the GoG key, you need to use only the UE side IP address. Because it is the <code>ip.dst</code> for one RTP direction and <code>ip.src</code> for the other one, you'll have to either extract <code>ip.addr</code> from the RTP packets and then erase the local side IP address(es) using a Transform, either already from the RTP PDUs or latest from the RTP Gops, or you would have to define "incoming" and "outgoing" RTP PDUs and extract from them <code>ip.src</code> or <code>ip.dst</code>. In either case, your mate configuration needs to contain the list of media proxy's IP addresses to be ignored.</p></div><div id="comment-51062-info" class="comment-info"><span class="comment-age">(21 Mar '16, 05:56)</span> sindy</div></div><span id="51086"></span><div id="comment-51086" class="comment not_top_scorer"><div id="post-51086-score" class="comment-score"></div><div class="comment-text"><p>Thanks again for your valuable inputs. Can you guide me in below points</p><ol><li><p>How to use the GoP timers to limit the exposure of capturing unwanted PDUs. Can you give an example or web source I can check this</p></li><li><p>MATE does not have capability to check existing attributes and not to keep on Extracting the same value, creating multiple iterations of same attribute value ?</p></li><li><p>For me to ignore the media proxy IPs, can i use subnets instead of individual IPs ?</p></li></ol></div><div id="comment-51086-info" class="comment-info"><span class="comment-age">(22 Mar '16, 06:43)</span> sshark</div></div><span id="51092"></span><div id="comment-51092" class="comment not_top_scorer"><div id="post-51092-score" class="comment-score"></div><div class="comment-text"><ol><li><p>Although I've recently ventured to update the <a href="https://wiki.wireshark.org/Mate">MATE wiki</a>, I haven't collected any practical experience with many of its aspects yet. And I don't think anyone has ever published any examples using the "new" syntax ("new" because it is about 10 years old by now). So please have a look at the <a href="https://wiki.wireshark.org/Mate/Reference#Gop_declaration_block_header">Gop definition at the wiki</a> and try to understand the meaning of those three timers.</p></li><li><p><code>Extract</code> only works at the Pdu level, which means the extraction is done just once for each individual "real" PDU (a single captured <em>frame</em> may contain several PDUs). But during this one-shot extraction, <em>all</em> instances of the required protocol field which occur in the PDU are extracted. You cannot prevent them from being Extracted, but what you <em>can</em> do is to remove the unnecessary ones using Transform. Gop behaves different, each additional Pdu contributing to it may extend the Gop's AVPL, but remember that if an AVP on the PDU's AVPL exactly matches (i.e. both name and value are the same) an AVP the Gop's AVPL, it will not be added again. Any (attribute name, attribute value) pair may exist only once in any AVPL by definition. Each MATE Pdu object matches exactly one real PDU and has its own individual AVPL; each Gop has a single AVPL which is built from the AVPLs of the contributing Pdus, preserving the uniqueness of each AVP.</p></li><li><p>MATE converts all protocol field values to text strings. So in MATE AVP match notation, a display filter rule <code>ip.addr == 192.168.123.0/24</code> is, quite simply, <code>ip_addr^"192.168.123."</code>; however, <code>ip.addr == 192.168.123.0/25</code> becomes a multi-line nightmare of exact matches (as no wildcard character or even regexp seems to be supported, so <code>ip.addr^"192.168.123.[0-9]"</code> does not work). So have a thorough look at the difference between processing of individual <code>Match</code> clauses declared within a <code>Transform</code> and processing of the list of <code>Transforms</code> which is a parameter of the <code>Transform</code> clause inside a Pdu or Gop declaration, and then decide what is the best way to define the media proxy addresses to be erased from the PDUs' AVPLs. If you cannot match a whole /8, /16 or /24 subnet, it may be less confusing to use <code>ip_addr {"192.168.123.5"|"192.168.123.6"|"192.168.123.7"}</code>.</p></li></ol></div><div id="comment-51092-info" class="comment-info"><span class="comment-age">(22 Mar '16, 07:54)</span> sindy</div></div><span id="51276"></span><div id="comment-51276" class="comment not_top_scorer"><div id="post-51276-score" class="comment-score"></div><div class="comment-text"><p>Ok, I am trying to use the timer clauses into the GoPs (e.g.Lifetime) and wireshark complains syntax error. Looks like the syntax is not valid</p><p>How can I get help if some MATE syntax which are documented is not working ?</p></div><div id="comment-51276-info" class="comment-info"><span class="comment-age">(29 Mar '16, 21:47)</span> sshark</div></div><span id="51277"></span><div id="comment-51277" class="comment not_top_scorer"><div id="post-51277-score" class="comment-score"></div><div class="comment-text"><p>You cannot unless you can read the MATE C sources better than me (as I was translating the C sources into Wiki about a month ago). Please send me your MATE code and a matching capture, I'll give you my address in the next comment which I will delete as soon as I get a confirmation e-mail message from you.</p></div><div id="comment-51277-info" class="comment-info"><span class="comment-age">(29 Mar '16, 21:52)</span> sindy</div></div><span id="51299"></span><div id="comment-51299" class="comment not_top_scorer"><div id="post-51299-score" class="comment-score"></div><div class="comment-text"><p>That's the everlasting issue with writing documentation: should it repeat every bit of information many times to support Ctrl-F based reading, or should it be as brief as possible in order not to to discourage people from reading it completely?</p><p>In particular: in the PDU section of the reference manual, I've written:</p><blockquote><p>The complete declaration of a PDU looks as below; the <strong>mandatory</strong> order of the diverse clauses is as shown.</p></blockquote><p>(the word mandatory is highlighted only here so far)</p><p>But I forgot to copy-paste that into the Gop declaration section, and as there is no obvious reason why the order of the clauses should be fixed, you've declared the <code>Lifetime</code> before <code>Extra</code>. I don't even think there is a <em>non-obvious</em> reason other than simplification of the configuration parser code, but this is how MATE's configuration parser is currently implemented and I can only document it, not change it.</p></div><div id="comment-51299-info" class="comment-info"><span class="comment-age">(30 Mar '16, 11:51)</span> sindy</div></div></div><div id="comment-tools-51023" class="comment-tools"><span class="comments-showing"> showing 5 of 14 </span> <a href="#" class="show-all-comments-link">show 9 more comments</a></div><div class="clear"></div><div id="comment-51023-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

