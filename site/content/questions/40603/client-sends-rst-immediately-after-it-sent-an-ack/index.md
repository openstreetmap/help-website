+++
type = "question"
title = "Client sends RST immediately after it sent an ACK"
description = '''I am having some issues with a fleet of devices that connects to the Internet through GPRS. These location devices send information about the position of the vehicles on the fleet in a regular basis. The problem is that from time to time, some of the devices enter in a weird TCP loop. They try to es...'''
date = "2015-03-16T02:15:00Z"
lastmod = "2015-03-16T03:08:00Z"
weight = 40603
keywords = [ "rst", "handshake", "client", "tcp" ]
aliases = [ "/questions/40603" ]
osqa_answers = 0
osqa_accepted = true
+++

<div class="headNormal">

# [Client sends RST immediately after it sent an ACK](/questions/40603/client-sends-rst-immediately-after-it-sent-an-ack)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-40603-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I am having some issues with a fleet of devices that connects to the Internet through GPRS. These location devices send information about the position of the vehicles on the fleet in a regular basis. The problem is that from time to time, some of the devices enter in a weird TCP loop. They try to establish a TCP connection using the 3-way handshake but this is what I see on the server side:</p><p>Server &lt;- Client SYN</p><p>Server -&gt; Client SYN-ACK</p><p>Server &lt;- Client ACK</p><p>Server &lt;- Client RST</p><p>The final RST is sent immediately after the ACK.</p><p>The network is something like this: Device(GPRS) - NAT Router - Internet - Firewall - NAT Router - Server</p><p>I cannot see what is really happening in the client side (i.e., the devices).</p><p>This is turning out into a big problem because all the devices which enter this loop, eat their data communications.</p><p>Any help regarding these behaviour will be really appreciated. I have a capture if this could provide more information.</p></div><div id="question-tags" class="tags-container tags">rst handshake client tcp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>16 Mar '15, 02:15</strong></p><img src="https://secure.gravatar.com/avatar/187c7d12f03ca50975799665bcf5326d?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Javier%20Ruiz&#39;s gravatar image" /><p>Javier Ruiz<br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Javier Ruiz has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 16 Mar '15, 02:56</p><img src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="grahamb&#39;s gravatar image" /><p>grahamb ♦<br />
<span class="score" title="19834 reputation points"><span>19.8k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">●</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">●</span><span class="badgecount">206</span></span></p></div></div><div id="comments-container-40603" class="comments-container"><span id="40604"></span><div id="comment-40604" class="comment"><div id="post-40604-score" class="comment-score"></div><div class="comment-text"><p>Can you post an example trace, e.g. on www.cloudshark.org? Sanitize it with TraceWrangler (<a href="https://www.tracewrangler.com">https://www.tracewrangler.com</a>) if you need to - for a problem like this it's probably enough to see the TCP headers.</p></div><div id="comment-40604-info" class="comment-info"><span class="comment-age">(16 Mar '15, 02:26)</span> Jasper ♦♦</div></div><span id="40605"></span><div id="comment-40605" class="comment"><div id="post-40605-score" class="comment-score"></div><div class="comment-text"><p>I have upload the capture to: <a href="https://www.cloudshark.org/captures/8f83272d4cb9">https://www.cloudshark.org/captures/8f83272d4cb9</a></p><p>Using these filter provides an easy example of what happens to a device: ip.src == 190.239.66.197 || ip.dst == 190.239.66.197 Btw, thx for the quick answer, Jasper.</p></div><div id="comment-40605-info" class="comment-info"><span class="comment-age">(16 Mar '15, 02:35)</span> Javier Ruiz</div></div><span id="40609"></span><div id="comment-40609" class="comment"><div id="post-40609-score" class="comment-score"></div><div class="comment-text"><p>Can you also make a trace on the Internet side of the FW and between the FW and the NAT router? Is the client really using the same port for each connection or is that caused by the FW of NAT router?</p></div><div id="comment-40609-info" class="comment-info"><span class="comment-age">(16 Mar '15, 03:16)</span> SYN-bit ♦♦</div></div><span id="40611"></span><div id="comment-40611" class="comment"><div id="post-40611-score" class="comment-score"></div><div class="comment-text"><p>I have no control on the client side more than configuring the devices OTA. I can change the port range using an script but I have no idea how the NAT router translate this afterwards. (Btw, I set a single port because the manufacturer asked me to do so, because my first intention was to set a wide range.)</p></div><div id="comment-40611-info" class="comment-info"><span class="comment-age">(16 Mar '15, 03:26)</span> Javier Ruiz</div></div></div><div id="comment-tools-40603" class="comment-tools"></div><div class="clear"></div><div id="comment-40603-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="40608"></span>

<div id="answer-container-40608" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-40608-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>The one thing that seems odd is that the client keeps reusing the same port number. This is not always a problem, but in your case, it is doing it repeatedly within less than 2 seconds after the previous connection. This might confuse the application and lead to a socket close. Can you check if you can force the clients to use different ports each time to see if this helps? Or, if you have access to it, check how the code of the application on the client handles connections that use the exact same socket pair than the previous one?</p><p>Also, you might want to check what the differences are when the connections are working. Maybe you can see that they use different ports on the client side each time?</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>16 Mar '15, 03:08</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-40608" class="comments-container"><span id="40610"></span><div id="comment-40610" class="comment"><div id="post-40610-score" class="comment-score"></div><div class="comment-text"><p>I will change the configuration of the devices to open the port range, as this is the only control I have over them. The provider of the devices told me that they connected to the Internet through a NAT router which obviously changes IP and port to public values. Once I have tested this new configuration I will tell you if it works. Thx</p></div><div id="comment-40610-info" class="comment-info"><span class="comment-age">(16 Mar '15, 03:18)</span> Javier Ruiz</div></div><span id="40617"></span><div id="comment-40617" class="comment"><div id="post-40617-score" class="comment-score"></div><div class="comment-text"><p>One question about opening the port range. If I do so, assuming there is a NAT router between the devices and the Internet, how these new range will be translated in the NAT router? I mean, if IP 1 port 1 is translated into IP 11 port 11, would be IP 1 port 3 translated into IP 11 port 33, for example?</p></div><div id="comment-40617-info" class="comment-info"><span class="comment-age">(16 Mar '15, 09:26)</span> Javier Ruiz</div></div><span id="40618"></span><div id="comment-40618" class="comment"><div id="post-40618-score" class="comment-score"></div><div class="comment-text"><p>That depends on the NAT strategy of the router. Some just increment the port for each new connection, others try to keep the original as long as it doesn't colide with an existing port, and then there are some that just randomize ports. Everything is kept in a NAT table, so the router knows what external ip/port pair belongs to which internal pair.</p></div><div id="comment-40618-info" class="comment-info"><span class="comment-age">(16 Mar '15, 09:34)</span> Jasper ♦♦</div></div><span id="40619"></span><div id="comment-40619" class="comment"><div id="post-40619-score" class="comment-score"></div><div class="comment-text"><p>Jasper explained the working of a masquerading NAT device, which I assume is used in the client setup.</p><p>I assume you have control of the server side of things. What is the NAT policy on the Firewall and on the NAT router on the server side? It does not need to translate the source address/port I assume, just the destination IP address. Is it configured to do a static NAT?</p><p>It would help if you can explain the server side of things a bit more and preferably add traces (as mentioned in a comment to the question).</p></div><div id="comment-40619-info" class="comment-info"><span class="comment-age">(16 Mar '15, 09:42)</span> SYN-bit ♦♦</div></div><span id="40712"></span><div id="comment-40712" class="comment"><div id="post-40712-score" class="comment-score"></div><div class="comment-text"><p>Finally this seems to be the answer to my problem. I made the change remotely to the devices and the situation has been stabilized. Thanks everybody for the support.</p></div><div id="comment-40712-info" class="comment-info"><span class="comment-age">(20 Mar '15, 01:08)</span> Javier Ruiz</div></div></div><div id="comment-tools-40608" class="comment-tools"></div><div class="clear"></div><div id="comment-40608-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

