+++
type = "question"
title = "Connections to remote server just stall - Seq mismatch?"
description = '''I have an issue I can’t quite figure out. Clients on my network connect to a terminal server on a remote network via a terminal emulator for Windows and perform the normal operations end-users do, but their sessions stall after seemingly random amounts of time (anywhere from 30 seconds to 4 hours). ...'''
date = "2011-11-24T00:05:00Z"
lastmod = "2011-11-24T13:53:00Z"
weight = 7595
keywords = [ "ack", "terminal", "stall", "remote", "sequence" ]
aliases = [ "/questions/7595" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Connections to remote server just stall - Seq mismatch?](/questions/7595/connections-to-remote-server-just-stall-seq-mismatch)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-7595-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I have an issue I can’t quite figure out. Clients on my network connect to a terminal server on a remote network via a terminal emulator for Windows and perform the normal operations end-users do, but their sessions stall after seemingly random amounts of time (anywhere from 30 seconds to 4 hours). They are left staring at a blank terminal emulator screen and have to force-close the application instance. I checked for any issues with our firewall concerning ACLs or IPS dropping connections, I checked the local Windows firewalls running on the clients’ workstations, I disabled TCP offloading for Windows 7 to check for compatibility, and then I set up Windows XP Pro workstations with local firewalls disabled, and all the logs are empty. I even checked the terminal emulator application for issues, but again the logs are empty, and the same problem still occurs.</p><p>I did A Wireshark packet capture and see the same pattern on every workstation right before the connection stalls: the server sends a client a packet, the client receives the packet and properly increments the Ack number and sends it off to the server, and then the server replies with a Seq that is 100 bytes less than the correct length. The client then responds Ack with the proper number, and the server again responds with the Seq that is 100 bytes less in length. This occurs a few times, and then the connections stalls. Sometimes it is reset automatically, and sometimes nothing happens until the user hits the Disconnect button in the terminal emulator and a FIN packet is successfully sent. But no other data packets are sent in the meantime.</p><p>Here’s output from a real capture (IPs are modified):</p><p>372 2011-11-22 10:39:14.350000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 944 orbixd &gt; 16936 [PSH, ACK] Seq=25305 Ack=1675 Win=36060 Len=890</p><p>373 2011-11-22 10:39:14.550000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 54 16936 &gt; orbixd [ACK] Seq=1675 Ack=26195 Win=63970 Len=0</p><p>374 2011-11-22 10:46:10.833333 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 60 orbixd &gt; 16936 [ACK] Seq=26095 Ack=1675 Win=36060 Len=0</p><p>375 2011-11-22 10:46:10.833333 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 54 [TCP Dup ACK 373#1] 16936 &gt; orbixd [ACK] Seq=1675 Ack=26195 Win=63970 Len=0</p><p>376 2011-11-22 10:56:19.883333 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 60 orbixd &gt; 16936 [ACK] Seq=26095 Ack=1675 Win=36060 Len=0</p><p>377 2011-11-22 10:56:19.883333 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 54 [TCP Dup ACK 373#2] 16936 &gt; orbixd [ACK] Seq=1675 Ack=26195 Win=63970 Len=0</p><p>378 2011-11-22 11:06:28.950000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 60 orbixd &gt; 16936 [ACK] Seq=26095 Ack=1675 Win=36060 Len=0</p><p>379 2011-11-22 11:06:28.950000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 54 [TCP Dup ACK 373#3] 16936 &gt; orbixd [ACK] Seq=1675 Ack=26195 Win=63970 Len=0</p><p>380 2011-11-22 11:16:38.350000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 60 orbixd &gt; 16936 [ACK] Seq=26095 Ack=1675 Win=36060 Len=0</p><p>381 2011-11-22 11:16:38.350000 201.xxx.xxx.xxx 201.xxx.xxx.xxx TCP 54 [TCP Dup ACK 373#4] 16936 &gt; orbixd [ACK] Seq=1675 Ack=26195 Win=63970 Len=0</p><p>And then it stalls.</p><p>Sometimes this pattern occurs, but the server eventually responds with the correct Seq number and transmission resumes, and the program slows down during this time.</p><p>I do not have access to the remote server or anything on its network; it is our ISP’s, so I can only troubleshoot on my end. Of course I got the obligatory “The problem is on your end” answer when I brought up the issue. If it is, fine; I just want it fixed.</p><p>Does anyone know the cause of this or have a hunch? Can a Sequence mismatch do this, or am I overlooking something? Is it a problem on the remote server side? Is it a buffering issue? An MTU mismatch? I do know this has a pattern of happening a lot in the morning and then lessens substantially in the afternoon.</p><p>Thanks in advance for any input!</p></div><div id="question-tags" class="tags-container tags">ack terminal stall remote sequence</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>24 Nov '11, 00:05</strong></p><img src="https://secure.gravatar.com/avatar/9e3c41e852874b220f0922904fc4ada4?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Yellowninja&#39;s gravatar image" /><p>Yellowninja<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="bronze">●</span><span class="badgecount">1</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Yellowninja has no accepted answers">0%</span></p></div></div><div id="comments-container-7595" class="comments-container"><span id="7597"></span><div id="comment-7597" class="comment"><div id="post-7597-score" class="comment-score"></div><div class="comment-text"><p>First thing i notice is that there is a nearly constant 10 minute delta between those packets - kind of looks to me like a customized TCP keepalive, where the machine sends this minus 100 Seq number to make the other side trigger the Ack and maybe by this implementing connection keepalive.</p><p>Whats not so clear is why the tcp.len is zero in those packets, because normally I'd send at least one Byte to really trigger an ACK from the other side, but in your case the other side's stack even reacts to zero byte payload TCP packets with Acks.</p><p>What are your thoughts about that?</p></div><div id="comment-7597-info" class="comment-info"><span class="comment-age">(24 Nov '11, 00:21)</span> Landi</div></div><span id="7603"></span><div id="comment-7603" class="comment"><div id="post-7603-score" class="comment-score"></div><div class="comment-text"><p>These clients always send back an Ack after receiving a packet, even if it has no payload. The Len of 0 is odd, but they happen quite frequently and always contain the correct Seq until right before the stall.</p><p>I also noticed the remote server sends out Window Update packets every minute or so even though every packet contains the PSH flag and it appears buffers are never full.</p></div><div id="comment-7603-info" class="comment-info"><span class="comment-age">(24 Nov '11, 00:45)</span> Yellowninja</div></div><span id="7606"></span><div id="comment-7606" class="comment"><div id="post-7606-score" class="comment-score"></div><div class="comment-text"><p>Do the connections only stall when clients are idle like in the trace snippet you posted or even when the clients are actively communicating ?</p></div><div id="comment-7606-info" class="comment-info"><span class="comment-age">(24 Nov '11, 01:31)</span> Landi</div></div><span id="7611"></span><div id="comment-7611" class="comment"><div id="post-7611-score" class="comment-score"></div><div class="comment-text"><p>They stall while actively communicating, too. I have dozens of captured sessions, and a good half are during active sessions, and I've seen the issue in real time from the end-user's perspective. They load up a screen, hit a command, and then it stalls.</p></div><div id="comment-7611-info" class="comment-info"><span class="comment-age">(24 Nov '11, 09:52)</span> Yellowninja</div></div><span id="7613"></span><div id="comment-7613" class="comment"><div id="post-7613-score" class="comment-score"></div><div class="comment-text"><p>Well now things get really interesting... I'm just thinking for patterns, like:</p><ul><li>Do those minus 100 bytes Seq Nr. packets ONLY occur right before a stalling session?</li><li>Could you check the IP headers of the regarding packets if there is a packet without DF bit set ?</li><li>do you have any idea why the timestamps of so many packets match exactly ? where did you capture the traffic?</li><li>could you provide absolute sequence numbers to check whether this might occur on special events (like seq.nr. overflow) ?</li></ul><p>If cou can provide another anonymized sample trace on cloudshark e.g. I'd like to look at it</p></div><div id="comment-7613-info" class="comment-info"><span class="comment-age">(24 Nov '11, 10:17)</span> Landi</div></div><span id="7635"></span><div id="comment-7635" class="comment not_top_scorer"><div id="post-7635-score" class="comment-score"></div><div class="comment-text"><p>Ok, in response to your points:</p><p>1) Those minus 100 byte Seq. packets occur when the connection stalls, and a couple of times they occur in the same pattern, but the server eventually responds with the right Seq number and transmission resumes. The vast majority of the time results in the stall. The minus 100 byte Seq. packets do not occur at any other time.</p><p>2) The DF flag is set on all packets originating from the client but not on any originating from the remote server.</p><p>3) I don't know about the timestamps--seems to be some kind of burst.</p><p>4) I'll post on cloudshark as soon as I can.</p></div><div id="comment-7635-info" class="comment-info"><span class="comment-age">(25 Nov '11, 12:32)</span> Yellowninja</div></div></div><div id="comment-tools-7595" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-7595-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="7616"></span>

<div id="answer-container-7616" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-7616-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>Sounds to me like there is a device that performs sequence number translations on the packets. Most firewall do "Initial Sequence Number Randomization" to protect old TCP/IP implementations that did not choose a random initial sequence number.</p><p>Do you have traces at both sides (client and server) of the connection? How do the sequence numbers look on the server side (as I believe from the trace snippet that it was made on the client side). If it is not possible to capture on the server side, are you able to capture on the public side of your own FW?</p><p>Also, what TCP options are used? Is SACK used? Or maybe it is initiated, but masked by an intermediate FW. The packets should say it all, so if you could post a tracefile on <a href="http://www.cloudshark.org">www.cloudshark.org</a> with the IP addresses anonimized and the TCP payload stripped (you can use <a href="http://bittwist.sourceforge.net/">Bittwiste</a> for that), that would be really helpful :-)</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>24 Nov '11, 13:53</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div></div><div id="comments-container-7616" class="comments-container"><span id="7666"></span><div id="comment-7666" class="comment"><div id="post-7666-score" class="comment-score"></div><div class="comment-text"><p>I only have a trace at client side since I don't have access to server side (different company), and I removed the relative sequence number and the real sequence numbers are showing same trend of 100 bytes off on server Seq.</p><p>I stripped the payload and uploaded it here: http://www.cloudshark.org/captures/ed43d82e8a41</p><p>Let me know if you have trouble with it now that all packets are Len=0 and Wireshark added in all sorts of Dup Packet messages now. The last ones are, of course, the problem packets.</p><p>Thanks again :)</p></div><div id="comment-7666-info" class="comment-info"><span class="comment-age">(27 Nov '11, 23:14)</span> Yellowninja</div></div><span id="7669"></span><div id="comment-7669" class="comment"><div id="post-7669-score" class="comment-score"></div><div class="comment-text"><p>Thank you for posting the tracefile. It shows that SACK was not used for this TCP stream. Bittwiste has done a more thorough job than I expected, not only did it strip the payload, it also changed the length field in the IP header, resulting in a TCP len of 0, which makes the file quite difficult to read. Sorry, my fault, should have checked the working of the -L option myself first.</p></div><div id="comment-7669-info" class="comment-info"><span class="comment-age">(28 Nov '11, 01:45)</span> SYN-bit ♦♦</div></div><span id="7670"></span><div id="comment-7670" class="comment"><div id="post-7670-score" class="comment-score"></div><div class="comment-text"><p>However, combined with the output you already posted, makes it more clear that something goes wrong somewhere along the path to the server. Are you able to make a connection from another network too? So you can determine if it is something in your network messing up? Also, can you make a trace on the outside of your FW? The best would be to make a trace at the demarcation point of your network. That way you can determine if the problem is caused by a device under your control or by a device out of your control.</p></div><div id="comment-7670-info" class="comment-info"><span class="comment-age">(28 Nov '11, 01:47)</span> SYN-bit ♦♦</div></div><span id="7674"></span><div id="comment-7674" class="comment"><div id="post-7674-score" class="comment-score"></div><div class="comment-text"><p>I do not have the ability to try it from a different network since this server is housed at our ISP, and only public IPs from their block are allowed. We are connected with AT&amp;T CSME, so the only hops are my router on this side and their router then server. I can't see it being something on AT&amp;T's side since I suspect I would see this type of issue on all traffic. I will hook up a switch beyond our router and see what happens.</p><p>Thanks again.</p></div><div id="comment-7674-info" class="comment-info"><span class="comment-age">(28 Nov '11, 07:49)</span> Yellowninja</div></div></div><div id="comment-tools-7616" class="comment-tools"></div><div class="clear"></div><div id="comment-7616-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

