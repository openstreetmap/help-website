+++
type = "question"
title = "Network sniffing - promiscuous vs. monitor modes"
description = '''Hi all, Here is what I want to do, and the solutions I considered. Project : Sniff packets from my local network to identify DNS queries, store them in a plain database with host IP, timestamp and URL as attributes. Solution 1 - Promiscuous mode : I want to sniff only one network at a time, and sinc...'''
date = "2016-09-09T08:30:00Z"
lastmod = "2016-09-11T06:09:00Z"
weight = 55437
keywords = [ "sniffing", "capture", "capture-filter", "sniff", "decryption" ]
aliases = [ "/questions/55437" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Network sniffing - promiscuous vs. monitor modes](/questions/55437/network-sniffing-promiscuous-vs-monitor-modes)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-55437-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi all,</p><p>Here is what I want to do, and the solutions I considered.</p><p><strong>Project :</strong> Sniff packets from my local network to identify DNS queries, store them in a plain database with host IP, timestamp and URL as attributes.</p><p><strong>Solution 1 - Promiscuous mode :</strong> I want to sniff only one network at a time, and since it is my own, the ideal solution would be to be connected to the network but capture every packet even if directed to some other IP. As far as I understand, this is called <em>promiscuous mode</em>, but it does not seem to work with my adapter (internal wifi card or external dongle). For instance, when starting a <em>Wireshark</em>/<em>tshark</em> capture, I am not able to sniff packets from/to different IP than mine (except broadcast). Obviously, everything directed from/to is captured.</p><p><strong>Solution 2 - Monitor mode :</strong> My wifi adapters can be switched to <em>monitor mode</em> (scan everything on the channel). Then, if I can sniff every packet on the channel (if possible with wlan capture filter to get rid off packets which do not belong to my network) and decrypt them on the fly, it would do the trick. But I am struggling with the decryption part... Of course I followed the wiki steps (<a href="https://wiki.wireshark.org/HowToDecrypt802.11">https://wiki.wireshark.org/HowToDecrypt802.11</a>), tried with <em>wpa-psk</em> and <em>wpa-pwd</em>, without success. My first thought was that, since I sniff a whole channel, packets may not be decrypted correctly, and Wireshark would think it is better not to apply decryption. Is this behaviour normal ? However, I am able to decrypt the traffic from the pcap file of this tutorial : <a href="http://www.lovemytool.com/blog/2010/05/wireshark-and-tshark-decrypt-sample-capture-file-by-joke-snelders.html">http://www.lovemytool.com/blog/2010/05/wireshark-and-tshark-decrypt-sample-capture-file-by-joke-snelders.html</a>. Thus, I am sure that <em>Wireshark</em> is able to decrypt and that I do the right thing. Then, either it is the wifi adapter fault (is it possible ?) or the way I proceed to filter my packets...</p><p>Every suggestion is appreciated. And, by the way, I am more likely to use <em>tshark</em> than <em>Wireshark</em>, so command lines are welcome.</p><p>C.</p></div><div id="question-tags" class="tags-container tags">sniffing capture capture-filter sniff decryption</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>09 Sep '16, 08:30</strong></p><img src="https://secure.gravatar.com/avatar/dab41ea1672caeca62b75b631c59123a?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="thefiercerabbit&#39;s gravatar image" /><p>thefiercerabbit<br />
<span class="score" title="11 reputation points">11</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="thefiercerabbit has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 09 Sep '16, 08:36</p></div></div><div id="comments-container-55437" class="comments-container"></div><div id="comment-tools-55437" class="comment-tools"></div><div class="clear"></div><div id="comment-55437-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="55438"></span>

<div id="answer-container-55438" class="answer answered-by-owner">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-55438-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>It's like when you take an appointment to your doctor because you're sick, and before you can get there you are already healed ! I should have been more careful. Quoting from <a href="https://wiki.wireshark.org/HowToDecrypt802.11">https://wiki.wireshark.org/HowToDecrypt802.11</a>.</p><p><em>WPA and WPA2 use keys derived from an EAPOL handshake, which occurs when a machine joins a Wi-Fi network, to encrypt traffic. Unless all four handshake packets are present for the session you're trying to decrypt, Wireshark won't be able to decrypt the traffic. You can use the display filter eapol to locate EAPOL packets in your capture. In order to capture the handshake for a machine, you will need to force the machine to (re-)join the network while the capture is in progress. One way to do this is to put the machine to sleep (for smartphones and tablets, "turning off" the machine puts it to sleep) before you start the capture, start the capture, and then wake the machine up. You will need to do this for all machines whose traffic you want to see. WPA and WPA2 use individual keys for each device. Older versions of Wireshark may only be able to use the most recently calculated session key to decrypt all packets. Therefore, when several devices have attached to the network while the trace was running, the packet overview shows all packets decoded, but in the detailed packet view, only packets of the last device that activated ciphering are properly deciphered. Newer Wireshark versions are able to handle up to 256 associations and should be able to decode any packets all the time. Nevertheless decoding can still fail if there are too many associations. Filtering out only the relevant packets (e.g. with "wlan.addr") and saving into a new file should get decryption working in all cases. Wireshark only frees used associations when editing keys or when it's closed. So you may try that when decoding fails for unknown reasons. This also allows you to decode files without any eapol packets in it, as long as Wireshark did see the eapol packets for this communication in another capture after the last start and key edit. If decoding suddenly stops working make sure the needed eapol packetes are still in it.</em></p><p>I guess both solutions 1 and 2 are affected by the fact I did not capture <em>EAPOL</em> handshake first. Then, even if the promiscuous mode works, I have to wait the handshake for each host.</p><p>Some more tests are now necessary to know if this is enough to decrypt DNS queries...</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>09 Sep '16, 08:51</strong></p><img src="https://secure.gravatar.com/avatar/dab41ea1672caeca62b75b631c59123a?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="thefiercerabbit&#39;s gravatar image" /><p>thefiercerabbit<br />
<span class="score" title="11 reputation points">11</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="thefiercerabbit has no accepted answers">0%</span></p></div></div><div id="comments-container-55438" class="comments-container"><span id="55468"></span><div id="comment-55468" class="comment"><div id="post-55468-score" class="comment-score"></div><div class="comment-text"><p>Okay, now that I've finally finished my project, here is a link to the code.</p><p>This version only print the sniffed DNS traffic and the DHCP packets (to figure out when a client has joined to the network, etc...). The traffic can only be decrypted if the EAPOL packets have been captured before.</p><p>Remember to be in <em>monitor mode</em> and to have correctly set the channel.</p><p>Link : <a href="https://github.com/thefiercerabbit/dns-sniffer">https://github.com/thefiercerabbit/dns-sniffer</a></p></div><div id="comment-55468-info" class="comment-info"><span class="comment-age">(11 Sep '16, 04:26)</span> thefiercerabbit</div></div></div><div id="comment-tools-55438" class="comment-tools"></div><div class="clear"></div><div id="comment-55438-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="55469"></span>

<div id="answer-container-55469" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-55469-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>To collect frames for wireless diagnostics at application layer (e.g. DNS, per your specific case) requires several things:</p><ol><li>Wireless hardware capable of monitor mode. This will usually pass up CONTROL and MGMT traffic to the stack for capture. It will also usually leave the 802.11 header intact and add some sort of header with hardware info, such as radiotap, PPI, etc. This mode is very driver hardware/specific, i.e. with Windows it can be difficult to get this mode. With Mac laptops, they support it out of the box. Linux has many drivers that support it as well.</li><li>Wireless hardware capable of promiscuous mode. This happens sometimes with monitor mode, but definitely not always. It's hardware and driver specific. This removes the hardware/driver filter which would drop frames not intended for this host.<br />
</li><li>Ability to decrypt, which as you found, requires the 4-way EAPOL handshake and either the pre-shared passphrase for WPA2 &amp; SSID or the PMK if using Enterprise (can be difficult to get this).</li></ol><p>Don't assume monitor mode == promiscuous mode in the wifi world. Sounds as if your adapter supports both, so you are all set. I would argue there is only one solution if using wireless sniffing for what you need and that is to have both of these features.</p><p>As an alternative, could you have just grab wired traffic at the router or DNS server? No need to decrypt then, and less overhead handling all the CONTROL and MGMT frames. Perhaps you don't have wired access.<br />
</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>11 Sep '16, 06:09</strong></p><img src="https://secure.gravatar.com/avatar/0a47ef51dd9c9996d194a4983295f5a4?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Bob%20Jones&#39;s gravatar image" /><p>Bob Jones<br />
<span class="score" title="1014 reputation points"><span>1.0k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="15 badges"><span class="bronze">●</span><span class="badgecount">15</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Bob Jones has 19 accepted answers">21%</span> </br></br></p></div></div><div id="comments-container-55469" class="comments-container"><span id="55475"></span><div id="comment-55475" class="comment"><div id="post-55475-score" class="comment-score"></div><div class="comment-text"><blockquote><p>As an alternative, could you have just grab wired traffic at the router or DNS server? No need to decrypt then, and less overhead handling all the CONTROL and MGMT frames. Perhaps you don't have wired access.</p></blockquote><p>Actually I have wired access, but I want my script to be able to do without it. However, if I believe my previous tests, packets sent over WiFi are not <em>repeated</em> on the wire. Then, a DNS query would reach the router by the air, and my machine would not see any of it since it is only connected via the wire. I guess I should grab the traffic after the router, which is not possible in my case.</p></div><div id="comment-55475-info" class="comment-info"><span class="comment-age">(11 Sep '16, 13:46)</span> thefiercerabbit</div></div><span id="55480"></span><div id="comment-55480" class="comment"><div id="post-55480-score" class="comment-score"></div><div class="comment-text"><p>I guess Bob's idea was that since you are interested specifically in DNS requests, these have to be sent to an external DNS server in the internet over the WAN, so he didn't come even close to an idea that WLAN frames should be mirrored on a LAN interface bridged with the WLAN one. But as you say you have no possibility to capture at the WAN side of your access point, you have to continue your way.</p><p>In an environment you administer yourself, using any wireless AP which supports bridge mode gives you a chance to capture DNS traffic of clients at an Ethernet wire if you insert the capturing PC between the AP and the router, which would simplify the task a lot; in an environment administered by someone else, you are not likely to get access to the WPA passphrases so even the WLAN monitoring mode won't help you much.</p></div><div id="comment-55480-info" class="comment-info"><span class="comment-age">(12 Sep '16, 02:24)</span> sindy</div></div></div><div id="comment-tools-55469" class="comment-tools"></div><div class="clear"></div><div id="comment-55469-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

