+++
type = "question"
title = "TCP previous segment not captured, why?"
description = '''Hi, I have a software who dumps data from a remote controller. The dump is made though a tcp connection that is not stable; my software is telling me &quot;communication stopped&quot; after 5-6 seconds  I run Wireshark to understand what was going on, but I&#x27;m not able to spot the reason behind this. All I see...'''
date = "2012-07-24T02:24:00Z"
lastmod = "2012-07-24T03:54:00Z"
weight = 12943
keywords = [ "prev_seg_lost", "tcp" ]
aliases = [ "/questions/12943" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [TCP previous segment not captured, why?](/questions/12943/tcp-previous-segment-not-captured-why)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12943-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, I have a software who dumps data from a remote controller. The dump is made though a tcp connection that is not stable; my software is telling me "communication stopped" after 5-6 seconds</p><p>I run Wireshark to understand what was going on, but I'm not able to spot the reason behind this. All I see in the pcap trace is that when the connection ends, I have a general error "tcp previous segment not captured".</p><p>my software runs in a hyperV machine. for tests I tried to install the software on my computer and the connection never stops.</p><p>I uploaded the trace here <a href="http://www.cloudshark.org/captures/c256982bb42d">http://www.cloudshark.org/captures/c256982bb42d</a></p><p>Can anyone help?</p></div><div id="question-tags" class="tags-container tags">prev_seg_lost tcp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>24 Jul '12, 02:24</strong></p><img src="https://secure.gravatar.com/avatar/0b0e2876fa46e2f356fad310b51b6d8e?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="GlobalS&#39;s gravatar image" /><p>GlobalS<br />
<span class="score" title="0 reputation points">0</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="GlobalS has no accepted answers">0%</span></p></div></div><div id="comments-container-12943" class="comments-container"></div><div id="comment-tools-12943" class="comment-tools"></div><div class="clear"></div><div id="comment-12943-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="12945"></span>

<div id="answer-container-12945" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12945-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>The server 82.117.201.86 is not following the TCP RFC. In closing the session the FIN should come from the next expected sequence number and when the FIN gets ACKed, it should send an ACK that acknowledges one phantom byte. However, the server is sending the FIN with a sequence number that already incorporates the phantom byte. This is not correct and the client correctly sends a duplicate ACK asking for a packet with the correct sequence number.</p><p>So either, there is indeed one byte of data being sent and the packet got lost. Or the TCP stack of the server has a bug in it.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>24 Jul '12, 03:22</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div></div><div id="comments-container-12945" class="comments-container"></div><div id="comment-tools-12945" class="comment-tools"></div><div class="clear"></div><div id="comment-12945-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="12946"></span>

<div id="answer-container-12946" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12946-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>"tcp previous segment not captured" is an expert message created by Wireshark when it didn't see a packet that should have been in the trace; this warning was previously called "tcp previous segment lost". It basically means that either the packet really wasn't seen on the wire (which would be a packet loss) or Wireshark wasn't capturing "fast enough" to record the packet even though it <strong>had been</strong> on the wire.</p><p>I looked at your trace file and it looks like the device with the IP 82.117.201.86 behaves a little strange - is this some embedded device with a rudimentary stack implementation? It sends packet 136 with a sequence number that is one byte too high to be valid, so that the FIN-ACK-FIN-ACK sequence doesn't work as it should. I think the TCP stack of the node with the IP 82.117.201.86 is doing the session shutdown wrong, but I may be mistaken. I doubt that there really is a missing packet - my guess is that it is just a bad sequence number calculation that is giving you trouble.</p><p>Anyway, this protocol looks pretty problematic when run over high latency links. It is constantly exchanging small packets with push flags, which leads to quickly adding up the round trip times since it is basically a serialized communication. 137 packets in 13 seconds isn't going to win any throughput championships - but then again maximizing throughput is probably not an issue for this communication I guess.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>24 Jul '12, 03:28</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-12946" class="comments-container"><span id="12947"></span><div id="comment-12947" class="comment"><div id="post-12947-score" class="comment-score"></div><div class="comment-text"><p>Thanks you for your answers! The server at 81.117.201.86 is an access control controller (the device that open the door automatically with a smart card, just to understand) and it records the entrance and exits. On 10.8.0.24 we have the software that collect the data and let us see who's going in and out.</p><p>Unfortunately I cannot change any setting on the controller; So as I understood correctly the only possibility here is to move the receiving server closer to the controller?</p><p>[converted to a comment to keep the Q&amp;A nature going]</p></div><div id="comment-12947-info" class="comment-info"><span class="comment-age">(24 Jul '12, 03:49)</span> GlobalS</div></div><span id="12949"></span><div id="comment-12949" class="comment"><div id="post-12949-score" class="comment-score"></div><div class="comment-text"><p>No, moving receiving server and controller closer to each other will probably not help. Your problem is that the access control controller most likely runs a faulty TCP stack implementation, which means you need the vendor of that device to update it.</p></div><div id="comment-12949-info" class="comment-info"><span class="comment-age">(24 Jul '12, 03:57)</span> Jasper ♦♦</div></div><span id="13327"></span><div id="comment-13327" class="comment"><div id="post-13327-score" class="comment-score"></div><div class="comment-text"><p>Hello, just for information, we upgraded the firmware on the router and everything works fine now. Unfortunately the router is a black box and I can't tell what setting changed. That is why we are switching to a better one :)</p></div><div id="comment-13327-info" class="comment-info"><span class="comment-age">(02 Aug '12, 14:23)</span> GlobalS</div></div></div><div id="comment-tools-12946" class="comment-tools"></div><div class="clear"></div><div id="comment-12946-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="12948"></span>

<div id="answer-container-12948" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12948-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>I second what @SYN-bit and @Jasper said about the FIN behaviour of the server.</p><p>But you say:</p><blockquote><p>my software is telling me "communication stopped" after 5-6 seconds</p></blockquote><p>This does not match the capture file. The client actively closes the connection after ~ 12 seconds (Frame: 134). So, why does your software say "communication stopped" after 5-6 seconds? Maybe there is a another problem with the application.</p><p>You say:</p><blockquote><p>for tests I tried to install the software on my computer and the connection never stops.</p></blockquote><p>Does that mean, you have constant data flow for more than a few seconds in that case? If so, then the problem is not a network problem, as the client actively closed the connection in your capture sample.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>24 Jul '12, 03:54</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 03 Aug '12, 02:37</p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span></p></div></div><div id="comments-container-12948" class="comments-container"><span id="12952"></span><div id="comment-12952" class="comment"><div id="post-12952-score" class="comment-score"></div><div class="comment-text"><p>Thanks for the asnwer.</p><p>The capture file is recording only one stop. I didn't start the communication for this pcap because the output is always the same. The communication always ends when wireshark tells me "segment lost".</p><p>Yes, if I move the server locally (2 ms latency) the data flow is constant. This afternoon I'm planning to move the server on vmware rather than hyperV to see if it helps</p></div><div id="comment-12952-info" class="comment-info"><span class="comment-age">(24 Jul '12, 04:38)</span> GlobalS</div></div><span id="12953"></span><div id="comment-12953" class="comment"><div id="post-12953-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Yes, if I move the server locally (2 ms latency) the data flow is constant.</p></blockquote><p>Without the client closing the connection (FIN)?</p><p>If so, it's a problem within the application (maybe latency, as Jasper mentioned) and not the network, because in your sample capture the client closes the connection actively. The sole purpose of that is to end the communication, so there should'nt be any error message ("communication stopped") if the client voluntarily ends the communication.</p><p>But that's just speculation. With the information provided so far, it's hard to come to a conclusion. There are two questions open:</p><ol><li>Why does the client close the TCP connection in one case and why not in the other case (2ms latency)?</li><li>Does the client report the error message ("communication stopped") as a result of the FIN behaviour of the server, or is that just something that happens anyway, after the client application decided to close the connection. In that case the FIN behaviour (as bad as it is) would be unrelated to your problem.</li></ol></div><div id="comment-12953-info" class="comment-info"><span class="comment-age">(24 Jul '12, 04:47)</span> Kurt Knochner ♦</div></div><span id="13328"></span><div id="comment-13328" class="comment"><div id="post-13328-score" class="comment-score"></div><div class="comment-text"><p>Hello, just for information, we upgraded the firmware on the router and everything works fine. Unfortunately the router is a black box and I can't tell what setting changed. That is why we are switching to a better one :)</p></div><div id="comment-13328-info" class="comment-info"><span class="comment-age">(02 Aug '12, 14:23)</span> GlobalS</div></div><span id="13338"></span><div id="comment-13338" class="comment"><div id="post-13338-score" class="comment-score"></div><div class="comment-text"><p>O.K. now I'm curious :-). Did you upgrade the "internet router" between 10.8.0.24 (client) and 81.117.201.86 (server)? If so, that would be kind of "interesting". As I mentioned, the client closes the connection actively and only then we see the bad FIN behaviour of the server (or maybe the router, interfering in the connection?). If the client stopped closing the connetion after the firmware upgrade (you mentioned that also for the case where the server was placed on the LAN), that would be kind of "strange" :-)</p></div><div id="comment-13338-info" class="comment-info"><span class="comment-age">(03 Aug '12, 01:10)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-12948" class="comment-tools"></div><div class="clear"></div><div id="comment-12948-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

