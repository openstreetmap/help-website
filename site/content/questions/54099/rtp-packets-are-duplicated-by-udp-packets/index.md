+++
type = "question"
title = "RTP packets are duplicated by UDP packets"
description = '''Hi, folks! I&#x27;ve being analysed sample RTP-dump I&#x27;ve found on the Internet when I noticed some weird effect I can&#x27;t really explain. Some of RTP packets (or maybe all of them - I didn&#x27;t check) are duplicated by UDP packets (they have identical payload) but with different srcIP and dstIP.  On the scree...'''
date = "2016-07-16T14:48:00Z"
lastmod = "2016-07-17T00:12:00Z"
weight = 54099
keywords = [ "rtp" ]
aliases = [ "/questions/54099" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [RTP packets are duplicated by UDP packets](/questions/54099/rtp-packets-are-duplicated-by-udp-packets)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54099-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, folks! I've being analysed sample RTP-dump I've found on the Internet when I noticed some weird effect I can't really explain.</p><p>Some of RTP packets (or maybe all of them - I didn't check) are duplicated by UDP packets (they have identical payload) but with different srcIP and dstIP.</p><p><img src="https://osqa-ask.wireshark.org/upfiles/rtp.png" alt="alt text" /></p><p>On the screenshot above 499th package is duplicated by 501th and 500th package is duplicated by 502th. And, as you can see, such duplicates are not classified by Wireshark as RTP-packets, but, as I mentioned, payload is identical.</p><p>It looks like destination machine (200.57.7.196) is forwarding such packets to another machine (200.57.7.199). But why? And when I open RTP streams analysis in Wireshark, it displays only 3 streams where 200.57.7.199 machine is absent.</p><p>So how do you explain it?</p></div><div id="question-tags" class="tags-container tags">rtp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>16 Jul '16, 14:48</strong></p><img src="https://secure.gravatar.com/avatar/9d8e7bdd418d0b727f76b47e655bc465?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="trixter&#39;s gravatar image" /><p>trixter<br />
<span class="score" title="21 reputation points">21</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="trixter has no accepted answers">0%</span></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 16 Jul '16, 14:49</p></div></div><div id="comments-container-54099" class="comments-container"><span id="54106"></span><div id="comment-54106" class="comment"><div id="post-54106-score" class="comment-score"></div><div class="comment-text"><p>The trace file is here: <a href="http://networker.wikia.com/wiki/File:Sample_SIP_call_with_RTP_in_G711.pcap?useskin=oasis">http://networker.wikia.com/wiki/File:Sample_SIP_call_with_RTP_in_G711.pcap?useskin=oasis</a></p></div><div id="comment-54106-info" class="comment-info"><span class="comment-age">(17 Jul '16, 01:26)</span> Christian_R</div></div></div><div id="comment-tools-54099" class="comment-tools"></div><div class="clear"></div><div id="comment-54099-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="54104"></span>

<div id="answer-container-54104" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54104-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>As you haven't provided a link to the capture you look at, I can only explain the generic part.</p><p>Imagine a setup where you have two VoIP phones in private IP subnets, accessing the internet via dumb NATs (i.e. no Application Layer Gateways), registered to the same VoIP service. In such case, the service cannot merely forward the SDPs between the phones, because the RTP destination addresses indicated in the SDPs are private ones and thus mutually unreachable. So what the service has to do is to use a techniques called "media proxying", "RTP forwarding" etc.: it uses a "controlled NAT" device, creates a pinhole between its two sockets on public IP addresses, and indicates these sockets as destinations for RTP, each of them to a different one of the phones, by replacing the original <code>c=</code> address in the SDPs forwarded from the other phone. So both phones thus send their RTP to the media proxy, which has to learn the actual source address of incoming RTP from a given phone (which is a socket on the public IP of the NAT) and use it as destination when sending to that phone the RTP coming from the other one.</p><p>The SSRC ID remains the same because the only part which the media proxy (controlled NAT) changes in the RTP streams is the <code>eth:ip:udp</code> header, the whole RTP payload remains unchanged.</p><p>Depending on where and how the capture has been made, it may contain both bi-directional RTP flows (between the media proxy and each phone), but only one signalling exchange. As RTP is hard to distinguish from any other UDP stream by its payload, Wireshark normally decides to dissect a UDP flow as an RTP one only if information from SDPs in the same capture (connection address, media stream port) matches the (IP address, UDP port) for source or destination of the UDP packets.</p><p>If there is no such SDP for one of the flows in your capture, Wireshark can only use the heuristic dissector to recognize that the UDP flow is actually an RTP one, and it may not always be able to do so.</p><p>It may even be that there is no standards-compliant signalling between the 200.57.7.196 and 200.57.7.199 because both of them may be controlled by the same controller so it only tells them to send RTP to each other using some proprietary control protocol running on another LAN so not captured.</p><p>If you need more, you'll have to provide a link to that capture.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>17 Jul '16, 00:12</strong></p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p>sindy<br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="sindy has 110 accepted answers">24%</span></p></div></div><div id="comments-container-54104" class="comments-container"><span id="54107"></span><div id="comment-54107" class="comment"><div id="post-54107-score" class="comment-score"></div><div class="comment-text"><p>Wow, great explanation, @sindy. And I guess, it's correct. You should post is as an answer and I will accept it. P.S. @Christian_R had attached the dump to the post, thanks.</p></div><div id="comment-54107-info" class="comment-info"><span class="comment-age">(17 Jul '16, 01:48)</span> trixter</div></div><span id="54108"></span><div id="comment-54108" class="comment"><div id="post-54108-score" class="comment-score"></div><div class="comment-text"><p>OK, as @Christian_R has provided the link to the file, I can confirm that the stream between 200.57.7.196:40378 and 200.57.7.199:4800 is not established using any SDP present in the capture, and no other call control protocols but SIP and MGCP seem to be present in the capture (there is also H.225 but no H.245).</p><p>But what Wireshark version do you use? My 2.0.4 did recognize that stream as RTP without a hint.</p></div><div id="comment-54108-info" class="comment-info"><span class="comment-age">(17 Jul '16, 01:52)</span> sindy</div></div><span id="54109"></span><div id="comment-54109" class="comment"><div id="post-54109-score" class="comment-score"></div><div class="comment-text"><p>And as for making it an Answer so that you could accept it: @Jaap's Answer was basically saying the same more briefly, so he deserves at least the "thumbs up" if you choose my Answer as the correct one.</p></div><div id="comment-54109-info" class="comment-info"><span class="comment-age">(17 Jul '16, 02:01)</span> sindy</div></div><span id="54110"></span><div id="comment-54110" class="comment"><div id="post-54110-score" class="comment-score"></div><div class="comment-text"><p>I'm using 2.0.4 and I think I messed it up: I've seen checked 'rtps_udp' and misrecognized it as 'rtp_udp' option :( Now Wireshark detected 2 more conversations. Well, @Jaap, sorry for wrong comment, I thumbed you up at least.</p></div><div id="comment-54110-info" class="comment-info"><span class="comment-age">(17 Jul '16, 03:02)</span> trixter</div></div><span id="54111"></span><div id="comment-54111" class="comment"><div id="post-54111-score" class="comment-score"></div><div class="comment-text"><p>@sindy, may I ask one more question? Which criteria should I use to find out true srcIP and dstIP and skip the proxy one? I'm developing own software for RTP analisys (and verify each step using Wireshark), so I need some correct algorithmic soluton for this specific case...</p></div><div id="comment-54111-info" class="comment-info"><span class="comment-age">(17 Jul '16, 03:08)</span> trixter</div></div><span id="54114"></span><div id="comment-54114" class="comment not_top_scorer"><div id="post-54114-score" class="comment-score"></div><div class="comment-text"><p>Leaving aside that this question is anything but a Wireshark one, it also cannot be answered unambiguously, because the right answer heavily depends on particular call scenario, capture point(s), and goal of the analysis.</p><p>Imagine the following logical arrangement:</p><pre><code>          --SIP--- switch1 [---SIP--- switchN]* ---SIP--
        /             |                  |               \
phoneA {              |                  |                } phoneB
        \             V                  V               /
          --RTP---  mpxy1  [---RTP---  mpxyN]*  ---RTP--</code></pre><p>(for example, each of the phones is connected to a different IPBX connected to a different operator - in such case, there are at least four voice switches between the phones) and imagine the possible different physical arrangements and capture points.</p><p>So the decision which RTP flow to analyze depends on which one(s) you have got in the capture and what you're after about the RTP. You may be looking for sources of jitter and packet loss, in that case you want to capture as many reincarnations of the RTP flow as you can to compare them to each other.</p><p>If you want to detect the extremities, you have to order the packets sharing the same SSRC and seqno by capture timestamps (provided that you've taken the capture at a single interface or that you're 150% sure about proper timestamp synchronisation between all the interfaces you have captured at). The source of the first one is closest to the real source which you can see, and the destination of the last one is closest to the real destination.</p><p>Plus as soon as one of the media proxies does more than just forward the RTP unchanged, you <strong>may</strong> lose the SSRC and RTP timestamps and you <strong>do</strong> lose the seqno. A typical case would be transcoding of DTMF between telephone-event codec in one branch and the basic PCMA or PCMU audio stream in the other one. In this case, a single telephone-event packet usually replaces several PCMx packets, so the transcoding media proxy must generate an independent sequence of seqno at the other side, although it may keep the SSRC value and RTP timestamps.</p></div><div id="comment-54114-info" class="comment-info"><span class="comment-age">(17 Jul '16, 06:12)</span> sindy</div></div></div><div id="comment-tools-54104" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-54104-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="54100"></span>

<div id="answer-container-54100" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54100-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>Without knowing the specifics of the setup here, I image the following.</p><p>Your looking at various things. One is the signalling part, which Wireshark uses to start decoding these UDP packets as RTP (through the use of a so called conversation). The next is the involvement of a gateway, where and RTP endpoint is, possibly some processing is done (not in this case apparently) and a new RTP session originates. For this stream there's no signalling captured, therefore no 'conversation' defined, therefore no UDP packet interpretation as RTP. This could be done by setting an RTP_over_udp preference to also decode RTP outside conversations. Try that and see what happens.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>16 Jul '16, 15:45</strong></p><img src="https://secure.gravatar.com/avatar/2337f0406681e5c72ea0e6f1f0d6c0b0?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jaap&#39;s gravatar image" /><p>Jaap ♦<br />
<span class="score" title="11680 reputation points"><span>11.7k</span></span><span title="16 badges"><span class="silver">●</span><span class="badgecount">16</span></span><span title="101 badges"><span class="bronze">●</span><span class="badgecount">101</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jaap has 155 accepted answers">14%</span></p></div></div><div id="comments-container-54100" class="comments-container"><span id="54101"></span><div id="comment-54101" class="comment"><div id="post-54101-score" class="comment-score"></div><div class="comment-text"><p>This option is enabled in my Wireshark (actually, I guess it's enabled by default, because I haven't enable it manually). Still we get what we get. Another question is: why the SSRC (sender identificator) is also the same in duplicated packets while the source IP address is diffirent? How can it be possible?</p></div><div id="comment-54101-info" class="comment-info"><span class="comment-age">(16 Jul '16, 16:00)</span> trixter</div></div><span id="54115"></span><div id="comment-54115" class="comment"><div id="post-54115-score" class="comment-score"></div><div class="comment-text"><p>The SSRC is not the sender, it's the sync source. Since the gateway apparently doesn't change a thing (transparent) it only influences the underlying IP addresses, not the RTP information related to the sync source, which remains the same.</p></div><div id="comment-54115-info" class="comment-info"><span class="comment-age">(17 Jul '16, 12:57)</span> Jaap ♦</div></div></div><div id="comment-tools-54100" class="comment-tools"></div><div class="clear"></div><div id="comment-54100-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

