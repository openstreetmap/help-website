+++
type = "question"
title = "tcp mss inconsistency in different capture points"
description = '''Analysis process, the client is found in the TCP connection is established, the MSS value is not the same in different capture points. client side packet: http://www.cloudshark.org/captures/0c7d36890433 server side packet: http://www.cloudshark.org/captures/1d460ea5291d Help to explain thanks.'''
date = "2013-04-19T09:55:00Z"
lastmod = "2013-04-21T06:34:00Z"
weight = 20633
keywords = [ "mss", "tcp" ]
aliases = [ "/questions/20633" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [tcp mss inconsistency in different capture points](/questions/20633/tcp-mss-inconsistency-in-different-capture-points)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-20633-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Analysis process, the client is found in the TCP connection is established, the MSS value is not the same in different capture points. client side packet: <a href="http://www.cloudshark.org/captures/0c7d36890433">http://www.cloudshark.org/captures/0c7d36890433</a> server side packet: <a href="http://www.cloudshark.org/captures/1d460ea5291d">http://www.cloudshark.org/captures/1d460ea5291d</a></p><p>Help to explain</p><p>thanks.</p></div><div id="question-tags" class="tags-container tags">mss tcp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>19 Apr '13, 09:55</strong></p><img src="https://secure.gravatar.com/avatar/c66d8077ef5f4d265694332542e2fbd4?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mengsunny&#39;s gravatar image" /><p>mengsunny<br />
<span class="score" title="11 reputation points">11</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mengsunny has no accepted answers">0%</span></p></div></div><div id="comments-container-20633" class="comments-container"><span id="20634"></span><div id="comment-20634" class="comment"><div id="post-20634-score" class="comment-score"></div><div class="comment-text"><p>In the client side capture MSS value is 1460. In the server side capture MSS value is 1380. Whether the intermediate network device to change the TCP MSS</p></div><div id="comment-20634-info" class="comment-info"><span class="comment-age">(19 Apr '13, 09:58)</span> mengsunny</div></div></div><div id="comment-tools-20633" class="comment-tools"></div><div class="clear"></div><div id="comment-20633-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="20635"></span>

<div id="answer-container-20635" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-20635-score" class="post-score" title="current number of votes">3</div></div></td><td><div class="item-right"><div class="answer-body"><p>There has to be a device sitting in the middle has changed the MSS value, since not only the MSS is changed but also the initial sequence number. So this looks like a transparent proxy of some sort, which you may be able to verify by sending an HTTP TRACE request. If the server responds to it it will echo back the request parameters the server got and display them in your browser (guessing that it is a Web server from port 443 being used).</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>19 Apr '13, 10:02</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-20635" class="comments-container"><span id="20637"></span><div id="comment-20637" class="comment"><div id="post-20637-score" class="comment-score"></div><div class="comment-text"><p>In the middle of the client and the server in a IPSEC VPN tunnel,but not have a transparent proxy.</p></div><div id="comment-20637-info" class="comment-info"><span class="comment-age">(19 Apr '13, 10:11)</span> mengsunny</div></div><span id="20638"></span><div id="comment-20638" class="comment"><div id="post-20638-score" class="comment-score"></div><div class="comment-text"><p>This environment will cause the change of MSS value</p></div><div id="comment-20638-info" class="comment-info"><span class="comment-age">(19 Apr '13, 10:12)</span> mengsunny</div></div><span id="20640"></span><div id="comment-20640" class="comment"><div id="post-20640-score" class="comment-score"></div><div class="comment-text"><ul><li>edited: [IPSEC tunnels (basically routers with next hop encryption) usually do not modify layer 4 information, but it may be still possible] not correct, see comment of @SYN-bit - . You need to determine all devices in the path and what they're configured to do with layer 4 information.</li></ul></div><div id="comment-20640-info" class="comment-info"><span class="comment-age">(19 Apr '13, 11:08)</span> Jasper ♦♦</div></div><span id="20641"></span><div id="comment-20641" class="comment"><div id="post-20641-score" class="comment-score"></div><div class="comment-text"><p>@Jasper, it is best practice in IPsec tunneling to adjust the MSS of TCP sessions to prevent fragmentation at the IP layer due to the encapsulation.</p><p>Cisco even takes this further and by default changes the MSS of TCP sessions to 1380 on the FWSM and ACE blades.</p><p>See for instance:</p><ul><li><a href="http://www.cisco.com/en/US/tech/tk827/tk369/technologies_white_paper09186a00800d6979.shtml">http://www.cisco.com/en/US/tech/tk827/tk369/technologies_white_paper09186a00800d6979.shtml</a></li><li><a href="http://www.firstdigest.com/2010/09/cisco-how-can-mss-help-to-solve-issues-in-vpn-communication/">http://www.firstdigest.com/2010/09/cisco-how-can-mss-help-to-solve-issues-in-vpn-communication/</a></li><li><a href="http://kb.juniper.net/InfoCenter/index?page=content&amp;id=KB6346">http://kb.juniper.net/InfoCenter/index?page=content&amp;id=KB6346</a></li></ul></div><div id="comment-20641-info" class="comment-info"><span class="comment-age">(19 Apr '13, 12:18)</span> SYN-bit ♦♦</div></div><span id="20644"></span><div id="comment-20644" class="comment"><div id="post-20644-score" class="comment-score"></div><div class="comment-text"><p>Makes sense, I guess, I just haven't seen many traces like that before :) I was just wondering why a device would also create a new inital sequence number - and it led me to the assumption that there is some kind of proxying involved.</p></div><div id="comment-20644-info" class="comment-info"><span class="comment-age">(19 Apr '13, 15:03)</span> Jasper ♦♦</div></div><span id="20645"></span><div id="comment-20645" class="comment not_top_scorer"><div id="post-20645-score" class="comment-score"></div><div class="comment-text"><p>That's also a cisco FW feature for the ol'days when systems still used 0 as ISN. Cisco firewalls randomize the ISN for the internal hosts... And guess what, that's why they could not handle SACK in the past (or maybe they still don't?). You can turn the ISN randomization of though :-)</p></div><div id="comment-20645-info" class="comment-info"><span class="comment-age">(19 Apr '13, 16:19)</span> SYN-bit ♦♦</div></div><span id="20648"></span><div id="comment-20648" class="comment not_top_scorer"><div id="post-20648-score" class="comment-score"></div><div class="comment-text"><p>Thank you very much for your help, I will continue to eliminate do operation for 4 layer equipment possible path.</p></div><div id="comment-20648-info" class="comment-info"><span class="comment-age">(19 Apr '13, 20:17)</span> mengsunny</div></div><span id="20651"></span><div id="comment-20651" class="comment not_top_scorer"><div id="post-20651-score" class="comment-score"></div><div class="comment-text"><p>Your answer has been converted to a comment as that's how this site works. Please read the FAQ for more information.</p><p>If an answer has solved your issue, please accept the answer for the benefit of other users by clicking the checkmark icon next to the answer. Please read the FAQ for more information.</p></div><div id="comment-20651-info" class="comment-info"><span class="comment-age">(20 Apr '13, 05:23)</span> grahamb ♦</div></div><span id="20669"></span><div id="comment-20669" class="comment not_top_scorer"><div id="post-20669-score" class="comment-score"></div><div class="comment-text"><p>Hm, interesting to see that the windows client is NOT honoring the reduced MSS of 1380 but sends a tcp.len==1477 segment in frame.number 13. This packet also exceeds the client's MTU size by 17 bytes... The re-transmission in #15 after 314 ms is then using the smaller - learned by PMTUD? - MTU size and this packet goes through. Is this 'segmentation offload' or is this normal windows behaviour?</p></div><div id="comment-20669-info" class="comment-info"><span class="comment-age">(21 Apr '13, 06:07)</span> mrEEde2</div></div><span id="20670"></span><div id="comment-20670" class="comment not_top_scorer"><div id="post-20670-score" class="comment-score"></div><div class="comment-text"><p>It does honor it as far as I can tell. Keep in mind that the trace taken on the client side was taken <strong>on the client</strong>. That means that you deal with "oversized" segments because of segmentation offloading. Check the server side to see that the MSS of 1380 is never violated.</p></div><div id="comment-20670-info" class="comment-info"><span class="comment-age">(21 Apr '13, 06:14)</span> Jasper ♦♦</div></div><span id="20671"></span><div id="comment-20671" class="comment not_top_scorer"><div id="post-20671-score" class="comment-score"></div><div class="comment-text"><p>The large segment never makes it to the server. So if TSO is enabled, the ethernet card does not look at the 'learned' MSS but sends out too large segments requiring a retransmission with the new (PMTUD learned) MTU size. So we'll always have to wait for the retransmission timer to pop - not good for performance.</p></div><div id="comment-20671-info" class="comment-info"><span class="comment-age">(21 Apr '13, 06:26)</span> mrEEde2</div></div><span id="20673"></span><div id="comment-20673" class="comment not_top_scorer"><div id="post-20673-score" class="comment-score"></div><div class="comment-text"><p>I agree with @Jasper that TSO is indeed enabled, as you can see that the 1477 bytes of TCP data from (clienttrace) frame 13 is split into 1380 bytes (missing in the server trace) and 97 bytes in frame 25 (servertrace).</p><p>The real problem is why the frame with 1380 bytes of TCP data did not get through, as this is conform the advertised MSS. Please see my separate answer for a possible cause.</p></div><div id="comment-20673-info" class="comment-info"><span class="comment-age">(21 Apr '13, 06:37)</span> SYN-bit ♦♦</div></div><span id="20674"></span><div id="comment-20674" class="comment not_top_scorer"><div id="post-20674-score" class="comment-score"></div><div class="comment-text"><p>Right, I was only checking tcp.len on the server side, and ignore the packet loss - my bad. Looks indeed like the segmentation offloading of the client doesn't consider MSS until it is forced to retransmit. Or it does, as SYN-bit mentioned - I think I need to clear my head and look through this again some time. These sequence number replacement mechanisms give me a headache :)</p></div><div id="comment-20674-info" class="comment-info"><span class="comment-age">(21 Apr '13, 06:40)</span> Jasper ♦♦</div></div><span id="20677"></span><div id="comment-20677" class="comment not_top_scorer"><div id="post-20677-score" class="comment-score"></div><div class="comment-text"><p>@mengsunny: What kind (brand, modell) of VPN device is involved?</p></div><div id="comment-20677-info" class="comment-info"><span class="comment-age">(21 Apr '13, 08:04)</span> Kurt Knochner ♦</div></div><span id="20678"></span><div id="comment-20678" class="comment not_top_scorer"><div id="post-20678-score" class="comment-score"></div><div class="comment-text"><p>to answer my own question :-)</p><p>Based on the ICMP "fragmentation needed" message (frame #57), I conclude, that the sending device (21.238.5.11) used a TTL of 255. <a href="http://www.netresec.com/?page=Blog&amp;month=2011-11&amp;post=Passive-OS-Fingerprinting">As Cisco routers (and possibly Cisco ASA as well) are using that TTL value</a>, I assume it's some Cisco IPSEC device and then the explanation of @SYN-bit sounds pretty reasonable.</p></div><div id="comment-20678-info" class="comment-info"><span class="comment-age">(21 Apr '13, 08:17)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-20635" class="comment-tools"><span class="comments-showing"> showing 5 of 15 </span> <a href="#" class="show-all-comments-link">show 10 more comments</a></div><div class="clear"></div><div id="comment-20635-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="20672"></span>

<div id="answer-container-20672" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-20672-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>The traces look a lot like traces I have made before for a customer where things did not work properly. In the end it was the IPsec configuration on the Cisco routers that caused the issue. You could check whether the crypto map is applied to the tunnel interface instead (or as well as) the physical interface. In my case the solution was to have the crypto map on the physical interface only.</p><p>Please look for "ICMP Fragmentation needed but DF bit set" messages on the client side which suggest an MTU of 1433 (which corresponds to an MSS of 1379 instead of 1380). That was what we were facing back then and we created a Cisco case.</p><p>This was the response from Cisco-TAC in my case:</p><pre><code>So here&#39;s what we are seeing on the show crypto ipsec sa:
interface: Tunnel0
    Crypto map tag: GENVPN, local addr x.x.x.141 ...
     local crypto endpt.: x.x.x.141, remote crypto endpt.: y.y.y.206
     path mtu 1476, ip mtu 1476, ip mtu idb Tunnel0
     current outbound spi: 0x0(0)

This is incorrect. The ipsec SADB should only be associated with the physical interface, and not the Tunnel interface.
Because of that, we see that even for the g0/1 interface, the MTU is being computed from the Tunnel interface mtu:

interface: GigabitEthernet0/1
    Crypto map tag: GENVPN, local addr x.x.x.141

...
     local crypto endpt.: x.x.x.141, remote crypto endpt.: y.y.y.206
     path mtu 1476, ip mtu 1476, ip mtu idb Tunnel0
     current outbound spi: 0x0(0)

This is one of the &quot;unexpected&quot; results of having the crypto-map applied to the Tunnel interface. Because of that all the MTU computations are being done with basis the MTU of the GRE tunnel, wich is 24 less than the physical interface. 
I could reproduce the issue in the lab, and by provisioning the crypto-map on the physical interface, before provisionning it on the Tunnel, the MTU will be derived from the physical interface, until next reload. This is most probably what happened in your case, given the crash that we have identified.
Therefore the solution is quite simple, simply remove the crypto map statement from the tunnel interface configuration. You might need to clear all the crypto tunnels or reload the box, if the removal is not enough. In the lab removing the crypto map was enough, but I did not have redundancy configured, so please keep that in mind. Please keep in mind that this is an unsupported configuration as it is right now.</code></pre></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>21 Apr '13, 06:34</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 21 Apr '13, 06:52</p></div></div><div id="comments-container-20672" class="comments-container"></div><div id="comment-tools-20672" class="comment-tools"></div><div class="clear"></div><div id="comment-20672-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

