+++
type = "question"
title = "Single chunk of TCP data missing from file transfer"
description = '''Hi everyone, I am performing a file transfer using some off the shelf COTS TCP libraries in a C# program. I am transferring a 5Mb randomly generated file. The transmission path traverses a virtual NIC (TAP/TUN), over a radio, and back out another virtual NIC. Sometimes the file is transmitted correc...'''
date = "2013-06-20T10:58:00Z"
lastmod = "2013-07-03T07:00:00Z"
weight = 22205
keywords = [ "data", "tcp", "error" ]
aliases = [ "/questions/22205" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [Single chunk of TCP data missing from file transfer](/questions/22205/single-chunk-of-tcp-data-missing-from-file-transfer)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-22205-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi everyone,</p><p>I am performing a file transfer using some off the shelf COTS TCP libraries in a C# program. I am transferring a 5Mb randomly generated file. The transmission path traverses a virtual NIC (TAP/TUN), over a radio, and back out another virtual NIC. Sometimes the file is transmitted correctly but sometimes the file is missing one contiguous chunk of data. It could be in the middle somewhere, and can be of varying size. The example I am using has a missing chuck of 16141 bytes. I have wireshark captures of both the sender and receiver. I would love to know if this might indicate an issue with the underlying virtual NIC and radio hardware, or something that happening in the stack. Here are the notes I have taken regarding my observations of the issue and the wireshark captures. I hope to be able to post the captures on here once this gets posted.</p><p>Notes:</p><p>The file is contiguous until:</p><p>46 46 41 85 C4 ED 24 9D @ Offset 1883080, - Packet #1799 in wireshark sender Capture (01D0) - Note: This is a smaller packet than the norm. THe packet data is truncated right after the 9D<br />
- Packet #6778 in Wireshark receive capture</p><p>Then...</p><p>next bytes Should be:</p><p>3B 89 04 83 B6 34 9C 14 @ Offset 1883087 - Packet #1799 in wireshark sender Capture (01E0) - No Receive PAcket with that data</p><p>but in the received file it is:</p><p>A3 D5 0F D9 10 B6 43 F3 @ Offset 1883087 - Packet #1814 in wireshark Sender Capture (0030) - Packet #6804 in Wireshark Receive Capture (0030)</p><p>This received string of bytes is found in the original file @ offset 1899228</p><p>1899228 - 1883087 = 16141 bytes of contiguous missing data</p><p>File size 5242880 byte (Sent) - 5226739 bytes (Received) = 16141 bytes, so this lines up too.</p><p>Is it looks like just his one big chunck is missing. Everything else, before and after, lines up.</p></div><div id="question-tags" class="tags-container tags">data tcp error</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>20 Jun '13, 10:58</strong></p><img src="https://secure.gravatar.com/avatar/b2300d01123e2ab3c9fe9f099c4d447a?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Tom%20Kuhn&#39;s gravatar image" /><p>Tom Kuhn<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Tom Kuhn has no accepted answers">0%</span> </br></p></div></div><div id="comments-container-22205" class="comments-container"><span id="22211"></span><div id="comment-22211" class="comment"><div id="post-22211-score" class="comment-score"></div><div class="comment-text"><p>Ah Thanks! Good to Know...</p><p>Sender Capture: <a href="http://cloudshark.org/captures/45f3ed36d2a5">http://cloudshark.org/captures/45f3ed36d2a5</a></p><p>Receiver Capture: <a href="http://cloudshark.org/captures/1a8fff96948c">http://cloudshark.org/captures/1a8fff96948c</a></p></div><div id="comment-22211-info" class="comment-info"><span class="comment-age">(20 Jun '13, 12:18)</span> Tom Kuhn</div></div><span id="22212"></span><div id="comment-22212" class="comment"><div id="post-22212-score" class="comment-score"></div><div class="comment-text"><p>I moved your comment to a more appropriate place under your question.</p></div><div id="comment-22212-info" class="comment-info"><span class="comment-age">(20 Jun '13, 13:10)</span> grahamb ♦</div></div><span id="22294"></span><div id="comment-22294" class="comment"><div id="post-22294-score" class="comment-score"></div><div class="comment-text"><p>Here is a graphical representation of whats going on. All traffic on the linux virtual NIC is forwarded out of the physical port (and Vice Versa).</p><p><img src="https://osqa-ask.wireshark.org/upfiles/IP_Issue_1.jpg" alt="alt text" /></p></div><div id="comment-22294-info" class="comment-info"><span class="comment-age">(24 Jun '13, 09:57)</span> Tom Kuhn</div></div><span id="22333"></span><div id="comment-22333" class="comment"><div id="post-22333-score" class="comment-score"></div><div class="comment-text"><p>Thanks for providing the picture. The data flows through 2 cascaded TCP connections, both of which seem to be happy with the amount of data flowing as they both orderly terminate with 2 FIN packets that get ack'ed, which means all lost packets have been dutifully retransmitted. That leaves only one conclusion: The missing data actually gets lost in the IP stack 'in the middle' that is receiving the data on socket_left (from 20.0.1.22 (port 1065) and is sending the data over socket_right towards 20.40.1.12:5020 (using client port number 2025). Whatever this TCP/IP stack is, it doesn't seem to be very mature given the wrong 'endianess' of the MSS option in its SYN packet.</p></div><div id="comment-22333-info" class="comment-info"><span class="comment-age">(25 Jun '13, 10:40)</span> mrEEde2</div></div><span id="22418"></span><div id="comment-22418" class="comment"><div id="post-22418-score" class="comment-score"></div><div class="comment-text"><p>Thank You. Your thoughts echo mine also. Thank you for your time in looking at this.</p></div><div id="comment-22418-info" class="comment-info"><span class="comment-age">(27 Jun '13, 09:30)</span> Tom Kuhn</div></div></div><div id="comment-tools-22205" class="comment-tools"></div><div class="clear"></div><div id="comment-22205-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="22207"></span>

<div id="answer-container-22207" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-22207-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>It the transport is TCP and there is data missing in the middle, then it must be the application. TCP is a connection oriented protocol with mechanisms to make sure that data is received properly. If there was data lost in transport or the vNIC, then TCP would make sure it's retransmitted.</p><p>Or the TCP/IP stack is broken... but then you would have other applications having problems too.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>20 Jun '13, 11:05</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></img></div></div><div id="comments-container-22207" class="comments-container"><span id="22208"></span><div id="comment-22208" class="comment"><div id="post-22208-score" class="comment-score"></div><div class="comment-text"><p>Come to find out I can not add attachments.</p></div><div id="comment-22208-info" class="comment-info"><span class="comment-age">(20 Jun '13, 11:10)</span> Tom Kuhn</div></div><span id="22209"></span><div id="comment-22209" class="comment"><div id="post-22209-score" class="comment-score"></div><div class="comment-text"><p>@Tom Kuhn, As long as the contents aren't sensitive (and as you were going to post them here they shouldn't be) you can upload the capture to <a href="http://cloudshark.org/">CloudShark</a> and post a link to the capture back here.</p></div><div id="comment-22209-info" class="comment-info"><span class="comment-age">(20 Jun '13, 11:36)</span> grahamb ♦</div></div><span id="22210"></span><div id="comment-22210" class="comment"><div id="post-22210-score" class="comment-score"></div><div class="comment-text"><p>That interesting. Since I do not have access under the hood of the actual socket , it is hard to see. My application is not catching any exceptions and there do not seem to be any error events.<br />
</p><p>As for other applications, this file tranfser SW is the only network application running on each of these laptops. The laptops only communicate between each other.</p><p>One other thing of note is that the sender transmitted 15 packets (That were not recieved) befor this final packet that started the continuation of incoming data (247 Bytes) to the receiver...</p><p>1814 14.981036000 20.0.1.22 20.40.1.12 TCP 301 [TCP Window Full] syscomlan &gt; zenginkyo-1 [ACK] Seq=1899229 Ack=1 Win=17520 Len=247</p></div><div id="comment-22210-info" class="comment-info"><span class="comment-age">(20 Jun '13, 12:08)</span> Tom Kuhn</div></div></div><div id="comment-tools-22207" class="comment-tools"></div><div class="clear"></div><div id="comment-22207-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="22213"></span>

<div id="answer-container-22213" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-22213-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>Are we looking at the same tcp session here? The timestamps differ but there are more curiosities.</p><p><strong>Sender Trace:</strong> The client is running a windows platform (TTL=128) and so is the server at an CaeElect MAC address. The client port number is 1065, the offered windows size by the client is <strong>16384</strong>, the 'MSS' option is 1460 (02:04:05:b4), followed by NOP,NOP,SACK <img src="https://osqa-ask.wireshark.org/upfiles/sender.png" alt="sender.png" /> <strong>Receiver Trace</strong>: The client port number is 2025, it is 5 hops away (TTL=123), the advertized windowsize is <strong>32768</strong>, MSS option is now in little endian: b4:05:04:02, sack is removed and 2 EOLs... <img src="https://osqa-ask.wireshark.org/upfiles/receiver.png" alt="alt text" /> So if the traces were really taken at the same time, it must be a proxy sitting at the <a href="http://www.caeelectronics.com/">CaeElect</a> MAC address that is terminating the tcp session towards the client and starting a new one towards the server. And it is probably this proxy that is dropping the packets.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>20 Jun '13, 14:20</strong></p><img src="https://secure.gravatar.com/avatar/d6607c3aca20db751d019d8bbd2da893?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde2&#39;s gravatar image" /><p>mrEEde2<br />
<span class="score" title="336 reputation points">336</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="14 badges"><span class="bronze">●</span><span class="badgecount">14</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde2 has 5 accepted answers">20%</span> </br></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 20 Jun '13, 14:26</p></div></div><div id="comments-container-22213" class="comments-container"><span id="22215"></span><div id="comment-22215" class="comment"><div id="post-22215-score" class="comment-score"></div><div class="comment-text"><p>The send and receive captures were running on separate machines at the same time.<br />
</p><p>I guess you could say there is a proxy of sorts, but I am not sure what it really is... More of a Serial to TCP Converter...<br />
</p><p>Since this data goes over a UHF radio, a third party hardware and software solution is used. Take the incoming capture. The hardware acts as a bridge between the radio's serial interface and the computers USB (I think of it as a USB Serial Interface) In addition, there is a driver with a TUN/TAP virtual adapter. When Receiving, the thought is... Serial data from the radio to the Hardware -&gt; convert to USB -&gt; Laptop USB -&gt; Some stack coverts De-serializes Serial data back into TCP data -&gt; pushes out the stack.</p><p>Unfortunately we do not have access to the source for this,</p></div><div id="comment-22215-info" class="comment-info"><span class="comment-age">(20 Jun '13, 17:52)</span> Tom Kuhn</div></div><span id="22602"></span><div id="comment-22602" class="comment"><div id="post-22602-score" class="comment-score"></div><div class="comment-text"><p>I have finally had the chance to perform some additional captures. I am looking through the first new capture and wanted to report what I am seeing in this one. I would like some thoughts to see if this is is another manifestation of a possible bad TCP stack design. In this instance, there was no missing data chink, but there was an error in some of the data in a single packet.</p><p>I did a small, random data, file transfer of only 100kB. This time, all the data transferred except that one small portion of data (15 bytes), inside a single packet, seems to have changed. The entire rest of the files is identical.</p><p>Sender File : <a href="http://www.cloudshark.org/captures/63e4629d73b1">http://www.cloudshark.org/captures/63e4629d73b1</a></p><p>Receiver File : <a href="http://www.cloudshark.org/captures/5b0a0c21a339">http://www.cloudshark.org/captures/5b0a0c21a339</a></p><p>It is packet #45 on the sender file and #206 on the receiver file. Sequence number 39421.</p><p>If anyone could shed light on this, that would be helpful.</p></div><div id="comment-22602-info" class="comment-info"><span class="comment-age">(03 Jul '13, 06:32)</span> Tom Kuhn</div></div></div><div id="comment-tools-22213" class="comment-tools"></div><div class="clear"></div><div id="comment-22213-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="22606"></span>

<div id="answer-container-22606" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-22606-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>there was no missing data chink, but there was an error in some of the data in a single packet.</p></blockquote><p>modified payload bytes are never a good sign ;-) So, now you need to find out which component in your setup modifies the bytes.</p><blockquote><p>I would like some thoughts to see if this is is another manifestation of a possible bad TCP stack design</p></blockquote><p>There are several bad signs in your capture file, as mentioned by others.</p><ol><li>Different source ports on client/server side (same for IP ID). This means the packets are not simply routed. As there is no NAT involved (same addresses), the TCP connection seems to be proxied at the TCP level.</li><li>Missing TCP options at server side (see 1.)</li><li>Different TCP Window size at server side (see 1.)</li><li>Missing packets (first capture files)</li><li>Modified payload bytes (latest capture file)</li></ol><p>Looking at that list, I think it's save to say that the TCP/IP implementation of one of the components it 'kind of broken' ;-)) It could be the virtual NIC (rather unusual), it could the USB driver or the RF radio part. Hard to tell...</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>03 Jul '13, 07:00</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 03 Jul '13, 07:04</p></div></div><div id="comments-container-22606" class="comments-container"><span id="22620"></span><div id="comment-22620" class="comment"><div id="post-22620-score" class="comment-score"></div><div class="comment-text"><p>Thanks Kurt. I have a few different vendors to get in touch with it seems. Unfortunately I do not know what is under the hood at the USB to TCP side of things. But this does provide a great amount to additional help for someone like me who could tell the difference between TCP window Size and a glass window size.</p></div><div id="comment-22620-info" class="comment-info"><span class="comment-age">(03 Jul '13, 12:42)</span> Tom Kuhn</div></div><span id="22621"></span><div id="comment-22621" class="comment"><div id="post-22621-score" class="comment-score"></div><div class="comment-text"><blockquote><p>tell the difference between TCP window Size and a glass window size.</p></blockquote><p>I'm not sure, but I <strong>believe</strong> one is measured in bytes and the other one in inches ;-)</p></div><div id="comment-22621-info" class="comment-info"><span class="comment-age">(03 Jul '13, 12:53)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-22606" class="comment-tools"></div><div class="clear"></div><div id="comment-22606-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

