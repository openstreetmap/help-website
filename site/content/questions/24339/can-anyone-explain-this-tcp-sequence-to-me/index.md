+++
type = "question"
title = "Can anyone explain this TCP sequence to me"
description = '''I have developed an application which reads data over a high volume network (2 sensors, both 1khz). The application reads the packets for a random time, and then crashes due to - what I believe to be - a native buffer overflow. The following image depicts the exacts packet sequence each time the cra...'''
date = "2013-09-04T04:40:00Z"
lastmod = "2013-09-04T06:14:00Z"
weight = 24339
keywords = [ "dup-ack", "rst" ]
aliases = [ "/questions/24339" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [Can anyone explain this TCP sequence to me](/questions/24339/can-anyone-explain-this-tcp-sequence-to-me)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24339-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I have developed an application which reads data over a high volume network (2 sensors, both 1khz).</p><p>The application reads the packets for a random time, and then crashes due to - what I believe to be - a native buffer overflow.</p><p>The following image depicts the exacts packet sequence each time the crash occurs - a large Dup ACK block followed by 2 RST flags.</p><p>Am I correct in thinking that this crash occurs due to the RWIN buffer being too small, and this in turn leads to the sending sockets shutting down. Any advice or suggestions is most appreiciated.</p><p>Edit - Updated with image of sequence pre DUP-ACK</p><p><img src="https://osqa-ask.wireshark.org/upfiles/4_-_Pre_Crash.jpg" alt="alt text" /></p><p><img src="https://osqa-ask.wireshark.org/upfiles/3_-_Final_Crash.jpg" alt="alt text" /></p></div><div id="question-tags" class="tags-container tags">dup-ack rst</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>04 Sep '13, 04:40</strong></p><img src="https://secure.gravatar.com/avatar/9916382bc95e6285924cb3a5b92d8ad3?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jnanathan&#39;s gravatar image" /><p>Jnanathan<br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jnanathan has no accepted answers">0%</span></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 04 Sep '13, 05:20</p></div></div><div id="comments-container-24339" class="comments-container"></div><div id="comment-tools-24339" class="comment-tools"></div><div class="clear"></div><div id="comment-24339-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="24344"></span>

<div id="answer-container-24344" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24344-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>I have developed an application which reads data over a high volume network (2 sensors, both 1khz).</p></blockquote><p>Is that just an application on top of a standard OS or are those 'embedded devices' with a their own TCP/IP stack?</p><p>That many DUP-ACK looks more than strange. I don't think that any recent OS (Windows, Linux) would send that many DUP-ACK that fast. So, I guess these are either duplicate packets (possibly a routing loop) or another problem in the TCP/IP stack.</p><p>Can you please add the following information:</p><ul><li>Check the IP ID of the packets marked with DUP-ACK. Is the ID IP increasing/changing or is it the same in every packet?</li><li>What OS are you using</li><li>Where did you capture the traffic</li></ul><p>BTW: is it possible to post the capture file instead of a screenshot? You can post the capture file on google docs, dropbox or cloudshark.</p><p><strong>UPDATE</strong></p><p>To me it looks like the Win7 system (your application) is not able to process the data (fast enough). In both TCP streams, the TCP window size reported by Win7 drops constantly until it reaches 0 (see tcp.stream eq 1 - it shows it pretty nicely).</p><p><img src="https://osqa-ask.wireshark.org/upfiles/io-graph_1.jpg" alt="IO-Graph" /></p><p>The embedded system keeps sending ACKs and the Win7 finally (after a long time) closes the connection with a RESET.</p><p>So, the key to your problem is: Why does the Win7 system lower its TCP window size, i.e. why is it incapable of handling the data (fast enough).</p><p>As that is your own application, the only way to understand that behavior is by debugging the application. Maybe the application does not receive the data it is expecting and your program logic waits for the correct data, until the TCP receive buffers are full.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>04 Sep '13, 06:14</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 06 Sep '13, 02:49</p></div></div><div id="comments-container-24344" class="comments-container"><span id="24380"></span><div id="comment-24380" class="comment"><div id="post-24380-score" class="comment-score"></div><div class="comment-text"><p>Hi Kurt, to answer your questions:</p><ol><li>Yes the data is coming from embedded devices which have implemented their own TCP IP stack</li><li>The IP.ID does increase with each DUP ACK in the sequence</li><li>The operating system that the program is running is Win 7</li><li>I have uploaded the capture file to mediafire, as it was too large for cloudshark. The link is found below</li></ol></div><div id="comment-24380-info" class="comment-info"><span class="comment-age">(05 Sep '13, 08:57)</span> Jnanathan</div></div><span id="24382"></span><div id="comment-24382" class="comment"><div id="post-24382-score" class="comment-score"></div><div class="comment-text"><p>I think the link got lost ;-)</p></div><div id="comment-24382-info" class="comment-info"><span class="comment-age">(05 Sep '13, 09:18)</span> Jasper ♦♦</div></div><span id="24404"></span><div id="comment-24404" class="comment"><div id="post-24404-score" class="comment-score"></div><div class="comment-text"><p>Cheers Jasper, it can be found below. I had to break the link into seperate parts to prevent it from being taken as spam.</p><p><a href="https://mega.co.nz/#!8M90VKaQ!RnvEnmIMWhm312QLrRy3R0CM6SsLaORN9x6K8rBLLb0">https://mega.co.nz/#!8M90VKaQ!RnvEnmIMWhm312QLrRy3R0CM6SsLaORN9x6K8rBLLb0</a></p></div><div id="comment-24404-info" class="comment-info"><span class="comment-age">(06 Sep '13, 00:46)</span> Jnanathan</div></div><span id="24405"></span><div id="comment-24405" class="comment"><div id="post-24405-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Yes the data is coming from embedded devices which <strong>have implemented their own TCP IP stack</strong> The operating system that the program is running is <strong>Win 7</strong></p></blockquote><p>O.K. please tell us the IP address of the Win7 system and the address of the embedded device.</p><p>BTW: I 'fixed' the link in your comment.</p></div><div id="comment-24405-info" class="comment-info"><span class="comment-age">(06 Sep '13, 00:52)</span> Kurt Knochner ♦</div></div><span id="24412"></span><div id="comment-24412" class="comment"><div id="post-24412-score" class="comment-score"></div><div class="comment-text"><p>Thanks Kurt. The address of the Win7 system is 109.168.0.2, and those of the two sensors are .106 &amp; .108.</p></div><div id="comment-24412-info" class="comment-info"><span class="comment-age">(06 Sep '13, 01:15)</span> Jnanathan</div></div><span id="24415"></span><div id="comment-24415" class="comment not_top_scorer"><div id="post-24415-score" class="comment-score"></div><div class="comment-text"><p>see the <strong>UPDATE</strong> in my answer.</p></div><div id="comment-24415-info" class="comment-info"><span class="comment-age">(06 Sep '13, 02:22)</span> Kurt Knochner ♦</div></div><span id="24421"></span><div id="comment-24421" class="comment not_top_scorer"><div id="post-24421-score" class="comment-score"></div><div class="comment-text"><p>Cheers for the break down Kurt. I believe this to be an issue with the hardware that the application is running on. The sensors are sending at a rate of 1khz each, and the host machine gets overloaded after a period of time - In that the CPU cannot process packets from the receive buffer, and this in turn causes the backlog. Thank you for your assistance.</p></div><div id="comment-24421-info" class="comment-info"><span class="comment-age">(06 Sep '13, 05:30)</span> Jnanathan</div></div><span id="24422"></span><div id="comment-24422" class="comment not_top_scorer"><div id="post-24422-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Thank you for your assistance.</p></blockquote><p>You're welcome.</p><p>Hint: If a supplied answer resolves your question can you please "accept" it by clicking the checkmark icon next to it. This highlights good answers for the benefit of subsequent users with the same or similar questions.</p></div><div id="comment-24422-info" class="comment-info"><span class="comment-age">(06 Sep '13, 05:46)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-24344" class="comment-tools"><span class="comments-showing"> showing 5 of 8 </span> <a href="#" class="show-all-comments-link">show 3 more comments</a></div><div class="clear"></div><div id="comment-24344-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="24341"></span>

<div id="answer-container-24341" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24341-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>I see only one RST; the others belong to a different connection (with the IP .108 instead of .106). But from that long long long list of Duplicate ACKs I can tell that something is going very wrong, and I guess your application has trouble with packet loss and recovery. There is no way to tell what stopped the sending process because it is not in the screenshot - the screenshot only tells the end of the story. It would be helpful to see how the Duplicate ACK series got started.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>04 Sep '13, 04:57</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></img></div></div><div id="comments-container-24341" class="comments-container"><span id="24342"></span><div id="comment-24342" class="comment"><div id="post-24342-score" class="comment-score"></div><div class="comment-text"><p>Hi Jasper.</p><p>Fist of all, I should have noted the 2 IPs of both sensors - being .106 &amp; .108</p><p>Secondly, I have re-edited the original with an image of the sequence before the DUP-ACK segment. As you will see there is a "TCP Window full" alert. Any idea what is causing this - might it be the buffer window on the receiving end?</p></div><div id="comment-24342-info" class="comment-info"><span class="comment-age">(04 Sep '13, 05:10)</span> Jnanathan</div></div><span id="24383"></span><div id="comment-24383" class="comment"><div id="post-24383-score" class="comment-score"></div><div class="comment-text"><p>Window full means that the sender has sent as many bytes as the receiver can buffer, so if you see that message it means that the sender has to pause and wait for the next acknowledge with a new window size to come in. In your case I'm pretty sure that this situation is the problem, because it doesn't seem to recover from that at all. I would expect a "Window Update" message from .2 to .108, but apparently it never arrives, so .108 cannot continue. The stack of .108 is also not behaving like most stacks, because it should do Window Probing instead of ACKing the last segment.</p></div><div id="comment-24383-info" class="comment-info"><span class="comment-age">(05 Sep '13, 09:27)</span> Jasper ♦♦</div></div></div><div id="comment-tools-24341" class="comment-tools"></div><div class="clear"></div><div id="comment-24341-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

