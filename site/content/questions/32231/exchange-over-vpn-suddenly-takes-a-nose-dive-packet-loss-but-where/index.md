+++
type = "question"
title = "Exchange over VPN suddenly takes a nose dive, packet loss but where"
description = '''Background: We have a tool that monitors application performance across our network. On Friday 28 Mar we notice a deviation from baseline of the retrains time from 28 ms to ~200 ms for our VPN users using Exchange starting at around 2300. Then on 31 Mar at 0951 it jumped to 1790 ms, needless to say,...'''
date = "2014-04-27T23:25:00Z"
lastmod = "2014-05-14T09:43:00Z"
weight = 32231
keywords = [ "latency", "router", "vpn", "exchange", "packetloss" ]
aliases = [ "/questions/32231" ]
osqa_answers = 1
osqa_accepted = false
+++

<div class="headNormal">

# [Exchange over VPN suddenly takes a nose dive, packet loss but where](/questions/32231/exchange-over-vpn-suddenly-takes-a-nose-dive-packet-loss-but-where)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32231-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32231-score" class="post-score" title="current number of votes">0</div><span id="post-32231-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Background:</p><p>We have a tool that monitors application performance across our network. On Friday 28 Mar we notice a deviation from baseline of the retrains time from 28 ms to ~200 ms for our VPN users using Exchange starting at around 2300. Then on 31 Mar at 0951 it jumped to 1790 ms, needless to say, that’s when our users started complaining about poor email performance. Of note, on the 28, we attempted an IOS upgrade to our core routers but it was rolled back at 2200. We do not host our own exchange servers, they are on a separate network. But, normal LAN users do NOT have the issue that VPN users do, nor did their performance take a hit, it is just VPN users. I am hoping some of the experts will spot something.</p><p>So, a user coming in over VPN comes across the internet, connects to this other network, which connects to our VPN concentrator which connects to one of our core routers which in turn connects back to the other network.</p><p>I’ve uploaded some packet captures for your viewing pleasure. The client IP is 192.168.1.1 and the server IP is 10.10.10.10. We were seeing some errors on the VPN concentrator and that was replaced. I have only one capture from home before the VPN was replaced.</p><p>One thing I noticed in that was that my MSS was 1160. I checked my MTU and sure enough, my physical NIC was set to 1300 and my VPN NIC to 1200. I do have a trace after the VPN change where I had changed my physical NIC to 1500 and my VPN NIC to 1400. With it set that way I can do a ping –f –l 1372 to my exchange server. When I try and connect my MSS is set to 1360 and the server replies with 1160.</p><p>All the laptops do have HIPS (McAfee), SEP (Symantec) installed.</p><p>Also of note, we do use asynchronous routing.</p><p>So my questions are: 1. We see packet loss, what’s the source, our network or the one hosting the Exchange servers? 2. Does MTU come into play? 3. I see a lot of retransmissions coming from the server, I do have a capture that was done at the core router but I couldn’t download it at home, it kept failing as it was a 100 MB file, I will try and get that uploaded tomorrow.</p><p>Edit 7:</p><p><a href="https://drive.google.com/file/d/0B0SDk9A4ChLGUlRuNmhBdnNPXzg/edit?usp=sharing">VPN Anon traffic</a></p><p>Just looking at this trace. If I use expert infos and go to the first "previous segment not captured" (packet 197) and look at 196, I see that it seems to be 2421 that has gone missing from stream 4. It looks like the time from the first loss to the last Dup ACK is 538 ms.</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Packet_Loss_Time_Ref_anon.PNG" alt="alt text" /></p><p>If I do a display filter of tcp.seq==2421 &amp;&amp; tcp.strem==4 then I see one packet, the re-transmit so it appears I am downstream from the packet loss.</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Lost_Packet.PNG" alt="alt text" /></p><p>I do have a capture done at the core router and I see the same pattern. Previous segment not captured, followed by a recovery process (Dup ACKs) and finally a re-transmit. And I only ever see the re-transmit.</p><p>So to me, given Laura Chappell's wonderful book, that indicates that even at the Core router we are still downstream from the loss and I need to yell at the network guys who also provide the exchange email service? Does that seem fair? Or am I totally lost and wandering in the wilds?</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-latency" rel="tag" title="see questions tagged &#39;latency&#39;">latency</span> <span class="post-tag tag-link-router" rel="tag" title="see questions tagged &#39;router&#39;">router</span> <span class="post-tag tag-link-vpn" rel="tag" title="see questions tagged &#39;vpn&#39;">vpn</span> <span class="post-tag tag-link-exchange" rel="tag" title="see questions tagged &#39;exchange&#39;">exchange</span> <span class="post-tag tag-link-packetloss" rel="tag" title="see questions tagged &#39;packetloss&#39;">packetloss</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>27 Apr '14, 23:25</strong></p><img src="https://secure.gravatar.com/avatar/5d07ae33b7a45a3b422b2be2b70a88fa?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="RTJ10&#39;s gravatar image" /><p><span>RTJ10</span><br />
<span class="score" title="16 reputation points">16</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="RTJ10 has no accepted answers">0%</span></p></img></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>28 Apr '14, 17:16</strong> </span></p></div></div><div id="comments-container-32231" class="comments-container"></div><div id="comment-tools-32231" class="comment-tools"></div><div class="clear"></div><div id="comment-32231-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="32235"></span>

<div id="answer-container-32235" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-32235-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-32235-score" class="post-score" title="current number of votes">0</div><span id="post-32235-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>The VPN client is not the problem here. You probably have the same MTU/MSS values on the VPN gateway, so I would not change them.</p><p>Are the packet captures from the client PC?</p><p>If yes, every packet from the server arrives at the client twice and it's not a retransmission, it's a duplicate.</p><p>Move your capture point closer to the server e.g. a switch or router on the internal side of the VPN gateway.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>28 Apr '14, 01:57</strong></p><img src="https://secure.gravatar.com/avatar/721b9692d2a30fc3b386b7fae9a44220?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Roland&#39;s gravatar image" /><p><span>Roland</span><br />
<span class="score" title="764 reputation points">764</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="15 badges"><span class="bronze">●</span><span class="badgecount">15</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Roland has 9 accepted answers">13%</span></p></img></div></div><div id="comments-container-32235" class="comments-container"><span id="32247"></span><div id="comment-32247" class="comment"><div id="post-32247-score" class="comment-score"></div><div class="comment-text"><p>Yes, the capture was done at the client. What would cause what you are describing? A routing issue/loop? A network diagram would look like: Client PC -&gt; VPN -&gt; Core Router -&gt; Black Hole -&gt; Exchange server. Inside the black hole there's all kinds of stuff, FWs, IPS, routers, switches etc, none of which I be able to do a capture on or between.</p></div><div id="comment-32247-info" class="comment-info"><span class="comment-age">(28 Apr '14, 04:13)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="32248"></span><div id="comment-32248" class="comment"><div id="post-32248-score" class="comment-score"></div><div class="comment-text"><p>I can probably arrange for a capture done at one or both of our core routers, but that the extent to which I have any access to networking devices through which the traffic must flow.</p></div><div id="comment-32248-info" class="comment-info"><span class="comment-age">(28 Apr '14, 04:47)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="32251"></span><div id="comment-32251" class="comment"><div id="post-32251-score" class="comment-score"></div><div class="comment-text"><p>I was doing some additional reading, and some of it seemed to indicate that this might not duplicate packet issue. I ran editcap -d on one of the files and it removed 1136 packets as duplicates with the window of 5 packets default setting.</p></div><div id="comment-32251-info" class="comment-info"><span class="comment-age">(28 Apr '14, 06:55)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="32268"></span><div id="comment-32268" class="comment"><div id="post-32268-score" class="comment-score"></div><div class="comment-text"><p>If you took the packet capture on the client without mirroring and no VLANs then I would say that the duplicates are genuine. Does the original packet capture before sanitizing it look the same? Packet captures from the core routers would be nice.</p></div><div id="comment-32268-info" class="comment-info"><span class="comment-age">(28 Apr '14, 11:47)</span> <span class="comment-user userinfo">Roland</span></div></div><span id="32271"></span><div id="comment-32271" class="comment"><div id="post-32271-score" class="comment-score"></div><div class="comment-text"><p>I do have one from core router but can't share it as I can't anon it for some reason. I was checking and it seems that the IPID and TTL are all the same, doesn't that indicate duplicates?</p></div><div id="comment-32271-info" class="comment-info"><span class="comment-age">(28 Apr '14, 16:53)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="32286"></span><div id="comment-32286" class="comment not_top_scorer"><div id="post-32286-score" class="comment-score"></div><div class="comment-text"><p>Do you see duplicate packets on the core router as well? Check the TTL, IP ID and VLAN ID.</p></div><div id="comment-32286-info" class="comment-info"><span class="comment-age">(29 Apr '14, 04:35)</span> <span class="comment-user userinfo">Roland</span></div></div><span id="32736"></span><div id="comment-32736" class="comment not_top_scorer"><div id="post-32736-score" class="comment-score"></div><div class="comment-text"><p><span>@Roland</span> Yes, when done at the core router, there are duplicates, they have the same IPID, TTL etc. I know some Juniper devices have something called packet protector that clones packets in cases where high packet loss is expected as a way to deal with it. Is it possible that there's something cloning the packets? I do know what when I do a capture say, of a plain file copy between my workstation and our datacenter, I do not see the dups.</p></div><div id="comment-32736-info" class="comment-info"><span class="comment-age">(12 May '14, 11:53)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="32799"></span><div id="comment-32799" class="comment not_top_scorer"><div id="post-32799-score" class="comment-score"></div><div class="comment-text"><p>I don't know if something is cloning the packets, but if all other services are working fine with the VPN connection apart from Exchange, I would also look at the server. If the packet capture looks fine there you can pinpoint the issue to the black hole.</p></div><div id="comment-32799-info" class="comment-info"><span class="comment-age">(14 May '14, 09:43)</span> <span class="comment-user userinfo">Roland</span></div></div></div><div id="comment-tools-32235" class="comment-tools"><span class="comments-showing"> showing 5 of 8 </span> <a href="#" class="show-all-comments-link">show 3 more comments</a></div><div class="clear"></div><div id="comment-32235-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

