+++
type = "question"
title = "Dup Acks and retransmission, only when sending particular data"
description = '''Hi All, I&#x27;m relativle new here (since I started troubleshooting this problem, I read a lot of posts :)). I would ask you guys if you could offer some suggestions about what might be going on here. We have an IP VPN connection between two sites, managed by a provider. Recently I configured a backup j...'''
date = "2016-06-29T01:07:00Z"
lastmod = "2016-06-30T02:07:00Z"
weight = 53710
keywords = [ "dup-ack", "retransmissions" ]
aliases = [ "/questions/53710" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Dup Acks and retransmission, only when sending particular data](/questions/53710/dup-acks-and-retransmission-only-when-sending-particular-data)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-53710-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-53710-score" class="post-score" title="current number of votes">0</div><span id="post-53710-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi All, I'm relativle new here (since I started troubleshooting this problem, I read a lot of posts :)). I would ask you guys if you could offer some suggestions about what might be going on here.</p><p>We have an IP VPN connection between two sites, managed by a provider. Recently I configured a backup job (in Veeam for who's interested) to backup servers from one site to the other. But the job would fail after only 256KB. Changing the job to a lower compression setting made it work. I can't remember why I even changed the compression however. Well, I openend a case with the backup vendor, but in the end they had me use wireshark on both sites because it turned out to be connection error. Wireshark shows a lot of duplicate ACKs and retransmissions.</p><p>I am 100% sure that all our firewall's are turned of, the provider claims to even not have any (in our path).</p><p>But now comes the strange part, as I tried to upload the wireshark capture from our datacenter site to the backup vendor, the upload failed as well. I used wireshark again during the FTP upload to capture, and it shows (as far as I could interpret) the same pattern, a short datastream and then dup acks and retransmissions and a RST eventually.</p><p>The provider that manages our IPVPN, also manages our primary internet connection. Both services are delivered through one 1Gbps ethernet uplink (tagged VLAN's). So by uploading the file, I would use part of the same 'physical' route as the IPVPN traffic. To be sure it was not our firewall I circumvented our firewall completely and plugged a server directly on to our internet VLAN and gave it a public IP. Did the upload again, same failure. Trying other files, no problem! We have a backup internet link, from another provider. I changed to that, and all uploads went fine. So problem is definately with our one provider, or so it would seem. But we can't figure out why we have only problems with uploading this file (and with making the backup). I also have been having networkprinter issues, where spooled jobs would just not print in about 10% of cases, also using their IPVPN. Trying to send the capture file via windows file shares over their IPVPN fails. other copies work fine. I have no clue what could cause this.</p><p>We thought of mtu sizes, but I can succesfully do a ping -l 1472 -f over the ipvpn. All my servers involved use a MTU of 1500.</p><p>But I remember that we changed the MTU of our printserver to as little as 500 bytes, and that was a huge imrpovement (but still no solution). I'm not sure if this is a related problem of course, but it seems so to me.</p><p>Below is screenshot of small part of the capture during the backup job. the capture is full of this. <img src="https://osqa-ask.wireshark.org/upfiles/captures.PNG" alt="alt text" /></p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-dup-ack" rel="tag" title="see questions tagged &#39;dup-ack&#39;">dup-ack</span> <span class="post-tag tag-link-retransmissions" rel="tag" title="see questions tagged &#39;retransmissions&#39;">retransmissions</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>29 Jun '16, 01:07</strong></p><img src="https://secure.gravatar.com/avatar/9f6fe4c441a346735ceacefc2a707541?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Tijs&#39;s gravatar image" /><p><span>Tijs</span><br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Tijs has no accepted answers">0%</span></p></img></div></div><div id="comments-container-53710" class="comments-container"><span id="53719"></span><div id="comment-53719" class="comment"><div id="post-53719-score" class="comment-score"></div><div class="comment-text"><p>I don't dare to post it as an Answer yet, but what you write resembles me of cases where particular bit sequences were causing some network cards or their drivers to err, causing the packet containing such pattern never to get through.</p><p>So I'd suggest to take several captures of transfer failures of different files, look at the first packet which could not get through (needed retransmission) in each of them, and check whether you can find anything similar about the contents of these packets.</p><p>If you capture at the sending machine, I would also strongly recommend to capture outside of it in parallel (using monitoring mode of a switch or similar means) to exclude an eventual weird behaviour of the sending machine itself.</p></div><div id="comment-53719-info" class="comment-info"><span class="comment-age">(29 Jun '16, 04:15)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="53723"></span><div id="comment-53723" class="comment"><div id="post-53723-score" class="comment-score"></div><div class="comment-text"><p>sindy may be right.</p><p>My first thought was there's some other security device (IDS?) on that primary path which is detecting something "suspicious" and killing the connection on you. Obviously this isn't your firewall but maybe something the IPVPN provider provides (as a service)?</p><p>Another next set of steps would be to do hop-by-hop captures: capture outside the sending machine then capture outside the first router then outside the next hop and so on. Obviously you'll need your ISP's help...</p></div><div id="comment-53723-info" class="comment-info"><span class="comment-age">(29 Jun '16, 06:12)</span> <span class="comment-user userinfo">JeffMorriss ♦</span></div></div><span id="53726"></span><div id="comment-53726" class="comment"><div id="post-53726-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your comments! I just got of the phone with our ISP, luckily it's not a big company and I spoke to one of their senior network guys. They are willing to help us troubleshoot. Sadly I only have one file (the wireshark capture) with which I can reproduce the problem, which is a weak case of course. 'I can't upload this one file, all others are working fine', luckily they want to help us.</p><p>Sindy, great comment about network cards, I troubleshooted from a VM before, let me try a physical machine or laptop next. On the other hand, when I configured that same VM with the VLAN and subnet of our other provider, everything worked smoothly... hmm.</p><p>Next step (with our ISP), is to circumvent our hardware altogether, and plug a laptop or something directly into their equipment and try to reproduce.</p><p>JeffMorris, indeed, if it aint a networkcard problem, that it must be a IDP right? But the network guy I just hung up with, swears they don't have anything like that. So that's why I logged this question, what else could it be, or is he mistaken and should we look for a firewall somewhere?</p><p>Oh well, will let you know what we find. In the meantime, any suggestion is welcome.</p></div><div id="comment-53726-info" class="comment-info"><span class="comment-age">(29 Jun '16, 07:01)</span> <span class="comment-user userinfo">Tijs</span></div></div><span id="53728"></span><div id="comment-53728" class="comment"><div id="post-53728-score" class="comment-score"></div><div class="comment-text"><blockquote><p>when I configured that same VM with the VLAN and subnet of our other provider, everything worked smoothly...</p></blockquote><p>if it is the case of "poisoning by bit pattern" which I've suggested, part of the destination IP or MAC address may be part of the bit pattern if the physical NIC of the server is affected. But more likely the issue is not affecting your local NIC - whatever actually happens, it may happen anywhere between the sending and receiving application, including the "poisoning by bit pattern".</p><blockquote><p>Sadly I only have one file (the wireshark capture) with which I can reproduce the problem</p></blockquote><p>No, you don't have just this single case - you can capture another unsuccessful synchronisation attempt, and then try to upload the resulting capture file the same way (important: without any kind of compression) and capture this attempt too. If you find that the "real" packet which breaks the original "sync" session is the same one which then breaks the "capture file upload" session when saved inside the capture file (I hope this description makes sense to you), you almost surely know that the poisonous bit pattern exists. Non-compressed pcap files contain bit-verbatim copies of the captured Ethernet frames (minus the leading sync pattern and the CRC).</p><p>As <span></span><span>@JeffMorris</span> wrote, to identify the guilty box (whatever the actual issue is), you'll have to slice the path by capturing at different points during repeated attempts to upload the trouble-causing file, each time splitting the path into halves like below:</p><pre><code>client - box1 - box2 - ... - boxN-1 - boxN - server
1.     ^                                   ^
2.     ^                   ^</code></pre><p>Capturing as per 1. should show that the critical packet has not reached the server.<br />
If capturing as per 2. shows that the critical packet from the client has reached the capturing point closer to the server, then 3., otherwise 4. etc:</p><pre><code>client - box1 - box2 - ... - boxN-1 - boxN - server
3.                         ^               ^
4.                   ^     ^</code></pre></div><div id="comment-53728-info" class="comment-info"><span class="comment-age">(29 Jun '16, 07:54)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="53744"></span><div id="comment-53744" class="comment"><div id="post-53744-score" class="comment-score"></div><div class="comment-text"><p>Well thanks again for offering your insights. It appears that both me and our ISP are not that provicient in packet capture, so we decided to first try and find the problem thtough trial and error...</p><p>I work for an IT company, and the ISP I mentioned is actually our partner, so many of our customers also use their services for internet connectivity. This allowed me to remotely login on a couple of our customers servers, and try the same upload. The upload failed too with some of our customers, but went ok for others. It turns out that our ISP has equipment mainly in two datacenters, and the customers where it failed go over the same hardware as we. Still, the guy was puzzled why in heavens name this one file could not upload.</p><p><span>@Sindy</span>, could a poisenous bit stream also affect cisco hardware? (I mean, have you ever heard of it), and if so, what could we do about it? Now we have narrowed it down, I'm secretly hoping he discovers some IDP feature is turned on by accident or whatever... I'll see if I can ask him what hardware they use exactly.</p></div><div id="comment-53744-info" class="comment-info"><span class="comment-age">(30 Jun '16, 00:02)</span> <span class="comment-user userinfo">Tijs</span></div></div><span id="53745"></span><div id="comment-53745" class="comment not_top_scorer"><div id="post-53745-score" class="comment-score"></div><div class="comment-text"><p>I have never heard about a poisonous bit pattern to affect Cisco hardware, but I've also not heard about many other things that exist :-)</p><p>My hands-on experience was an ADSL box which could not survive a transit VPN session (reboot within 2 minutes from start of use of each session established from a software client on PC and a remote sever, so the from the perspective of the affected box the VPN session was just a bi-directional UDP stream) and I have read a well-documented case of a particular NIC model on the internet.</p><p>If it is confirmed to be a hardware/firmware issue (i.e. not a configuration one), what to do about it depends on the stage of the lifecycle of the guilty equipment and how much the vendor cares about their reputation. Some boxes can be fixed by vendor within weeks while others can only be trashed.</p></div><div id="comment-53745-info" class="comment-info"><span class="comment-age">(30 Jun '16, 02:07)</span> <span class="comment-user userinfo">sindy</span></div></div></div><div id="comment-tools-53710" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-53710-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

