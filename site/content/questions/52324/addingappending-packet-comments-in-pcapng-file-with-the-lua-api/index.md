+++
type = "question"
title = "Adding/appending packet comments in pcapng file with the Lua API"
description = '''I looked through the API and coulnd find anything about adding/appending comments to pcapng files.  I need to lable 12mb of data...'''
date = "2016-05-08T15:23:00Z"
lastmod = "2016-05-09T07:32:00Z"
weight = 52324
keywords = [ "comment", "lua", "pcapng", "script" ]
aliases = [ "/questions/52324" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Adding/appending packet comments in pcapng file with the Lua API](/questions/52324/addingappending-packet-comments-in-pcapng-file-with-the-lua-api)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-52324-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I looked through the API and coulnd find anything about adding/appending comments to pcapng files. I need to lable 12mb of data...</p></div><div id="question-tags" class="tags-container tags">comment lua pcapng script</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>08 May '16, 15:23</strong></p><img src="https://secure.gravatar.com/avatar/f9df4644e8c578c944b68144e0e7adce?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="13utters&#39;s gravatar image" /><p>13utters<br />
<span class="score" title="11 reputation points">11</span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="13utters has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 09 May '16, 06:57</p><img src="https://secure.gravatar.com/avatar/e0564001bb7deb960d5d9d9c1e0ba074?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JeffMorriss&#39;s gravatar image" /><p>JeffMorriss ♦<br />
<span class="score" title="6219 reputation points"><span>6.2k</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="72 badges"><span class="bronze">●</span><span class="badgecount">72</span></span></p></div></div><div id="comments-container-52324" class="comments-container"><span id="52326"></span><div id="comment-52326" class="comment"><div id="post-52326-score" class="comment-score"></div><div class="comment-text"><blockquote><p>I looked through the API</p></blockquote><p>Which API?</p></div><div id="comment-52326-info" class="comment-info"><span class="comment-age">(08 May '16, 15:41)</span> Guy Harris ♦♦</div></div><span id="52327"></span><div id="comment-52327" class="comment"><div id="post-52327-score" class="comment-score"></div><div class="comment-text"><p><a href="https://wiki.wireshark.org/LuaAPI">https://wiki.wireshark.org/LuaAPI</a></p></div><div id="comment-52327-info" class="comment-info"><span class="comment-age">(08 May '16, 15:48)</span> 13utters</div></div></div><div id="comment-tools-52324" class="comment-tools"></div><div class="clear"></div><div id="comment-52324-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="52347"></span>

<div id="answer-container-52347" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-52347-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>Check out <code>captureinfo.comment</code> and <code>frameinfo.comment</code> in the <a href="https://www.wireshark.org/docs/wsdg_html_chunked/lua_module_File.html">Developer's Guide</a>.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>09 May '16, 07:32</strong></p><img src="https://secure.gravatar.com/avatar/e0564001bb7deb960d5d9d9c1e0ba074?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JeffMorriss&#39;s gravatar image" /><p>JeffMorriss ♦<br />
<span class="score" title="6219 reputation points"><span>6.2k</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="72 badges"><span class="bronze">●</span><span class="badgecount">72</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="JeffMorriss has 103 accepted answers">27%</span></p></div></div><div id="comments-container-52347" class="comments-container"><span id="52471"></span><div id="comment-52471" class="comment"><div id="post-52471-score" class="comment-score"></div><div class="comment-text"><p>I have trouble writing a new <code>captureinfo.comment</code> to the file my tab listing on. I only found examples of writing to .txt files, can u show me the way to do it ?</p></div><div id="comment-52471-info" class="comment-info"><span class="comment-age">(12 May '16, 07:32)</span> 13utters</div></div><span id="52481"></span><div id="comment-52481" class="comment"><div id="post-52481-score" class="comment-score">1</div><div class="comment-text"><p>Oh, shoot. It looks like that whole section I pointed you to is about <em>writing</em> file handlers in Lua. PCAPNG files are already handled by the C code.</p><p>So: my answers's no good. I don't see a method to access PCAPNG comments in Lua.</p><p>[I'd vote down my answer but apparently I'm not allowed!]</p></div><div id="comment-52481-info" class="comment-info"><span class="comment-age">(12 May '16, 14:18)</span> JeffMorriss ♦</div></div><span id="52747"></span><div id="comment-52747" class="comment"><div id="post-52747-score" class="comment-score"></div><div class="comment-text"><p>Hi JeffMorriss,</p><p>I am not sure where i go from there..</p><p>Is there a way to add comments to specific packets (e.g all ip.addr == 8.8.8.8) in ANSI C ? Do you have a good source for wireshark ANSI C ? Will lua be able to handle PCAPNG ?</p></div><div id="comment-52747-info" class="comment-info"><span class="comment-age">(18 May '16, 15:15)</span> 13utters</div></div><span id="52762"></span><div id="comment-52762" class="comment not_top_scorer"><div id="post-52762-score" class="comment-score"></div><div class="comment-text"><p>Just to make sure... you need the automatically generated comments to be stored into the pcapng file so that the resulting file could be open using any other Wireshark fresh installation and the comments would be there.</p><p>I.e. distributing a Lua post-dissector along with the pcapng file, which would add expert info or protocol fields during dissection, thus allowing packet filtering on the presence or contents of these forged fields, would not do the trick for you, correct?</p></div><div id="comment-52762-info" class="comment-info"><span class="comment-age">(19 May '16, 04:46)</span> sindy</div></div><span id="52764"></span><div id="comment-52764" class="comment not_top_scorer"><div id="post-52764-score" class="comment-score"></div><div class="comment-text"><p>My task is to label specific packets with a specific comments. Is the packet malicious or a consequences of malicious traffic and an identifier (attack_&lt;protocol_n&gt;:&lt;[mal|con]_N&gt;). My result will be fed into a machine learning algorithmus, to teach it how different attacks can look like.</p></div><div id="comment-52764-info" class="comment-info"><span class="comment-age">(19 May '16, 05:54)</span> 13utters</div></div><span id="52765"></span><div id="comment-52765" class="comment"><div id="post-52765-score" class="comment-score">1</div><div class="comment-text"><p>Do you need to be doing this in Wireshark? Who is inputting the comments--a human or a computer?</p><p>I worked on one project where we used packet comments to give the user some information. We just wrote the PCAPNG file directly--it's not that hard.</p><p>Or could you use <code>editcap -a &lt;frame.comment&gt;</code>?</p></div><div id="comment-52765-info" class="comment-info"><span class="comment-age">(19 May '16, 06:57)</span> JeffMorriss ♦</div></div><span id="52767"></span><div id="comment-52767" class="comment"><div id="post-52767-score" class="comment-score">1</div><div class="comment-text"><p>I understand @13utters' workflow the way that he needs to use Wireshark's dissection capabilities, further enhanced using Lua post-dissectors, to generate the packet classifications, but then the raw packet data, not packet dissections, shall be fed to the expert system together with the classifications. So I could still imagine two files could be used for this purpose - the original input pcapng and it's companion csv file which would be a result of a tshark run over the original input and contain only frame numbers (or timestamps or both as frame numbers are not explicitly stored in the pcapng and the timestamps may not be unique) and the classifications. Alternatively, "empty" classifications could be used, so that each frame of the original pcapng would have a classification on its own line of text, and either the expert system would handle this file set directly, or a script would read the original input pcapng and the classifications file synchronously and generate an output pcapng with comments.</p></div><div id="comment-52767-info" class="comment-info"><span class="comment-age">(19 May '16, 07:11)</span> sindy</div></div><span id="52773"></span><div id="comment-52773" class="comment not_top_scorer"><div id="post-52773-score" class="comment-score"></div><div class="comment-text"><p><a href="https://ask.wireshark.org/users/655/jeffmorriss"></a>@JeffMorriss I dont have to do it in Wireshark/Lua (thought it would be easy) and the comments can be written by computers, but humans have to decide weather the packet is malicious in this context or else, but the amount of data is to large to be handled by a human alone.</p><p>Just gave editcap a quick look and it seems to to do the job maybe (still need to get the speficic frame.number and feed it into editcap)</p><p><a href="https://ask.wireshark.org/users/19586/sindy"></a>@sindy I guess i have to learn about tshark creating csv files to understand your answer.</p></div><div id="comment-52773-info" class="comment-info"><span class="comment-age">(19 May '16, 08:14)</span> 13utters</div></div><span id="52786"></span><div id="comment-52786" class="comment not_top_scorer"><div id="post-52786-score" class="comment-score"></div><div class="comment-text"><p>not too much to learn, see below:</p><p><code>tshark -r "c:\Users\your_login\Captures\in.cap" -T fields -e frame.number -e ip.dst -E separator=, &gt; out.csv</code> creates the following contents of out.csv:</p><pre><code>1,10.20.127.53
2,212.47.21.121
3,10.20.127.53
4,10.20.127.53
5,212.47.21.121
6,212.47.21.121
...</code></pre><p>So your Lua post-dissector would create a single field (named e.g. <code>classification</code>) for those packets which are worth it, and you would replace <code>-e ip.dst</code> with <code>-e classification</code> in the example above. For those packets for which the Lua script would create the field, its value would be output to the file after the packet number; for the rest, only the packet number would be printed. By adding <code>-Y classification</code>, you would prevent these "packet number only" lines from being written to the output file.</p><p>Or, vice versa, you could let the Lua post-dissector create the classification field for every single packet, except that it would contain some special "don't care" value for packets which the expert system should ignore. In that case, you could omit the <code>-e frame.number</code> and you would get just the classification string for each packet, so the merging script could simply be reading one packet from the pcap file and one line from the list of classifications at a time, rather than keep track of packet numbers.</p></div><div id="comment-52786-info" class="comment-info"><span class="comment-age">(19 May '16, 12:55)</span> sindy</div></div></div><div id="comment-tools-52347" class="comment-tools"><span class="comments-showing"> showing 5 of 9 </span> <a href="#" class="show-all-comments-link">show 4 more comments</a></div><div class="clear"></div><div id="comment-52347-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

