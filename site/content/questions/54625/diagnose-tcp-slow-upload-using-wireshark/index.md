+++
type = "question"
title = "Diagnose TCP slow upload using WireShark"
description = '''Hi, I have a 25 mb up/25 mb down Internet Leased Line from Service Provider delivered directly from their MUX Port at their BTS. The problem is that I never get 25 mbps tcp upload speed. TCP download speed is perfectly 25 mbps. Also checked with UDP upload and download that is also 25 mbps. But when...'''
date = "2016-08-06T05:26:00Z"
lastmod = "2016-08-08T01:44:00Z"
weight = 54625
keywords = [ "upload" ]
aliases = [ "/questions/54625" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Diagnose TCP slow upload using WireShark](/questions/54625/diagnose-tcp-slow-upload-using-wireshark)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54625-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54625-score" class="post-score" title="current number of votes">0</div><span id="post-54625-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, I have a 25 mb up/25 mb down Internet Leased Line from Service Provider delivered directly from their MUX Port at their BTS. The problem is that I never get 25 mbps tcp upload speed. TCP download speed is perfectly 25 mbps. Also checked with UDP upload and download that is also 25 mbps. But when ever TCP Upload takes place the speed varies between 10 and 18 giving an average of 16 mbps max.</p><p>I have already talked with the provider and they are very casual and just showed UDP upload using WAN Killer software.. I need something strong to prove them.</p><p>Please guide me a proper troubleshooting process.. My link is delivered via 1 Gbps full duplex ethernet port both set at auto negotiation at MUX end and Laptop end.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-upload" rel="tag" title="see questions tagged &#39;upload&#39;">upload</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>06 Aug '16, 05:26</strong></p><img src="https://secure.gravatar.com/avatar/eb98c14d545ea1c961fdf94965df4da9?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="srijit92&#39;s gravatar image" /><p><span>srijit92</span><br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="srijit92 has no accepted answers">0%</span></p></div></div><div id="comments-container-54625" class="comments-container"><span id="54634"></span><div id="comment-54634" class="comment"><div id="post-54634-score" class="comment-score">1</div><div class="comment-text"><p>The transmission speed (regardless whether upload or download) does not depend only on the bandwidth of your connection to the ISP's POP but also on the available bandwidth on the path between the POP and the remote endpoint of the connection, as well as on the ability of the remote endpoint of the connection to process the incoming or outgoing data. You haven't given any information about the remote endpoint and its position in the network so it is hard to say whether it is some artificial limitation imposed by your ISP or something beyond their responsibility that reduces your TCP upload speed.</p><p>Another point is how you measure. Applications tend to indicate "netto" bitrates, i.e. without taking into account the overhead (IP and TCP headers of the packets) and eventual retransmissions.</p><p>So you may capture an upload of a single file and use Wireshark's statistics tools to find out what is the brutto bitrate on the session, see the number of retransmissions etc.</p></div><div id="comment-54634-info" class="comment-info"><span class="comment-age">(07 Aug '16, 06:04)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="54635"></span><div id="comment-54635" class="comment"><div id="post-54635-score" class="comment-score"></div><div class="comment-text"><p>You (we) should compare two sybchrobised traces: The first one should be taken as close as possible to the client and the second trace should be taken as close as possible to wan interface.</p></div><div id="comment-54635-info" class="comment-info"><span class="comment-age">(07 Aug '16, 11:48)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="54636"></span><div id="comment-54636" class="comment"><div id="post-54636-score" class="comment-score"></div><div class="comment-text"><p><span>@sindy</span> - I have upload the file to a server having more than 200 mbps uplink and enough free bandwidth was there for link testing.. The testing mechanism was first a simple speedtest, then ftp upload, iperf. Al results were almost same that is 25 mbps download but very unstable upload giving average of 16 mbps and not going between 5 to 18 mbps..</p><p>Also checked when I am downloading a file while upload is in progress then download is also falling drastically to 8 to 10 mb and total of up+down is between 25 to 30 mbps at all time..</p><p>I am confused why UDP is always fine but it breaks in TCP and that too in upload. In a simple 150 mb file upload to several server there are average 500+ re transmissions as seen from wireshark.</p><p>Link for PCAP - <a href="http://www.filedropper.com/wiresharkpcapng23a7996d-d285-4da2-816b-b1d2d743bde620160808080235a04252">http://www.filedropper.com/wiresharkpcapng23a7996d-d285-4da2-816b-b1d2d743bde620160808080235a04252</a> <a href="http://www.filedropper.com/zz_1">http://www.filedropper.com/zz_1</a></p></div><div id="comment-54636-info" class="comment-info"><span class="comment-age">(07 Aug '16, 19:45)</span> <span class="comment-user userinfo">srijit92</span></div></div><span id="54637"></span><div id="comment-54637" class="comment"><div id="post-54637-score" class="comment-score"></div><div class="comment-text"><p>From my point of view is your not much worth, if you want to say something about bandwith usage. There are a lot of "packet not captured" messages inside and in combination with "ACKED unseen packet" it seems that you didn´t capture every packet.</p><p>And also I can´t see any packet with IP.SRC= 104.211.104.104</p></div><div id="comment-54637-info" class="comment-info"><span class="comment-age">(08 Aug '16, 00:09)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="54638"></span><div id="comment-54638" class="comment"><div id="post-54638-score" class="comment-score"></div><div class="comment-text"><p>How do you want me to capture it? I captured the previous one after starting the uload and ending before its completion your ip.src shows only 1 packet</p></div><div id="comment-54638-info" class="comment-info"><span class="comment-age">(08 Aug '16, 01:29)</span> <span class="comment-user userinfo">srijit92</span></div></div><span id="54639"></span><div id="comment-54639" class="comment not_top_scorer"><div id="post-54639-score" class="comment-score"></div><div class="comment-text"><p>Before answering your last question: as the device from which you upload has a private IP address, I suppose there is a NATting router between that device and the uplink channel. It is possible that this router is the bottleneck, as processing NAT on TCP needs more resources than processing NAT on UDP.</p><p>To answer your question:</p><p>Please capture without any capture filter. You are interested in upload speed, but to understand what is happening, we need to see the reverse direction as well. If even without any capture filter there are still "previous packet not captured" messages, the possible reasons are the following:</p><ul><li><p>you are capturing using another machine than the one which uploads the file, and the capturing machine is too slow so it drops some packets</p></li><li><p>you are capturing on the machine which uploads the file but it is too slow so it drops some packets (which could also explain why it doesn't make use of the bandwidth)</p></li><li><p>you are capturing on the machine which uploads the file but its network card performs "TCP offloading" which causes some frames to bypass WinPcap/NPcap. Check the settings of your network card driver and disable any "TCP offloading" or "chimney" feature.</p></li></ul><p>In any case, start capturing before starting the upload (so that the session establishment phase is captured as some information is only available in the initial packets) and stop capturing when the upload finishes.</p><p>After saving the capture, apply a display filter <code>ip.addr == 104.211.104.104</code> and then use <code>File-&gt;Export Specified Packets-&gt;Displayed</code> to save only the tcp session of interest into a new file you would then publish.</p><p>It would be also good if you could <strong>simultaneously</strong> capture at the server itself and publish both captures. This could at least tell something about the behaviour of the NAT device.</p></div><div id="comment-54639-info" class="comment-info"><span class="comment-age">(08 Aug '16, 01:44)</span> <span class="comment-user userinfo">sindy</span></div></div></div><div id="comment-tools-54625" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-54625-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

