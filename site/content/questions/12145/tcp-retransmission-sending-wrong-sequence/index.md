+++
type = "question"
title = "TCP Retransmission sending wrong sequence"
description = '''Hi,  I hope someone here can help. I have seen a strange problem where our server seems to be retransmitting the segment prior to the one being requested by the Duplicate ACKs sent by the client. The Duplicate ACK is requesting re-transmission: Acknowledgement number: 422281 (relative ack number) So...'''
date = "2012-06-25T04:46:00Z"
lastmod = "2012-06-25T06:09:00Z"
weight = 12145
keywords = [ "retransmission" ]
aliases = [ "/questions/12145" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [TCP Retransmission sending wrong sequence](/questions/12145/tcp-retransmission-sending-wrong-sequence)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12145-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi,</p><p>I hope someone here can help. I have seen a strange problem where our server seems to be retransmitting the segment prior to the one being requested by the Duplicate ACKs sent by the client.</p><p>The Duplicate ACK is requesting re-transmission: Acknowledgement number: 422281 (relative ack number)</p><p>Sometimes I see an ICMP packet being sent by the server after receipt of the Duplicate ACK, usually in response to the first five of these Duplicate ACKs, but can be later as well, in this particular case the last five received too :<br />
ICMP 94 Destination unreachable (Host administratively prohibited)</p><p>Then the server retransmit sends the previous sequence:<br />
Sequence number: 420901 (relative sequence number)<br />
Next sequence number: 422281 (relative sequence number)</p><p>This continues until the conversation peters out after about a minute. Has anyone seen anything like this before?</p></div><div id="question-tags" class="tags-container tags">retransmission</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>25 Jun '12, 04:46</strong></p><img src="https://secure.gravatar.com/avatar/939e0e9467e1fd794cf46c50a73c7973?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Christian&#39;s gravatar image" /><p>Christian<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="bronze">●</span><span class="badgecount">1</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Christian has no accepted answers">0%</span> </br></br></p></div></div><div id="comments-container-12145" class="comments-container"><span id="12146"></span><div id="comment-12146" class="comment"><div id="post-12146-score" class="comment-score"></div><div class="comment-text"><p>I should add that the ACK and duplicates mentioned above are SACK packets with the SRE incrementing with each DupACK until all in-flight data is received and the server starts to retransmit the packet in the sequence prior to number requested.</p></div><div id="comment-12146-info" class="comment-info"><span class="comment-age">(25 Jun '12, 04:53)</span> Christian</div></div><span id="12149"></span><div id="comment-12149" class="comment"><div id="post-12149-score" class="comment-score"></div><div class="comment-text"><p>Further I suspect that something between client and server is meddling with the packets as the SLE and SRE transmitted by the client in the SACK is not the same as the SLE and SRE seen by the server.</p><p>Sent by client:<br />
96194 TCP 66 tksocket &gt; http [ACK] Seq=883 Ack=422281 Win=65535 Len=0 SLE=447121 SRE=448501</p><p>Received by server:<br />
340552 TCP 66 25882 &gt; http [ACK] Seq=883 Ack=422281 Win=65535 Len=0 SLE=1186682302 SRE=1186683682</p></div><div id="comment-12149-info" class="comment-info"><span class="comment-age">(25 Jun '12, 06:32)</span> Christian</div></div></div><div id="comment-tools-12145" class="comment-tools"></div><div class="clear"></div><div id="comment-12145-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="12147"></span>

<div id="answer-container-12147" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-12147-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>Where did you capture? I guess at the client side. Do you have verified the behavior by capturing on the server side as well? I suspect there's a firewall or similar device with ACLs in the communication path between client and server (the ICMP administratively prohibited indicates a "reject" rule existing somewhere).</p><p>If there is a firewall you need to verify first that the server actually gets the same TCP details that the client sent. A firewall might modify the TCP header in flight so that the server does not actually get the ACK numbers the client sent. Maybe it even removes the SACK options for whatever reason. So you need to make sure that the server sends data from before the last ACK number by verifying that behavior as close to the server as possible (but please not by capturing on the server itself, because that could give funny results, too). Don't forget to inspect and compare the SYN-SYN/ACK sequence at the beginning of the communication on both sides, because you might see that some TCP option negotiation is being influenced as well.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>25 Jun '12, 06:09</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span> </br></br></p></div></div><div id="comments-container-12147" class="comments-container"><span id="12150"></span><div id="comment-12150" class="comment"><div id="post-12150-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jasper, I managed to get traces simultaneously from both client and server. The problem is the web server is virtual, in a hosted location in London and the client is accessing through the internet so I am restricted to captures on the endpoints. I'm trying to pinpoint what I think is problem in a local authorities ISP making it even harder to get details about what is happening to the packets en-route.</p><p>There are some differences in the SYN, SYN-ACK packets, the MSS is different at either end, the server MSS is 1380, the clients is 1460 , TTL is different too, 121 to 128. Otherwise the rest seems the same</p><p>The ICMP is being sent by the server, and seems to relate to some of the SACK packets with the rubbish SLE/SRE (ports 80 and 443 are open). I was wondering whether the ICMP was produced because the SLE/SRE can't possibly be correct for the file being transmitted? I can see no other purpose for this ICMP as the host is reachable. This ICMP is also not reaching the client. I know the ISP blocks ICMP through its network on 'security' grounds.</p></div><div id="comment-12150-info" class="comment-info"><span class="comment-age">(25 Jun '12, 07:33)</span> Christian</div></div><span id="12159"></span><div id="comment-12159" class="comment"><div id="post-12159-score" class="comment-score"></div><div class="comment-text"><p>what is the payload of the ICMP packet? What is your OS at the server? Is there any security software installed on that server? Reason: That ICMP message is rather seldom (even for firewalls), so there must be a reason for this, IF it belongs to your problem (TCP connection), hence the question about the payload.</p></div><div id="comment-12159-info" class="comment-info"><span class="comment-age">(26 Jun '12, 00:14)</span> Kurt Knochner ♦</div></div><span id="12161"></span><div id="comment-12161" class="comment"><div id="post-12161-score" class="comment-score"></div><div class="comment-text"><p>regarding the broken SRE/SLE values.</p><p>Does this happen</p><ul><li>with every connection</li><li>some connections</li><li>some frames of one connection</li></ul></div><div id="comment-12161-info" class="comment-info"><span class="comment-age">(26 Jun '12, 01:38)</span> Kurt Knochner ♦</div></div><span id="12162"></span><div id="comment-12162" class="comment"><div id="post-12162-score" class="comment-score"></div><div class="comment-text"><p>CentOS 6.2 patched to last month, no extra security, just the default firewall allowing ssh, http and https set using system-config-firewall-tui. The ping contains the nonsense SLE/SRE from the previously received SACK packet in Options. SACK: 1186682302-1186685062</p><p>340552 (server) Arrival Time: Jun 20, 2012 15:56:38.036203000 BST Epoch Time: 1340204198.036203000 seconds</p><p>96194 (client) Arrival Time: Jun 20, 2012 15:56:38.021608000 BST Epoch Time: 1340204198.021608000 seconds</p></div><div id="comment-12162-info" class="comment-info"><span class="comment-age">(26 Jun '12, 01:54)</span> Christian</div></div><span id="12163"></span><div id="comment-12163" class="comment"><div id="post-12163-score" class="comment-score"></div><div class="comment-text"><p>can you please upload just those two packets to <a href="http://cloudshark.org">cloudshark.org</a>? I want to take a look at the SACK options in detail, not just the "Info Summary". You can change the IP addresses with '<a href="http://tcpreplay.synfin.net/wiki/tcprewrite">tcprewrite</a>'</p><p>HINT: You cannot delete anonymous uploads to cloudshark!</p></div><div id="comment-12163-info" class="comment-info"><span class="comment-age">(26 Jun '12, 01:59)</span> Kurt Knochner ♦</div></div><span id="12164"></span><div id="comment-12164" class="comment not_top_scorer"><div id="post-12164-score" class="comment-score"></div><div class="comment-text"><p>With every connection after data is lost in transit, SLE/SRE is always broken for connections passing through this service provider. The packets passing through the network are NATed by something and I suspect this device. As for the ICMP, I think it is trying to communicate the root of the problem, but as the network in question drops all ICMP "for security reasons", the packet mangling box is never getting to hear about it.</p></div><div id="comment-12164-info" class="comment-info"><span class="comment-age">(26 Jun '12, 02:13)</span> Christian</div></div><span id="12166"></span><div id="comment-12166" class="comment not_top_scorer"><div id="post-12166-score" class="comment-score"></div><div class="comment-text"><p>Are the packets NATed at the client side (Firewall/Router) or somewhere within the ISP network? If at the client side, is the NATed source port the same as in the packet at the server side (possible double NAT)?</p></div><div id="comment-12166-info" class="comment-info"><span class="comment-age">(26 Jun '12, 02:20)</span> Kurt Knochner ♦</div></div><span id="12167"></span><div id="comment-12167" class="comment not_top_scorer"><div id="post-12167-score" class="comment-score"></div><div class="comment-text"><p>Had to do this with two files, the first for the server I also included the ICMP response: <a href="http://cloudshark.org/captures/39ca99695903">http://cloudshark.org/captures/39ca99695903</a></p><p>The second for the client: <a href="http://cloudshark.org/captures/578b446be516">http://cloudshark.org/captures/578b446be516</a></p></div><div id="comment-12167-info" class="comment-info"><span class="comment-age">(26 Jun '12, 02:32)</span> Christian</div></div><span id="12168"></span><div id="comment-12168" class="comment not_top_scorer"><div id="post-12168-score" class="comment-score"></div><div class="comment-text"><p>I don't know the details of the NATing on their network, but it is not beyond the realms of possibility that it is a double NAT, however I notice their clients have 10.0.0.0 series IPs rather than the more usual 192.168 or 176. so potentially they could be just one big network.</p></div><div id="comment-12168-info" class="comment-info"><span class="comment-age">(26 Jun '12, 02:36)</span> Christian</div></div><span id="12169"></span><div id="comment-12169" class="comment not_top_scorer"><div id="post-12169-score" class="comment-score"></div><div class="comment-text"><p>tcprewrite seems to have messed up the SACK numbers in the ICMP packet. In my original file the SACK data contained in Options is as follows:<br />
SACK: 1186260022-1186261402<br />
left edge = 1186260022 (relative)<br />
right edge = 1186261402 (relative)</p></div><div id="comment-12169-info" class="comment-info"><span class="comment-age">(26 Jun '12, 03:11)</span> Christian</div></div><span id="12171"></span><div id="comment-12171" class="comment not_top_scorer"><div id="post-12171-score" class="comment-score"></div><div class="comment-text"><blockquote><p>tcprewrite seems to have messed up the SACK numbers in the ICMP packet.</p></blockquote><p>the values in the ICMP packet are the real (absolute SEQ numbers). Wireshark uses relative SEQ numbers per default. If you change that, the values in the TCP packet and the ICMP packet are identical.</p><blockquote><p><code>Edit -&gt; Preferences -&gt; Protocols -&gt; TCP -&gt; Relative Sequence Numbers</code></p></blockquote></div><div id="comment-12171-info" class="comment-info"><span class="comment-age">(26 Jun '12, 03:40)</span> Kurt Knochner ♦</div></div><span id="12172"></span><div id="comment-12172" class="comment not_top_scorer"><div id="post-12172-score" class="comment-score"></div><div class="comment-text"><blockquote><p>is always broken for connections passing through this service provider. The packets passing through the network are NATed by something and I suspect this device.</p></blockquote><p>there could be WAN accelerators in place that modify the values due to a bug. Without knowledge of the network architecture, it can be virtually anything :-(</p><p>It would be interesting to see if you can find a "pattern" for the SRE/SLE value changes (client versus server), like: always same delta, slightly changing delta, etc. You can do that with tshark: -T fields -e tcp.options.sack_le -e tcp.options.sack_re</p></div><div id="comment-12172-info" class="comment-info"><span class="comment-age">(26 Jun '12, 03:43)</span> Kurt Knochner ♦</div></div><span id="12173"></span><div id="comment-12173" class="comment not_top_scorer"><div id="post-12173-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your expert help, I'm going to recommend to the chaps in the ISP that they review their blanket ban on ICMP and investigate what is corrupting the SLE/SRE data in the packets. I don't know how they manage to get anything across their network!</p></div><div id="comment-12173-info" class="comment-info"><span class="comment-age">(26 Jun '12, 03:49)</span> Christian</div></div><span id="12174"></span><div id="comment-12174" class="comment not_top_scorer"><div id="post-12174-score" class="comment-score"></div><div class="comment-text"><p>If you provide the information about SRE/SLE to the ISP, give them the absolute SEQ numbers, not the relative ones.</p><p>Good luck!</p></div><div id="comment-12174-info" class="comment-info"><span class="comment-age">(26 Jun '12, 03:51)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-12147" class="comment-tools"><span class="comments-showing"> showing 5 of 14 </span> <a href="#" class="show-all-comments-link">show 9 more comments</a></div><div class="clear"></div><div id="comment-12147-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

