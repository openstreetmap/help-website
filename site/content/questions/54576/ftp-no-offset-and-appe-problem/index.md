+++
type = "question"
title = "FTP no offset and APPE problem"
description = '''Hey, I have two production machines in VLAN5 which sent data to VLAN10 where is Filezilla ftp server. One machine works ok, i mean data are trasfered corecctly with APPE command. Unfortunately on second is not. Example log of first one which is ok:  (000614)2016-08-01 11:25:43 - (not logged in) (192...'''
date = "2016-08-04T04:38:00Z"
lastmod = "2016-08-04T04:38:00Z"
weight = 54576
keywords = [ "ftp" ]
aliases = [ "/questions/54576" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [FTP no offset and APPE problem](/questions/54576/ftp-no-offset-and-appe-problem)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-54576-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hey,</p><p>I have two production machines in VLAN5 which sent data to VLAN10 where is Filezilla ftp server. One machine works ok, i mean data are trasfered corecctly with APPE command. Unfortunately on second is not. Example log of first one which is ok:</p><p><code></code></p><code></code><p><code>(000614)2016-08-01 11:25:43 - (not logged in) (192.168.XX.XX)&gt; Connected on port 21, sending welcome message... (000614)2016-08-01 11:25:43 - (not logged in) (192.168.XX.XX)&gt; 220 FTP Server (000614)2016-08-01 11:25:43 - (not logged in) (192.168.XX.XX)&gt; USER userX (000614)2016-08-01 11:25:43 - (not logged in) (192.168.XX.XX)&gt; 331 Password required for userX (000614)2016-08-01 11:25:43 - (not logged in) (192.168.XX.XX)&gt; PASS ** (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 230 Logged on (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; TYPE I (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 200 Type set to I (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; PASV (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 227 Entering Passive Mode (192,168,YYY,YYY,249,114) (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; APPE 6457_56_2016-8-1.txt (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 150 Opening data channel for file upload to server of "/6457_56_2016-8-1.txt", restarting at offset 17235 (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 426 Connection closed; aborted transfer of "/6457_56_2016-8-1.txt" (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; QUIT (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; 221 Goodbye (000614)2016-08-01 11:25:43 - userX (192.168.XX.XX)&gt; disconnected.</code></p><p>Second, which create file but file has always 0 data in it. Just empty.</p><p><code></code></p><code></code><p><code>(000594)2016-08-01 11:12:31 - (not logged in) (192.168.XX.YY)&gt; Connected on port 21, sending welcome message... (000594)2016-08-01 11:12:31 - (not logged in) (192.168.XX.YY)&gt; 220 FTP Server (000594)2016-08-01 11:12:31 - (not logged in) (192.168.XX.YY)&gt; USER userY (000594)2016-08-01 11:12:31 - (not logged in) (192.168.XX.YY)&gt; 331 Password required for userY (000594)2016-08-01 11:12:31 - (not logged in) (192.168.XX.YY)&gt; PASS ** (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 230 Logged on (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; TYPE I (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 200 Type set to I (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; PASV (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 227 Entering Passive Mode (192,168,XXX,XXX,198,207) (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; APPE test.txt (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 150 Opening data channel for file upload to server of "/test.txt" (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 426 Connection closed; aborted transfer of "/test.txt" (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; QUIT (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; 221 Goodbye (000594)2016-08-01 11:12:31 - userY (192.168.XX.YY)&gt; disconnected.</code></p><p>I've sniffed data on server and this is result:</p><p><code></code></p><code></code><p>GOOD Apply to end of file.</p><p>6939 2016-08-04 11:53:25.085005 192.168.0.11 192.168.1.200 FTP 78 Request: APPE rf_2_2016-8-4.txt 6940 2016-08-04 11:53:25.085005 192.168.0.11 192.168.1.200 TCP 60 49471 → 60988 [SYN] Seq=0 Win=4096 Len=0 MSS=1400 6942 2016-08-04 11:53:25.085005 192.168.0.11 192.168.1.200 TCP 60 49471 → 60988 [ACK] Seq=1 Ack=1 Win=4096 Len=0 6943 2016-08-04 11:53:25.085005 192.168.1.200 192.168.0.11 FTP 157 Response: 150 Opening data channel for file upload to server of "/rf_2_2016-8-4.txt", restarting at offset 3416 6947 2016-08-04 11:53:25.100605 192.168.0.11 192.168.1.200 TCP 60 49470 → 21 [ACK] Seq=73 Ack=250 Win=4096 Len=0 6948 2016-08-04 11:53:25.100605 192.168.0.11 192.168.1.200 FTP-DATA 197 FTP Data: 143 bytes 6949 2016-08-04 11:53:25.100605 192.168.0.11 192.168.1.200 TCP 60 49471 → 60988 [RST, ACK] Seq=144 Ack=1 Win=4096 Len=0 6950 2016-08-04 11:53:25.100605 192.168.1.200 192.168.0.11 FTP 119 Response: 426 Connection closed; aborted transfer of "/rf_2_2016-8-4.txt" 6952 2016-08-04 11:53:25.116206 192.168.0.11 192.168.1.200 FTP 60 Request: QUIT 6953 2016-08-04 11:53:25.116206 192.168.1.200 192.168.0.11 FTP 67 Response: 221 Goodbye 6954 2016-08-04 11:53:25.116206 192.168.1.200 192.168.0.11 TCP 54 21 → 49470 [FIN, ACK] Seq=328 Ack=79 Win=64322 Len=0 6955 2016-08-04 11:53:25.116206 192.168.0.11 192.168.1.200 TCP 60 49470 → 21 [ACK] Seq=79 Ack=329 Win=4083 Len=0 6956 2016-08-04 11:53:25.116206 192.168.0.11 192.168.1.200 TCP 60 49470 → 21 [RST, ACK] Seq=79 Ack=329 Win=4096 Len=0</p><p>BAD: No store data in file. File is 0 bytes</p><p>7568 2016-08-04 11:53:34.679128 192.168.0.48 192.168.1.200 FTP 81 Request: APPE r_1_2016-8-4CTC2.txt 7569 2016-08-04 11:53:34.679128 192.168.0.48 192.168.1.200 TCP 66 49441 → 50234 [SYN] Seq=0 Win=29200 Len=0 MSS=1400 SACK_PERM=1 WS=128 7570 2016-08-04 11:53:34.679128 192.168.1.200 192.168.0.48 TCP 66 50234 → 49441 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1460 WS=256 SACK_PERM=1 7571 2016-08-04 11:53:34.679128 192.168.0.48 192.168.1.200 TCP 60 49441 → 50234 [ACK] Seq=1 Ack=1 Win=29312 Len=0 7572 2016-08-04 11:53:34.679128 192.168.1.200 192.168.0.48 TCP 54 [TCP Window Update] 50234 → 49441 [ACK] Seq=1 Ack=1 Win=262144 Len=0 7573 2016-08-04 11:53:34.679128 192.168.1.200 192.168.0.48 FTP 133 Response: 150 Opening data channel for file upload to server of "/r_1_2016-8-4CTC2.txt" 7577 2016-08-04 11:53:34.694728 192.168.0.48 192.168.1.200 TCP 60 49441 → 50234 [RST, ACK] Seq=1 Ack=1 Win=29312 Len=0 7578 2016-08-04 11:53:34.694728 192.168.1.200 192.168.0.48 FTP 122 Response: 426 Connection closed; aborted transfer of "/r_1_2016-8-4CTC2.txt" 7579 2016-08-04 11:53:34.694728 192.168.0.48 192.168.1.200 TCP 60 49440 → 21 [ACK] Seq=77 Ack=295 Win=29312 Len=0 7580 2016-08-04 11:53:34.725929 192.168.0.48 192.168.1.200 FTP 60 Request: QUIT 7581 2016-08-04 11:53:34.725929 192.168.1.200 192.168.0.48 FTP 67 Response: 221 Goodbye 7582 2016-08-04 11:53:34.725929 192.168.1.200 192.168.0.48 TCP 54 21 → 49440 [FIN, ACK] Seq=308 Ack=83 Win=65536 Len=0 7584 2016-08-04 11:53:34.741529 192.168.0.48 192.168.1.200 TCP 60 49440 → 21 [RST, ACK] Seq=83 Ack=309 Win=29312 Len=0</p></code><p><code></code></p><p>It's look that ftp server don't open file to write and show end of file. What do You think? How can i solve it or make more tests.</p></div><div id="question-tags" class="tags-container tags">ftp</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>04 Aug '16, 04:38</strong></p><img src="https://secure.gravatar.com/avatar/1285da97ee7fe8695cd3c0f7a77847c9?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Tester1&#39;s gravatar image" /><p>Tester1<br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Tester1 has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 04 Aug '16, 04:39</p></div></div><div id="comments-container-54576" class="comments-container"><span id="54579"></span><div id="comment-54579" class="comment"><div id="post-54579-score" class="comment-score"></div><div class="comment-text"><p>Debugging on text is a pain in general; here, it is not clear what display filter you have used, so some overhead TCP messages (i.e. without FTP of FTP-DATA payload) may be missing. So if you can publish the complete capture files, maybe anonymized using Tracewrangler, you can get much more reasoned guesses.</p><p>Without the capture, I would first think of user privileges (where UserY may have different access rights to the target directory) and of firewall settings (where the FTP server may not be able to open the FTP-DATA TCP session towards the client Y).</p></div><div id="comment-54579-info" class="comment-info"><span class="comment-age">(04 Aug '16, 05:09)</span> sindy</div></div><span id="54580"></span><div id="comment-54580" class="comment"><div id="post-54580-score" class="comment-score"></div><div class="comment-text"><p>I've filtered IP of client and server. Is it enough?</p><p><a href="https://www.cloudshark.org/captures/f99b933801b9">https://www.cloudshark.org/captures/f99b933801b9</a> <a href="https://www.cloudshark.org/captures/980a9e53de20">https://www.cloudshark.org/captures/980a9e53de20</a></p></div><div id="comment-54580-info" class="comment-info"><span class="comment-age">(04 Aug '16, 06:19)</span> Tester1</div></div><span id="54581"></span><div id="comment-54581" class="comment"><div id="post-54581-score" class="comment-score"></div><div class="comment-text"><p>It is actually more than enough as you've also stripped the ftp and ftp-data payload :-) Substitution of the IP addresses but keeping the payload would have been better in this particular case.</p><p>What I can see is an attempt to set up a second TCP connection, presumably for ftp-data, which ends by RST (rather than FIN) sent by the TCP client (which is the FTP client as well in this case). This excludes the possibility that a firewall would prevent this session from being set up, but without the ftp payload it is hard to say more. So what about the user privileges, can you log in to the server as userY and check whether you can create a file in the ftpd's root directory?</p></div><div id="comment-54581-info" class="comment-info"><span class="comment-age">(04 Aug '16, 06:31)</span> sindy</div></div><span id="54582"></span><div id="comment-54582" class="comment"><div id="post-54582-score" class="comment-score"></div><div class="comment-text"><p>Only 3 machines upload\download to server text files. When i collect data for analyses only two machines work in the same time. So i don't think is ftp payload problem, becouse it's problem only one machine.</p><p>About privilages: I've tested on other user on which it works on first machine and the same problem. I made test: I've disconnected client (production machine) and give the same IP for notebook and from the ftp windows command line i've make append function and it works.</p><p><code> ftp&gt; append c:\temp\test.txt test.txt 200 Port command successful 150 Opening data channel for file upload to server of "/tests/test.txt", restarting at offset 93 226 Successfully transferred "/tests/test.txt" ftp: 11 bytes sent in 0.01Seconds 0.73Kbytes/sec. ftp&gt; append c:\temp\test.txt test.txt 200 Port command successful</code></p><p>I know that ftp windows client don't use passive mode.</p><p>What can i test next?</p></div><div id="comment-54582-info" class="comment-info"><span class="comment-age">(04 Aug '16, 06:48)</span> Tester1</div></div><span id="54584"></span><div id="comment-54584" class="comment"><div id="post-54584-score" class="comment-score"></div><div class="comment-text"><p>I haven't got it from the initial description, but can you confirm that only Append is problematic, while normal Put works fine from all machines? Because if yes, it is not a task for Wireshark, as that would mean an application level issue at either the server or the client, and Wireshark can only show you what happens at protocol level.</p></div><div id="comment-54584-info" class="comment-info"><span class="comment-age">(04 Aug '16, 11:35)</span> sindy</div></div><span id="54626"></span><div id="comment-54626" class="comment not_top_scorer"><div id="post-54626-score" class="comment-score"></div><div class="comment-text"><p>I can't test PUT on client, because it's PLC client and I have to ask to external programmer. I can ask him to modify it at Monday.</p><p>I made other test. On second server i've installed FTP server with the same configuration and it works :) Second server is in the same subnetwork like first one.</p><p>First server has had Kaspersky KES8, so i deinstalled and problem is the same. I thought that it can do something bad. I haven't any information in events.</p></div><div id="comment-54626-info" class="comment-info"><span class="comment-age">(06 Aug '16, 06:07)</span> Tester1</div></div></div><div id="comment-tools-54576" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-54576-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

