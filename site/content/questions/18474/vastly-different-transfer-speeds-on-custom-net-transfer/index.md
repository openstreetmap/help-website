+++
type = "question"
title = "Vastly different transfer speeds on custom .net transfer"
description = '''Hello All, Thanks for reading. I was wondering if you could take a look at these logs and tell me what&#x27;s happening. I&#x27;ll admit straight away I know almost nothing of networking other than the basics like setting up routers and port forwarding. Nothing low level. The problem is that I get very differ...'''
date = "2013-02-10T05:05:00Z"
lastmod = "2013-02-23T14:07:00Z"
weight = 18474
keywords = [ "dup", "ack", "slow", ".net", "tcp" ]
aliases = [ "/questions/18474" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Vastly different transfer speeds on custom .net transfer](/questions/18474/vastly-different-transfer-speeds-on-custom-net-transfer)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-18474-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-18474-score" class="post-score" title="current number of votes">0</div><span id="post-18474-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hello All, Thanks for reading. I was wondering if you could take a look at these logs and tell me what's happening.</p><p>I'll admit straight away I know almost nothing of networking other than the basics like setting up routers and port forwarding. Nothing low level.</p><p>The problem is that I get very different transfer speeds throughout the day. The logs show a transfer of about 200KB and it can range from ~2 seconds to 20+ seconds.</p><p>Here's what I know / what I've tried:</p><p>I've made a client/server program in .NET using TCPClient/Listener and it transfers byte arrays of UFT8 encoded strings as messages on the network stream object.</p><p>The read buffers are set to 1460 (not sure it makes a difference but I understand it that's the default packet size for the internet and it helps in debugging when I can see if there's a delay).</p><p>After some research I found that it could be a problem with the the packets not getting acknowledged quick enough so I followed the Microsoft KB article and set the registry value of TcpAckFrequency to 1.</p><p>The server uses non-blocking ports and I read there can be a problem with them if the information you're sending in the write is larger than the buffer on the NIC so I also added the NonBlockingSendSpecialBuffering registry value to 1.</p><p>I've also used setSockOpt to change the send buffer size so I know it's larger than the information being sent.</p><p>All the logs show information from the same code and same data, nothing has changed, it's just at a different time of day.</p><p>The problem always seems to start when a DUP ACK is sent to the server. This seems to put it in a spin and it doesn't recover.</p><p>At midday I usually get the average transfer speed (2-7 seconds), in the afternoon I get the slow speeds (20+ seconds) and at night it's all nice and fast (1-2 seconds).</p><p>I've tried looking at the logs but other than noticing the DUP ACKs I don't really know what I'm looking for (or if there's something missing that should be there).</p><p>So my questions are these: Is there anything I can do about this from my code? Or is it simply traffic on the line causing drops?</p><p>Links:</p><p>Slow <a href="https://www.cloudshark.org/captures/f8a9174ea25d">https://www.cloudshark.org/captures/f8a9174ea25d</a></p><p>Average <a href="https://www.cloudshark.org/captures/cf5fe673ad85">https://www.cloudshark.org/captures/cf5fe673ad85</a></p><p>Fast <a href="https://www.cloudshark.org/captures/7333076c9d0f">https://www.cloudshark.org/captures/7333076c9d0f</a></p><p>Help me Obi-Wan, you're my only hope,</p><p>Hal</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-dup" rel="tag" title="see questions tagged &#39;dup&#39;">dup</span> <span class="post-tag tag-link-ack" rel="tag" title="see questions tagged &#39;ack&#39;">ack</span> <span class="post-tag tag-link-slow" rel="tag" title="see questions tagged &#39;slow&#39;">slow</span> <span class="post-tag tag-link-.net" rel="tag" title="see questions tagged &#39;.net&#39;">.net</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>10 Feb '13, 05:05</strong></p><img src="https://secure.gravatar.com/avatar/d3e47bdea2f4c0f31f358fb558171cee?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="HAL9000&#39;s gravatar image" /><p><span>HAL9000</span><br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="HAL9000 has no accepted answers">0%</span></p></div></div><div id="comments-container-18474" class="comments-container"></div><div id="comment-tools-18474" class="comment-tools"></div><div class="clear"></div><div id="comment-18474-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="18481"></span>

<div id="answer-container-18481" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-18481-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-18481-score" class="post-score" title="current number of votes">2</div><span id="post-18481-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>For me this looks like you've got different line qualities depending on the time of day. I have seen this happen in a couple of cases where the fastest speeds where between midnight and noon, and getting worse from noon to midnight. As far as I can tell the reason for this is usually that - even though everybody has his own internet connection - the service providers bundle them at at "last mile" connection nodes/hubs. This means that when more people are at home surfing the web connectivity gets worse for all customers connected to a local hub, while it gets better when they go to sleep or are off to work.</p><p>I looked at your traces for a bit and as far as I can tell you suffer from packet loss (notice the "previous segment not captured" messages) in the slow AND average trace, but not the fast one. Your trace files are just excerpts from a larger capture, so unfortunately there is no TCP session handshake in the files to see the setup parameters, but I don't think they will tell us much. So without having done a full scale investigation I'd say your line has different qualities over the course of a day and you'll probably have to live with it. You could try and switch the internet service provider, but often you'll still end up on the same leased line with just a different address from where the invoice is sent.</p><p>By the way - please let the TcpAckFrequency stay where it was... acknowledging every packet will not help in most cases, and most certainly does not in yours. It's putting additional work on your nodes and line, and even though it's minimal effort you should go back to the usual ACK frequency of every other packet (and the trace is a little awkward to read if you're used to less frequent acknowledges, like I am). My advice would be to leave the stack settings alone until you are sure that you have a symptom that can be fixed with this. If it doesn't help (as it didn't in your case) go back to what it was.</p><p>Oh, and another thing: "The problem always seems to start when a DUP ACK is sent to the server. This seems to put it in a spin and it doesn't recover." - this isn't true. First of all, the problem starts with packet loss (DUP ACKs being a result of that, not the cause) indicated by "previous segment not seen" messages. And it does recover - if you check what segments are missing when something was "not seen" you can also see that the retransmissions coming in are filling up the gap each time. But the next packet loss happens shortly after the previous was recovered from, so it looks like there is constant trouble. But still, it does recover - otherwise, your transfer would never see the end of it at all :-)</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>10 Feb '13, 17:29</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p><span>Jasper ♦♦</span><br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>10 Feb '13, 17:35</strong> </span></p></div></div><div id="comments-container-18481" class="comments-container"><span id="18833"></span><div id="comment-18833" class="comment"><div id="post-18833-score" class="comment-score"></div><div class="comment-text"><p>Hi Jasper, thanks for the response. Apologies for the late reply (I got moved onto other business and this is the first real chance to look at this problem again.)</p><p>I'll do as you suggest and reset everything (you're right, if it doesn't help might as well set it back.)</p><p>It must be something I'm doing as at times it can take 6 minutes to pass 300KB of data! And if I go and download something else off the net the download speed is fine ~400KB/s.</p><p>Another random question but would you know of any delay built in that would pause transmission for 60 seconds?</p><p>Thanks again,</p><p>Hal</p></div><div id="comment-18833-info" class="comment-info"><span class="comment-age">(23 Feb '13, 14:04)</span> <span class="comment-user userinfo">HAL9000</span></div></div></div><div id="comment-tools-18481" class="comment-tools"></div><div class="clear"></div><div id="comment-18481-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="18545"></span>

<div id="answer-container-18545" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-18545-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-18545-score" class="post-score" title="current number of votes">0</div><span id="post-18545-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>a possible cause for the packet loss is simply another customer system up-/downloading large amounts of data, thus filling up the available bandwidth (ISO up-/download, P2P traffic, Web Radio, Youtube, Online Backup, Malware uploading the customers data/files, etc.). Unless you capture the whole traffic at the router interface, you won't see that and in your capture file (created at the internal client) you will only see the result: packet loss and slow transfer speed.</p><p>Did you check the utilization of your internet link during the times you run into this problem?</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>12 Feb '13, 05:10</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>12 Feb '13, 05:11</strong> </span></p></div></div><div id="comments-container-18545" class="comments-container"><span id="18834"></span><div id="comment-18834" class="comment"><div id="post-18834-score" class="comment-score"></div><div class="comment-text"><p>Hi Kurt,</p><p>Thanks for the help and apologies for the delay in replying.</p><p>Yes the only computer active on the network was mine and there was nothing else drawing on the bandwidth. But if I try and download something else off the net at the same time it has download speeds of ~400KB/s (and that's about average for DL speed here)</p><p>Cheers,</p><p>Hal</p></div><div id="comment-18834-info" class="comment-info"><span class="comment-age">(23 Feb '13, 14:07)</span> <span class="comment-user userinfo">HAL9000</span></div></div></div><div id="comment-tools-18545" class="comment-tools"></div><div class="clear"></div><div id="comment-18545-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

