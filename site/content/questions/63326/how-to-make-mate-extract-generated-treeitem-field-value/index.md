+++
type = "question"
title = "How to make MATE extract generated treeitem field value"
description = '''In my heuristic dissector for a private network protocol, I have the following generated treeitem added for 3-way handshaking purposes: -- field definition fclas.a2_srcrid = ProtoField.uint16(&quot;cmx_clud_as.srcrid&quot;,&quot;Src. Ref. ID (Calculated)&quot;,base.HEX)  -- field value assignment subtree:add(fclas.a2_s...'''
date = "2017-08-02T01:17:00Z"
lastmod = "2017-08-05T03:58:00Z"
weight = 63326
keywords = [ "generated", "mate", "treeitem" ]
aliases = [ "/questions/63326" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [How to make MATE extract generated treeitem field value](/questions/63326/how-to-make-mate-extract-generated-treeitem-field-value)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-63326-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>In my heuristic dissector for a private network protocol, I have the following generated treeitem added for 3-way handshaking purposes:</p><pre><code>-- field definition
fclas.a2_srcrid = ProtoField.uint16(&quot;cmx_clud_as.srcrid&quot;,&quot;Src. Ref. ID (Calculated)&quot;,base.HEX)

-- field value assignment
subtree:add(fclas.a2_srcrid,clas_srid):set_generated()</code></pre><p>The field and value can be seen in the Wireshark packet details window, surrounded by [], and can be used as display filter, but cannot be extracted by MATE for a pdu:</p><pre><code>-- // MATE pdu extract for generated field value
Extract sref From cmx_clud_as.srcrid;</code></pre><p>Please kindly advise if this is expected, and if there is a workaround -- to extract generated protocol treeitem field value.</p><p>Many thanks in advance.</p></div><div id="question-tags" class="tags-container tags">generated mate treeitem</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>02 Aug '17, 01:17</strong></p><img src="https://secure.gravatar.com/avatar/7e50c86ac4ee2038257acc83ccb1ce21?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="juandering&#39;s gravatar image" /><p>juandering<br />
<span class="score" title="11 reputation points">11</span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="juandering has one accepted answer">100%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 02 Aug '17, 01:22</p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p>sindy<br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span></p></div></div><div id="comments-container-63326" class="comments-container"><span id="63332"></span><div id="comment-63332" class="comment"><div id="post-63332-score" class="comment-score"></div><div class="comment-text"><p>Just spitballing here: What happens if you leave out the set_generated() call?</p></div><div id="comment-63332-info" class="comment-info"><span class="comment-age">(02 Aug '17, 02:58)</span> Jaap ♦</div></div><span id="63334"></span><div id="comment-63334" class="comment"><div id="post-63334-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jaap.</p><p>If I leave out the set_generated() call, the result is the same.</p><p>Seems MATE extracts field values only if they come with the packet. Generated field values (not from TvbRange) are discarded, or not seen?</p></div><div id="comment-63334-info" class="comment-info"><span class="comment-age">(02 Aug '17, 03:20)</span> juandering</div></div><span id="63336"></span><div id="comment-63336" class="comment"><div id="post-63336-score" class="comment-score"></div><div class="comment-text"><p>If I can make this work with generated field from hash table, then a 3-way handshake like below is peanuts to track for MATE.</p><p>First PDU:</p><p>SrcMAC to DstMAC \ clud_as_cr with src_ref_id (0x0001)</p><p>2nd PDU:</p><p>Switched DstMAC to SrcMAC \ clud_as_ack1 with dst_ref_id (0x0001) and src_ref_id (0x3456)</p><p>3rd PDU:</p><p>SrcMAC to DstMAC \ clud_as_ack2 with dst_ref_id (0x3456) and generated src_ref_id (0x0001)</p><p>MATE Gop can have key of SrcMAC, DstMAC, src_ref_id. And this will work even if there are overlaps of the 3-way handshakes.</p></div><div id="comment-63336-info" class="comment-info"><span class="comment-age">(02 Aug '17, 03:50)</span> juandering</div></div><span id="63343"></span><div id="comment-63343" class="comment"><div id="post-63343-score" class="comment-score"></div><div class="comment-text"><p><a href="https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=12182">It is known</a> that MATE has issues even with some "native" dissectors. As it searches for fields only within specified protocol layers, it wouldn't surprise me if it would ignore generated fields which cannot be physically found in the packet data.</p><p>Don't hesitate to paste the debug output here once you get it.</p></div><div id="comment-63343-info" class="comment-info"><span class="comment-age">(02 Aug '17, 08:54)</span> sindy</div></div><span id="63396"></span><div id="comment-63396" class="comment"><div id="post-63396-score" class="comment-score"></div><div class="comment-text"><p>You were right Sindy, my generated field cannot be discovered / extracted by MATE since it is not really physically included in the packet. In my case, it is just a reference ID from an earlier packet, passed via hash table.</p><p>In my 3-way handshake, the original transaction between data source and the destination is many many packets past.</p><p>Currently, every time the data sender sends data, it sends a source ref ID. The data receiver acknowledges with Ack1, containing the sender's source ref ID, and the receiver's destination ref ID. The data sender sends Ack2 with the data receiver's destination ref ID.</p><p>3-way handshakes can sometimes overlap, and sometimes the sender-destination can also reverse in the "overlap". So, the only way to track a conversation I see, is to tie the two directed (source and destination) ref IDs with the sender-destination combination.</p><p>Unluckily, MATE will not extract the generated source ref ID for Ack2.</p><p>Perhaps somebody around has a workaround to share please?</p><p>Thanks.</p></div><div id="comment-63396-info" class="comment-info"><span class="comment-age">(04 Aug '17, 04:26)</span> juandering</div></div><span id="63397"></span><div id="comment-63397" class="comment not_top_scorer"><div id="post-63397-score" class="comment-score"></div><div class="comment-text"><p>The pdu debug output for the 3 packets - data send with src ref ID, Ack1 with dst and src ref IDs, Ack2 with dst ref ID:</p><p>The "found field 0-0" is the result of referencing the Ack2 src ref ID generated field; no TvB range address.</p><pre><code>mate_analyze_frame: trying to extract: clud_as_pdu
mate_analyze_frame: found matching proto, extracting: clud_as_pdu
new_pdu: type=clud_as_pdu framenum=1
...
get_pdu_fields: found field 70-72
get_pdu_fields: got sref=0x00006423
...
mate_analyze_frame: trying to extract: clud_as_pdu
mate_analyze_frame: found matching proto, extracting: clud_as_pdu
new_pdu: type=clud_as_pdu framenum=2
...
get_pdu_fields: found field 71-73
get_pdu_fields: got sref=0x00006423
get_pdu_fields: found field 69-71
get_pdu_fields: got dref=0x0000170f
...
mate_analyze_frame: trying to extract: clud_as_pdu
mate_analyze_frame: found matching proto, extracting: clud_as_pdu
new_pdu: type=clud_as_pdu framenum=3
...
get_pdu_fields: found field 0-0
get_pdu_fields: found field 69-71
get_pdu_fields: got dref=0x0000170f</code></pre></div><div id="comment-63397-info" class="comment-info"><span class="comment-age">(04 Aug '17, 04:29)</span> juandering</div></div><span id="63398"></span><div id="comment-63398" class="comment not_top_scorer"><div id="post-63398-score" class="comment-score"></div><div class="comment-text"><p>Leaving MATE aside, I'm a bit lost in your explanation, are the refIDs unique per transaction or only unique per source? I do understand that they differ between source and destination and that they are not common between Req and ACK2 of the same trasaction.</p><p>Second, MATE was intended as a generic tool allowing to match together packets from <strong>different</strong> protocols. You are creating your own dissector for a single protocol, so it is far simpler to track the transactions in its code. Take the TCP dissector for loose inspiration, it generates fields called Stream index (<code>tcp.stream</code>). You can assign arbitrary numbers to your transactions and store them in an associative array indexed by frame number. If, for a given frame number, the transaction number is already assigned, leave it unchanged. If it is not (which indicates the first dissection pass) and you process a request, you assign the next free one and store this newly assigned transaction number to another associative array indexed by the source refID. If handling ACK1, you also check whether a transaction number has already been assigned for that frame number (if not, it indicates the first dissection pass), and if not, you use source refID to find it in the second array; if you don't find it there, you assign the next free one because it means that the request is missing in the capture. In both cases, you then store the transaction number to a third array, indexed by destination refID. And for ACK2 you act similarly, except that you only search for transaction number in the third associative array.</p><p>The second and third arrays may have to be indexed by combination of refID and source L3 address if refID alone is not "unique enough".</p><p>There is a Question dealing with similar topic somewhere here but I cannot remember any keyword to identify it.</p></div><div id="comment-63398-info" class="comment-info"><span class="comment-age">(04 Aug '17, 05:01)</span> sindy</div></div><span id="63410"></span><div id="comment-63410" class="comment not_top_scorer"><div id="post-63410-score" class="comment-score"></div><div class="comment-text"><p>The ref IDs are unique per source.</p><p>My newbie heuristic dissector in Lua, dissects a few other protocols in the company's suite of network protocols for different applications.</p><p>I have not gone yet into conversation or stream tracking yet -- and don't know if Lua is enough, or if we need to go C++.</p><p>With Lua, I was hoping to make use of MATE for grouping the related pdus, plus using MATEs timing capabilities for handshake timing validations.</p><p>Just now I was trying your suggested associative arrays to track frame numbers already processed, and using L3 Src and Dst MAC as conversation stream keys for the second and third tables to pass the required ref IDs. I think with Lua only, my logic below does not work properly:</p><p>if (frames_done[pinfo.number] == nil) then</p><p>-- process this stream ref1_table[L3SrcMAC .. L3DstMAC] = ref1_id stream_num = stream_num + 1 frames_done[pinfo.number] = stream_num end</p><p>If I remove the if testing, the stream_num keeps jumping when I click on a packet in the packet display.</p><p>I think this is similar to pinfo.visited issue that from the forum entries I have seen before, does not work with Lua dissectors -- needing C++ to work.</p><p>Please bear with my newbieness on this matter; plus lack of C++ resources.</p><p>Thanks.</p></div><div id="comment-63410-info" class="comment-info"><span class="comment-age">(04 Aug '17, 15:34)</span> juandering</div></div><span id="63415"></span><div id="comment-63415" class="comment not_top_scorer"><div id="post-63415-score" class="comment-score"></div><div class="comment-text"><blockquote><p>With Lua, I was hoping to<br />
1) make use of MATE for grouping the related pdus, plus<br />
2) using MATEs timing capabilities for handshake timing validations.</p></blockquote><p>1) is confirmed to be impossible with current implementation of MATE, which is the answer to your original Question</p><p>2) seems to me to be the same case as the transaction number is a generated field as well, so you can't use it to build a GoP. So you'll have to introduce generated fields like <code>ack1_delay</code>, <code>ack2_delay</code> to deal with the timing in the dissector itself as well.</p><p>Having said that, I think that given the purpose and rules of this site, it is time that you ask a new Question about your issue which won't mention MATE, Answer the current one with the conclusion we've come to, and accept that Answer.</p><blockquote><p>I think this is similar to pinfo.visited issue that from the forum entries I have seen before, does not work with Lua dissectors</p></blockquote><p>Well, I think the opposite. Your <code>frames_done</code> table is, among other purposes, a replacement of <code>pinfo.visited</code> which you create and maintain yourself, so any eventual bug rendering <code>pinfo.visited</code> unusable in Lua doesn't affect it. I would rather suspect something like declaration of the table in a wrong place, causing it to be re-created with each new call of <code>yourproto.dissector</code>.</p><blockquote><p>Please bear with my ... lack of C++ resources.</p></blockquote><p>I'm in the same boat. An iteration of Lua development is so quick as compared to that of C++ one that I never considered rolling out the full development environment seriously. You've just confused me into thinking that you use C by calling an associative array a hash table.</p></div><div id="comment-63415-info" class="comment-info"><span class="comment-age">(04 Aug '17, 23:29)</span> sindy</div></div><span id="63417"></span><div id="comment-63417" class="comment not_top_scorer"><div id="post-63417-score" class="comment-score"></div><div class="comment-text"><p>Sindy, I am having difficulties posting the answer. Keep getting red prompt text "* This field is required." when I click "Anwer Your Own Question".</p><p>Something about my comments seem to be spam? Or too many attempts in posting a comment / answer?</p></div><div id="comment-63417-info" class="comment-info"><span class="comment-age">(05 Aug '17, 03:58)</span> juandering</div></div><span id="63419"></span><div id="comment-63419" class="comment not_top_scorer"><div id="post-63419-score" class="comment-score"></div><div class="comment-text"><p>No idea. The site engine started behaving funny recently, and as it is not maintained any more, it is unlikely to bet better. At least it permitted me to convert your Comment into an Answer and slightly edit it (it is not important whether the field is generated by Lua or C++ dissector), now it is your job to Accept it to highlight the Question as usefully answered in the question list for others.</p></div><div id="comment-63419-info" class="comment-info"><span class="comment-age">(05 Aug '17, 04:10)</span> sindy</div></div></div><div id="comment-tools-63326" class="comment-tools"><span class="comments-showing"> showing 5 of 11 </span> <a href="#" class="show-all-comments-link">show 6 more comments</a></div><div class="clear"></div><div id="comment-63326-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="63418"></span>

<div id="answer-container-63418" class="answer accepted-answer answered-by-owner">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-63418-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>Extracting generated protocol fields (those which are not physically present in frame data) is impossible with the current implementation of MATE which checks that the fields extracted are located within the payload of the indicated transport.</p><p>Thanks to matey <a href="https://ask.wireshark.org/users/19586/sindy"></a><a href="https://ask.wireshark.org/users/19586/sindy">@sindy</a></a> for the kind guidance in checking this issue. I will now try using associative tables in my dissector to track conversation handshakes.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>05 Aug '17, 03:58</strong></p><img src="https://secure.gravatar.com/avatar/7e50c86ac4ee2038257acc83ccb1ce21?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="juandering&#39;s gravatar image" /><p>juandering<br />
<span class="score" title="11 reputation points">11</span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="juandering has one accepted answer">100%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p>edited 05 Aug '17, 04:12</p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p>sindy<br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span></p></div></div><div id="comments-container-63418" class="comments-container"></div><div id="comment-tools-63418" class="comment-tools"></div><div class="clear"></div><div id="comment-63418-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

