+++
type = "question"
title = "Router appears to block proper TCP Session Teardown (FIN, ACK), Ever See This?"
description = '''We have several Cisco (Linksys) RV082 routers in our networks. I have been trying to run down a problem with a new application that appears to be network related. After 3 weeks of investigation, it appears our RV082 router is terminating some TCP conversations before the full teardown handshake can ...'''
date = "2013-02-25T11:52:00Z"
lastmod = "2013-02-25T15:25:00Z"
weight = 18858
keywords = [ "ack", "handshake", "fin", "tcp", "rv082" ]
aliases = [ "/questions/18858" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Router appears to block proper TCP Session Teardown (FIN, ACK), Ever See This?](/questions/18858/router-appears-to-block-proper-tcp-session-teardown-fin-ack-ever-see-this)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-18858-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>We have several Cisco (Linksys) RV082 routers in our networks. I have been trying to run down a problem with a new application that appears to be network related. After 3 weeks of investigation, it appears our RV082 router is terminating some TCP conversations before the full teardown handshake can take place. I have done simultaneous packet capture on both sides of the router and compared the conversations/sessions. (I can provide full packet captures if it comes to that).</p><p>Anyway, The client is INSIDE the network and the SERVER is outside. The client establishes an HTTP session with the server. This all looks OK. Data is requested and received. The problem starts when the server then requests that the session be terminated.</p><p>[Start of session...] Server: [FIN, ACK] Client: [ACK]</p><p>The client then sends 10 FIN, ACK packets (in exponentially increasing delay) which never make it through the router. It appears that the router has slammed the door after the client ACK's the server's FIN, ACK...</p><p>This is not an isolated problem and I can see exactly the same behavior on many occasions. Although it appears that the conversation payload is being delivered, I suspect the application in question is throwing away the data if it thinks the port was not closed properly. I've been trying to educate myself on whether this is the root cause of our issue, and everything I read seems to indicate that this is not proper behavior.</p><p>I've posted this info on the Cisco SMB support forum, but they don't seem to have any interest in commenting on this behavior. (They reply with some boilerplate about making sure I don't have an Virus' on my network and that all my NIC cards are working properly!)</p><p>Has anyone ever seem this before? Is this likely a bona-fida bug in our router's firmware?<br />
</p></div><div id="question-tags" class="tags-container tags">ack handshake fin tcp rv082</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>25 Feb '13, 11:52</strong></p><img src="https://secure.gravatar.com/avatar/81ae17d36e548026e62525855b896541?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="evanevery&#39;s gravatar image" /><p>evanevery<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="evanevery has no accepted answers">0%</span> </br></p></div></div><div id="comments-container-18858" class="comments-container"></div><div id="comment-tools-18858" class="comment-tools"></div><div class="clear"></div><div id="comment-18858-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="18867"></span>

<div id="answer-container-18867" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-18867-score" class="post-score" title="current number of votes">3</div></div></td><td><div class="item-right"><div class="answer-body"><p>Replacing the routers may solve your problem, but I think it's premature to put all the blame on the routers. It seems that you also have an application that's not as well behaved as it could be. Let's start with the image you posted of captured traffic at <a href="http://homecommunity.cisco.com/t5/Wired-Routers/RV082-Dropping-Packets-captures-included/td-p/612638">http://homecommunity.cisco.com/t5/Wired-Routers/RV082-Dropping-Packets-captures-included/td-p/612638</a> .</p><p>It appears that the time display format was set to "Seconds since beginning of capture." In packet 8, the server sends its FIN/ACK. In packet 9, 39 ms later, the client responds with an ACK. In packet 10, <em>over 39 seconds later</em>, the client sends its own FIN/ACK.</p><p>So, the first question for the application developers is, "Why does the application wait <em>39 seconds</em> to issue its own FIN/ACK when it has no data to send?"</p><p>On the Cisco site, you said the TCP timeout is set to 1800 seconds. That's a lot more than 39 seconds, but that's probably the timeout for an idle connection, that is, one on which no data has moved. Your router likely has a different, shorter timeout for a connection on which a FIN/ACK has been seen. I'd guess that this timer is 30 seconds or less. So, is the router "slamming the door prematurely"? Well, it's slamming the door before the client responds, but 39 seconds is a long time in networking. If this other timer is user configurable, you might be able to fix your problem by changing the timeout value to, say, a minute.</p><p>I see this behavior on my home network. My anti-virus software contacts the update server. After the data exchange is complete, the server sends a FIN/ACK. Sometimes the client responds with its own FIN/ACK within a second or two. In that case, the connection closes normally. Other times, the client waits a full minute or more before sending its FIN/ACK. By this time, the router has cleared the session information, so the router returns an ICMP "Destination unreachable, network unreachable" packet. The client sends six FIN/ACKs, and when it doesn't get a response to any of them, it finally sends a RST and then gives up. However, if I wasn't using Wireshark, I would never know anything was wrong. In fact, from the user perspective nothing <em>is</em> wrong.</p><p>However, in your case, as you posted on the Cisco site, "This causes a lot of problems with a particular application which simply throws away the whole conversation since the port/conversation 'wasn't closed properly.'"</p><p>So the second question for the application developers is, "Why does the application throw away an entire conversation <em>that is known to be good</em> simply because there was a technical problem with the last packet of the tear down procedure?"</p><p>The client knows that the server has no more data to send because it has received the server's FIN packet. The client can tell from the sequence number in the FIN packet that it has successfully received all the data that the server sent. The client can tell from the ACK number in the server's FIN packet that the server successfully received all the data that the client sent. So, regardless of whether the connection terminated correctly or not, the client can tell that all the data was transferred successfully.</p><p>It seems to me that the developers have been a bit lazy, and they're just assuming that the data may be incomplete or bad if the connection didn't close properly. If they would reprogram the app to actually determine from the sequence and acknowledgment numbers if all the data has been received properly, the app would be much more robust under real-world network conditions, like my anti-virus app.</p><p>The fact that you're not having a similar problem with all your applications indicates that it's at least partly an application problem. The problem will go away when you replace your routers <em>if</em> the new routers have a FIN/ACK teardown timer that is longer than your application's response time, otherwise you will still have the problem.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>25 Feb '13, 15:25</strong></p><img src="https://secure.gravatar.com/avatar/071fe61f64868d98bdf4eb060b63b6ca?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jim%20Aragon&#39;s gravatar image" /><p>Jim Aragon<br />
<span class="score" title="7187 reputation points"><span>7.2k</span></span><span title="7 badges"><span class="badge1">●</span><span class="badgecount">7</span></span><span title="33 badges"><span class="silver">●</span><span class="badgecount">33</span></span><span title="118 badges"><span class="bronze">●</span><span class="badgecount">118</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jim Aragon has 70 accepted answers">24%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 25 Feb '13, 18:08</p></div></div><div id="comments-container-18867" class="comments-container"><span id="18882"></span><div id="comment-18882" class="comment"><div id="post-18882-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jim! I'm in 100% agreement with your analysis. I've asked the developer about this on several occasions. Why does it appear they ignore a perfectly good payload just because the teardown (port closure) may have returned an error. I still have not got any response from them... Its somewhat comforting to see that I was/am on the correct path here.</p></div><div id="comment-18882-info" class="comment-info"><span class="comment-age">(26 Feb '13, 07:22)</span> evanevery</div></div><span id="18883"></span><div id="comment-18883" class="comment"><div id="post-18883-score" class="comment-score"></div><div class="comment-text"><p>It sounds as if this applications was developed and tested on a LAN where it did not have to pass through any NAT or firewall devices, but it's not actually ready for service under real-world WAN network conditions. Any NAT router you buy will have a FIN teardown timer, and on a SOHO class router like the RV082, it will not generally be user-configurable. As mentioned above, if the teardown timer is longer than the application's response time, you won't see this problem any more; however, the problem won't be gone, it will just be masked by the long timer. They really need to tune the app.</p></div><div id="comment-18883-info" class="comment-info"><span class="comment-age">(26 Feb '13, 09:07)</span> Jim Aragon</div></div><span id="18888"></span><div id="comment-18888" class="comment"><div id="post-18888-score" class="comment-score"></div><div class="comment-text"><p>Is the application related to Commtouch Antispam (see the last comment in my answer)? If so, is your developer using the API of Commtouch?</p></div><div id="comment-18888-info" class="comment-info"><span class="comment-age">(26 Feb '13, 11:25)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-18867" class="comment-tools"></div><div class="clear"></div><div id="comment-18867-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="18860"></span>

<div id="answer-container-18860" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-18860-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>As you've added much more information in the Cisco forum, I'll post the links here. If you don't like that, please add a comment and I'll delete the links.</p><blockquote><p><code>https://supportforums.cisco.com/thread/2199005</code><br />
<code>http://homecommunity.cisco.com/t5/Wired-Routers/RV082-Dropping-Packets-captures-included/td-p/612638</code><br />
</p></blockquote><p>So, to me it looks like the routers firewall clears the session table entry very soon after it receives the first FIN packet from the server. Any further packet from the client (FIN,ACK) will then be dropped and logged as "Connection Refused - Policy violation"). So, this seems to be a firmware issue with the RV082 and should be solved by Cisco.</p><p>As an alternative, you could try to install OpenWRT, dd-wrt or NSLU2 on the RV082 (not sure if any of those properly support the RV082 - please google yourself ;-)).</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>25 Feb '13, 12:41</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div></div><div id="comments-container-18860" class="comments-container"><span id="18861"></span><div id="comment-18861" class="comment"><div id="post-18861-score" class="comment-score"></div><div class="comment-text"><p>No problem posting those links... Thanks for asking though!</p><p>Thank you for confirming my suspicion. I could not get a straight answer anywhere else! Based on the lack of support from the CISCO SMB group, we are already in process of getting the routers replaced. We are replacing them with Netgear UTM150's which have some additional security features...</p><p>It really is a shame when someone works hard to isolate a pretty major problem and then the vendor does not even spend the time to read the findings...</p><p>Thanks so much for your information. I feel better knowing that the replacement of the RV082's is the correct thing to do!</p></div><div id="comment-18861-info" class="comment-info"><span class="comment-age">(25 Feb '13, 13:19)</span> evanevery</div></div><span id="18870"></span><div id="comment-18870" class="comment"><div id="post-18870-score" class="comment-score"></div><div class="comment-text"><p>before you replace the router, please consider what @Jim Aragon said about the behavior of your application (see his answer).</p><p>BTW: Is that an application you developed or simply a web application accessed by a standard browser. If so, what happens if you use a different browser? Is any client code involved (java, java script, flash)?</p><p>The mentioned IP address belongs to c1iprep1.ctmail.com, which is part of a mail security system (Antispam) of Commtouch Software.</p></div><div id="comment-18870-info" class="comment-info"><span class="comment-age">(25 Feb '13, 17:30)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-18860" class="comment-tools"></div><div class="clear"></div><div id="comment-18860-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

