+++
type = "question"
title = "TCP Retransmission - Server sends wrong SeqNo?"
description = '''Hi I had to analyze network packets because of an application that crashed quite a lot. So I stumbled upon TCP retransmissions, and did a simple setup to start &#x27;troubleshooting&#x27;. I connected two Laptops running SystemRescueLinux two the same switch (Gigabit Switch, Cat6 cables) and opened an SSH con...'''
date = "2015-11-12T04:37:00Z"
lastmod = "2015-11-13T06:00:00Z"
weight = 47542
keywords = [ "tcp", "tcp-retransmit" ]
aliases = [ "/questions/47542" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [TCP Retransmission - Server sends wrong SeqNo?](/questions/47542/tcp-retransmission-server-sends-wrong-seqno)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-47542-score" class="post-score" title="current number of votes">1</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi</p><p>I had to analyze network packets because of an application that crashed quite a lot. So I stumbled upon TCP retransmissions, and did a simple setup to start 'troubleshooting'. I connected two Laptops running SystemRescueLinux two the same switch (Gigabit Switch, Cat6 cables) and opened an SSH connection from one machine to the other, running 'tcpdump -i &lt;netif&gt; -s65535 -w file.pcap' on both client and server.</p><p>I was analyzing the packets just before the TCP retransmission happens in both the PCAPs, and if I did not make any mistake, the server sends an invalid Sequencenumber causing the retransmission...</p><p>ClientIP: 10.41.1.87 ServerIP: 10.41.1.88</p><p>Client side looks like: <img src="http://ianfe.dyndns.org/Client.png" alt="alt text" /></p><p>Server side looks like: <img src="http://ianfe.dyndns.org/Server.png" alt="alt text" /></p><p>Client-Side starting with packet no 1890:<br />
2018416+5792 --&gt; 2024208 --&gt; Correct!<br />
2024208+7240 --&gt; 2031448 --&gt; Correct!<br />
2031448+4836 --&gt; 2036284 --&gt; WTF? Got 2035792?<br />
<br />
Server-Side starting with packet no 1878:<br />
1989456+24616 --&gt; 2014072 --&gt; Correct!<br />
2014072+22212 --&gt; 2036284 --&gt; Seems to match what I calculated on client side, but not what the server actually sent?<br />
</p><p>So,...I'm at a loss here. Is this the network driver? The NIC? The...I don't know? Did I miss something? I suppose it's definitely not the switch in between, at least that's what I'm trying to find out,...but what is it then?</p><p>Kind regards</p><p>EDIT</p><p>Ok, as requested, here's the PCAP of the TCP stream:<br />
Server: <a href="http://ianfe.dyndns.org/server_tcp.pcap">Server PCAP</a><br />
Client: <a href="http://ianfe.dyndns.org/client_tcp.pcap">Client PCAP</a><br />
</p></div><div id="question-tags" class="tags-container tags">tcp tcp-retransmit</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>12 Nov '15, 04:37</strong></p><img src="https://secure.gravatar.com/avatar/001a62488d7db5d6571ad5771ae03d52?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="esc4rg0t&#39;s gravatar image" /><p>esc4rg0t<br />
<span class="score" title="26 reputation points">26</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="7 badges"><span class="bronze">●</span><span class="badgecount">7</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="esc4rg0t has no accepted answers">0%</span> </br></br></p></img></div><div class="post-update-info post-update-info-edited"><p>edited 13 Nov '15, 00:02</p></div></div><div id="comments-container-47542" class="comments-container"><span id="47543"></span><div id="comment-47543" class="comment"><div id="post-47543-score" class="comment-score"></div><div class="comment-text"><p>Hi,<br />
as the captures are encrypted and coming from a lab test, would you mind placing them somewhere to the cloud and posting links to them here to allow more comfortable analysis?<br />
BR, Pavel</p></div><div id="comment-47543-info" class="comment-info"><span class="comment-age">(12 Nov '15, 08:02)</span> sindy</div></div><span id="47546"></span><div id="comment-47546" class="comment"><div id="post-47546-score" class="comment-score"></div><div class="comment-text"><p>Or, if paranoid, run them through a sanitization task with TraceWrangler, and tell it to cut payloads after layer 4 :)</p></div><div id="comment-47546-info" class="comment-info"><span class="comment-age">(12 Nov '15, 09:11)</span> Jasper ♦♦</div></div></div><div id="comment-tools-47542" class="comment-tools"></div><div class="clear"></div><div id="comment-47542-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="47573"></span>

<div id="answer-container-47573" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-47573-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>I don't think the packet size or offloading is the cause, at least not the direct one.</p><p>The packet with <code>ip.id == 0x8a75</code> has 24682 octets including all headers (24616 tcp payload) when sent by server, but only 4410 (4344) when received by client, and another 3 directly following packets (with different ip ids) carry the rest of its tcp payload, but all four of them are acknowledged by a single ACK seen in the captures from both ends.</p><p>The same situation repeats for the immediately following "jumbo packet" with <code>ip.id == 0x8a86</code>, except that this time the client does not send any ACK, and so the retransmission takes place in about 10 ms.</p><p><strong>But</strong> there is a significant difference between these two "jumbo packets": the second one, which causes the retransmission, carries the PSH (push) flag in it, which is logically only available in the last packet of the series.</p><p>So I would vote for some issue in buffer handling (or the ssh client maybe?): when the receiving side (client) gets the Push command, it should send the buffer contents to the application immediately, and in some cases something goes wrong and it takes too long so the stack cannot send the backward packet with ACK on time.</p><p>A similar situation can be seen with frames 1651, 1652 at client side and 1742, 1743 at server side, and at least one more time (use display filter <code>tcp.analysis.retransmission</code>). Or, in yet another words, in these captures, no packet without the PSH flag needed to be retransmitted.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>13 Nov '15, 06:00</strong></p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p>sindy<br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="sindy has 110 accepted answers">24%</span> </br></br></p></img></div></div><div id="comments-container-47573" class="comments-container"><span id="47716"></span><div id="comment-47716" class="comment"><div id="post-47716-score" class="comment-score"></div><div class="comment-text"><p>Can u tell how to send last packet without push flag ???</p><p>what is the best solution ????</p></div><div id="comment-47716-info" class="comment-info"><span class="comment-age">(18 Nov '15, 06:49)</span> srinu_bel</div></div><span id="47717"></span><div id="comment-47717" class="comment"><div id="post-47717-score" class="comment-score"></div><div class="comment-text"><p>Not the right place to ask, I'd ask that at <a href="http://stackoverflow.com/questions">Stackoverflow programmers' Q&amp;A</a>, because it is an application and/or driver related question, not wireshark or network traffic <em>analysis</em> one.</p></div><div id="comment-47717-info" class="comment-info"><span class="comment-age">(18 Nov '15, 06:55)</span> sindy</div></div><span id="47720"></span><div id="comment-47720" class="comment"><div id="post-47720-score" class="comment-score"></div><div class="comment-text"><p>e-mail id please ???</p></div><div id="comment-47720-info" class="comment-info"><span class="comment-age">(18 Nov '15, 07:06)</span> srinu_bel</div></div></div><div id="comment-tools-47573" class="comment-tools"></div><div class="clear"></div><div id="comment-47573-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="47561"></span>

<div id="answer-container-47561" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-47561-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>Can u limit packet size to 1448 Bytes in place of 24616 / 22212</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>13 Nov '15, 02:28</strong></p><img src="https://secure.gravatar.com/avatar/ce1843f92a1c18db26bc79b3afa9bd50?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="srinu_bel&#39;s gravatar image" /><p>srinu_bel<br />
<span class="score" title="20 reputation points">20</span><span title="15 badges"><span class="badge1">●</span><span class="badgecount">15</span></span><span title="16 badges"><span class="silver">●</span><span class="badgecount">16</span></span><span title="20 badges"><span class="bronze">●</span><span class="badgecount">20</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="srinu_bel has no accepted answers">0%</span> </br></br></p></div></div><div id="comments-container-47561" class="comments-container"><span id="47562"></span><div id="comment-47562" class="comment"><div id="post-47562-score" class="comment-score"></div><div class="comment-text"><p>Ahm...what exactly do you mean by that? Do I have to make a new trace, or...? As I put the pcap files for download now (see first post)...</p></div><div id="comment-47562-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:32)</span> esc4rg0t</div></div><span id="47563"></span><div id="comment-47563" class="comment"><div id="post-47563-score" class="comment-score"></div><div class="comment-text"><p>Application server is sending very big TCP segments, Is it possible to limit the size of TCP segment to 1448 insted of 24616 / 22212 ???</p></div><div id="comment-47563-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:36)</span> srinu_bel</div></div><span id="47564"></span><div id="comment-47564" class="comment"><div id="post-47564-score" class="comment-score"></div><div class="comment-text"><p>Application server is sending very big TCP segments, Is it possible to limit the size of TCP segment to 1448 insted of 24616 / 22212 ???</p><p>from your application and then take fresh capture</p></div><div id="comment-47564-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:39)</span> srinu_bel</div></div><span id="47565"></span><div id="comment-47565" class="comment"><div id="post-47565-score" class="comment-score"></div><div class="comment-text"><p>I will have to check that, as I just default booted into a Linux live image (SysRescueCD)...</p></div><div id="comment-47565-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:44)</span> esc4rg0t</div></div><span id="47566"></span><div id="comment-47566" class="comment"><div id="post-47566-score" class="comment-score"></div><div class="comment-text"><p>Don't know if it is a good idea to disable TCP offloading at that moment. Seems to that it is main part of the question maybe with SACK or DSACK. More precise answer could be achieved with sharing us a capture. Like Pavel and Jasper have mentioned earlier.</p></div><div id="comment-47566-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:53)</span> Christian_R</div></div><span id="47567"></span><div id="comment-47567" class="comment not_top_scorer"><div id="post-47567-score" class="comment-score"></div><div class="comment-text"><p>Please see original post, I already shared the captures. Or here again: <a href="http://ianfe.dyndns.org/server_tcp.pcap">http://ianfe.dyndns.org/server_tcp.pcap</a> <a href="http://ianfe.dyndns.org/client_tcp.pcap">http://ianfe.dyndns.org/client_tcp.pcap</a></p><p>Right, I guess that offloading is active, so the NIC segments everything. I could use a tap, but would need to buy one first ;-)</p></div><div id="comment-47567-info" class="comment-info"><span class="comment-age">(13 Nov '15, 02:55)</span> esc4rg0t</div></div><span id="47570"></span><div id="comment-47570" class="comment not_top_scorer"><div id="post-47570-score" class="comment-score"></div><div class="comment-text"><p>If you want to use the tap only to confirm that the server's NIC segments the packets autonomously, maybe it would be enough to disable tcp offloading only at the receiving machine?<br />
That way, you should see the packets as they look on wire, i.e. as the sending side's NIC has modified them. In the same step you could get an info which direction causes the issue if switching tcp offloading on one end would miraculously heal the retransmissions.</p></div><div id="comment-47570-info" class="comment-info"><span class="comment-age">(13 Nov '15, 03:41)</span> sindy</div></div><span id="47571"></span><div id="comment-47571" class="comment not_top_scorer"><div id="post-47571-score" class="comment-score"></div><div class="comment-text"><p>yes, maybe I will do another dump today with tcp segmentation disabled...if I find the time :-/ But maybe somebody already got an idea with the current dump. I just thought it through again and again,...NIC DOES tcp offloading, cool. So one of these "split" packages could be lost...but then I would no calculate the exact same and perfectly right! sequence number on client and server side dump, would I? Which differs from what the server sent along as a sequence number...</p></div><div id="comment-47571-info" class="comment-info"><span class="comment-age">(13 Nov '15, 03:48)</span> esc4rg0t</div></div><span id="47572"></span><div id="comment-47572" class="comment not_top_scorer"><div id="post-47572-score" class="comment-score"></div><div class="comment-text"><p>Okey, I disabled the offloading on both client AND server, no retransmissions anymore. Whatever that means...</p></div><div id="comment-47572-info" class="comment-info"><span class="comment-age">(13 Nov '15, 05:56)</span> esc4rg0t</div></div><span id="47574"></span><div id="comment-47574" class="comment not_top_scorer"><div id="post-47574-score" class="comment-score"></div><div class="comment-text"><p>So if that's the case (what you described above), I would not have to worry about my network intfrastructure, and TCP retransmissions from time to time seem to be quite normal,...because of things like what's happening here.</p></div><div id="comment-47574-info" class="comment-info"><span class="comment-age">(13 Nov '15, 06:13)</span> esc4rg0t</div></div><span id="47577"></span><div id="comment-47577" class="comment not_top_scorer"><div id="post-47577-score" class="comment-score"></div><div class="comment-text"><p>yes, stop worrying about your network and start worrying about the task scheduler of your OS :-D</p><p>But for me it is more interesting that the tcp offloading affects the behaviour... maybe it does so indirectly and the application (ssh client in this case) has problems to handle large buffers, not expecting to get 10 pages of text in a single update?</p><p>Also, this effect, if it exists, might explain your initial issue:</p><blockquote><p>I had to analyze network packets because of an application that crashed quite a lot.</p></blockquote><p>Or you've already found some other reason of that issue and the analysis of retransmissions was just a spin-off project?</p></div><div id="comment-47577-info" class="comment-info"><span class="comment-age">(13 Nov '15, 07:35)</span> sindy</div></div><span id="47595"></span><div id="comment-47595" class="comment not_top_scorer"><div id="post-47595-score" class="comment-score"></div><div class="comment-text"><p>1) Yes U r right 100% sindy.... 2) To overcome the problem of buffers.... i am tying to send smaller PDUs.. Which reduces the burden on tcp stack...</p><p>Regards</p></div><div id="comment-47595-info" class="comment-info"><span class="comment-age">(13 Nov '15, 18:29)</span> srinu_bel</div></div><span id="47615"></span><div id="comment-47615" class="comment not_top_scorer"><div id="post-47615-score" class="comment-score"></div><div class="comment-text"><p>Sindy: Well, I came to the conclusion that the application that crashes seems to be crap, yes... But apart from that, I will put more effort into analyzing this behaviour, try other software, other Linux builds and so on.</p><p>Right now I got an indication that it might be SSH, as I have similar behaviour when connecting to a pfSense box over SSH from the same client...</p></div><div id="comment-47615-info" class="comment-info"><span class="comment-age">(15 Nov '15, 02:02)</span> esc4rg0t</div></div></div><div id="comment-tools-47561" class="comment-tools"><span class="comments-showing"> showing 5 of 13 </span> <a href="#" class="show-all-comments-link">show 8 more comments</a></div><div class="clear"></div><div id="comment-47561-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

