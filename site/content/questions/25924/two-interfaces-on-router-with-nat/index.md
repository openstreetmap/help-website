+++
type = "question"
title = "two interfaces on router with NAT"
description = '''Dear friends, it seems to be simple problem but I cannot deal with it. I have captured packets on the Linux router with NAT on the two interfaces at the same time: tcpdump -i eth1 -w lan.pcap tcpdump -i eth0 -w wan.pcap during two sessions SSH and enter&amp;amp;stop commands almost simultaneously. I nee...'''
date = "2013-10-11T15:54:00Z"
lastmod = "2013-12-04T15:35:00Z"
weight = 25924
keywords = [ "nat" ]
aliases = [ "/questions/25924" ]
osqa_answers = 1
osqa_accepted = true
+++

<div class="headNormal">

# [two interfaces on router with NAT](/questions/25924/two-interfaces-on-router-with-nat)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-25924-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-25924-score" class="post-score" title="current number of votes">0</div><span id="post-25924-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Dear friends, it seems to be simple problem but I cannot deal with it. I have captured packets on the Linux router with NAT on the two interfaces at the same time:</p><p>tcpdump -i eth1 -w lan.pcap</p><p>tcpdump -i eth0 -w wan.pcap</p><p>during two sessions SSH and enter&amp;stop commands almost simultaneously. I need to filter incoming packets to eth1 from 192.168.1.2 IP address and the same packets on the outcoming interface of router (eth0) from these files. First task is simple, because I can filter packets in based on MAC address of 192.168.1.2 host. But how can I filter the same packets on the second (wan.pcap) file (these packets have got different source IP address after NAT operation - IP address of eth0 interface)? I can filter every destination addresses but it is very long time process. Is there any simpler method?</p><p>Please help me.</p><p>edit:</p><p>192.168.1.2 ------eth1_router_eth0--------wan</p><p>One more question: if I send data from 192.168.1.2 host through the router, then I see the packet on the eth0 with time of leaving eth0 interface or entering eth0 interface? I need time of leaving eth0 interface by packet.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-nat" rel="tag" title="see questions tagged &#39;nat&#39;">nat</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>11 Oct '13, 15:54</strong></p><img src="https://secure.gravatar.com/avatar/28071bd7cf93e424c03dec9086ffa60f?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="net16&#39;s gravatar image" /><p><span>net16</span><br />
<span class="score" title="46 reputation points">46</span><span title="6 badges"><span class="badge1">●</span><span class="badgecount">6</span></span><span title="7 badges"><span class="silver">●</span><span class="badgecount">7</span></span><span title="12 badges"><span class="bronze">●</span><span class="badgecount">12</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="net16 has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>12 Oct '13, 10:33</strong> </span></p></div></div><div id="comments-container-25924" class="comments-container"><span id="25925"></span><div id="comment-25925" class="comment"><div id="post-25925-score" class="comment-score"></div><div class="comment-text"><p>Do you mean a capture filter or a display filter?</p></div><div id="comment-25925-info" class="comment-info"><span class="comment-age">(11 Oct '13, 17:29)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="25927"></span><div id="comment-25927" class="comment"><div id="post-25927-score" class="comment-score">1</div><div class="comment-text"><p>I must be missing something. Can you just capture all the traffic, then find out what the NAT table looks like? MAC addresses are no good because all IPs sourced by your interface will have the same MAC. Remember, MAC addresses are only relevant to Ethernet segments. You won't see the MAC address of a remote system if there is a router in the middle.</p></div><div id="comment-25927-info" class="comment-info"><span class="comment-age">(11 Oct '13, 18:29)</span> <span class="comment-user userinfo">hansangb</span></div></div><span id="25935"></span><div id="comment-25935" class="comment"><div id="post-25935-score" class="comment-score"></div><div class="comment-text"><p>Kurt, I mean a display filter. I would like to capture all traffic by tcpdump, then move captured .pcap file to Windows OS and filter different data by Wireshark. After filtering I will estimate different statistics on the filtered data.</p><p>hansangb, thank you for your comment. In this example MAC address was associated with one IP - PC workstation. I will remember, thanks.</p></div><div id="comment-25935-info" class="comment-info"><span class="comment-age">(12 Oct '13, 07:55)</span> <span class="comment-user userinfo">net16</span></div></div></div><div id="comment-tools-25924" class="comment-tools"></div><div class="clear"></div><div id="comment-25924-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="25938"></span>

<div id="answer-container-25938" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-25938-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-25938-score" class="post-score" title="current number of votes">1</div><span id="post-25938-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="net16 has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>Kurt , I mean a display filter.</p></blockquote><p>O.K. so, what do you have to build a filter?</p><p>The source IP will be changed and source port <strong>might</strong> be changed by the NAT operation, so you can't use the source IP address, but the source port could work, unless your NAT devices changes that by default, which is not the case for Linux MASQUERADING.</p><p>O.K. Then there is the IP ID and the TCP sequence numbers. Both are good candidates as well, although if some randomization features are enabled in the Linux kernel, they will change as well.</p><p>I'd start with the source ports and if that does not work, I'd look for one of the other criteria (IP ID, TCP sequence number, TCP stream number - tcp.stream, etc.).</p><blockquote><p>then I see the packet on the eth0 with time of leaving eth0 interface or entering eth0 interface?</p></blockquote><p>The time when libpcap gets the packet from the kernel, which is <strong>'more to the side'</strong> of leaving eth0 than to the side of entering eth0.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>12 Oct '13, 10:32</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>12 Oct '13, 10:37</strong> </span></p></div></div><div id="comments-container-25938" class="comments-container"><span id="25940"></span><div id="comment-25940" class="comment"><div id="post-25940-score" class="comment-score"></div><div class="comment-text"><p>Kurt, thank you very much for your answer. At the moment, it looks that I cannot use TCP sequence numbers because they are relative. But I will try to use range of source port numbers (I have no MASQUERADING). Although I am affraid that another workstations (sharing traffic) may use the same random numbers - it is possible. To the other parameter I have similar misgiving - it can be repeated in different flows. But I will try carefully.</p><p>Second question: I understand that in this one direction - on the eth1 I have entering (receiving a whole packet) time and on the eth0 I have time of leaving packet on outcoming interface (eth0).</p></div><div id="comment-25940-info" class="comment-info"><span class="comment-age">(12 Oct '13, 11:07)</span> <span class="comment-user userinfo">net16</span></div></div><span id="25943"></span><div id="comment-25943" class="comment"><div id="post-25943-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>it looks that I cannot use TCP sequence numbers because they are relative.</p></blockquote><p>That's just the default settings of Wireshark. You can change it here</p><blockquote><p>Edit -&gt; Preferences -&gt; Protocols -&gt; TCP -&gt; Relative Sequence Numbers</p></blockquote><p>Regarding your question regarding time stamps.</p><p>It's more or less like this:</p><p>The NIC receives the frame and hands it over to the kernel. In the kernel there is an API to capture traffic. Wireshark will get the frames via that API (from libpcap). So, the time stamp of the frame will be a few nanoseconds later than the frame really arrived, due to the handling in the kernel. On the sending side it is the same. So, there is a difference between the time stamps in the capture file and the 'real' time where the frames are being received/sent.</p><p>For TCP conversations, you can also use the stream index (tcp.stream). However, to be able to use that, you need to 'sync' the two capture files. Here is how to do it.</p><ul><li>Find the first SYN frame in the internal pcap</li><li>Find the corresponding SYN frame in the external pcap (look for source port, IP ID, TCP SEQ, etc.)</li><li>Then 'sync' the two files, by removing everything before those two frames. The easiest way is by using a display filter and File -&gt; Export Specified Packets. Display Filter: Internal: frame.number &gt;= x External: frame.number &gt;= y</li><li>Then open the 'stipped' files and tcp.stream 1 should be the same in both files. Now, you just need to find the streams for your source IP and you should be able to identify the same TCP conversation in the external file.</li></ul><p>For this to work, you need to capture the same data internally and externally. If your Firewall drops some TCP connections, this will not work, as the number of connections on the internal and external side is different.</p></div><div id="comment-25943-info" class="comment-info"><span class="comment-age">(12 Oct '13, 16:21)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="25949"></span><div id="comment-25949" class="comment"><div id="post-25949-score" class="comment-score"></div><div class="comment-text"><p>Dear Kurt, thank you for your time and explanations. I see few different tcp.stream indexes within transmission between 192.168.1.2 and 'chosen public address' hosts in my 30 seconds file. Do you think that it means such refreshing or re-quering page in new tab of web browser? Despite of this it is only SYN, SYN/ACK, ACK, FIN/ACK and "Continuation or non-HTTP traffic" (as it is traffic in one direction) - it is proper. I capture only headers.</p><p>Moreover I measure traffic statistics during some interval, for example 1 min, therefore I do not know if I can remove traffic before suitable frame on wan.pcap because that frame is shifted in time. I need to capture this shifting on the graph of wan interface. I use Statistics-&gt;IO Graph with filter obviously. I will check if I get such difference (Wireshark should include shifting in Tick intervals).</p></div><div id="comment-25949-info" class="comment-info"><span class="comment-age">(13 Oct '13, 11:18)</span> <span class="comment-user userinfo">net16</span></div></div><span id="25950"></span><div id="comment-25950" class="comment not_top_scorer"><div id="post-25950-score" class="comment-score"></div><div class="comment-text"><p>After removing unnecessary packets I have to synchronize time in the both pcap files (with processing time of reference packet). I have used Edit-&gt;Set Time Reference, and Time Shift. I would like to shift with 0.000065 s. I use Shift all packets and write +0.000065 but error is appeared - Offset is zero. How can I do this?</p><p>When I set value of "Time shift for this packet" (0.53968800), then times from input trace file is appeared again. Tommorow I will export displayed data to new files. Maybe it will help.</p></div><div id="comment-25950-info" class="comment-info"><span class="comment-age">(13 Oct '13, 14:51)</span> <span class="comment-user userinfo">net16</span></div></div><span id="25963"></span><div id="comment-25963" class="comment not_top_scorer"><div id="post-25963-score" class="comment-score"></div><div class="comment-text"><blockquote><p>I see few different tcp.stream indexes within transmission between 192.168.1.2 and 'chosen public address' hosts in my 30 seconds file. <strong>Do you think that it means such refreshing or re-quering page in new tab of web browser?</strong></p></blockquote><p>I'm sorry, but without the capture files and some details of what you are trying to do, I can only speculate about the reasons.</p><blockquote><p>Moreover I measure traffic statistics during some interval, for example 1 min,</p></blockquote><p>Hm.. what are you actually trying to do and why do you need a capture of both interfaces for traffic statistics !?!</p></div><div id="comment-25963-info" class="comment-info"><span class="comment-age">(14 Oct '13, 06:40)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="26024"></span><div id="comment-26024" class="comment not_top_scorer"><div id="post-26024-score" class="comment-score"></div><div class="comment-text"><p>Kurt, sorry for my delay. I make some research work. I estimate times, retransmisions, packet lost, etc. The deeper subject we enter, the broader knowledge we need. I still look for something in my research work. Thank you for discuss and help.</p></div><div id="comment-26024-info" class="comment-info"><span class="comment-age">(15 Oct '13, 14:44)</span> <span class="comment-user userinfo">net16</span></div></div><span id="27784"></span><div id="comment-27784" class="comment not_top_scorer"><div id="post-27784-score" class="comment-score"></div><div class="comment-text"><p>I have another idea. It is possible to display packets with the same SEQ numbers? During NAT operation router change IP addresses but SEQ numbers and IP ID leave the same. It would be great to find duplicated SEQ numbers. Then I will get all packets forwarded by the router with NAT. Some packets are lost and do not forward and I want to separate it.</p><p>Or I can use tshark with "-e tcp.seq". I see twice packets one by one and single packets (without pair), but how can I filter it?</p></div><div id="comment-27784-info" class="comment-info"><span class="comment-age">(04 Dec '13, 14:52)</span> <span class="comment-user userinfo">net16</span></div></div><span id="27786"></span><div id="comment-27786" class="comment"><div id="post-27786-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>Or I can use tshark with "-e tcp.seq". I see twice packets one by one and single packets (without pair), <strong>but how can I filter it?</strong></p></blockquote><p>Only with a script that pareses the tshark output and tries to find duplicates. There is no such functionality (find duplicates) in tshark/Wireshark.</p></div><div id="comment-27786-info" class="comment-info"><span class="comment-age">(04 Dec '13, 15:03)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="27787"></span><div id="comment-27787" class="comment not_top_scorer"><div id="post-27787-score" class="comment-score"></div><div class="comment-text"><p>Do you mean bash scripts? Awk, sed, etc. ? And later I have to count all statistics by scripts too?</p></div><div id="comment-27787-info" class="comment-info"><span class="comment-age">(04 Dec '13, 15:18)</span> <span class="comment-user userinfo">net16</span></div></div><span id="27788"></span><div id="comment-27788" class="comment"><div id="post-27788-score" class="comment-score">1</div><div class="comment-text"><p>Whatever scripting language you speak fluent ;-) I prefer Perl or Python. If you like bash or Awk, take that. sed would be too hard for this kind of task.</p><blockquote><p>And later I have to count statistics by scripts too?</p></blockquote><p>Sure, as soon as you have exported/extracted those values with tshark, it's up to you to do whatever you want/need with that data.</p></div><div id="comment-27788-info" class="comment-info"><span class="comment-age">(04 Dec '13, 15:20)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="27789"></span><div id="comment-27789" class="comment not_top_scorer"><div id="post-27789-score" class="comment-score"></div><div class="comment-text"><p>Fluent not necessarily. But I used scripts for different task. I will spend some time and I'll do it. Thank you very much, Kurt. You are helpful as always :)</p></div><div id="comment-27789-info" class="comment-info"><span class="comment-age">(04 Dec '13, 15:33)</span> <span class="comment-user userinfo">net16</span></div></div><span id="27790"></span><div id="comment-27790" class="comment not_top_scorer"><div id="post-27790-score" class="comment-score"></div><div class="comment-text"><p>Good luck.</p></div><div id="comment-27790-info" class="comment-info"><span class="comment-age">(04 Dec '13, 15:35)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div></div><div id="comment-tools-25938" class="comment-tools"><span class="comments-showing"> showing 5 of 12 </span> <a href="#" class="show-all-comments-link">show 7 more comments</a></div><div class="clear"></div><div id="comment-25938-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

