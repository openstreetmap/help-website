+++
type = "question"
title = "Losing connection with weird behavior."
description = '''My game client loses connection from my game server intermittently. (about 0.2% per minute) When connection is dropped, my client received a error code 10053(connaborted) usually. The number of user is about 100k, so about 200 users are dropped per minute. I should find the cause, but can&#x27;t find the...'''
date = "2013-09-13T02:34:00Z"
lastmod = "2013-09-14T04:49:00Z"
weight = 24631
keywords = [ "connection", "drop", "disconnect" ]
aliases = [ "/questions/24631" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Losing connection with weird behavior.](/questions/24631/losing-connection-with-weird-behavior)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24631-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>My game client loses connection from my game server intermittently. (about 0.2% per minute) When connection is dropped, my client received a error code 10053(connaborted) usually.</p><p>The number of user is about 100k, so about 200 users are dropped per minute.</p><p>I should find the cause, but can't find the root cause.</p><p>Now I have written code to work aroud this problem. When my client detects losing connection, my client tries to connect again.</p><p>Although this work around, I want to know the root cause of this problem.</p><p>Here is my game C/S's environment.</p><ul><li><p>Client</p><ul><li>works on Windows (XP, Visita, 7)</li><li>uses in-house network library (it's very simple)</li></ul></li><li><p>Server</p><ul><li>works on Linux (Ubuntu 12.04.1 - kernel 3.2.0-29 / Ubuntu 12.04.2 - kernel 3.5.0-23)</li><li>using iptables or ufw</li></ul></li></ul><p>Here is my approach to solve this problem.</p><p>First of all, I doubted my in-house code. I reviewed my codes very carefully but couldn't find any problems.</p><p>Second, I tried to capture packets on my server. Before loosing connection, my server can't receve any packets from a client. My server can't receive a ack packet, so my server try retransmission again and again.</p><p>Maybe a client also can't receive any packets from a server. (I can't reproduce this problem in my computer, so can't capture packets in client's side.)</p><p>The reason I think a client can't receive any packets is that a client is disconnected with a 10053 error code before the server's retransmission timeout. The client doesn't call closesocket explicitly.</p><p>I wonder why client and server can't receive any packets? What's wrong? If the reason is congestion, trying reconnect should be fail, isn't it? But almost trying reconnect is success!</p><p>I don't know who drops my packets and why?</p><p>I suspect the firewall, so I make the firewall disable on the server (just one machine). But, the problem still produces.</p><p>Finally, I suspect linux kernel/tcp stack or NIC device driver. But commonsensically the linux kernel/tcp stack is very stable, isn't it?</p><p>Do you have any idea? I'll be very appreciate any feedback.</p><p>** attach my wireshark's result</p><ul><li>port: 4134 is a client</li><li>port: 7781 is a server</li><li>a client should send a ping msg (which size is 20 bytes) to a server per 3 seconds.</li><li>but, there is no client's ping msg from 768 to 786</li><li>a server sends a ping msg per 20 seconds. At 786 a server try to send a ping msg. (which size is 30 bytes)</li><li>but a server can't receive ack packet from a client.</li><li>At 815, a client tries to reconnect to server!! (It's my work around.) But, a server can't receive any FIN or RST.</li><li>Maybe a client had sent a RST to a server, but a server can't receive it.</li></ul><p><img src="https://osqa-ask.wireshark.org/upfiles/capture_5.png" alt="alt text" /></p></div><div id="question-tags" class="tags-container tags">connection drop disconnect</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>13 Sep '13, 02:34</strong></p><img src="https://secure.gravatar.com/avatar/1b0e831a230435b60baa865724a25032?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="plotonix&#39;s gravatar image" /><p>plotonix<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="plotonix has no accepted answers">0%</span></p></img></div></div><div id="comments-container-24631" class="comments-container"></div><div id="comment-tools-24631" class="comment-tools"></div><div class="clear"></div><div id="comment-24631-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="24657"></span>

<div id="answer-container-24657" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24657-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><ul><li>Assuming that this trace is filtered on the remote client's ip address the client port number 'wraps' from within 4134 to 1737. Very unlikely for a windows client which uses incremental ephemeral ports.</li><li>The SYN packet arrives with a reduced MSS of 1414</li><li>The client's 'ping' packet was due at 761.64x but was never seen at the server</li><li>The server's ping packets don't go through either</li><li>815.708 into the trace - 54 seconds after the first missing packet - the client reconnects - immediately after the abort as you say your client is coded.</li></ul><p>So, the client entered retransmission and finally aborted the connection when retries were exhausted. The new SYN packet went through immediately, so we can exclude a general IP connectivity problem. I'd say, the problem is with security device in the path that is dropping packets of your TCP session for whatever reason.</p><p>Good luck in finding out more using traces at the endpoints ! ;-)</p><p>Regards Matthias</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>13 Sep '13, 13:29</strong></p><img src="https://secure.gravatar.com/avatar/5500bd1decb766660522dfb347eedc49?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="mrEEde&#39;s gravatar image" /><p>mrEEde<br />
<span class="score" title="3892 reputation points"><span>3.9k</span></span><span title="15 badges"><span class="badge1">●</span><span class="badgecount">15</span></span><span title="22 badges"><span class="silver">●</span><span class="badgecount">22</span></span><span title="70 badges"><span class="bronze">●</span><span class="badgecount">70</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="mrEEde has 48 accepted answers">20%</span></p></div></div><div id="comments-container-24657" class="comments-container"><span id="24665"></span><div id="comment-24665" class="comment"><div id="post-24665-score" class="comment-score"></div><div class="comment-text"><p>@mrEEde Thanks for your comment.</p><p>Of course, this trace is filtered on the client's ip addr and the port.</p><p>I totally agree with your answer. It's not a general IP connectivity problem.</p><p>When I tried to turn off the firewall in my server, the problem is still occurred. So, the firewall in my server is not dropping my packets.</p><p>I want to know who drops my packets (intermittently) and why? How can I trace this problem and how to find 'who and why?'</p></div><div id="comment-24665-info" class="comment-info"><span class="comment-age">(13 Sep '13, 18:12)</span> plotonix</div></div><span id="24716"></span><div id="comment-24716" class="comment"><div id="post-24716-score" class="comment-score"></div><div class="comment-text"><p>With your server serving 100.000 users I gather that the clients are spread all over the world. So, to find "THE" device that is dropping those packets by looking at a single connection is close to impossible as there are probably many devices out there that are causing your 'problem'. Furthermore, those devices are most likely not in your scope of influence and the owners will not be too keen to spend their time figuring out what is going on unless you have a valid business reason. To summ it up, I think 200 drops out of 100.000 user sessions is not too bad ;-)</p></div><div id="comment-24716-info" class="comment-info"><span class="comment-age">(15 Sep '13, 07:40)</span> mrEEde</div></div></div><div id="comment-tools-24657" class="comment-tools"></div><div class="clear"></div><div id="comment-24657-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="24676"></span>

<div id="answer-container-24676" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24676-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>I want to know who drops my packets (intermittently) and why? How can I trace this problem and how to find 'who and why?'</p></blockquote><p>Well, that's hard to do, as you won't be able to easily figure that out. A drop of a security device is usually 'silent' meaning, you don't know where is happens.</p><p>One option I see is this:</p><p>On the server (better on the client as well): If you detect multiple re-transmissions/DUP ACK, etc., you could start a new thread and start sending the last packet (the one you don't get an answer for) with increasing TTL. If you're lucky, you will at least be able to nail down the approx. device that could be dropping the packet, which is the one after which you don't get ICMP time exceeded anymore. This will obviouly only work, if the routers on the way do send the ICMP messages and they are not filtered on the way to your server.</p><pre><code>Server -&gt; Router1 --&gt; Router2 --&gt; Firewall/IDS/Whatever --&gt; Router3 --&gt; Router4
TTL:1     # &lt;- ICMP
TTL:2                # &lt;- ICMP
TTL:3                             :: drop
TTL:4                             :: drop
TTL:5                             :: drop</code></pre><p>The firewall drops the TCP packet and thus the last station you get an ICMP message from would be Router2.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>14 Sep '13, 04:49</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 14 Sep '13, 14:54</p></div></div><div id="comments-container-24676" class="comments-container"><span id="24680"></span><div id="comment-24680" class="comment"><div id="post-24680-score" class="comment-score"></div><div class="comment-text"><p>@Kurt Knochner</p><p>Thanks for your comment. I have some questions about your comment.</p><ol><li>How do the server application know TCP retransmission. There is no callback and notification. As I known, It's just duty of TCP, and the server application couldn't know that timing. So, I couldn't start a new thread and blah blah.. at that timing. How could I do it?</li></ol><p>2. I'm not a fluent English speaker. :( I couldn't understand your sentence. "device that could be dropping the packet, which is the one after which you don't get ICMP time exceeded anymore" If you explain this sentence with another words, I will be appreciate it.</p><p>3. Why do you suggest to increase TTL.</p><ol><li>As you said, if the routers on the way do send the ICMP msg to my server, I will know who drops my packet! I already tried to capture ICMP message on my server, but there is nothing special. I'll try to do it again.</li></ol></div><div id="comment-24680-info" class="comment-info"><span class="comment-age">(14 Sep '13, 07:25)</span> plotonix</div></div><span id="24692"></span><div id="comment-24692" class="comment"><div id="post-24692-score" class="comment-score"></div><div class="comment-text"><blockquote><p>How do the server application know TCP retransmission.</p></blockquote><p>Well, actually I don't think it will be possible with the standard TCP/IP API calls, so you need to either use libpcap in a kind of monitoring thread of your server and look for retransmissions yourself (rather hard) or use some scripting together with Wireshark/tshark. As soon as you detect a retransmission, you fire up script and try to implement what I mentioned above. You can use packet injection tools to do that. Although, that sounds like a weird hack, it might be your best option to identify the part where everything fails.</p><blockquote><p>Second, I tried to capture packets on my server.</p></blockquote><p>Did you try to capture the traffic off-box, meaning on a mirror port of the switch? Maybe the problem is caused by the NIC (or the driver) of your server. Maybe you should do that first!</p><blockquote><p>I'm not a fluent English speaker.</p></blockquote><p>Neither am I ;-)</p><blockquote><p>I couldn't understand your sentence.</p></blockquote><p>Look at the picture in my answer. The last device that sends an ICMP response, is the last hop before the device that possibly drops the TCP packets.</p><blockquote><p>I already tried to capture ICMP message on my server, but there is nothing special.</p></blockquote><p>You will only see ICMP messages, if you implement the 'TTL hack' I tried to describe.</p></div><div id="comment-24692-info" class="comment-info"><span class="comment-age">(14 Sep '13, 14:54)</span> Kurt Knochner ♦</div></div><span id="24729"></span><div id="comment-24729" class="comment"><div id="post-24729-score" class="comment-score"></div><div class="comment-text"><p>@Kurt Knochner</p><p>Thanks for your reply. I've got what you mean. I'll try it and share the result.</p></div><div id="comment-24729-info" class="comment-info"><span class="comment-age">(15 Sep '13, 18:21)</span> plotonix</div></div></div><div id="comment-tools-24676" class="comment-tools"></div><div class="clear"></div><div id="comment-24676-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

