+++
type = "question"
title = "TCP Retransmissions, reassembled PDU, TCP Out-of-order, issue with slow connectivity"
description = '''Hello everyone, I am troubleshooting an issue with slow and sometimes no connectivity, when a end user tries to open a file (PDF) on a file server over the internet. The users has internet connection, the problem only happens when accessing a specific site to view files. I&#x27;ve confirmed the issue is ...'''
date = "2016-01-06T09:25:00Z"
lastmod = "2016-08-11T07:26:00Z"
weight = 48918
keywords = [ "tls", "reassembly", "retransmissions", "tcp", "wireshark" ]
aliases = [ "/questions/48918" ]
osqa_answers = 1
osqa_accepted = false
+++

<div class="headNormal">

# [TCP Retransmissions, reassembled PDU, TCP Out-of-order, issue with slow connectivity](/questions/48918/tcp-retransmissions-reassembled-pdu-tcp-out-of-order-issue-with-slow-connectivity)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-48918-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-48918-score" class="post-score" title="current number of votes">0</div><span id="post-48918-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hello everyone, I am troubleshooting an issue with slow and sometimes no connectivity, when a end user tries to open a file (PDF) on a file server over the internet. The users has internet connection, the problem only happens when accessing a specific site to view files. I've confirmed the issue is not on the end users workstation as the issue happens from my PC as well.</p><p>Network is as shown : User-&gt; switch -&gt; (in)firewall<strong><em>(out) -&gt;</em></strong> switch -&gt; gateway router</p><p>Here are some of the packets: The packets shown are from a trace on the switchport connected to the outside port of the firewall.</p><pre><code>No. 1093 | time (Since prev pkt) 0.010808000 | src addr 23.200.30.6 | desti addr 10.10.1.45 | Strm indx 4 | src prt 443 | protocol TCP | info **[TCP Spurious Retransmission] [TCP segment of a reassembled PDU]**

No. 1838 | time (Since prev pkt) 0.011681000 | src addr 23.200.30.6 | desti addr 10.10.1.45 | Strm indx 4 |src prt 443 | protocol TCP | info : **[TCP Spurious Retransmission] 443&gt;56886 [ACK] Seq=990774 Ack=1358 Win=31872 Len=1380[reassembly error, protocol TCP: New Fragment overpaps old data (retransmission?)]**

No. 1782 | time (Since prev pkt) 0.038045000 | src addr 23.200.30.6 | desti addr 10.10.1.45 | Strm indx 4 | src prt 443 | protocol TCP | info : **[TCP Retransmission] [TCP segment of a reassembled PDU]**

No.283 | time  (Since prev pkt) 0.001030000 | src addr 23.200.30.6 | desti addr 10.10.1.45 |Strm indx 4 |   src prt 443 | procotol TLSv1.2 | info : **[TCP Retransmission] Application Data**

No.358 | time (Since prev pkt) 0.000533000 | src addr 23.200.30.6 | desti addr 10.10.1.45 | Strm indx 4 | src prt 443 | procotol TCP | info : **[TCP Out-Of-Order] [TCP segment reassembled PDU]**

No. 317 | time (Since prev pkt) 0.000001000 | src addr 23.200.30.6 | desti addr 10.10.1.45 | Strm indx 4 | src prt 443 | procotol TLSv1.2 | info : **[TCP Out-Of-Order] Application Data**</code></pre><p>Here is the location of the PCAPS and network diagram: <a href="https://drive.google.com/folderview?id=0B41R9G9kL5L-S1JWZ0Z2bTFKN3c&amp;usp=sharing">https://drive.google.com/folderview?id=0B41R9G9kL5L-S1JWZ0Z2bTFKN3c&amp;usp=sharing</a></p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-tls" rel="tag" title="see questions tagged &#39;tls&#39;">tls</span> <span class="post-tag tag-link-reassembly" rel="tag" title="see questions tagged &#39;reassembly&#39;">reassembly</span> <span class="post-tag tag-link-retransmissions" rel="tag" title="see questions tagged &#39;retransmissions&#39;">retransmissions</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span> <span class="post-tag tag-link-wireshark" rel="tag" title="see questions tagged &#39;wireshark&#39;">wireshark</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>06 Jan '16, 09:25</strong></p><img src="https://secure.gravatar.com/avatar/d1740cb5b9c3de85d65623d87d51f7f3?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Lewis%20Travieso&#39;s gravatar image" /><p><span>Lewis Travieso</span><br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Lewis Travieso has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>08 Jan '16, 12:53</strong> </span></p></div></div><div id="comments-container-48918" class="comments-container"><span id="48919"></span><div id="comment-48919" class="comment"><div id="post-48919-score" class="comment-score"></div><div class="comment-text"><p>The packets (as shown by the frame number) seems to be in an odd order.</p><p>Apart from that there's not enough info in the text dump to diagnose the issue. A capture file shared in a public spot will help immensely.</p></div><div id="comment-48919-info" class="comment-info"><span class="comment-age">(06 Jan '16, 09:42)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="48946"></span><div id="comment-48946" class="comment"><div id="post-48946-score" class="comment-score"></div><div class="comment-text"><p><span>@grahamb</span> The packets shown are only one a few of the packets that seem to have errors. There are quite a few of them.</p><p>Here is a link to the pcaps. Ive also included a diagram of what we are working with. Ive named the pcaps based on where the traces were taken on the network. <a href="https://drive.google.com/folderview?id=0B41R9G9kL5L-S1JWZ0Z2bTFKN3c&amp;usp=sharing">https://drive.google.com/folderview?id=0B41R9G9kL5L-S1JWZ0Z2bTFKN3c&amp;usp=sharing</a></p><p>PS. The orignal post was based on the pcap named "Trace from Outside Firewall Port"</p></div><div id="comment-48946-info" class="comment-info"><span class="comment-age">(07 Jan '16, 07:45)</span> <span class="comment-user userinfo">Lewis Travieso</span></div></div><span id="49023"></span><div id="comment-49023" class="comment"><div id="post-49023-score" class="comment-score"></div><div class="comment-text"><p>The sessions in "Inside Firewall" and "My Switchport" show different source ports, which means you did not capture the <strong>same</strong> session in parallel. With that it's not possible to compare the sessions in order to figure out if one of the components drops frames. Can you please repeat your test and then post the capture files taken in parallel on all three or four locations?</p></div><div id="comment-49023-info" class="comment-info"><span class="comment-age">(09 Jan '16, 12:16)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="49067"></span><div id="comment-49067" class="comment"><div id="post-49067-score" class="comment-score"></div><div class="comment-text"><p>Packets are arriving out_of_sequence already in the "Trace from Outside Firewall Port" causing a high number of SACK packets flowing out which trigger (spurious) retransmissions.</p><p>The ip.ids on the inbound packets look kind of strange as they suggest the packets were already out of order when they left the source.</p><p>May I suggest you turn on TCP timestamps in your windows by setting Tcp1323Opts to 3 <a href="https://technet.microsoft.com/en-us/library/cc938205.aspx">https://technet.microsoft.com/en-us/library/cc938205.aspx</a> so we can get some clues as to when they left the source and, while you're at it - temporarily disable SACK by setting SackOpts 0 (maybe it confuses some NAT devices on the path.<br />
</p><p>Also for the next trace action I suggest you in addition trace between your Firewall and the gateway router to see the sequence of arrival from the internet.</p></div><div id="comment-49067-info" class="comment-info"><span class="comment-age">(10 Jan '16, 23:10)</span> <span class="comment-user userinfo">mrEEde</span></div></div><span id="54619"></span><div id="comment-54619" class="comment"><div id="post-54619-score" class="comment-score"></div><div class="comment-text"><p>hi, did you able to solve the issue? i happen to face the same exact issue</p></div><div id="comment-54619-info" class="comment-info"><span class="comment-age">(05 Aug '16, 12:15)</span> <span class="comment-user userinfo">zareefaqmar</span></div></div><span id="54622"></span><div id="comment-54622" class="comment not_top_scorer"><div id="post-54622-score" class="comment-score"></div><div class="comment-text"><p><span>@zareefaqmar</span>, if you want assistance, you'll have to follow the advice of <span>@mrEEde</span> to the OP regarding the points where you capture at the same time (so that the same session can be observed at both sides of the firewall) and what settings in the Windows TCP stack to use, and post the resulting capture files.</p></div><div id="comment-54622-info" class="comment-info"><span class="comment-age">(05 Aug '16, 13:25)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="54628"></span><div id="comment-54628" class="comment not_top_scorer"><div id="post-54628-score" class="comment-score"></div><div class="comment-text"><p><span></span><span>@sindy</span> hi sindy. thank you for the reply. i have taken the pcap at both ingress &amp; engress at the same time. i can see that after client are sending GET, the client would one again send TCP Spurious Retransmission.</p><p>As per quoted previously, the issue in real life is that the website would load up normally. Only that when I tried to view the pdf file onto the page, it would see an error.</p><p>PCAP file are shared as below:</p><p><a href="https://www.dropbox.com/sh/50djblz04h4m1fq/AABtZ9WdqklVydF6-g-b9o9Ma?dl=0">https://www.dropbox.com/sh/50djblz04h4m1fq/AABtZ9WdqklVydF6-g-b9o9Ma?dl=0</a></p></div><div id="comment-54628-info" class="comment-info"><span class="comment-age">(06 Aug '16, 14:04)</span> <span class="comment-user userinfo">zareefaqmar</span></div></div></div><div id="comment-tools-48918" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-48918-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="54630"></span>

<div id="answer-container-54630" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-54630-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-54630-score" class="post-score" title="current number of votes">3</div><span id="post-54630-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I feel a bit weird answering a Question based on a capture file provided by a 3rd party, but the world isn't black and white.</p><p>The first question would be what kind "firewall" do you use (and <span><span>@Lewis Travieso</span></span>, if you are still interested, the same question applies to you)? Looking at the captures, I can see that the device is as if filtering out the turbulences happening at the WAN side so that they wouldn't affect the LAN side. But obviously the primary goal is not the filtering but either caching or, even more likely, analysing the files as they are downloaded for possible malicious contents.</p><p>If you apply a display filter <code>tcp.stream == 9</code> at both files and have a closer look at the packets which Wireshark's TCP analysis marks as unusual ones in the WAN-side capture, you'll see the following:<br />
while at WAN side, the incoming packet with seq 21240, next seq 22620 (in frame 344) is immediately followed by an incoming packet with seq 44700, next seq 46080 (in frame 346), at LAN side the "same" packet with seq 21240, next seq 22620 (in frame 348) is immediately followed by a packet with seq 22620, next seq 24000 (in frame 350) after that packet has arrived to the WAN side (in frame 350).<br />
<del>The WAN-side packet in frame 346 has arrived out of sequence most likely because between the firewall and the server, there are multiple paths with significantly different propagation time.</del><br />
<strong>EDIT:</strong> as <span><span>@mrEEde</span></span> has noted for the capture provided by the OP, the <code>ip.id</code> field suggests that the weird order of WAN-side packets mentioned earlier is not caused by multiple routes between the server ad client ends. As the same behaviour can be observed in the capture provided by <span><span>@zareefaqmar</span></span>, and lacking any knowledge about the network architecture at the server end, I hereby guess that there is some NAT/firewall/load balancing device there which assigns its own values of <code>ip.id</code> to packets it forwards from the actual server.</p><p>The "firewall" device at the client end is also responsible for the crash of the TCP session. The last incoming packet from WAN side to be properly retransmitted to LAN side is the one in frame 462 (WAN)/frame 464 (LAN); after that, the firewall sends (inevitably impersonating the remote server) a locally generated RST, although at the WAN side, subsequent packets (frames 463 and 464) have arrived from the remote server in the meantime. But the firewall stops talking to the server completely, so after a short while, the server starts retransmitting the last packet it didn't get acknowledged, and it sends a RST itself after still getting no acknowledge for almost 20 seconds.</p><p>So my conclusion is that the "firewall" is actually a more sophisticated security device, which analyses the HTTP responses as it forwards them, and it either does not like or merely does not understand the contents of the pdf file, so it causes the TCP session to fail as a consequence, either intentionally or due to a bug. Notably, Wireshark's <code>File-&gt;Export Objects-&gt;HTTP</code> didn't recognize the pdf payload either.</p><p>The url (<code>gltopdf</code>) suggests that the pdf file is generated, so maybe its contents is really malformed?</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>07 Aug '16, 03:13</strong></p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p><span>sindy</span><br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="sindy has 110 accepted answers">24%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>07 Aug '16, 12:55</strong> </span></p></div></div><div id="comments-container-54630" class="comments-container"><span id="54726"></span><div id="comment-54726" class="comment"><div id="post-54726-score" class="comment-score"></div><div class="comment-text"><p>hi <span>@sindy</span> thank you for the lead. the firewall is cisco ASA. upon furher inspection on the logs and firewall configuration; the culprit is the 'http inspection policy' that dropping the packet prior to policy violation and mismatch body size (200). currently are seeking principle advise on fine-tuning the configuration.</p></div><div id="comment-54726-info" class="comment-info"><span class="comment-age">(10 Aug '16, 17:13)</span> <span class="comment-user userinfo">zareefaqmar</span></div></div><span id="54729"></span><div id="comment-54729" class="comment"><div id="post-54729-score" class="comment-score"></div><div class="comment-text"><p>I'm not an expert on http, but as Wireshark was unable to identify the pdf file in the HTTP 200, can you check whether a browser on a PC bypassing the ASA can display the pdf properly? I mean, the ASA is most likely right and there is really something wrong about the way the http body is encoded, so the fix should be done at the server rather than the ASA.</p><p>In particular, the HTTP <code>Content-Type</code> header of the 200 OK doesn't mention a multi-part body (it says just <code>Content-Type: application/pdf</code>) but in reality, the pdf part is immediately followed by a html one, while the size indicated by <code>Content-Length: 87851</code> is of the pdf part alone.</p></div><div id="comment-54729-info" class="comment-info"><span class="comment-age">(10 Aug '16, 23:24)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="54748"></span><div id="comment-54748" class="comment"><div id="post-54748-score" class="comment-score"></div><div class="comment-text"><p>FYI, the pdf itself is fine (Acrobat Reader DC doesn't complain about anything), so only the http appendix to the 200's contents seems to cause the trouble.</p></div><div id="comment-54748-info" class="comment-info"><span class="comment-age">(11 Aug '16, 07:26)</span> <span class="comment-user userinfo">sindy</span></div></div></div><div id="comment-tools-54630" class="comment-tools"></div><div class="clear"></div><div id="comment-54630-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

