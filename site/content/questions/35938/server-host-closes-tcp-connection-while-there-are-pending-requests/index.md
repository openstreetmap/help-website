+++
type = "question"
title = "server host closes TCP connection while there are pending requests"
description = '''Web server prematurely closes connection and not sure why..  Client : 10.x.x.6 Server: 10.x.x.99 (Host OS: Win 2003 Std Edition SP2) Capture from Client No. Time Source Source Port Destination Dest Port Protocol Length Info 199039 2014-08-28 12:29:21.743519 10.x.x.6 19018 10.x.x.99 8080 TCP 62 19018...'''
date = "2014-09-02T13:18:00Z"
lastmod = "2014-09-09T11:12:00Z"
weight = 35938
keywords = [ "connection_reset", "wirshark_resets" ]
aliases = [ "/questions/35938" ]
osqa_answers = 1
osqa_accepted = false
+++

<div class="headNormal">

# [server host closes TCP connection while there are pending requests](/questions/35938/server-host-closes-tcp-connection-while-there-are-pending-requests)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-35938-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-35938-score" class="post-score" title="current number of votes">0</div><span id="post-35938-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Web server prematurely closes connection and not sure why.. Client : 10.x.x.6 Server: 10.x.x.99 (Host OS: Win 2003 Std Edition SP2)</p><p>Capture from Client</p><pre><code>No.     Time                       Source                Source Port Destination           Dest Port Protocol Length Info
199039 2014-08-28 12:29:21.743519 10.x.x.6          19018       10.x.x.99         8080      TCP      62     19018 &gt; 8080 [SYN] Seq=0 Win=4380 Len=0 MSS=1460
199044 2014-08-28 12:29:21.745172 10.x.x.99         8080        10.x.x.6          19018     TCP      64     8080 &gt; 19018 [SYN, ACK] Seq=0 Ack=1 Win=16384 Len=0 MSS=1460
199045 2014-08-28 12:29:21.745176 10.x.x.6          19018       10.x.x.99         8080      TCP      58     19018 &gt; 8080 [ACK] Seq=1 Ack=1 Win=4380 Len=0
199213 2014-08-28 12:29:22.719074 10.x.x.6          19018       10.x.x.99         8080      HTTP     489    GET /VIS_504_xxxv1/-/next?Action_5e6ed7a6b1bf436bb453dfdf845f6227=success.filled&amp;MODE=GVP8 HTTP/1.1 
199214 2014-08-28 12:29:22.729915 10.x.x.99         8080        10.x.x.6          19018     TCP      1518   [TCP segment of a reassembled PDU]
199216 2014-08-28 12:29:22.729934 10.x.x.99         8080        10.x.x.6          19018     TCP      1518   [TCP segment of a reassembled PDU]
199219 2014-08-28 12:29:22.730333 10.x.x.6          19018       10.x.x.99         8080      TCP      58     19018 &gt; 8080 [ACK] Seq=432 Ack=2921 Win=65535 Len=0
199220 2014-08-28 12:29:22.731974 10.x.x.99         8080        10.x.x.6          19018     HTTP/XML 853    HTTP/1.1 200 OK 
199228 2014-08-28 12:29:22.982290 10.x.x.6          19018       10.x.x.99         8080      TCP      58     19018 &gt; 8080 [ACK] Seq=432 Ack=3716 Win=4380 Len=0
199679 2014-08-28 12:29:43.243733 10.x.x.6          19018       10.x.x.99         8080      HTTP     527    GET /VIS_504_xxxv1/-/next?MODE=GVP8&amp;Action_50439cce58b7476387d6bfdf4e5c01ff_e91fe4004370445db983b7ec06a14a58=error.input.noinput HTTP/1.1 
199680 2014-08-28 12:29:43.254350 10.x.x.99         8080        10.x.x.6          19018     TCP      64     8080 &gt; 19018 [FIN, ACK] Seq=3716 Ack=901 Win=64635 Len=0
199681 2014-08-28 12:29:43.254355 10.x.x.99         8080        10.x.x.6          19018     TCP      64     8080 &gt; 19018 [RST, ACK] Seq=3717 Ack=901 Win=0 Len=0 </code></pre><p>Capture from Server</p><pre><code>No.     Time                          Source                Source Port Destination           Dest Port Protocol Length Info
 125233 2014-08-28 12:29:21.407191000 10.x.x.6          19018       10.x.x.99         8080      TCP      60     19018 &gt; 8080 [SYN] Seq=0 Win=4380 Len=0 MSS=1460
 125234 2014-08-28 12:29:21.407265000 10.x.x.99         8080        10.x.x.6          19018     TCP      58     8080 &gt; 19018 [SYN, ACK] Seq=0 Ack=1 Win=16384 Len=0 MSS=1460
 125235 2014-08-28 12:29:21.409137000 10.x.x.6          19018       10.x.x.99         8080      TCP      60     19018 &gt; 8080 [ACK] Seq=1 Ack=1 Win=4380 Len=0 
 125917 2014-08-28 12:29:22.382409000 10.x.x.6          19018       10.x.x.99         8080      HTTP     485    GET /VIS_504_xxxv1/-/next?Action_5e6ed7a6b1bf436bb453dfdf845f6227=success.filled&amp;MODE=GVP8 HTTP/1.1 
 125922 2014-08-28 12:29:22.391445000 10.x.x.99         8080        10.x.x.6          19018     TCP      2974   [TCP segment of a reassembled PDU]
 125926 2014-08-28 12:29:22.393651000 10.x.x.6          19018       10.x.x.99         8080      TCP      60     19018 &gt; 8080 [ACK] Seq=432 Ack=2921 Win=65535 Len=0 
 125927 2014-08-28 12:29:22.393663000 10.x.x.99         8080        10.x.x.6          19018     HTTP/XML 849    HTTP/1.1 200 OK 
 126064 2014-08-28 12:29:22.645648000 10.x.x.6          19018       10.x.x.99         8080      TCP      60     19018 &gt; 8080 [ACK] Seq=432 Ack=3716 Win=4380 Len=0
 137092 2014-08-28 12:29:42.906730000 10.x.x.6          19018       10.x.x.99         8080      HTTP     523    GET /VIS_504_xxxv1/-/next?MODE=GVP8&amp;Action_50439cce58b7476387d6bfdf4e5c01ff_e91fe4004370445db983b7ec06a14a58=error.input.noinput HTTP/1.1 
 137096 2014-08-28 12:29:42.916900000 10.x.x.99         8080        10.x.x.6          19018     TCP      54     8080 &gt; 19018 [FIN, ACK] Seq=3716 Ack=901 Win=64635 Len=0
 137097 2014-08-28 12:29:42.916929000 10.x.x.99         8080        10.x.x.6          19018     TCP      54     8080 &gt; 19018 [RST, ACK] Seq=3717 Ack=901 Win=0 Len=0 </code></pre><p>The second GET request got a [RST, ACK] because the server host sent a [FIN, ACK] as part previous request just after the second GET. Why would the server close the connection while there is still request pending? The server host is running Tomcat webserver, the tomcat log shows 200 OK for the second GET request. Could someone shed some light on this?</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-connection_reset" rel="tag" title="see questions tagged &#39;connection_reset&#39;">connection_reset</span> <span class="post-tag tag-link-wirshark_resets" rel="tag" title="see questions tagged &#39;wirshark_resets&#39;">wirshark_resets</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>02 Sep '14, 13:18</strong></p><img src="https://secure.gravatar.com/avatar/62299610ecdd3308246f3d98a122f92b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JackTCP&#39;s gravatar image" /><p><span>JackTCP</span><br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="JackTCP has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>02 Sep '14, 18:03</strong> </span></p></div></div><div id="comments-container-35938" class="comments-container"><span id="35967"></span><div id="comment-35967" class="comment"><div id="post-35967-score" class="comment-score">1</div><div class="comment-text"><p>I bet the key is that there was ~20 seconds of idle time between the last client ACK and the first segment of the next post. In other words, a ~20s gap between 199679 and 199680 on the client side, and 126064 and 137092 on the serverside.</p><p>My guess is that the HTTP Keep-Alive timer expired. I think in Apache, this is 5s by default. Sometimes I see artifacts of this behavior in the error log. Do you see any messages in your web/app logs?</p></div><div id="comment-35967-info" class="comment-info"><span class="comment-age">(03 Sep '14, 11:01)</span> <span class="comment-user userinfo">smp</span></div></div><span id="35974"></span><div id="comment-35974" class="comment"><div id="post-35974-score" class="comment-score"></div><div class="comment-text"><p>Thank you smp for your comment. I found the timeout in tomcat</p><p>&lt;connector port="8080" protocol="HTTP/1.1" connectiontimeout="20000" redirectport="8443"/&gt;</p><p>I can increase the timeout to a higher value to 40 or 60 sec but looks like I may have to do more than just increasing the timeout or?, the requesting client is a F5 LB and after I increase the timeout for tomcat if i still get request close to the timeout expiry, most likely it will fail again..? any other options to tackle this? Thank you again.</p></div><div id="comment-35974-info" class="comment-info"><span class="comment-age">(03 Sep '14, 15:06)</span> <span class="comment-user userinfo">JackTCP</span></div></div><span id="35978"></span><div id="comment-35978" class="comment"><div id="post-35978-score" class="comment-score"></div><div class="comment-text"><p>I also manage F5s for our company, so I am quite familiar with how they work. Is this health monitor traffic?</p><p>Maybe I missed it, but I don't believe you have clearly articulated exactly what the problem is. It seems we have an explanation for your question, which is why the connection gets closed before the next request arrives. So perhaps you could re-state your question to help clarify?</p></div><div id="comment-35978-info" class="comment-info"><span class="comment-age">(03 Sep '14, 17:42)</span> <span class="comment-user userinfo">smp</span></div></div><span id="35979"></span><div id="comment-35979" class="comment"><div id="post-35979-score" class="comment-score"></div><div class="comment-text"><p>Thanks smp. Let me give some background, Its a voice application (GVP) which access VoiceXML (VXML) code hosted on the webserver (Apache Tomcat), GVP can directly talk to webserver but we want to have HA for webserver, so we hosted the VXML code on two Tomcat webservers. To load balance GVP request to webservers we introduced F5. The flow is like this, when a new call arrives ( lets call it as CALL 1 and the life of call would be around 3 mins), GVP sends a initial VXML page fetch via F5 LB to Tomcat 1/2 (lets conside it was sent to Tomcat 1) which returns the page with JSESSIONID, GVP uses the JSESSIONID to communicate with F5 (not necessarily the same port) till the life of CALL 1 and it should always go to tomcat 1 till end of the call. F5 team has setup Cookie persistence that way the request for same JSESSIONID is always sent to same Tomcat. Next call (CALL 2) can go to tomcat 2.</p><p>GVP request to F5 would look something like below</p><p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:519 GET /VIS_xxxv1/-/next?MODE=GVP8&amp;Action_50439cce58b7476387d6bfdf4e5c01ff_e91fe4004370445db983b7ec06a14a58=error.input.noinput HTTP/1.1</p><p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 User-Agent: GVPi/GVP Common Lib (Build: 8.1.410.29)</p><p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 Host: Gxxxxxx.xxxx.example.com:8080,</p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 Accept: <em>/</em><p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 Cache-Control: max-age=0, max-stale=0</p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 Cookie: $Version="0"; JSESSIONID=3FA23FA8441345725BA2CA676D5B206F; $Path=/VIS_xxxxxv1; BIGipServer=1674440970.36895.0000; $Path=/<p>main.C:299 01DB013F-10006CBD-00011B54 .\FMUserRequest.cxx:488 X-Genesys-FMSessionID: 01DB013F-10006CBD-00011B54</p>main.C:299 .\FMResponseData.cxx:326 HTTP/1.1 200 OK<p>main.C:299 .\FMResponseData.cxx:345 Server: Apache-Coyote/1.1</p></div><div id="comment-35979-info" class="comment-info"><span class="comment-age">(03 Sep '14, 19:17)</span> <span class="comment-user userinfo">JackTCP</span></div></div><span id="35980"></span><div id="comment-35980" class="comment"><div id="post-35980-score" class="comment-score"></div><div class="comment-text"><p>Now the problem is between F5 and webserver (tomcat). Tomcat has 20 secs HTTP idle timeout and it closes the connection after 20 seconds if its not active. In my above example (server side capture), Tomcat was about to close the connection (Frame 137096) and a new GET request arrived from F5 few milli sec before connection close (Frame 137092) and it got rejected anyway as the conection is closed. If F5 would have sent the same request to same tomcat using a new connection, it would have been successful, do i need ask my F5 team to see if they can set some timeouts lower than 20 secs that way F5 opens a new connection? let me know your thoughts. Thank you!</p></div><div id="comment-35980-info" class="comment-info"><span class="comment-age">(03 Sep '14, 19:20)</span> <span class="comment-user userinfo">JackTCP</span></div></div><span id="35981"></span><div id="comment-35981" class="comment not_top_scorer"><div id="post-35981-score" class="comment-score"></div><div class="comment-text"><p>It seems you are falling into the common mental mistake of thinking that the F5 is somehow the source of the traffic - it's not. The F5 is simply forwarding what it receives from the real clients. So in the trace you caught, it is the real client - not the F5 - that waited 20 seconds between HTTP requests. The trace clearly shows that the F5 did not initiate the close.</p><p>So, the way I see it, you have basic two choices. Either somehow make the clients send HTTP requests at a frequency greater than the Tomcat Keep-Alive (which is not likely), or make Tomcat wait longer between successive HTTP requests from a client. I think increasing the Tomcat Keep-Alive timeout is really your only realistic option.</p></div><div id="comment-35981-info" class="comment-info"><span class="comment-age">(03 Sep '14, 19:51)</span> <span class="comment-user userinfo">smp</span></div></div><span id="36118"></span><div id="comment-36118" class="comment not_top_scorer"><div id="post-36118-score" class="comment-score"></div><div class="comment-text"><p>I agree F5 is forwarding traffic but it can also control how connections are opened and closed. Example: for each request there will be 2 legs. leg 1 - b/w source and F5, leg 2 - b/w F5 and target server. target server has 20 sec connection timeout, we have set the connection timeout as 15 secs on F5 to resolve this issue.</p></div><div id="comment-36118-info" class="comment-info"><span class="comment-age">(09 Sep '14, 11:10)</span> <span class="comment-user userinfo">JackTCP</span></div></div></div><div id="comment-tools-35938" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-35938-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="36119"></span>

<div id="answer-container-36119" class="answer answered-by-owner">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-36119-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-36119-score" class="post-score" title="current number of votes">0</div><span id="post-36119-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>we have set the connection timeout lower (15 sec) then server side connection timeout (20 Sec), so the client always closes the connection before server closes it.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>09 Sep '14, 11:12</strong></p><img src="https://secure.gravatar.com/avatar/62299610ecdd3308246f3d98a122f92b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JackTCP&#39;s gravatar image" /><p><span>JackTCP</span><br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="JackTCP has no accepted answers">0%</span></p></div></div><div id="comments-container-36119" class="comments-container"></div><div id="comment-tools-36119" class="comment-tools"></div><div class="clear"></div><div id="comment-36119-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

