+++
type = "question"
title = "Decrypt Secure Web Socket traffic not working"
description = '''Hello, I&#x27;m trying to decrypt WSS (websocket secure) traffic in in Wireshark, but for some reason I cannot make it work. Here are the steps I followed:  Collect all WSS traffic towards my server with tcpdump (i.e. $ sudo tcpdump -i any -w capture.pcap) Made sure that the negotiated cipher between cli...'''
date = "2017-06-30T05:53:00Z"
lastmod = "2017-07-06T04:55:00Z"
weight = 62441
keywords = [ "ssl", "websocket", "decryption", "wireshark" ]
aliases = [ "/questions/62441" ]
osqa_answers = 1
osqa_accepted = true
+++

<div class="headNormal">

# [Decrypt Secure Web Socket traffic not working](/questions/62441/decrypt-secure-web-socket-traffic-not-working)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-62441-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-62441-score" class="post-score" title="current number of votes">0</div><span id="post-62441-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hello,</p><p>I'm trying to decrypt WSS (websocket secure) traffic in in Wireshark, but for some reason I cannot make it work. Here are the steps I followed:</p><ul><li>Collect all WSS traffic towards my server with tcpdump (i.e. $ sudo tcpdump -i any -w capture.pcap)</li><li>Made sure that the negotiated cipher between client and server is NOT Diffie-Hellman so that it is decryptable using RSA key in wireshark</li><li>Open capture.pcap in wireshark and go to Preferences &gt; Protocols &gt; SSL &gt; RSA keys list &gt; Add and add: any, 5083, tcp, server.key. Where: 5083 is the server port for WSS, and server.key is the private key of the server in .pem format (notice that I have tested that this .pem is correct and works with wireshark by testing it with regular TLS traffic, where decryption works fine)</li><li>For some reason even after previous step the traffic still shows up decrypted.</li><li>I introduced an SSL debug file from Preferences &gt; Protocols &gt; SSL &gt; SSL debug file to figure out what is going on under the hood and the private key seems successfully loaded (based on the first lines of the log). I then checked for a specific frame that shows up as TLSv1.2 Application Data and which I would expect to be decrypted. But I see this issue: 'decrypt_ssl3_record: no decoder available'.</li></ul><p>Any idea why that is?</p><p>Thanks a lot in advance, Antonis Tsakiridis</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-ssl" rel="tag" title="see questions tagged &#39;ssl&#39;">ssl</span> <span class="post-tag tag-link-websocket" rel="tag" title="see questions tagged &#39;websocket&#39;">websocket</span> <span class="post-tag tag-link-decryption" rel="tag" title="see questions tagged &#39;decryption&#39;">decryption</span> <span class="post-tag tag-link-wireshark" rel="tag" title="see questions tagged &#39;wireshark&#39;">wireshark</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>30 Jun '17, 05:53</strong></p><img src="https://secure.gravatar.com/avatar/d239d5cab74caaa43a594772e4724687?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="atsakiridis&#39;s gravatar image" /><p><span>atsakiridis</span><br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="atsakiridis has no accepted answers">0%</span></p></div></div><div id="comments-container-62441" class="comments-container"><span id="62445"></span><div id="comment-62445" class="comment"><div id="post-62445-score" class="comment-score"></div><div class="comment-text"><p>What Wireshark version is in use? Latest stable is 2.2.7. Are you sure that the private key matches the one in the certificate? In the debug file you should see a match between the pubkey from the Certificate handshake message and the pubkey from the private key (if you use Wireshark &gt;= 2.0).</p></div><div id="comment-62445-info" class="comment-info"><span class="comment-age">(30 Jun '17, 06:42)</span> <span class="comment-user userinfo">Lekensteyn</span></div></div><span id="62490"></span><div id="comment-62490" class="comment"><div id="post-62490-score" class="comment-score"></div><div class="comment-text"><p>Thanks for the prompt reply Lekensteyn. So let me try to answer your questions: a. Used 2.2.3, but updated to 2.2.7 to make sure it's not an issue with previous version. The problem is that the issue still occurs :(. b. I did some more digging after you mentioned pubkey in the debug file and I realized that there is no Certificate in the ServerHello in the .pcap! Is this somehow legit? I then checked the SSL debug file more information and I saw only this:</p><p><code> dissect_ssl enter frame #346 (first time) packet_from_server: is from server - TRUE   conversation = 0x116b9fbb0, ssl_session = 0x116ba0fd0   record: offset = 0, reported_length_remaining = 86 ssl_try_set_version found version 0x0303 -&gt; state 0x91 dissect_ssl3_record: content_type 22 Handshake Calculating hash with offset 5 81 decrypt_ssl3_record: app_data len 81, ssl state 0x91 packet_from_server: is from server - TRUE decrypt_ssl3_record: using server decoder decrypt_ssl3_record: no decoder available dissect_ssl3_handshake iteration 1 type 2 offset 5 length 77 bytes, remaining 86 ssl_try_set_version found version 0x0303 -&gt; state 0x91 ssl_dissect_hnd_hello_common found SERVER RANDOM -&gt; state 0x93 ssl_dissect_hnd_srv_hello found CIPHER 0x002F TLS_RSA_WITH_AES_128_CBC_SHA -&gt; state 0x97</code></p><p>Any hints?</p></div><div id="comment-62490-info" class="comment-info"><span class="comment-age">(04 Jul '17, 06:03)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62491"></span><div id="comment-62491" class="comment"><div id="post-62491-score" class="comment-score"></div><div class="comment-text"><p>Also, here's another, successful scenario where I use plain TLS (i.e. not WSS). The ServerHello has a Certificate and this is how it look in SSL debug (notice the additional fields on the bottom):</p><p><code> dissect_ssl enter frame #320 (first time) packet_from_server: is from server - TRUE   conversation = 0x12166b840, ssl_session = 0x12166c420   record: offset = 0, reported_length_remaining = 821 ssl_try_set_version found version 0x0301 -&gt; state 0x91 dissect_ssl3_record: content_type 22 Handshake Calculating hash with offset 5 816 decrypt_ssl3_record: app_data len 816, ssl state 0x91 packet_from_server: is from server - TRUE decrypt_ssl3_record: using server decoder decrypt_ssl3_record: no decoder available dissect_ssl3_handshake iteration 1 type 2 offset 5 length 77 bytes, remaining 821 ssl_try_set_version found version 0x0301 -&gt; state 0x91 ssl_dissect_hnd_hello_common found SERVER RANDOM -&gt; state 0x93 ssl_dissect_hnd_srv_hello found CIPHER 0x002F TLS_RSA_WITH_AES_128_CBC_SHA -&gt; state 0x97 dissect_ssl3_handshake iteration 0 type 11 offset 86 length 727 bytes, remaining 821 lookup(KeyID)[20]: | ea 6b 53 25 49 89 f8 29 a7 11 fd 9f 2f 97 88 6a |.kS%I..)..../..j| | fd 8f 24 5b                                     |..$[            | ssl_find_private_key_by_pubkey: lookup result: 0x7fc814867400 dissect_ssl3_handshake iteration 0 type 14 offset 817 length 0 bytes, remaining 821</code></p></div><div id="comment-62491-info" class="comment-info"><span class="comment-age">(04 Jul '17, 06:03)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62494"></span><div id="comment-62494" class="comment"><div id="post-62494-score" class="comment-score"></div><div class="comment-text"><p>One totally irrelevant hint is to use &lt; code &gt; &lt; /code &gt; markers around your log output so that it shows up in a readable format.</p></div><div id="comment-62494-info" class="comment-info"><span class="comment-age">(04 Jul '17, 07:58)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="62495"></span><div id="comment-62495" class="comment"><div id="post-62495-score" class="comment-score"></div><div class="comment-text"><p>Thanks a lot grahamb for fixing this! I'm new to this forum, so will keep it in mind from now on</p></div><div id="comment-62495-info" class="comment-info"><span class="comment-age">(04 Jul '17, 08:09)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62496"></span><div id="comment-62496" class="comment not_top_scorer"><div id="post-62496-score" class="comment-score"></div><div class="comment-text"><p>Any chance of a capture along with the key so others can test?</p></div><div id="comment-62496-info" class="comment-info"><span class="comment-age">(04 Jul '17, 08:12)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="62519"></span><div id="comment-62519" class="comment not_top_scorer"><div id="post-62519-score" class="comment-score"></div><div class="comment-text"><p>Hello, sure, I'm sharing a link from my google drive that points to wireshark-wss.zip which contains: 1. wss.pcap which is the actual capture file, notice that WSS traffic is towards/from port 5083, 2. server.key which is the WSS server private key (it's a just a test key), 3. ssl-debug-wss.log which is the wireshark SSL debug file that I told you about. Here it is: <a href="https://drive.google.com/file/d/0BwfD74mG87iMQ3MxblNvOTA0Nm8/view?usp=sharing">https://drive.google.com/file/d/0BwfD74mG87iMQ3MxblNvOTA0Nm8/view?usp=sharing</a></p><p>As an example you can check frame #49, which is the ServerHello that doesn't include a Certificate section at all</p><p>Any hints on what might be wrong?</p><p>In case you 're interested, this is the RSA keys list file contents:</p><p>"any","5083","tcp","/Users/antonis/Documents/server.key",""</p><p>Best regards and thanks in advance, Antonis</p></div><div id="comment-62519-info" class="comment-info"><span class="comment-age">(05 Jul '17, 07:03)</span> <span class="comment-user userinfo">atsakiridis</span></div></div></div><div id="comment-tools-62441" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-62441-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="62527"></span>

<div id="answer-container-62527" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-62527-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-62527-score" class="post-score" title="current number of votes">0</div><span id="post-62527-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="atsakiridis has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I think you're out of luck. The TLS connection is using TLS session resumption as the Client Hello provides a Session ID which the server echo's back indicating that the server has retained state for that particular Session ID so no server certificate is required. As the capture does not include the original TLS session that created that Session ID Wireshark (currently) fails to decrypt the session.</p><p>You capture also seems to contain a lot of duplicate messages which I eliminated using <code>editcap -d wss.pcap wss2.pcap</code></p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>05 Jul '17, 08:27</strong></p><img src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="grahamb&#39;s gravatar image" /><p><span>grahamb ♦</span><br />
<span class="score" title="19834 reputation points"><span>19.8k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">●</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">●</span><span class="badgecount">206</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="grahamb has 274 accepted answers">22%</span></p></div></div><div id="comments-container-62527" class="comments-container"><span id="62559"></span><div id="comment-62559" class="comment"><div id="post-62559-score" class="comment-score"></div><div class="comment-text"><p>You 're right; seems that the browser even after refresh sometimes remembers previous session IDs and reuses them, which explains why Cert wasn't sent by server in ServerHello and wireshark couldn't correlate. I verified by using Firefox (instead of Chrome) and a private tab and indeed first WSS connection has full negotiation, and in that case indeed decryption for WSS worked like a charm! I had another error in the RSA keys list configuration, where I used 'tcp' instead of 'http', but after I fixed that all was good :)</p><p>The only issue I'd like to improve now is the presentation where I have the following issues. I'm working on an open source communications platform, and we 're dealing a lot with SIP. In fact the WSS traffic I'm investigating contains SIP flows.</p><p>So I'd like instead of getting the generic Websocket presentation in the packet list as can be seen here: <a href="https://drive.google.com/file/d/0BwfD74mG87iMcWNmTFQ0RTk1bDA/view,">https://drive.google.com/file/d/0BwfD74mG87iMcWNmTFQ0RTk1bDA/view,</a> to see that its a SIP message and its type (i.e. REGISTER) like this: <a href="https://drive.google.com/file/d/0BwfD74mG87iMTDRRbGxVbHE5RUE/view">https://drive.google.com/file/d/0BwfD74mG87iMTDRRbGxVbHE5RUE/view</a> (taken from non WSS session where SIP is directly on top of TCP and hence is presented nicely).</p><p>Do you think that is possible with the current state of Wireshark, with some additional configuration? If not I could try to contribute it, with some help from you guys. I think it will prove pretty useful for a lot of folks out there, as WS is pretty much used everywhere nowadays for signaling in communication systems (and with WebRTC boom it's even more widespread). Notice that the same issue exists when working with non encrypted WS. It's still not parsed as SIP and it's harder to do troubleshooting</p><p>Finally thanks for the pointer on editcap. Actually I had tried it on another pcap on my Mac but I got:</p><p><code> $ editcap -d wholeff.pcap wholeff-no-dups.pcap editcap: Error writing to wholeff-no-dups.pcap: Internal error</code></p><p>So I didn't try again. Maybe because I'm collecting using tcpdump and Ctrl-C to stop? Could it be that a packet is cut in half and it messes up the parsing</p><p>Thanks a lot for your quick responses and help. I know first hand that keeping up with community requests can be hard.</p></div><div id="comment-62559-info" class="comment-info"><span class="comment-age">(06 Jul '17, 03:17)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62560"></span><div id="comment-62560" class="comment"><div id="post-62560-score" class="comment-score"></div><div class="comment-text"><p><a href="https://ask.wireshark.org/users/1225/grahamb">@grahamb</a>, I just posted a comment here and then edited it again to make a small change but got an error in the lines of: 'Akismet thinks your comment is spam' and I lost it! Can you guys check where that comment went and try to repost it -it was huge and will take me forever to rewrite :(</p></div><div id="comment-62560-info" class="comment-info"><span class="comment-age">(06 Jul '17, 03:21)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62562"></span><div id="comment-62562" class="comment"><div id="post-62562-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Maybe because I'm collecting using tcpdump and Ctrl-C to stop? Could it be that a packet is cut in half and it messes up the parsing</p></blockquote><p>Nope. Ctrl-C stops tcpdump gracefully, the last packet is written in full. "Cut in the middle" packets happen when you copy the output file before stopping tcpdump as the file write buffering ignores packet borders.</p><p>To double-check you can export just a few packets from the beginning of the capture and try editcap on the exported file.</p></div><div id="comment-62562-info" class="comment-info"><span class="comment-age">(06 Jul '17, 03:31)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="62563"></span><div id="comment-62563" class="comment"><div id="post-62563-score" class="comment-score"></div><div class="comment-text"><p><a href="https://ask.wireshark.org/users/37517/atsakiridis">@atsakiridis</a> If there is a <code>Sec-WebSocket-Protocol: sip</code> header, it should be automatically picked up by Wireshark 2.4. In older versions or other cases, one method to force dissection of Websockets data as SIP is by means of the <code>websocket.text_type:As SIP</code> option (right-click the Websocket layer, select Protocol Preferences and change "Dissect websocket text as ...").</p></div><div id="comment-62563-info" class="comment-info"><span class="comment-age">(06 Jul '17, 03:50)</span> <span class="comment-user userinfo">Lekensteyn</span></div></div><span id="62564"></span><div id="comment-62564" class="comment"><div id="post-62564-score" class="comment-score"></div><div class="comment-text"><p>Second option works perfectly, thanks!</p><p>We will also consider introducing the SIP header you 're talking about for easier troubleshooting</p></div><div id="comment-62564-info" class="comment-info"><span class="comment-age">(06 Jul '17, 03:59)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62566"></span><div id="comment-62566" class="comment not_top_scorer"><div id="post-62566-score" class="comment-score"></div><div class="comment-text"><p><a href="https://ask.wireshark.org/users/19586/sindy">@sindy</a>, here's what I tried: I opened the pcap and did 'Export Specific Packets' without applying any filters. And then tried to editcap the result of that export and it worked fine. So there seems to have been something wrong to the original capture from tcpdump that somehow was 'corrected' by the export. But can't say what. I did verify that the number of frames between original and exported was the same though.</p></div><div id="comment-62566-info" class="comment-info"><span class="comment-age">(06 Jul '17, 04:41)</span> <span class="comment-user userinfo">atsakiridis</span></div></div><span id="62567"></span><div id="comment-62567" class="comment not_top_scorer"><div id="post-62567-score" class="comment-score"></div><div class="comment-text"><p>...while the original file opens normally in Wireshark but still causes trouble to editcap? If so, may I see that file?</p></div><div id="comment-62567-info" class="comment-info"><span class="comment-age">(06 Jul '17, 04:43)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="62568"></span><div id="comment-62568" class="comment not_top_scorer"><div id="post-62568-score" class="comment-score"></div><div class="comment-text"><p><a href="https://ask.wireshark.org/users/19586/sindy">@sindy</a> unfortunately I cannot share the problematic pcap as it contains sensitive data, and trying to reproduce the issue now is not possible. I'll keep an eye on it and if it happens again in the future will post again here to get to the bottom of this.</p><p>Thanks for the help</p></div><div id="comment-62568-info" class="comment-info"><span class="comment-age">(06 Jul '17, 04:55)</span> <span class="comment-user userinfo">atsakiridis</span></div></div></div><div id="comment-tools-62527" class="comment-tools"><span class="comments-showing"> showing 5 of 8 </span> <a href="#" class="show-all-comments-link">show 3 more comments</a></div><div class="clear"></div><div id="comment-62527-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

