+++
type = "question"
title = "L2TP encryption analysis packets"
description = '''Hi everybody. There are a lot of questions regrading L2TP/IPsec troubleshootin and little answers, but i have to try and check for your help. I&#x27;m using Wireshark 2.0.1 (v2.0.1-0-g59ea380) that has Gcrypt (1.6.2). I am in control of a VPN router server, with it&#x27;s WAN static public IP (mu little bussi...'''
date = "2016-06-20T10:05:00Z"
lastmod = "2016-06-20T10:05:00Z"
weight = 53575
keywords = [ "troubleshoot", "vpn", "l2tp", "ipsec" ]
aliases = [ "/questions/53575" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [L2TP encryption analysis packets](/questions/53575/l2tp-encryption-analysis-packets)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-53575-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi everybody. There are a lot of questions regrading L2TP/IPsec troubleshootin and little answers, but i have to try and check for your help.</p><p>I'm using Wireshark 2.0.1 (v2.0.1-0-g59ea380) that has Gcrypt (1.6.2).</p><p>I am in control of a VPN router server, with it's WAN static public IP (mu little bussiness store). On another ADSL connection i have my laptop with Windows 10. I create in the VPN Server a L2TP Server for Client-to-LAN:</p><ul><li>List item</li><li>it's own local Ip address pool (172.30.10.10-20/24).</li><li>Account name: yyyy</li><li>Password: yxyxyx</li><li>Encryption: OM (IPsec - no configuration needed, just enable it)</li><li>Pre-shared key: aaaaaaa And it's done.</li></ul><p>In my Windows 10 i create a VPN connection and configure:</p><ul><li>List item</li><li>Account name: yyyy</li><li>IP server: WAN Static IP from L2TP server.</li><li>Choose VPN connection: L2TP/IPsec with pre-share key</li><li>Pre-shared key: aaaaa</li><li>Initial session information: user and password --&gt; yyyy yxyxyxyx</li><li>Also in Control Panel - Networks and Internet - right click in the network connection just made.</li><li>Configure correctly security option (pre-shared key) and enable the use of the following protocols: CHAP and MS-CHAP v2.</li></ul><p>After this i launch the connection and the tunnel is created. I can reach correctly the devices connected to VPN Server Router. I use Wireshark to capture all the packets directly from my W10 laptop, and i can see clearly the ISAKMP and ESP packets.</p><p>But i need to check the L2TP connection and for that i have to decrypt the ESP packets. In wireshark i configure the ESP protocol (Edit - Protocols - and choose ESP). <strong>At this point i am lost and although i've read many forums and Wikishark, i am not able to decrypt these packets. I am not an expert in Wireshark but have been working with it in order to learn.</strong> The following is a screenshot of the ESP configuration:</p><p><img src="https://osqa-ask.wireshark.org/upfiles/ESP_Wireshark_Conf_RYpVvbS.JPG" alt="alt text" /> although i'm not sure about the encryption and Authentication used by Windows 10. The VPN router also does not specifically inform of what kind of encryption and authentication is used by default. If i'm not correct the Encryptio usualy used is DES or 3DES. And the authentication used in IKE usualy is MD5. I tried some combinations, but there is no change in wireshark, once this configuration is applied. I've introduced in ESP configuration 2 entrances: one for the incoming packets and another for the outgoing packets.</p><ul><li>At this point can anyone please help me? I'm sure a lot of people knows about this, so a little help, at least pointing me to a possible error, or some step i'm not doing or having in consideration in order to troubleshoot L2TP/IPsec issues.</li></ul><p>Many thanks.</p></div><div id="question-tags" class="tags-container tags">troubleshoot vpn l2tp ipsec</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>20 Jun '16, 10:05</strong></p><img src="https://secure.gravatar.com/avatar/331d7152395d5e34e11493dd810df433?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Portuguevos&#39;s gravatar image" /><p>Portuguevos<br />
<span class="score" title="6 reputation points">6</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Portuguevos has no accepted answers">0%</span></p></img></div></div><div id="comments-container-53575" class="comments-container"><span id="53632"></span><div id="comment-53632" class="comment"><div id="post-53632-score" class="comment-score"></div><div class="comment-text"><p>Hi again. I've been following other posts like <a href="https://wiki.wireshark.org/ESP_Preferences">https://wiki.wireshark.org/ESP_Preferences</a> or <a href="http://www.spiceupyourknowledge.net/2012/11/decrypting-esp-packet-using-wireshark.html">http://www.spiceupyourknowledge.net/2012/11/decrypting-esp-packet-using-wireshark.html</a></p><p>I've downlowaded a pcap file with ESP packets, and applied the configuration in ESP configuration and in that example worked. But not in my case, and i have ALL the information. I tried with SPI is HEX, Decimal. The Keys i have are only numbers, and even so i cannot decrypt any of the ESP packets.</p><p>Also in order to know ALL information, i've made a VPN tunel with Shrew VPN Client against my VPM router. IKE proposal is using SHA1 Authentication, DES encryption, DH Group DH2, in both ends. IPsec proposal has the SECURITY PROTOCOL: ESP, ESP Authentication: SHA1 and ESP Encryption DES.</p><p>The tunel is correctly enabled and i can access the devices.</p><p>But again, in Wireshartk -&gt; Preferences -&gt; Protocols ESP, i fill all the information and ESP packets are still not decrypted.</p><p>Any idea? Many thanks.</p></div><div id="comment-53632-info" class="comment-info"><span class="comment-age">(23 Jun '16, 07:59)</span> Portuguevos</div></div><span id="53637"></span><div id="comment-53637" class="comment"><div id="post-53637-score" class="comment-score"></div><div class="comment-text"><p>I doubt IKE using Diffie-Hellman is going to work, Wireshark won't have access to the encryption keys from the Pre-shared key only. See for instance <a href="https://ask.wireshark.org/questions/21011,">https://ask.wireshark.org/questions/21011,</a> which talks about this in the context of TLS</p></div><div id="comment-53637-info" class="comment-info"><span class="comment-age">(24 Jun '16, 01:25)</span> Jaap ♦</div></div><span id="53638"></span><div id="comment-53638" class="comment"><div id="post-53638-score" class="comment-score"></div><div class="comment-text"><p>Hi Jaap. Thanks for the information. I'll check this situation. Although for the first case (main text), using only a L2TP VPN connection using microsoft integrated VPN client, DH (Diffie-Helman) is not being used. And even in that situation i cannot decrypt the messages. This second comment was a second test, but did not realize the DH situation. Many thanks.</p></div><div id="comment-53638-info" class="comment-info"><span class="comment-age">(24 Jun '16, 01:35)</span> Portuguevos</div></div><span id="58333"></span><div id="comment-58333" class="comment"><div id="post-58333-score" class="comment-score"></div><div class="comment-text"><p>How are you getting the symmetric key for the DES encryption. I think you need to have the Phase2 symmetric key. DH is as I remember used during the phase1(possibly in ike key exchange)?? Will that even matter if you have phase2 keys?</p></div><div id="comment-58333-info" class="comment-info"><span class="comment-age">(26 Dec '16, 01:30)</span> koundi</div></div></div><div id="comment-tools-53575" class="comment-tools"></div><div class="clear"></div><div id="comment-53575-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

