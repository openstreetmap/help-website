+++
type = "question"
title = "Migrating ASN.1 based dissector plugin to Wireshark 2.1"
description = '''Hi, in our company we use some Wireshark plugins. They worked fine for Wireshark 1.x. For Wireshark 2.1 they do no longer work and I am trying to migrate them to Wireshark 2.1. I managed to compile them for Windows 64 bit. The generation of c files from the .asn files didn&#x27;t work with CMake but I ma...'''
date = "2016-06-22T08:06:00Z"
lastmod = "2016-06-24T06:21:00Z"
weight = 53607
keywords = [ "asn.1", "dissector", "plugin" ]
aliases = [ "/questions/53607" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Migrating ASN.1 based dissector plugin to Wireshark 2.1](/questions/53607/migrating-asn1-based-dissector-plugin-to-wireshark-21)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-53607-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi,</p><p>in our company we use some Wireshark plugins. They worked fine for Wireshark 1.x. For Wireshark 2.1 they do no longer work and I am trying to migrate them to Wireshark 2.1.</p><p>I managed to compile them for Windows 64 bit. The generation of c files from the .asn files didn't work with CMake but I managed to create them manually using awn2wrs. I updated some renamed functions and now Windows 64 bit works fine.</p><p>What causes some headache is compiling for Linux. (Ubuntu 14.04 64bit)</p><p>I found instructions in README.plugins and followed them. They are not fully complete but I managed to build some plugins that do not use asn.1 files.</p><p>What I did is updating these files to include my plugins: - CMakeListsCustom.txt - configure.ac - plugins/Custom.m4 - plugins/Custom.make</p><p>I also deleted my Makefile.common and Makefile.am files and created new ones based on plugins/gryphon example.</p><p>Doing this for non-ASN.1 dissectors works fine but it doesn't help if ASN.1 is used.</p><p>All samples and instructions I found lack some hints on how to use them with latest Wireshark version.</p><p>Also the <a href="https://wiki.wireshark.org/ASN1_sample">ASN.1 sample</a> dissector does not build:</p><pre><code>Making all in toyasn1
...
make  all-am
make[4]: Entering directory `/Development/x/Wireshark/plugins/toyasn1&#39;
make[4]: *** No rule to make target `../../tools/make-dissector-reg&#39;, needed by `plugin.c&#39;.  Stop.</code></pre><p>Are there any updated build instructions available to create plugins? Are there any migration instructions available?</p><p>I never compiled for Wireshark before. I am not aware with which version the changes in the dissector API and in the build process were introduced with.</p><p>I hope the experts here can ease my pain. ;)</p><p>BR, Gerhard</p><hr /><p>Edit1: When I updated the non ASN.1 plugins I had to remove the rule to create plugin.c from Makefile.am. This is what causes the error message about missing make-dissector-re.py tool. I also applied this change to the ASN.1 based plugins. But this only shifts the problem a bit further:</p><pre><code>make  all-am
make[4]: Entering directory `/Development/x/Wireshark/plugins/toyasn1&#39;
Makefile:1100: warning: overriding commands for target `checkapi&#39;
Makefile:1074: warning: ignoring old commands for target `checkapi&#39;
Making plugin.c
No files found
make[4]: *** [plugin.c] Error 1
make[4]: Leaving directory `/Development/x/Wireshark/plugins/toyasn1&#39;</code></pre><p>Now there is no file plugin.c created. I cannot apply all the other changes from the makefiles as they are rather different with regards to the autogenerated files and I cannot really figure out which part I still need or with what other rules I have to replace the content.</p></div><div id="question-tags" class="tags-container tags">asn.1 dissector plugin</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>22 Jun '16, 08:06</strong></p><img src="https://secure.gravatar.com/avatar/99008d0e4c4c15ab03d77938ad9e345b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="gerhardh&#39;s gravatar image" /><p>gerhardh<br />
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="gerhardh has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 24 Jun '16, 04:30</p></div></div><div id="comments-container-53607" class="comments-container"></div><div id="comment-tools-53607" class="comment-tools"></div><div class="clear"></div><div id="comment-53607-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="53641"></span>

<div id="answer-container-53641" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-53641-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>The "No files found" text means that tools/make-dissector-reg.py was called with an empty $REGISTER_SRC_FILES list. If you look at plugins\Makefile.common.inc, you will get this definition:</p><pre><code>REGISTER_SRC_FILES = \
    $(FLEX_GENERATED_REGISTER_C_FILES) \
    $(FLEX_GENERATED_REGISTER_CPP_FILES) \
    $(LEMON_GENERATED_REGISTER_C_FILES) \
    $(LEMON_GENERATED_REGISTER_CPP_FILES) \
    $(NONGENERATED_REGISTER_C_FILES) \
    $(NONGENERATED_REGISTER_CPP_FILES)</code></pre><p>Where those lists are supposed to be defined in the Makefile.common file in your plugin folder. So ensure to have something like:</p><pre><code>NONGENERATED_REGISTER_C_FILES = \
    packet-toyasn1.c</code></pre><p>Where you replace packet-toyasn1.c by whatever file name contains your register and handoff functions.</p><p>PS: given that you were able to compile with CMake on Windows, it might be easier to use CMake on Linux also rather that updating the Makefile.(am|common) files.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>24 Jun '16, 06:21</strong></p><img src="https://secure.gravatar.com/avatar/713f24fd877861260b71ecd455018625?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Pascal%20Quantin&#39;s gravatar image" /><p>Pascal Quantin<br />
<span class="score" title="5544 reputation points"><span>5.5k</span></span><span title="10 badges"><span class="silver">●</span><span class="badgecount">10</span></span><span title="60 badges"><span class="bronze">●</span><span class="badgecount">60</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Pascal Quantin has 92 accepted answers">30%</span></p></div></div><div id="comments-container-53641" class="comments-container"><span id="53669"></span><div id="comment-53669" class="comment"><div id="post-53669-score" class="comment-score"></div><div class="comment-text"><p>Thanks a lot for your answer.</p><p>Calling tools/make-dissector-reg.py will not be possible even with proper parameters. This tool does not exist any longer. I had to remove the whole part where plugin.c was created.</p><p>I tried to apply the same changes as with the non-ASN.1 plugins and add the differences for ASN.1 on top of them. After some fiddling around I managed to get a version of the Makefiles that work for me (more or less).</p><hr /><p>The new content of Makefile.am is:</p><pre><code>include Makefile.common
include $(top_srcdir)/Makefile.am.inc
include ../Makefile.am.inc
plugindir = @[email protected]
BUILT_SOURCES = packet-toyasn1.h
plugin_LTLIBRARIES = toyasn1.la
toyasn1_la_SOURCES = \
    plugin.c \
    moduleinfo.h \
    $(DISSECTOR_SRC) \
    $(DISSECTOR_INCLUDES)
toyasn1_la_CPPFLAGS = $(AM_CPPFLAGS) $(PLUGIN_CPPFLAGS)
toyasn1_la_CFLAGS = $(AM_CFLAGS) $(PLUGIN_CFLAGS)
toyasn1_la_LDFLAGS = $(PLUGIN_LDFLAGS)
generate_dissector: $(DISSECTOR_FILES)
generate_export: $(EXPORT_FILES)
PROTO_OPT ?= -p $(PLUGIN_NAME)
$(DISSECTOR_FILES): $(top_srcdir)/tools/asn2wrs.py $(SRC_FILES) $(EXTRA_CNF)
    python $(top_srcdir)/tools/asn2wrs.py \
    $(A2W_FLAGS) \
    $(PROTO_OPT) \
    -c $(srcdir)/$(PLUGIN_NAME).cnf \
    -s $(srcdir)/packet-$(PLUGIN_NAME)-template \
    -D $(srcdir) $(EXT_ASN_FILE_LIST) $(ASN_FILE_LIST) $(EXT_ASN_FILE_LIST_LATE)
$(EXPORT_FILES): $(top_srcdir)/tools/asn2wrs.py $(SRC_FILES)
    python $(top_srcdir)/tools/asn2wrs.py \
    -E $(A2W_FLAGS) \
    $(PROTO_OPT) \
    -c $(srcdir)/$(PLUGIN_NAME).cnf \
    -D $(srcdir) $(EXT_ASN_FILE_LIST) $(ASN_FILE_LIST) $(EXT_ASN_FILE_LIST_LATE)
CLEANFILES = \
parsetab.py \
parsetab.pyc \
$(DISSECTOR_FILES) \
-exp.cnf \
packet--{dis-tab,ettarr,ett,fn,hfarr,hf,table,val,exp}.[hc] \
~
MAINTAINERCLEANFILES = \
Makefile.in \
plugin.c
EXTRA_DIST = \
Makefile.common     \
Makefile.nmake      \
$(ASN_FILE_LIST) \
packet-$(PLUGIN_NAME)-template.c \
packet-$(PLUGIN_NAME)-template.h \
$(PLUGIN_NAME).cnf \
$(PLUGIN_NAME).asn \
moduleinfo.nmake    \
plugin.rc.in</code></pre><hr /><p>The new content of Makefile.common is:</p><pre><code>PLUGIN_NAME = toyasn1
PLUG = toyasn1
Non-generated sources to be scanned for registration routines
NONGENERATED_REGISTER_C_FILES = \
packet-toyasn1.c
Non-generated sources
NONGENERATED_C_FILES = \
$(NONGENERATED_REGISTER_C_FILES)
Headers.
CLEAN_HEADER_FILES = \
packet-toyasn1.h
HEADER_FILES = \
$(CLEAN_HEADER_FILES)
the dissector sources (without any helpers)
DISSECTOR_SRC = \
packet-toyasn1.c
corresponding headers
DISSECTOR_INCLUDES =    \
packet-toyasn1.h
DISSECTOR_FILES = $(DISSECTOR_SRC) $(DISSECTOR_INCLUDES)
BUILT_FILES = packet-$(PLUG)-template.c packet-$(PLUG)-template.h $(PLUG).cnf $(PLUG).asn
A2W_FLAGS= -b -L
ASN_FILE_LIST = $(PLUGIN_NAME).asn
PROTO_OPT = -p $(PLUGIN_NAME)
srcdir = .
EXTRA_CNF =
Dissector helpers. They&#39;re included in the source files in this
directory, but they&#39;re not dissectors themselves, i.e. they&#39;re not
used to generate &quot;plugin.c&quot;.
DISSECTOR_SUPPORT_SRC =
include ../Makefile.common.inc</code></pre><hr /><p>The only drawback of these Makefiles is that packet-toyasn1.c|h are only created from packet-toyasn1-template.c|h if they do not exist. If they already exist and the template files are changed, asn2wrs tool ist not called again to update the autogenerated files. As I do not need to touch the dissector code itself a lot, this limitation is fine for me.</p><p>When using cmake for building the Windows version these C and H files were not created from the template files automatically at all. This is one of the reasons why I didn't use cmake to build the Linux version.</p><p>With this solution my problem is solved. Thanks for helping</p></div><div id="comment-53669-info" class="comment-info"><span class="comment-age">(27 Jun '16, 06:01)</span> gerhardh</div></div><span id="53674"></span><div id="comment-53674" class="comment"><div id="post-53674-score" class="comment-score"></div><div class="comment-text"><p>I do not know why you say that tools/make-dissector-reg.py does not exist anymore. It does and in master branch it is called from plugins/Makefile.am.inc file (you are supposed to include it in your Makefile, see Makefile.am in plugins/gryphon folder for example).</p></div><div id="comment-53674-info" class="comment-info"><span class="comment-age">(27 Jun '16, 08:14)</span> Pascal Quantin</div></div><span id="53690"></span><div id="comment-53690" class="comment"><div id="post-53690-score" class="comment-score"></div><div class="comment-text"><p>I am sorry. I provided wrong link to ASN.1 sample plugin in the initial question. I didn't use foo.tar.gz sample file but toyasn1.tar.gz sample file from here: <a href="https://wiki.wireshark.org/ASN1_plugin">https://wiki.wireshark.org/ASN1_plugin</a></p><p>Maybe it would have worked better if I had used to foo ASN.1 example.</p><p>With toyasn1 sample code I got the error message about missing ../../tools/make-dissector-reg script that I showed in initial question. That shell script is not existing in the git repository.</p><p>What I didn't notice is the missing file extension. You were talking about make-dissector-reg.py which does exist in tools directory.</p><p>Looking a bit closer into Makefile.am it seems that it assumes that there is a script for use with Python and one without Python. But the latter is not existing in the folder, causing the error message.</p><p>Sorry for the confusion.</p></div><div id="comment-53690-info" class="comment-info"><span class="comment-age">(28 Jun '16, 01:02)</span> gerhardh</div></div><span id="53693"></span><div id="comment-53693" class="comment"><div id="post-53693-score" class="comment-score"></div><div class="comment-text"><p>Indeed toyasn1 plugin is really out of date (if you check the wiki page you will see that it was last updated in 2010) and does not work out of the box with current master branch (as you unfortunately discovered).</p></div><div id="comment-53693-info" class="comment-info"><span class="comment-age">(28 Jun '16, 01:43)</span> Pascal Quantin</div></div></div><div id="comment-tools-53641" class="comment-tools"></div><div class="clear"></div><div id="comment-53641-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</hr>

</div>

</div>

