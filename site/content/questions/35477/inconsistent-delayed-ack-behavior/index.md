+++
type = "question"
title = "Inconsistent delayed ACK behavior"
description = '''Hi, packet pros. I&#x27;ve got an interesting one that I can&#x27;t explain. Maybe someone out there has seen this behavior before. Environment:  Bandwidth: 1Gbps LAN RTT: &amp;lt;1ms Hosts: Both Win2k8R2, bare metal Test: wget of a ~223MB file from a Tomcat server  Issue: When MTU is default 1500, performance is...'''
date = "2014-08-14T00:16:00Z"
lastmod = "2014-08-14T00:16:00Z"
weight = 35477
keywords = [ "tcp_delayed_ack" ]
aliases = [ "/questions/35477" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [Inconsistent delayed ACK behavior](/questions/35477/inconsistent-delayed-ack-behavior)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-35477-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-35477-score" class="post-score" title="current number of votes">0</div><span id="post-35477-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count">3</div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, packet pros. I've got an interesting one that I can't explain. Maybe someone out there has seen this behavior before.</p><p><strong>Environment</strong>:</p><ul><li>Bandwidth: 1Gbps LAN</li><li>RTT: &lt;1ms</li><li>Hosts: Both Win2k8R2, bare metal</li><li>Test: wget of a ~223MB file from a Tomcat server</li></ul><p><strong>Issue</strong>: When MTU is default 1500, performance is ~55Mbps. Lower MTU to 1350 gets ~300Mbps.</p><p><strong>Analysis</strong>: There are 10x more delayed ACKs in the 1500 MTU test vs the 1350 MTU test.</p><p><strong>Fix</strong>: Disable delayed ACK (TcpAckFrequency = 1) = ~500Mbps.</p><p><strong>Digging deeper and question</strong>: I can't see why a 1500 MTU (1460 MSS) would trigger more delayed ACKs than 1350 MTU (1310 MSS). On top of that, the delayed ACKs aren't consistent when there's a single segment to be ACKed that should trigger a delayed ACK.</p><p>In fact, the send buffer size is 64k so that leads to an odd number of packets for both 1460 (45 segments) and 1310 (51 segments) MSSes. So there should likely be a delayed ACK at the end of each 64k chunk.</p><p>However, the number of segments acknowledged per ACK varies, it's not always 2. Sometimes it varies wildly e.g. 2, 3, 8 or more. Given that the number of ACKs it takes to acknowledge 64k varies depending on how many segments are ACKed per ACK, it would make sense that sometimes we end up with a single segment to be ACKed at the end of 64k and sometimes not. So it doesn't make sense to me that a MSS of 1310 would have consistently 10x fewer delayed ACKs.</p><p>Now, this isn't my issue, it was brought to me, so I won't share the pcaps unless allowed (he's cool with it, see below), but I'll include some screencaps. Also, note that I added two columns <code>Segments ACKed</code> and <code>Buffer bytes</code>. I added these in packet-tcp.c.</p><p><code>Segments ACKed</code>: The number of segments acknowledged by this ACK</p><p><code>Buffer bytes</code>: The number of bytes sent since the last PSH flag. This gives me an idea of the send buffer size or how much data the application is giving to TCP. With low latency, bytes in flight never gets very high so I wanted an easier way to see the buffer size.</p><p>Example of single segment to be ACKED with delayed ACK: <img src="http://i.imgur.com/K9PiKaQ.png" alt="delay" /></p><p>Example of single segment to be ACKED with no delay: <img src="http://i.imgur.com/GS6JwA4.png" alt="no delay" /></p><p>These are just two examples that are repeated many times through out the capture. There are 3573 64k chunks which means with an MSS of 1460 and an odd number of packets, there could be 3573 delayed ACKs but there are only 150. There are only 15 delayed ACKs in the 1310 MSS capture.</p><p>I can not explain this behavior.</p><p>pcaps:</p><ul><li><a href="https://dl.dropboxusercontent.com/u/19380111/traces/MTU_1500_Copy_to_local_anon.pcapng">1500 MTU</a></li><li><a href="https://dl.dropboxusercontent.com/u/19380111/traces/MTU_1350_Copy_to_local_anon.pcapng">1350 MTU</a></li></ul></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-tcp_delayed_ack" rel="tag" title="see questions tagged &#39;tcp_delayed_ack&#39;">tcp_delayed_ack</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>14 Aug '14, 00:16</strong></p><img src="https://secure.gravatar.com/avatar/31a520375abb3ce54cec49f68af6a11c?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="karyrogers&#39;s gravatar image" /><p><span>karyrogers</span><br />
<span class="score" title="66 reputation points">66</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="karyrogers has one accepted answer">100%</span></p></img></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>14 Aug '14, 09:16</strong> </span></p></div></div><div id="comments-container-35477" class="comments-container"></div><div id="comment-tools-35477" class="comment-tools"></div><div class="clear"></div><div id="comment-35477-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

