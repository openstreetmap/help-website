+++
type = "question"
title = "Connection to Microsoft Exchange has been lost. Outlook will restore the connection when possible"
description = '''If I had any hair left, I would be pulling it out right now. I can’t seem to figure out why my Outlook 2007 keeps disconnecting from Exchange 2007 running on Windows Server 2008 every 10 seconds. I didn&#x27;t have any connection problems until I injected 700MB pst file in to a users mailbox (cached mode...'''
date = "2010-10-26T07:00:00Z"
lastmod = "2010-11-01T16:04:00Z"
weight = 652
keywords = [ "outlook", "mapi", "connection", "lost", "exchange" ]
aliases = [ "/questions/652" ]
osqa_answers = 0
osqa_accepted = true
+++

<div class="headNormal">

# [Connection to Microsoft Exchange has been lost. Outlook will restore the connection when possible](/questions/652/connection-to-microsoft-exchange-has-been-lost-outlook-will-restore-the-connection-when-possible)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-652-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>If I had any hair left, I would be pulling it out right now. I can’t seem to figure out why my Outlook 2007 keeps disconnecting from Exchange 2007 running on Windows Server 2008 every 10 seconds.</p><p>I didn't have any connection problems until I injected 700MB pst file in to a users mailbox (cached mode)</p><p>So here is the scenario:</p><p>Server: Windows 2008 x64 with Exchange 2007 Enterprise (Virtual on ESXi 4.1 Server) 192.168.30.5</p><p>Client: Windows Ultimate x86 with Outlook 2007 192.168.20.107</p><p>As soon as I imported the PST file in to outlook I started getting</p><p>Event IDs 9646 on the server</p><p>Mapi session "/o=First Organization/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=tom" exceeded the maximum of 32 objects of type "session".</p><p>Increasing the limit in the Registry to 512 didn't fix the connection problem, but took care of the event 9646 on the server.</p><p>Clearing Download shared folders (excludes mail folders) in outlook on the client pc didn't fix the problem.</p><p>Event id 26 gets logged on the client every 10 sec</p><p>Connection to Microsoft Exchange has been lost. Outlook will restore the connection when possible.</p><p>then</p><p>Connection to Microsoft Exchange has been restored.</p><p>Client is located at the remote location with a hardware VPN between locations (Linksys RV082 &amp; RV042)</p><p>Symantec EndPoint Protection is installed on the client, but shutting it down does not make any difference.</p><p>This is not a network problem, as I can copy 300MB file from the client to the server and back without any problems.</p><p>Client is connected to a Linksys SRW2008 switch. I spanned its port and captured outlook traffic using another computer (promiscuise mode)</p><p>Looking at the trace, I am seeing ACKs packets to the server from the client, but no SYN ACKs back</p><p>Can anyone spot where the problem is in this trace?</p><p>P.S. Also new emails are coming in and going out while disconnects are happening. What’s causing the disconnects are outlooks attempts to sync its Mailbox with the server. Why it’s happening is still a question.</p><p><a href="http://www.remontnetworks.com/mapi.zip">Click here to download Trace File</a></p><p>Thanks</p></div><div id="question-tags" class="tags-container tags">outlook mapi connection lost exchange</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>26 Oct '10, 07:00</strong></p><img src="https://secure.gravatar.com/avatar/bcfdf26904f3a8a9fb69c7ca0dc5e7b1?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="net_tech&#39;s gravatar image" /><p>net_tech<br />
<span class="score" title="116 reputation points">116</span><span title="30 badges"><span class="badge1">●</span><span class="badgecount">30</span></span><span title="33 badges"><span class="silver">●</span><span class="badgecount">33</span></span><span title="37 badges"><span class="bronze">●</span><span class="badgecount">37</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="net_tech has 2 accepted answers">13%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 26 Oct '10, 08:04</p></div></div><div id="comments-container-652" class="comments-container"><span id="655"></span><div id="comment-655" class="comment"><div id="post-655-score" class="comment-score"></div><div class="comment-text"><p>As I live in the world of packets, I focused in on your sentence regarding the trace file.</p><p>You see ACKs, but no SYN ACKs back...</p><p>The SYN/ACK would be seen only in the handshake process - we'd expect to see SYN, SYN/ACK, ACK for the 3-way TCP handshake.</p><p>Since you see a MAPI error message, consider checking out http://support.microsoft.com/kb/842022 which lists possible causes for this issue. Seems to point to an application issue.</p><p>Consider looking at the line about adding a large additional mailbox to a profile.</p><p>You might ask over in one of the Exchange/Outlook forums as well.</p></div><div id="comment-655-info" class="comment-info"><span class="comment-age">(26 Oct '10, 08:45)</span> lchappell ♦</div></div><span id="663"></span><div id="comment-663" class="comment"><div id="post-663-score" class="comment-score"></div><div class="comment-text"><p>Hi Laura and thank you for your response.</p><p>I posted this problem in Exchange forum, but got no help so that's why I am here. I spent some time on Microsoft site and saw the article you mentioned 842022.</p><p>As I said in my original post "Clearing Download shared folders (excludes mail folders) in outlook on the client pc didn't fix the problem"</p><p>Also if I fire up a 2003 exchange server on the same virtual hardware and don't make any other changes the problem does not exist.</p></div><div id="comment-663-info" class="comment-info"><span class="comment-age">(26 Oct '10, 09:14)</span> net_tech</div></div><span id="667"></span><div id="comment-667" class="comment"><div id="post-667-score" class="comment-score"></div><div class="comment-text"><p>I don’t think I knew what I was talking about. (ACKs, but no SYN ACKs back) So please let me rephrase. 47 sec in to the trace (packet 2898), Vista Client sends an ACK to the server with a Sequence # 10552. 4 packets come back from the server, client send another ACK with the same sequence number (10552) another 4 packets come back. This process repeats 9 times then finally client sends another ACK with the same sequence # (Packet 2941) but this time wiresharks marks it as a DUP ACK for packet 2937 then I see another 34 DUP ACK packets for 2937 and then client gives up and sends a RST, ACK</p></div><div id="comment-667-info" class="comment-info"><span class="comment-age">(26 Oct '10, 09:35)</span> net_tech</div></div><span id="679"></span><div id="comment-679" class="comment"><div id="post-679-score" class="comment-score"></div><div class="comment-text"><p>just taking another guess here, but DUP ACKs seem to be a result of torn down MAPI session which was requested in packet 2777 by the client and acknowledged by the server in 2778</p><p>can anyone comment on that?</p></div><div id="comment-679-info" class="comment-info"><span class="comment-age">(26 Oct '10, 11:21)</span> net_tech</div></div></div><div id="comment-tools-652" class="comment-tools"></div><div class="clear"></div><div id="comment-652-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="771"></span>

<div id="answer-container-771" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-771-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>Copying files via (Explorer/CIFS?) doesn't necessarily rule out a network issue. Different apps behave differently when packet fragmentation has to occur. The question I have is what is the MTU between the to path?<br />
</p><p>For some reason, someone is not honoring the do-not-fragment bit in the packets (lot of devices do this, including Cisco routers). The MTU from 30.5 to 20.107 seems to be limited as can be seen in packet #59. Although previous smaller packets (with DF bit set) makes it across, this packet does not). Presumably, it too had the DF bit set, so we can reasonably assume that someone is munging it.</p><p>Also, in pkt #1012, you can see that the fragment goes missing causing the communication to go "wonky" Notice that ip.id= == 30384 in 1012 doesn't have a corresponding fragment. So this fragment and the next two packets went missing for some reason. The next packet has ip.id==30386 (two fragmented packets that make up the first original packet). So someone ate the fragment for ip.id==30384 and the two packets that make up id 30385.</p><p>Ensure someone isn't ACL'ing ICMP messages. Especially ICMP type 3, code 4 (fragmentation required but DF bit set) which is critical for path mtu discovery process.</p><p>Good luck Hansang</p><p>PS: in the future, give us quick ascii layout of the land. What IP represents the server/client, where the capture was taken etc. Although it can be figured out by looking at the traces, it's a hinderance and folks may not take the time to review the trace files.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>01 Nov '10, 16:04</strong></p><img src="https://secure.gravatar.com/avatar/63805f079ac429902641cad9d7cd69e8?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="hansangb&#39;s gravatar image" /><p>hansangb<br />
<span class="score" title="791 reputation points">791</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="6 badges"><span class="silver">●</span><span class="badgecount">6</span></span><span title="19 badges"><span class="bronze">●</span><span class="badgecount">19</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="hansangb has 7 accepted answers">12%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 01 Nov '10, 16:09</p></div></div><div id="comments-container-771" class="comments-container"><span id="773"></span><div id="comment-773" class="comment"><div id="post-773-score" class="comment-score"></div><div class="comment-text"><p>Thanks Hansang!</p><p>You are 100% right on the money. The problem was in the transport layer with MTU. All application error messages were misleading. Server side router had MTU set to 1500, client side was set to 1492. Changing server side router to 1492 fixed the problem. (big thanks to Laura &amp; SYNbit)</p><p>I didn't get anywhere in this thread, so started another one</p><p>http://ask.wireshark.org/questions/748/wireshark-placement-question</p></div><div id="comment-773-info" class="comment-info"><span class="comment-age">(01 Nov '10, 19:01)</span> net_tech</div></div></div><div id="comment-tools-771" class="comment-tools"></div><div class="clear"></div><div id="comment-771-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

