+++
type = "question"
title = "TCP Retransmssion - client Hello"
description = '''Hi, Kindly help based on 2 capture below, why the delay / error ? client = 192.168.19.175 ( NAT IP : 192.168.30.134 ) Server = 192.168.5.18 virtual IP ( node C IP : 192.168.5.113 ) Server under the NLB.... Below capture from client to Node C  Below capture at Server Node C '''
date = "2016-01-11T03:22:00Z"
lastmod = "2016-01-13T00:44:00Z"
weight = 49072
keywords = [ "client", "retransmssion", "tcp", "hello" ]
aliases = [ "/questions/49072" ]
osqa_answers = 1
osqa_accepted = false
+++

<div class="headNormal">

# [TCP Retransmssion - client Hello](/questions/49072/tcp-retransmssion-client-hello)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-49072-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-49072-score" class="post-score" title="current number of votes">0</div><span id="post-49072-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi, Kindly help based on 2 capture below, why the delay / error ?</p><p>client = 192.168.19.175 ( NAT IP : 192.168.30.134 ) Server = 192.168.5.18 virtual IP ( node C IP : 192.168.5.113 )</p><p>Server under the NLB....</p><p>Below capture from client to Node C <img src="https://osqa-ask.wireshark.org/upfiles/Client_to_Node_C.jpg" /></p><p>Below capture at Server Node C <img src="https://osqa-ask.wireshark.org/upfiles/Server_Node_C_n5IJxnO.jpg" /></p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-client" rel="tag" title="see questions tagged &#39;client&#39;">client</span> <span class="post-tag tag-link-retransmssion" rel="tag" title="see questions tagged &#39;retransmssion&#39;">retransmssion</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span> <span class="post-tag tag-link-hello" rel="tag" title="see questions tagged &#39;hello&#39;">hello</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>11 Jan '16, 03:22</strong></p><img src="https://secure.gravatar.com/avatar/23c28ef216aa671c316d94cd9b566639?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="suarez&#39;s gravatar image" /><p><span>suarez</span><br />
<span class="score" title="1 reputation points">1</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="suarez has no accepted answers">0%</span></p></img></div></div><div id="comments-container-49072" class="comments-container"><span id="49076"></span><div id="comment-49076" class="comment"><div id="post-49076-score" class="comment-score"></div><div class="comment-text"><p>Could you publish the capture file (anonymized using TraceWrangler if necessary so that the tcp payload and the real IP addresses are not disclosed) somewhere and put a link to it here.</p></div><div id="comment-49076-info" class="comment-info"><span class="comment-age">(11 Jan '16, 04:18)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="49077"></span><div id="comment-49077" class="comment"><div id="post-49077-score" class="comment-score"></div><div class="comment-text"><p>I would extend <span></span><span>@Christian_R</span>'s requirement to <strong>both</strong> files, and not filtered to just a single tcp session each. <span></span><span>@Christian_R</span>'s remark has drawn my attention to the fact that the source port is the same for packets sent from client to the NAT box and from the NAT box to the server, which does not necessarily mean that they come from the same session, while the timestamps are slightly shifted. So knowing nothing about the mutual offset of the timestamps on both machines, I'm afraid that we'll not be able to match the client-NAT and NAT-server sessions to each other by anything else but the payload contents. Or it is not a plain NAT but a MITM box and then even the payload won't help, so you'd have to get rid of all the other traffic while capturing.</p></div><div id="comment-49077-info" class="comment-info"><span class="comment-age">(11 Jan '16, 04:26)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="49079"></span><div id="comment-49079" class="comment"><div id="post-49079-score" class="comment-score"></div><div class="comment-text"><p>One more sample...</p><p>Client Screenshot...port 9776 <img src="https://osqa-ask.wireshark.org/upfiles/Client_Port_9776.jpg" /></p><p>server Screenshot...port 9776 <img src="https://osqa-ask.wireshark.org/upfiles/Server_Port_9776.jpg" alt="alt text" /></p><p>1) There is lost packets a. Client site send around 9 packets to server b. Server site only receive 6 packets 2) Packet information changed when reached server a. Client site send PSH, ACK packet to server b. Server Receive the packet as SYN.</p></div><div id="comment-49079-info" class="comment-info"><span class="comment-age">(11 Jan '16, 04:49)</span> <span class="comment-user userinfo">suarez</span></div></div><span id="49080"></span><div id="comment-49080" class="comment"><div id="post-49080-score" class="comment-score"></div><div class="comment-text"><p>You <em>cannot</em> get a better answer by providing more <em>screenshots</em>. You <em>may</em> get a better one if you post links to the capture <em>files</em>, as asked by <span>@Christian_R</span>.</p><p>Once again, the NAT often changes the port numbers, so you cannot be sure that the packets in the two captures come from sessions matching each other.</p><p>NB: relative times are worse than absolute ones when it comes to matching two captures to each other.</p></div><div id="comment-49080-info" class="comment-info"><span class="comment-age">(11 Jan '16, 04:56)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="49108"></span><div id="comment-49108" class="comment"><div id="post-49108-score" class="comment-score"></div><div class="comment-text"><p>Hi Thanks Sindy and Cristian_R</p><p>I have upload files to cloudshark... Below is the link..I have remove Setting for Payload sanitization &gt; Remove all unknown layers ( cut away bytes from packets ) using Trace Wrangler...</p><p>CLIENT <a href="https://www.cloudshark.org/captures/0605c5094ba9">https://www.cloudshark.org/captures/0605c5094ba9</a></p><p>SERVER node A <a href="https://www.cloudshark.org/captures/dc238978f7b7">https://www.cloudshark.org/captures/dc238978f7b7</a></p><p>SERVER node C <a href="https://www.cloudshark.org/captures/c3cc23dcfcb7">https://www.cloudshark.org/captures/c3cc23dcfcb7</a></p><p>Thank you very much :)</p></div><div id="comment-49108-info" class="comment-info"><span class="comment-age">(11 Jan '16, 17:57)</span> <span class="comment-user userinfo">suarez</span></div></div><span id="49112"></span><div id="comment-49112" class="comment not_top_scorer"><div id="post-49112-score" class="comment-score"></div><div class="comment-text"><p>Once more:</p><ul><li><p>what makes you believe that your NAT device uses, at its public side, the same port which the client on private side is using? Some NATs do act like this unless specific circumstances force them not to do so, but more often the source port of the source-NATed packet differs from that of the same packet before the source-NAT was applied.</p></li><li><p>as you have removed everything above the tcp level, we cannot verify by payload contents whether the packets before and after pass through NAT belong to each other. The payload of the client Hello may not be enough and at least one response may be necessary.</p></li><li><p>even if you would have provided information about offset between the timestamps in the captures, the processing delay of the NAT device may be too high to allow to reliably correlate the captures without the payload contents.</p></li></ul><p>So at the moment I can only repeat that I can see in the capture at Node A that in the previous TCP session using the same socket pair like the one affected with retransmissions, the client (or the NAT device) sends FIN first, which causes the server side to go into TIME_WAIT state after closing the session, which usually lasts for two minutes. The last ACK packet of the "previous" TCP session, in frame 23, comes at 11:16:28.368, so the server ignores any packets from the same source socket to the same destination socket until 11:18:28.36 because it treats them as wandering packets belonging to that last session. This is the case for all the SYN packets from frame 24 (the initial SYN packet) through frame 27 (which has come at 11:18.22.287), and the server has only "taken seriously" the retransmission of the SYN which has come at 11:18:46.266 (frame 28).</p><p>Whether this also explains why the TCP Hello from the client is retransmitted depends on whether the packets which the client is sending from port 9776 are also sent from port 9776 by the NAT device. If the NAT really maintains the source port unchanged, then my original answer is valid (the NAT device establishing the session with the client before the twin session gets established between the NAT device and the server); otherwise, these two phenomenons are unrelated because the two tcp sessions using source port 9776 are unrelated.</p></div><div id="comment-49112-info" class="comment-info"><span class="comment-age">(12 Jan '16, 01:51)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="49155"></span><div id="comment-49155" class="comment not_top_scorer"><div id="post-49155-score" class="comment-score"></div><div class="comment-text"><p>Hi,</p><p>does anyone have an idea related to this issue..? thanks</p></div><div id="comment-49155-info" class="comment-info"><span class="comment-age">(12 Jan '16, 18:08)</span> <span class="comment-user userinfo">suarez</span></div></div></div><div id="comment-tools-49072" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-49072-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="49073"></span>

<div id="answer-container-49073" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-49073-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-49073-score" class="post-score" title="current number of votes">0</div><span id="post-49073-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>It seems that your NAT box establishes the tcp session locally before receiving the SYN,ACK from the real server, so when the client starts sending real data packets, the NAT box is unable to forward them because the session at public side has not been established yet.</p><p>As for the reason why the server ignores the incoming SYN packet: seeing the "tcp port numbers reused" expert info at the first occurrence of the SYN packet together with the time it took the server to respond the SYN packet, I would assume that the previous session to the server from the same source socket (of the NAT) has been closed from client initiative, and thus the server has been in TIME_WAIT state since then and has responded the SYN only after that state has timed out. Look at the last packets with same source and destination port which came before the first SYN to confirm this.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>11 Jan '16, 04:01</strong></p><img src="https://secure.gravatar.com/avatar/00fc6e2633725bd871ff636f0175eabc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="sindy&#39;s gravatar image" /><p><span>sindy</span><br />
<span class="score" title="6049 reputation points"><span>6.0k</span></span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="8 badges"><span class="silver">●</span><span class="badgecount">8</span></span><span title="51 badges"><span class="bronze">●</span><span class="badgecount">51</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="sindy has 110 accepted answers">24%</span></p></img></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>11 Jan '16, 04:03</strong> </span></p></div></div><div id="comments-container-49073" class="comments-container"><span id="49074"></span><div id="comment-49074" class="comment"><div id="post-49074-score" class="comment-score"></div><div class="comment-text"><p>Maybe, maybe not... Without the trace files it is hard to say.</p><p>Two small example: The SYN Packets have different length in both traces. And the SYN/ACK offers different MSS</p></div><div id="comment-49074-info" class="comment-info"><span class="comment-age">(11 Jan '16, 04:06)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="49158"></span><div id="comment-49158" class="comment"><div id="post-49158-score" class="comment-score"></div><div class="comment-text"><p><span>@suarez</span>, have you noticed that only 5 comments are shown to each Question or Answer and you have to press "show X more comments" to read the additional ones?</p></div><div id="comment-49158-info" class="comment-info"><span class="comment-age">(13 Jan '16, 00:44)</span> <span class="comment-user userinfo">sindy</span></div></div></div><div id="comment-tools-49073" class="comment-tools"></div><div class="clear"></div><div id="comment-49073-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

