+++
type = "question"
title = "ACK/RST loop"
description = '''I recently installed conky (system monitoring application) on my Linux Mint 17.3 PC, and I have since noticed some intermittent odd network behaviour. At random times during the day, I see a sustained spike in upload &amp;amp; download traffic on my eth0 interface (normal wired NIC). It lasts 10-30 minu...'''
date = "2017-01-05T13:36:00Z"
lastmod = "2017-01-14T05:18:00Z"
weight = 58546
keywords = [ "ack", "rst" ]
aliases = [ "/questions/58546" ]
osqa_answers = 1
osqa_accepted = false
+++

<div class="headNormal">

# [ACK/RST loop](/questions/58546/ackrst-loop)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-58546-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-58546-score" class="post-score" title="current number of votes">1</div><span id="post-58546-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count">1</div></div></td><td><div id="item-right"><div class="question-body"><p>I recently installed <a href="https://github.com/brndnmtthws/conky">conky</a> (system monitoring application) on my Linux Mint 17.3 PC, and I have since noticed some intermittent odd network behaviour.</p><p>At random times during the day, I see a sustained spike in upload &amp; download traffic on my eth0 interface (normal wired NIC). It lasts 10-30 minutes, then goes away on its own.</p><p>Normally, the conky output for network traffic looks like this:</p><p><a href="https://i.stack.imgur.com/n4FNd.jpg"><img src="https://i.stack.imgur.com/n4FNd.jpg" alt="enter image description here" /></a></p><p>10KB/s down; 11KB/s up. I'm listening to music on YouTube; so this seems pretty reasonable.</p><p>BUT! Sometimes, I happen to glance over &amp; see the traffic graph, and it looks like this: <a href="https://i.stack.imgur.com/JKOXU.jpg"><img src="https://i.stack.imgur.com/JKOXU.jpg" alt="enter image description here" /></a></p><p>The white "BAR" is the up/send side of my NIC max'ing out this chart. Yes, it's only 630 KB/s, but that seems pretty dang high, considering that I'm not initiating it.</p><p>So, I'm naturally wondering "what is using all of that bandwidth?"</p><p>I've dug in a bit, and (using a combination of nethogs, netstat, tcpdump, and Wireshark) I have identified that the culprit in all situations is a single connection to a remote host.</p><p>The connection is either on :80 or :443; and is simply a sustained loop of ACK's (coming from their side) and RST's (coming from me).</p><p>Normally, NetHogs looks a bit like this: <a href="https://i.stack.imgur.com/lVDbR.jpg"><img src="https://i.stack.imgur.com/lVDbR.jpg" alt="enter image description here" /></a> Note the Process ID on the left (handy for identifying the source of the traffic)</p><p>But when the 'Spike' is happening, the NetHogs output looks like this: <a href="https://i.stack.imgur.com/FgZMO.jpg"><img src="https://i.stack.imgur.com/FgZMO.jpg" alt="enter image description here" /></a> Note the '?' in the PID. Yes, I'm running NetHogs as root. How can it not know??</p><p>So, I dump the traffic with <code>tcpdump -w</code> and toss the .pcap into WireShark: <a href="https://i.stack.imgur.com/GcqPr.jpg"><img src="https://i.stack.imgur.com/GcqPr.jpg" alt="enter image description here" /></a></p><p>Here's the actual tcpdump output for the extra-geeky:</p><pre><code>14:41:00.007873 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.007876 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.007877 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.007880 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008130 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008137 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008139 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008142 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008406 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008417 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008420 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008423 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008425 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008428 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0
14:41:00.008673 IP 58.229.196.104.bc.googleusercontent.com.https &gt; reginald.34879: Flags [.], ack 1, win 58, length 0
14:41:00.008680 IP reginald.34879 &gt; 58.229.196.104.bc.googleusercontent.com.https: Flags [R], seq 1127736183, win 0, length 0</code></pre><p>Anyhow, my (limited) understanding of what's going on with the RST's &amp; ACK's is this:</p><hr /><p>They say: "ACK", meaning "OK, I got what you said"</p><p>I say: "RST", meaning "Right, let's end this conversation"</p><hr /><p>But even after I 'reset' the convo; they keep ACK'ing me!</p><p>This goes on for several minutes; then the traffic just dies off after awhile. (I haven't timed it; that might be interesting info too).</p><p><a href="https://i.stack.imgur.com/v7PmC.jpg"><img src="https://i.stack.imgur.com/v7PmC.jpg" alt="enter image description here" /></a></p><p>A few other pieces of info:</p><ol><li>There's nothing that I do on my PC that precedes this. I'm just browsing the internet, etc. Basically running only Chrome Browser.</li><li>I don't have any 'servers' going (P2P, file services, etc)</li><li>I don't have Spotify or anything that can act as a P2P server running</li><li>I am on a very simple network. Just my PC &amp; Android phone, behind a 50/10 Mbps Cable Modem link</li><li>I don't suspect foul play, hacking, etc. I'm not interesting.</li></ol><p>So, <strong>all of that</strong> to lead up to my questions:</p><ol><li>What is going on here?</li><li>Why don't I see the process ID in NetHogs? That sure would help identify the source of the traffic.</li><li>One theory that I have is that this is a Chrome data transmission gone bad. Chrome starts this TCP session, and then closes it off; but the other end keeps up the convo, for some reason. Does that sound possible/reasonable?</li><li>Is this preventable?</li><li>Any ideas on how to kill it, when I notice it happening again? I'm thinking tcpkill; and will update the post when this happens again.</li><li>What other tools can I use to identify the source of the traffic?</li></ol></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-ack" rel="tag" title="see questions tagged &#39;ack&#39;">ack</span> <span class="post-tag tag-link-rst" rel="tag" title="see questions tagged &#39;rst&#39;">rst</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>05 Jan '17, 13:36</strong></p><img src="https://secure.gravatar.com/avatar/e94c6034e9c57aead12549c40b46470b?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="jonwadsworth&#39;s gravatar image" /><p><span>jonwadsworth</span><br />
<span class="score" title="21 reputation points">21</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="jonwadsworth has no accepted answers">0%</span></p></img></div></div><div id="comments-container-58546" class="comments-container"><span id="58561"></span><div id="comment-58561" class="comment"><div id="post-58561-score" class="comment-score">1</div><div class="comment-text"><blockquote><blockquote><p>Here's the actual tcpdump output for the extra-geeky:</p></blockquote></blockquote><p>I'd still rather have look at actual pcap file in a publicly accessible location...</p><p>First blush at the RST/ACK behavior without seeing the trace is the RSTs are either not getting to the destination, or they are considered invalid by the receiving destination. I have some older products that have some TCP stack issues and a modern Linux host does not accept RSTs from these devices. Conversely, perhaps an outbound firewall won't forward them because it lost the state (e.g. you probably see RELATED-ESTABLISHED and other such keywords when doing firewall config).</p><blockquote><blockquote><p>?' in the PID. Yes, I'm running NetHogs as root. How can it not know??</p></blockquote></blockquote><p>I don't know that tool but I usually use netstat -tnp. Once sockets are in certain states that are not passing data (e.g. Time-Wait), I noticed no process is listed. I wonder if you are seeing that here as well.</p><p>Is lsof any better?</p></div><div id="comment-58561-info" class="comment-info"><span class="comment-age">(06 Jan '17, 05:10)</span> <span class="comment-user userinfo">Bob Jones</span></div></div><span id="58568"></span><div id="comment-58568" class="comment"><div id="post-58568-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your comments Bob! I have the .pcap file: <a href="https://github.com/jonwadsworth/pcap/blob/master/104.pcap">https://github.com/jonwadsworth/pcap/blob/master/104.pcap</a></p><p>It's pretty big (12MB).... Very interested to hear what you think.</p><p>I will try your suggestions of netstat -tnp &amp; checking the firewall the next time this happens!</p></div><div id="comment-58568-info" class="comment-info"><span class="comment-age">(06 Jan '17, 11:27)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div><span id="58575"></span><div id="comment-58575" class="comment"><div id="post-58575-score" class="comment-score"></div><div class="comment-text"><p>Just being curious: is there a virtualization software running at the time this happens?</p></div><div id="comment-58575-info" class="comment-info"><span class="comment-age">(07 Jan '17, 03:27)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="58643"></span><div id="comment-58643" class="comment"><div id="post-58643-score" class="comment-score"></div><div class="comment-text"><p>No Virt software running... thanks for asking</p></div><div id="comment-58643-info" class="comment-info"><span class="comment-age">(10 Jan '17, 09:27)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div></div><div id="comment-tools-58546" class="comment-tools"></div><div class="clear"></div><div id="comment-58546-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="58574"></span>

<div id="answer-container-58574" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-58574-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-58574-score" class="post-score" title="current number of votes">3</div><span id="post-58574-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Hello jonwadsworth!</p><p>This is one of the coolest RST loops that I have ever seen. Here is what's going on:</p><p>Your Linux box is trying to reset a connection. You figured that out correctly. For some reason this packet doesn't make it to the destination address. Instead you get these retransmitted ACKs all the time.</p><p>From a receivers point of view it is perfectly normal, if data arrives after a Reset has been send. That's usually data in transit that was transmitted by the remote system before it has received the RST. This happens usually within a few milliseconds (1 TCP roundtrip time to be precise).</p><p>In your tracefile we see TCP packets <em>without data</em> arriving for more than 8 seconds. That's odd. Let's take a closer look.</p><p>The ACK packets with source address 104.196.229.58 have a TTL of 64 and an IP ID of 0. Both are odd values. The TTL has an initial value of 255, 128 or 64 (depending on your operating system) and is reduced by one when a router forwards a packet. A TTL of 64 indicates that the very packet originates from a host on your local network. My guess is, that your firewall is sending this packet for what ever reason.</p><p>Next the IP ID. This is something like a 16 bit serial number that is used to process fragmented IP packets. Depending on your OS the IP ID could be incremented by one for each packet in a TCP connection or each packet send by the host (independent of the TCP connection). Or it could be a just a random number. In your tracefile all ACK packets have the same IP ID of zero. This is another indicator, that the packets are not coming from the remote host. If 104.196.229.58 had send these packets as real retransmissions we would see different IP IDs.</p><p>I assume, that your firewall is doing something strange. I am pretty sure that neither the RST packets nor the ACK packets are visible on the external interface of the firewall. It would be greatly appreciated if you could tell us what manufacturer / software / configuration is responsible for this behaviour.</p><p>Oh, by the way: Capturing directly on the firewall may or may not give you a correct representation of the traffic leaving the physical interface. The result depends on the order of operation on the firewall. The tracefile will be different, depending on the fact if the filter engine kicks in before or after Wireshark / tcpdump have access to the packet.</p><p>Anyway, thank you for one of the most remarkable TCP behavior that I have seen in a while. Thumbs up.</p><p>Good hunting!</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>07 Jan '17, 02:42</strong></p><img src="https://secure.gravatar.com/avatar/3b60e92020a427bb24332efc0b560943?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="packethunter&#39;s gravatar image" /><p><span>packethunter</span><br />
<span class="score" title="2137 reputation points"><span>2.1k</span></span><span title="7 badges"><span class="badge1">●</span><span class="badgecount">7</span></span><span title="15 badges"><span class="silver">●</span><span class="badgecount">15</span></span><span title="48 badges"><span class="bronze">●</span><span class="badgecount">48</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="packethunter has 8 accepted answers">8%</span></p></img></div></div><div id="comments-container-58574" class="comments-container"><span id="58614"></span><div id="comment-58614" class="comment"><div id="post-58614-score" class="comment-score"></div><div class="comment-text"><p>Hey Packethunter!</p><p>Wow, some great info there.</p><p>Well, it's happening again today, so I have more data! And, it looks like your suspicions are correct.</p><p>First -- the Firewall is a Sonicwall TZ200 -- on their low-end of devices; but it has the latest firmware updates, etc.</p><p>Here's the SonicWall's Packet Monitor output for the address in question, during a 'event': <img src="https://osqa-ask.wireshark.org/upfiles/Selection_138.jpg" width="600" /></p><p>I'm not sure if this site will display the entire width of that image, so in case you can't see -- the far right columns show that the packets with a "Source IP" of 50.234.5.128 (the ACK's) are actually being GENERATED by the SonicWall! This is super crazy to me -- it's as if the SonicWall is forging/impersonating that device. I suppose that it thinks that it has a good reason for this -- but seems crummy to me.</p><p>Then, when my PC sends back the RST, the logs indicate that the SonicWall has DROPPED those packets. Presumably so that the actual server at 50.234.5.128 doesn't get these RST's and wonder WTF is going on.</p><p>In case you'd like to have a look---- I have added my PCAP from my local system: <a href="https://github.com/jonwadsworth/pcap/blob/master/dump.pcap">https://github.com/jonwadsworth/pcap/blob/master/dump.pcap</a></p><p>And the pcap from the SonicWall: <a href="https://github.com/jonwadsworth/pcap/blob/master/packet-c.pcap">https://github.com/jonwadsworth/pcap/blob/master/packet-c.pcap</a></p><p>OK, so:</p><p>1) Any clue why a Firewall would GENERATE ACK's for a remote device? 2) Could something in my configuration be causing this? 3) Any idea how to prevent this from happening in the future?</p><p>Thanks again for help in sleuthing this out!!</p></div><div id="comment-58614-info" class="comment-info"><span class="comment-age">(09 Jan '17, 12:27)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div><span id="58615"></span><div id="comment-58615" class="comment"><div id="post-58615-score" class="comment-score"></div><div class="comment-text"><p>So it's happening again... it seems like the SonicWall is detecting this as an RST flood.</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Selection_139.jpg" alt="alt text" /></p><p>I'm guessing that this is an overly aggressive TCP flood detection setting on the SonicWall. Here are my TCP settings:</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Selection_140.jpg" alt="alt text" /></p><p>Any ideas?</p><p>Thanks!!</p></div><div id="comment-58615-info" class="comment-info"><span class="comment-age">(09 Jan '17, 13:32)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div><span id="58616"></span><div id="comment-58616" class="comment"><div id="post-58616-score" class="comment-score">1</div><div class="comment-text"><p>Is there any setting for ssl or tls content filtering or control?</p></div><div id="comment-58616-info" class="comment-info"><span class="comment-age">(09 Jan '17, 13:44)</span> <span class="comment-user userinfo">Bob Jones</span></div></div><span id="58644"></span><div id="comment-58644" class="comment"><div id="post-58644-score" class="comment-score"></div><div class="comment-text"><p>I have seen this behaviour with :80 as well as :443; so I'm inclined to think it's not SSL-specific -- but I'll check &amp; report back</p></div><div id="comment-58644-info" class="comment-info"><span class="comment-age">(10 Jan '17, 09:28)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div><span id="58645"></span><div id="comment-58645" class="comment"><div id="post-58645-score" class="comment-score"></div><div class="comment-text"><p>There are 3 tracefiles attached to this question: - Client - FW - Server</p><p>Am I right?</p></div><div id="comment-58645-info" class="comment-info"><span class="comment-age">(10 Jan '17, 11:27)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="58671"></span><div id="comment-58671" class="comment not_top_scorer"><div id="post-58671-score" class="comment-score"></div><div class="comment-text"><p>Please try to disable the RFC 5961 enforcement</p><p>RFC 5961 addresses a problem in TCP where an attacker might be able to break a session by guessing sequence and acknowledge numbers within a certain range. This RFC adds a few extra checks to make the attackers life harder.</p><p>It is possible that the firewall is a bit overzealous with it's checks.</p><p>Just a (very) wild guess: Your initial post mentions, that the problems started after the installation of a monitoring application. Is it possible, that a source port number was re-used? The RST/ACK loop could be explained, if the firewall uses stale data from an internal table to perform the RFC 5961 checks.</p><p>Can you browse through your log files to check if (and when) this combination of source IP, source port, destination IP and destination port was used?</p><p>On the other hand: The case can be closed, if disabling RFC 5961 enforcement both fixes the problem and leaves you happy</p><p>Good hunting</p></div><div id="comment-58671-info" class="comment-info"><span class="comment-age">(11 Jan '17, 14:10)</span> <span class="comment-user userinfo">packethunter</span></div></div><span id="58676"></span><div id="comment-58676" class="comment not_top_scorer"><div id="post-58676-score" class="comment-score"></div><div class="comment-text"><p>That's right, they are in my Github, linked above.</p></div><div id="comment-58676-info" class="comment-info"><span class="comment-age">(11 Jan '17, 14:22)</span> <span class="comment-user userinfo">jonwadsworth</span></div></div><span id="58689"></span><div id="comment-58689" class="comment not_top_scorer"><div id="post-58689-score" class="comment-score"></div><div class="comment-text"><p>Hm, from timing in the sonicwall trace it seems the FW generates the ACKs.</p><p>But if I remember right, can't open the traces at the moment, the TTL in every trace and and every packet is 64. That looks unexpected to me, as the traces have been captured at different point and the ip addresses suggest that there should be a routing instance in the path.</p></div><div id="comment-58689-info" class="comment-info"><span class="comment-age">(12 Jan '17, 01:09)</span> <span class="comment-user userinfo">Christian_R</span></div></div><span id="58763"></span><div id="comment-58763" class="comment not_top_scorer"><div id="post-58763-score" class="comment-score"></div><div class="comment-text"><p>In all the tracefiles provided on Github I can only see the RST/ACK loop.</p><p>To verify or to refute my guess regarding the RFC 5961 implementation working with stale data we need a much longer tracefile. Not sure, if you can force this with your toolset:</p><ul><li><p>Each TCP connection has a unique combination of source and destination IP, source and destination port, and SEQ and ACK numbers</p></li><li><p>If I am right the monitoring application generates enough TCP sessions so that the combination of IP addresses and ports is no longer unique</p></li><li><p>It might take days until this situation re-occurs. So, that's a good opportunity to work with large ring buffers.</p></li></ul><p>If the problem disappears by disabling the RFC 5961 check this threat can be closed. Otherwise I suggest a support call to the firewall manufacturer, as it is clear that the firewall is generating the packets.</p><p>Good luck</p></div><div id="comment-58763-info" class="comment-info"><span class="comment-age">(14 Jan '17, 05:18)</span> <span class="comment-user userinfo">packethunter</span></div></div></div><div id="comment-tools-58574" class="comment-tools"><span class="comments-showing"> showing 5 of 9 </span> <a href="#" class="show-all-comments-link">show 4 more comments</a></div><div class="clear"></div><div id="comment-58574-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</hr>

</div>

</div>

