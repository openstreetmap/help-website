+++
type = "question"
title = "Unable dissect TLS handshake messages"
description = '''Hi,  We are using Latest Version of wireshark 2.0.3 with GnuTLS 3.2.15, with Gcrypt 1.6.2 on our windows Machine. Also we have wireshark 1.0.15 on CentOS 4.5. We have issue on Both wireshark version on Both OS. In our case we trying to dissert TLS handshake messages, where we have Netconf messages a...'''
date = "2016-05-26T00:55:00Z"
lastmod = "2016-06-07T06:47:00Z"
weight = 52942
keywords = [ "dissector" ]
aliases = [ "/questions/52942" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Unable dissect TLS handshake messages](/questions/52942/unable-dissect-tls-handshake-messages)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-52942-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-52942-score" class="post-score" title="current number of votes">0</div><span id="post-52942-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi,</p><p>We are using Latest Version of wireshark 2.0.3 with GnuTLS 3.2.15, with Gcrypt 1.6.2 on our windows Machine. Also we have wireshark 1.0.15 on CentOS 4.5. We have issue on Both wireshark version on Both OS.</p><p>In our case we trying to dissert TLS handshake messages, where we have Netconf messages as payload for TLS messages. i.e we are trying to establish Netconf session over TLS. Our protocol encapsulation will be like TCP--TLS--Netconf</p><p>We are trying to see the TLS handshake messages which is used for the Netconf Over TLS session.</p><p>But we are not able dessect TLS Handshake messages in this case.</p><p>Is there any Limitation from wireshark for this case Netconf over TLS &amp; TCP i.e TCP--TLS-- Netconf.</p><p>At the same time, We are able to capture and dissect TLS handshake messages, when we browse https sites.</p><p>Please Help</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-dissector" rel="tag" title="see questions tagged &#39;dissector&#39;">dissector</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>26 May '16, 00:55</strong></p><img src="https://secure.gravatar.com/avatar/df4dab12d9437bfe0ef8981b3526b069?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="dhanish&#39;s gravatar image" /><p><span>dhanish</span><br />
<span class="score" title="6 reputation points">6</span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="3 badges"><span class="silver">●</span><span class="badgecount">3</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="dhanish has no accepted answers">0%</span></p></div></div><div id="comments-container-52942" class="comments-container"><span id="52950"></span><div id="comment-52950" class="comment"><div id="post-52950-score" class="comment-score"></div><div class="comment-text"><p>Can you share a capture in a publicly accessible spot, e.g. <a href="http://cloudshark.org">CloudShark</a>?</p></div><div id="comment-52950-info" class="comment-info"><span class="comment-age">(26 May '16, 02:36)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="52959"></span><div id="comment-52959" class="comment"><div id="post-52959-score" class="comment-score"></div><div class="comment-text"><p>Thanks for the response. Actuall as per another query from wireshark forum i have upgraded my CentOS 5.5 version with wireshark version 1.6.16.</p><p>Now am able to capture the TLS traffic and TLS dissector working working on linux CentOS machine. (Note:packet captured on same machine with loopback interface lo).</p><p>But the same capture(which is captured in linux on lo interface) when i open from my windows 7 desktop machine which has got the latest wireshark version 2.0-3 - No success. Its display only as TCP packets.</p><p>Is it because of windows machine doesnt have loopback lo ? But as said earlier am able to dissect https traffic from my browser from my window machine.</p><p>It have uploaded 2 capture files on to cloudshark with tag "callhome" 1.packet - URL - <a href="https://www.cloudshark.org/captures/c793bfd6c8d1">https://www.cloudshark.org/captures/c793bfd6c8d1</a> 2.callhomeTLSwireshark1.6.16 - URL - <a href="https://www.cloudshark.org/captures/baa5c0384046">https://www.cloudshark.org/captures/baa5c0384046</a></p></div><div id="comment-52959-info" class="comment-info"><span class="comment-age">(26 May '16, 06:02)</span> <span class="comment-user userinfo">dhanish</span></div></div><span id="52960"></span><div id="comment-52960" class="comment"><div id="post-52960-score" class="comment-score"></div><div class="comment-text"><p>We need the "sharing" links to the Cloudshark captures. In the Cloudshark UI, next to each file there is an (i) button, click that then on the resulting dialog click the sharing tab. Edit your question and add the links to the captures there.</p></div><div id="comment-52960-info" class="comment-info"><span class="comment-age">(26 May '16, 06:12)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="52961"></span><div id="comment-52961" class="comment"><div id="post-52961-score" class="comment-score"></div><div class="comment-text"><p>Hi,</p><p>This query is inline with query "Unable to decrypt TLS data from a TLS captured file"</p><p>After upgrading the linux CentOS 4.5 with wireshark , as said TLS dissector works fine. Hence i tried to decrypt the TLS data using wireshark GUI- EDIT-Preference-RSA key - ssl_init IPv4 addr '127.0.0.1' (127.0.0.1) port '39515' filename '/home/amanimar/openssl/device.key</p><p>In the ssl debug file i find more info than before , but still TLS data is not decrypted,</p><p>Debug log uploaded on cloudshark with tag 'callhomessldebuglog' file name "callhomeTlsNew1". - URL - <a href="https://www.cloudshark.org/captures/45435a2b6f7b">https://www.cloudshark.org/captures/45435a2b6f7b</a></p><p>As i mentioned earlier our packet encapsulation is like this, TCP-TLS-Netconf session details.</p><p>Here TLS payload is Netconf protocol, not http - Is that the reason why we are not able decrypt the TLS data ?</p><p>RSA key is of PEM format.</p><p>Thanks Very Much for the Response !!</p></div><div id="comment-52961-info" class="comment-info"><span class="comment-age">(26 May '16, 06:33)</span> <span class="comment-user userinfo">dhanish</span></div></div></div><div id="comment-tools-52942" class="comment-tools"></div><div class="clear"></div><div id="comment-52942-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="52973"></span>

<div id="answer-container-52973" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-52973-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-52973-score" class="post-score" title="current number of votes">0</div><span id="post-52973-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Are you trying to <em>decrypt</em> the TLS or just dissect it?</p><p>Since Wireshark doesn't have a NETCONF dissector if you just want to dissect the TLS messages you can just tell the <strong>HTTP</strong> dissector that one of its TLS ports is 4444. That should show you the Server Hello, etc. (Maybe there's a less hacky way to get this done.)</p><p>In terms of <em>decryption</em> (where I presume you're putting the protocol in the TLS key configuration as <code>data</code>) the log file says:</p><pre><code>   dissect_ssl3_hnd_srv_hello can&#39;t find cipher suite 0x9D
   record: offset = 63, reported_length_remaining = 934</code></pre><p>That means that the Wireshark version that generated that log file does not understand the cipher (<code>TLS_RSA_WITH_AES_256_GCM_SHA384</code>) used in the session. Wireshark 2.0.3 knows that cipher so I'm guessing this was run on RHEL.</p><p>To get the decryption working on RHEL you'll need to change the cipher being sent by the NETCONF server (or upgrade Wireshark's version--which you may not be able to do).</p><p>Decryption should work on Windows--we'd need to see the log file from that to know what's wrong there.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>26 May '16, 14:54</strong></p><img src="https://secure.gravatar.com/avatar/e0564001bb7deb960d5d9d9c1e0ba074?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="JeffMorriss&#39;s gravatar image" /><p><span>JeffMorriss ♦</span><br />
<span class="score" title="6219 reputation points"><span>6.2k</span></span><span title="5 badges"><span class="silver">●</span><span class="badgecount">5</span></span><span title="72 badges"><span class="bronze">●</span><span class="badgecount">72</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="JeffMorriss has 103 accepted answers">27%</span></p></div></div><div id="comments-container-52973" class="comments-container"><span id="52980"></span><div id="comment-52980" class="comment"><div id="post-52980-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jeff !</p><p>Actually traffic is captured at Linux machine Centos 4.5.</p><p>On Linux : After upgrading to 1.6.16 able to dessect TLS handshake message. But unable to decrypt - Understand thats because of Unsupported Cipher used between client and server . Will check with dev to make use of another cipher for client server Transcations.</p><p>On my Windows 7 am trying to open the captured file from Linux,</p><p>Here on Windows:</p><p>Am upgraded to latest version 2.0.3. But here TLS dissect itself getting failed . Hence i hope decryption wont happen. At the same time with 2.0.3 am able dissect TLS traffic from my browser, like any https sites.</p><p>What might be the reason ? I doubt the interface 'lo' on which handshake was captured. But windows doesnt have 'lo' does it make any impact ?</p><p>Thanks Again, Dhanish.</p></div><div id="comment-52980-info" class="comment-info"><span class="comment-age">(26 May '16, 22:47)</span> <span class="comment-user userinfo">dhanish</span></div></div></div><div id="comment-tools-52973" class="comment-tools"></div><div class="clear"></div><div id="comment-52973-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="52984"></span>

<div id="answer-container-52984" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-52984-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-52984-score" class="post-score" title="current number of votes">0</div><span id="post-52984-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>The server in both captures is on port 4444, so use "Decode as ..." to set tcp\4444 to be SSL. The captures then dissect TLS 1.2 quite happily for me using 2.0.2 on Windows.</p><p>To decrypt the data you'll also need to use port 4444 in the RSA Keys list preference setting.</p><p>After you've set that, post the SSL debug log for the capture packet.pcap back here.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>27 May '16, 02:35</strong></p><img src="https://secure.gravatar.com/avatar/d2a7e24ca66604c749c7c88c1da8ff78?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="grahamb&#39;s gravatar image" /><p><span>grahamb ♦</span><br />
<span class="score" title="19834 reputation points"><span>19.8k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="30 badges"><span class="silver">●</span><span class="badgecount">30</span></span><span title="206 badges"><span class="bronze">●</span><span class="badgecount">206</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="grahamb has 274 accepted answers">22%</span></p></div></div><div id="comments-container-52984" class="comments-container"><span id="52988"></span><div id="comment-52988" class="comment"><div id="post-52988-score" class="comment-score"></div><div class="comment-text"><p>I tried to decrypt with port 4444 but still not working.</p><p>but i feel in our case 39515 is TLS server port. Below is our scenario,</p><p>CALLHome/TLS Client(4444) CALLHome/TLS server(39515) TCP is intiated &lt;------------------------------------------syn ------------------------------------------------------&gt;syn + ACK &lt;--------------------------------------------------------- Ack On Established TCP connection client will initiate TLS connction with port 39515 ----------------------------------------------------------&gt;client Hello</p><p>Dump i am unable to upload to cloudshark - getthing this error "Couldn't read capinfo from this file. Please make sure it is a file Wireshark can read." Not sure Why ?</p><p>Thanks Again, Dhanish.</p></div><div id="comment-52988-info" class="comment-info"><span class="comment-age">(27 May '16, 05:33)</span> <span class="comment-user userinfo">dhanish</span></div></div><span id="52991"></span><div id="comment-52991" class="comment"><div id="post-52991-score" class="comment-score"></div><div class="comment-text"><p>Nope, in that capture port 4444 is definitely the server, look at the directions of the packets only carrying a SYN, they are from ephemeral ports to 4444.</p><p>Just try it and you'll see TLS dissection. Correct your RSA key setting and you should see decryption as well.</p><p>Note also the info on the <a href="https://wiki.wireshark.org/SSL#Key_File_format_conversion">SSL</a> Wiki page about PEM files and the private key.</p></div><div id="comment-52991-info" class="comment-info"><span class="comment-age">(27 May '16, 05:52)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="52993"></span><div id="comment-52993" class="comment"><div id="post-52993-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Dump i am unable to upload to cloudshark - getthing this error "Couldn't read capinfo from this file. Please make sure it is a file Wireshark can read." Not sure Why ?</p></blockquote><p>Because Cloudshark accepts only files which contain packet captures, i.e. files which Wireshark itself can open. The ssl debug file you are trying to upload there is a plain text file so Cloudshark rejects it. So please publish it at some file sharing service (Google drive, Dropbox, ...), login-free, and provide a link to it here.</p></div><div id="comment-52993-info" class="comment-info"><span class="comment-age">(27 May '16, 06:01)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="52994"></span><div id="comment-52994" class="comment"><div id="post-52994-score" class="comment-score"></div><div class="comment-text"><p>re the debug log, or add it to your question by editing the question and pasting the debug log contents.</p></div><div id="comment-52994-info" class="comment-info"><span class="comment-age">(27 May '16, 06:05)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div><span id="53275"></span><div id="comment-53275" class="comment"><div id="post-53275-score" class="comment-score"></div><div class="comment-text"><p>Hi all,</p><p>I am continuing with the query which Dhanish have raised. Working for the same team. We are having a packet captured with protocol encapsulation TCP--TLS--Netconf. we are trying to decrypt the packet, but not able to decrypt it. Using the wireshark Version "Version 2.0.3 (v2.0.3-0-geed34f0 from master-2.0)" For decrypting, what we did is: a) Under Edit--&gt; preference --&gt;Selected Protocol 'SSL' --&gt; RSA Key List --&gt; EDIT --&gt; IP Address - 127.0.0.1 Port - 4444 Protocol - http Key File - Path for Server.key. But not able to decrypt the packet.</p><p>I am sharing the packet capture --&gt; <a href="https://drive.google.com/file/d/0B6pHYzndrgxScjd1VWNNMTR5NGM/view?usp=sharing">here</a>.</p><p>And also sharing the Key which we are using for Encryption, Sever.key --&gt; <a href="https://drive.google.com/open?id=0B6pHYzndrgxSQjItQzY5dFN3LXM">here</a>.</p><p>Please help me with Decryption.</p><p>Thanks, Nancy.</p></div><div id="comment-53275-info" class="comment-info"><span class="comment-age">(07 Jun '16, 05:49)</span> <span class="comment-user userinfo">Nancy</span></div></div><span id="53278"></span><div id="comment-53278" class="comment not_top_scorer"><div id="post-53278-score" class="comment-score"></div><div class="comment-text"><p>For whoever understands it better than me but may not look for obvious things, the roles of client and server are swapped between TCP and TLS. The TCP session is initiated from client port 39975 to server port 4444, but the Client Hello packet is sent from server port 4444 to client port 39975 and Server Hello comes from the TCP client. But even defining 39975 as SSL port and relating the RSA key to it doesn't help Wireshark decipher the Application Data.</p></div><div id="comment-53278-info" class="comment-info"><span class="comment-age">(07 Jun '16, 06:33)</span> <span class="comment-user userinfo">sindy</span></div></div><span id="53280"></span><div id="comment-53280" class="comment not_top_scorer"><div id="post-53280-score" class="comment-score"></div><div class="comment-text"><p>Odd behaviour indeed, but looking at the SSL debug log I don't think the key is the correct one for the server certificate:</p><pre><code>KeyID[20]:
| 3b cd c0 07 7b a3 7d a1 f6 7b 24 b6 aa 38 14 61 |;...{.}..{$..8.a|
| 68 94 e4 06                                     |h...            |
ssl_load_key: swapping p and q parameters and recomputing u
ssl_init private key file C:/Users/graham.bloice/Downloads/server.key successfully loaded.
ssl_init port &#39;39975&#39; filename &#39;C:/Users/xxx/Downloads/server.key&#39; password(only for p12 file) &#39;&#39;
association_add ssl.port port 39975 handle 04ABAAD8</code></pre><p>...</p><pre><code>dissect_ssl enter frame #6 (first time)
packet_from_server: is from server - TRUE
  conversation = 068ADE78, ssl_session = 068AE4D8
  record: offset = 0, reported_length_remaining = 997
ssl_try_set_version found version 0x0303 -&gt; state 0x11
dissect_ssl3_record: content_type 22 Handshake
Calculating hash with offset 5 58
decrypt_ssl3_record: app_data len 58, ssl state 0x11
packet_from_server: is from server - TRUE
decrypt_ssl3_record: using server decoder
decrypt_ssl3_record: no decoder available
dissect_ssl3_handshake iteration 1 type 2 offset 5 length 54 bytes, remaining 63 
ssl_try_set_version found version 0x0303 -&gt; state 0x11
ssl_dissect_hnd_hello_common found SERVER RANDOM -&gt; state 0x13
ssl_dissect_hnd_srv_hello found CIPHER 0x009D TLS_RSA_WITH_AES_256_GCM_SHA384 -&gt; state 0x17
  record: offset = 63, reported_length_remaining = 934
dissect_ssl3_record: content_type 22 Handshake
Calculating hash with offset 68 878
decrypt_ssl3_record: app_data len 878, ssl state 0x17
packet_from_server: is from server - TRUE
decrypt_ssl3_record: using server decoder
decrypt_ssl3_record: no decoder available
dissect_ssl3_handshake iteration 1 type 11 offset 68 length 874 bytes, remaining 946 
lookup(KeyID)[20]:
| 4b 0b 80 88 a1 54 bc ee 75 94 cd 1e f1 4e 95 84 |K....T..u....N..|
| bd a0 4b 9c                                     |..K.            |
ssl_find_private_key_by_pubkey: lookup result: 00000000</code></pre></div><div id="comment-53280-info" class="comment-info"><span class="comment-age">(07 Jun '16, 06:47)</span> <span class="comment-user userinfo">grahamb ♦</span></div></div></div><div id="comment-tools-52984" class="comment-tools"><span class="comments-showing"> showing 5 of 7 </span> <a href="#" class="show-all-comments-link">show 2 more comments</a></div><div class="clear"></div><div id="comment-52984-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

