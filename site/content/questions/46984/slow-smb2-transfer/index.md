+++
type = "question"
title = "slow SMB2 transfer"
description = '''HI, I &#x27;am analysing very poor performances between a windows 7 pc and an Hitachi NAS  Protocol used is SMB2. A sniffer trace has been made on the PC. Minimum bandwith between the two ends is 100 Mb/s : -protocol=SMB2 -pc says MSS=1460, HNAS says MSS=1460 -pc says windows scaling factor 8 , HNAS says...'''
date = "2015-10-27T06:15:00Z"
lastmod = "2015-10-27T06:15:00Z"
weight = 46984
keywords = [ "smb2" ]
aliases = [ "/questions/46984" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [slow SMB2 transfer](/questions/46984/slow-smb2-transfer)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-46984-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>HI, I 'am analysing very poor performances between a windows 7 pc and an Hitachi NAS Protocol used is SMB2. A sniffer trace has been made on the PC. Minimum bandwith between the two ends is 100 Mb/s :</p><p>-protocol=SMB2</p><p>-pc says MSS=1460, HNAS says MSS=1460</p><p>-pc says windows scaling factor 8 , HNAS says windows scaling factor 3</p><p>-RTT between the two ends =14ms</p><p>-No retansmission, no segment lost , no dup ack</p><p>-Troughput of transfer is about 1,2 Mb/s</p><p>The PC receive about 123 MB of applicative bytes(about 230 files) from the NAS and this takes about 970 s . (when the PC gets the same among of data (and same number of files) from a another remote site with an higher RTT of 23 ms , it takes only 600 s ..)<br />
</p><p>The PC always advertises a 64KB window (64 KB plateau curve). Bytes in flight (send by the NAS) show only a 2 KB plateau curve (since the PC requests only PDU of 2048 Bytes, I presume the server cannot sends more without an acknowledge, this may explain the seen value of bytes in flight)</p><p>My explanation for this slow transfer is :</p><p>The PC uses very often SMB2 READ REQUEST of 2048 Bytes instead of higher length (seen with wireshark io graph using "smb2.read_length" filter) This behavior generates too many applications turns and the latency makes the rest ...<br />
</p><p>Well, at those steps of my investigations my questions are :</p><p>How the heck does not the PC send SMB2 READ REQUESTs with a requested "read length" greater than 2048 ? Why is the PC advertised received windows at only 64KB (according it has a windows scaling factor of 8, it could increase at 16MB maximum..)</p><p>Any advice would be appreciated , regards jm</p></div><div id="question-tags" class="tags-container tags">smb2</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>27 Oct '15, 06:15</strong></p><img src="https://secure.gravatar.com/avatar/bf3b6fb4e16ad7abad1e9c2af6ff83d9?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="jmnogues&#39;s gravatar image" /><p>jmnogues<br />
<span class="score" title="10 reputation points">10</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="jmnogues has no accepted answers">0%</span> </br></br></p></div></div><div id="comments-container-46984" class="comments-container"><span id="46987"></span><div id="comment-46987" class="comment"><div id="post-46987-score" class="comment-score"></div><div class="comment-text"><p>Wireshark will tell you what is in the frames and you've found that yourself. <strong>However</strong> it won't be able to tell you <strong>why</strong> a system behaves in a certain way.</p><blockquote><p>Why is the PC advertised received windows at only 64KB (according it has a windows scaling factor of 8, it could increase at 16MB maximum..)</p></blockquote><p>sounds like a good question for the Microsoft support people.</p><p>BTW: Did you search this site for SMB? I believe we had similar cases, but I can't remember if there was a solution.</p><blockquote><p><a href="https://www.google.com/?q=site:ask.wireshark.org+smb+performance">https://www.google.com/?q=site:ask.wireshark.org+smb+performance</a></p></blockquote></div><div id="comment-46987-info" class="comment-info"><span class="comment-age">(27 Oct '15, 06:51)</span> Kurt Knochner ♦</div></div><span id="47006"></span><div id="comment-47006" class="comment"><div id="post-47006-score" class="comment-score"></div><div class="comment-text"><p>SMB2 has a 64k limit, can't remember the math. There is a registry setting.. don't quote me but I think it was DisableLargeMtu=0 in HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Tcpip\Parameters</p><p>Edit: it has to be enabled on both ends for it to work when both are windows boxes</p></div><div id="comment-47006-info" class="comment-info"><span class="comment-age">(28 Oct '15, 00:47)</span> DarrenWright</div></div><span id="47013"></span><div id="comment-47013" class="comment"><div id="post-47013-score" class="comment-score"></div><div class="comment-text"><p>"SMB2 has a 64k limit, can't remember the math"</p><p>In the "SMB2 NEGOTIATE Response" of the server we see "MaxReadSize (4 bytes): The maximum size, in bytes, of the Length in an SMB2 READ Request that the server will accept. (<a href="https://msdn.microsoft.com/en-us/library/cc246561.aspx)">https://msdn.microsoft.com/en-us/library/cc246561.aspx)</a></p><p>In my case the server is effectively giving this value 65536 which seems to be the default for SMB2.</p><p>So this would let think that when receiving a 64K Maxreadsize from the server, the client will unconditionaly sets its windows size to 64K.. why not , seems rather logical ..;-)</p><p>Anyway this is not the main issue and I would even be very happy if the 64K Windows was really used on the wire (i.e.if bytes in flight were 64K and not only 2K ..;-)<br />
But as mentionned above , the client requests only 2048 bytes blocks despite the server can accept 65536 bytes blocks .. ;-(.</p><p>jm</p></div><div id="comment-47013-info" class="comment-info"><span class="comment-age">(28 Oct '15, 06:12)</span> jmnogues</div></div></div><div id="comment-tools-46984" class="comment-tools"></div><div class="clear"></div><div id="comment-46984-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

</div>

