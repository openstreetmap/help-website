+++
type = "question"
title = "tshark memory usage - explanation needed"
description = '''In the following question, @hoangsonk49 claims that he is running tshark continuously for 6 months without getting any memory usage problems, as predicted by the Wiki. Question:    http://ask.wireshark.org/questions/25091/wireshark-tshark-out-of-memory-problem  Last comment/answer of @hoangsonk49:  ...'''
date = "2014-06-22T08:25:00Z"
lastmod = "2015-04-15T06:17:00Z"
weight = 34035
keywords = [ "out-of-memory", "tshark", "memory" ]
aliases = [ "/questions/34035" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [tshark memory usage - explanation needed](/questions/34035/tshark-memory-usage-explanation-needed)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-34035-score" class="post-score" title="current number of votes">1</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>In the following question, @hoangsonk49 claims that he is running tshark <strong>continuously</strong> for 6 months without getting any memory usage problems, <a href="http://wiki.wireshark.org/KnownBugs/OutOfMemory">as predicted by the Wiki</a>.</p><p>Question:<br />
</p><blockquote><p><a href="http://ask.wireshark.org/questions/25091/wireshark-tshark-out-of-memory-problem">http://ask.wireshark.org/questions/25091/wireshark-tshark-out-of-memory-problem</a></p></blockquote><p>Last comment/answer of @hoangsonk49:<br />
</p><blockquote><p><a href="http://ask.wireshark.org/questions/25091/wireshark-tshark-out-of-memory-problem/33952">http://ask.wireshark.org/questions/25091/wireshark-tshark-out-of-memory-problem/33952</a></p></blockquote><p>Presumably he is using the following command:</p><blockquote><p>nohup tshark -i 5 -P -w /tmp/Log.pcap -b filesize:655350|split -b 655350000 -a 10 - /tmp/log/call_log- &amp;</p></blockquote><p>My understanding of the dissection engine is the following:</p><p>Running tshark on a link without any filter (I'm waiting for a comment of @hoangsonk49 on that issue), he <strong>should</strong> run into a memory problem sooner or later, as almost every dissector creates <strong>at least</strong> an entry in the conversation hash tables. Some dissectors also add additional data to a conversation (e.g. HTTP).</p><pre><code>get_http_conversation_data(packet_info *pinfo)
{
    conversation_t  *conversation;
    http_conv_t *conv_data;

    conversation = find_or_create_conversation(pinfo);

    /* Retrieve information from conversation
     * or add it if it isn&#39;t there yet
     */
    conv_data = (http_conv_t *)conversation_get_proto_data(conversation, proto_http);
    if(!conv_data) {
        /* Setup the conversation structure itself */
        conv_data = (http_conv_t *)wmem_alloc0(wmem_file_scope(), sizeof(http_conv_t));
        conversation_add_proto_data(conversation, proto_http, conv_data);
    }
    return conv_data;
}</code></pre><p>So, the hash table will keep growing as long as tshark is running. Furthermore, there should be other data structures as well in certain dissectors, which would increase the memory usage even more.</p><p>At least that's my understanding of the dissection engine.</p><p>So, if he <strong>does not see any increase in memory usage</strong> after running tshark for 6 months (just my interpretation of his comments), my understanding of the dissection engine might be wrong.</p><p>Any idea why tshark does not crash with an out of memory error after running it <strong>continuously</strong> for 6 months?</p><p>Is there anything in tshark that clears 'old data structures' if it is running in the way described above? I was not able to find such a thing in the code!?!</p><p>Thanks!<br />
Kurt</p></div><div id="question-tags" class="tags-container tags">out-of-memory tshark memory</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>22 Jun '14, 08:25</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p>edited 22 Jun '14, 08:47</p></div></div><div id="comments-container-34035" class="comments-container"></div><div id="comment-tools-34035" class="comment-tools"></div><div class="clear"></div><div id="comment-34035-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="34037"></span>

<div id="answer-container-34037" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-34037-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>Either he's modified the source code directly (in a non-trivial way) or he's seeing <em>very</em> little traffic.</p><p>Or, potentially, he's running it via a system like upstart or systemd which automatically restarts crashed processes, in which case it does restart every couple of days he's just never noticed.</p><p>Tangentially: I had a hack at one point of just a couple of lines which would wipe out all state after each packet, letting tshark run in "stateless" mode but I've lost it and I don't know if it ever worked all that well in the first place.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>22 Jun '14, 09:18</strong></p><img src="https://secure.gravatar.com/avatar/74a01200b8e1bc8b9b57ddd5633288bc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="eapache&#39;s gravatar image" /><p>eapache<br />
<span class="score" title="41 reputation points">41</span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="eapache has no accepted answers">0%</span> </br></p></div></div><div id="comments-container-34037" class="comments-container"><span id="34042"></span><div id="comment-34042" class="comment"><div id="post-34042-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Or, potentially, he's running it via a system like upstart or systemd which automatically restarts crashed processes</p></blockquote><p>hm.. that's actually a possible explanation, and that's why I asked him to confirm that it's the same process (same PID) running for 6 months. I'm waiting for an answer.</p></div><div id="comment-34042-info" class="comment-info"><span class="comment-age">(22 Jun '14, 10:43)</span> Kurt Knochner ♦</div></div><span id="34046"></span><div id="comment-34046" class="comment"><div id="post-34046-score" class="comment-score"></div><div class="comment-text"><p>I dug up my hack code and cleaned it up a bit and submitted it as a Work-In-Progress for code review: <a href="https://code.wireshark.org/review/2559/">https://code.wireshark.org/review/2559/</a></p></div><div id="comment-34046-info" class="comment-info"><span class="comment-age">(22 Jun '14, 14:02)</span> eapache</div></div></div><div id="comment-tools-34037" class="comment-tools"></div><div class="clear"></div><div id="comment-34037-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="34039"></span>

<div id="answer-container-34039" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-34039-score" class="post-score" title="current number of votes">2</div></div></td><td><div class="item-right"><div class="answer-body"><p>Maybe the traffic he's capturing doesn't have the usual memory creation issues. He said in his post he was looking at CAMEL protocol, which I guess means he's capturing M3UA/SCTP (right?)... and a quick peek at SCTP's dissector code doesn't show it creating conversations like UDP and TCP does. So if all he's capturing is traffic between two SS7 systems or something similar, maybe he just doesn't have the type of packet traffic that would have the issues.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>22 Jun '14, 10:23</strong></p><img src="https://secure.gravatar.com/avatar/d02f20c18a7742ec73a666f1974bf6dc?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Hadriel&#39;s gravatar image" /><p>Hadriel<br />
<span class="score" title="2652 reputation points"><span>2.7k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="9 badges"><span class="silver">●</span><span class="badgecount">9</span></span><span title="39 badges"><span class="bronze">●</span><span class="badgecount">39</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Hadriel has 30 accepted answers">18%</span></p></div></div><div id="comments-container-34039" class="comments-container"><span id="34041"></span><div id="comment-34041" class="comment"><div id="post-34041-score" class="comment-score"></div><div class="comment-text"><blockquote><p>So if all he's capturing is traffic between two SS7 systems or something similar, maybe he just doesn't have the type of packet traffic that would have the issues.</p></blockquote><p>that's what I thought as well, so I asked him if he pre-filtered the traffic, as that would explain it partly. I'm waiting for an answer.</p></div><div id="comment-34041-info" class="comment-info"><span class="comment-age">(22 Jun '14, 10:42)</span> Kurt Knochner ♦</div></div><span id="34055"></span><div id="comment-34055" class="comment"><div id="post-34055-score" class="comment-score"></div><div class="comment-text"><p>Hi all, here are my answers for Kurt 's questions:</p><blockquote><pre><code>do you see an increased memory usage of the tshark process?</code></pre></blockquote><p>At the beginning, I saw an increased memory used of tshark. It reached 10% of 8 GB RAM in one hour and from that moment it works around 15% and I don't see any other increment.</p><blockquote><pre><code>can you ensure, that its the same tshark process running for 6 months (same PID)?</code></pre></blockquote><p>YES, I'm pretty sure because it is the core process of our service. Our engineers check process and log files 3 times everyday, otherwise, if there 's any crash during running,the warning system should send an SMS to all of us automatically. It has the same PID and not able to re-start by itself (the source code was changed to process message but it is still running in the same way with the normal tshark).</p><blockquote><pre><code>do you pre-filter the traffic on eth0 (switch port/TAP filtering)?</code></pre></blockquote><p>NO. In my program, I do run some filters but that happens after decoding messages. I ignore the messages which have decoded values of some parameters do not match our objective.</p><p>And here are my answers for some comments above:</p><blockquote><p>or he's seeing very little traffic</p></blockquote><p>As you can see my tshark command, the size of each log file is limited by ~650 Mb. This size is reached in about 12 minutes. Also,this is 1/3 traffic of the telco which has about 35 million subscribers, and tshark has to capture a hundred of calls every second. So I think, it is not quite little traffic:-)</p><blockquote><pre><code>So if all he&#39;s capturing is traffic between two SS7 systems or something similar, maybe he just</code></pre><p>doesn't have the type of packet traffic that would have the issues.</p></blockquote><p>YES, You are right. I run tshark on IN network which has ONLY CAMEL, SCTP message... No other type of packet. Maybe this is the answer for my case :-)</p></div><div id="comment-34055-info" class="comment-info"><span class="comment-age">(23 Jun '14, 00:12)</span> hoangsonk49</div></div><span id="34061"></span><div id="comment-34061" class="comment"><div id="post-34061-score" class="comment-score"></div><div class="comment-text"><blockquote><p>YES, You are right. I run tshark on IN network <strong>which has ONLY CAMEL, SCTP message</strong>...</p></blockquote><p>Maybe that explains it, as @Hadriel said: The SCTP dissector does not create a conversation table entry, however it adds other data structures on its own. Hm...</p><p>BTW: Are there many different IP addresses or just a few IP addresses?</p></div><div id="comment-34061-info" class="comment-info"><span class="comment-age">(23 Jun '14, 03:06)</span> Kurt Knochner ♦</div></div><span id="34101"></span><div id="comment-34101" class="comment"><div id="post-34101-score" class="comment-score"></div><div class="comment-text"><blockquote><p>BTW: Are there many different IP addresses or just a few IP addresses?</p></blockquote><p>I see many different IP addresses (at least, more than 15 addresses). Some information: When a *.pcap is created, we dissect this file in real-time and when a file is completely decoded and switch to other file, we are able to delete this file without any warning or error. So i think when a pcap was decoded, there is no connection between this file and other data, otherwise, it should not be able to be deleted.</p></div><div id="comment-34101-info" class="comment-info"><span class="comment-age">(23 Jun '14, 18:53)</span> hoangsonk49</div></div><span id="35247"></span><div id="comment-35247" class="comment"><div id="post-35247-score" class="comment-score"></div><div class="comment-text"><p>Hi Kurt, we are going to deploy a service which also captures and analyzes the message in IN network. It is similar to the previous service but in this case, the IN network contains only UDP (not CAMEL like the previous telco). According to my understanding, it definitely faces the problem of the memory because of the hashtable in <strong><code>get_udp_conversation_data</code></strong>. So, I have some questions that is not clear to me:</p><ul><li>I imagine the wireshark code structure like that :</li></ul><hr /><pre><code>    1.Get the message</code></pre><hr /><pre><code>    2.Classify the protocol</code></pre><hr /><pre><code>    3.Analyze the data of the message by using the dissector of the protocol</code></pre><hr /><pre><code>    4.End</code></pre><hr /><pre><code>My question is: Where is get_udp_conversation_data in this picture ? AND what does it use for?</code></pre><ul><li><p>Our processing is in the step 3, when we are able to have the useful data, we can stop the analysis and remove the pcap file. No need to store it anymore. So, is it possible to clear the hashtable after our processing OR remove the Setup the conversation from the code?</p></li><li><p>If we do in this way, is there anything affected?</p></li></ul><p>Thanks!</p></div><div id="comment-35247-info" class="comment-info"><span class="comment-age">(05 Aug '14, 23:46)</span> hoangsonk49</div></div><span id="35251"></span><div id="comment-35251" class="comment not_top_scorer"><div id="post-35251-score" class="comment-score"></div><div class="comment-text"><blockquote><p>My question is: Where is get_udp_conversation_data in this picture ? AND what does it use for?</p></blockquote><p>that depends on the dissector that gets called on the UDP frame, so what if the protocol on top of UDP?</p></div><div id="comment-35251-info" class="comment-info"><span class="comment-age">(06 Aug '14, 01:32)</span> Kurt Knochner ♦</div></div><span id="35261"></span><div id="comment-35261" class="comment not_top_scorer"><div id="post-35261-score" class="comment-score"></div><div class="comment-text"><blockquote><p>that depends on the dissector that gets called on the UDP frame, so what if the protocol on top of UDP?</p></blockquote><p>It is <strong>data.data</strong>. In this case, I'm afraid that changing the code of <code>get_udp_conversation_data</code> might affect the data that I want to analyze. So, It means I cannot clear the hash table or remove the Setup of conversation. If the conversation is set up after I get the analysis of data.data, there 's a hope to skip the conversation in order to have a workaround of the memory problem but now, it looks impossible. That 's a bad new.</p><p><img src="https://osqa-ask.wireshark.org/upfiles/Untitled_8.png" alt="alt text" /></p></div><div id="comment-35261-info" class="comment-info"><span class="comment-age">(06 Aug '14, 04:01)</span> hoangsonk49</div></div><span id="35264"></span><div id="comment-35264" class="comment not_top_scorer"><div id="post-35264-score" class="comment-score"></div><div class="comment-text"><p>Is that one long lasting conversation or many short conversations?</p></div><div id="comment-35264-info" class="comment-info"><span class="comment-age">(06 Aug '14, 06:01)</span> Kurt Knochner ♦</div></div><span id="35266"></span><div id="comment-35266" class="comment not_top_scorer"><div id="post-35266-score" class="comment-score"></div><div class="comment-text"><p>that is one long lasting conversation. This is the data to be encoded.</p></div><div id="comment-35266-info" class="comment-info"><span class="comment-age">(06 Aug '14, 07:55)</span> hoangsonk49</div></div><span id="35267"></span><div id="comment-35267" class="comment not_top_scorer"><div id="post-35267-score" class="comment-score"></div><div class="comment-text"><blockquote><p>that is one long lasting conversation.</p></blockquote><p>Then there will be only one entry in the hash table, or just a few if tshark runs for several days/weeks/months. That should be no problem at all.</p></div><div id="comment-35267-info" class="comment-info"><span class="comment-age">(06 Aug '14, 08:15)</span> Kurt Knochner ♦</div></div><span id="35269"></span><div id="comment-35269" class="comment not_top_scorer"><div id="post-35269-score" class="comment-score"></div><div class="comment-text"><p>maybe I have a misunderstanding. This is one of a thousand messages. Each message has one conversation like that. So at anytime, we capture many data.data to analyze. My question is: can I clear the hashtable or just remove the set up of conversation from the source code ?</p></div><div id="comment-35269-info" class="comment-info"><span class="comment-age">(06 Aug '14, 08:41)</span> hoangsonk49</div></div><span id="35274"></span><div id="comment-35274" class="comment not_top_scorer"><div id="post-35274-score" class="comment-score"></div><div class="comment-text"><blockquote><p>can I clear the hashtable or just remove the set up of conversation from the source code ?</p></blockquote><p>well, yes you 'can', but I don't know if there would be any side effects, as I have not yet checked the code, and I'm not sure if I will find the time during the next couple of days.</p></div><div id="comment-35274-info" class="comment-info"><span class="comment-age">(06 Aug '14, 11:51)</span> Kurt Knochner ♦</div></div><span id="35276"></span><div id="comment-35276" class="comment not_top_scorer"><div id="post-35276-score" class="comment-score"></div><div class="comment-text"><p>You might be interested by <a href="https://blog.wireshark.org/2014/07/to-infinity-and-beyond-capturing-forever-with-tshark/">https://blog.wireshark.org/2014/07/to-infinity-and-beyond-capturing-forever-with-tshark/</a></p></div><div id="comment-35276-info" class="comment-info"><span class="comment-age">(06 Aug '14, 13:18)</span> Pascal Quantin</div></div></div><div id="comment-tools-34039" class="comment-tools"><span class="comments-showing"> showing 5 of 13 </span> <a href="#" class="show-all-comments-link">show 8 more comments</a></div><div class="clear"></div><div id="comment-34039-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="41454"></span>

<div id="answer-container-41454" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-41454-score" class="post-score" title="current number of votes">1</div></div></td><td><div class="item-right"><div class="answer-body"><p>I've used Tshark numerous times, but never for a period of 6 months.</p><p>But I have used the following on a WinTel machine for anywhere from 10 ~ 20 days without any errors.</p><p>tshark -i 3 -w MyCapture.pcap -s 80 -b filesize:1000000</p><p>I dump all my files in 1GB size. Then used Editcap to weed out only the portions I want (usually within 5 ~ 30 minutes prior to and/or after the problem to reduce the 1GB file to a more usable size.</p><p>I've had 192GB of data over 7 days and 233GB of data over 20 days, but never experienced any such error.</p><p>Cheers,</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>15 Apr '15, 06:17</strong></p><img src="https://secure.gravatar.com/avatar/08ceaa93ec93bcecf429815ccc39e803?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Walter%20Benton&#39;s gravatar image" /><p>Walter Benton<br />
<span class="score" title="16 reputation points">16</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Walter Benton has no accepted answers">0%</span></p></img></div></div><div id="comments-container-41454" class="comments-container"><span id="41456"></span><div id="comment-41456" class="comment"><div id="post-41456-score" class="comment-score"></div><div class="comment-text"><p>Your snaplength of 80 (<code>-s 80</code>) limits the protocol layers in the capture.</p><p>It's possible that they may not be able to add state to the hash tables or other data they maintain.</p></div><div id="comment-41456-info" class="comment-info"><span class="comment-age">(15 Apr '15, 06:50)</span> grahamb ♦</div></div></div><div id="comment-tools-41454" class="comment-tools"></div><div class="clear"></div><div id="comment-41454-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

