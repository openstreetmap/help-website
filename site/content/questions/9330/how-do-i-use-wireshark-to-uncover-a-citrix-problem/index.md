+++
type = "question"
title = "How do I use Wireshark to uncover a Citrix problem?"
description = '''We have this small application that goes out to a web server and it pulls down a report (about 57K on average) which works fine on a standalone workstation. The whole process is a couple of seconds long. Put that application on a Citrix server and you&#x27;re waiting just over 2 minutes. And you don&#x27;t ev...'''
date = "2012-03-03T08:59:00Z"
lastmod = "2012-03-03T11:47:00Z"
weight = 9330
keywords = [ "reassembled", "retransmissions", "citrix" ]
aliases = [ "/questions/9330" ]
osqa_answers = 0
osqa_accepted = false
+++

<div class="headNormal">

# [How do I use Wireshark to uncover a Citrix problem?](/questions/9330/how-do-i-use-wireshark-to-uncover-a-citrix-problem)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-9330-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>We have this small application that goes out to a web server and it pulls down a report (about 57K on average) which works fine on a standalone workstation. The whole process is a couple of seconds long.</p><p>Put that application on a Citrix server and you're waiting just over 2 minutes. And you don't even need to do it through citrix. I can RDP to the citrix server and reliably reproduce the issue over and over from the console.</p><p>In the app you click Print to bring down the PDF and opens it in Adobe, Foxit, doesn't matter the result is the same. Running Wireshark on the citrix server (which is a Win2003 virtual server running on Hyper V) I can see where and why it hangs, I'm just at a standstill....Can someone help?</p><p>Here's the relevant info(I think) filtered for just HTTP:</p><pre><code>785 114.761196  192.168.1.5 96.44.1.1   HTTP/XML    1103    POST /SmartServerNet/WebService.asmx HTTP/1.1 
786 115.939767  192.168.1.5 96.44.1.1   TCP 1103    [TCP Retransmission] [TCP segment of a reassembled PDU]
787 118.232875  192.168.1.5 96.44.1.1   TCP 1103    [TCP Retransmission] [TCP segment of a reassembled PDU]
788 122.725705  192.168.1.5 96.44.1.1   TCP 1103    [TCP Retransmission] [TCP segment of a reassembled PDU]
789 131.461834  192.168.1.5 96.44.1.1   TCP 1103    [TCP Retransmission] [TCP segment of a reassembled PDU]
790 149.074068  192.168.1.5 96.44.1.1   TCP 1103    [TCP Retransmission] [TCP segment of a reassembled PDU]
791 169.137619  96.44.1.1   192.168.1.5 TCP 60  http &gt; 4962 [RST, ACK] Seq=24048 Ack=4084 Win=0 Len=0
792 184.428380  192.168.1.5 96.44.1.1   TCP 62  4993 &gt; http [SYN] Seq=0 Win=64512 Len=0 MSS=1460 SACK_PERM=1</code></pre><p>Then boom, pdf opens and all is right. I'm new at this so please bear with me....</p><p>THANK YOU!</p></div><div id="question-tags" class="tags-container tags">reassembled retransmissions citrix</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>03 Mar '12, 08:59</strong></p><img src="https://secure.gravatar.com/avatar/29c58be3d3185018b724cf9f0aebf8bf?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Willmeister&#39;s gravatar image" /><p>Willmeister<br />
<span class="score" title="6 reputation points">6</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Willmeister has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 03 Mar '12, 09:06</p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span></p></div></div><div id="comments-container-9330" class="comments-container"><span id="9646"></span><div id="comment-9646" class="comment"><div id="post-9646-score" class="comment-score"></div><div class="comment-text"><p>The Proxy was the problem. And I was never going to find that until the vendor put Wireshark on their side in a test environment, had me connect directly to that server and we captured it all from both sides. We were posting an XML page and apparently not receiving ACKs back, but they were in fact ACKing. Over and over again. Enabled verbose logging in the proxy and saw exactly why those were dropping. Turned out adding an exception for their web servers was no sufficient, I had to disable filtering completely and everything worked. Thank you so much for all the help!!!!!</p></div><div id="comment-9646-info" class="comment-info"><span class="comment-age">(20 Mar '12, 10:04)</span> Willmeister</div></div></div><div id="comment-tools-9330" class="comment-tools"></div><div class="clear"></div><div id="comment-9330-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="9332"></span>

<div id="answer-container-9332" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-9332-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>I doubt it has anything to do with the server being a Citrix server. Unfortunately, your trace isn't telling much in terms of timings and TCP sequence/ack behaviour, so it is kinda hard to tell what happens and where the time goes.</p><p>I guess it is caused by something that is different for the server machine than on a workstation - a firewall, a Intrusion Prevention System, other IP subnet ACLs somewhere, DNS name resolution failures, that kind of thing. If you could create and provide a trace file it might be easier to tell, but I'm not sure if you can do that without disclosing company internals (or sensitive information in general). If you can, you might want to upload it to <a href="http://cloudshark.org/">CloudShark</a> and post the URL so I/we can take a look.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>03 Mar '12, 11:47</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-9332" class="comments-container"><span id="9565"></span><div id="comment-9565" class="comment"><div id="post-9565-score" class="comment-score"></div><div class="comment-text"><p>I don't know what else to do as this still isn't working, so here it is <a href="http://cloudshark.org/captures/29ddf69aafee">http://cloudshark.org/captures/29ddf69aafee</a></p><p>I know the answer is in there, I just can't find it. Anything is much appreciated....</p></div><div id="comment-9565-info" class="comment-info"><span class="comment-age">(15 Mar '12, 16:32)</span> Willmeister</div></div><span id="9566"></span><div id="comment-9566" class="comment"><div id="post-9566-score" class="comment-score"></div><div class="comment-text"><p>As far as I can tell it looks like your server with the IP 96.44.176.10 has a problem. If you filter your trace on "tcp.stream==0" you can see that packet 13 coming from the client is not ACKed by the server anymore, and is retransmitted a couple of times in packet 15 thru 26 after waiting longer and longer. In 27 the client gives up and sends a reset packet. Right after that in 29 the server finally answers and ACKs packet 13, but its too late. My guess is that there was a big holdup on the path to the server, which is why its answer (in 29) arrives very very late. Or it was just very busy.</p></div><div id="comment-9566-info" class="comment-info"><span class="comment-age">(15 Mar '12, 17:00)</span> Jasper ♦♦</div></div><span id="9567"></span><div id="comment-9567" class="comment"><div id="post-9567-score" class="comment-score"></div><div class="comment-text"><p>To check that you'll need to capture both at the client and at the server at the same time. That way you can compare the traces and tell where the holdup is. Interestingly enough the communication in stream 2 works just fine as far as I can tell, and the server responds quickly.</p></div><div id="comment-9567-info" class="comment-info"><span class="comment-age">(15 Mar '12, 17:02)</span> Jasper ♦♦</div></div><span id="9570"></span><div id="comment-9570" class="comment"><div id="post-9570-score" class="comment-score"></div><div class="comment-text"><p>Wow I wasn't too far off in my interpretation of what's going on. That 96.44 ip is the vendor of the software that's hanging up. The source in packet 13 is our server, with a small client piece. I gave them the trace earlier and told them to follow the TCP stream from 13. Everytime you run a report from this software the trace is the same, we push an XML file to them then the retransmits start. Their argument is I'm the only customer with an issue so it has to be on my side. There's logic there since I can put the client on nearly anything and it will work.</p></div><div id="comment-9570-info" class="comment-info"><span class="comment-age">(15 Mar '12, 18:44)</span> Willmeister</div></div><span id="9571"></span><div id="comment-9571" class="comment"><div id="post-9571-score" class="comment-score"></div><div class="comment-text"><p>But our citrix servers are virtual 2003 standard running in 2008R2 Hyper-V. If you run this client from host or virtual the same thing happens every single time.</p></div><div id="comment-9571-info" class="comment-info"><span class="comment-age">(15 Mar '12, 18:44)</span> Willmeister</div></div><span id="9572"></span><div id="comment-9572" class="comment not_top_scorer"><div id="post-9572-score" class="comment-score"></div><div class="comment-text"><p>Oh and thank you. I will try and see if I can get them to do a trace from their side. Right now I'm not even thinking about the virtual citrix servers, I'm just running this client software and wireshark on the hyper-v host trying to narrow it down...latest NIC drivers helped some, but it's obviously still hanging up...</p></div><div id="comment-9572-info" class="comment-info"><span class="comment-age">(15 Mar '12, 18:46)</span> Willmeister</div></div><span id="9579"></span><div id="comment-9579" class="comment not_top_scorer"><div id="post-9579-score" class="comment-score"></div><div class="comment-text"><p>Ok, what you need to do is to track down where the packets are delayed. It's still possible it has something to do with your servers, so if you suspect it is still a problem in your network you might want to capture at your ISP uplink to see if you see the same packets as on the server, or if there's already delay inside your network.</p></div><div id="comment-9579-info" class="comment-info"><span class="comment-age">(16 Mar '12, 00:59)</span> Jasper ♦♦</div></div><span id="9582"></span><div id="comment-9582" class="comment not_top_scorer"><div id="post-9582-score" class="comment-score"></div><div class="comment-text"><p>I don't really suspect it's anything on the network, other than something with the virtual nics on the Hyper-V. I have other servers, both citrix and non citrix, both windows 2003 and 2008, sitting on the same switch, same vlan, and there are no problems. The app works flawlessly. Vmswitch.sys is the virtual NIC driver and it's very suspect to me. Thanks for all your input.</p></div><div id="comment-9582-info" class="comment-info"><span class="comment-age">(16 Mar '12, 05:55)</span> Willmeister</div></div><span id="9586"></span><div id="comment-9586" class="comment not_top_scorer"><div id="post-9586-score" class="comment-score"></div><div class="comment-text"><p>Got a traffic shaper/prioritizing system in the path somewhere? This kind of thing reminds me of some strange behaviors I have seen in the past when that kind of device was in use. And especially with Citrix servers those shaping appliances are often deployed to guarantee bandwidth and fast latencies to terminal session users. Which will put your XML traffic in a very low class and delay it, sometimes for ages.</p></div><div id="comment-9586-info" class="comment-info"><span class="comment-age">(16 Mar '12, 07:51)</span> Jasper ♦♦</div></div><span id="9587"></span><div id="comment-9587" class="comment not_top_scorer"><div id="post-9587-score" class="comment-score"></div><div class="comment-text"><p>The proxy. But I couldn't find anything in the logs. I got the vendor to agree to a packet capture on their end, hoping it yields some info as to why we go unacknowledged. But after that I'll revisit the proxy.</p></div><div id="comment-9587-info" class="comment-info"><span class="comment-age">(16 Mar '12, 08:10)</span> Willmeister</div></div></div><div id="comment-tools-9332" class="comment-tools"><span class="comments-showing"> showing 5 of 10 </span> <a href="#" class="show-all-comments-link">show 5 more comments</a></div><div class="clear"></div><div id="comment-9332-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

