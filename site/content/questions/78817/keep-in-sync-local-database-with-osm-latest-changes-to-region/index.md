+++
type = "question"
title = "Keep in sync local database with OSM latest changes to region"
description = '''Hi Guys,  I have successfully build a tile server following below article :  https://switch2osm.org/serving-tiles/manually-building-a-tile-server-18-04-lts/ Successfully imported the data for Switzerland into the database and now i would like to keep the latest changes for this map into sync on dail...'''
date = "2021-02-12T13:23:00Z"
lastmod = "2021-10-31T02:44:00Z"
weight = 78817
keywords = [ "local", "osm", "sync" ]
aliases = [ "/questions/78817" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [Keep in sync local database with OSM latest changes to region](/questions/78817/keep-in-sync-local-database-with-osm-latest-changes-to-region)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr>
<td style="width: 30px; vertical-align: top"><div class="vote-buttons">
<span id="post-78817-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span>
<div id="post-78817-score" class="post-score" title="current number of votes">
1
</div>
<span id="post-78817-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span>
<div id="favorite-count" class="favorite-count">
&#10;</div>
</div></td>
<td><div id="item-right">
<div class="question-body">
<p>Hi Guys,</p>
<p>I have successfully build a tile server following below article :</p>
<p><a href="https://switch2osm.org/serving-tiles/manually-building-a-tile-server-18-04-lts/">https://switch2osm.org/serving-tiles/manually-building-a-tile-server-18-04-lts/</a></p>
<p>Successfully imported the data for Switzerland into the database and now i would like to keep the latest changes for this map into sync on daily level <a href="http://download.geofabrik.de/europe/switzerland-updates/">http://download.geofabrik.de/europe/switzerland-updates/</a></p>
<p>How i can achieve this is there anywhere step by step guide , or scripts that i can use.</p>
</div>
<div id="question-tags" class="tags-container tags">
<span class="post-tag tag-link-local" rel="tag" title="see questions tagged &#39;local&#39;">local</span> <span class="post-tag tag-link-osm" rel="tag" title="see questions tagged &#39;osm&#39;">osm</span> <span class="post-tag tag-link-sync" rel="tag" title="see questions tagged &#39;sync&#39;">sync</span>
</div>
<div id="question-controls" class="post-controls">
&#10;</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p>asked <strong>12 Feb '21, 13:23</strong></p>
<img src="https://secure.gravatar.com/avatar/b4c6f7d35e4fd1b4561578e5e376ca06?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="DavorB0&#39;s gravatar image" />
<p><span>DavorB0</span><br />
<span class="score" title="22 reputation points">22</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="DavorB0 has no accepted answers">0%</span></p>
</div>
</div>
<div id="comments-container-78817" class="comments-container">
&#10;</div>
<div id="comment-tools-78817" class="comment-tools">
&#10;</div>
<div class="clear">
&#10;</div>
<div id="comment-78817-form-container" class="comment-form-container">
&#10;</div>
<div class="clear">
&#10;</div>
</div></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="78822"></span>

<div id="answer-container-78822" class="answer accepted-answer">

<table style="width:100%;">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr>
<td style="width: 30px; vertical-align: top"><div class="vote-buttons">
<span id="post-78822-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span>
<div id="post-78822-score" class="post-score" title="current number of votes">
0
</div>
<span id="post-78822-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="DavorB0 has selected this answer as the correct answer"> </span>
</div></td>
<td><div class="item-right">
<div class="answer-body">
<p>See the <a href="https://osm2pgsql.org/doc/manual.html#updating-an-existing-database">osm2pgsql manual</a> for recommended ways of doing this.</p>
</div>
<div class="answer-controls post-controls">
&#10;</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p>answered <strong>12 Feb '21, 15:44</strong></p>
<img src="https://secure.gravatar.com/avatar/2d4dfcdcde73aa5e2ffa4a9b3a7cb51d?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jochen%20Topf&#39;s gravatar image" />
<p><span>Jochen Topf</span><br />
<span class="score" title="5244 reputation points"><span>5.2k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="50 badges"><span class="silver">●</span><span class="badgecount">50</span></span><span title="74 badges"><span class="bronze">●</span><span class="badgecount">74</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jochen Topf has 32 accepted answers">31%</span></p>
</div>
</div>
<div id="comments-container-78822" class="comments-container">
&#10;</div>
<div id="comment-tools-78822" class="comment-tools">
&#10;</div>
<div class="clear">
&#10;</div>
<div id="comment-78822-form-container" class="comment-form-container">
&#10;</div>
<div class="clear">
&#10;</div>
</div></td>
</tr>
</tbody>
</table>

</div>

<span id="78819"></span>

<div id="answer-container-78819" class="answer">

<table style="width:100%;">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr>
<td style="width: 30px; vertical-align: top"><div class="vote-buttons">
<span id="post-78819-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span>
<div id="post-78819-score" class="post-score" title="current number of votes">
2
</div>
<span id="post-78819-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span>
</div></td>
<td><div class="item-right">
<div class="answer-body">
<p><a href="https://switch2osm.org/serving-tiles/updating-as-people-edit/">https://switch2osm.org/serving-tiles/updating-as-people-edit/</a></p>
<p>(it's relatively new there)</p>
</div>
<div class="answer-controls post-controls">
<div class="community-wiki">
This answer is marked "community wiki".
</div>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p>answered <strong>12 Feb '21, 14:15</strong></p>
<img src="https://secure.gravatar.com/avatar/0bf1aa22f7f5e045b0eb8beb79fe7907?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SomeoneElse&#39;s gravatar image" />
<p><span>SomeoneElse ♦</span><br />
<span class="score" title="36866 reputation points"><span>36.9k</span></span><span title="71 badges"><span class="badge1">●</span><span class="badgecount">71</span></span><span title="370 badges"><span class="silver">●</span><span class="badgecount">370</span></span><span title="866 badges"><span class="bronze">●</span><span class="badgecount">866</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SomeoneElse has 228 accepted answers">16%</span></p>
</div>
</div>
<div id="comments-container-78819" class="comments-container">
<span id="78821"></span>
<div id="comment-78821" class="comment">
<div id="post-78821-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>That description uses zveriks trim_osc which isn't a good solution in this case. Geofabrik offers local change files already so that is not needed at all.</p>
</div>
<div id="comment-78821-info" class="comment-info">
<span class="comment-age">(12 Feb '21, 15:43)</span> <span class="comment-user userinfo">Jochen Topf</span>
</div>
</div>
<span id="78826"></span>
<div id="comment-78826" class="comment">
<div id="post-78826-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>It's going to depend how up to date you want to be. If you're happy with daily updates (and OP here has said they are) then yes you can consume Geofabrik daily diffs direct and not bother trying to trim them down.</p>
<p>By all means add an extra sentence to <a href="https://github.com/switch2osm/switch2osm.github.io/blob/master/serving-tiles/updating-as-people-edit.md">https://github.com/switch2osm/switch2osm.github.io/blob/master/serving-tiles/updating-as-people-edit.md</a> to say that.</p>
</div>
<div id="comment-78826-info" class="comment-info">
<span class="comment-age">(12 Feb '21, 19:00)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
<span id="78828"></span>
<div id="comment-78828" class="comment">
<div id="post-78828-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>Thanks guys for the input and the feedback, much appreciated. Yes we're happy if we can achieve to sync the database on daily level, i followed the instructions provided , however when running the script</p>
<p>sudo -u renderaccount /home/renderaccount/src/mod_tile/openstreetmap-tiles-update-expire</p>
<p>It popup some strange error :</p>
<p>rm: cannot remove '/var/lib/mod_tile/dirty_tiles.6877': No such file or directory</p>
<p>Command in the script is the below one :</p>
<pre><code>if ! $OSM2PGSQL_BIN -a --slim -e $EXPIRY_MINZOOM-$EXPIRY_MAXZOOM $OSM2PGSQL_OPTIONS -o &quot;$EXPIRY_FILE.$$&quot; $CHANGE_FILE 1&gt;&amp;2 2&gt; &quot;$PGSQLLOG&quot;; then
    m_error &quot;osm2pgsql error&quot;
fi</code></pre>
<p>Below are the variables used :</p>
<p>OSM2PGSQL_BIN=osm2pgsql EXPIRY_MINZOOM=13 EXPIRY_MAXZOOM=20 OSM2PGSQL_OPTIONS="-d $DBNAME --tag-transform-script /home/renderaccount/src/openstreetmap-carto/openstreetmap-carto.lua" BASE_DIR=/var/lib/mod_tile EXPIRY_FILE=$BASE_DIR/dirty_tiles CHANGE_FILE=$BASE_DIR/changes.osc.gz</p>
<p>Cant figure it out why it's throwing this error , does the script suppose to download this files from somewhere or simply creates them ?</p>
</div>
<div id="comment-78828-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 08:27)</span> <span class="comment-user userinfo">DavorB0</span>
</div>
</div>
<span id="78831"></span>
<div id="comment-78831" class="comment not_top_scorer">
<div id="post-78831-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>For completeness, the source of the original script is <a href="https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire">https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire</a> .</p>
<p>By default, when you run that script with a date to initialise it, it'll write a configuration to files in /var/lib/mod_tile/.osmosis/ . In there you'll see "configuration.txt". By default obtains minutely diffs <a href="https://planet.openstreetmap.org/replication/minute">https://planet.openstreetmap.org/replication/minute</a> .</p>
<p>"rm: cannot remove '/var/lib/mod_tile/dirty_tiles.6877':" just means that something went so far wrong that it didn't produce a list of dirty tiles.</p>
<p>Details of the actual osm2pgsql error error are written to a logfile, and where that is is defined at the top of the file at <a href="https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire#L37">https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire#L37</a> and <a href="https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire#L46">https://github.com/SomeoneElseOSM/mod_tile/blob/switch2osm/openstreetmap-tiles-update-expire#L46</a> .</p>
<p>If you look in /var/log/tiles/osm2pgsql.log you should see the actual error.</p>
</div>
<div id="comment-78831-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 12:20)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
<span id="78832"></span>
<div id="comment-78832" class="comment not_top_scorer">
<div id="post-78832-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>That said, as Jochen has noted, if you want to consume daily diffs from Geofabrik, you'll need to make changes to the script or configuration files in /var/lib/mod_tile/.osmosis/ to say where you're getting files from and how much you want to update at once, or as he suggests, do something different.</p>
</div>
<div id="comment-78832-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 12:21)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
<span id="78833"></span>
<div id="comment-78833" class="comment">
<div id="post-78833-score" class="comment-score">
1
</div>
<div class="comment-text">
<p>Yes indeed if i check the log into the mention file , it show's completely different error :</p>
<p>ERROR: DB copy thread failed: Database error: ERROR: column "addr:interpolation" of relation "planet_osm_point" does not exist</p>
<p>Guess i will need to figure out a different way so i can manage to apply the daily updates from Geofabrik.</p>
<p>I already try to execute with below commands , unfortunately this doesn't work as well.</p>
<p>osmosis --read-replication-interval workingDirectory=/home/renderaccount/data --simplify-change --write-xml-change /home/renderaccount/data/changes.osc.gz</p>
<p>osm2pgsql --append -d gis -S ~/src/openstreetmap-carto/openstreetmap-carto.style -C 10500 --slim --number-processes 6 /home/renderaccount/data/changes.osc.gz</p>
<p>Previously i created the state and configuration file.</p>
<p>$ pwd ; ls -l /home/renderaccount/data configuration.txt download.lock state.txt cat configuration.txt -e baseUrl=<a href="http://download.geofabrik.de/europe/switzerland-updates">http://download.geofabrik.de/europe/switzerland-updates</a> maxInterval=3600 cat state.txt</p>
<h1 id="original-osm-minutely-replication-sequence-number-4407283">original OSM minutely replication sequence number 4407283</h1>
<p>timestamp=2021-02-08T21\:42\:02Z sequenceNumber=2876</p>
</div>
<div id="comment-78833-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 13:17)</span> <span class="comment-user userinfo">DavorB0</span>
</div>
</div>
<span id="78834"></span>
<div id="comment-78834" class="comment not_top_scorer">
<div id="post-78834-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>Missing database columns is something that will likely cause a problem however you update the database, and that particular one isn't one I've seen before. Have you perhaps changed or updated the style and not made some needed changes to the database structure? Maybe you need to make sure that "OSM2PGSQL_OPTIONS" matches your database?</p>
</div>
<div id="comment-78834-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 13:27)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
<span id="78835"></span>
<div id="comment-78835" class="comment not_top_scorer">
<div id="post-78835-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>Yes the variable OSM2PGSQL_OPTIONS matches the database. This is how it is in the script :</p>
<p>DBNAME=gis OSM2PGSQL_OPTIONS="-d $DBNAME"</p>
<p>I didn't perform any updates on the database or the style. If the database structure somehow it's not good , should i maybe re-deploy new system completely , following the same guide ? and then to try again with the same script to synchronize the changes</p>
</div>
<div id="comment-78835-info" class="comment-info">
<span class="comment-age">(13 Feb '21, 13:43)</span> <span class="comment-user userinfo">DavorB0</span>
</div>
</div>
<span id="78847"></span>
<div id="comment-78847" class="comment not_top_scorer">
<div id="post-78847-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<blockquote>
<p>If the database structure somehow it's not good , should i maybe re-deploy new system completely</p>
</blockquote>
<p>How you update data depends on how you loaded it in the first place. As an example, the options that I need to use when updating a different map style (which has a different database format) can be seen at <a href="https://github.com/SomeoneElseOSM/mod_tile/blob/zoom/openstreetmap-tiles-update-expire#L25">https://github.com/SomeoneElseOSM/mod_tile/blob/zoom/openstreetmap-tiles-update-expire#L25</a> . I don't know what columns were originally in your database, so can't really comment on that.</p>
</div>
<div id="comment-78847-info" class="comment-info">
<span class="comment-age">(14 Feb '21, 15:40)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
<span id="78848"></span>
<div id="comment-78848" class="comment not_top_scorer">
<div id="post-78848-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>In order to install and create a tile server i did follow below guide :</p>
<p><a href="https://switch2osm.org/serving-tiles/manually-building-a-tile-server-18-04-lts/">https://switch2osm.org/serving-tiles/manually-building-a-tile-server-18-04-lts/</a></p>
<p>Which everything went fine.</p>
<p>The load of the data into the Gis database that i used is below one (same one from the guide , only the country is changed ) :</p>
<p>osm2pgsql -d gis --create --slim -G --hstore --tag-transform-script ~/src/openstreetmap-carto/openstreetmap-carto.lua -C 10500 --number-processes 4 -S ~/src/openstreetmap-carto/openstreetmap-carto.style ~/data/switzerland-latest.osm.pbf</p>
<p>I did not include the '--tag-transform-script' part into the variable OSM2PGSQL_OPTIONS. Suppose this is the reason why the database structure it's changed and now its no good. I will build a new server and will include this parameter before i execute the script once again.</p>
<p>Since all of this is new technology for me and i jump from one article to another to understand everything (mod_tile, render, mapnik etc) and reading documentation. Is there an easy way what/where its needed to be changed in the script 'openstreetmap-tiles-update-expire' in order daily updates from Geofabrik for Switzerland to be applied.</p>
<p>Thanks for the help.</p>
</div>
<div id="comment-78848-info" class="comment-info">
<span class="comment-age">(14 Feb '21, 18:41)</span> <span class="comment-user userinfo">DavorB0</span>
</div>
</div>
<span id="78866"></span>
<div id="comment-78866" class="comment">
<div id="post-78866-score" class="comment-score">
1
</div>
<div class="comment-text">
<p>Below article helped me to update the database on daily level :</p>
<p><a href="https://wiki.openstreetmap.org/wiki/HowTo_minutely_hstore">https://wiki.openstreetmap.org/wiki/HowTo_minutely_hstore</a></p>
<p>Unfortunately i am using the whole planet , but the goal to have the changes for Swiss are included as well in the replication file.</p>
<p>With the approach from <a href="https://switch2osm.org/serving-tiles/updating-as-people-edit/">https://switch2osm.org/serving-tiles/updating-as-people-edit/</a> to update from Geofabrik didn't work for me.</p>
</div>
<div id="comment-78866-info" class="comment-info">
<span class="comment-age">(15 Feb '21, 18:13)</span> <span class="comment-user userinfo">DavorB0</span>
</div>
</div>
<span id="82425"></span>
<div id="comment-82425" class="comment not_top_scorer">
<div id="post-82425-score" class="comment-score">
&#10;</div>
<div class="comment-text">
<p>For completeness, this error:</p>
<pre><code>ERROR: DB copy thread failed: Database error: ERROR: column &quot;addr:interpolation&quot; of relation &quot;planet_osm_point&quot; does not exist</code></pre>
<p>can be caused by the database format not matching the default osm2pgsql style file. This didn't use to be a problem, but it appears that following changes at the "OSM Carto" side (actually bugfixes in terms of what database contents are actually needed) it now is one.</p>
<p>To resolve it, specify the style file in the OSM2PGSQL_OPTIONS, something like:</p>
<pre><code>OSM2PGSQL_OPTIONS=&quot;-d $DBNAME --tag-transform-script /path/to/openstreetmap-carto.lua -S /path/to/openstreetmap-carto.style&quot;</code></pre>
</div>
<div id="comment-82425-info" class="comment-info">
<span class="comment-age">(31 Oct '21, 02:44)</span> <span class="comment-user userinfo">SomeoneElse ♦</span>
</div>
</div>
</div>
<div id="comment-tools-78819" class="comment-tools">
<span class="comments-showing"> showing 5 of 12 </span> <a href="#" class="show-all-comments-link">show 7 more comments</a>
</div>
<div class="clear">
&#10;</div>
<div id="comment-78819-form-container" class="comment-form-container">
&#10;</div>
<div class="clear">
&#10;</div>
</div></td>
</tr>
</tbody>
</table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

