+++
type = "question"
title = "Can we get total length of IP packet from pinfo pointer ?"
description = '''I intend to dissect last 12 bytes of my protocol packet and for that i am using eth.trailer subdissector list of standard ethernet dissector. And we know that in IP header we have a field of 2 bytes which denotes total length of IP packet.Also i assume IP dissector must have done its dissection befo...'''
date = "2012-06-14T00:51:00Z"
lastmod = "2012-06-19T08:25:00Z"
weight = 11892
keywords = [ "plugin", "wireshark" ]
aliases = [ "/questions/11892" ]
osqa_answers = 3
osqa_accepted = true
+++

<div class="headNormal">

# [Can we get total length of IP packet from pinfo pointer ?](/questions/11892/can-we-get-total-length-of-ip-packet-from-pinfo-pointer)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-11892-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-11892-score" class="post-score" title="current number of votes">0</div><span id="post-11892-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I intend to dissect last 12 bytes of my protocol packet and for that i am using eth.trailer subdissector list of standard ethernet dissector. And we know that in IP header we have a field of 2 bytes which denotes total length of IP packet.Also i assume IP dissector must have done its dissection before my dissector will get called. So is there any way to retrieve that value from *pinfo ?? I hope i am clear.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-plugin" rel="tag" title="see questions tagged &#39;plugin&#39;">plugin</span> <span class="post-tag tag-link-wireshark" rel="tag" title="see questions tagged &#39;wireshark&#39;">wireshark</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>14 Jun '12, 00:51</strong></p><img src="https://secure.gravatar.com/avatar/d15cd2870e25518ba76d2eb42f56bbcb?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="yogeshg&#39;s gravatar image" /><p><span>yogeshg</span><br />
<span class="score" title="41 reputation points">41</span><span title="22 badges"><span class="badge1">●</span><span class="badgecount">22</span></span><span title="23 badges"><span class="silver">●</span><span class="badgecount">23</span></span><span title="26 badges"><span class="bronze">●</span><span class="badgecount">26</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="yogeshg has no accepted answers">0%</span></p></div></div><div id="comments-container-11892" class="comments-container"><span id="11900"></span><div id="comment-11900" class="comment"><div id="post-11900-score" class="comment-score"></div><div class="comment-text"><p>Com'on folks please help , its a humble request... To make myself clear let me rephrase :</p><p>I want to write dissector which will dissect packets whose eth.dst is of a certain pattern. For that i am using heuristic dissector.</p><p>But , my data, which i want to dissect is located at end of the IP payload . We can also say it's at end of eth payload or ip payload or tcp payload ..</p><p>That's why i think i should use eth.trailer subdissector for this.</p><p>But my heuristics need to access eth.dst, which will be already dissected when my dissector gets called isn't it ?</p><p>So for that i was wondering if we have any way to fetch eth.dst from pinfo pointer ?</p></div><div id="comment-11900-info" class="comment-info"><span class="comment-age">(14 Jun '12, 09:21)</span> <span class="comment-user userinfo">yogeshg</span></div></div></div><div id="comment-tools-11892" class="comment-tools"></div><div class="clear"></div><div id="comment-11892-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="11963"></span>

<div id="answer-container-11963" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-11963-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-11963-score" class="post-score" title="current number of votes">2</div><span id="post-11963-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="yogeshg has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>You have set a real hard target for yourself trying to keep all Wireshark functionality while dissecting such a violating protocol. What kind of HW or SW is used that overwrites these 12 bytes and the ethernet addresses?</p><p>I think the way forward (warning: uncharted territory!!!) would be:</p><ol><li>Build your own ethernet dissector as a plug-in and add it to the heuristics table.</li><li>If the packet matches your protocol (based on the mac address):<ul><li>Dissect the ethernet header and add it to the tree</li><li>create a new TVB with all IP and upper layer data, up to (but not including) your 12 bytes</li><li>Call the IP dissector with the new TVB</li><li>When the IP dissector returns, dissect your 12 bytes and add it to the tree</li></ul></li><li>If not, don't dissect and let the normal ethernet dissector do it's magic on the packet.</li></ol></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>15 Jun '12, 09:19</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p><span>SYN-bit ♦♦</span><br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>15 Jun '12, 09:21</strong> </span></p></div></div><div id="comments-container-11963" class="comments-container"><span id="11965"></span><div id="comment-11965" class="comment"><div id="post-11965-score" class="comment-score"></div><div class="comment-text"><p>Boss,</p><blockquote><blockquote><p>Dissect the ethernet header and add it to the tree</p></blockquote></blockquote><p>This part is the only hurdle.I will have to plunge into default eth dissector to comprehend how that is being done.</p></div><div id="comment-11965-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:35)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11967"></span><div id="comment-11967" class="comment"><div id="post-11967-score" class="comment-score">1</div><div class="comment-text"><p>As I mentioned, copy the default eth dissector and remove the unnecessary parts. After all, you know that it's a "default" IP packet you're after, so no need to take care about all the other ethernet stuff, basically just the mac addresses, protocl type (IP) and possibly padding. Easy one ;-))</p></div><div id="comment-11967-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:46)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11968"></span><div id="comment-11968" class="comment"><div id="post-11968-score" class="comment-score"></div><div class="comment-text"><p>Can't thank enough both of you , earlier i was not sure of what i am doing , now that atleast i know how to go forward , i should be able to do it.</p></div><div id="comment-11968-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:55)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11969"></span><div id="comment-11969" class="comment"><div id="post-11969-score" class="comment-score"></div><div class="comment-text"><p>can you please tell us what kind of cluster software or loadbalancer (if any) causes that behaviour? Is it something "home-brewed" or is it available on the market? I want to store that information somewhere deep in my skull, just in case I'll see that ever again in the wild ;-)</p></div><div id="comment-11969-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:57)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="12015"></span><div id="comment-12015" class="comment"><div id="post-12015-score" class="comment-score"></div><div class="comment-text"><p>Is it possible to have plugin calling another plugin in wireshark ? if yes , please point examples , thanks</p></div><div id="comment-12015-info" class="comment-info"><span class="comment-age">(18 Jun '12, 04:27)</span> <span class="comment-user userinfo">yogeshg</span></div></div></div><div id="comment-tools-11963" class="comment-tools"></div><div class="clear"></div><div id="comment-11963-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="11902"></span>

<div id="answer-container-11902" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-11902-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-11902-score" class="post-score" title="current number of votes">0</div><span id="post-11902-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>I'm not sure what you mean, as you are mixing ethernet trailer with last 12 bytes of IP payload in your question. If the 12 bytes you want to dissect are part of the IP payload, then you need to follow the normal path and let the protocol that has your 12 bytes as its payload call your dissector.</p><p>If your 12 bytes come after the IP payload, then it will indeed be handled as ethernet trailer and you will need to add your dissector to the ethernet trailer dissector list. Your dissector will then be called with a TVB pointing to the first byte <strong>after</strong> the IP payload, so that should be the first byte of your 12 bytes.</p><p>You have to be aware though, that there might or might not be a FCS in the trailer as well.</p><p>It would help if you could upload a tracefile with a few of the packets you want to dissect to <a href="http://www.cloudshark.org">www.cloudshark.org</a> and post the link to it here.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>14 Jun '12, 10:24</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p><span>SYN-bit ♦♦</span><br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span></p></div></div><div id="comments-container-11902" class="comments-container"><span id="11907"></span><div id="comment-11907" class="comment"><div id="post-11907-score" class="comment-score"></div><div class="comment-text"><p>Hi SYN-bit</p><p>Yes it's last 12 bytes of IP payload. But the criteria on which i will want my dissector to be called is eth.dst has to be of certain pattern.(02:00:6f:A:B:01) A and B can belong to a range.</p><p>So for this i am bound to use eth.heuristics ,or can i use normal ip disssector also and use negative offset with TVB to get to eth.dst in order to check it ? ..</p><p>I believe all this trouble is because my protocol data and the criteria part(eth.dst) lie far ahead from each other.</p><p>Tried uploading trace but no packets are showing <a href="http://up.It">up.It</a> says "No packets were found"</p></div><div id="comment-11907-info" class="comment-info"><span class="comment-age">(14 Jun '12, 16:36)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11908"></span><div id="comment-11908" class="comment"><div id="post-11908-score" class="comment-score"></div><div class="comment-text"><p>Did you try to upload a file in libpcap format?</p></div><div id="comment-11908-info" class="comment-info"><span class="comment-age">(14 Jun '12, 16:51)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="11909"></span><div id="comment-11909" class="comment"><div id="post-11909-score" class="comment-score"></div><div class="comment-text"><p>disector_add() is used for definition of criteria right ? and most of examples i saw ,use tcp.port or udp.port equal to some value. But my case is different , i want packets whose eth.dst is of certain pattern as i mentioned above.</p><p>That's why i am using eth heuristic dissector. But when we have heuristic dissector , our dissector gets called before that frame (eth in this case) is touched by wireshark. correct me if i am wrong</p></div><div id="comment-11909-info" class="comment-info"><span class="comment-age">(14 Jun '12, 17:04)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11916"></span><div id="comment-11916" class="comment"><div id="post-11916-score" class="comment-score"></div><div class="comment-text"><p>No , i tried to upload in .cap format not pcap ,can you send me your email address at <a href="http://yogesh.gg">yogesh.gg</a>@<a href="http://hotmail.com">hotmail.com</a> , i will send you file itself or check your facebook message :)</p></div><div id="comment-11916-info" class="comment-info"><span class="comment-age">(14 Jun '12, 22:20)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11917"></span><div id="comment-11917" class="comment"><div id="post-11917-score" class="comment-score"></div><div class="comment-text"><p><a href="http://www.cloudshark.org/captures/7e77eba8a6cb">http://www.cloudshark.org/captures/7e77eba8a6cb</a></p><p>Filter -- eth.dst==02:00:6f:01:02:01</p><p>Frame number 385</p></div><div id="comment-11917-info" class="comment-info"><span class="comment-age">(14 Jun '12, 22:40)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11951"></span><div id="comment-11951" class="comment not_top_scorer"><div id="post-11951-score" class="comment-score"></div><div class="comment-text"><p>OK, I just took a look at your data. Since "your protocol" seems to change the dst mac address and the last 12 bytes of the IP payload, I'm not sure how you want to dissect this.</p><ul><li>Do you want to dissect only your 12 bytes?</li><li>Or also the IP header (and what happens if the IP payload is less then 12 bytes, will the end of the IP header be overwritten?)</li><li>The dissector of the protocol in which the 12 bytes are overwritten will have a hard time dealing with that, regardless of your dissector.</li><li>How do you plan to handle sliced packets (like in frame 412) where (part of) your 12 bytes are missing</li></ul></div><div id="comment-11951-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:48)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="11953"></span><div id="comment-11953" class="comment not_top_scorer"><div id="post-11953-score" class="comment-score"></div><div class="comment-text"><p>Or will the following do for you:</p><p>Ethernet Dissection Padding Dissection of your 12 bytes</p><p>If that's the case, you should change the Ethernet dissector to recognize your special mac-address and call your dissector as next (instead of the IP dissector).</p><p>Then in your dissector, you need to extract the IP length from the IP header to get the offset to your 12 bytes. Show the "padding" as hexdata and then show the dissection of your protocol.</p></div><div id="comment-11953-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:52)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="11954"></span><div id="comment-11954" class="comment not_top_scorer"><div id="post-11954-score" class="comment-score"></div><div class="comment-text"><p>You might want to create a new TVB with the IP header and payload up to, but not inlcuding your 12 bytes. Get those dissected by calling the IP dissector and when the dissector returns, dissect your 12 octets. I'm not 100% sure though if that will work, I would have to work that out myself.</p></div><div id="comment-11954-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:54)</span> <span class="comment-user userinfo">SYN-bit ♦♦</span></div></div><span id="12059"></span><div id="comment-12059" class="comment not_top_scorer"><div id="post-12059-score" class="comment-score"></div><div class="comment-text"><p>Hi yogeshg,</p><p>Just a neat FYI - if you're using CloudShark you can actually embed the filter directly in the URL, thus:</p><p><a href="http://www.cloudshark.org/captures/7e77eba8a6cb?filter=eth.dst%3D%3D02%3A00%3A6f%3A01%3A02%3A01">http://www.cloudshark.org/captures/7e77eba8a6cb?filter=eth.dst%3D%3D02%3A00%3A6f%3A01%3A02%3A01</a></p><p>(When you hit apply filter, the URL will change so you can copy it easily).</p><p>/CS</p></div><div id="comment-12059-info" class="comment-info"><span class="comment-age">(19 Jun '12, 08:25)</span> <span class="comment-user userinfo">cloudshark</span></div></div></div><div id="comment-tools-11902" class="comment-tools"><span class="comments-showing"> showing 5 of 9 </span> <a href="#" class="show-all-comments-link">show 4 more comments</a></div><div class="clear"></div><div id="comment-11902-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="11930"></span>

<div id="answer-container-11930" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-11930-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-11930-score" class="post-score" title="current number of votes">0</div><span id="post-11930-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>yogeshg, you are asking a lot of questions about how to write a dissector during the last weeks, which is absolutely fine.</p><p>You say, you need to filter on a specific dst mac address. Then you show a sample (Frame 385) that looks like a somehow "crippled" HTTP request. BTW: There are other, "crippled" HTTP requests to that dst mac. Why is that?</p><p>So, what are you excatly trying to do with your dissector? I'm not sure you really need a dissector. Can you show a binary packet you want to dissect and the logical structure of the data in that packet? You need that information anyway if you want to dissect the packet.</p><p>BTW: Why do you want to filter on the dst mac address? Your sample is TCP on port 80. So, why not just add a heuristic TCP/HTTP dissector?</p><p>Are you interested in the structure of the payload or just the fact that there are packets with that dst mac address?</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>15 Jun '12, 04:55</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>15 Jun '12, 05:10</strong> </span></p></div></div><div id="comments-container-11930" class="comments-container"><span id="11931"></span><div id="comment-11931" class="comment"><div id="post-11931-score" class="comment-score"></div><div class="comment-text"><p>Yes Kurt , its a HTTP packet in this case but in general it can be any packet with that specific dest mac.That is not crippled but chunked HTTP packet , usually when size is big we do this.</p><p>In that chunked packet , if you click on HTTP header , then last 12 bytes will get highlighted below. That is precisely the part which i want to dissect.And this dissection i want to be done only on packets whose eth.dst is of that specific pattern.</p><p>In that packet, below you can see all the binary and all the info you asked for.</p><p>I gave the filter just because you guys can see what i want.</p></div><div id="comment-11931-info" class="comment-info"><span class="comment-age">(15 Jun '12, 05:17)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11932"></span><div id="comment-11932" class="comment"><div id="post-11932-score" class="comment-score"></div><div class="comment-text"><p>Thanks for you comment first.</p><p>It can be any packet , http,udp,icmp whatever. That's why i can rely only and only on eth.dst.</p><p>There are other HTTP requests also because trace was taken during traffic running. So only we are seeing lot of http requests.</p><p>Two things i want :</p><ol><li><p>Wireshark to search packets with eth.dst of my specific pattern and call my dissector on those packets.</p></li><li><p>The data i want to dissect is <em>PART</em> of IP payload and last 12 bytes of IP payload.</p></li></ol><p>That's it.</p></div><div id="comment-11932-info" class="comment-info"><span class="comment-age">(15 Jun '12, 05:29)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11936"></span><div id="comment-11936" class="comment"><div id="post-11936-score" class="comment-score"></div><div class="comment-text"><p>UPDATE: see my comment below</p></div><div id="comment-11936-info" class="comment-info"><span class="comment-age">(15 Jun '12, 06:57)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11937"></span><div id="comment-11937" class="comment not_top_scorer"><div id="post-11937-score" class="comment-score"></div><div class="comment-text"><p>Actually this packet is being steered from one node(a device) to another when any packet from client falls on wrong node. So from client it can be any packet icmp,http .. isn't it ? :)</p><p>I just got what i wanted..</p><p>for dst mac pinfo-&gt;dl_dst</p><p>and i also need to know about src mac .. pinfo-&gt;dl_src ??</p></div><div id="comment-11937-info" class="comment-info"><span class="comment-age">(15 Jun '12, 07:04)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11938"></span><div id="comment-11938" class="comment not_top_scorer"><div id="post-11938-score" class="comment-score"></div><div class="comment-text"><blockquote><p>It can be any packet , http,udp,icmp whatever.</p></blockquote><p>crazy "protocol", isn't it? I'm just curious: Why are you doing that???</p><p>If it's always an IP packet, why not adding a heuristic IP dissector? <strong>HOWEVER</strong>: I'm not sure if that's possible, as I could not find one in the sources!!<br />
</p><p>Within that dissector you can look for the dst mac (maybe pinfo-&gt;dl_dst) as soon as your dissector gets the packet. If the dst mac matches, look for your magic bytes (if there are any), possibly at position "pfino-&gt;iplen - 12" (or something similar). If neither condition matches return from your dissector.</p><p><strong>UPDATE</strong>: I don't think you can add a heuristic IP dissector, as packet-ip.c does not try to call heuristic dissectors. In that case, you can try to add a TCP and UDP heuristic dissector instead. I believe a heuristic ICMP dissector is also not possible (can't find code in packet-icmp.c). If that does not work for you, there is still the fallback to the heuristic ethernet dissector :-)</p><p>However, with the information given in this thread, somebody with good experience in writing dissectors, might be able to help you. I'm still diving into the wireshark code and there is a lot I don't understand (from the code and data structure perspective).</p><p>What you need:</p><ol><li>Add a heuristic ethernet dissector</li><li>As soon as your dissector gets called, check if the dst mac matches your pattern</li><li>If true, extract the last 12 bytes of the ethernet frame (what about trailer?), OR look at the IP structure itself (if the protocol is IP) and extract the last 12 bytes of the IP frame. As you mentioned, look at the IP len filed. You will have to do the later yourself, as the IP dissector will be called after your dissector, so you can't use that information.</li><li>Build any tree structure you need with the extracted data</li></ol></div><div id="comment-11938-info" class="comment-info"><span class="comment-age">(15 Jun '12, 07:08)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11939"></span><div id="comment-11939" class="comment not_top_scorer"><div id="post-11939-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Actually this packet is being steered from one node(a device) to another when any packet from client falls on wrong node. So from client it can be any packet icmp,http .. isn't it ? :)</p></blockquote><p>Is this some kind of cluster protocol? I have seen some traffic in your capture that looks like cluster communication.</p></div><div id="comment-11939-info" class="comment-info"><span class="comment-age">(15 Jun '12, 07:11)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11944"></span><div id="comment-11944" class="comment not_top_scorer"><div id="post-11944-score" class="comment-score"></div><div class="comment-text"><p>Kurt, Whatever you just mentioned in "What you need" , i did precisely same in first attempt. But it didn't work. Because when we make heuristic eth dissector , our dissector gets called for every packet before wireshark touches the eth frame and TVB points to first bit of eth header. But problem is, when i did the dissection of those 12 bytes and i called eth dissector using "call_dissector(eth_handle ....)" function , in that call actually it again calls my heuristic dissector with TVB still pointing to first bit of eth header. IF you see line number 249 in packet-eth.c you can find it.</p></div><div id="comment-11944-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:14)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11945"></span><div id="comment-11945" class="comment not_top_scorer"><div id="post-11945-score" class="comment-score"></div><div class="comment-text"><p>So it becomes loop kind of thing , because i will use call_dissector function inside my heur_dissect_proto function ..and in turn call_dissector will again call my heuristic dissector. I hope you will follow all what i said. That's why the procedure you mentioned won;t work !!</p><p>Thanks anyways for your patience Sir!</p></div><div id="comment-11945-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:14)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11950"></span><div id="comment-11950" class="comment not_top_scorer"><div id="post-11950-score" class="comment-score"></div><div class="comment-text"><p>you should not call the eth dissector in YOUR eth dissector, as it will "loop", as you mentioned. You need to parse the whole data yourself in your own eth dissector, as it will be called very early in the whole dissection process, so you can't access any IP, TCP data structures, as they are not there. No other dissector has been called for that packet, and you should not call any one of them yourself unless you know very well what happens then.</p><p>So, basically you need to (kind of) rebuild the basic functionality of the eth and ip dissector to get to the data you need. First look at the eth dst address (see eth fram spec). Look at the protocol field. If it's IP, look at the IP len field and extract the data you need (last 12 bytes).</p><p>If you are not interested in the dissection if the IP,TCP,UDP,ICMP part, then you can add your own information to the tree and tell wireshark to stop dissecting the packet any further.</p><p>However, if you want other dissectors to be called as well (on such a packet), then it get's really tricky.</p></div><div id="comment-11950-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:34)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11952"></span><div id="comment-11952" class="comment not_top_scorer"><div id="post-11952-score" class="comment-score"></div><div class="comment-text"><p>No i want to dissect every bit :) .. i tried calling ip dissector in my heuristic dissector and that worked only thing is eth part was not dissected.</p><p>And you told that pinfo-&gt;dl_dst will give me dst.mac right ? I suppose pinfo-&gt;dl_src will then give me src.mac. Ok that said, is there any way to get my dissector called for all packets without using heuristic dissector.AFAIK, only heuristic dissector gets called for all packet.</p></div><div id="comment-11952-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:48)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11955"></span><div id="comment-11955" class="comment not_top_scorer"><div id="post-11955-score" class="comment-score"></div><div class="comment-text"><p>as SYN-bit said, change the default eth dissector to detect your special mac addresses. As long as you don't want this change to be included into the official source, it's probably the best (simple) way to go.</p></div><div id="comment-11955-info" class="comment-info"><span class="comment-age">(15 Jun '12, 08:58)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11956"></span><div id="comment-11956" class="comment not_top_scorer"><div id="post-11956-score" class="comment-score"></div><div class="comment-text"><p>UPDATE: see my comment below</p></div><div id="comment-11956-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:04)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11957"></span><div id="comment-11957" class="comment not_top_scorer"><div id="post-11957-score" class="comment-score"></div><div class="comment-text"><p>I think only way for me is to build up dissection of eth part myself in my eth heuristic dissector.</p><p>And yes you got it right ,i am supposed to dissect all bits ..</p></div><div id="comment-11957-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:07)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11959"></span><div id="comment-11959" class="comment"><div id="post-11959-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>No i want to dissect every bit :)</p></blockquote><p>Do I get this right? You want to see ALL protocol details (Eth, IP, UDP, TCP, HTTP) plus your 12 last "magic" bytes beeing dissected by your own dissector? If so, you will have a hard time doing this, without some severe changes to wireshark, as those 12 last bytes can be part of any protocol (as you said).</p><p>Just a wild idea: Change the default eth dissector to trigger on your mac address. If that trigger fires, look at the last 12 bytes of the packets. If they contain some magic bytes, remove those 12 bytes from the packet (adjust the length) and call the ip dissector. As soon as that dissector returns, add the 12 bytes back to the packet and dissect them yourself within the eth dissector.</p></div><div id="comment-11959-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:12)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11960"></span><div id="comment-11960" class="comment"><div id="post-11960-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>I think only way for me is to build up dissection of eth part myself in my eth heuristic dissector.</p></blockquote><p>The better (and possibly easier) way would be to fix your cluster protocol ;-))</p></div><div id="comment-11960-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:14)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div><span id="11961"></span><div id="comment-11961" class="comment not_top_scorer"><div id="post-11961-score" class="comment-score"></div><div class="comment-text"><p>Nice suggestion , until now i was not even thinking of changing default source :) , thanks a ton , i should try to do it.thanks again</p></div><div id="comment-11961-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:18)</span> <span class="comment-user userinfo">yogeshg</span></div></div><span id="11964"></span><div id="comment-11964" class="comment not_top_scorer"><div id="post-11964-score" class="comment-score"></div><div class="comment-text"><p>you can also do this:</p><ul><li>distribute your own version of the wireshark binary</li><li>just copy the eth dissector code into your heuristic eth dissector plugin and make the necessary changes there. So, you don't have to care about all the obstacles of ethernet. Then just distribute your plugin.</li></ul></div><div id="comment-11964-info" class="comment-info"><span class="comment-age">(15 Jun '12, 09:21)</span> <span class="comment-user userinfo">Kurt Knochner ♦</span></div></div></div><div id="comment-tools-11930" class="comment-tools"><span class="comments-showing"> showing 5 of 17 </span> <a href="#" class="show-all-comments-link">show 12 more comments</a></div><div class="clear"></div><div id="comment-11930-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

