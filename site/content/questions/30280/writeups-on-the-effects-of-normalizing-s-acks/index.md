+++
type = "question"
title = "Writeups on the effects of normalizing S-ACKs"
description = '''Are there any good write ups on the effects on performance/throughput on normalizing the S-ACK option out at a firewall or IPS? I was trouble shooting some slow SMB2 file copy issues and saw that the SYN had the flag at the sender but by the time it gets to the destination the S-ACK options has been...'''
date = "2014-02-28T11:28:00Z"
lastmod = "2014-04-29T06:42:00Z"
weight = 30280
keywords = [ "ips", "s-ack", "tcp-options", "performance" ]
aliases = [ "/questions/30280" ]
osqa_answers = 2
osqa_accepted = true
+++

<div class="headNormal">

# [Writeups on the effects of normalizing S-ACKs](/questions/30280/writeups-on-the-effects-of-normalizing-s-acks)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-30280-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-30280-score" class="post-score" title="current number of votes">0</div><span id="post-30280-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Are there any good write ups on the effects on performance/throughput on normalizing the S-ACK option out at a firewall or IPS? I was trouble shooting some slow SMB2 file copy issues and saw that the SYN had the flag at the sender but by the time it gets to the destination the S-ACK options has been NOOP'd by a sourcefire IPS. I'd like to take something back to the security guys and try and convince them how stupid this is.</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-ips" rel="tag" title="see questions tagged &#39;ips&#39;">ips</span> <span class="post-tag tag-link-s-ack" rel="tag" title="see questions tagged &#39;s-ack&#39;">s-ack</span> <span class="post-tag tag-link-tcp-options" rel="tag" title="see questions tagged &#39;tcp-options&#39;">tcp-options</span> <span class="post-tag tag-link-performance" rel="tag" title="see questions tagged &#39;performance&#39;">performance</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>28 Feb '14, 11:28</strong></p><img src="https://secure.gravatar.com/avatar/5d07ae33b7a45a3b422b2be2b70a88fa?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="RTJ10&#39;s gravatar image" /><p><span>RTJ10</span><br />
<span class="score" title="16 reputation points">16</span><span title="4 badges"><span class="badge1">●</span><span class="badgecount">4</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="9 badges"><span class="bronze">●</span><span class="badgecount">9</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="RTJ10 has no accepted answers">0%</span></p></div></div><div id="comments-container-30280" class="comments-container"></div><div id="comment-tools-30280" class="comment-tools"></div><div class="clear"></div><div id="comment-30280-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="30281"></span>

<div id="answer-container-30281" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-30281-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-30281-score" class="post-score" title="current number of votes">2</div><span id="post-30281-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span class="accept-answer on" rel="nofollow" title="RTJ10 has selected this answer as the correct answer"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>There is no such write up that I am aware of, but I could write one in my blog at a later time. Facts are</p><ol><li>S-ACK is the best way to deal with packet loss. If you remove S-ACK from the options you'll revert to Fast Retransmissions or even RTO (worst case), which is not as efficient.</li><li>S-ACK has no known relevance when it comes to network security, so stripping it does not improve security but decreases throughput when recovering from packet loss. So it does not make sense to remove it, unless you want to keep your TCP behavior consistent with ancient TCP stacks.</li></ol><p>If your security guys do not believe me have them contact me and I'll convince them :-)</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>28 Feb '14, 11:48</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p><span>Jasper ♦♦</span><br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-30281" class="comments-container"><span id="30282"></span><div id="comment-30282" class="comment"><div id="post-30282-score" class="comment-score"></div><div class="comment-text"><p>I know I saw something by Laura Chappell about ASA's normalizing the S-ACK option out but I can't find the video on youtube, perhaps because she mentions it in passing and never did a presentation or writeup. :(</p></div><div id="comment-30282-info" class="comment-info"><span class="comment-age">(28 Feb '14, 11:57)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="30283"></span><div id="comment-30283" class="comment"><div id="post-30283-score" class="comment-score"></div><div class="comment-text"><p>She presented that one two years ago on Sharkfest I think. I don't have a youtube link either, but it still doesn't make any sense to remove S-ACK options from packets. I think it is a result of the security devices not recognizing the option at all and dropping it for that reason. The vendors should get their TCP normalization engines up to speed and let those options pass.</p></div><div id="comment-30283-info" class="comment-info"><span class="comment-age">(28 Feb '14, 12:00)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="30284"></span><div id="comment-30284" class="comment"><div id="post-30284-score" class="comment-score"></div><div class="comment-text"><p>No, they are doing it on purpose, here's a quote from my security guy:</p><p>"After reviewing your captures can see what you're referring to. Yes, we are normalizing TCP traffic across the Sourcefire sensors -- Unfortunately, turning Normalization off will severely impact inspection policies."</p></div><div id="comment-30284-info" class="comment-info"><span class="comment-age">(28 Feb '14, 12:22)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="30286"></span><div id="comment-30286" class="comment"><div id="post-30286-score" class="comment-score"></div><div class="comment-text"><p>tell them to open a support case. Sourcefire needs to fix their "Normalization", which seems to be on the level of the last century.</p></div><div id="comment-30286-info" class="comment-info"><span class="comment-age">(28 Feb '14, 12:33)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="30294"></span><div id="comment-30294" class="comment"><div id="post-30294-score" class="comment-score"></div><div class="comment-text"><p>Well, I passed on your comments to the security folks, I don't think I am very well loved ATM. :)</p></div><div id="comment-30294-info" class="comment-info"><span class="comment-age">(28 Feb '14, 18:56)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="30296"></span><div id="comment-30296" class="comment not_top_scorer"><div id="post-30296-score" class="comment-score"></div><div class="comment-text"><p>I bet they need to remove the S-ACK option to be able to search through the stream properly for matching policies, without buffering too much. After all, it's not a whole message but just segments, so they need to see the segments sequentially in order for match rules to work right. I doubt they want to have a large TCP buffer per connection/stream in their IDS to reassemble, and if they don't buffer, then they can't reassemble the stream properly if S-ACK is used; and even if they did buffer, it might be too late by then because the offending/bad segments already went by and will be accepted by the side they're trying to protect.</p></div><div id="comment-30296-info" class="comment-info"><span class="comment-age">(28 Feb '14, 19:11)</span> <span class="comment-user userinfo">Hadriel</span></div></div><span id="30298"></span><div id="comment-30298" class="comment not_top_scorer"><div id="post-30298-score" class="comment-score"></div><div class="comment-text"><p>Wellll, not being an IPS/IDS guy...wouldn't that make sense on outside IPS/IDSs, but safe to turn off on inside devices so as to not negatively affect network performance in or across datacenters?</p></div><div id="comment-30298-info" class="comment-info"><span class="comment-age">(28 Feb '14, 19:23)</span> <span class="comment-user userinfo">RTJ10</span></div></div><span id="30299"></span><div id="comment-30299" class="comment not_top_scorer"><div id="post-30299-score" class="comment-score"></div><div class="comment-text"><p>I'm not sure I understand what you mean... if it's crossing an IPS/IDS, presumably you want the IDS/IPS to apply its policies - otherwise why have it involved to begin with? If you're just talking about traffic between hosts on the private/internal side only, put their internal traffic on a separate network/vlan that the IDS/IPS ignores or isn't even in the path of. No?</p></div><div id="comment-30299-info" class="comment-info"><span class="comment-age">(28 Feb '14, 20:58)</span> <span class="comment-user userinfo">Hadriel</span></div></div><span id="30309"></span><div id="comment-30309" class="comment not_top_scorer"><div id="post-30309-score" class="comment-score"></div><div class="comment-text"><p>Sorry <span>@Hadriel</span>, but S-ACK has no negative effect on buffering segments - on the contrary, it helps getting the complete payload reconstructed in case of packet loss as fast as possible for content inspection.</p></div><div id="comment-30309-info" class="comment-info"><span class="comment-age">(01 Mar '14, 12:39)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="30310"></span><div id="comment-30310" class="comment not_top_scorer"><div id="post-30310-score" class="comment-score"></div><div class="comment-text"><p><span>@Jasper</span>: imagine you're an IDS/IPS receiving TCP segments that you need to reconstruct into a stream to run match policies against (regex or whatever). You currently have last processed TCP seq #3 and are waiting on #4. You see #5+6+7 come through. Do you (a) buffer those and wait for #4 some time later, or (b) drop them and force the far-end to resend them all again in sequence? If you choose (a), you're buffering for some time X. If you choose (b), you have to force S-ACK off, but you can avoid buffering quite a bit depending on the match policies logic. (but as I said, this is only a guess - I don't work for an IDS/IPS vendor)</p></div><div id="comment-30310-info" class="comment-info"><span class="comment-age">(01 Mar '14, 13:00)</span> <span class="comment-user userinfo">Hadriel</span></div></div><span id="30313"></span><div id="comment-30313" class="comment not_top_scorer"><div id="post-30313-score" class="comment-score"></div><div class="comment-text"><p>Really, "force the far end to resend them all in sequence?" That is not a good strategy (to say it in a nice way), because it will delay the transmission <strong>a lot</strong>, plus nobody can guarantee that the "in sequence" will work the second time - there may be more packet loss or just out-of-orders, and you'll never complete the full transaction.</p><p>No, if an IDS/IPS is doing policy matching against TCP payloads it needs to gather (buffer) all segments until the payload is complete.</p></div><div id="comment-30313-info" class="comment-info"><span class="comment-age">(01 Mar '14, 13:57)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="30318"></span><div id="comment-30318" class="comment not_top_scorer"><div id="post-30318-score" class="comment-score"></div><div class="comment-text"><p>If it doesn't work the second (or third or whatever) time, your internet connection between host+server is so bad it doesn't matter much what happens. But anyway I didn't say it was a great strategy - I just said I bet that's why they do it. I could be wrong - maybe there's some other reason (aside from just not having implemented it yet type thing).</p></div><div id="comment-30318-info" class="comment-info"><span class="comment-age">(02 Mar '14, 02:26)</span> <span class="comment-user userinfo">Hadriel</span></div></div></div><div id="comment-tools-30281" class="comment-tools"><span class="comments-showing"> showing 5 of 12 </span> <a href="#" class="show-all-comments-link">show 7 more comments</a></div><div class="clear"></div><div id="comment-30281-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="30325"></span>

<div id="answer-container-30325" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-30325-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-30325-score" class="post-score" title="current number of votes">1</div><span id="post-30325-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p><strong>S-ACK has no known relevance</strong> when it comes to network security,</p></blockquote><p>hm.. While trying <strong>not the sound</strong> like a smartass, I 'sometimes' fail to do so ;-)) So, here we go...</p><p>Software is full of bugs, and a TCP/IP implementation suffers from the same problem. So, people could come up with all kind of sick ideas to misuse the SACK feature, by sending wrong (forged) SACKs or whatever. If there is a bug in the TCP/IP stack, it could lead to almost anything, from a DoS, to a crash, to whatever you can think of.</p><p>Actually, that's exactly what happened some (long) time ago.</p><blockquote><p><a href="http://www.iss.net/security_center/reference/vuln/TCP_Invalid_SACK.htm">http://www.iss.net/security_center/reference/vuln/TCP_Invalid_SACK.htm</a><br />
<a href="http://www.iss.net/security_center/reference/vuln/TCP_Malformed_SACK_DoS.htm">http://www.iss.net/security_center/reference/vuln/TCP_Malformed_SACK_DoS.htm</a><br />
</p></blockquote><p>Even Snort failed to handle SACKs in certain environments.</p><blockquote><p><a href="http://archive.cert.uni-stuttgart.de/vuln-dev/2005/09/msg00006.html">http://archive.cert.uni-stuttgart.de/vuln-dev/2005/09/msg00006.html</a></p></blockquote><p>So, if you look at it this way, <strong>SACK did have a known relevance</strong> (years ago) when it comes to network security.</p><p>Nevertheless, the problems of the year 2005 are not a valid/good reason to strip the SACK options <strong>today</strong>.</p><p>I also believe it's somehow related to the TCP reassembling/buffering problem within the IDS scanner engine. However, I don't know snort/Sourcefire well enough to know why they might do that.</p><blockquote><p>Yes, <strong>we are normalizing TCP traffic</strong> across the Sourcefire sensors</p></blockquote><p>There is a normalizer preprocessor available for snort (and Sourcefire, I guess).</p><blockquote><p><a href="http://manual.snort.org/node17.html#SECTION003217000000000000000">http://manual.snort.org/node17.html#SECTION003217000000000000000</a></p></blockquote><p>They say, it's helpful to enable it <strong>in inline mode</strong>, to minimize the chances of evasion.</p><p>See also here: <a href="http://vrt-blog.snort.org/2010/11/inline-normalization-with-snort-290.html">http://vrt-blog.snort.org/2010/11/inline-normalization-with-snort-290.html</a></p><p><span><span>@RTJ10</span></span>: Maybe the same holds true for your Sourcefire configuration.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>02 Mar '14, 08:41</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p><span>Kurt Knochner ♦</span><br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>02 Mar '14, 08:49</strong> </span></p></div></div><div id="comments-container-30325" class="comments-container"><span id="32289"></span><div id="comment-32289" class="comment"><div id="post-32289-score" class="comment-score"></div><div class="comment-text"><p><span>@Kurt Knochner</span> - Thank you very much for the comments and links!</p><p><span>@Jasper</span> Thank you as well! I will need to track down a public email for Laura and see if she'd be willing to share the PPS or presentation.</p></div><div id="comment-32289-info" class="comment-info"><span class="comment-age">(29 Apr '14, 06:42)</span> <span class="comment-user userinfo">RTJ10</span></div></div></div><div id="comment-tools-30325" class="comment-tools"></div><div class="clear"></div><div id="comment-30325-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

