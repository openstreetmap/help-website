+++
type = "question"
title = "TCP window size and scaling"
description = '''Hi I am trying to troubleshoot speed issues for a customer connecting to a Web Site from abroad. We have carried out testing by asking carrying out downloads of files from our Web site &amp;amp; capturing traffic during this. We can see that once the download commences, after a short amount of packets, ...'''
date = "2011-02-16T05:07:00Z"
lastmod = "2011-02-28T06:31:00Z"
weight = 2365
keywords = [ "scaling", "window", "tcp", "size" ]
aliases = [ "/questions/2365" ]
osqa_answers = 3
osqa_accepted = false
+++

<div class="headNormal">

# [TCP window size and scaling](/questions/2365/tcp-window-size-and-scaling)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-2365-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-2365-score" class="post-score" title="current number of votes">2</div><span id="post-2365-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span> <span id="favorite-mark" class="ajax-command favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </span><div id="favorite-count" class="favorite-count">2</div></div></td><td><div id="item-right"><div class="question-body"><p>Hi</p><p>I am trying to troubleshoot speed issues for a customer connecting to a Web Site from abroad. We have carried out testing by asking carrying out downloads of files from our Web site &amp; capturing traffic during this.</p><p>We can see that once the download commences, after a short amount of packets, the TCP Window size on the receiving host drops to zero. After a short while this resumes &amp; then does not drop below 40000.</p><p>On this machine the Windows Scaling option is set to 3 &amp; the TCP Window size set to 65535. Even with the scaling option set the TCP Window size never goes above 65535 in the packets (which I am told is normal).</p><p>I am surprised that, with the scaling set to 3, the TCP Window size still reduces to zero.</p><p>IS this normal behaviour? I am guessing that the TCP Window reducing to zero is because of some resource limitation on the Receiving host...?</p><p>Any assistance would be greatly appreciated. Thanks Ian</p></div><div id="question-tags" class="tags-container tags"><span class="post-tag tag-link-scaling" rel="tag" title="see questions tagged &#39;scaling&#39;">scaling</span> <span class="post-tag tag-link-window" rel="tag" title="see questions tagged &#39;window&#39;">window</span> <span class="post-tag tag-link-tcp" rel="tag" title="see questions tagged &#39;tcp&#39;">tcp</span> <span class="post-tag tag-link-size" rel="tag" title="see questions tagged &#39;size&#39;">size</span></div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>16 Feb '11, 05:07</strong></p><img src="https://secure.gravatar.com/avatar/4dfdb30f4297c840a2cd7b3b6754fe34?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="ipittam&#39;s gravatar image" /><p><span>ipittam</span><br />
<span class="score" title="31 reputation points">31</span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="4 badges"><span class="silver">●</span><span class="badgecount">4</span></span><span title="6 badges"><span class="bronze">●</span><span class="badgecount">6</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="ipittam has no accepted answers">0%</span></p></div></div><div id="comments-container-2365" class="comments-container"></div><div id="comment-tools-2365" class="comment-tools"></div><div class="clear"></div><div id="comment-2365-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

3 Answers:

</div>

</div>

<span id="2366"></span>

<div id="answer-container-2366" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-2366-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-2366-score" class="post-score" title="current number of votes">3</div><span id="post-2366-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>TCP window dropping to Zero means that the receiving host has trouble processing incoming data fast enough. Even with window scaling it is something that can happen - the larger the window the longer it takes to drop to zero. If the receiving station is too slow to process data and it has to receive more data than the window size is in size it will go down to zero.</p><p>You can take a look at the "bytes in flight" value in the sender's tcp header to see how much data has not yet been acknowledged - it ususally shows pretty high numbers if the receiver is too slow to process the incoming flood of packets.</p><p>Zero windows very often indicate an overloaded receiving station (either OS or slow application), and is a good indicator that "it is NOT the network" :-)</p><p>Exception are Reset-Packet - they usually have a window size of 0 and are not an indication of an overworked station.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>16 Feb '11, 05:31</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p><span>Jasper ♦♦</span><br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div><div class="post-update-info post-update-info-edited"><p><span> edited <strong>16 Feb '11, 05:32</strong> </span></p></div></div><div id="comments-container-2366" class="comments-container"><span id="2367"></span><div id="comment-2367" class="comment"><div id="post-2367-score" class="comment-score"></div><div class="comment-text"><p>Hi Jasper,</p><p>Thanks for your response.</p><p>I was looking at the "bytes in flight" value in the packets (we have a packet capture on the client side for a download). I can see that bytes in flight never goes beyond 2736 (ie 2 packets) at a given time even though the client has been showing a win size of 65535.</p><p>Should the server be not sending more data (and hence show more bytes under bytes in flight) and thus make the download faster?</p><p>Are we missing something? Thanks - Ian</p></div><div id="comment-2367-info" class="comment-info"><span class="comment-age">(16 Feb '11, 07:07)</span> <span class="comment-user userinfo">ipittam</span></div></div><span id="2368"></span><div id="comment-2368" class="comment"><div id="post-2368-score" class="comment-score"></div><div class="comment-text"><p>For a capture at the client side that is pretty normal as every other packet is acknowledged (thus resulting in 2 packets being "in flight", meaning "not acknowledged"). On the server side you should see higher numbers of bytes in flight though, at least if client and server are not very close to each other.</p><p>Regardless of the bytes in flight the important fact is still the Zero Window syndrome - this should not happen in the middle of a transfer because it means the receiver is too slow to process data.</p></div><div id="comment-2368-info" class="comment-info"><span class="comment-age">(16 Feb '11, 07:17)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="2369"></span><div id="comment-2369" class="comment"><div id="post-2369-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jasper</p><p>We have looked at the Packet capture from the Server &amp; it is quite different. The bytes in flight reaches up to almost 65535 &amp; then ACKs are received.</p><p>If the TCP Windows Scaling setting is enabled, should the bytes in flight be seen to increase above this amount?</p><p>Also, am I right in saying that the Window Size setting may be changed by intermediate network devices, as the packets are buffered by these devices in transit?</p><p>Thanks Ian</p></div><div id="comment-2369-info" class="comment-info"><span class="comment-age">(16 Feb '11, 07:53)</span> <span class="comment-user userinfo">ipittam</span></div></div></div><div id="comment-tools-2366" class="comment-tools"></div><div class="clear"></div><div id="comment-2366-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="2384"></span>

<div id="answer-container-2384" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-2384-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-2384-score" class="post-score" title="current number of votes">2</div><span id="post-2384-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>When you look at that station communicating - how do you know the Window Scale is in use?</p><p>Do you see a "scaled" value in the host's TCP headers?</p><p>Here's the deal and it's all over the place these days. - your client can be set to use Window Scaling (TCP options in handshake) - if the server doesn't support it, neither side will use it (look at server handshake response) - if an intermediary device (such as a "smart firewall" - ugh) doesn't like/support that option for the path, it might strip off your client's TCP option (thinking Cisco ASA here). - if Window Scaling is on and truly in use and your client still hits Window Zero conditions, then what the heck is the application running for that communication? Example: IE being dog slow picking data up out of receive buffer causes Window Zero condition on large file download - update IE or get a better browser.</p><p>BTW, the Window Size field can only go to 65,535 as it is a 2-byte field. If Window Scaling is truly in use and you have set the TCP Preferences to show Relative Sequence Numbering and Window Scaling (the default), then you should see a scaled factor after the Window Size field in the communications after the first two packets of the handshake.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>16 Feb '11, 11:17</strong></p><img src="https://secure.gravatar.com/avatar/9b4bb3984350b45aee3eda5cc1c90d36?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="lchappell&#39;s gravatar image" /><p><span>lchappell ♦</span><br />
<span class="score" title="1206 reputation points"><span>1.2k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="7 badges"><span class="silver">●</span><span class="badgecount">7</span></span><span title="30 badges"><span class="bronze">●</span><span class="badgecount">30</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="lchappell has 6 accepted answers">8%</span></p></div></div><div id="comments-container-2384" class="comments-container"><span id="2417"></span><div id="comment-2417" class="comment"><div id="post-2417-score" class="comment-score"></div><div class="comment-text"><p>Thanks for your comments - very useful!</p><p>We have convinced our Service Provider to enable TCP windows Scaling &amp; Selective Acks. We now see that the these options are mutually enabled it the SYN / SYN-ACK packets.</p><p>A further observation we have is that the when downloading a file from a Web Server behind the Cisco ACE device via a SSL connection (HTTPS URL) we can see that the Cisco is struggling with flow &amp; reducing the TCP Window &amp; also the Server advertising that the TCP Window is full.</p><p>Thanks Ian</p></div><div id="comment-2417-info" class="comment-info"><span class="comment-age">(18 Feb '11, 09:27)</span> <span class="comment-user userinfo">ipittam</span></div></div><span id="2418"></span><div id="comment-2418" class="comment"><div id="post-2418-score" class="comment-score"></div><div class="comment-text"><p>Am I right in saying that this could be too do with processing delays on the ACE device due to SSL processing?</p><p>Could it also be due to a downstream device throttling the connection &amp; this being passed down the stream to the ACE &amp; eventually to the sending Web Server?</p><p>(Web Server &gt; Cisco ACE &gt; Intermediate router &gt; ....Client)</p><p>Thanks Ian</p></div><div id="comment-2418-info" class="comment-info"><span class="comment-age">(18 Feb '11, 09:27)</span> <span class="comment-user userinfo">ipittam</span></div></div><span id="2428"></span><div id="comment-2428" class="comment"><div id="post-2428-score" class="comment-score"></div><div class="comment-text"><p>SSL processing might be a reason why the window drops to zero since it adds further encryption load on the devices apart from just transfering data. If you still have the zero window problem you should track down the origin of which device advertises that window and performance tune it or (worst case) replace it with a more powerful device.</p></div><div id="comment-2428-info" class="comment-info"><span class="comment-age">(19 Feb '11, 11:19)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div><span id="2449"></span><div id="comment-2449" class="comment"><div id="post-2449-score" class="comment-score"></div><div class="comment-text"><p>Ok... not to cast stones or anything.... but... "the Cisco is struggling with flow &amp; reducing the TCP Window"... that makes me gag. Aren't these guys the gurus of infrastructure and data flow? I'm gonna just say it outright... they stink if they are adjusting the Window Size value - do we have any Cisco folks hanging around here? I've seen Cisco products kill SACK in the handshake too... can you take a trace at both ends of a TCP handshake and see what they are doing to the TCP options fields? ... breathing deeply now... going to my happy place... &lt;g&gt;</p></div><div id="comment-2449-info" class="comment-info"><span class="comment-age">(21 Feb '11, 02:13)</span> <span class="comment-user userinfo">lchappell ♦</span></div></div><span id="2477"></span><div id="comment-2477" class="comment"><div id="post-2477-score" class="comment-score"></div><div class="comment-text"><p>I can see you being able to selectively disable SACK in ACE. Unless the ACE box is being hammered I don't see it being the choke point for the SSL communications, those boxes have ASICs dedicated to crypto.</p></div><div id="comment-2477-info" class="comment-info"><span class="comment-age">(22 Feb '11, 06:26)</span> <span class="comment-user userinfo">GeonJay</span></div></div><span id="2583"></span><div id="comment-2583" class="comment not_top_scorer"><div id="post-2583-score" class="comment-score"></div><div class="comment-text"><p>If there IS an ACE module please really be SURE that both ends of the communication really have identical TCP headers + options... We also had issues with cisco devices cutting the options field during transfer which only came out doing a multi-point trace. So like Laura said keep that in mind and because I nearly vomited at that point at a recent project I could not not comment this here :)</p></div><div id="comment-2583-info" class="comment-info"><span class="comment-age">(28 Feb '11, 06:31)</span> <span class="comment-user userinfo">Landi</span></div></div></div><div id="comment-tools-2384" class="comment-tools"><span class="comments-showing"> showing 5 of 6 </span> <a href="#" class="show-all-comments-link">show 1 more comments</a></div><div class="clear"></div><div id="comment-2384-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="2371"></span>

<div id="answer-container-2371" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><span id="post-2371-upvote" class="ajax-command post-vote up" rel="nofollow" title="I like this post (click again to cancel)"> </span><div id="post-2371-score" class="post-score" title="current number of votes">1</div><span id="post-2371-downvote" class="ajax-command post-vote down" rel="nofollow" title="I dont like this post (click again to cancel)"> </span></div></td><td><div class="item-right"><div class="answer-body"><p>Usually the window scaling should be set to a value high enough to continuously transfer packets without having to stop and wait for an ACK to arrive. The bytes in flight can not exceed the effective window size.</p><p>If window scaling is enabled you'll see that both station negotiate the window scale factor in their SYN packets, which is then used to calculate the effective window size as "2 to the power of &lt;scale factor=""&gt; multiplied by the 'normal' 16bit window size". The latest development builds of Wireshark show both values, "normal" window size and scaled window size.</p><p>I have seen intermediate devices change the window size, resulting in a very ineffective communication (usually packet shaping or prioritizing devices, layer3 devices usually don't do this). You can check that by comparing window size and scale factors when capturing both at client and server: both should show the same values - if not, an intermediate device fumbles around with your packets.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>16 Feb '11, 08:33</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p><span>Jasper ♦♦</span><br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div></div><div id="comments-container-2371" class="comments-container"><span id="2376"></span><div id="comment-2376" class="comment"><div id="post-2376-score" class="comment-score"></div><div class="comment-text"><p>Thanks Jasper</p><p>So is the fact that we see different communication conversations at each end meaning that the intermediate networks devices are altering the flow.</p><p>Am I right in presuming that this flow control would be different for each intermediate hop?</p><p>Thanks again! Ian</p></div><div id="comment-2376-info" class="comment-info"><span class="comment-age">(16 Feb '11, 09:35)</span> <span class="comment-user userinfo">ipittam</span></div></div><span id="2388"></span><div id="comment-2388" class="comment"><div id="post-2388-score" class="comment-score"></div><div class="comment-text"><p>What kind of differences do you see? Different window sizes and/or scale factors for the exact same packets? Are there any devices doing NAT?</p><p>I'm not sure what you mean with "different flow control for intermediate hops". Usually TCP flows are not modified by network devices except when NATting, or if a traffic shaper/prioritizing device is used.</p></div><div id="comment-2388-info" class="comment-info"><span class="comment-age">(16 Feb '11, 15:33)</span> <span class="comment-user userinfo">Jasper ♦♦</span></div></div></div><div id="comment-tools-2371" class="comment-tools"></div><div class="clear"></div><div id="comment-2371-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

