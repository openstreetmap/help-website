+++
type = "question"
title = "Rewrite the inner IP addresses of a GTP packet"
description = '''I have a capture (pcap) file with GTP-C and GTP-U traffic. I need to edit the inner source and destination IP address of the GTP packet. These would be the IP addresses related the actual subscriber&#x27;s traffic flow. I was trying to achieve this using tcpprep and tcprewrite, but I am only able rewrite...'''
date = "2013-10-29T09:08:00Z"
lastmod = "2013-10-30T15:32:00Z"
weight = 26516
keywords = [ "gtp", "ip", "pcap" ]
aliases = [ "/questions/26516" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Rewrite the inner IP addresses of a GTP packet](/questions/26516/rewrite-the-inner-ip-addresses-of-a-gtp-packet)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-26516-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I have a capture (pcap) file with GTP-C and GTP-U traffic. I need to edit the inner source and destination IP address of the GTP packet. These would be the IP addresses related the actual subscriber's traffic flow. I was trying to achieve this using tcpprep and tcprewrite, but I am only able rewrite the outer (GGSN and SGSN) IP addresses. I want to keep the outer IP addresses as is, and only change the inner IP addresses. So, is it still possible to achieve what I want using tcpreqrite or do I have to take some other approach? Thanks.</p></div><div id="question-tags" class="tags-container tags">gtp ip pcap</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>29 Oct '13, 09:08</strong></p><img src="https://secure.gravatar.com/avatar/f06228c3ce6d7a0b36c09417311ff2bb?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="waqasamin&#39;s gravatar image" /><p>waqasamin<br />
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="bronze">●</span><span class="badgecount">1</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="waqasamin has no accepted answers">0%</span></p></div></div><div id="comments-container-26516" class="comments-container"><span id="26521"></span><div id="comment-26521" class="comment"><div id="post-26521-score" class="comment-score"></div><div class="comment-text"><p>I'm not certain if it works on GTP traffic, but you might take a look at Bittwist <a href="http://bittwist.sourceforge.net/">http://bittwist.sourceforge.net/</a> It has a packet editor that may do what you need.</p></div><div id="comment-26521-info" class="comment-info"><span class="comment-age">(29 Oct '13, 10:36)</span> kpalmgren</div></div></div><div id="comment-tools-26516" class="comment-tools"></div><div class="clear"></div><div id="comment-26516-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="26529"></span>

<div id="answer-container-26529" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-26529-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p><a href="http://www.tracewrangler.com">TraceWrangler</a> can parse GTP-U packets and allows removing the outer layer, basically stripping the packet down to the inner IP and payload layers. It does not (yet) offer annonymization/modification of GTP-U or GTP-C packets, but maybe I can add that functionality at some point.</p><p>The problem is that it is quite hard to find adequate samples to do the tests while implementing features like that, because of the sensitive nature of the details found inside. Sort of a Catch-22: I need to see a sample to be able to implement anonymization but I can't get the sample because it is not anonymized yet :-)</p><p>But back to your question: I doubt that there are any tools that can do what you need, because both tcprewrite and bittwiste cannot deal with tunneled layers. I guess you'll have to do it the hard way in the meantime: using a hex editor (I can recommend the "010 Editor" which has templates that makes it easier to parse pcap files).</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>30 Oct '13, 00:33</strong></p><img src="https://secure.gravatar.com/avatar/c578ba2967741f25aebd6afef702f432?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Jasper&#39;s gravatar image" /><p>Jasper ♦♦<br />
<span class="score" title="23806 reputation points"><span>23.8k</span></span><span title="5 badges"><span class="badge1">●</span><span class="badgecount">5</span></span><span title="51 badges"><span class="silver">●</span><span class="badgecount">51</span></span><span title="284 badges"><span class="bronze">●</span><span class="badgecount">284</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Jasper has 263 accepted answers">18%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 30 Oct '13, 00:34</p></div></div><div id="comments-container-26529" class="comments-container"><span id="26538"></span><div id="comment-26538" class="comment"><div id="post-26538-score" class="comment-score"></div><div class="comment-text"><p>Removing the outer layer is not difficult, but that is not what I need. I do have a very good sample, but for understandable reasons I cannot share that :). I think the hex editor approach won't work because the file is over 1GB, though I will still give it a go. Thanks.</p></div><div id="comment-26538-info" class="comment-info"><span class="comment-age">(30 Oct '13, 07:22)</span> waqasamin</div></div><span id="26556"></span><div id="comment-26556" class="comment"><div id="post-26556-score" class="comment-score"></div><div class="comment-text"><p>Some sample files:</p><blockquote><p><a href="http://cloudshark.org/captures/374cf36574b6">http://cloudshark.org/captures/374cf36574b6</a><br />
<a href="https://bro-tracker.atlassian.net/browse/BIT-934">https://bro-tracker.atlassian.net/browse/BIT-934</a></p></blockquote><p>Have fun coding that stuff ;-))</p></div><div id="comment-26556-info" class="comment-info"><span class="comment-age">(30 Oct '13, 15:20)</span> Kurt Knochner ♦</div></div><span id="26558"></span><div id="comment-26558" class="comment"><div id="post-26558-score" class="comment-score"></div><div class="comment-text"><p>GTPv1 especially has some stuff out there, mostly as it relates to openGGSN, but even then it's darn-near impossible to get full mobility call flows in a trace file outside of tight NDAs.</p><p>I'm trying to get permission from a carrier to allow public distribution of 3GPP call flow traces that can be generated in a lab environment (a mini but working cell network, simulator-free and with support for the major EPS, GPRS and traditional CS call flows). With a test network number and non-confidential media payload, I think I could reliably reproduce and capture snapshot examples of most 3GPP-defined call flows including all protocols involved, and comment every packet in the flow citing the 3GPP TS and section number that defines why it's there.</p><p>Getting that approved might be difficult but since I need to lobby for it anyway to complete a publicly-distributable project I'm trying to get off the ground, if I'm successful I'll get you the trace files if it helps you with your sanitizer. Can't make any promises though.</p></div><div id="comment-26558-info" class="comment-info"><span class="comment-age">(30 Oct '13, 20:38)</span> Quadratic</div></div><span id="26564"></span><div id="comment-26564" class="comment"><div id="post-26564-score" class="comment-score"></div><div class="comment-text"><p>@Kurt: thanks, I already have some of them, but I'll take a closer look to see if I can improve my decodes.</p><p>@Quadratic: thanks for your efforts, it would be cool to see something like that. I can understand the sensitive nature of such traces, so if you can provide some that are not violating any NDAs and do not expose any critical data I would love to take a look.</p><p>If not, that's fine too - there are so many other protocols that I can work on instead... :-)</p></div><div id="comment-26564-info" class="comment-info"><span class="comment-age">(31 Oct '13, 01:23)</span> Jasper ♦♦</div></div><span id="26570"></span><div id="comment-26570" class="comment"><div id="post-26570-score" class="comment-score"></div><div class="comment-text"><blockquote><p>but even then it's darn-near impossible to get full mobility call flows in a trace file outside of tight NDAs.</p></blockquote><p>I always wondered what kind of secret byte string could be part of a capture file that requires an NDA? Aren't there test environments where one can generate 'non real world' traffic?</p></div><div id="comment-26570-info" class="comment-info"><span class="comment-age">(31 Oct '13, 02:59)</span> Kurt Knochner ♦</div></div><span id="26644"></span><div id="comment-26644" class="comment not_top_scorer"><div id="post-26644-score" class="comment-score"></div><div class="comment-text"><p>There are a few things that contribute to the secrecy:</p><p>Even though a protocol might be standardized, many mobile signaling protocols will reveal engineering decisions made by that vendor or by that operator. If you're a competing operator or vendor, there are a few ways you could take advantage of that. For example a vendor might lobby the 3GPP to make a section mandatory if they knew another vendor chose not to support it in their traces yet, or an operator might leverage design decisions made by another operator in their own decision-making process.</p><p>And it's not just optional fields, or in some cases literally per-feature booleaan flags indicating support, either. The presence of some optional messages in a call flow would tell you whether that network was using real-time policy/QoS control, real-time credit control, checks against IMEI black list registries, etc. It would reveal whether they had deployed Diameter routing which is a hot topic in the industry right now. Even in a development environment, it would suggest a lot about their plans or the state of their production environment.</p><p>Even to take something as standard as DNS, due to the 3GPP's extensive use of NAPTR and SRV records to convey service information, a full DNS trace would practically serve as an NMAP protocol scan in the core of a carrier's network, providing a list of logical systems, their IPs and what protocols and protocol versions they support. In general, since mobile networks have so many small parts communicating so verbosely to each other, a packet capture of all the signaling flows is revealing on many levels.</p><p>Some vendors also have proprietary versions or extensions to standards, where the messages themselves (unlike something like EIGRP) could actually be under NDA as well. And for exchanges in the SS7 stack, the equivalent of public IP info (public point code and GT information) would be revealed as well.</p><p>You'll notice that most traces that have been made public have been GTP or MTP3-related, which are sent between carriers and can't really be "protected" in this way from untrusted peers. Rarely will you see radio network exchanges (NBAP, RANAP, S1AP) or intra-core exchanges (SGsAP, Diameter policy/credit/authentication for the time being) in the wild right now.</p><p>Anyway, my plan is to use a minimalist lab environment to demonstrate the simplest, standards-based flows possible, then request NDA exemption for them. I honestly don't think I will succeed, but we shall see</p></div><div id="comment-26644-info" class="comment-info"><span class="comment-age">(03 Nov '13, 13:14)</span> Quadratic</div></div><span id="26645"></span><div id="comment-26645" class="comment not_top_scorer"><div id="post-26645-score" class="comment-score"></div><div class="comment-text"><p>@Quadratic: thanks for elaborating, this was a really interesting explanation. It also means that I probably shouldn't spend too much time on thinking about sanitization for these kind of traces, since you made it clear that even features being present/not present can be a problem - and I just really don't know enough of these protocol families to be able to do a good job in that regard.</p><p>So dear network carrier engineers, I'm sorry, but unless I change jobs and become really familiar with your network protocols I will spend my time sanitizing others that I know better ;-)</p><p>Of course, if there is a good lab trace and someone tells me what to focus on / what makes sense to sanitize I could try ;-)</p></div><div id="comment-26645-info" class="comment-info"><span class="comment-age">(03 Nov '13, 13:25)</span> Jasper ♦♦</div></div><span id="26659"></span><div id="comment-26659" class="comment not_top_scorer"><div id="post-26659-score" class="comment-score"></div><div class="comment-text"><blockquote><p>There are a few things that contribute to the secrecy:</p></blockquote><p>Jesus, that sounds like 3GPP environments are more like a secret society than an 'open' protocol standard ;-)</p><p>O.K. I see, there is obviously no simple way to generate meaningful traces, except by capturing them in a live environment and that would contain too much about internal structures.</p><p>In that respect, I wish you good luck with your endeavor :-)</p><p>Thanks<br />
Kurt</p></div><div id="comment-26659-info" class="comment-info"><span class="comment-age">(04 Nov '13, 05:24)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-26529" class="comment-tools"><span class="comments-showing"> showing 5 of 8 </span> <a href="#" class="show-all-comments-link">show 3 more comments</a></div><div class="clear"></div><div id="comment-26529-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="26557"></span>

<div id="answer-container-26557" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-26557-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>See my answer to a similar question:</p><blockquote><p><a href="http://ask.wireshark.org/questions/25437/field-obfuscation">http://ask.wireshark.org/questions/25437/field-obfuscation</a></p></blockquote><p>Basically you can use a hex editor (as @Jasper said), or you can use <strong>sed</strong> on Linux.</p><p>The IP header in the GTP encapsulated frame should be pretty unique in the capture file, so if you just replace the byte string that contains the IP addresses, it should work (in most of the cases).</p><p>Sample gtp-u file:</p><blockquote><p><a href="http://cloudshark.org/captures/374cf36574b6">http://cloudshark.org/captures/374cf36574b6</a></p></blockquote><p>Now, run <strong>sed</strong> on Linux (<strong>tested</strong> and <strong>works!</strong>)</p><p>One direction of communication:</p><blockquote><p>sed -i 's/\xca\x0b\x28\x9e\xc0\xa8\x28\xb2/\x0a\x01\x01\x01\x0a\x01\x01\x02/g' gtp-u.pcap</p></blockquote><p>Other (reverse) direction of communication:</p><blockquote><p>sed -i 's/\xc0\xa8\x28\xb2\xca\x0b\x28\x9e/\x0a\x01\x01\x02\x0a\x01\x01\x01/g' gtp-u.pcap</p></blockquote><p>This will change the IP addresses</p><p>from: 202.11.40.158, 192.168.40.178<br />
to: 10.1.1.1, 10.1.1.2</p><p>This is <strong>not</strong> perfect, as you may hit false positives in your pcap file, but it's better than nothing ;-))</p><p><strong>Hint:</strong> The IP checksum will be wrong after that change, but there is no simple solution for this. Sorry.</p><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>30 Oct '13, 15:32</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p>edited 31 Oct '13, 03:29</p></div></div><div id="comments-container-26557" class="comments-container"></div><div id="comment-tools-26557" class="comment-tools"></div><div class="clear"></div><div id="comment-26557-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

