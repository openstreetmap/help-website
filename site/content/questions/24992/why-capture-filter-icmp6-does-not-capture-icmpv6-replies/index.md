+++
type = "question"
title = "Why capture filter icmp6 does not capture ICMPv6 replies?"
description = '''I&#x27;m running a couple of LXC containers (Container1 and Container2) on my host, each with a veth (veth1000_1 and veth1001_1) connected through a bridge (mbr1). From Container1 I ping6 Container2 and everything is working, but I can&#x27;t manage to capture the icmp6 replies if I filter by protocol on veth...'''
date = "2013-09-20T03:01:00Z"
lastmod = "2013-09-20T04:10:00Z"
weight = 24992
keywords = [ "capture-filter", "vlan", "lxc", "tshark", "icmp6" ]
aliases = [ "/questions/24992" ]
osqa_answers = 0
osqa_accepted = true
+++

<div class="headNormal">

# [Why capture filter icmp6 does not capture ICMPv6 replies?](/questions/24992/why-capture-filter-icmp6-does-not-capture-icmpv6-replies)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24992-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>I'm running a couple of LXC containers (Container1 and Container2) on my host, each with a veth (veth1000_1 and veth1001_1) connected through a bridge (mbr1). From Container1 I ping6 Container2 and everything is working, but I can't manage to capture the icmp6 replies if I filter by protocol on veth1000_1:</p><ul><li><strong>tshark -i veth1000_1</strong> captures requests and replies</li><li><strong>tshark -i veth1000_1 -f icmp6</strong> captures only requests</li><li><strong>tshark -i mbr1 -f icmp6</strong> captures requests and replies</li><li><strong>tshark -i eth1.12 -f icmp6</strong> inside Container1 captures both requests and replies</li></ul><p>I'm interested in using veth1000_1 instead of mbr1 because when jumping to a more complex scenario, where packets can be lost, I'm interested on seeing only the packets actually received by the container and not on the network. Also having to capture in the container makes everything more complicated so I rather capture everything from the host. And I don't want huge capture files, so I'd like to filter out the other traffic.</p><p>I've also tried with tcpdump with the same results. Also I tried pinging from the host to the outside world and everything worked fine.</p><p>I'm using tshark 1.8.2 with libpcap 1.3.0.</p><p>Any idea what I'm doing wrong and how can I manage to do it properly?</p></div><div id="question-tags" class="tags-container tags">capture-filter vlan lxc tshark icmp6</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>20 Sep '13, 03:01</strong></p><img src="https://secure.gravatar.com/avatar/7e2df31cada4c7bc3f6f18ece179fee5?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Ester&#39;s gravatar image" /><p>Ester<br />
<span class="score" title="16 reputation points">16</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Ester has no accepted answers">0%</span></p></div><div class="post-update-info post-update-info-edited"><p>edited 20 Sep '13, 17:55</p><img src="https://secure.gravatar.com/avatar/f93de7000747ab5efb5acd3034b2ebd7?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Guy%20Harris&#39;s gravatar image" /><p>Guy Harris ♦♦<br />
<span class="score" title="17443 reputation points"><span>17.4k</span></span><span title="3 badges"><span class="badge1">●</span><span class="badgecount">3</span></span><span title="35 badges"><span class="silver">●</span><span class="badgecount">35</span></span><span title="196 badges"><span class="bronze">●</span><span class="badgecount">196</span></span></p></div></div><div id="comments-container-24992" class="comments-container"></div><div id="comment-tools-24992" class="comment-tools"></div><div class="clear"></div><div id="comment-24992-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

One Answer:

</div>

</div>

<span id="24997"></span>

<div id="answer-container-24997" class="answer accepted-answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-24997-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>I've <strong>also tried with tcpdump</strong> with the <strong>same results</strong>.</p></blockquote><p>O.K. then I guess it's either a libpcap issue or an issue with the LXC virtual interfaces and <strong>not an issue with Wireshark</strong>. Unfortunately neither problem can be fixed by the Wireshark community.</p><p>Did you ask this question in the forums of libpcap/tcpdump and/or lxc?</p><blockquote><p>tshark -i veth1000_1 captures requests and replies</p></blockquote><p>If you look at the reply packets in this case: Is there any VLAN tag added (I don't know if LXC uses VLANs internally)? Or do the replies look in any way 'strange'?</p><p>BTW: If you cannot detect a difference, can you please post a capture file somewhere (google docs, dropbox, cloudshark, etc.)?</p><p><strong>SOLUTION</strong></p><p>see comments below.</p><p>The problem seems to be related to VLAN tags and possibly a bug in libpcap in conjunction with LXC virtual interfaces. The following filter shows both, requests and responses:</p><blockquote><p>tcpdump -ni veth1000_1 'icmp6 or (vlan and icmp6)'<br />
tshark -ni veth1000_1 -f 'icmp6 or (vlan and icmp6)'</p></blockquote><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>20 Sep '13, 04:10</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></br></p></div><div class="post-update-info post-update-info-edited"><p>edited 20 Sep '13, 07:17</p></div></div><div id="comments-container-24997" class="comments-container"><span id="25003"></span><div id="comment-25003" class="comment"><div id="post-25003-score" class="comment-score"></div><div class="comment-text"><p>Yup, I forgot to mention that traffic carries a VLAN tag, but both request and replies. What I don't get is why (if everything seems the same on lower ayers) when filtering by protocol it will drop some packets.</p><p>A capture file (without the icmp6 filter): <a href="https://dl.dropboxusercontent.com/u/3807034/ICMP6_capture.pcap">https://dl.dropboxusercontent.com/u/3807034/ICMP6_capture.pcap</a></p><p>Anyway, I'll ask too to the libpcap community. Thanks Kurt.</p></div><div id="comment-25003-info" class="comment-info"><span class="comment-age">(20 Sep '13, 04:27)</span> Ester</div></div><span id="25004"></span><div id="comment-25004" class="comment"><div id="post-25004-score" class="comment-score"></div><div class="comment-text"><p>Can you please try this:</p><blockquote><p>tshark -ni veth1000_1 -f "vlan and icmp6"<br />
</p></blockquote><p>and/or</p><blockquote><p>tcpdump -ni veth1000_1 vlan and icmp6</p></blockquote><p>What do you see?</p><blockquote><p>What I don't get is why (if everything seems the same on lower ayers) when filtering by protocol it will drop some packets.</p></blockquote><p>If it's a bug in the LXC veth code or the libpcap code, there is no logic you can apply ;-))</p></div><div id="comment-25004-info" class="comment-info"><span class="comment-age">(20 Sep '13, 04:30)</span> Kurt Knochner ♦</div></div><span id="25007"></span><div id="comment-25007" class="comment"><div id="post-25007-score" class="comment-score"></div><div class="comment-text"><p>Wow,</p><p>In both cases (tcpdump and tshark) I see only the replies:</p><blockquote><p>tshark -ni veth1000_1 -f "vlan and icmp6"</p><p>Capturing on veth1000_1</p><p>0.000000 fd02::a0cd:ef10:1101:0:1 -&gt; fd02::a0cd:ef10:1:0:1 ICMPv6 122 Echo (ping) reply id=0x021c, seq=693</p><p>0.007975 fd02::a0cd:ef10:1501:0:1 -&gt; fd02::a0cd:ef10:1:0:1 ICMPv6 122 Echo (ping) reply id=0x022c, seq=585</p><p>0.012042 fd02::a0cd:ef10:601:0:1 -&gt; fd02::a0cd:ef10:1:0:1 ICMPv6 122 Echo (ping) reply id=0x0208, seq=752</p><p>0.012059 fd02::a0cd:ef10:1001:0:1 -&gt; fd02::a0cd:ef10:1:0:1 ICMPv6 122 Echo (ping) reply id=0x0218, seq=720</p></blockquote><p>whereas</p><blockquote><p>tshark -ni veth1000_1 -f "icmp6"</p><p>Capturing on veth1000_1</p><p>0.000000 fd02::a0cd:ef10:1:0:1 -&gt; fd02::a0cd:ef10:1201:0:1 ICMPv6 122 Echo (ping) request id=0x0220, seq=1383</p><p>0.012003 fd02::a0cd:ef10:1:0:1 -&gt; fd02::a0cd:ef10:801:0:1 ICMPv6 122 Echo (ping) request id=0x0210, seq=1297</p><p>0.016011 fd02::a0cd:ef10:1:0:1 -&gt; fd02::a0cd:ef10:901:0:1 ICMPv6 122 Echo (ping) request id=0x0214, seq=1263</p><p>0.020014 fd02::a0cd:ef10:1:0:1 -&gt; fd02::a0cd:ef10:201:0:1 ICMPv6 122 Echo (ping) request id=0x01f8, seq=1291</p></blockquote><p>Could you explain me the rationale behind this? (I mean I know I can now use the filter "icmp6 or (vlan and icmp6)" but I cannot understand the reason why it works)</p></div><div id="comment-25007-info" class="comment-info"><span class="comment-age">(20 Sep '13, 04:39)</span> Ester</div></div><span id="25012"></span><div id="comment-25012" class="comment"><div id="post-25012-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Could you explain me the rationale behind this?</p></blockquote><p>I'm sorry, but no. I believe this could be a libpcap issue (or a problem with the veth interface code).</p><p>What do you see with this filter:</p><blockquote><p>tcpdump -ni '(vlan and icmp6) or icmp6'</p></blockquote></div><div id="comment-25012-info" class="comment-info"><span class="comment-age">(20 Sep '13, 04:45)</span> Kurt Knochner ♦</div></div><span id="25016"></span><div id="comment-25016" class="comment not_top_scorer"><div id="post-25016-score" class="comment-score"></div><div class="comment-text"><p>Captur filter works on byte offsets and the VLAN tag adds a couple of bytes so "icmp6" does not work on the VLAN tagged packet, Most probably the outgoing request gets the VLAN tag added by the interface or after libpcap "sees" the pacaket so the filter with VLAN does not catch the packet try "vlan and icmp6"|| "icmp6"</p></div><div id="comment-25016-info" class="comment-info"><span class="comment-age">(20 Sep '13, 04:51)</span> Anders ♦</div></div><span id="25019"></span><div id="comment-25019" class="comment not_top_scorer"><div id="post-25019-score" class="comment-score"></div><div class="comment-text"><p>Neither the filter '(vlan and icmp6) or icmp6' nor "vlan and icmp6"|| "icmp6" worked (they only show replies).</p><p>I guess it is because, as explained by Anders, once you write vlan it expects the packets to have a VLAN tag and then does not recognise the ones without it.</p><p>Anyway, it is confusing, because the "or" operation should be commutative.</p><p>Many thanks to you both.</p></div><div id="comment-25019-info" class="comment-info"><span class="comment-age">(20 Sep '13, 05:04)</span> Ester</div></div><span id="25021"></span><div id="comment-25021" class="comment not_top_scorer"><div id="post-25021-score" class="comment-score"></div><div class="comment-text"><p>Did you try this:</p><blockquote><p>tcpdump -ni 'icmp6 or (vlan and icmp6)'</p></blockquote><p>The BPF code is different see</p><blockquote><p>tcpdump -d 'icmp6 or (vlan and icmp6)'</p></blockquote><p>versus</p><blockquote><p>tcpdump -d '(vlan and icmp6) or icmp6'</p></blockquote></div><div id="comment-25021-info" class="comment-info"><span class="comment-age">(20 Sep '13, 05:11)</span> Kurt Knochner ♦</div></div><span id="25023"></span><div id="comment-25023" class="comment not_top_scorer"><div id="post-25023-score" class="comment-score"></div><div class="comment-text"><p>Yeah, that one is working :), yet I always thought that 'or' order didn't matter (much)..</p><p>I see that is not the case after seeing the code, though I couldn't decipher it, but I see that 'icmp6 or (vlan and icmp6)' seems to check more cases, or at least its longer.</p></div><div id="comment-25023-info" class="comment-info"><span class="comment-age">(20 Sep '13, 05:22)</span> Ester</div></div><span id="25025"></span><div id="comment-25025" class="comment"><div id="post-25025-score" class="comment-score">1</div><div class="comment-text"><blockquote><p>Yeah, that one is working :)</p></blockquote><p>I'm glad I could help.</p><p>Nevertheless, there seems to be a bug in libpcap in conjunction with LXC virtual ethernet nics, whereas it is yet unclear who is introducing the bug. See @Anders comment: I's probably related to the fact where/when the VLAN tag is added.</p><blockquote><p>I see that is not the case after seeing the code, though I couldn't decipher it</p></blockquote><p>It's code for the BPF filtering virtual machine. See here, if you are interested in some details</p><blockquote><p><a href="http://sharkfest.wireshark.org/sharkfest.11/presentations/McCanne-Sharkfest%2711_Keynote_Address.pdf">http://sharkfest.wireshark.org/sharkfest.11/presentations/McCanne-Sharkfest%2711_Keynote_Address.pdf</a></p></blockquote></div><div id="comment-25025-info" class="comment-info"><span class="comment-age">(20 Sep '13, 05:29)</span> Kurt Knochner ♦</div></div><span id="25062"></span><div id="comment-25062" class="comment not_top_scorer"><div id="post-25062-score" class="comment-score"></div><div class="comment-text"><p>For future reference, you may want to refer to the <a href="http://www.tcpdump.org/manpages/pcap-filter.7.html">pcap-filter man page</a> hosted on <a href="http://www.tcpdump.org/">www.tcpdump.org</a>.</p><p>Of particular note:</p><ul><li>The <code>vlan</code> primitive is not the only primitive that behaves this way - both <code>mpls</code> and <code>pppoes</code> do as well.</li><li>Each use of the <code>vlan</code> (and <code>mpls</code>) primitive increments the filter offsets by 4. (Refer to the man page for more details and examples.)</li></ul></div><div id="comment-25062-info" class="comment-info"><span class="comment-age">(20 Sep '13, 19:51)</span> cmaynard ♦♦</div></div><span id="25063"></span><div id="comment-25063" class="comment not_top_scorer"><div id="post-25063-score" class="comment-score"></div><div class="comment-text"><blockquote><p>For future reference, you may want to refer to the pcap-filter man page</p></blockquote><p>the pcap-filter man page would be a good source of information about the filter synatx, however the OP wanted to understand the difference in generated BPF code and thus he needs to know how the BPF virtual machine works and how to read the BPF 'machine instructions'. The pcap-filter man page does not contain that information, whereas the PDF is a pretty good tutorial for that.</p></div><div id="comment-25063-info" class="comment-info"><span class="comment-age">(21 Sep '13, 00:08)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-24997" class="comment-tools"><span class="comments-showing"> showing 5 of 11 </span> <a href="#" class="show-all-comments-link">show 6 more comments</a></div><div class="clear"></div><div id="comment-24997-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

