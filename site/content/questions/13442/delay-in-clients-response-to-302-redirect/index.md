+++
type = "question"
title = "Delay in client&#x27;s response to 302 redirect"
description = '''Hi All i am trying to figure out as to why the client after receiving 302 is delaying to close the connection and initiate new one for the url in Location header. Basically the traffic to the Web App (via load balancer is as follows): 1) the client posts with a HTTP POST containing their login detai...'''
date = "2012-08-07T15:21:00Z"
lastmod = "2012-08-08T02:21:00Z"
weight = 13442
keywords = [ "redirect", "302", "delayed" ]
aliases = [ "/questions/13442" ]
osqa_answers = 2
osqa_accepted = false
+++

<div class="headNormal">

# [Delay in client's response to 302 redirect](/questions/13442/delay-in-clients-response-to-302-redirect)

</div>

<div id="main-body">

<div id="askform">

<table id="question-table" style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-13442-score" class="post-score" title="current number of votes">0</div><div id="favorite-count" class="favorite-count"></div></div></td><td><div id="item-right"><div class="question-body"><p>Hi All i am trying to figure out as to why the client after receiving 302 is delaying to close the connection and initiate new one for the url in Location header.</p><p>Basically the traffic to the Web App (via load balancer is as follows):</p><p>1) the client posts with a HTTP POST containing their login details</p><p>2) the server accepts that message, commits it, and responds to the client by sending a HTTP 302 redirect to a page called ....</p><p>3) The client when receiving the 302 would close its TCP session, and reestablish a new one and send a HTTP GET for the new URL provided in the 302 redirect.</p><p>4) Client confirms receiving 302 and :</p><pre><code>a) in working scenario closes existing TCP session almost immediately and opens new new for the URL provided in 302

b) in slowdown scenario - the load balancer sends RST (due to the session timeout) and forces to close this TCP session</code></pre><p>The main question is as to why after client's receiving 302 is not terminating existing connection ...?</p><p>Any ideas ?</p></div><div id="question-tags" class="tags-container tags">redirect 302 delayed</div><div id="question-controls" class="post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>asked <strong>07 Aug '12, 15:21</strong></p><img src="https://secure.gravatar.com/avatar/89941aca50bd896f00def88cf664f9de?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="andrus&#39;s gravatar image" /><p>andrus<br />
<span class="score" title="1 reputation points">1</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="andrus has no accepted answers">0%</span></p></div></div><div id="comments-container-13442" class="comments-container"><span id="17246"></span><div id="comment-17246" class="comment"><div id="post-17246-score" class="comment-score"></div><div class="comment-text"><p>Did you ever find an answer on this? I'm having pretty much the same exact issue and I'm using Citrix Netscalers. I'm having 3-5 minute delays when moving between tabs in one of our lotus apps. Let me know please!</p></div><div id="comment-17246-info" class="comment-info"><span class="comment-age">(26 Dec '12, 13:05)</span> zmiller013</div></div><span id="17409"></span><div id="comment-17409" class="comment"><div id="post-17409-score" class="comment-score"></div><div class="comment-text"><p>Yes, I did - it was eventually looked at by the engineering team of the LB vendor and there was some issue with the web application firewall found, later fixed in the next firmware release :) so make sure first you are using the latest build just in case :)</p></div><div id="comment-17409-info" class="comment-info"><span class="comment-age">(03 Jan '13, 01:10)</span> andrus</div></div><span id="17491"></span><div id="comment-17491" class="comment"><div id="post-17491-score" class="comment-score"></div><div class="comment-text"><p>Thanks for the reply. I eventually found my problem as well. With the Citrix Netscaler's in the code I was running they forgot to include a piece of code that sent the Close Notify for SSL sessions. Without this close notify my session stayed open until the timeout and then would reset and work. They verified this was missing and is in the latest code of the Netscaler.</p></div><div id="comment-17491-info" class="comment-info"><span class="comment-age">(07 Jan '13, 05:44)</span> zmiller013</div></div></div><div id="comment-tools-13442" class="comment-tools"></div><div class="clear"></div><div id="comment-13442-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

------------------------------------------------------------------------

<div class="tabBar">

<span id="sort-top"></span>

<div class="headQuestions">

2 Answers:

</div>

</div>

<span id="13443"></span>

<div id="answer-container-13443" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-13443-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><blockquote><p>The main question is as to why after client's receiving 302 is not terminating existing connection ...?</p></blockquote><p>well, hard to say without any information about the client beeing used... Please add this:</p><ul><li>OS / OS version of the system running the client application</li><li>the client application (browser, browser version, own application, etc.</li><li>if the client is a browser: does your application use Javascript? If so, the code in the browser might check the response and thus add some delay</li><li>a capture file that shows the behaviour of the client</li></ul><p>Regards<br />
Kurt</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>07 Aug '12, 17:00</strong></p><img src="https://secure.gravatar.com/avatar/23b7bf5b13bc2c98b2e8aa9869ca5d75?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="Kurt%20Knochner&#39;s gravatar image" /><p>Kurt Knochner ♦<br />
<span class="score" title="24767 reputation points"><span>24.8k</span></span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="39 badges"><span class="silver">●</span><span class="badgecount">39</span></span><span title="237 badges"><span class="bronze">●</span><span class="badgecount">237</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="Kurt Knochner has 344 accepted answers">15%</span> </br></p></div><div class="post-update-info post-update-info-edited"><p>edited 07 Aug '12, 17:00</p></div></div><div id="comments-container-13443" class="comments-container"><span id="13450"></span><div id="comment-13450" class="comment"><div id="post-13450-score" class="comment-score"></div><div class="comment-text"><p>Thanks for checking this Kurt, Here is more info for this: - OS is Windows 7 - Browser is Firefox 14 (has been tested using IE 8 - There is no Javascript in the page code</p><p>The flow is a follows: (Client,win7) &lt;-&gt; (Load balancer) &lt;-&gt; (backend IIS,win2008) have traces from all 3 machines, I narrowed it down to the issue with the client not responding to 302 in timely fashion manner</p><p>NOTE: both traces were taken using the same client machine and same browser, the change is that in Working scenario we have older version of firmware on Load balancer and in the SLOW working scenario we has newest version</p><p>Here is the properly working trace:( clients IP 192.168.1.37) <img src="https://osqa-ask.wireshark.org/upfiles/Capture-ok-resized_1.png" alt="alt text" /></p><p>and here is the delay in clients response (not closing connection after receiving 302) * RST seen in 19404 packet is the Load Balancer forcing to reset this CP stream due to the timeout</p><p><img src="https://osqa-ask.wireshark.org/upfiles/capture-slow-res_1.png" alt="alt text" /></p></div><div id="comment-13450-info" class="comment-info"><span class="comment-age">(08 Aug '12, 00:33)</span> andrus</div></div><span id="13451"></span><div id="comment-13451" class="comment"><div id="post-13451-score" class="comment-score"></div><div class="comment-text"><blockquote><p>the change is that in <strong>Working scenario</strong> we have <strong>older version of firmware</strong> on Load balancer</p></blockquote><p>Look at who is closing the connection. The first FIN comes from x.251.21.95. It is the loadbalancer that is closing the connection not the client (first screenshot).</p><p>So, the reason for the different behaviour is clearly the firmware upgrade on the loadbalancer. Maybe there is a new feature in the new firmare that keeps the connection open to the client.</p><p>Unfortunately the new client request (to the redirected URL) is not part of the capture screenshot.</p><p>Do you have any performance issues with this behaviour, or do you just want to know why it happens (firmware upgrade)?</p></div><div id="comment-13451-info" class="comment-info"><span class="comment-age">(08 Aug '12, 01:20)</span> Kurt Knochner ♦</div></div><span id="13454"></span><div id="comment-13454" class="comment"><div id="post-13454-score" class="comment-score"></div><div class="comment-text"><p>Spot on Kurt, I have no idea how could I missed that !</p><p>I will move away from the client toward the load balancer checking for any differences in TCP/HTTP profiles in the new version.</p><p>Yes it is performance issue. Basically after upgrading LB the login process takes 2-3 min longer when going thought upgraded LB.</p><p>Here is trace taken on the LB directly (filtered for the front-end communication for this client) - 192.168.1.172 is the LB VIP ip address - clients POST was toggled as a time 0</p><ol><li>Old version of firmware (trace taken directly on the LB)</li></ol><p><img src="https://osqa-ask.wireshark.org/upfiles/CaptureLB.png" alt="alt text" /></p><ol><li>New version of firmware (trace taken directly on the LB) - as can be seen 188sec of delay in client coming back to the 302</li></ol><p><img src="https://osqa-ask.wireshark.org/upfiles/CaptureLB_1.png" alt="alt text" /></p><p>I would have though that if the client received 302 with "Connection:Close" header - it should terminate the existing TCP stream and initiate new TCP connection for the URL given in the "Location:" header - it's that the case ??</p><p><strong>HTTP/1.1 302 Found Server: My Own Date: Fri, 03 Aug 2012 10:00:02 GMT Connection: close Location: <a href="http://www.xxxxxx.xx/mail/testuser.nsf">http://www.xxxxxx.xx/mail/testuser.nsf</a></strong></p><p>Tanks for you help Andrzej</p></div><div id="comment-13454-info" class="comment-info"><span class="comment-age">(08 Aug '12, 02:22)</span> andrus</div></div><span id="13456"></span><div id="comment-13456" class="comment"><div id="post-13456-score" class="comment-score"></div><div class="comment-text"><blockquote><p>Spot on Kurt, I have no idea how could I missed that !</p></blockquote><p>Never mind. You know, sometimes ...</p><blockquote><p>I will move away from the client toward the load balancer checking for any differences in TCP/HTTP profiles in the new version.</p></blockquote><p>yes, please check that.</p><blockquote><p>Yes it is performance issue. Basically after upgrading LB the login process takes 2-3 min longer when going thought upgraded LB.</p></blockquote><p>Look at both POST requests with "Follow TCP stream" and compare anything in both connections. Is there any difference at HTTP protocol level? If there is none, the loadbalancer behaves just different. If there is a difference, check if the LB answer (new firmware) is HTTP compliant. If it is not, the client might just wait for more data within the open connection, until it gets closed by the LB. The 186 seconds to the connection close, sounds like your delay of 2-3 minutes.</p></div><div id="comment-13456-info" class="comment-info"><span class="comment-age">(08 Aug '12, 02:35)</span> Kurt Knochner ♦</div></div><span id="13458"></span><div id="comment-13458" class="comment"><div id="post-13458-score" class="comment-score"></div><div class="comment-text"><blockquote><p>I would have though that if the client received 302 with "Connection:Close" header - it should terminate the existing TCP stream</p></blockquote><p>well, yes and no ;-) Take a look at the HTTP 1.1 RFC. It states:</p><blockquote><p><code>HTTP/1.1 defines the "close" connection option for the sender to</code><br />
<code>signal that the connection will be closed after completion of the</code><br />
<code>response.</code><br />
<code>For example,</code><br />
<code>`       Connection: close`</code><br />
<code>in either the request or the response header fields indicates that</code><br />
<code>the connection SHOULD NOT be considered</code>persistent' (section 8.1)<code></code> after the current request/response is complete.`<br />
</p></blockquote><p>The server can close the connection when it finished sending all data.</p><p>The client however, can only close the connection when it received all data. If the "Content-Length" header contains the wrong length, the client might just wait for the rest of the data until the LB closes the connection.</p><p>As the problem only occurs after the LB upgrade, there must be some change in behavior or a bug with the LB.</p></div><div id="comment-13458-info" class="comment-info"><span class="comment-age">(08 Aug '12, 02:47)</span> Kurt Knochner ♦</div></div></div><div id="comment-tools-13443" class="comment-tools"></div><div class="clear"></div><div id="comment-13443-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<span id="13453"></span>

<div id="answer-container-13453" class="answer">

<table style="width:100%;"><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><tbody><tr class="odd"><td style="width: 30px; vertical-align: top"><div class="vote-buttons"><div id="post-13453-score" class="post-score" title="current number of votes">0</div></div></td><td><div class="item-right"><div class="answer-body"><p>My guess would be that the 302 response is not correct. Is there a Content-Length header? And does it correctly state the length of the 302 response? Is Keep-Alive used by any chance? It's pretty hard to analyze this issue based on just a screenshot, that's why we all love to use Wireshark :-)</p><p>As you obfuscated some of the info, I assume you are not able to share the tracefiles? Are you able to send them privately to one or two persons? I'd be willing to have a quick look at them if you'd like.</p></div><div class="answer-controls post-controls"></div><div class="post-update-info-container"><div class="post-update-info post-update-info-user"><p>answered <strong>08 Aug '12, 02:21</strong></p><img src="https://secure.gravatar.com/avatar/7901a94d8fdd1f9f47cda9a32fcfa177?s=32&amp;d=identicon&amp;r=g" class="gravatar" width="32" height="32" alt="SYN-bit&#39;s gravatar image" /><p>SYN-bit ♦♦<br />
<span class="score" title="17094 reputation points"><span>17.1k</span></span><span title="9 badges"><span class="badge1">●</span><span class="badgecount">9</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="245 badges"><span class="bronze">●</span><span class="badgecount">245</span></span><br />
<span class="accept_rate" title="Rate of the user&#39;s accepted answers">accept rate:</span> <span title="SYN-bit has 174 accepted answers">20%</span> </br></br></p></img></div></div><div id="comments-container-13453" class="comments-container"><span id="13455"></span><div id="comment-13455" class="comment"><div id="post-13455-score" class="comment-score"></div><div class="comment-text"><p>If:</p><pre><code>HTTP/1.1 302 Found 
Server: My Own
Date: Fri, 03 Aug 2012 10:00:02 GMT 
Connection: close 
Location: http://www.xxxxxx.xx/mail/testuser.nsf</code></pre><p>Are all the headers that the client receives, it will indeed wait. As there is no "Content-Length" header. This means the client does not know when the object has been sent completely, so it needs to wait for the FIN from the server (which it normally sends when "Connection: close" is being used.</p><p>You might want to take a look at the server side to see whether the server indeed closes the connection and then check the settings on the LB why it is not closing the connection. If it wants to keep the connection open, it should add a "Content-Length: 0" header to the client.</p></div><div id="comment-13455-info" class="comment-info"><span class="comment-age">(08 Aug '12, 02:33)</span> SYN-bit ♦♦</div></div><span id="13457"></span><div id="comment-13457" class="comment"><div id="post-13457-score" class="comment-score"></div><div class="comment-text"><p>Thanks a mil for your input on this.</p><p>302 looks like this (there is no Content-Lenght header)</p><h2 id="this-is-the-302-given-to-the-client">This is the 302 given to the client:</h2><p>HTTP/1.1 302 Found Server: My Own Date: Fri, 03 Aug 2012 09:51:13 GMT Connection: close Location: <a href="http://www.xxxxxx.xx/mail/testuser.nsf">http://www.xxxxxx.xx/mail/testuser.nsf</a> Set-Cookie: LtpaToken=AHDER7LK9kHknb8MJHGRT876KNJGTFD0KHJSUJNBGTc2aL6c8v0XQ35wDW14B8z85Gv; domain=.xxxxxx.xx; path=/</p><hr /></div><div id="comment-13457-info" class="comment-info"><span class="comment-age">(08 Aug '12, 02:44)</span> andrus</div></div><span id="13459"></span><div id="comment-13459" class="comment"><div id="post-13459-score" class="comment-score"></div><div class="comment-text"><p>I have now checked the in the traces taken on the back-end server and can confirm in both scenarios that the back-end after responding with 302 to the initial POST is closing the existing connection</p><p><img src="https://osqa-ask.wireshark.org/upfiles/CaptureBackend.PNG" alt="alt text" /></p><p>I will check on the LB why there is hold up for so long in terminating this connection after 302 is passed to the client...</p><p>Thank you all for looking into this. Andrzej</p></div><div id="comment-13459-info" class="comment-info"><span class="comment-age">(08 Aug '12, 03:15)</span> andrus</div></div></div><div id="comment-tools-13453" class="comment-tools"></div><div class="clear"></div><div id="comment-13453-form-container" class="comment-form-container"></div><div class="clear"></div></div></td></tr></tbody></table>

</div>

<div class="paginator-container-left">

</div>

</div>

</div>

